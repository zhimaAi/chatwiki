import{b as pe,d as _e}from"../../index-OnalErht.js";import{ab as ye,f as _,e as ve,r as fe,o as me,Y as I,k as o,a5 as s,a2 as u,aa as ge,_ as v,G as d,u as w,a1 as c,F as K,a9 as U,a7 as z,y as V}from"./vue-chunks-Ci-XTWEs.js";import{M as be}from"./multi-reply-CT8f169M.js";import{p as L,q as j,r as ce}from"./index-DFuA_ofI.js";import{a as p,i as xe,F as he,j as we,e as ke,I as Ce,p as Re,ab as G,B as Ie,z as N,ao as Ae,q as Be,R as $e}from"./ui-antd-BgeWxFcI.js";import"./utils-ChQO-_r6.js";import"./index-BdOGHXRM.js";const qe={class:"subManage-edit"},Fe=["href"],Ke={class:"main"},Ue={class:"nav-box",style:{"padding-top":"10px"}},ze={class:"item-box"},Ne={class:"item-title-box"},Te={class:"flex",style:{gap:"8px","align-items":"center"}},He={class:"tag-container",style:{"margin-top":"8px"}},Me={class:"item-box",style:{"margin-top":"12px"}},Se={class:"item-title-box"},De={class:"flex",style:{gap:"8px","align-items":"center"}},Ee={class:"tag-container",style:{"margin-top":"8px"}},Oe={class:"nav-box",style:{"margin-top":"24px"}},Pe={class:"item-box"},Ve={class:"nav-box",style:{"margin-top":"24px"}},Le={class:"item-box"},je={class:"radio-container"},Ge={class:"btn-container"},Je={__name:"add-rule",setup(Qe){const f=ye().query,b=_(+f.rule_id||+f["rule-id"]||0),J=ge(),Q=ve(()=>`/#/robot/ability/auto-reply?id=${f.id}&robot_key=${f.robot_key}`),T=_(null),y=fe({name:"",reply_num:"0"}),W={name:[{required:!0,message:"请输入规则名称",trigger:"blur"}]},m=_([]),g=_([]),k=_(""),C=_(""),A=_(!1),B=_(!1),H=_(null),M=_(null),$=_(!1),Y=()=>{A.value=!0,V(()=>{var e,l;const n=H.value;n!=null&&n.focus?n.focus():(l=(e=n==null?void 0:n.$el)==null?void 0:e.querySelector("input"))==null||l.focus()})},S=async()=>{var e,l;if($.value)return;const n=(k.value||"").trim();if(!n){p.warning("请输入关键词");return}if(m.value.includes(n)){p.warning("已存在该关键词");return}try{$.value=!0;const a=await j({id:b.value,robot_id:f.id,keyword:n}),t=(e=a==null?void 0:a.data)==null?void 0:e.is_repeat,h=((l=a==null?void 0:a.data)==null?void 0:l.rule_name)||"";if(t){p.error(`关键词与规则「${h}」重复`);return}m.value.push(n),k.value="",A.value=!1}catch{p.error("校验失败，请稍后重试")}finally{$.value=!1}},X=n=>{m.value=m.value.filter(e=>e!==n)},q=_(!1),Z=()=>{B.value=!0,V(()=>{var e,l;const n=M.value;n!=null&&n.focus?n.focus():(l=(e=n==null?void 0:n.$el)==null?void 0:e.querySelector("input"))==null||l.focus()})},D=async()=>{var e,l;if(q.value)return;const n=(C.value||"").trim();if(!n){p.warning("请输入关键词");return}if(g.value.includes(n)){p.warning("已存在该关键词");return}try{q.value=!0;const a=await j({id:b.value,robot_id:f.id,keyword:n}),t=(e=a==null?void 0:a.data)==null?void 0:e.is_repeat,h=((l=a==null?void 0:a.data)==null?void 0:l.rule_name)||"";if(t){p.error(`关键词与规则「${h}」重复`);return}g.value.push(n),C.value="",B.value=!1}catch{p.error("校验失败，请稍后重试")}finally{q.value=!1}},ee=n=>{g.value=g.value.filter(e=>e!==n)},r=_([{type:"text",description:""}]),te=()=>{if(r.value.length>=5){p.warning("最多添加5条回复内容");return}r.value.push({type:"text",description:""})},le=n=>{const{reply_index:e,...l}=n;e>=0&&e<r.value.length&&(r.value[e]=l)},ne=n=>{r.value.splice(n,1)},ae=()=>{};function oe(n){return(n||[]).map(e=>({...e,status:"1"}))}function se(n){const e={text:"2",image:"4",card:"3",imageText:"1",url:"5"};return n.map(l=>e[l.type]||"").filter(Boolean)}const ue=()=>{var n;(n=T.value)==null||n.validate().then(async()=>{if(!m.value.length&&!g.value.length){p.warning("请至少添加一个关键词（精准或模糊）");return}if(!r.value.length){p.warning("请至少添加一条回复内容");return}const e={robot_id:f.id,name:y.name,full_keyword:m.value,half_keyword:g.value,reply_content:JSON.stringify(oe(r.value)),reply_type:se(r.value),reply_num:y.reply_num};b.value&&(e.id=b.value);try{const l=await ce(e);l&&l.res==0&&(p.success("保存成功"),J.push({path:"/robot/ability/auto-reply",query:{id:f.id,robot_key:f.robot_key}}))}catch{}})};return me(async()=>{const n=+(f.copy_id||0);if(!b.value&&n){try{const e=await L({id:n}),l=(e==null?void 0:e.data)||{};y.name=`${(l==null?void 0:l.name)||""}副本`;const a=Array.isArray(l==null?void 0:l.reply_content)?l.reply_content:[];r.value=a.map(t=>({type:(t==null?void 0:t.type)||(t==null?void 0:t.reply_type)||"text",description:(t==null?void 0:t.description)||"",thumb_url:(t==null?void 0:t.thumb_url)||(t==null?void 0:t.pic)||"",title:(t==null?void 0:t.title)||"",url:(t==null?void 0:t.url)||"",appid:(t==null?void 0:t.appid)||"",page_path:(t==null?void 0:t.page_path)||""})),y.reply_num=l.reply_num}catch{p.error("加载规则失败，请稍后重试")}return}if(b.value)try{const e=await L({id:b.value}),l=(e==null?void 0:e.data)||{};y.name=(l==null?void 0:l.name)||"",m.value=Array.isArray(l==null?void 0:l.full_keyword)?l.full_keyword:[],g.value=Array.isArray(l==null?void 0:l.half_keyword)?l.half_keyword:[];const a=Array.isArray(l==null?void 0:l.reply_content)?l.reply_content:[];r.value=a.map(t=>({type:(t==null?void 0:t.type)||(t==null?void 0:t.reply_type)||"text",description:(t==null?void 0:t.description)||"",thumb_url:(t==null?void 0:t.thumb_url)||(t==null?void 0:t.pic)||"",title:(t==null?void 0:t.title)||"",url:(t==null?void 0:t.url)||"",appid:(t==null?void 0:t.appid)||"",page_path:(t==null?void 0:t.page_path)||""})),y.reply_num=l.reply_num}catch{p.error("加载规则失败，请稍后重试")}}),(n,e)=>{const l=we,a=xe,t=Ce,h=ke,F=_e,E=Re,R=Ie,O=Ae,P=$e,ie=Be,re=he;return v(),I("div",qe,[o(a,{class:"subManage-breadcrumb"},{default:u(()=>[o(l,null,{default:u(()=>[s("a",{href:Q.value},"关键词回复",8,Fe)]),_:1}),o(l,null,{default:u(()=>e[4]||(e[4]=[d("新增规则")])),_:1,__:[4]})]),_:1}),s("div",Ke,[o(re,{ref_key:"formRef",ref:T,model:y,rules:W},{default:u(()=>[o(h,{label:"规则名称",name:"name",rules:[{required:!0,message:"请输入规则名称"}]},{default:u(()=>[o(t,{value:y.name,"onUpdate:value":e[0]||(e[0]=i=>y.name=i),placeholder:"请输入",style:{width:"512px"}},null,8,["value"])]),_:1}),s("div",Ue,[o(F,{name:"set-keywords",style:{"font-size":"16px"}}),e[5]||(e[5]=d(" 设置关键词 "))]),s("div",ze,[s("div",Ne,[e[7]||(e[7]=s("div",{class:"item-title"},"精准匹配",-1)),o(E,null,{title:u(()=>e[6]||(e[6]=[d("发送消息内容只提到某个关键词，才回复指定的内容")])),default:u(()=>[o(w(G),{style:{color:"#8C8C8C"}})]),_:1})]),s("div",Te,[A.value?(v(),c(t,{key:0,ref_key:"fullInputRef",ref:H,value:k.value,"onUpdate:value":e[1]||(e[1]=i=>k.value=i),placeholder:"输入关键词后回车或失去焦点添加",style:{width:"260px"},onPressEnter:S,onBlur:S},null,8,["value"])):(v(),c(R,{key:1,type:"dashed",class:"add-btn",onClick:Y},{icon:u(()=>[o(w(N))]),default:u(()=>[e[8]||(e[8]=d(" 添加关键词 "))]),_:1,__:[8]}))]),s("div",He,[(v(!0),I(K,null,U(m.value,i=>(v(),c(O,{key:i,closable:"",onClose:x=>X(i)},{default:u(()=>[d(z(i),1)]),_:2},1032,["onClose"]))),128))])]),s("div",Me,[s("div",Se,[e[10]||(e[10]=s("div",{class:"item-title"},"模糊匹配",-1)),o(E,null,{title:u(()=>e[9]||(e[9]=[d("发送消息内容只要包含某个关键词，才回复指定的内容")])),default:u(()=>[o(w(G),{style:{color:"#8C8C8C"}})]),_:1})]),s("div",De,[B.value?(v(),c(t,{key:0,ref_key:"halfInputRef",ref:M,value:C.value,"onUpdate:value":e[2]||(e[2]=i=>C.value=i),placeholder:"输入关键词后回车或失去焦点添加",style:{width:"260px"},onPressEnter:D,onBlur:D},null,8,["value"])):(v(),c(R,{key:1,type:"dashed",class:"add-btn",onClick:Z},{icon:u(()=>[o(w(N))]),default:u(()=>[e[11]||(e[11]=d(" 添加关键词 "))]),_:1,__:[11]}))]),s("div",Ee,[(v(!0),I(K,null,U(g.value,i=>(v(),c(O,{key:i,closable:"",onClose:x=>ee(i)},{default:u(()=>[d(z(i),1)]),_:2},1032,["onClose"]))),128))])]),s("div",Oe,[o(F,{name:"reply-content",style:{"font-size":"16px"}}),e[12]||(e[12]=d(" 回复内容 "))]),s("div",Pe,[(v(!0),I(K,null,U(r.value,(i,x)=>(v(),c(be,{key:x,value:r.value[x],"onUpdate:value":de=>r.value[x]=de,reply_index:x,onChange:le,onDel:ne},null,8,["value","onUpdate:value","reply_index"]))),128)),o(R,{type:"dashed",style:{width:"694px"},disabled:r.value.length>=5,onClick:te},{icon:u(()=>[o(w(N))]),default:u(()=>[d(" 添加回复内容("+z(r.value.length)+"/5) ",1)]),_:1},8,["disabled"])]),s("div",Ve,[o(F,{name:"reply-settings",style:{"font-size":"16px"}}),e[13]||(e[13]=d(" 回复设置 "))]),s("div",Le,[e[16]||(e[16]=s("div",{class:"item-title-box"},[s("div",{class:"item-title"},"回复方式：")],-1)),s("div",je,[o(ie,{value:y.reply_num,"onUpdate:value":e[3]||(e[3]=i=>y.reply_num=i),onChange:ae},{default:u(()=>[o(P,{value:"0"},{default:u(()=>e[14]||(e[14]=[d("全部回复")])),_:1,__:[14]}),o(P,{value:"1"},{default:u(()=>e[15]||(e[15]=[d("随机回复一条")])),_:1,__:[15]})]),_:1},8,["value"])])]),s("div",Ge,[o(R,{type:"primary",onClick:ue},{default:u(()=>e[17]||(e[17]=[d("保存")])),_:1,__:[17]})])]),_:1},8,["model"])])])}}},nt=pe(Je,[["__scopeId","data-v-66fdf714"]]);export{nt as default};
