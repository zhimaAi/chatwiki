import{X as ae,Y as r,_ as l,k as R,a5 as a,a6 as ie,a3 as Q,G as H,a7 as p,ag as U,f as w,w as X,o as K,y as z,b as Z,a1 as q,u as C,ae as x,F as M,a9 as I,ad as P,a2 as B,H as ee,J as W,aa as ne,q as le,n as ce}from"./vue-chunks-BSjLwu6d.js";import{u as te}from"./useEventBus-BwH2zX88.js";import{g as re}from"./index-B4oOBcCh.js";import{a8 as E,ai as Y,av as G,h as de,b as D,d as V}from"../../index-0SFcfYGN.js";import{u as ue}from"./useIM-CKdjTFo_.js";import{B as j,M as _e,S as he,P as pe}from"./pull-up.esm-D94Swpvl.js";import{O as ve}from"./observe-dom.esm-CyCedSm-.js";import{ah as me,au as fe,aw as ge,v as ye,u as be,I as Le}from"./ui-antd-BIopZvX3.js";import{_ as ke}from"./index-BuQpXDoX.js";import{a as Se}from"./index-BBPKhyB5.js";import"./utils-BMKRjDTh.js";import"./index-1KR-OfoX.js";const Te=(n={})=>E.get({url:"/manage/getReceiverList",params:n}),Ce=(n={})=>E.post({url:"/chat/message",data:n}),we=(n={})=>E.post({url:"/manage/setReceiverRead",data:n}),F=ae("chatMonitor",{state:()=>({im:null,selectedRobotId:"",robotList:[],selectedReceiverId:"",receiverList:[],receiverListPage:{page:0,size:10},activeChat:null,chatMessagePageSize:10,messageList:[],messageListScrollTop:0,chatMessageLoadCompleted:!1,messageListLoading:!1}),getters:{},actions:{async init(){this.selectedRobotId="",this.selectedReceiverId="",this.robotList=[],this.receiverList=[],this.messageList=[],this.receiverListPage={page:0,size:10},this.messageListScrollTop=0,this.chatMessageLoadCompleted=!1,this.messageListLoading=!1,this.activeChat=null,await this.getRobotList(),await this.getReceiverList(),this.receiverList.length>0&&await this.switchChat(this.receiverList[0]),this.initIM()},closeIM(){this.im&&this.im.close()},initIM(){const n=ue(),c=de();this.im=n,n.connect(c.user_id),n.on("message",e=>{!e.data||e.msg_type!=="receiver_notify"||((e.change=="create"||e.change=="update")&&this.onAddReceiver(e),e.change=="delete"&&this.onDeleteReceiver(e),(e.change=="c_message"||e.change=="ai_message")&&this.onAddMessage(e))})},onAddMessage(n){if(!this.activeChat)return;const c=te();let e=n.data;this.activeChat.session_id==e.session_id&&(e.displayName=e.name||e.nickname,e.dispayTime=G(e.create_time),e.uid=Y(32),e.loading=!1,e.menu_json&&typeof e.menu_json=="string"&&(e.menu_json=JSON.parse(e.menu_json)),e.quote_file&&typeof e.quote_file=="string"&&(e.quote_file=JSON.parse(e.quote_file)),this.messageList.push(e),c.emit("onAddMessage",e))},onAddReceiver(n){let c=n.data;c.displayName=c.name||c.nickname,c.come_from=JSON.parse(c.come_from);let e=this.receiverList.find(s=>s.session_id==c.session_id);e?Object.assign(e,c):(this.selectedRobotId==""||this.selectedRobotId==c.robot_id)&&this.receiverList.unshift(c)},onDeleteReceiver(n){let c=n.data,e=this.receiverList.findIndex(s=>s.id==c);e!=-1&&(this.activeChat&&this.activeChat.id==c&&(this.activeChat=null),this.receiverList.splice(e,1))},async getRobotList(n){return re(n).then(c=>(this.robotList=c.data||[],c))},async getReceiverList(n){return n!=null&&n.page?this.receiverListPage.page=n==null?void 0:n.page:this.receiverListPage.page++,Te({...this.receiverListPage,robot_id:this.selectedRobotId,...n}).then(c=>{let e=c.data.list||[];for(let s=0;s<e.length;s++)e[s].displayName=e[s].name||e[s].nickname,e[s].come_from&&(e[s].come_from=JSON.parse(e[s].come_from));return this.receiverListPage.page==1?this.receiverList=e:this.receiverList=this.receiverList.concat(e),c})},changeRobot(n){this.activeChat=null,this.resetReceiverList(n)},resetReceiverList(n){return this.receiverListPage.page=0,this.receiverList=[],this.getReceiverList(n)},async getChatMessage(){if(this.messageListLoading)return;this.messageListLoading=!0;let n=0,c=this.messageList.filter(s=>!s.isWelcome);c.length>0&&(n=c[0].id);let e={robot_key:this.activeChat.robot_key,openid:this.activeChat.openid,min_id:n,size:this.chatMessagePageSize};return Ce(e).then(s=>{var L,v;this.messageListLoading=!1;let t=s.data.list||[];const u=((L=s==null?void 0:s.data)==null?void 0:L.customer)||{},h=((v=s==null?void 0:s.data)==null?void 0:v.robot)||{};t.sort((o,m)=>o.id-m.id);for(let o=0;o<t.length;o++)t[o].displayName=t[o].name||t[o].nickname,t[o].is_customer==1?(t[o].displayName=t[o].displayName||u.name,t[o].avatar=t[o].avatar||u.avatar):(t[o].displayName=t[o].displayName||h.robot_name,t[o].avatar=t[o].avatar||h.robot_avatar),t[o].uid=Y(32),t[o].menu_json&&typeof t[o].menu_json=="string"&&(t[o].menu_json=JSON.parse(t[o].menu_json)),t[o].quote_file&&typeof t[o].menu_json=="string"&&(t[o].quote_file=JSON.parse(t[o].quote_file)),t[o].dispayTime=G(t[o].create_time);return this.messageList=[...t,...this.messageList],t.length<this.chatMessagePageSize&&(this.chatMessageLoadCompleted=!0),s}).catch(s=>{this.messageListLoading=!1})},claerUnread(){return we({id:this.selectedReceiverId})},async switchChat(n){this.chatMessageLoadCompleted=!1,this.messageListLoading=!1,this.messageList=[],this.messageListScrollTop=0,this.selectedReceiverId=n.id,this.activeChat=n,this.claerUnread(),await this.getChatMessage()}}}),$e={class:"no-data"},Re={class:"no-data-text"},xe={__name:"list-empty",props:{text:{type:String,default:"暂无数据"},size:{type:[Number,String],default:100}},setup(n){const c=n;return(e,s)=>{const t=V;return l(),r("div",$e,[R(t,{name:"empty",style:ie({"font-size":`${c.size}px`})},null,8,["style"]),a("div",Re,[Q(e.$slots,"default",{},()=>[H(p(c.text),1)],!0)])])}}},se=D(xe,[["__scopeId","data-v-9f7736f0"]]),Me={key:1,class:"chat-list"},Ie=["onClick"],Ne={class:"avatar"},Be=["src","alt"],De={class:"chat-info"},Oe={class:"nickname"},qe={class:"last-message"},Ae={class:"webapp-source"},je={key:0,class:"loading-wrapper"},ze={key:1,class:"finished-text"},He={__name:"chat-list ",emits:["switchChat"],setup(n,{expose:c,emit:e}){j.use(_e),j.use(he),j.use(ve),j.use(pe);const s=e,t=F(),{getReceiverList:u}=t,{receiverList:h,selectedReceiverId:L}=U(t),v=w(null);let o=null;const m=w(!1),k=w(!1),$=()=>{o=new j(v.value,{scrollY:!0,click:!0,observeDOM:!0,mouseWheel:!0,bounce:!1,scrollbar:{fade:!0,interactive:!0},pullUpLoad:!0}),o.on("pullingUp",()=>{f()})},f=async g=>{if(m.value||k.value){o.finishPullUp();return}m.value=!0;try{(await u(g)).data.list.length===0&&!g.keyword&&(k.value=!0)}catch(S){console.error("加载更多数据失败:",S)}finally{m.value=!1,o.finishPullUp()}},_=g=>{s("switchChat",g)};return X(h,g=>{g.length>0&&z(()=>{o&&o.refresh()})}),K(()=>{z(()=>{$()})}),Z(()=>{o&&o.destroy()}),c({getData:f}),(g,S)=>{const b=me;return l(),r("div",{class:"scroll-wrapper",ref_key:"scrollRef",ref:v},[C(h).length==0?(l(),q(se,{key:0,size:"140",text:"暂无机器人接待中会话"})):(l(),r("div",Me,[(l(!0),r(M,null,I(C(h),i=>(l(),r("div",{key:i.id,class:P(["chat-item",{active:i.id===C(L)}]),onClick:T=>_(i)},[a("div",Ne,[a("img",{src:i.avatar,alt:i.displayName},null,8,Be),i.unread>0?(l(),r("span",{key:0,class:P(["dot",{plus:i.unread>9}])},p(i.unread),3)):x("",!0)]),a("div",De,[a("div",Oe,p(i.displayName),1),a("div",qe,p(i.last_chat_message),1),a("div",Ae,"来自："+p(i.come_from.app_name),1)])],10,Ie))),128)),m.value?(l(),r("div",je,[R(b,{size:"small"}),S[0]||(S[0]=a("span",{class:"loading-text"},"加载中...",-1))])):x("",!0),k.value?(l(),r("div",ze,"没有更多了")):x("",!0)]))],512)}}},Pe=D(He,[["__scopeId","data-v-7b8e9eac"]]),Ue={__name:"chat-message-scroll",props:{topTriggerDistance:{type:Number,default:10},bottomTriggerDistance:{type:Number,default:40},isLoading:{type:Boolean,default:!1},scrollTop:{type:Number,default:0}},emits:["scroll-top","scroll-bottom","scroll"],setup(n,{expose:c,emit:e}){const s=n,t=e,u=w(null),h=w({scrollTop:0,scrollHeight:0,clientHeight:0,scrollDirection:"down",scrollStartDiff:s.topTriggerDistance,scrollEndDiff:s.bottomTriggerDistance}),L=w(null),v=_=>{const{scrollTop:g}=_,S=h.value.scrollTop-g;h.value.scrollDirection=S>0?"up":"down",Object.assign(h.value,{scrollTop:g,scrollHeight:_.scrollHeight,clientHeight:_.clientHeight})},o=()=>{const{scrollTop:_,scrollHeight:g,clientHeight:S,scrollStartDiff:b,scrollEndDiff:i,scrollDirection:T}=h.value;t("scroll",{...h.value}),s.isLoading||(Math.abs(_)<=b&&T==="up"&&t("scroll-top",{...h.value}),Math.abs(g-_-S)<=i&&T==="down"&&t("scroll-bottom",{...h.value}))},m=_=>{v(_.target),L.value&&(clearTimeout(L.value),L.value=null),L.value=setTimeout(()=>{o()},100)};function k(){u.value&&(u.value.scrollTop=0)}function $(){u.value&&(u.value.scrollTop=u.value.scrollHeight)}function f(){return u.value&&Object.assign(h.value,{scrollTop:u.value.scrollTop,scrollHeight:u.value.scrollHeight,clientHeight:u.value.clientHeight}),JSON.parse(JSON.stringify(h.value))}return X(()=>s.scrollTop,_=>{u.value&&(u.value.scrollTop=_)}),c({scrollToTop:k,scrollToBottom:$,getState:f}),(_,g)=>(l(),r("div",{class:"chat-message-scroll",ref_key:"scrollContainer",ref:u,onScroll:m},[Q(_.$slots,"default",{},void 0,!0)],544))}},Fe=D(Ue,[["__scopeId","data-v-3e3a1c2e"]]),Je={class:"chat-message-warpper"},Ee={class:"chat-message-content"},Ve={key:0,class:"is-loaded"},We={class:"avatar"},Ye=["src","alt"],Ge={class:"message-content"},Qe={class:"message-info"},Xe={class:"nickname"},Ke={class:"time"},Ze={class:"message-bubble"},et={key:0,class:"text-content"},tt={key:1},st={key:1,class:"image-content"},ot=["src"],at={key:2,class:"menu-content"},it={class:"menus-label"},nt={key:0,class:"menu-items"},lt=["onClick"],ct={key:3,class:"answer-reference-box"},rt=["onClick"],dt={__name:"chat-message",emits:["openLibrary"],setup(n,{expose:c,emit:e}){const s=e,t=w(null),u=F(),{getChatMessage:h}=u,{messageList:L,messageListScrollTop:v,messageListLoading:o,chatMessageLoadCompleted:m,activeChat:k}=U(u),$=()=>{};function f(T,y,N){let d=W(T);y.robot_key=k.value.robot_key,y.robot_id=k.value.robot_id,d.forEach(O=>{O.message_id=N.id,O.openid=N.openid,O.robot_key=k.value.robot_key,O.robot_id=k.value.robot_id}),s("openLibrary",d,W(y))}const _=T=>{const{scrollTop:y}=T;v.value=y},g=async()=>{if(m.value)return;let T=t.value.getState();await h(),z(()=>{let y=t.value.getState();y.scrollDirection=="up"&&(v.value=y.scrollHeight-T.scrollHeight)})},S=async()=>{};return c({scrollToTop:()=>{t.value.scrollToTop()},scrollToBottom:()=>{t.value.scrollToBottom()}}),(T,y)=>{const N=V;return l(),r("div",Je,[R(Fe,{ref_key:"scrollViewRef",ref:t,scrollTop:C(v),"onUpdate:scrollTop":y[0]||(y[0]=d=>ee(v)?v.value=d:null),"is-loading":C(o),onScroll:_,onScrollTop:g,onScrollBottom:S},{default:B(()=>[a("div",Ee,[C(m)?(l(),r("div",Ve,"没用更多聊天记录了")):x("",!0),(l(!0),r(M,null,I(C(L),(d,O)=>(l(),r("div",{key:O,class:P(["message-item",d.is_customer==0?"right":""])},[a("div",We,[a("img",{src:d.avatar,alt:d.displayName},null,8,Ye)]),a("div",Ge,[a("div",Qe,[a("span",Xe,p(d.displayName),1),y[1]||(y[1]=a("i",{class:"gap"},null,-1)),a("span",Ke,p(d.dispayTime),1)]),a("div",Ze,[d.msg_type==1?(l(),r("div",et,[d.is_customer==0?(l(),q(ke,{key:0,content:d.content},null,8,["content"])):(l(),r("div",tt,p(d.content),1))])):d.msg_type==3?(l(),r("div",st,[a("img",{src:d.content,alt:"image"},null,8,ot)])):d.msg_type==2?(l(),r("div",at,[a("div",it,p(d.menu_json.content),1),d.menu_json.question&&d.menu_json.question.length>0?(l(),r("div",nt,[(l(!0),r(M,null,I(d.menu_json.question,(A,J)=>(l(),r("div",{key:J,class:"menu-item",onClick:oe=>$(A)},p(A),9,lt))),128))])):x("",!0)])):x("",!0),d.quote_file&&d.quote_file.length?(l(),r("div",ct,[y[2]||(y[2]=a("div",{class:"answer-reference-label"},"回答参考",-1)),a("div",null,[(l(!0),r(M,null,I(d.quote_file,(A,J)=>(l(),r("div",{class:"list-item",key:J},[R(N,{name:"attachment"}),a("span",{onClick:oe=>f(d.quote_file,A,d)},p(A.file_name),9,rt)]))),128))])])):x("",!0)])])],2))),128))])]),_:1},8,["scrollTop","is-loading"])])}}},ut=D(dt,[["__scopeId","data-v-97ee52a0"]]),_t={class:"library-info-content"},ht={class:"file-list"},pt=["onClick"],vt={class:"document-items"},mt={class:"document-item-header"},ft={class:"left-box"},gt={class:"document-title"},yt={key:0,class:"document-title"},bt={class:"document-size"},Lt={class:"document-item-body"},kt={class:"document-similarity"},St={key:0,class:"document-content"},Tt={key:1,class:"document-content"},Ct={class:"document-content"},wt={class:"fragment-img"},$t=["src"],Rt={__name:"library-info-alert",setup(n,{expose:c}){const e=ne(),s=w(!1),t=w([]),u=w(null),h=()=>{t.value=[],u.value=null},L=(f,_)=>{h(),t.value=f,u.value=_.id,s.value=!0,m(_)},v=f=>{f.id!=u.value&&(u.value=f.id,m(f))},o=w([]),m=f=>{Se({message_id:f.message_id,file_id:f.id,robot_key:f.robot_key,openid:f.openid}).then(_=>{o.value=_.data||[]})},k=()=>{e.push("/library/preview?id="+u.value)},$=()=>{s.value=!1};return c({open:L}),(f,_)=>{const g=V,S=ge,b=le("viewer");return l(),q(S,{class:"library-info-alert",open:s.value,"onUpdate:open":_[0]||(_[0]=i=>s.value=i),title:"答案来源",placement:"right",width:"746px",closable:!1,bodyStyle:{background:"#F2F4F7"}},{extra:B(()=>[a("span",{class:"close-btn",onClick:$},[R(C(fe))])]),default:B(()=>[a("div",_t,[a("div",ht,[(l(!0),r(M,null,I(t.value,i=>(l(),r("div",{class:P(["file-item",{active:u.value==i.id}]),key:i.id,onClick:T=>v(i)},p(i.file_name),11,pt))),128))]),a("div",vt,[(l(!0),r(M,null,I(o.value,i=>(l(),r("div",{class:"document-item",key:i.id},[a("div",mt,[a("div",ft,[a("span",gt,"id："+p(i.id),1),i.title?(l(),r("span",yt,p(i.title),1)):x("",!0),a("span",bt," 共"+p(i.word_total)+"个字符 ",1)]),a("div",{class:"right-box"},[a("a",{onClick:k},"查看源文档>")])]),a("div",Lt,[a("div",kt,[_[1]||(_[1]=H(" 相似度： ")),R(g,{name:"similarity",style:{"font-size":"16px"}}),H(p(i.similarity),1)]),i.question?(l(),r("div",St,"Q："+p(i.question),1)):x("",!0),i.answer?(l(),r("div",Tt,"A："+p(i.answer),1)):x("",!0),a("div",Ct,p(i.content),1),ce((l(),r("div",wt,[(l(!0),r(M,null,I(i.images,(T,y)=>(l(),r("img",{key:y,src:T,alt:""},null,8,$t))),128))])),[[b]])])]))),128))])])]),_:1},8,["open"])}}},xt=D(Rt,[["__scopeId","data-v-3e30a1b1"]]),Mt={key:0,class:"chat-box-warpper"},It={class:"chat-box-header"},Nt={class:"nickname"},Bt={class:"chat-source"},Dt={class:"chat-box-content"},Ot={key:1},qt={__name:"chat-box",setup(n,{expose:c}){const e=F(),{activeChat:s}=U(e),t=w(null),u=()=>{t.value.scrollToBottom()},h=()=>{t.value.scrollToTop()},L=w(null),v=(o,m)=>{L.value.open(o,m)};return c({scrollToTop:h,scrollToBottom:u}),(o,m)=>(l(),r(M,null,[C(s)?(l(),r("div",Mt,[a("div",It,[a("div",Nt,p(C(s).name||C(s).nickname),1),a("div",Bt," 来自："+p(C(s).come_from.robot_name)+" - "+p(C(s).come_from.app_name),1)]),a("div",Dt,[R(ut,{ref_key:"chatMessageRef",ref:t,onOpenLibrary:v},null,512)])])):(l(),r("div",Ot)),R(xt,{ref_key:"libraryInfoAlertRef",ref:L},null,512)],64))}},At=D(qt,[["__scopeId","data-v-1d47d849"]]),jt={class:"chat-monitor-page"},zt={class:"page-left"},Ht={class:"app-list-box"},Pt={class:"search-box"},Ut={class:"chat-list-wrapper"},Ft={class:"page-body"},Jt={__name:"index",setup(n){const c=te(),e=F(),{init:s,changeRobot:t,switchChat:u,closeIM:h}=e,{robotList:L,selectedRobotId:v,activeChat:o}=U(e),m=w(null),k=w(null),$=w(""),f=()=>{const b={keyword:$.value,page:1};t(b)},_=async b=>{var i;await u(b),(i=k.value)==null||i.scrollToBottom()},g=()=>{z(()=>{var b;(b=k.value)==null||b.scrollToBottom()})},S=()=>{const b={keyword:$.value,page:1};m.value&&m.value.getData(b)};return K(async()=>{await s(),z(()=>{var b;(b=k.value)==null||b.scrollToBottom()}),c.on("onAddMessage",g)}),Z(()=>{c.off("onAddMessage",g),h()}),(b,i)=>{const T=ye,y=be,N=Le;return l(),r("div",jt,[a("div",zt,[a("div",Ht,[R(y,{value:C(v),"onUpdate:value":i[0]||(i[0]=d=>ee(v)?v.value=d:null),style:{width:"100%"},onChange:f},{default:B(()=>[R(T,{value:""},{default:B(()=>i[2]||(i[2]=[H("全部应用")])),_:1,__:[2]}),(l(!0),r(M,null,I(C(L),d=>(l(),q(T,{value:d.id,key:d.id},{default:B(()=>[a("span",null,p(d.robot_name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),a("div",Pt,[R(N,{value:$.value,"onUpdate:value":i[1]||(i[1]=d=>$.value=d),placeholder:"搜索客户昵称或openld，按enter搜索","enter-button":"",style:{width:"100%"},onSearch:S,allowClear:"",onPressEnter:S},null,8,["value"])]),a("div",Ut,[R(Pe,{ref_key:"chatListRef",ref:m,onSwitchChat:_},null,512)])]),a("div",Ft,[C(o)?(l(),q(At,{key:0,ref_key:"chatBoxRef",ref:k},null,512)):(l(),q(se,{key:1,style:{background:"#F2F4F7"},size:"250"},{default:B(()=>i[3]||(i[3]=[a("div",null,[a("p",null,"请在左侧列表先选择会话"),a("p",null,"通过本功能，可以实时查看机器人接待中的会话消息，监控机器人回复效果")],-1)])),_:1,__:[3]}))])])}}},os=D(Jt,[["__scopeId","data-v-c690c066"]]);export{os as default};
