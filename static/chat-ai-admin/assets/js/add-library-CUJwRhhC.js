import{b as fe,an as pe,av as ve,bk as ye,bl as ge,bm as he,d as be,be as ke}from"../../index-ZzVqUZIR.js";import{e as T,ab as xe,f as y,r as D,o as Ne,Y as p,a5 as u,k as t,a2 as r,aa as qe,_,ae as k,a4 as x,u as N,F as w,n as C,a9 as B,ad as O,a1 as A,a7 as g,A as S,G as v,B as we}from"./vue-chunks-yZ4gwLzA.js";import{U as Ae}from"./upload-input-CJJGHjj1.js";import{j as Ce}from"./index-CkBKI6U4.js";import{A as Be}from"./avatar-input-BTbDP7nN.js";import{t as P}from"./validate-8MtiUsxW.js";import{a as I,F as z,e as Se,I as Le,W as Ve,u as Ee,v as Fe,q as Me,R as Ue,bp as Re,J as Te,B as De}from"./ui-antd-BJtyvQX6.js";import"./utils-smNh_pj2.js";const Oe={class:"add-library-page"},Pe={class:"form-box"},Ie={class:"upload-document-type-box"},ze=["onClick"],$e={class:"right-block"},je={class:"title-block"},Je={class:"title-text"},Ge={class:"desc"},Ye={class:"upload-document-type-box"},Qe=["onClick"],We={class:"right-block"},Xe={class:"title-block"},He={class:"title-text"},Ke={class:"desc"};const Ze=["src"],ea={key:0},aa={key:1},la={__name:"add-library",setup(oa){const{getStorage:$,setStorage:j}=pe("localStorage");I.config({duration:2});const L=qe(),J=xe(),s=T(()=>J.query.type||0),V=["azure","ollama","xinference","openaiAgent"],G=["azure"],ta=y([{iconName:"high",iconNameActive:"high-active",title:"高质量",value:1,is_offline:!1,desc:"使用在线的嵌入模型，在召回时具有更高的准确度，但需要花费token"}]),E=y([{iconName:"doc-icon",iconNameActive:"doc-icon-active",title:"本地文档",value:1,desc:`${s.value==2?"上传本地 docx/csv/xlsx 等格式文件":"上传本地 pdf/docx/ofd/txt/md/xlsx/csv/html 等格式文件"}`},{iconName:"link-icon",iconNameActive:"link-icon-active",title:"在线数据",value:2,desc:"获取在线网页内容"},{iconName:"cu-doc-icon",iconNameActive:"cu-doc-active",title:"自定义文档",value:3,desc:"自定义一个空文档，手动添加或编辑内容"}]);s.value==2&&(E.value=E.value.filter(l=>l.value!=2));const Y=y([{iconName:"file-search",iconNameActive:"file-search",title:"问题与答案一起生成索引",value:1,desc:"回答用户提问时，将用户提问与导入的问题和答案一起对比相似度，根据相似度高的问题和答案回复"},{iconName:"comment-search",iconNameActive:"comment-search",title:"仅对问题生成索引",value:2,desc:"回答用户提问时，将用户提问与导入的问题一起对比相似度，再根据相似度高的问题和对应的答案来回复"}]),Q=z.useForm,q=y(!1),W=T(()=>$("lastEmbeddedModel")||{}),X=y(1),H=s.value==0?ve:ye,e=D({type:s.value,access_rights:0,library_name:"",library_intro:"",use_model:"text-embedding-v2",model_config_id:"",library_files:void 0,avatar:H,avatar_file:void 0,is_offline:!1,urls:"",doc_type:1,file_name:"",is_qa_doc:s.value==2?1:0,qa_index_type:1,doc_auto_renew_frequency:1}),F=y(""),K=(l,a)=>s.value==1||a&&a.length>0||e.doc_type!=1?Promise.resolve():Promise.reject(new Error("请上传文件")),Z=(l,a)=>s.value==1||e.doc_type!=2?Promise.resolve():P(a)===!1?Promise.reject(new Error("网页地址不合法")):Promise.resolve(),ee=D({library_name:[{required:!0,message:"请输入库名称",trigger:"change"}],use_model:[{required:!0,message:"请选择嵌入模型",trigger:"change"}],library_files:[{required:s.value==0,message:"请选择文件",trigger:"change",validator:K}],urls:[{required:s.value==0,validator:Z}],file_name:[{required:s.value==0,validator:(l,a)=>s.value==1||e.doc_type!=3||a?Promise.resolve():Promise.reject(new Error("请输入文档名称"))}]}),{validate:ae,validateInfos:h}=Q(e,ee),le=l=>{e.library_files=l},oe=(l,a)=>{const d=a.current_obj;e.use_model=V.indexOf(d.model_define)>-1&&d.deployment_name?d.deployment_name:d.name,F.value=d.model_define,e.model_config_id=d.id||a.model_config_id},te=l=>{e.avatar=l.imageUrl,e.avatar_file=l.file},na=l=>{e.is_offline=l.is_offline,X.value=l.value,e.use_model=void 0,M(l.is_offline)},ne=l=>{e.doc_type=l},ie=l=>{e.qa_index_type=l},re=()=>{L.back()},se=()=>{ae().then(()=>{de()}).catch(l=>{})},de=()=>{let l=new FormData,a=JSON.parse(JSON.stringify(e));G.indexOf(F.value)>-1&&(a.use_model="默认"),l.append("type",e.type),l.append("access_rights",e.access_rights),l.append("library_name",e.library_name),l.append("library_intro",e.library_intro),l.append("use_model",a.use_model),l.append("model_config_id",e.model_config_id),l.append("avatar",e.avatar_file?e.avatar_file:""),l.append("is_offline",e.is_offline),l.append("urls",JSON.stringify(P(e.urls))),l.append("doc_type",e.doc_type),l.append("file_name",e.file_name),l.append("is_qa_doc",e.is_qa_doc),l.append("qa_index_type",e.qa_index_type),l.append("doc_auto_renew_frequency",e.doc_auto_renew_frequency),l.append("is_default",2),j("lastEmbeddedModel",{});let d=!1;(s.value==0||s.value==2)&&e.doc_type==1&&e.library_files.forEach(n=>{(n.name.includes(".xlsx")||n.name.includes(".csv"))&&(d=!0),l.append("library_files",n)}),q.value=!0,ke(l).then(n=>{if(I.success("创建成功"),s.value==1){L.replace({path:"/public-library/config",query:{library_id:n.data.id}}),q.value=!1;return}let i="/library/details/knowledge-document",c={id:n.data.id};d&&(i="/library/document-segmentation",c={document_id:n.data.file_ids[0]}),e.doc_type==3&&(i="/library/preview",c={id:n.data.file_ids[0]}),L.replace({path:i,query:c}),q.value=!1}).catch(()=>{q.value=!1})},b=y([]);function ce(l,a,d){const n=new Set(l.map(i=>i.model_define));return a.filter(i=>{let c=i[d];n.has(c)&&l.filter(f=>{if(f.model_define==c)return f.children=he(f.children,i.children),!1})}),l}const M=l=>{Ce({model_type:"TEXT EMBEDDING",is_offline:l}).then(a=>{let d=a.data||[],n=[];b.value=d.map(i=>{n=[];for(let c=0;c<i.model_info.vector_model_list.length;c++){const f=i.model_info.vector_model_list[c];n.push({name:f,deployment_name:i.model_config.deployment_name,id:i.model_config.id,model_define:i.model_info.model_define})}return i.model_config.id==W.value.model_config_id,{id:i.model_config.id,name:i.model_info.model_name,model_define:i.model_info.model_define,icon:i.model_info.model_icon_url,children:n,deployment_name:i.model_config.deployment_name}}),b.value=ce(ge(b.value,"model_define"),b.value,"model_define"),b.value.forEach(i=>{i.model_define=="chatwiki"&&(e.model_config_id=i.id)})})};return Ne(()=>{M(!1)}),(l,a)=>{const d=Le,n=Se,i=Ve,c=be,f=Fe,U=Ee,ia=Ue,ra=Me,_e=Te,ue=Re,R=De,me=z;return _(),p("div",Oe,[u("div",Pe,[t(me,{"label-col":{span:5}},{default:r(()=>[t(n,x({ref:"name",label:"知识库名称"},N(h).library_name),{default:r(()=>[t(d,{value:e.library_name,"onUpdate:value":a[0]||(a[0]=o=>e.library_name=o),type:"text",placeholder:"请输入知识库名称，最多20个字",maxlength:20},null,8,["value"])]),_:1},16),t(n,{label:"知识库简介"},{default:r(()=>[t(i,{value:e.library_intro,"onUpdate:value":a[1]||(a[1]=o=>e.library_intro=o),placeholder:"请输入知识库介绍"},null,8,["value"])]),_:1}),t(n,x({ref:"name",label:"知识库封面"},N(h).avatar),{default:r(()=>[t(Be,{value:e.avatar,"onUpdate:value":a[2]||(a[2]=o=>e.avatar=o),onChange:te},null,8,["value"]),a[8]||(a[8]=u("div",{class:"form-item-tip"},"请上传知识库封面，建议尺寸为100*100px.大小不超过100kb",-1))]),_:1},16),s.value!=1?(_(),p(w,{key:0},[t(n,{label:"导入文档类型",required:""},{default:r(()=>[u("div",Ie,[(_(!0),p(w,null,B(E.value,o=>(_(),p("div",{class:O(["type-item",{active:e.doc_type==o.value}]),key:o.value,onClick:m=>ne(o.value)},[u("div",$e,[u("div",je,[t(c,{name:e.doc_type==o.value?o.iconNameActive:o.iconName},null,8,["name"]),u("div",Je,g(o.title),1)]),u("div",Ge,g(o.desc),1)]),e.doc_type==o.value?(_(),A(c,{key:0,class:"check-arrow",name:"check-arrow-filled",style:{"font-size":"24px",color:"#fff"}})):k("",!0)],10,ze))),128))])]),_:1}),C(t(n,x({ref:"name",label:"知识库文档"},N(h).library_files),{default:r(()=>[t(Ae,{type:s.value,onChange:le},null,8,["type"])]),_:1},16),[[S,e.doc_type==1]]),C(t(n,x({ref:"urls",label:"网页链接"},N(h).urls),{default:r(()=>[t(i,{style:{height:"120px"},value:e.urls,"onUpdate:value":a[3]||(a[3]=o=>e.urls=o),placeholder:"请输入网页链接,形式：一行标题一行网页链接"},null,8,["value"])]),_:1},16),[[S,e.doc_type==2]]),C(t(n,{ref:"doc_auto_renew_frequency",label:"更新频率",required:""},{default:r(()=>[t(U,{value:e.doc_auto_renew_frequency,"onUpdate:value":a[4]||(a[4]=o=>e.doc_auto_renew_frequency=o),style:{width:"100%"}},{default:r(()=>[t(f,{value:1},{default:r(()=>[...a[9]||(a[9]=[v("不自动更新",-1)])]),_:1}),t(f,{value:2},{default:r(()=>[...a[10]||(a[10]=[v("每天",-1)])]),_:1}),t(f,{value:3},{default:r(()=>[...a[11]||(a[11]=[v("每3天",-1)])]),_:1}),t(f,{value:4},{default:r(()=>[...a[12]||(a[12]=[v("每7天",-1)])]),_:1}),t(f,{value:5},{default:r(()=>[...a[13]||(a[13]=[v("每30天",-1)])]),_:1})]),_:1},8,["value"])]),_:1},512),[[S,e.doc_type==2]]),C(u("div",null,[t(n,x({ref:"file_name",label:"文档名称"},N(h).file_name),{default:r(()=>[t(d,{placeholder:"请输入文档名称",value:e.file_name,"onUpdate:value":a[5]||(a[5]=o=>e.file_name=o)},null,8,["value"])]),_:1},16),k("",!0),e.is_qa_doc==1?(_(),A(n,{key:1,label:"索引方式",required:""},{default:r(()=>[u("div",Ye,[(_(!0),p(w,null,B(Y.value,o=>(_(),p("div",{class:O(["type-item",{active:e.qa_index_type==o.value}]),key:o.value,onClick:m=>ie(o.value)},[u("div",We,[u("div",Xe,[t(c,{name:e.qa_index_type==o.value?o.iconNameActive:o.iconName},null,8,["name"]),u("div",He,g(o.title),1)]),u("div",Ke,g(o.desc),1)]),e.qa_index_type==o.value?(_(),A(c,{key:0,class:"check-arrow",name:"check-arrow-filled",style:{"font-size":"24px",color:"#fff"}})):k("",!0)],10,Qe))),128))])]),_:1})):k("",!0)],512),[[S,e.doc_type==3]])],64)):k("",!0),t(n,x({label:"嵌入模型 "},N(h).use_model),{default:r(()=>[k("",!0),t(U,{value:e.use_model,"onUpdate:value":a[7]||(a[7]=o=>e.use_model=o),placeholder:"请选择嵌入模型",onChange:oe},{default:r(()=>[(_(!0),p(w,null,B(b.value,o=>(_(),A(ue,{key:o.id},{label:r(()=>[t(_e,{align:"center",gap:6},{default:r(()=>[u("img",{class:"model-icon",src:o.icon,alt:""},null,8,Ze),v(g(o.name),1)]),_:2},1024)]),default:r(()=>[(_(!0),p(w,null,B(o.children,m=>(_(),A(f,{value:V.indexOf(o.model_define)>-1&&m.deployment_name?m.deployment_name:m.name+m.id,model_config_id:o.id,current_obj:m,key:m.name+m.id},{default:r(()=>[V.indexOf(o.model_define)>-1&&m.deployment_name?(_(),p("span",ea,g(m.deployment_name),1)):(_(),p("span",aa,g(m.name),1))]),_:2},1032,["value","model_config_id","current_obj"]))),128))]),_:2},1024))),128))]),_:1},8,["value"])]),_:1},16),t(n,{"wrapper-col":{span:14,offset:4}},{default:r(()=>[t(R,{onClick:re},{default:r(()=>[...a[16]||(a[16]=[v("取 消",-1)])]),_:1}),t(R,{type:"primary",style:{"margin-left":"16px"},loading:q.value,onClick:we(se,["prevent"])},{default:r(()=>[...a[17]||(a[17]=[v("下一步",-1)])]),_:1},8,["loading"])]),_:1})]),_:1})])])}}},va=fe(la,[["__scopeId","data-v-5119e082"]]);export{va as default};
