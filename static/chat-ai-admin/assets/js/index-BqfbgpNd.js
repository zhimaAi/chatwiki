import{M as Ne}from"./multi-reply-BleoyWnP.js";import{e as J,ab as Pe,f as b,o as Ve,y as Oe,b as Ye,r as Fe,Y as r,_ as o,a5 as l,k as u,ae as h,G as g,ad as Q,a1 as B,F as q,a9 as X,a7 as w,a2 as d,u as L,aa as Ue}from"./vue-chunks-Ci-XTWEs.js";import{a as Z,d as qe,u as We,b as ee,s as je,c as Ke}from"./index-DzgHDarz.js";import{b as se,an as Ge,ao as He}from"../../index-BZRrEp3V.js";import{u as Je}from"./robot-ChheCicf.js";import{a as f,X as Qe,B as Xe,Z as Ze,Y as et,k as tt,z as te,u as at,O as st,E as nt,p as it,ab as ae,y as ot,R as lt,q as ut,d as pt,M as rt}from"./ui-antd-BWf8LxGy.js";import"./index-BpTkDq9_.js";import"./utils-ChQO-_r6.js";import"./index-BOvAmdHY.js";const _t={class:"user-model-page"},dt={class:"switch-block"},ct={class:"mp-list-block"},yt=["onClick"],mt=["src"],vt={class:"mp-name"},bt={key:0},ft={key:1},ht={key:2},kt={key:0,class:"search-block"},gt={class:"left-block"},wt={class:"search-item"},xt={key:1,class:"list-box"},Ct={key:0},St={key:1},Rt={key:2},$t={key:0,style:{color:"#595959"}},At={key:1,style:{color:"#595959"}},Tt={key:3,style:{color:"#595959"}},Dt={key:4,style:{color:"#595959","white-space":"pre-wrap"}},It=["onClick"],zt=["onClick"],Et=["onClick"],Bt={key:2,class:"reply-editor"},Lt={class:"reply-editor-item"},Mt={class:"switch-box"},Nt={class:"content-box"},Pt={class:"item-box"},Vt={class:"method-box"},Ot={style:{"margin-top":"16px"}},Yt=160,Ft=8,Ut=96,qt={__name:"received-reply",setup(ne){const O=Je(),W=J(()=>O.subscribeReplySwitchStatus==="1"),_=Pe().query,Y=Ue(),c=b(_.rule_type||"subscribe_reply_default"),y=b([{type:"text",description:""}]),I=b("0"),S=b(0),R=b("0"),$=b([]),m=b(""),z=b(!1),j=b(null),E=b(0);function F(){const t=j.value;if(!t){E.value=0;return}const e=t.clientWidth||0,a=Yt+Ft,n=Math.floor((e-Ut)/a);E.value=Math.max(n,0)}Ve(()=>{var t;$.value=[{id:"mp-1",appid:"wx_appid_A",name:"企业公众号A",logo:"https://dummyimage.com/48x48/2475fc/ffffff&text=A"},{id:"mp-2",appid:"wx_appid_B",name:"企业公众号B",logo:"https://dummyimage.com/48x48/52c41a/ffffff&text=B"},{id:"mp-3",appid:"wx_appid_C",name:"企业公众号C",logo:"https://dummyimage.com/48x48/f5222d/ffffff&text=C"},{id:"mp-4",appid:"wx_appid_D",name:"企业公众号D",logo:"https://dummyimage.com/48x48/13c2c2/ffffff&text=D"},{id:"mp-5",appid:"wx_appid_E",name:"企业公众号E",logo:"https://dummyimage.com/48x48/722ed1/ffffff&text=E"},{id:"mp-6",appid:"wx_appid_F",name:"企业公众号F",logo:"https://dummyimage.com/48x48/fa8c16/ffffff&text=F"}],m.value=((t=$.value[0])==null?void 0:t.appid)||"",Oe(F),window.addEventListener("resize",F),c.value==="subscribe_reply_default"&&N()}),Ye(()=>{window.removeEventListener("resize",F)});const ie=[{title:"关注来源",dataIndex:"subscribe_source",key:"subscribe_source",width:120},{title:"回复内容",dataIndex:"reply_content",key:"reply_content",width:120},{title:"回复方式",dataIndex:"reply_num",key:"reply_num",width:120},{title:"创建时间",dataIndex:"create_time",key:"create_time",width:120},{title:"启用状态",dataIndex:"switch_status",key:"switch_status",width:120},{title:"操作",dataIndex:"action",key:"action",width:120}],oe=[{title:"时间段",dataIndex:"duration",key:"duration",width:220},{title:"回复内容",dataIndex:"reply_content",key:"reply_content",width:120},{title:"回复方式",dataIndex:"reply_num",key:"reply_num",width:120},{title:"优先级",dataIndex:"priority_num",key:"priority_num",width:120},{title:"创建时间",dataIndex:"create_time",key:"create_time",width:120},{title:"启用状态",dataIndex:"switch_status",key:"switch_status",width:120},{title:"操作",dataIndex:"action",key:"action",width:120}],le=J(()=>c.value==="subscribe_reply_duration"?oe:ie),v=Fe({page:1,size:10,total:0}),ue=Ge,K=b([]),U=b(!1),M=b(""),C=()=>{const t={robot_id:_.id,rule_type:c.value,reply_type:M.value||"",appid:m.value||"",page:v.page,size:v.size};U.value=!0,Z({...t}).then(e=>{const a=(e==null?void 0:e.data)||{list:[],total:0,page:v.page,size:v.size};K.value=(a.list||[]).map(n=>({...n,reply_content:Array.isArray(n.reply_content)?n.reply_content:[],switch_status:String(n.switch_status??"0"),duration_type:n.duration_type||"",start_duration:n.start_duration||"",end_duration:n.end_duration||"",priority_num:n.priority_num??"",subscribe_source:Array.isArray(n.subscribe_source)?n.subscribe_source:[]})),v.total=+a.total||0}).finally(()=>{U.value=!1})};C();const pe=t=>{v.page=t.current,v.size=t.pageSize,C()},re=()=>{v.page=1,C()},_e=t=>{M.value=t,re()},de=()=>{v.page=1,C(),c.value==="subscribe_reply_default"&&N()};function ce(t){m.value=t.appid,z.value=!0,v.page=1,C(),c.value==="subscribe_reply_default"&&N()}async function G(t){const e=Number(t.priority_num);if(!Number.isInteger(e)||e<0){f.error("请输入有效的优先级");return}try{await We({id:t.id,robot_id:_.id,priority_num:e,appid:m.value||""}),f.success("优先级已更新"),C()}catch{f.error("更新失败，请稍后重试")}}const ye=()=>{Y.push({path:"/robot/ability/subscribe-reply/add-rule",query:{id:_.id,robot_key:_.robot_key,rule_type:c.value,appid:m.value||""}})},me=t=>{Y.push({path:"/robot/ability/subscribe-reply/add-rule",query:{id:_.id,robot_key:_.robot_key,rule_id:t.id,appid:m.value||""}})},ve=t=>{Y.push({path:"/robot/ability/subscribe-reply/add-rule",query:{id:_.id,robot_key:_.robot_key,copy_id:t.id,appid:m.value||""}})},be=t=>{const e=t?"1":"0";je({robot_id:_.id,ability_type:"robot_subscribe_reply",switch_status:e}).then(a=>{a&&a.res==0&&(O.setSubscribeReplySwitchStatus(e),f.success("操作成功"),window.dispatchEvent(new CustomEvent("robotAbilityUpdated",{detail:{robotId:_.id}})))})},fe=(t,e)=>{const a=e;ee({id:t.id,robot_id:_.id,switch_status:a,appid:m.value||""}).then(n=>{n&&n.res==0&&(t.switch_status=a,f.success("操作成功"))})},he=t=>{rt.confirm({title:"确认删除吗？",okText:"确认",onOk:()=>{qe({id:t.id,robot_id:_.id}).then(e=>{e&&e.res==0&&(f.success("删除成功"),C())})}})};function ke(t){return(t||[]).map(e=>({...e,status:"1"}))}function ge(t){const e={text:"2",image:"4",card:"3",imageText:"1",url:"5"};return t.map(a=>e[a.type]||"").filter(Boolean)}async function N(){var t;try{const e=await Z({robot_id:_.id,rule_type:"subscribe_reply_default",appid:m.value||"",page:1,size:1}),a=Array.isArray((t=e==null?void 0:e.data)==null?void 0:t.list)?e.data.list[0]:null;if(!a){S.value=0,y.value=[{type:"text",description:""}],I.value="0",R.value="0";return}S.value=Number(a.id||0);const n=Array.isArray(a.reply_content)?a.reply_content:[];y.value=n.map(s=>({type:(s==null?void 0:s.type)||(s==null?void 0:s.reply_type)||"text",description:(s==null?void 0:s.description)||"",thumb_url:(s==null?void 0:s.thumb_url)||(s==null?void 0:s.pic)||"",title:(s==null?void 0:s.title)||"",url:(s==null?void 0:s.url)||"",appid:(s==null?void 0:s.appid)||"",page_path:(s==null?void 0:s.page_path)||""})),I.value=String(a.reply_num??"0"),R.value=String(a.switch_status??"0")}catch{f.error("加载默认回复失败")}}async function we(){if(!m.value){f.warning("请选择公众号");return}if(!y.value.length){f.warning("请至少添加一条回复内容");return}const t={robot_id:_.id,appid:m.value,rule_type:"subscribe_reply_default",reply_content:JSON.stringify(ke(y.value)),reply_type:ge(y.value),reply_num:Number(I.value)||0,switch_status:Number(R.value)||0};S.value&&(t.id=S.value);try{const e=await Ke(t);e&&e.res==0&&(f.success("保存成功"),N())}catch{f.error("保存失败，请稍后重试")}}function xe(t){const e=String(t);if(!S.value){R.value=e,f.info("请先完善回复内容并保存");return}ee({id:S.value,robot_id:_.id,switch_status:e,appid:m.value||""}).then(a=>{a&&a.res==0&&(R.value=e,f.success("操作成功"))})}function Ce(t){return He[t]||""}function Se(t){if(!Array.isArray(t))return"";const e=t.map(n=>Ce(n==null?void 0:n.type)).filter(n=>!!n);return[...new Set(e)].join("/")}function Re(t){const e={1:"周一",2:"周二",3:"周三",4:"周四",5:"周五",6:"周六",7:"周日"},a=String(t||"");return e[a]||a}function P(t){const e=String(t||"");return e?/^\d{4}-\d{2}-\d{2}/.test(e)?e.slice(0,10):e:""}function $e(t,e="YYYY-MM-DD"){return t?pt(t*1e3).format(e):""}function V(t){const e=String(t||"");return e?/^\d{2}:\d{2}/.test(e)?e.slice(0,5):e:""}function Ae(t){const e=(t==null?void 0:t.duration_type)||"",a=(t==null?void 0:t.week_duration)||"",n=(t==null?void 0:t.start_duration)||"",s=(t==null?void 0:t.end_duration)||"";if(e==="week"){const A=Array.isArray(a)?a.map(x=>String(x)):a?[String(a)]:[],T=A.length?A.map(x=>Re(x)).join("、"):"",D=`${V(n)} 至 ${V(s)}`;return T?`每星期${T}：${D}`:`每星期：${D}`}if(e==="day")return`每天：${P(n)} 至 ${P(s)}`;if(e==="time_range"){const A=(t==null?void 0:t.start_day)||"",T=(t==null?void 0:t.end_day)||"",D=`${P(A)} ${V(n)}`.trim(),x=`${P(T)} ${V(s)}`.trim();return`自定义时间：
${D} 至 ${x}`}return`${e||""}：${n||""} 至 ${s||""}`}function Te(t){const e=Array.isArray(t==null?void 0:t.subscribe_source)?t.subscribe_source:[];return e.length?e.join("、"):"--"}function De(){y.value.length>=5||y.value.push({type:"text",description:""})}function Ie({reply_index:t,...e}){t>=0&&t<y.value.length&&(y.value[t]=e)}function ze(t){y.value.splice(t,1)}return(t,e)=>{const a=Qe,n=Xe,s=Ze,A=et,T=tt,D=at,x=it,Ee=st,Be=nt,Le=ot,H=lt,Me=ut;return o(),r("div",_t,[e[13]||(e[13]=l("div",{class:"page-title"},"关注后自动回复",-1)),l("div",dt,[u(a,{onChange:be,checked:W.value,"checked-children":"开","un-checked-children":"关"},null,8,["checked"]),e[4]||(e[4]=l("span",{class:"switch-desc"},[g(" 开启后，用户关注公众号后，回复指定的内容，"),l("span",{style:{color:"#FF4D4F"}},"该功能仅支持公众号内回复")],-1))]),l("div",ct,[l("div",{class:Q(["mp-list",{expanded:z.value}]),ref_key:"mpListRef",ref:j},[(o(!0),r(q,null,X(z.value?$.value:$.value.slice(0,E.value),i=>(o(),r("div",{class:Q(["mp-card",{selected:i.appid===m.value}]),key:i.id,onClick:p=>ce(i)},[l("img",{src:i.logo,class:"mp-logo"},null,8,mt),l("span",vt,w(i.name),1)],10,yt))),128)),!z.value&&$.value.length>E.value?(o(),B(n,{key:0,type:"dashed",class:"more-btn",onClick:e[0]||(e[0]=i=>z.value=!0)},{default:d(()=>[g(" 更多 +"+w($.value.length-E.value),1)]),_:1})):h("",!0)],2)]),u(A,{activeKey:c.value,"onUpdate:activeKey":e[1]||(e[1]=i=>c.value=i),onChange:de,style:{"margin-top":"8px"}},{default:d(()=>[u(s,{key:"subscribe_reply_default",tab:"默认回复"}),u(s,{key:"subscribe_reply_duration",tab:"按时段设置"}),u(s,{key:"subscribe_reply_source",tab:"按关注来源设置"})]),_:1},8,["activeKey"]),u(T,{"show-icon":""},{message:d(()=>[c.value==="subscribe_reply_default"?(o(),r("p",bt,"关注后1分钟内只能给粉丝发送3条消息。建议关注后自动回复数量不要超过2条。可以根据关注来源或关注时间段单独设置回复")):c.value==="subscribe_reply_duration"?(o(),r("p",ft,"优先级设置的区间为1-100的自然整数，数字越小，优先级越高。触发优先级为：按时间段回复>按关注来源回复>默认回复。")):(o(),r("p",ht,"触发优先级为：按时间段回复>按关注来源回复>默认回复。"))]),_:1}),c.value!=="subscribe_reply_default"?(o(),r("div",kt,[l("div",gt,[u(n,{type:"primary",onClick:ye},{icon:d(()=>[u(L(te))]),default:d(()=>[g(" "+w(c.value==="subscribe_reply_default"?"新增回复":"增加时段回复"),1)]),_:1}),l("div",wt,[u(D,{modelValue:M.value,"onUpdate:modelValue":e[2]||(e[2]=i=>M.value=i),placeholder:"回复内容",allowClear:"",options:L(ue),style:{width:"240px"},onChange:_e},null,8,["modelValue","options"])])])])):h("",!0),c.value!=="subscribe_reply_default"?(o(),r("div",xt,[u(Le,{columns:le.value,"data-source":K.value,loading:U.value,pagination:{current:v.page,total:v.total,pageSize:v.size,showQuickJumper:!0,showSizeChanger:!0,pageSizeOptions:["10","20","50","100"]},onChange:pe},{headerCell:d(({column:i})=>[i.key==="priority_num"?(o(),r("span",Ct,[e[5]||(e[5]=g(" 优先级 ")),u(x,{title:"优先级设置的数值不能重复，数值越小，优先级越高"},{default:d(()=>[u(L(ae))]),_:1})])):i.key==="switch_status"?(o(),r("span",St,[e[6]||(e[6]=g(" 启用状态 ")),u(x,{title:c.value==="receive_reply_message_type"?"开启开关后，触发消息类型回复指定的内容":"开启后，按照设置的时间段回复指定的内容"},{default:d(()=>[u(L(ae))]),_:1},8,["title"])])):(o(),r("span",Rt,w(i.title),1))]),bodyCell:d(({column:i,record:p})=>[i.key==="subscribe_source"?(o(),r("span",$t,w(Te(p)),1)):h("",!0),i.key==="reply_content"?(o(),r("span",At,w(Se(p.reply_content)||"--"),1)):h("",!0),i.key==="reply_num"?(o(),r(q,{key:2},[g(w(p.reply_num==0?"全部回复":"随机回复一条"),1)],64)):h("",!0),i.key==="create_time"?(o(),r("span",Tt,w($e(p.create_time)||"--"),1)):h("",!0),i.key==="duration"?(o(),r("span",Dt,w(Ae(p)),1)):h("",!0),i.key==="priority_num"?(o(),B(Ee,{key:5,value:p.priority_num,"onUpdate:value":k=>p.priority_num=k,min:1,max:100,precision:0,style:{width:"96px"},onBlur:k=>G(p),onPressEnter:k=>G(p)},null,8,["value","onUpdate:value","onBlur","onPressEnter"])):h("",!0),i.key==="switch_status"?(o(),B(a,{key:6,checked:p.switch_status,checkedValue:"1","un-checkedValue":"0","checked-children":"开","un-checked-children":"关",onChange:k=>fe(p,k)},null,8,["checked","onChange"])):h("",!0),i.key==="action"?(o(),B(Be,{key:7,gap:8},{default:d(()=>[l("a",{onClick:k=>me(p)},"编辑",8,It),l("a",{onClick:k=>he(p)},"删除",8,zt),l("a",{onClick:k=>ve(p)},"复制",8,Et)]),_:2},1024)):h("",!0)]),_:1},8,["columns","data-source","loading","pagination"])])):h("",!0),c.value==="subscribe_reply_default"?(o(),r("div",Bt,[l("div",Lt,[l("div",Mt,[e[7]||(e[7]=l("div",{class:"nav-box"},"关注后自动回复：",-1)),u(a,{checked:R.value,checkedValue:"1","un-checkedValue":"0","checked-children":"开","un-checked-children":"关",onChange:xe},null,8,["checked"])]),l("div",Nt,[e[8]||(e[8]=l("div",{class:"nav-box"},"回复内容：",-1)),l("div",Pt,[(o(!0),r(q,null,X(y.value,(i,p)=>(o(),B(Ne,{key:p,value:y.value[p],"onUpdate:value":k=>y.value[p]=k,reply_index:p,onChange:Ie,onDel:ze},null,8,["value","onUpdate:value","reply_index"]))),128)),u(n,{type:"dashed",style:{width:"694px"},disabled:y.value.length>=5,onClick:De},{icon:d(()=>[u(L(te))]),default:d(()=>[g(" 添加回复内容("+w(y.value.length)+"/5) ",1)]),_:1},8,["disabled"])])]),l("div",Vt,[e[11]||(e[11]=l("div",{class:"nav-box"},"回复方式：",-1)),u(Me,{value:I.value,"onUpdate:value":e[3]||(e[3]=i=>I.value=i)},{default:d(()=>[u(H,{value:"0"},{default:d(()=>e[9]||(e[9]=[g("全部回复")])),_:1,__:[9]}),u(H,{value:"1"},{default:d(()=>e[10]||(e[10]=[g("随机回复一条")])),_:1,__:[10]})]),_:1},8,["value"])]),l("div",Ot,[u(n,{type:"primary",onClick:we},{default:d(()=>e[12]||(e[12]=[g("保存")])),_:1,__:[12]})])])])):h("",!0)])}}},Wt=se(qt,[["__scopeId","data-v-5c263692"]]),jt={class:"auto-reply-home"},Kt={__name:"index",setup(ne){return(O,W)=>(o(),r("div",jt,[u(Wt)]))}},sa=se(Kt,[["__scopeId","data-v-de948fb2"]]);export{sa as default};
