import{e as ee,f as x,w as ie,Y as c,_ as d,k as e,a5 as k,a2 as o,u as z,a7 as F,F as Q,a9 as j,ad as ue,r as te,ae as D,G as v,y as de,q as _e,n as ce,b as re,a1 as Y,aa as pe}from"./vue-chunks-Ci-XTWEs.js";import{b as E,bZ as me,b_ as fe,b$ as ke,h as ve,k as he,c0 as ge,c1 as ye,c2 as xe,c3 as be}from"../../index-BZRrEp3V.js";import{P as Ce}from"./page-tabs-Bo5Jwmm1.js";import{_ as we}from"./page-alert-Bj7e6e5x.js";import{as as Fe,at as $e,a as M,F as De,e as ze,q as Me,R as qe,O as Ie,Q as Te,M as N,bh as Se,B as Oe,w as Ue,$ as Ae,bp as Z,ac as Le,b8 as Re,E as Qe,av as Ne,b as Ee,c as Pe,D as Be,y as He,d as X,H as Ve}from"./ui-antd-BWf8LxGy.js";import{M as Ye}from"./model-select-S5ievtWN.js";import{I as Ke}from"./import-knowledge-modal-DdZYgl8o.js";import"./utils-ChQO-_r6.js";import"./index-UUVUVnDU.js";import"./validate-8MtiUsxW.js";const je={class:"ant-upload-drag-icon"},Je={class:"ant-upload-hint"},We={__name:"upload-input",props:{value:{type:Array,default:()=>[]},maxCount:{type:Number,default:1},type:{type:[String,Number],default:0}},emits:["change","update:value"],setup(U,{emit:q}){const $=q,m=U;let n=["docx","txt","md"];const I=ee(()=>n.map(u=>`.${u}`).join(",")),i=x([]);ie(()=>m.value,u=>{i.value=u},{immediate:!0});let C=null;const r=()=>{if(i.value.length>=m.maxCount)return M.error("一次最多上传"+m.maxCount+"个文件")},f=()=>{i.value.length>m.maxCount&&M.error("一次最多上传"+m.maxCount+"个文件");let u=[...i.value];$("change",u),$("update:value",u)},b=u=>{w(u),f()},w=u=>{for(let _=0;_<i.value.length;_++)if(i.value[_].uid===u.uid){i.value.splice(_,1);break}},T=u=>{const _=u.name.split(".").pop();return n.includes(_.toLowerCase())?u.size/1024/1024<100?(i.value=[...i.value||[],u],i.value.length>m.maxCount&&(i.value=i.value.splice(0,m.maxCount)),C&&clearTimeout(C),C=setTimeout(()=>{f(),clearTimeout(C)},50),!1):(M.error("文件大小不能超过100M"),!1):(M.error("不支持的文件格式"),!1)};return(u,_)=>{const p=$e;return d(),c("div",{class:ue(["upload-input",{disabled:i.value.length>=m.maxCount}])},[e(p,{"file-list":i.value,name:"file",multiple:!0,"max-count":m.maxCount,accept:I.value,beforeUpload:T,onRemove:b,class:"ant-upload-drag"},{default:o(()=>[k("div",je,[e(z(Fe))]),_[1]||(_[1]=k("div",{class:"ant-upload-text"},"点击或将文件拖拽到这里上传",-1)),k("div",Je,[k("p",null,"一次只能上传"+F(m.maxCount)+"个文档，单个文件不超过100M",1),k("p",null,[_[0]||(_[0]=k("span",null,"支持文件类型：",-1)),(d(!0),c(Q,null,j(z(n),s=>(d(),c("span",{class:"ant-upload-hint-ext",key:s},"."+F(s),1))),128))])])]),_:1,__:[1]},8,["file-list","max-count","accept"]),k("div",{class:"disabled-mask",onClick:r})],2)}}},Ge=E(We,[["__scopeId","data-v-092c4c31"]]),Ze={key:0,class:"mt8"},K=`根据user角色提供的文本，学习和分析它，并整理学习成果：
- 提出问题并给出每个问题的答案。
- 答案需详细完整，尽可能保留原文描述，可以适当扩展答案描述。
- 答案可以包含普通文字、链接、代码、表格、公示、媒体链接等 Markdown 元素。
- 最多提出 50 个问题。
- 生成的问题和答案和源文本语言相同。`,Xe={__name:"upload-document",emits:["ok"],setup(U,{expose:q,emit:$}){const m=$,n=te({faq_files:[],chunk_model:"",chunk_model_config_id:"",chunk_type:1,chunk_size:8e3,chunk_prompt:K}),I=x({chunk_model_config_id:[{message:"请选择提取模型",required:!0}],faq_files:[{message:"请选择文件",required:!0}]}),i=x(!1),C=()=>{i.value=!0,me().then(p=>{let s=p.data||{chunk_model:"",chunk_model_config_id:"",chunk_size:8e3,chunk_prompt:K};n.faq_files=[],n.chunk_model=s.chunk_model,n.chunk_model_config_id=s.chunk_model_config_id,n.chunk_type=1,n.chunk_size=s.chunk_size||8e3,n.chunk_prompt=s.chunk_prompt||K,setTimeout(()=>{!n.chunk_model_config_id&&u.value.length>0&&u.value[0].children&&u.value[0].children.length&&(n.chunk_model_config_id=u.value[0].model_config_id,n.chunk_model=u.value[0].children[0].name)},500)})},r=x(!1),f=x(null),b=()=>{f.value.validate().then(()=>{w()}).catch(()=>{r.value=!1})},w=()=>{let p=new FormData;n.faq_files.forEach(s=>{p.append("faq_files",s)}),p.append("chunk_type",n.chunk_type),p.append("chunk_size",n.chunk_size),p.append("chunk_model",n.chunk_model),p.append("chunk_model_config_id",n.chunk_model_config_id),p.append("chunk_prompt",n.chunk_prompt),r.value=!0,fe(p).then(s=>{M.success("上传成功"),m("ok"),i.value=!1}).finally(()=>{r.value=!1})};x([]);const T=p=>{n.faq_files=p,f.value.validate(["faq_files"])},u=x([]),_=p=>{u.value=p,de(()=>{})};return q({show:C}),(p,s)=>{const S=ze,P=qe,B=Me,H=Ie,A=Te,L=De,V=N;return d(),c("div",null,[e(V,{open:i.value,"onUpdate:open":s[6]||(s[6]=h=>i.value=h),"confirm-loading":r.value,title:"上传文档",width:"746px",onOk:b},{default:o(()=>[e(L,{class:"url-add-form",layout:"vertical",ref_key:"formRef",ref:f,model:n,rules:I.value},{default:o(()=>[e(S,{name:"faq_files",label:null},{default:o(()=>[e(Ge,{maxCount:1,value:n.faq_files,"onUpdate:value":s[0]||(s[0]=h=>n.faq_files=h),onChange:T},null,8,["value"])]),_:1}),e(S,{name:"chunk_model_config_id",label:"提取模型"},{default:o(()=>[e(Ye,{modelType:"LLM",placeholder:"请选择AI大模型",modeName:n.chunk_model,"onUpdate:modeName":s[1]||(s[1]=h=>n.chunk_model=h),modeId:n.chunk_model_config_id,"onUpdate:modeId":s[2]||(s[2]=h=>n.chunk_model_config_id=h),style:{width:"100%"},onLoaded:_},null,8,["modeName","modeId"])]),_:1}),e(S,{label:"分块方式"},{default:o(()=>[e(B,{value:n.chunk_type,"onUpdate:value":s[3]||(s[3]=h=>n.chunk_type=h)},{default:o(()=>[e(P,{value:1},{default:o(()=>s[7]||(s[7]=[v("按长度")])),_:1,__:[7]})]),_:1},8,["value"]),n.chunk_type==1?(d(),c("div",Ze,[e(H,{value:n.chunk_size,"onUpdate:value":s[4]||(s[4]=h=>n.chunk_size=h),min:1,max:1e4,step:1,placeholder:"请输入",style:{width:"300px"}},null,8,["value"])])):D("",!0)]),_:1}),e(S,{label:"FAQ提取提示词"},{default:o(()=>[e(A,{value:n.chunk_prompt,"onUpdate:value":s[5]||(s[5]=h=>n.chunk_prompt=h),style:{height:"150px"},placeholder:"请输入"},null,8,["value"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["open","confirm-loading"])])}}},et=E(Xe,[["__scopeId","data-v-3b72cbfe"]]),tt={class:"list-box"},at={class:"error-tip"},nt={class:"content-block"},lt={class:"fragment-img"},ot=["src"],st={__name:"fail-detail",setup(U,{expose:q}){const $=x(!1),m=x([]),n=i=>{$.value=!0,m.value=[],I(i.id)},I=i=>{ke({id:i}).then(C=>{let r=C.data||[];m.value=r.map(f=>({...f,images:f.images?JSON.parse(f.images):[]}))})};return q({show:n}),(i,C)=>{const r=N,f=_e("viewer");return d(),c("div",null,[e(r,{wrapClassName:"no-padding-modal",bodyStyle:{"padding-right":"24px","max-height":"650px","overflow-y":"auto"},open:$.value,"onUpdate:open":C[0]||(C[0]=b=>$.value=b),title:"提取失败分段",width:746,footer:null},{default:o(()=>[k("div",tt,[(d(!0),c(Q,null,j(m.value,b=>(d(),c("div",{class:"list-item",key:b.id},[k("div",at,F(b.split_errmsg),1),k("div",nt,F(b.content),1),ce((d(),c("div",lt,[(d(!0),c(Q,null,j(b.images,(w,T)=>(d(),c("img",{key:T,src:w,alt:""},null,8,ot))),128))])),[[f]])]))),128))])]),_:1},8,["open"])])}}},it=E(st,[["__scopeId","data-v-4796072d"]]),ut={class:"library-page"},dt={class:"library-page-body"},_t={key:0,class:"btn-block"},ct={class:"list-box"},rt=["onClick"],pt={key:0,class:"status-block status-bule"},mt={key:1,class:"status-block status-bule"},ft={key:2,class:"status-block status-bule"},kt={key:3,class:"status-block status-green"},vt={key:4,class:"status-block status-red"},ht=["onClick"],gt={key:1},yt={key:2},xt=["onClick"],bt={__name:"index",setup(U){const q=ve(),$=pe(),m=he();let{role_permission:n,role_type:I}=m;const i=ee(()=>I==1||n.includes("UploadDocFaq")),C=x([{title:"知识库",path:"/library/list"},{title:"数据库",path:"/database/list"},{title:"文档提取FAQ",path:"/ai-extract-faq/list"},{title:"触发次数统计",path:"/trigger-statics/list"}]),r=te({page:1,size:20,total:0}),f=x([{}]),b=x(!1),w=()=>{b.value=!1,ge({...r}).then(t=>{let a=t.data.list||[];a=a.map(y=>{let g=X(y.create_time*1e3).format("YY-MM-DD HH:mm");return{...y,create_time_desc:g}}),r.total=+t.data.total,f.value=a,p()}).finally(()=>{b.value=!1})};w();const T=()=>{r.page=1,w()},u=t=>{r.page=t.current,r.size=t.pageSize,w()};let _={};const p=()=>{f.value.forEach(t=>{t.status==2&&s(t.id)})};function s(t){_[t]&&clearInterval(_[t]),_[t]=setInterval(async()=>{try{const y=(await xe({id:t})).data;y.create_time_desc=X(y.create_time*1e3).format("YY-MM-DD HH:mm");const g=f.value.findIndex(R=>R.id==t);g!==-1&&f.value.splice(g,1,y),y.status!=2&&S(t)}catch{S(t)}},5e3)}function S(t){_[t]&&(clearInterval(_[t]),delete _[t])}const P=t=>{N.confirm({title:"删除确认",icon:e(Ve),content:`是否删除该文件【${t.file_name}】?`,okText:"确定",cancelText:"取消",okType:"danger",onOk(){B(t)},onCancel(){}})},B=({id:t})=>{ye({id:t}).then(()=>{M.success("删除成功"),w()})},H=t=>{N.confirm({title:"重新分段确认",icon:null,okText:"确定",cancelText:"取消",onOk(){be({id:t.id}).then(a=>{M.success("重新分段成功"),w()})},onCancel(){}})},A=t=>{if(t.status==2||t.status==3){$.push({path:"/ai-extract-faq/details",query:{id:t.id,file_name:t.file_name}});return}let a="无法查看文件详情";t.status==0&&(a="排队中,请稍候"),t.status==1&&(a="文档解析中,请稍候"),t.status==4&&(a="提取失败, 无法查看详情"),M.error(a)},L=x(null),V=()=>{L.value.show()},h=x(null),ae=t=>{h.value.show({...t})},J=(t,a)=>{let y=q.getToken,g=`/manage/exportFAQFileAllQA?id=${a}&token=${y}&ext=${t}`;window.location.href=g},W=x(null),ne=t=>{W.value.show({...t})};return re(()=>{Object.keys(_).forEach(t=>{clearInterval(_[t])}),_={}}),(t,a)=>{const y=Oe,g=Ue,R=Qe,G=Pe,le=Ee,oe=Be,se=He;return d(),c(Q,null,[k("div",ut,[e(Ce,{class:"mb-16",tabs:C.value,active:"/ai-extract-faq/list"},null,8,["tabs"]),e(we,{style:{"margin-bottom":"16px"},title:"使用说明"},{default:o(()=>a[0]||(a[0]=[k("div",null,[k("p",null," 1、文档拆分成若干大段落，然后由大模型从大段落中抽取问答对。问答对类型的只是由很高的检索精度，但是大模型提取问答对的过程中也可能会导致部分细节丢失。 "),k("p",null," 2、提取成功的文档，您可以下载到本地查看（系统会自动保存成docx格式），也可以直接导入到指定的问答知识库中。 ")],-1)])),_:1,__:[0]}),k("div",dt,[i.value?(d(),c("div",_t,[e(y,{onClick:V,type:"primary",icon:e(z(Se))},{default:o(()=>a[1]||(a[1]=[v("上传文档提取")])),_:1,__:[1]},8,["icon"])])):D("",!0),k("div",ct,[e(se,{"data-source":f.value,loading:b.value,pagination:{current:r.page,total:r.total,pageSize:r.size,showQuickJumper:!0,showSizeChanger:!0,pageSizeOptions:["10","20","50","100"]},onChange:u,scroll:{x:800}},{default:o(()=>[e(g,{key:"file_name","data-index":"file_name",title:"原始文档",width:200},{default:o(({record:l})=>[k("a",{onClick:O=>A(l)},F(l.file_name),9,rt)]),_:1}),e(g,{key:"status",title:"状态",width:140},{default:o(({record:l})=>[l.status==0?(d(),c("div",pt,[e(z(Ae)),a[2]||(a[2]=v("排队中 "))])):D("",!0),l.status==1?(d(),c("div",mt,[e(z(Z)),a[3]||(a[3]=v("文档解析中 "))])):D("",!0),l.status==2?(d(),c("div",ft,[e(z(Z)),a[4]||(a[4]=v("提取中 "))])):D("",!0),l.status==3?(d(),c("div",kt,[e(z(Le)),a[5]||(a[5]=v("提取完成 "))])):D("",!0),l.status==4?(d(),c("div",vt,[e(z(Re)),a[6]||(a[6]=v("提取失败 "))])):D("",!0)]),_:1}),e(g,{key:"chunk_size",title:"分块方式",width:140},{default:o(({record:l})=>[v(" 按长度："+F(l.chunk_size),1)]),_:1}),e(g,{key:"count",title:"总分块数",width:110},{default:o(({record:l})=>[v(F(+l.success_count+ +l.fail_count),1)]),_:1}),e(g,{key:"success_count",title:"提取成功分块数",width:140},{default:o(({record:l})=>[v(F(l.success_count),1)]),_:1}),e(g,{key:"fail_count",title:"提取失败分块数",width:140},{default:o(({record:l})=>[e(R,{gap:12},{default:o(()=>[l.fail_count>0?(d(),c("a",{key:0,onClick:O=>ne(l)},F(l.fail_count),9,ht)):(d(),c("span",gt,F(l.fail_count),1)),l.status==3||l.status==4?(d(),c("a",yt,[l.fail_count>0?(d(),Y(z(Ne),{key:0,onClick:O=>H(l)},null,8,["onClick"])):D("",!0)])):D("",!0)]),_:2},1024)]),_:1}),e(g,{key:"qa_count",title:"提取问答对数量",width:140},{default:o(({record:l})=>[k("a",{onClick:O=>A(l)},F(l.qa_count),9,xt)]),_:1}),e(g,{key:"create_time_desc",title:"上传时间",width:150},{default:o(({record:l})=>[v(F(l.create_time_desc),1)]),_:1}),e(g,{key:"key7",title:"操作",width:190,fixed:"right"},{default:o(({record:l})=>[e(R,{gap:16},{default:o(()=>[l.status==3?(d(),Y(oe,{key:0},{overlay:o(()=>[e(le,null,{default:o(()=>[e(G,{onClick:O=>J("docx",l.id),key:"1"},{default:o(()=>a[7]||(a[7]=[v("下载为docx")])),_:2,__:[7]},1032,["onClick"]),e(G,{onClick:O=>J("xlsx",l.id),key:"2"},{default:o(()=>a[8]||(a[8]=[v("下载为xlsx")])),_:2,__:[8]},1032,["onClick"])]),_:2},1024)]),default:o(()=>[e(y,{size:"small",type:"link",style:{padding:"0"}},{default:o(()=>a[9]||(a[9]=[v("下载")])),_:1,__:[9]})]),_:2},1024)):(d(),Y(y,{key:1,disabled:"",size:"small",type:"link",style:{padding:"0"}},{default:o(()=>a[10]||(a[10]=[v("下载")])),_:1,__:[10]})),e(y,{onClick:O=>ae(l),disabled:l.status!=3,size:"small",type:"link",style:{padding:"0"}},{default:o(()=>a[11]||(a[11]=[v("导入问答库")])),_:2,__:[11]},1032,["onClick","disabled"]),e(y,{onClick:O=>P(l),size:"small",type:"link",style:{padding:"0"}},{default:o(()=>a[12]||(a[12]=[v("删除")])),_:2,__:[12]},1032,["onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data-source","loading","pagination"])])])]),e(et,{ref_key:"uploadDocumentRef",ref:L,onOk:T},null,512),e(Ke,{ref_key:"importKnowledgeModalRef",ref:h,onOk:w},null,512),e(it,{ref_key:"failDetailRef",ref:W},null,512)],64)}}},St=E(bt,[["__scopeId","data-v-63c3fb15"]]);export{St as default};
