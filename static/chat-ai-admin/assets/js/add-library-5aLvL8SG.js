import{b as pe,k as D,c_ as fe,bx as ve,ds as ye,aD as ge,aE as he,d as be,B as ke,bO as xe}from"../../index-CzPebXix.js";import{b as R,a3 as Ne,d as y,z as T,q as qe,N as f,X as u,j as l,U as r,a2 as we,O as c,a6 as k,W as x,u as N,F as w,H as C,a1 as S,a5 as P,S as A,_ as g,I as B,Z as v,a0 as Ae}from"./vue-chunks-BRsu9_To.js";import{U as Ce}from"./upload-input-BmT6L6Xv.js";import{h as Se}from"./index-BfxXXGE8.js";import{A as Be}from"./avatar-input-De0IDy91.js";import{t as I}from"./validate-8MtiUsxW.js";import{F as z,_ as Ee}from"./index-BgVvqN-n.js";import"./index-BFhVTGQQ.js";import{I as Le}from"./Input-DFtZp9vk.js";import{S as Ve,a as Ue,i as Fe}from"./index-6HDf6TPN.js";import"./index-Di5l0R3t.js";import{_ as Me,R as Oe}from"./RadioButton-h1wW1k6O.js";import{_ as De}from"./TextArea-DrgXbuSS.js";import{_ as Re}from"./index-BhUXTHsq.js";import"./axios-Dq7h7Pqt.js";import"./qs-BrxkIg-9.js";import"./crypto-js-ClNpte_9.js";import"./dayjs-B6IotFah.js";import"./InboxOutlined-BcJOXEMG.js";import"./index-7Ecr060x.js";import"./Trigger-Bvakuge0.js";import"./ResizeObserver.es-B1PUzC5B.js";import"./Password-fnCqxsm2.js";import"./inputProps-jdR54afw.js";import"./DownloadOutlined-CeWsYko2.js";import"./index-BwqnaIPU.js";import"./colors-DfoziJR7.js";import"./index-hvcgcTJ4.js";import"./CheckOutlined-Mk6nTpyE.js";import"./useRefs-CRRjy_qY.js";import"./collapseMotion-Brd6xpAT.js";import"./useMergedState-C0iIHNGF.js";import"./FormItemContext-B2RmG14m.js";import"./PlusOutlined-BlmIiILr.js";import"./isPlainObject-OEy0Jz8l.js";import"./Col-CFxRRwN8.js";import"./responsiveObserve-DqAe0rZk.js";import"./QuestionCircleOutlined-DTfTQPH4.js";import"./index-Bxqtz4sn.js";import"./Search-Cf7bcOZJ.js";import"./SearchOutlined-a_gTycfl.js";import"./slide-CsbPJG8I.js";import"./index-Bhf8G0AA.js";import"./List-D7uk7Chm.js";import"./DownOutlined-DXKkgIsm.js";import"./move-CkiYyFmr.js";import"./Checkbox-oqMTsvET.js";const Te={class:"add-library-page"},Pe={class:"form-box"},Ie={class:"upload-document-type-box"},ze=["onClick"],$e={class:"right-block"},je={class:"title-block"},Je={class:"title-text"},Ge={class:"desc"},Qe={class:"upload-document-type-box"},Xe=["onClick"],Ye={class:"right-block"},He={class:"title-block"},We={class:"title-text"},Ze={class:"desc"};const Ke=["src"],eo={key:0},oo={key:1},ao={__name:"add-library",setup(to){const{getStorage:$,setStorage:j}=fe("localStorage");D.config({duration:2});const E=we(),J=Ne(),s=R(()=>J.query.type||0),L=["azure","ollama","xinference","openaiAgent"],G=["azure"],lo=y([{iconName:"high",iconNameActive:"high-active",title:"高质量",value:1,is_offline:!1,desc:"使用在线的嵌入模型，在召回时具有更高的准确度，但需要花费token"}]),V=y([{iconName:"doc-icon",iconNameActive:"doc-icon-active",title:"本地文档",value:1,desc:`${s.value==2?"上传本地 docx/csv/xlsx 等格式文件":"上传本地 pdf/docx/ofd/txt/md/xlsx/csv/html 等格式文件"}`},{iconName:"link-icon",iconNameActive:"link-icon-active",title:"在线数据",value:2,desc:"获取在线网页内容"},{iconName:"cu-doc-icon",iconNameActive:"cu-doc-active",title:"自定义文档",value:3,desc:"自定义一个空文档，手动添加或编辑内容"}]);s.value==2&&(V.value=V.value.filter(a=>a.value!=2));const Q=y([{iconName:"file-search",iconNameActive:"file-search",title:"问题与答案一起生成索引",value:1,desc:"回答用户提问时，将用户提问与导入的问题和答案一起对比相似度，根据相似度高的问题和答案回复"},{iconName:"comment-search",iconNameActive:"comment-search",title:"仅对问题生成索引",value:2,desc:"回答用户提问时，将用户提问与导入的问题一起对比相似度，再根据相似度高的问题和对应的答案来回复"}]),X=z.useForm,q=y(!1),Y=R(()=>$("lastEmbeddedModel")||{}),H=y(1),W=s.value==0?ve:ye,e=T({type:s.value,access_rights:0,library_name:"",library_intro:"",use_model:"text-embedding-v2",model_config_id:"",library_files:void 0,avatar:W,avatar_file:void 0,is_offline:!1,urls:"",doc_type:1,file_name:"",is_qa_doc:s.value==2?1:0,qa_index_type:1,doc_auto_renew_frequency:1}),U=y(""),Z=(a,o)=>s.value==1||o&&o.length>0||e.doc_type!=1?Promise.resolve():Promise.reject(new Error("请上传文件")),K=(a,o)=>s.value==1||e.doc_type!=2?Promise.resolve():I(o)===!1?Promise.reject(new Error("网页地址不合法")):Promise.resolve(),ee=T({library_name:[{required:!0,message:"请输入库名称",trigger:"change"}],use_model:[{required:!0,message:"请选择嵌入模型",trigger:"change"}],library_files:[{required:s.value==0,message:"请选择文件",trigger:"change",validator:Z}],urls:[{required:s.value==0,validator:K}],file_name:[{required:s.value==0,validator:(a,o)=>s.value==1||e.doc_type!=3||o?Promise.resolve():Promise.reject(new Error("请输入文档名称"))}]}),{validate:oe,validateInfos:h}=X(e,ee),ae=a=>{e.library_files=a},te=(a,o)=>{const d=o.current_obj;e.use_model=L.indexOf(d.model_define)>-1&&d.deployment_name?d.deployment_name:d.name,U.value=d.model_define,e.model_config_id=d.id||o.model_config_id},le=a=>{e.avatar=a.imageUrl,e.avatar_file=a.file},no=a=>{e.is_offline=a.is_offline,H.value=a.value,e.use_model=void 0,F(a.is_offline)},ne=a=>{e.doc_type=a},ie=a=>{e.qa_index_type=a},re=()=>{E.back()},se=()=>{oe().then(()=>{de()}).catch(a=>{})},de=()=>{let a=new FormData,o=JSON.parse(JSON.stringify(e));G.indexOf(U.value)>-1&&(o.use_model="默认"),a.append("type",e.type),a.append("access_rights",e.access_rights),a.append("library_name",e.library_name),a.append("library_intro",e.library_intro),a.append("use_model",o.use_model),a.append("model_config_id",e.model_config_id),a.append("avatar",e.avatar_file?e.avatar_file:""),a.append("is_offline",e.is_offline),a.append("urls",JSON.stringify(I(e.urls))),a.append("doc_type",e.doc_type),a.append("file_name",e.file_name),a.append("is_qa_doc",e.is_qa_doc),a.append("qa_index_type",e.qa_index_type),a.append("doc_auto_renew_frequency",e.doc_auto_renew_frequency),j("lastEmbeddedModel",{});let d=!1;(s.value==0||s.value==2)&&e.doc_type==1&&e.library_files.forEach(n=>{(n.name.includes(".xlsx")||n.name.includes(".csv"))&&(d=!0),a.append("library_files",n)}),q.value=!0,xe(a).then(n=>{if(D.success("创建成功"),s.value==1){E.replace({path:"/public-library/config",query:{library_id:n.data.id}}),q.value=!1;return}let i="/library/details/knowledge-document",_={id:n.data.id};d&&(i="/library/document-segmentation",_={document_id:n.data.file_ids[0]}),e.doc_type==3&&(i="/library/preview",_={id:n.data.file_ids[0]}),E.replace({path:i,query:_}),q.value=!1}).catch(()=>{q.value=!1})},b=y([]);function _e(a,o,d){const n=new Set(a.map(i=>i.model_define));return o.filter(i=>{let _=i[d];n.has(_)&&a.filter(p=>{if(p.model_define==_)return p.children=he(p.children,i.children),!1})}),a}const F=a=>{Se({model_type:"TEXT EMBEDDING",is_offline:a}).then(o=>{let d=o.data||[],n=[];b.value=d.map(i=>{n=[];for(let _=0;_<i.model_info.vector_model_list.length;_++){const p=i.model_info.vector_model_list[_];n.push({name:p,deployment_name:i.model_config.deployment_name,id:i.model_config.id,model_define:i.model_info.model_define})}return i.model_config.id==Y.value.model_config_id,{id:i.model_config.id,name:i.model_info.model_name,model_define:i.model_info.model_define,icon:i.model_info.model_icon_url,children:n,deployment_name:i.model_config.deployment_name}}),b.value=_e(ge(b.value,"model_define"),b.value,"model_define"),b.value.forEach(i=>{i.model_define=="chatwiki"&&(e.model_config_id=i.id)})})};return qe(()=>{F(!1)}),(a,o)=>{const d=Le,n=Ee,i=De,_=be,p=Ue,M=Ve,io=Oe,ro=Me,ce=Re,ue=Fe,O=ke,me=z;return c(),f("div",Te,[u("div",Pe,[l(me,{"label-col":{span:5}},{default:r(()=>[l(n,x({ref:"name",label:"知识库名称"},N(h).library_name),{default:r(()=>[l(d,{value:e.library_name,"onUpdate:value":o[0]||(o[0]=t=>e.library_name=t),type:"text",placeholder:"请输入知识库名称，最多20个字",maxlength:20},null,8,["value"])]),_:1},16),l(n,{label:"知识库简介"},{default:r(()=>[l(i,{value:e.library_intro,"onUpdate:value":o[1]||(o[1]=t=>e.library_intro=t),placeholder:"请输入知识库介绍"},null,8,["value"])]),_:1}),l(n,x({ref:"name",label:"知识库封面"},N(h).avatar),{default:r(()=>[l(Be,{value:e.avatar,"onUpdate:value":o[2]||(o[2]=t=>e.avatar=t),onChange:le},null,8,["value"]),o[8]||(o[8]=u("div",{class:"form-item-tip"},"请上传知识库封面，建议尺寸为100*100px.大小不超过100kb",-1))]),_:1,__:[8]},16),s.value!=1?(c(),f(w,{key:0},[l(n,{label:"导入文档类型",required:""},{default:r(()=>[u("div",Ie,[(c(!0),f(w,null,S(V.value,t=>(c(),f("div",{class:P(["type-item",{active:e.doc_type==t.value}]),key:t.value,onClick:m=>ne(t.value)},[u("div",$e,[u("div",je,[l(_,{name:e.doc_type==t.value?t.iconNameActive:t.iconName},null,8,["name"]),u("div",Je,g(t.title),1)]),u("div",Ge,g(t.desc),1)]),e.doc_type==t.value?(c(),A(_,{key:0,class:"check-arrow",name:"check-arrow-filled",style:{"font-size":"24px",color:"#fff"}})):k("",!0)],10,ze))),128))])]),_:1}),C(l(n,x({ref:"name",label:"知识库文档"},N(h).library_files),{default:r(()=>[l(Ce,{type:s.value,onChange:ae},null,8,["type"])]),_:1},16),[[B,e.doc_type==1]]),C(l(n,x({ref:"urls",label:"网页链接"},N(h).urls),{default:r(()=>[l(i,{style:{height:"120px"},value:e.urls,"onUpdate:value":o[3]||(o[3]=t=>e.urls=t),placeholder:"请输入网页链接,形式：一行标题一行网页链接"},null,8,["value"])]),_:1},16),[[B,e.doc_type==2]]),C(l(n,{ref:"doc_auto_renew_frequency",label:"更新频率",required:""},{default:r(()=>[l(M,{value:e.doc_auto_renew_frequency,"onUpdate:value":o[4]||(o[4]=t=>e.doc_auto_renew_frequency=t),style:{width:"100%"}},{default:r(()=>[l(p,{value:1},{default:r(()=>o[9]||(o[9]=[v("不自动更新")])),_:1,__:[9]}),l(p,{value:2},{default:r(()=>o[10]||(o[10]=[v("每天")])),_:1,__:[10]}),l(p,{value:3},{default:r(()=>o[11]||(o[11]=[v("每3天")])),_:1,__:[11]}),l(p,{value:4},{default:r(()=>o[12]||(o[12]=[v("每7天")])),_:1,__:[12]}),l(p,{value:5},{default:r(()=>o[13]||(o[13]=[v("每30天")])),_:1,__:[13]})]),_:1},8,["value"])]),_:1},512),[[B,e.doc_type==2]]),C(u("div",null,[l(n,x({ref:"file_name",label:"文档名称"},N(h).file_name),{default:r(()=>[l(d,{placeholder:"请输入文档名称",value:e.file_name,"onUpdate:value":o[5]||(o[5]=t=>e.file_name=t)},null,8,["value"])]),_:1},16),k("",!0),e.is_qa_doc==1?(c(),A(n,{key:1,label:"索引方式",required:""},{default:r(()=>[u("div",Qe,[(c(!0),f(w,null,S(Q.value,t=>(c(),f("div",{class:P(["type-item",{active:e.qa_index_type==t.value}]),key:t.value,onClick:m=>ie(t.value)},[u("div",Ye,[u("div",He,[l(_,{name:e.qa_index_type==t.value?t.iconNameActive:t.iconName},null,8,["name"]),u("div",We,g(t.title),1)]),u("div",Ze,g(t.desc),1)]),e.qa_index_type==t.value?(c(),A(_,{key:0,class:"check-arrow",name:"check-arrow-filled",style:{"font-size":"24px",color:"#fff"}})):k("",!0)],10,Xe))),128))])]),_:1})):k("",!0)],512),[[B,e.doc_type==3]])],64)):k("",!0),l(n,x({label:"嵌入模型 "},N(h).use_model),{default:r(()=>[k("",!0),l(M,{value:e.use_model,"onUpdate:value":o[7]||(o[7]=t=>e.use_model=t),placeholder:"请选择嵌入模型",onChange:te},{default:r(()=>[(c(!0),f(w,null,S(b.value,t=>(c(),A(ue,{key:t.id},{label:r(()=>[l(ce,{align:"center",gap:6},{default:r(()=>[u("img",{class:"model-icon",src:t.icon,alt:""},null,8,Ke),v(g(t.name),1)]),_:2},1024)]),default:r(()=>[(c(!0),f(w,null,S(t.children,m=>(c(),A(p,{value:L.indexOf(t.model_define)>-1&&m.deployment_name?m.deployment_name:m.name+m.id,model_config_id:t.id,current_obj:m,key:m.name+m.id},{default:r(()=>[L.indexOf(t.model_define)>-1&&m.deployment_name?(c(),f("span",eo,g(m.deployment_name),1)):(c(),f("span",oo,g(m.name),1))]),_:2},1032,["value","model_config_id","current_obj"]))),128))]),_:2},1024))),128))]),_:1},8,["value"])]),_:1},16),l(n,{"wrapper-col":{span:14,offset:4}},{default:r(()=>[l(O,{onClick:re},{default:r(()=>o[16]||(o[16]=[v("取 消")])),_:1,__:[16]}),l(O,{type:"primary",style:{"margin-left":"16px"},loading:q.value,onClick:Ae(se,["prevent"])},{default:r(()=>o[17]||(o[17]=[v("下一步")])),_:1,__:[17]},8,["loading"])]),_:1})]),_:1})])])}}},aa=pe(ao,[["__scopeId","data-v-5c6ff907"]]);export{aa as default};
