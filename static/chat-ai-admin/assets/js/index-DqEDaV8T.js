import{b as N,bs as ie,c$ as re,d as X,du as ce,df as de,d7 as ue,bB as pe,dF as fe}from"../../index-Bo1NSLpy.js";import{Z as _e,f as he,a as me,P as ve,H as ge,C as ye,b as G}from"./cu-scroll-DO8SSPzJ.js";import{d as b,z as L,q as Y,N as p,O as c,X as e,j as m,w as we,H as ke,am as be,an as xe,a6 as C,u as O,a5 as W,x as A,b as Fe,a3 as $e,S as V,U as R,_ as S,Y as Ce,F as U,a1 as q,Z as j,A as Ie}from"./vue-chunks-BRsu9_To.js";import{S as Se}from"./SearchOutlined-CFTHZIcT.js";import{C as Be}from"./CaretDownFilled-DQ5FyPd3.js";import{C as Q}from"./CaretRightOutlined-DuIjfFNw.js";import{S as ee}from"./index-eahgXICC.js";import{R as Le}from"./RightOutlined-zEOifMPB.js";import"./axios-Dq7h7Pqt.js";import"./qs-BrxkIg-9.js";import"./crypto-js-ClNpte_9.js";import"./dayjs-B6IotFah.js";import"./pull-up.esm-D94Swpvl.js";import"./observe-dom.esm-CyCedSm-.js";const De={class:"chart-wrapper"},Me={class:"zoom-toolbar-wrapper"},Oe={__name:"chart-box",emits:["nodeClick"],setup(B,{expose:$,emit:x}){const f=x,n=b(null);let a=null;const l=L({nodes:[],edges:[]}),v=b(1),y=()=>{a&&a.destroy();const _={layout:"forceDirected",initialZoom:v.value,disableTelemetry:!0,maxZoom:10,minZoom:.1,minimapContainer:document.getElementById("chatMap"),styling:{minimapViewportBoxColor:"#4399FF",selectedBorderColor:"rgba(255, 255, 255, 1)"}},u=document.getElementById("chartBox");a=new he(u,l.nodes,l.edges,_);const i=new me(a);new ve(a),i.updateCallback("onZoom",k=>{v.value=Number(k.toFixed(1))}),new ge(a,{drawShadowOnHover:!0}),new ye(a,{selectOnClick:!0}).updateCallback("onNodeClick",k=>{f("nodeClick",k)})},d=_=>{v.value=_,a&&a.setZoom(_)},o=({nodes:_,edges:u})=>{l.nodes=[l.nodes,..._],l.edges=[l.edges,...u],a&&a.addElementsToGraph(_,u)},w=({nodes:_,edges:u})=>{l.nodes=[l.nodes,..._],l.edges=[l.edges,...u],a&&a.addAndUpdateElementsInGraph(_,u)},I=({nodes:_,edges:u})=>{l.nodes=_,l.edges=u,a&&a.updateElementsInGraph(_,u)},z=({nodes:_,edges:u})=>{l.nodes=_,l.edges=u,y()};return Y(()=>{}),$({render:z,add:o,addAndUpdate:w,update:I}),(_,u)=>(c(),p("div",De,[e("div",{class:"chart",id:"chartBox",ref_key:"chartBox",ref:n},null,512),u[0]||(u[0]=e("div",{class:"chart-mini-map",id:"chatMap"},null,-1)),e("div",Me,[m(_e,{value:v.value,onChange:d},null,8,["value"])])]))}},ze=N(Oe,[["__scopeId","data-v-2b63d066"]]),Ne={class:"search-action-box"},Te={__name:"search-input",props:{value:{type:String,default:""}},emits:["search","clear","input","update:value"],setup(B,{emit:$}){const x=$,f=B,n=b(f.value),a=b(!1),l=b(null),v=()=>{x("update:value",n.value)},y=()=>{n.value="",A(()=>{var o;(o=l.value)==null||o.focus()}),v(),d()},d=()=>{x("search",n.value)};return we(()=>f.value,o=>{n.value!==o&&(n.value=o)}),(o,w)=>(c(),p("div",{class:W(["search-input-box",{focused:a.value}])},[ke(e("input",{ref_key:"searchInput",ref:l,class:"search-input","onUpdate:modelValue":w[0]||(w[0]=I=>n.value=I),placeholder:"输入关键词搜索",type:"text",onKeyup:xe(d,["enter"]),onFocus:w[1]||(w[1]=I=>a.value=!0),onBlur:w[2]||(w[2]=I=>a.value=!1),onInput:v},null,544),[[be,n.value]]),e("div",Ne,[B.value.length>0?(c(),p("span",{key:0,class:"action-btn",onClick:y},[m(O(ie),{class:"clear-icon"})])):C("",!0),e("span",{class:"action-btn",onClick:d},[m(O(Se),{class:"search-icon"})])])],2))}},Ee=N(Te,[["__scopeId","data-v-74ee1494"]]),Ze={key:0,class:"file-list-wrapper"},Re={class:"open-file-box"},Ve={key:0,class:"file-item active"},He={class:"file-info"},Ge=["onMouseenter","onClick"],Ue={class:"doc-content"},Ae={key:0,class:"loading-box"},Ke={class:"file-list-box"},Pe={class:"file-items"},qe={key:0,class:"file-item"},je=["onClick"],Xe={class:"file-name"},Ye={key:0,class:"loading-box"},Je={class:"fragment-title"},Qe={class:"fragment-details-body"},We={class:"fragment-content"},et={__name:"file-list",props:{show:{type:Boolean,default:!1}},emits:["openFile","openFragment"],setup(B,{expose:$,emit:x}){const{getStorage:f,removeStorage:n}=re("localStorage"),a=x,l=B,v=$e(),y=f("graph:autoOpenFileId")||null,d=Fe(()=>v.query.id),o=L({list:[],library_id:d.value,status:2,page:1,size:20,total:0,showMore:!0}),w=async()=>{try{const r=await de({library_id:o.library_id,status:o.status,page:o.page,size:o.size});if(r.res!=0)return;let h=r.data.list||[];o.total=r.data.total,y&&(h=h.filter(M=>M.id!=y)),o.list=[...o.list,...h],o.list.length>=o.total&&(o.showMore=!1),o.page==1&&o.list.length>0&&D(o.list[0])}catch(r){o.showMore=!1}},I=()=>{o.list.length>=o.total||(o.page++,w())},z=b(null),_=b(null),u=b(0),i=L({show:!1,file_name:"",id:""}),s=L({show:!0,page:1,size:20,total:0,list:[],showMore:!0}),k=b(null),g=L({show:!1,title:"",content:""}),D=async r=>{if(r.id==i.id){k.value=null,a("openFile",r);return}i.show=!0,i.file_name=r.file_name,i.id=r.id,k.value=null,s.page=1,s.total=0,s.list=[],s.show=!0,s.showMore=!0,await E(),a("openFile",r)},H=()=>{s.show=!1},T=()=>{s.show=!0},t=b(300),E=async()=>{const r=await ue({file_id:i.id,page:s.page,size:s.size,status:-1,graph_status:-1,category_id:-1});r.res==0&&(s.total=r.data.total,s.page==1?s.list=r.data.list||[]:s.list=[...s.list,...r.data.list],s.list.length>=s.total&&(s.showMore=!1),A(()=>{var M;let h=((M=_.value)==null?void 0:M.offsetHeight)||0;h>t.value?u.value=t.value:u.value=h,A(()=>{var Z;(Z=z.value)==null||Z.refresh()})}))},K=()=>{s.list.length>=s.total||(s.page++,E())},te=r=>{k.value=r.id,a("openFragment",r)},se=r=>{clearTimeout(P),g.title=r.title,g.content=r.content,g.show=!0};let P=null;const oe=()=>{P=setTimeout(()=>{g.show=!1},200)},ne=()=>{clearTimeout(P)},ae=()=>{g.show=!1},le=async()=>{try{const r=await ce({id:y});o.list.push(r.data)}catch(r){}};return Y(async()=>{y&&(await le(),n("graph:autoOpenFileId")),w()}),$({openFile:D}),(r,h)=>{const M=X,Z=ee;return c(),V(Ie,{name:"slide-fade"},{default:R(()=>[l.show?(c(),p("div",Ze,[e("div",Re,[i.show?(c(),p("div",Ve,[e("div",He,[s.show?(c(),V(O(Be),{key:0,class:"caret-icon",onClick:h[0]||(h[0]=F=>H())})):(c(),V(O(Q),{key:1,class:"caret-icon",onClick:h[1]||(h[1]=F=>T())})),m(M,{class:"file-icon",name:"doc-file",style:{}}),e("span",{class:"file-name",onClick:h[2]||(h[2]=F=>D(i))},S(i.file_name),1)]),s.show?(c(),p("div",{key:0,class:"document-fragments",style:Ce({maxHeight:t.value+"px",height:u.value>0?u.value+"px":"auto"})},[m(G,{ref_key:"fragmentsScrollView",ref:z,"group-id":"a",onOnScrollEnd:K},{default:R(()=>[e("div",{class:"fragment-list",ref_key:"fragmentListRef",ref:_},[(c(!0),p(U,null,q(s.list,F=>(c(),p("div",{class:W(["fragment-item",{active:k.value==F.id}]),onMouseenter:J=>se(F),onMouseleave:oe,onClick:J=>te(F),key:F.id},[e("div",Ue,S(F.content),1)],42,Ge))),128))],512),s.list.length<s.total?(c(),p("div",Ae,[m(Z,{size:"small"}),h[3]||(h[3]=j()),h[4]||(h[4]=e("span",{class:"loading-text"},"加载中...",-1))])):C("",!0)]),_:1},512)],4)):C("",!0)])):C("",!0)]),e("div",Ke,[m(G,{"group-id":"a",onOnScrollEnd:I},{default:R(()=>[e("div",Pe,[(c(!0),p(U,null,q(o.list,F=>(c(),p(U,{key:F.id},[F.id!=i.id?(c(),p("div",qe,[e("div",{class:"file-info",onClick:J=>D(F)},[m(O(Q),{class:"caret-icon"}),m(M,{class:"file-icon",name:"doc-file",style:{}}),e("span",Xe,S(F.file_name),1)],8,je)])):C("",!0)],64))),128)),o.showMore?(c(),p("div",Ye,[m(Z,{size:"small"}),h[5]||(h[5]=j()),h[6]||(h[6]=e("span",{class:"loading-text"},"加载中...",-1))])):C("",!0)])]),_:1})]),g.show?(c(),p("div",{key:0,class:"fragment-details",onMouseenter:ne,onMouseleave:ae},[e("div",Je,S(g.title||"无标题片段"),1),e("div",Qe,[m(G,null,{default:R(()=>[e("div",We,S(g.content),1)]),_:1})])],32)):C("",!0)])):C("",!0)]),_:1})}}},tt=N(et,[["__scopeId","data-v-20862e4a"]]),st={key:0,class:"popup-wrapper entity-details-wrapper"},ot={class:"popup-header"},nt={key:0,class:"popup-body"},at={class:"popup-content"},lt={class:"entity-details"},it={class:"entity-item"},rt={class:"entity-name"},ct={class:"entity-item",style:{"margin-bottom":"8px"}},dt={class:"file-info"},ut={class:"file-name"},pt={class:"entity-item"},ft={class:"entity-item-header"},_t={class:"doc-item"},ht={class:"fragment-content"},mt={class:"entity-item"},vt={key:0,class:""},gt={class:"fragment-content"},yt={__name:"entity-details",emits:["toDetails"],setup(B,{expose:$,emit:x}){const f=x,n=L({show:!1,node:null,fromNodes:[]}),a=()=>{n.show=!1},l=(y,d)=>{n.node=y,n.fromNodes=d,n.show?(n.show=!1,A(()=>{n.show=!0})):n.show=!0},v=()=>{f("toDetails",n.node)};return $({open:l,close:a}),(y,d)=>{const o=X;return n.show?(c(),p("div",st,[e("div",ot,[d[0]||(d[0]=e("div",{class:"popup-title"},"实体详情",-1)),m(O(pe),{class:"close-btn",onClick:a})]),n.node?(c(),p("div",nt,[m(G,null,{default:R(()=>[e("div",at,[e("div",lt,[e("div",it,[d[1]||(d[1]=e("div",{class:"entity-item-header"},[e("div",{class:"entity-item-label"},"实体")],-1)),e("div",rt,S(n.node.name),1)]),e("div",ct,[d[2]||(d[2]=e("div",{class:"entity-item-header"},[e("div",{class:"entity-item-label"},"归属文档")],-1)),e("div",dt,[m(o,{class:"file-icon",name:"doc-file",style:{}}),e("span",ut,S(n.node.file_name),1)])]),e("div",pt,[e("div",ft,[d[4]||(d[4]=e("div",{class:"entity-item-label"},"分段",-1)),e("span",{class:"to-details",onClick:v},[d[3]||(d[3]=j("详情  ")),m(O(Le),{class:"right-icon"})])]),e("div",null,[e("div",_t,[e("div",ht,S(n.node.content),1)])])]),e("div",mt,[d[5]||(d[5]=e("div",{class:"entity-item-header"},[e("div",{class:"entity-item-label"},"子图")],-1)),e("div",null,[n.fromNodes.length==0?(c(),p("div",vt,"无")):C("",!0),(c(!0),p(U,null,q(n.fromNodes,w=>(c(),p("div",{class:"subgraph-item",key:w.id},[e("div",gt,S(w.name),1)]))),128))])])])])]),_:1})])):C("",!0)])):C("",!0)}}},wt=N(yt,[["__scopeId","data-v-1adce7af"]]),kt={class:"collapse-icon"},bt={class:"collapse-label"},xt={__name:"collapse-btn",emits:["change"],setup(B,{emit:$}){const x=$,f=b(!0),n=()=>{f.value=!f.value,x("change",f.value)};return(a,l)=>{const v=X;return c(),p("div",{class:"collapse-btn",onClick:n},[e("span",kt,[f.value?(c(),V(v,{key:0,name:"collapse-close"})):(c(),V(v,{key:1,name:"collapse-open"}))]),e("span",bt,S(f.value?"收起":"展开"),1)])}}},Ft=N(xt,[["__scopeId","data-v-bd8022c3"]]),$t={class:"knowledge-graph-page"},Ct={key:0,class:"loading-wrapper"},It={class:"search-box"},St={class:"left-box"},Bt={class:"right-box"},Lt={__name:"index",setup(B){const $=b(null),x=b(null),f=b(!1),n=b(""),a=b(!0),l=L({file_id:"",data_id:"",search_term:""}),v=L({edges:[],nodes:[]});let y={};const d=i=>{a.value=i},o=i=>{l.file_id=i.id,l.data_id="",I()},w=i=>{l.data_id=i.id,I()},I=()=>{f.value=!0,fe({file_id:l.file_id,data_id:l.data_id,search_term:l.search_term}).then(i=>{f.value=!1;let s=i.data.edges||[],k=i.data.nodes||[];const g=new Map;s=s.filter(t=>{const E=`${t.from_id}_${t.to_id}`,K=`${t.to_id}_${t.from_id}`;return g.has(E)||g.has(K)?!1:(g.set(E,!0),!0)}),s.forEach(t=>{t.id=t.id.toString(),t.from=t.from_id.toString(),t.to=t.to_id.toString(),t.caption=t.label});const D=new Set(s.map(t=>t.from)),H=new Set(s.map(t=>t.to));k.forEach(t=>{t.id=t.id.toString(),t.nodeType=D.has(t.id)&&H.has(t.id)?"both":D.has(t.id)?"from":H.has(t.id)?"to":"normal",t.nodeType==="from"?(t.size=35,t.color="#FFB1B2"):t.nodeType==="to"?(t.size=45,t.color="#005AFF"):(t.size=30,t.color="#69E9BE"),t.captions=[{value:t.name,styles:[]}]});let T={edges:s,nodes:k};v.edges=T.edges,v.nodes=T.nodes,setTimeout(()=>{$.value.render(T)},0),y={},s.forEach(t=>{y[t.to]||(y[t.to]=[]),y[t.to].push(t.from)})}).catch(i=>{f.value=!1})},z=i=>{let s=y[i.id]||[],k=[];for(let g=0;g<v.nodes.length;g++)s.indexOf(v.nodes[g].id)>-1&&k.push(v.nodes[g]);x.value.open(i,k)},_=i=>{l.search_term=i,I()},u=i=>{window.open(`/#/library/preview?id=${i.file_id}`)};return Y(()=>{}),(i,s)=>{const k=ee;return c(),p("div",$t,[f.value?(c(),p("div",Ct,[m(k,{spinning:f.value},null,8,["spinning"])])):C("",!0),m(ze,{ref_key:"chartBoxRef",ref:$,loading:f.value,onNodeClick:z},null,8,["loading"]),m(Ft,{onChange:d}),e("div",It,[m(Ee,{value:n.value,"onUpdate:value":s[0]||(s[0]=g=>n.value=g),onSearch:_},null,8,["value"])]),e("div",St,[m(tt,{onOpenFile:o,onOpenFragment:w,show:a.value},null,8,["show"])]),e("div",Bt,[m(wt,{ref_key:"entityDetailsRef",ref:x,onToDetails:u},null,512)])])}}},Kt=N(Lt,[["__scopeId","data-v-9a80e34d"]]);export{Kt as default};
