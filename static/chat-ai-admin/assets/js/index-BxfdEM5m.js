import{_ as ee,d as ue,aj as qe,c as De,bh as Pe}from"../../index-DxV-PNCd.js";import{ac as s,ad as t,as as e,az as p,ai as Z,F as R,ax as z,at as v,e as Q,f as U,ae as N,n as re,k as r,ar as y,B as He,G as H,u as E,A as Ne,y as ye,J as ge,q as Se,w as me,ah as ze,b as Ce,I as je,r as Le,av as Ve,aw as be,aB as Je,o as Qe,aA as Ke}from"./vue-chunks-CGLjTDrY.js";import{u as We}from"./useEventBus-CB_rGuu7.js";import{u as ke}from"./chat-DoLMCmpL.js";import{_ as fe,V as Ge}from"./voice-message-CaBDyXQe.js";import{M as Ye}from"./multiple-message-Fw4PZ8Kc.js";import{u as Me}from"./robot-CbQxxX9E.js";import{al as Te,a5 as he,aq as Xe,v as Ie,ay as we,b as ce,$ as Ze,ah as ie,aA as Ee,M as Fe,e as et,I as tt,O as st,y as ot,z as nt,V as lt,F as at,B as Re,m as it,af as rt,n as ct,a6 as ut}from"./ui-antd-AfNpv4wx.js";import{_ as Ae}from"./cu-scroll-qHaWhCWu.js";import{q as _t}from"./other-BrZCAsTs.js";import{u as dt}from"./index-DwtbXc27.js";import{i as pt}from"./index-CmzDLrI5.js";import{V as mt}from"./vue3-pdf-embed-BvuBfFnt.js";import{ac as vt}from"./index-BNO9ztvM.js";import"./neo4j-L2Hgpmga.js";import"./utils-COBjqVvs.js";import"./useIM-CgIuP9SB.js";import"./pull-up.esm-DIiTC7VE.js";import"./observe-dom.esm-B25JyVKH.js";import"./vue-pdf-embed-CiRf6fZ3.js";const gt={class:"guess-you-want"},ft={class:"message-tabs"},ht={key:1,class:"v-line"},yt={key:0,class:"message-menus"},bt=["onClick"],kt={key:1,class:"message-menus"},wt=["onClick"],$t={__name:"guess-you-want",props:{item:{type:Object,default:()=>{}},common_question_list:{type:Object,default:()=>[]},enable_common_question:{type:Boolean,default:!1}},emits:["clickMeun"],setup(T,{emit:k}){const C=k,n=T,I=(u,o)=>{u.question_tabkey=o},f=u=>{C("clickMeun",u)};return(u,o)=>(t(),s("div",gt,[e("div",ft,[n.item.guess_you_want?(t(),s("div",{key:0,onClick:o[0]||(o[0]=l=>I(n.item,1)),class:Z(["tab-item",{active:n.item.question_tabkey==1}])}," 猜你想问 ",2)):p("",!0),n.item.guess_you_want&&n.common_question_list&&n.enable_common_question?(t(),s("div",ht)):p("",!0),n.common_question_list&&n.enable_common_question?(t(),s("div",{key:2,onClick:o[1]||(o[1]=l=>I(n.item,2)),class:Z(["tab-item",{active:n.item.question_tabkey==2}])}," 常见问题 ",2)):p("",!0)]),n.item.question_tabkey==1?(t(),s("div",yt,[(t(!0),s(R,null,z(n.item.guess_you_want,(l,_)=>(t(),s("div",{onClick:a=>f(l),class:"menu-item",key:_},v(l),9,bt))),128))])):(t(),s("div",kt,[(t(!0),s(R,null,z(T.common_question_list,(l,_)=>(t(),s("div",{onClick:a=>f(l),class:"menu-item",key:_},v(l),9,wt))),128))]))]))}},xt=ee($t,[["__scopeId","data-v-253226a8"]]),qt={class:"text-message"},St={__name:"text-message",props:{message:String},setup(T){return(k,C)=>(t(),s("div",qt,v(T.message),1))}},Ct={class:"message-list-wrapper"},Lt={class:"message-list"},Mt=["id","data-msg_type"],Tt={class:"itme-left"},It=["src"],Et={class:"itme-right"},Ft={class:"item-body"},Rt={key:0,class:"message-content"},At=["src"],Ot={key:1,class:"message-content"},Ut=["id"],Bt={class:"itme-left"},Dt=["src"],Pt={class:"itme-right"},Ht={key:0,class:"reply-list"},Nt={key:0,class:"reply-item reply-text"},zt=["innerHTML"],jt={key:1,class:"reply-item reply-image"},Vt={class:"message-content"},Jt=["src"],Qt={key:2,class:"reply-item reply-url"},Kt={class:"url-row"},Wt=["href"],Gt={key:3,class:"reply-item reply-card"},Yt={class:"card-row"},Xt=["src"],Zt={class:"card-title-box"},es={class:"card-title"},ts={key:4,class:"reply-item reply-imageText"},ss=["href"],os=["src"],ns={class:"imageText-text"},ls={class:"imageText-title"},as={class:"imageText-desc"},is={key:5,class:"reply-item reply-smartMenu"},rs={class:"smart-menu-box"},cs={key:0,class:"card-title"},us={class:"card-text"},_s={key:0,class:"line-text"},ds={key:1,class:"empty-line"},ps=["innerHTML"],ms=["onClick"],vs={key:0},gs={class:"label-flex-block"},fs={key:0,class:"thinking-label-wrapper"},hs={class:"thinking-label"},ys={class:"label-text"},bs=["onClick"],ks={class:"label-text"},ws=["onClick"],$s={class:"label-text"},xs={class:"item-body"},qs={key:0,class:"file-items"},Ss=["onClick"],Cs={class:"file-name"},Ls={key:0},Ms={key:1},Ts={key:1,class:"thinking-content"},Is={class:"message-content"},Es={class:"message-menus"},Fs=["onClick"],Rs=["innerHTML"],As={class:"message-menus"},Os=["onClick"],Us={key:4,class:"message-content"},Bs=["src"],Ds={key:5,class:"message-action-wrap"},Ps={key:0,class:"message-action"},Hs={class:"action-btn"},Ns=["onClick"],zs={key:1},js={__name:"message-list",props:{messages:{type:Array,default:()=>[]},robotInfo:{type:Object,default:()=>{}}},emits:["clickMsgMeun","scroll","scrollStart","scrollEnd","openPromptLog","openLibrary"],setup(T,{expose:k,emit:C}){const n=Me(),I=Q(()=>n.robotInfo.tips_before_answer_content),f=Q(()=>n.robotInfo.tips_before_answer_switch=="true"),u=C,o=T,l=m=>{m.show_reasoning=!m.show_reasoning},_=m=>{m.show_quote_file=!m.show_quote_file},a=Q(()=>o.robotInfo.common_question_list.length?JSON.parse(o.robotInfo.common_question_list):[]),c=Q(()=>(o.robotInfo.chat_type==1||o.robotInfo.chat_type==3)&&o.robotInfo.application_type=="0"),q=m=>{u("clickMsgMeun",m)},B=U(null),g={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let J=null,D=!1;function w(m){D||(J&&(clearTimeout(J),J=null),J=setTimeout(()=>{g.scrollTop-m.target.scrollTop>0&&(g.scrollDirection="up"),g.scrollTop-m.target.scrollTop<0&&(g.scrollDirection="down"),g.scrollTop=m.target.scrollTop,g.scrollHeight=m.target.scrollHeight,g.clientHeight=m.target.clientHeight,u("scroll",{...g}),Math.abs(g.scrollTop)<=g.scrollStartDiff&&g.scrollDirection==="up"&&$(),Math.abs(g.scrollHeight-g.scrollTop-g.clientHeight)<=g.scrollEndDiff&&g.scrollDirection==="down"&&b()},50))}function $(){o.messages.length!=0&&u("scrollStart",{msg:o.messages[0]})}function b(){o.messages.length!=0&&u("scrollEnd",{msg:o.messages[o.messages.length-1]})}const h=()=>{B.value&&ye(()=>{D=!0,B.value.scrollTop=B.value.scrollHeight+1,setTimeout(()=>{g.scrollTop=B.value.scrollTop,D=!1},50)})};function j(m,L){ye(()=>{D=!0,L||(L="top");let F=B.value,A=document.querySelector("#msg-"+m);L=="top"?F.scrollTop=A.offsetTop:F.scrollTop=A.offsetTop-F.clientHeight+A.clientHeight,setTimeout(()=>{g.scrollTop=B.value.scrollTop,D=!1},50)})}function K(){g.scrollTop=0,g.scrollDirection=""}function G(m){return!!(m.quote_file&&m.quote_file.length>0||m.debug&&m.debug.length>0)}function Y(m){u("openPromptLog",ge(m))}function ne(m,L,F){let A=ge(m);L.message_id=L.message_id||F,A.forEach(P=>{P.message_id=P.message_id||F}),u("openLibrary",A,ge(L))}function x(m){try{return m?Array.isArray(m)?m:typeof m=="string"?JSON.parse(m||"[]"):[]:[]}catch{return[]}}function X(m){const L=[];return(Array.isArray(m)?m:[]).forEach(F=>{const A=String((F==null?void 0:F.menu_type)||""),P=String((F==null?void 0:F.content)||"");if(A==="0")if(P==="")L.push({kind:"newline"});else if(/<a[\s\S]*?<\/a>/.test(P)){const te=/href\s*=\s*['"]\s*#\s*['"]/i.test(P)?P.replace(/href\s*=\s*['"]\s*#\s*['"]/ig,'href="javascript:;"'):P.replace(/href=/ig,'target="_blank" href=');L.push({kind:"html",html:te})}else L.push({kind:"text",text:P});else A==="1"&&L.push({kind:"keyword",text:P,serial_no:(F==null?void 0:F.serial_no)||""})}),L.slice(0,20)}function S(m){var A,P;const L=(P=(A=m.target)==null?void 0:A.closest)==null?void 0:P.call(A,"a");if(!L)return;const F=String(L.getAttribute("href")||"");(F==="#"||F==="javascript:;")&&(m.preventDefault(),m.stopPropagation())}function V(m){const L=String(m||"").trim();L&&u("clickMsgMeun",L)}return k({scrollToBottom:h,scrollToMessage:j,resetScroll:K}),(m,L)=>{const F=Te,A=ue,P=Ie,te=Se("viewer");return t(),s("div",Ct,[e("div",{class:"scroll-box",ref_key:"scrollBoxRef",ref:B,onScroll:w},[e("div",Lt,[(t(!0),s(R,null,z(o.messages,i=>(t(),s(R,{key:i.uid},[i.is_customer==1?(t(),s("div",{key:0,class:"message-item user-message",id:"msg-"+i.uid,"data-msg_type":i.msg_type},[e("div",Tt,[e("img",{class:"user-avatar",src:i.avatar},null,8,It)]),e("div",Et,[e("div",Ft,[i.msg_type==3?(t(),s("div",Rt,[re(e("img",{class:"msg-img",src:i.media_id_to_oss_url,alt:""},null,8,At),[[te]])])):i.msg_type==99?(t(),s("div",Ot,[r(Ye,{message:i.content},null,8,["message"])])):(t(),N(St,{key:2,class:"message-content",message:i.content},null,8,["message"]))])])],8,Mt)):(t(),s("div",{key:1,class:"message-item robot-message",id:"msg-"+i.uid},[e("div",Bt,[r(F,{size:"small",spinning:i.loading},{default:y(()=>[e("img",{class:"robot-avatar",src:i.robot_avatar},null,8,Dt)]),_:2},1032,["spinning"])]),e("div",Pt,[x(i.reply_content_list).length?(t(),s("div",Ht,[(t(!0),s(R,null,z(x(i.reply_content_list),(d,se)=>{var le;return t(),s(R,{key:se},[(d.reply_type||d.type)==="text"?(t(),s("div",Nt,[e("div",{class:"message-content",innerHTML:d.description},null,8,zt)])):(d.reply_type||d.type)==="image"?(t(),s("div",jt,[e("div",Vt,[re(e("img",{class:"msg-img",src:d.pic||d.thumb_url},null,8,Jt),[[te]])])])):(d.reply_type||d.type)==="url"?(t(),s("div",Qt,[e("div",Kt,[e("a",{class:"url-link",href:d.url,target:"_blank"},v(d.url),9,Wt)])])):(d.reply_type||d.type)==="card"?(t(),s("div",Gt,[e("div",Yt,[d.thumb_url?(t(),s("img",{key:0,src:d.thumb_url,class:"card-thumb"},null,8,Xt)):p("",!0),e("div",Zt,[r(A,{class:"think-icon",name:"applet"}),e("span",es,v(d.title),1)])])])):(d.reply_type||d.type)==="imageText"?(t(),s("div",ts,[e("a",{class:"imageText-row",href:d.url,target:"_blank"},[d.thumb_url?(t(),s("img",{key:0,src:d.thumb_url,class:"imageText-thumb"},null,8,os)):p("",!0),e("div",ns,[e("div",ls,v(d.title),1),e("div",as,v(d.description),1)])],8,ss)])):(d.reply_type||d.type)==="smartMenu"?(t(),s("div",is,[e("div",rs,[d.smart_menu&&d.smart_menu.menu_description?(t(),s("div",cs,v(d.smart_menu.menu_description),1)):p("",!0),e("div",us,[(t(!0),s(R,null,z(X(((le=d.smart_menu)==null?void 0:le.menu_content)||[]),(W,_e)=>(t(),s("div",{key:_e,class:"reply-line",onClick:L[0]||(L[0]=de=>S(de))},[W.kind==="text"?(t(),s("span",_s,v(W.text),1)):W.kind==="newline"?(t(),s("div",ds)):W.kind==="html"?(t(),s("span",{key:2,innerHTML:W.html},null,8,ps)):W.kind==="keyword"?(t(),s("a",{key:3,href:"javascript:;",class:"link",onClick:He(de=>V(W.text),["prevent"])},[W.serial_no?(t(),s("div",vs,v(W.serial_no),1)):p("",!0),H(" "+v(W.text),1)],8,ms)):p("",!0)]))),128))])])])):p("",!0)],64)}),128))])):p("",!0),e("div",gs,[f.value&&i.startLoading?(t(),s("div",fs,[e("div",hs,[r(E(he),{class:"loading"}),e("span",ys,v(I.value),1)])])):p("",!0),i.msg_type==1&&c.value&&(!i.startLoading||!f.value)?(t(),s("div",{key:1,class:Z(["thinking-label-wrapper",{reasoning_open:i.show_quote_file}])},[e("div",{class:"thinking-label",onClick:d=>_(i)},[i.quote_loading?(t(),s(R,{key:0},[r(E(he),{class:"loading"}),L[1]||(L[1]=e("span",{class:"label-text"},"正在检索知识库...",-1))],64)):p("",!0),i.quote_loading?p("",!0):(t(),s(R,{key:1},[r(A,{class:"think-icon",name:"quote-file"}),e("span",ks,"检索到"+v(i.quote_file.length)+"个知识库文档",1)],64)),i.quote_file.length?(t(),N(A,{key:2,name:"arrow-down",class:"arrow-down"})):p("",!0)],8,bs)],2)):p("",!0),i.reasoning_content?(t(),s("div",{key:2,class:Z(["thinking-label-wrapper",{reasoning_open:i.show_reasoning}])},[e("div",{class:"thinking-label",onClick:d=>l(i)},[i.reasoning_status?(t(),N(E(he),{key:0,class:"loading"})):(t(),N(A,{key:1,class:"think-icon",name:"think"})),e("span",$s,v(i.reasoning_status?"深度思考中...":"已完成深度思考"),1),i.reasoning_status?p("",!0):(t(),N(A,{key:2,name:"arrow-down",class:"arrow-down"}))],8,ws),r(P,null,{title:y(()=>[...L[2]||(L[2]=[H("在应用设置中关闭推理过程开关，将不再显示推理过程",-1)])]),default:y(()=>[r(E(Xe),{class:"tip"})]),_:1})],2)):p("",!0)]),e("div",xs,[i.show_quote_file&&i.quote_file&&i.quote_file.length>0?(t(),s("div",qs,[(t(!0),s(R,null,z(i.quote_file,d=>(t(),s("div",{class:"file-item",key:d.id,onClick:se=>ne(i.quote_file,d,i.id)},[e("a",Cs,[r(A,{class:"think-icon",name:"quote-file"}),d.file_name?(t(),s("span",Ls,v(d.file_name),1)):(t(),s("span",Ms,v(d.library_name)+"-精选",1))])],8,Ss))),128))])):p("",!0),i.show_reasoning&&i.reasoning_content?(t(),s("div",Ts,[r(fe,{content:i.reasoning_content},null,8,["content"])])):p("",!0),i.msg_type==1?(t(),s(R,{key:2},[re((t(),s("div",Is,[r(fe,{content:i.content},null,8,["content"])])),[[te]]),e("div",Es,[(t(!0),s(R,null,z(i.question,(d,se)=>(t(),s("div",{class:"menu-item",onClick:le=>q(d),key:se},v(d),9,Fs))),128))])],64)):p("",!0),i.msg_type==2?(t(),s(R,{key:3},[i.isWelcome?(t(),N(fe,{key:0,class:"markdown-content",content:i.menu_json.content},null,8,["content"])):(t(),s("div",{key:1,class:"message-content",innerHTML:i.menu_json.content},null,8,Rs)),e("div",As,[(t(!0),s(R,null,z(i.menu_json.question,(d,se)=>(t(),s("div",{class:"menu-item",onClick:le=>q(d),key:se},v(d),9,Os))),128))])],64)):p("",!0),i.msg_type==3?(t(),s("div",Us,[re(e("img",{class:"msg-img",src:i.content,alt:""},null,8,Bs),[[te]])])):p("",!0),G(i)?re((t(),s("div",Ds,[i.debug&&i.debug.length>0?(t(),s("div",Ps,[e("div",Hs,[e("span",null,[e("a",{onClick:d=>Y(i)},"Prompt 日志",8,Ns)])])])):p("",!0)],512)),[[Ne,!i.question]]):p("",!0)]),i.voice_content&&i.voice_content.length?(t(),s("div",zs,[r(Ge,{voice_content:i.voice_content},null,8,["voice_content"])])):p("",!0),(i.guess_you_want&&i.guess_you_want.length||a.value.length&&o.robotInfo.enable_common_question=="true")&&i.question_tabkey>0?(t(),N(xt,{key:2,item:i,enable_common_question:o.robotInfo.enable_common_question=="true",common_question_list:a.value,onClickMeun:q},null,8,["item","enable_common_question","common_question_list"])):p("",!0)])],8,Ut))],64))),128))])],544)])}}},Vs=ee(js,[["__scopeId","data-v-c2b4c934"]]),Js={class:"chat-list-box"},Qs=["onClick"],Ks={class:"chat-item-title"},Ws={__name:"chat-list",props:{list:{type:Array,default:()=>[]},active:{type:[String,Number],default:""}},emits:["openChat","onScrollEnd"],setup(T,{emit:k}){const C=k,n=T,I=U(null),f=o=>{C("openChat",o)},u=()=>{C("onScrollEnd")};return me(()=>n.list,()=>{ye(()=>{I.value.refresh()})}),(o,l)=>{const _=ue;return t(),s("div",Js,[r(Ae,{ref_key:"scroller",ref:I,onOnScrollEnd:u},{default:y(()=>[e("div",null,[(t(!0),s(R,null,z(n.list,a=>(t(),s("div",{class:Z(["chat-list-item",{active:a.id==n.active}]),onClick:c=>f(a),key:a.id},[r(_,{class:"chat-item-icon",name:"message"}),e("span",Ks,v(a.subject||a.last_chat_message),1)],10,Qs))),128))])]),_:1},512)])}}},Gs=ee(Ws,[["__scopeId","data-v-4b3af25b"]]),Ys={class:"file-toolbar"},Xs={class:"toolbar-left"},Zs={class:"file-list"},eo={key:0,class:"delete-btn action-btn"},to={key:1,class:"preview-btn action-btn"},so=["src"],oo={key:2,class:"progress-bar"},no={key:3,class:"error-text"},lo={__name:"file-toolbar",props:{fileList:{type:Array,default:()=>[]}},emits:["add","delete"],setup(T,{emit:k}){const C=T,n=k,I=Q(()=>C.fileList.map(o=>o.url)),f=o=>{_t({options:{toolbar:!0,initialViewIndex:o},images:I.value}).show()},u=o=>{n("delete",o)};return(o,l)=>{const _=ue;return t(),s("div",Ys,[e("div",Xs,[e("div",Zs,[(t(!0),s(R,null,z(T.fileList,(a,c)=>(t(),s("div",{key:c,class:Z(["file-item",{uploading:a.status==="uploading",error:a.status==="error"}])},[a.status=="done"||a.status=="error"?(t(),s("span",eo,[r(E(we),{class:"delete-icon",onClick:q=>u(c)},null,8,["onClick"])])):p("",!0),a.status=="done"?(t(),s("span",to,[r(_,{class:"preview-icon",name:"eye-open",onClick:q=>f(c)},null,8,["onClick"])])):p("",!0),e("img",{src:a.url,alt:"avatar"},null,8,so),l[0]||(l[0]=e("div",{class:"mask"},null,-1)),a.status==="uploading"?(t(),s("div",oo,[e("div",{class:"progress",style:ze({width:a.percent+"%"})},null,4)])):p("",!0),a.status==="error"?(t(),s("div",no,"上传失败")):p("",!0)],2))),128))])])])}}},ao=ee(lo,[["__scopeId","data-v-69709643"]]),io=(T,k,C)=>new Promise((n,I)=>{dt({file:T.originFile,category:C},f=>{const u=Math.round(f.loaded*100/f.total),o=k.value.find(l=>l.uid===T.uid);if(o){const l={...o,percent:u},_=k.value.findIndex(a=>a.uid===T.uid);_!==-1&&k.value.splice(_,1,l)}}).then(f=>{const u=k.value.find(o=>o.uid===T.uid);if(u){const o={...u,percent:100,status:"done",url:f.data.link||""},l=k.value.findIndex(_=>_.uid===T.uid);l!==-1&&k.value.splice(l,1,o),n(o)}}).catch(f=>{const u=k.value.find(o=>o.uid===T.uid);if(u){const o={...u,status:"error"},l=k.value.findIndex(_=>_.uid===T.uid);l!==-1&&k.value.splice(l,1,o)}I(f)})});function ro(T){const{limit:k=10,maxSize:C=10,accept:n="image/*",multiple:I=!0,category:f,fileList:u=U([])}=T||{};if(!f)throw new Error("category is required");let o=null;const l=c=>{let q=Array.from(c.target.files);const B=k-u.value.length;if(B<=0){ce.error(`最多只能上传 ${k} 张图片`);return}q.length>B&&(q=q.slice(0,B),ce.error(`最多只能上传 ${k} 张图片，已为您选择前 ${B} 张`)),q.forEach(g=>{if(!(g.size/1024/1024<C)){ce.error(`文件大小不能超过 ${C}MB!`);return}const D=g.type;if(!n.split(",").map(h=>h.trim()).some(h=>h.endsWith("/*")?D.startsWith(h.slice(0,-1)):D===h)){ce.error(`不支持的文件类型: ${D}`);return}const b={uid:g.uid||qe(16),name:g.name,status:"uploading",percent:0,originFile:g,url:URL.createObjectURL(g)};u.value.push(b),io(b,u,f).then(h=>{const j=u.value.findIndex(K=>K.uid===h.uid);j!==-1&&u.value.splice(j,1,h)}).catch(()=>{const h=u.value.findIndex(j=>j.uid===b.uid);h!==-1&&(u.value[h].status="error")})}),c.target.value=""},_=()=>{const c=document.createElement("input");return c.type="file",c.accept=n,c.multiple=I,c.style.display="none",c.onchange=l,document.body.appendChild(c),c},a=()=>{if(u.value.length>=k){ce.error(`最多只能上传 ${k} 张图片`);return}o||(o=_()),o.click()};return Ce(()=>{o&&document.body.contains(o)&&(document.body.removeChild(o),o=null)}),{openFileDialog:a}}const co={class:"message-input-wrapper"},uo={key:0,class:"file-toolbar-box"},_o={class:"message-input-box"},po={class:"message-action"},mo=["disabled"],vo={__name:"message-input",props:{value:{type:String,default:""},loading:{type:Boolean,default:!1},fileList:{type:Array,default:()=>[]},showUpload:{type:Boolean,default:!1}},emits:["send","update:value","update:fileList"],setup(T,{emit:k}){const C=k,n=T,{fileList:I}=je(n),{openFileDialog:f}=ro({limit:10,maxSize:10,category:"chat_image",fileList:I,multiple:!0,accept:"image/bmp,image/jpeg,image/png,image/tiff,image/heic,image/gif,image/webp"}),u=c=>{const q=n.fileList.filter((B,g)=>g!==c);C("update:fileList",q)},o=Q(()=>n.fileList.length>0?!1:n.loading||n.value.trim().length===0),l=c=>{C("update:value",c.target.value.trim())},_=c=>{if(c.key==="Enter"&&!c.shiftKey){if(!c.target.value.trim())return;c.preventDefault(),c.stopPropagation(),a()}else c.key==="Enter"&&c.shiftKey&&(c.preventDefault(),c.stopPropagation(),C("update:value",n.value+`
`))},a=()=>{C("send",n.value.trim())};return(c,q)=>{const B=Ze,g=ue,J=Te;return t(),s("div",co,[n.fileList.length>0?(t(),s("div",uo,[r(ao,{"file-list":n.fileList,onDelete:u},null,8,["file-list"])])):p("",!0),e("div",_o,[r(B,{class:"message-input",value:n.value,placeholder:"在此输入您想了解的内容，Shift+Enter换行","auto-size":{minRows:2,maxRows:5},onChange:l,onKeydown:_},null,8,["value"])]),e("div",po,[n.showUpload?(t(),s("div",{key:0,class:"select-file-btn",onClick:q[0]||(q[0]=(...D)=>E(f)&&E(f)(...D))},[r(g,{class:"select-file-icon",name:"circularNeedle"}),E(I).length>0?(t(),s("span",{key:0,class:Z(["file-number",{big:E(I).length>9}])},v(E(I).length),3)):p("",!0)])):p("",!0),e("button",{class:Z(["send-msg-btn",{loading:n.loading}]),disabled:o.value,onClick:a},[n.loading?(t(),N(J,{key:0,size:"small",class:"loading-action",style:{"margin-right":"4px"}})):(t(),N(g,{key:1,class:"paper-airplane",name:"paper-airplane"}))],10,mo)])])}}},go=ee(vo,[["__scopeId","data-v-e330362d"]]),fo={class:"prompt-log-content"},ho={class:"prompt-log-items"},yo={class:"prompt-log-label"},bo={class:"prompt-log-item"},ko={class:"prompt-log-items"},wo={class:"prompt-log-label"},$o={class:"prompt-log-items"},xo={class:"prompt-log-label"},qo={class:"prompt-log-item"},So={class:"prompt-log-items"},Co={class:"prompt-log-label"},Lo={class:"prompt-log-item"},Mo={key:0,class:"prompt-log-items"},To={class:"prompt-log-label"},Io={class:"prompt-log-item"},Eo={key:1,class:"prompt-log-items"},Fo={class:"prompt-log-label"},Ro={class:"prompt-log-item"},Ao={class:"prompt-log-items"},Oo={class:"prompt-log-label"},Uo={class:"prompt-log-item"},Bo={__name:"prompt-log-alert",setup(T,{expose:k}){const C=U(!1),n=Le({prompt:"",library:[],context_qa:[],cur_question:"",cur_answer:"",error:""}),I=()=>{C.value=!1},f=()=>{n.prompt="",n.library=[],n.context_qa=[],n.cur_question="",n.cur_answer="",n.error="",n.recall_time="",n.request_time=""};return k({open:o=>{f(),n.error=o.error,n.recall_time=o.recall_time?(o.recall_time/1e3).toFixed(2):"",n.request_time=o.request_time?(o.request_time/1e3).toFixed(2):"";let l=o.debug||[];for(let _=0;_<l.length;_++){let a=l[_];a.type=="library"?n.library.push(a.content):a.type=="context_qa"?n.context_qa.push(a):n[a.type]=a.content}C.value=!0}}),(o,l)=>{const _=Ie,a=Ee;return t(),N(a,{class:"prompt-log-alert",open:C.value,"onUpdate:open":l[0]||(l[0]=c=>C.value=c),title:"Prompt 日志",placement:"right",width:"746px",closable:!1},{extra:y(()=>[e("span",{class:"close-btn",onClick:I},[r(E(we))])]),default:y(()=>[e("div",fo,[e("div",ho,[e("div",yo,[l[2]||(l[2]=e("span",null,"提示词 ",-1)),r(_,null,{title:y(()=>[...l[1]||(l[1]=[H("系统提示词和文档分段。",-1)])]),default:y(()=>[r(E(ie),{class:"question-icon"})]),_:1})]),e("div",bo,[e("p",null,v(n.prompt),1)]),(t(!0),s(R,null,z(n.library,(c,q)=>(t(),s("div",{class:"prompt-log-item",key:q},[e("p",null,v(c),1)]))),128))]),e("div",ko,[e("div",wo,[l[4]||(l[4]=e("span",null,"上下文 ",-1)),r(_,null,{title:y(()=>[...l[3]||(l[3]=[H("传递的历史提问消息",-1)])]),default:y(()=>[r(E(ie),{class:"question-icon"})]),_:1})]),(t(!0),s(R,null,z(n.context_qa,(c,q)=>(t(),s("div",{class:"prompt-log-item",key:q},[e("p",null,"Q："+v(c.question),1),e("p",null,"A："+v(c.answer),1)]))),128))]),e("div",$o,[e("div",xo,[l[6]||(l[6]=e("span",null,"USER ",-1)),r(_,null,{title:y(()=>[...l[5]||(l[5]=[H("本次用户的提问",-1)])]),default:y(()=>[r(E(ie),{class:"question-icon"})]),_:1})]),e("div",qo,[e("p",null,v(n.cur_question),1)])]),e("div",So,[e("div",Co,[l[8]||(l[8]=e("span",null,"ASSISTANT ",-1)),r(_,null,{title:y(()=>[...l[7]||(l[7]=[H("语言模型输出的答案",-1)])]),default:y(()=>[r(E(ie),{class:"question-icon"})]),_:1})]),e("div",Lo,[e("p",null,v(n.cur_answer),1)])]),n.recall_time>0?(t(),s("div",Mo,[e("div",To,[l[10]||(l[10]=e("span",null,"Recall time ",-1)),r(_,null,{title:y(()=>[...l[9]||(l[9]=[H("从知识库中检索到有效分段所需要的时间，包括对分段进行排序时间。",-1)])]),default:y(()=>[r(E(ie),{class:"question-icon"})]),_:1})]),e("div",Io,[e("p",null,v(n.recall_time)+"s",1)])])):p("",!0),n.request_time>0?(t(),s("div",Eo,[e("div",Fo,[l[12]||(l[12]=e("span",null,"Request time ",-1)),r(_,null,{title:y(()=>[...l[11]||(l[11]=[H("从发送问题和上下文信息给大模型到大模型开始返回答案的时间。",-1)])]),default:y(()=>[r(E(ie),{class:"question-icon"})]),_:1})]),e("div",Ro,[e("p",null,v(n.request_time)+"s",1)])])):p("",!0),e("div",Ao,[e("div",Oo,[l[14]||(l[14]=e("span",null,"Error ",-1)),r(_,null,{title:y(()=>[...l[13]||(l[13]=[H("报错信息，调用聊天接口报错时会显示。",-1)])]),default:y(()=>[r(E(ie),{class:"question-icon"})]),_:1})]),e("div",Uo,[e("p",null,v(n.error),1)])])])]),_:1},8,["open"])}}},Do=ee(Bo,[["__scopeId","data-v-d8a3a35d"]]),Po={class:"library-info-content"},Ho={class:"file-list"},No=["onClick"],zo={key:0},jo={key:1},Vo={class:"document-items"},Jo={class:"document-item-header"},Qo={class:"left-box"},Ko={class:"document-title"},Wo={key:0,class:"document-title"},Go={class:"document-size"},Yo={class:"right-box"},Xo=["onClick"],Zo={class:"document-item-body"},en={class:"document-similarity"},tn={key:0,class:"document-content"},sn={key:1,class:"document-content"},on={class:"document-content"},nn={class:"fragment-img"},ln=["src"],an={class:"iframe-box"},rn={__name:"library-info-alert",setup(T,{expose:k}){const C=ke(),{robot:n,user:I}=C;Ve();const f=U(!1),u=U([]),o=U(null),l=()=>{u.value=[],o.value=null},_=(b,h)=>{if(l(),u.value=b.map(j=>{let K=null;return j.answer_source_data&&(K=JSON.parse(j.answer_source_data)),{...j,answer_source_data:K}}),o.value=h.id,f.value=!0,h.answer_source_data){c.value=JSON.parse(h.answer_source_data)||[];return}q(h)},a=b=>{if(b.id!=o.value){if(o.value=b.id,b.answer_source_data){c.value=b.answer_source_data||[];return}q(b)}},c=U([]),q=b=>{pt({message_id:b.message_id,file_id:b.id,robot_key:n.robot_key,openid:n.openid}).then(h=>{c.value=h.data||[]})},B=()=>{let b=u.value.filter(h=>h.id==o.value)[0]||{};b.file_name?window.open(`#/library/preview?id=${o.value}`):window.open(`#/library/details/categary-manage?id=${b.library_id}`)},g=Q(()=>{let b=u.value.filter(h=>h.id==o.value)[0]||{};return b.file_name?b.file_name:b.library_name+"-精选"}),J=U(""),D=U(!1),w=b=>{D.value=!0,J.value="/manage/getLibRawFileOnePage?id="+o.value+"&page="+b.page_num+"&admin_user_id="+I.admin_user_id},$=()=>{f.value=!1};return k({open:_}),(b,h)=>{const j=ue,K=Ee,G=Ae,Y=Fe,ne=Se("viewer");return t(),s(R,null,[r(K,{class:"library-info-alert",open:f.value,"onUpdate:open":h[0]||(h[0]=x=>f.value=x),title:"答案来源",placement:"right",width:"746px",closable:!1,bodyStyle:{background:"#F2F4F7"}},{extra:y(()=>[e("span",{class:"close-btn",onClick:$},[r(E(we))])]),default:y(()=>[e("div",Po,[e("div",Ho,[(t(!0),s(R,null,z(u.value,x=>(t(),s("div",{class:Z(["file-item",{active:o.value==x.id}]),key:x.id,onClick:X=>a(x)},[x.file_name?(t(),s("span",zo,v(x.file_name),1)):(t(),s("span",jo,v(x.library_name)+"-精选",1))],10,No))),128))]),e("div",Vo,[(t(!0),s(R,null,z(c.value,x=>(t(),s("div",{class:"document-item",key:x.id},[e("div",Jo,[e("div",Qo,[e("span",Ko,"id："+v(x.id),1),x.title?(t(),s("span",Wo,v(x.title),1)):p("",!0),e("span",Go," 共"+v(x.word_total)+"个字符 ",1)]),e("div",Yo,[x.page_num>0?(t(),s("a",{key:0,onClick:X=>w(x)},"预览原文件>",8,Xo)):p("",!0),e("a",{onClick:B},"查看源文档>")])]),e("div",Zo,[e("div",en,[h[2]||(h[2]=H(" 相似度： ",-1)),r(j,{name:"similarity",style:{"font-size":"16px"}}),H(v(x.similarity),1)]),x.question?(t(),s("div",tn,"Q："+v(x.question),1)):p("",!0),x.answer?(t(),s("div",sn,"A："+v(x.answer),1)):p("",!0),e("div",on,v(x.content),1),re((t(),s("div",nn,[(t(!0),s(R,null,z(x.images,(X,S)=>(t(),s("img",{key:S,src:X,alt:""},null,8,ln))),128))])),[[ne]])])]))),128))])])]),_:1},8,["open"]),r(Y,{open:D.value,"onUpdate:open":h[1]||(h[1]=x=>D.value=x),title:g.value,footer:null,width:740},{default:y(()=>[e("div",an,[r(G,null,{default:y(()=>[r(E(mt),{source:J.value},null,8,["source"])]),_:1})])]),_:1},8,["open","title"])],64)}}},cn=ee(rn,[["__scopeId","data-v-e1a41673"]]),un="/assets/img/form-modal-header-Dfjzr0xA.png",_n={class:"form-body"},dn={class:"from-footer"},pn={class:"btn-box"},mn={__name:"index",setup(T,{expose:k}){const C=be().query,n=U(!1),I=ke(),f=Q(()=>I.chat_variables||{}),u=Q(()=>(f.value.wait_variables||[]).map($=>({...$,options:$.options?JSON.parse($.options):[]}))),o=Q(()=>f.value.fill_variables||[]),l=Q(()=>f.value.need_fill_variable||!1),_=U(!1),a=Le({}),c=()=>{n.value=!0,o.value.forEach(w=>{(w.variable_type=="input_string"||w.variable_type=="input_number")&&(a[w.variable_key]=w.value||""),w.variable_type=="select_one"&&(a[w.variable_key]=w.value||void 0),w.variable_type=="checkbox_switch"&&(a[w.variable_key]=w.value==1)}),_.value=!0},q=w=>{w.forEach($=>{($.variable_type=="input_string"||$.variable_type=="input_number")&&(a[$.variable_key]=$.default_value||""),$.variable_type=="select_one"&&(a[$.variable_key]=$.default_value||void 0),$.variable_type=="checkbox_switch"&&(a[$.variable_key]=$.default_value==1)})},B=w=>w.max_input_length>0?+w.max_input_length:50;me(()=>u.value,w=>{f.value,w&&q(u.value)},{deep:!0}),me(()=>l.value,w=>{w&&(n.value=!1,_.value=!0)},{deep:!0,immediate:!0});const g=U(null),J=()=>{g.value.validate().then(()=>{let w=D(),$=`chat_prompt_variables_${C.robot_key}`;n.value?I.handleEditVariables({chat_prompt_variables:w}):localStorage.setItem($,JSON.stringify(w)),_.value=!1})};function D(){return u.value.map($=>{let b=a[$.variable_key];return $.variable_type=="checkbox_switch"&&(b=b?1:0),{...$,value:b}})}return k({handleEdit:c}),(w,$)=>{const b=tt,h=st,j=nt,K=ot,G=lt,Y=et,ne=at,x=Re,X=Fe;return t(),N(X,{wrapClassName:"variable-modal-class",open:_.value,"onUpdate:open":$[0]||($[0]=S=>_.value=S),title:null,footer:null,closable:n.value,maskClosable:!1,width:560},{default:y(()=>[$[2]||($[2]=e("div",{class:"modal-header"},[e("div",{class:"banner-bg"},[e("img",{src:un,alt:""})]),e("div",{class:"title"},"请先填写信息")],-1)),e("div",_n,[r(ne,{model:a,ref_key:"formRef",ref:g,layout:"vertical"},{default:y(()=>[(t(!0),s(R,null,z(u.value,S=>(t(),N(Y,{key:S.variable_key,label:S.variable_type=="checkbox_switch"?null:S.variable_name,name:S.variable_key,rules:[{required:S.must_input==1,message:`请输入${S.variable_name}`}]},{default:y(()=>[S.variable_type=="input_string"?(t(),N(b,{key:0,value:a[S.variable_key],"onUpdate:value":V=>a[S.variable_key]=V,maxLength:B(S),placeholder:"请输入"},null,8,["value","onUpdate:value","maxLength"])):p("",!0),S.variable_type=="input_number"?(t(),N(h,{key:1,style:{width:"100%"},value:a[S.variable_key],"onUpdate:value":V=>a[S.variable_key]=V,stringMode:"",maxLength:50,placeholder:"请输入"},null,8,["value","onUpdate:value"])):p("",!0),S.variable_type=="select_one"?(t(),N(K,{key:2,value:a[S.variable_key],"onUpdate:value":V=>a[S.variable_key]=V,style:{width:"100%"}},{default:y(()=>[(t(!0),s(R,null,z(S.options,V=>(t(),N(j,{value:V.label,key:V.label},{default:y(()=>[H(v(V.label),1)]),_:2},1032,["value"]))),128))]),_:2},1032,["value","onUpdate:value"])):p("",!0),S.variable_type=="checkbox_switch"?(t(),N(G,{key:3,checked:a[S.variable_key],"onUpdate:checked":V=>a[S.variable_key]=V},{default:y(()=>[H(v(S.variable_name),1)]),_:2},1032,["checked","onUpdate:checked"])):p("",!0)]),_:2},1032,["label","name","rules"]))),128))]),_:1},8,["model"])]),e("div",dn,[e("div",pn,[r(x,{onClick:J,block:"",type:"primary"},{default:y(()=>[...$[1]||($[1]=[H("提 交",-1)])]),_:1})])])]),_:1},8,["open","closable"])}}},vn=ee(mn,[["__scopeId","data-v-87d84d0c"]]),gn={class:"chat-page-wrapper"},fn={class:"chat-page-header"},hn={class:"breadcrumb-box"},yn={class:"chat-page"},bn={class:"page-left"},kn={class:"page-left-top"},wn={class:"page-left-body"},$n={class:"page-body"},xn={key:0,class:"form-banner-top"},qn={class:"chat-box-body"},Sn={style:{"padding-top":"30px"},class:"chat-box-footer"},Cn={__name:"index",setup(T){const C=be().query,n=Me(),{getRobot:I}=n,f=Q(()=>n.robotInfo),u=We(),o=ke(),l=De();let _=!0;const a=U(""),c=U([]),q=U(null),{createChat:B,sendMessage:g,getMyChatList:J,openChat:D,onGetChatMessage:w,changeRobotPrompt:$,$reset:b}=o,{messageList:h,sendLock:j,myChatList:K,robot:G,dialogue_id:Y}=Je(o),ne=Q(()=>!o.chat_variables.need_fill_variable&&o.chat_variables.fill_variables&&o.chat_variables.fill_variables.length),x=be(),X=U(!1),S=U(!1),V=Q(()=>j.value||S.value),m=async()=>{if(!V.value){if(!a.value&&!c.value.length)return Pe("请输入消息内容");S.value=!0;try{let M=await vt({robot_key:G.value.robot_key,openid:G.value.openid,question:a.value,form_ids:G.value.form_ids,dialogue_id:Y.value});if(S.value=!1,M.data&&M.data.words)return ce.error(`提交的内容包含敏感词：[${M.data.words.join(";")}] 请修改后再提交`);let O=1,oe=a.value;if(f.value.question_multiple_switch==1){let ae=[];O=99,a.value&&(ae=[{type:"text",uid:qe(16),text:a.value}]),c.value.length&&c.value.map(pe=>{ae.push({uid:pe.uid,type:"image_url",image_url:{url:pe.url}})}),oe=JSON.stringify(ae)}_=!0,g({message:oe,global:JSON.stringify(C),msg_type:O}),a.value="",c.value=[]}catch{S.value=!1}}},L=async()=>{_=!0,a.value="";let M=x.query||{},O=l.user_id,oe={robot_key:M.robot_key,avatar:M.avatar,name:M.name,nickname:M.nickname,is_background:1,openid:O,dialogue_id:0};le(),await B(oe)},F=async M=>{if(Y.value==M.dialogue_id)return;_=!0;let oe={robot_key:(x.query||{}).robot_key,avatar:M.avatar,name:M.name,nickname:M.nickname,is_background:M.is_background,openid:M.openid,dialogue_id:M.id};le(),await D(oe),await w()&&d()},A=M=>{_=!0,g({message:M})};U(!1);const P=()=>{d()},te=async()=>{_=!1;let M=h.value[0].uid;await w()&&se(M)},i=()=>{},d=()=>{q.value&&_&&q.value.scrollToBottom()},se=M=>{q.value&&q.value.scrollToMessage(M)},le=()=>{q.value&&q.value.resetScroll()},W=()=>{J()},_e=U(null),de=M=>{_e.value.open(M)},$e=U(null),Oe=(M,O)=>{$e.value.open(M,O)},xe=U(null),Ue=()=>{xe.value.handleEdit()};return me(()=>h.value,()=>{}),Qe(async()=>{L(),J(),await I(C.id),X.value=!0,u.on("updateAiMessage",P)}),Ce(()=>{b(),u.off("updateAiMessage",P)}),(M,O)=>{const oe=Ke("router-link"),ae=ct,pe=it,Be=Re;return t(),s("div",gn,[e("div",fn,[e("div",hn,[r(pe,null,{default:y(()=>[r(ae,null,{default:y(()=>[r(oe,{to:"/robot/list"},{default:y(()=>[...O[2]||(O[2]=[H("机器人管理",-1)])]),_:1})]),_:1}),r(ae,null,{default:y(()=>[H(v(E(G).robot_name),1)]),_:1})]),_:1})])]),e("div",yn,[e("div",bn,[e("div",kn,[r(Be,{type:"primary",block:"",ghost:"",onClick:L},{default:y(()=>[r(E(ut)),O[3]||(O[3]=H(" 新建对话",-1))]),_:1})]),e("div",wn,[r(Gs,{list:E(K),active:E(Y),onOpenChat:F,onOnScrollEnd:W},null,8,["list","active"])]),O[4]||(O[4]=e("div",{class:"page-left-footer"},null,-1))]),e("div",$n,[ne.value?(t(),s("div",xn,[O[6]||(O[6]=e("div",{class:"title"},"表单信息",-1)),e("div",{class:"edit-block",onClick:Ue},[r(E(rt)),O[5]||(O[5]=H("编辑 ",-1))])])):p("",!0),e("div",qn,[r(Vs,{ref_key:"messageListRef",ref:q,messages:E(h),robotInfo:f.value,onClickMsgMeun:A,onScrollStart:te,onScrollEnd:i,onOpenPromptLog:de,onOpenLibrary:Oe},null,8,["messages","robotInfo"])]),e("div",Sn,[r(go,{value:a.value,"onUpdate:value":O[0]||(O[0]=ve=>a.value=ve),fileList:c.value,"onUpdate:fileList":O[1]||(O[1]=ve=>c.value=ve),loading:V.value,showUpload:f.value.question_multiple_switch==1,onSend:m},null,8,["value","fileList","loading","showUpload"])])]),e("div",null,[p("",!0)])]),r(Do,{ref_key:"promptLogAlertRef",ref:_e},null,512),r(cn,{ref_key:"libraryInfoAlertRef",ref:$e},null,512),r(vn,{ref_key:"variableModalRef",ref:xe},null,512)])}}},Kn=ee(Cn,[["__scopeId","data-v-65f2c312"]]);export{Kn as default};
