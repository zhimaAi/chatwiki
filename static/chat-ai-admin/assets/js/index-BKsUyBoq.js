import{Y as s,_ as t,a5 as e,ae as g,ad as G,F as q,a9 as O,a7 as m,e as ee,f as T,n as V,k as a,a2 as v,a1 as K,u as C,G as E,A as xe,y as oe,J as se,q as _e,w as de,r as Se,aa as Te,ab as re,ag as Le,o as Me,b as Ie,af as Ee}from"./vue-chunks-Ci-XTWEs.js";import{u as Oe}from"./useEventBus-BwH2zX88.js";import{u as pe}from"./chat-PhIeNawd.js";import{b as j,d as ne,h as Re,b5 as Ae}from"../../index-BZRrEp3V.js";import{_ as ce}from"./index-AGdtDeuS.js";import{ah as me,$ as ue,am as Be,p as ge,Q as De,ab as U,au as ve,aw as fe,M as He,i as Pe,B as Fe,j as Ne,z as Ue,a as je}from"./ui-antd-BWf8LxGy.js";import{_ as he}from"./cu-scroll-BD8CyTy-.js";import{h as Qe}from"./index-7T5SviPf.js";import{V as ze}from"./vue3-pdf-embed-DNcosj3W.js";import{W as Je}from"./index-BOvAmdHY.js";import{u as Ve}from"./robot-ChheCicf.js";import"./useIM-BjK15RNY.js";import"./index-BpTkDq9_.js";import"./utils-ChQO-_r6.js";import"./pull-up.esm-D94Swpvl.js";import"./observe-dom.esm-CyCedSm-.js";import"./vue-pdf-embed-B4woVYJb.js";const Ke={class:"guess-you-want"},Ge={class:"message-tabs"},We={key:1,class:"v-line"},Ye={key:0,class:"message-menus"},Xe=["onClick"],Ze={key:1,class:"message-menus"},et=["onClick"],tt={__name:"guess-you-want",props:{item:{type:Object,default:()=>{}},common_question_list:{type:Object,default:()=>[]},enable_common_question:{type:Boolean,default:!1}},emits:["clickMeun"],setup(L,{emit:R}){const k=R,o=L,f=(w,u)=>{w.question_tabkey=u},S=w=>{k("clickMeun",w)};return(w,u)=>(t(),s("div",Ke,[e("div",Ge,[o.item.guess_you_want?(t(),s("div",{key:0,onClick:u[0]||(u[0]=n=>f(o.item,1)),class:G(["tab-item",{active:o.item.question_tabkey==1}])}," 猜你想问 ",2)):g("",!0),o.item.guess_you_want&&o.common_question_list&&o.enable_common_question?(t(),s("div",We)):g("",!0),o.common_question_list&&o.enable_common_question?(t(),s("div",{key:2,onClick:u[1]||(u[1]=n=>f(o.item,2)),class:G(["tab-item",{active:o.item.question_tabkey==2}])}," 常见问题 ",2)):g("",!0)]),o.item.question_tabkey==1?(t(),s("div",Ye,[(t(!0),s(q,null,O(o.item.guess_you_want,(n,p)=>(t(),s("div",{onClick:_=>S(n),class:"menu-item",key:p},m(n),9,Xe))),128))])):(t(),s("div",Ze,[(t(!0),s(q,null,O(L.common_question_list,(n,p)=>(t(),s("div",{onClick:_=>S(n),class:"menu-item",key:p},m(n),9,et))),128))]))]))}},st=j(tt,[["__scopeId","data-v-9c22a890"]]),ot={class:"message-list-wrapper"},nt={class:"message-list"},lt=["id"],at={class:"itme-left"},it=["src"],rt={class:"itme-right"},ct={class:"item-body"},ut={key:0,class:"message-content"},_t=["src"],dt={class:"message-content"},pt=["id"],mt={class:"itme-left"},gt=["src"],vt={class:"itme-right"},ft={key:0,class:"reply-list"},ht={key:0,class:"reply-item reply-text"},yt=["innerHTML"],bt={key:1,class:"reply-item reply-image"},kt={class:"message-content"},wt=["src"],$t={key:2,class:"reply-item reply-url"},qt={class:"url-row"},Ct=["href"],xt={key:3,class:"reply-item reply-card"},St={class:"card-row"},Tt=["src"],Lt={class:"card-title-box"},Mt={class:"card-title"},It={key:4,class:"reply-item reply-imageText"},Et=["href"],Ot=["src"],Rt={class:"imageText-text"},At={class:"imageText-title"},Bt={class:"imageText-desc"},Dt={class:"label-flex-block"},Ht=["onClick"],Pt={class:"label-text"},Ft=["onClick"],Nt={class:"label-text"},Ut={key:1,class:"item-body"},jt={key:0,class:"file-items"},Qt=["onClick"],zt={class:"file-name"},Jt={key:0},Vt={key:1},Kt={key:1,class:"thinking-content"},Gt={class:"message-content"},Wt={class:"message-menus"},Yt=["onClick"],Xt=["innerHTML"],Zt={class:"message-menus"},es=["onClick"],ts={key:4,class:"message-content"},ss=["src"],os={key:5,class:"message-action-wrap"},ns={key:0,class:"message-action"},ls={class:"action-btn"},as=["onClick"],is={__name:"message-list",props:{messages:{type:Array,default:()=>[]},robotInfo:{type:Object,default:()=>{}}},emits:["clickMsgMeun","scroll","scrollStart","scrollEnd","openPromptLog","openLibrary"],setup(L,{expose:R,emit:k}){const o=k,f=L,S=d=>{d.show_reasoning=!d.show_reasoning},w=d=>{d.show_quote_file=!d.show_quote_file},u=ee(()=>f.robotInfo.common_question_list.length?JSON.parse(f.robotInfo.common_question_list):[]),n=ee(()=>(f.robotInfo.chat_type==1||f.robotInfo.chat_type==3)&&f.robotInfo.application_type=="0"),p=d=>{o("clickMsgMeun",d)},_=T(null),i={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let I=null,B=!1;function Q(d){B||(I&&(clearTimeout(I),I=null),I=setTimeout(()=>{i.scrollTop-d.target.scrollTop>0&&(i.scrollDirection="up"),i.scrollTop-d.target.scrollTop<0&&(i.scrollDirection="down"),i.scrollTop=d.target.scrollTop,i.scrollHeight=d.target.scrollHeight,i.clientHeight=d.target.clientHeight,o("scroll",{...i}),Math.abs(i.scrollTop)<=i.scrollStartDiff&&i.scrollDirection==="up"&&z(),Math.abs(i.scrollHeight-i.scrollTop-i.clientHeight)<=i.scrollEndDiff&&i.scrollDirection==="down"&&H()},50))}function z(){f.messages.length!=0&&o("scrollStart",{msg:f.messages[0]})}function H(){f.messages.length!=0&&o("scrollEnd",{msg:f.messages[f.messages.length-1]})}const X=()=>{_.value&&oe(()=>{B=!0,_.value.scrollTop=_.value.scrollHeight+1,setTimeout(()=>{i.scrollTop=_.value.scrollTop,B=!1},50)})};function W(d,x){oe(()=>{B=!0,x||(x="top");let c=_.value,$=document.querySelector("#msg-"+d);x=="top"?c.scrollTop=$.offsetTop:c.scrollTop=$.offsetTop-c.clientHeight+$.clientHeight,setTimeout(()=>{i.scrollTop=_.value.scrollTop,B=!1},50)})}function h(){i.scrollTop=0,i.scrollDirection=""}function b(d){return!!(d.quote_file&&d.quote_file.length>0||d.debug&&d.debug.length>0)}function D(d){o("openPromptLog",se(d))}function A(d,x,c){let $=se(d);x.message_id=x.message_id||c,$.forEach(F=>{F.message_id=F.message_id||c}),o("openLibrary",$,se(x))}function P(d){try{return d?Array.isArray(d)?d:typeof d=="string"?JSON.parse(d||"[]"):[]:[]}catch{return[]}}return R({scrollToBottom:X,scrollToMessage:W,resetScroll:h}),(d,x)=>{const c=me,$=ne,F=ge,J=_e("viewer");return t(),s("div",ot,[e("div",{class:"scroll-box",ref_key:"scrollBoxRef",ref:_,onScroll:Q},[e("div",nt,[(t(!0),s(q,null,O(f.messages,l=>(t(),s(q,{key:l.uid},[l.is_customer==1?(t(),s("div",{key:0,class:"message-item user-message",id:"msg-"+l.uid},[e("div",at,[e("img",{class:"user-avatar",src:l.avatar},null,8,it)]),e("div",rt,[e("div",ct,[l.received_message_type=="image"&&l.media_id_to_oss_url?(t(),s("div",ut,[V(e("img",{class:"msg-img",src:l.media_id_to_oss_url,alt:""},null,8,_t),[[J]])])):g("",!0),e("div",dt,m(l.content),1)])])],8,lt)):(t(),s("div",{key:1,class:"message-item robot-message",id:"msg-"+l.uid},[e("div",mt,[a(c,{size:"small",spinning:l.loading},{default:v(()=>[e("img",{class:"robot-avatar",src:l.robot_avatar},null,8,gt)]),_:2},1032,["spinning"])]),e("div",vt,[P(l.reply_content_list).length?(t(),s("div",ft,[(t(!0),s(q,null,O(P(l.reply_content_list),(r,N)=>(t(),s(q,{key:N},[(r.reply_type||r.type)==="text"?(t(),s("div",ht,[e("div",{class:"message-content",innerHTML:r.description},null,8,yt)])):(r.reply_type||r.type)==="image"?(t(),s("div",bt,[e("div",kt,[V(e("img",{class:"msg-img",src:r.pic||r.thumb_url},null,8,wt),[[J]])])])):(r.reply_type||r.type)==="url"?(t(),s("div",$t,[e("div",qt,[e("a",{class:"url-link",href:r.url,target:"_blank"},m(r.url),9,Ct)])])):(r.reply_type||r.type)==="card"?(t(),s("div",xt,[e("div",St,[r.thumb_url?(t(),s("img",{key:0,src:r.thumb_url,class:"card-thumb"},null,8,Tt)):g("",!0),e("div",Lt,[a($,{class:"think-icon",name:"applet"}),e("span",Mt,m(r.title),1)])])])):(r.reply_type||r.type)==="imageText"?(t(),s("div",It,[e("a",{class:"imageText-row",href:r.url,target:"_blank"},[r.thumb_url?(t(),s("img",{key:0,src:r.thumb_url,class:"imageText-thumb"},null,8,Ot)):g("",!0),e("div",Rt,[e("div",At,m(r.title),1),e("div",Bt,m(r.description),1)])],8,Et)])):g("",!0)],64))),128))])):g("",!0),e("div",Dt,[l.msg_type==1&&n.value?(t(),s("div",{key:0,class:G(["thinking-label-wrapper",{reasoning_open:l.show_quote_file}])},[e("div",{class:"thinking-label",onClick:r=>w(l)},[l.quote_loading?(t(),s(q,{key:0},[a(C(ue),{class:"loading"}),x[0]||(x[0]=e("span",{class:"label-text"},"正在检索知识库...",-1))],64)):(t(),s(q,{key:1},[a($,{class:"think-icon",name:"quote-file"}),e("span",Pt,"检索到"+m(l.quote_file.length)+"个知识库文档",1)],64)),l.quote_file.length?(t(),K($,{key:2,name:"arrow-down",class:"arrow-down"})):g("",!0)],8,Ht)],2)):g("",!0),l.reasoning_content?(t(),s("div",{key:1,class:G(["thinking-label-wrapper",{reasoning_open:l.show_reasoning}])},[e("div",{class:"thinking-label",onClick:r=>S(l)},[l.reasoning_status?(t(),K(C(ue),{key:0,class:"loading"})):(t(),K($,{key:1,class:"think-icon",name:"think"})),e("span",Nt,m(l.reasoning_status?"深度思考中...":"已完成深度思考"),1),l.reasoning_status?g("",!0):(t(),K($,{key:2,name:"arrow-down",class:"arrow-down"}))],8,Ft),a(F,null,{title:v(()=>x[1]||(x[1]=[E("在应用设置中关闭推理过程开关，将不再显示推理过程")])),default:v(()=>[a(C(Be),{class:"tip"})]),_:1})],2)):g("",!0)]),l.msg_type==1&&l.content==""?g("",!0):(t(),s("div",Ut,[l.show_quote_file&&l.quote_file&&l.quote_file.length>0?(t(),s("div",jt,[(t(!0),s(q,null,O(l.quote_file,r=>(t(),s("div",{class:"file-item",key:r.id,onClick:N=>A(l.quote_file,r,l.id)},[e("a",zt,[a($,{class:"think-icon",name:"quote-file"}),r.file_name?(t(),s("span",Jt,m(r.file_name),1)):(t(),s("span",Vt,m(r.library_name)+"-精选",1))])],8,Qt))),128))])):g("",!0),l.show_reasoning?(t(),s("div",Kt,[a(ce,{content:l.reasoning_content},null,8,["content"])])):g("",!0),l.msg_type==1?(t(),s(q,{key:2},[V((t(),s("div",Gt,[a(ce,{content:l.content},null,8,["content"])])),[[J]]),e("div",Wt,[(t(!0),s(q,null,O(l.question,(r,N)=>(t(),s("div",{class:"menu-item",onClick:Z=>p(r),key:N},m(r),9,Yt))),128))])],64)):g("",!0),l.msg_type==2?(t(),s(q,{key:3},[e("div",{class:"message-content",innerHTML:l.menu_json.content},null,8,Xt),e("div",Zt,[(t(!0),s(q,null,O(l.menu_json.question,(r,N)=>(t(),s("div",{class:"menu-item",onClick:Z=>p(r),key:N},m(r),9,es))),128))])],64)):g("",!0),l.msg_type==3?(t(),s("div",ts,[V(e("img",{class:"msg-img",src:l.content,alt:""},null,8,ss),[[J]])])):g("",!0),b(l)?V((t(),s("div",os,[l.debug&&l.debug.length>0?(t(),s("div",ns,[e("div",ls,[e("span",null,[e("a",{onClick:r=>D(l)},"Prompt 日志",8,as)])])])):g("",!0)],512)),[[xe,!l.question]]):g("",!0)])),(l.guess_you_want&&l.guess_you_want.length||u.value.length&&f.robotInfo.enable_common_question=="true")&&l.question_tabkey>0?(t(),K(st,{key:2,item:l,enable_common_question:f.robotInfo.enable_common_question=="true",common_question_list:u.value,onClickMeun:p},null,8,["item","enable_common_question","common_question_list"])):g("",!0)])],8,pt))],64))),128))])],544)])}}},rs=j(is,[["__scopeId","data-v-2988ccd7"]]),cs={class:"chat-list-box"},us=["onClick"],_s={class:"chat-item-title"},ds={__name:"chat-list",props:{list:{type:Array,default:()=>[]},active:{type:[String,Number],default:""}},emits:["openChat","onScrollEnd"],setup(L,{emit:R}){const k=R,o=L,f=T(null),S=u=>{k("openChat",u)},w=()=>{k("onScrollEnd")};return de(()=>o.list,()=>{oe(()=>{f.value.refresh()})}),(u,n)=>{const p=ne;return t(),s("div",cs,[a(he,{ref_key:"scroller",ref:f,onOnScrollEnd:w},{default:v(()=>[e("div",null,[(t(!0),s(q,null,O(o.list,_=>(t(),s("div",{class:G(["chat-list-item",{active:_.id==o.active}]),onClick:i=>S(_),key:_.id},[a(p,{class:"chat-item-icon",name:"message"}),e("span",_s,m(_.subject||_.last_chat_message),1)],10,us))),128))])]),_:1},512)])}}},ps=j(ds,[["__scopeId","data-v-8a5dd127"]]),ms={class:"message-input-wrapper"},gs={class:"message-action"},vs={class:"loading-action"},fs=["disabled"],hs={__name:"message-input",props:{value:{type:String,default:""},loading:{type:Boolean,default:!1}},emits:["send","update:value"],setup(L,{emit:R}){const k=R,o=L,f=ee(()=>o.loading||o.value.trim().length===0),S=n=>{k("update:value",n.target.value.trim())},w=n=>{if(n.key==="Enter"&&!n.shiftKey){if(!n.target.value.trim())return;n.preventDefault(),u()}else n.key==="Enter"&&n.shiftKey&&(n.preventDefault(),k("update:value",o.value+`
`))},u=()=>{k("send",o.value.trim())};return(n,p)=>{const _=De,i=me;return t(),s("div",ms,[a(_,{value:L.value,"auto-size":{minRows:5,maxRows:5},placeholder:"在此输入您想了解的内容，Shift+Enter换行",onChange:S,onKeydown:w},null,8,["value"]),e("div",gs,[e("span",vs,[a(i,{spinning:L.loading},null,8,["spinning"])]),L.loading?g("",!0):(t(),s("button",{key:0,class:"send-msg-btn",disabled:f.value,onClick:u},p[0]||(p[0]=[e("span",null,"发送",-1)]),8,fs))])])}}},ys=j(hs,[["__scopeId","data-v-47f207c0"]]),bs={class:"prompt-log-content"},ks={class:"prompt-log-items"},ws={class:"prompt-log-label"},$s={class:"prompt-log-item"},qs={class:"prompt-log-items"},Cs={class:"prompt-log-label"},xs={class:"prompt-log-items"},Ss={class:"prompt-log-label"},Ts={class:"prompt-log-item"},Ls={class:"prompt-log-items"},Ms={class:"prompt-log-label"},Is={class:"prompt-log-item"},Es={key:0,class:"prompt-log-items"},Os={class:"prompt-log-label"},Rs={class:"prompt-log-item"},As={key:1,class:"prompt-log-items"},Bs={class:"prompt-log-label"},Ds={class:"prompt-log-item"},Hs={class:"prompt-log-items"},Ps={class:"prompt-log-label"},Fs={class:"prompt-log-item"},Ns={__name:"prompt-log-alert",setup(L,{expose:R}){const k=T(!1),o=Se({prompt:"",library:[],context_qa:[],cur_question:"",cur_answer:"",error:""}),f=()=>{k.value=!1},S=()=>{o.prompt="",o.library=[],o.context_qa=[],o.cur_question="",o.cur_answer="",o.error="",o.recall_time="",o.request_time=""};return R({open:u=>{S(),o.error=u.error,o.recall_time=u.recall_time?(u.recall_time/1e3).toFixed(2):"",o.request_time=u.request_time?(u.request_time/1e3).toFixed(2):"";let n=u.debug||[];for(let p=0;p<n.length;p++){let _=n[p];_.type=="library"?o.library.push(_.content):_.type=="context_qa"?o.context_qa.push(_):o[_.type]=_.content}k.value=!0}}),(u,n)=>{const p=ge,_=fe;return t(),K(_,{class:"prompt-log-alert",open:k.value,"onUpdate:open":n[0]||(n[0]=i=>k.value=i),title:"Prompt 日志",placement:"right",width:"746px",closable:!1},{extra:v(()=>[e("span",{class:"close-btn",onClick:f},[a(C(ve))])]),default:v(()=>[e("div",bs,[e("div",ks,[e("div",ws,[n[2]||(n[2]=e("span",null,"提示词 ",-1)),a(p,null,{title:v(()=>n[1]||(n[1]=[E("系统提示词和文档分段。")])),default:v(()=>[a(C(U),{class:"question-icon"})]),_:1})]),e("div",$s,[e("p",null,m(o.prompt),1)]),(t(!0),s(q,null,O(o.library,(i,I)=>(t(),s("div",{class:"prompt-log-item",key:I},[e("p",null,m(i),1)]))),128))]),e("div",qs,[e("div",Cs,[n[4]||(n[4]=e("span",null,"上下文 ",-1)),a(p,null,{title:v(()=>n[3]||(n[3]=[E("传递的历史提问消息")])),default:v(()=>[a(C(U),{class:"question-icon"})]),_:1})]),(t(!0),s(q,null,O(o.context_qa,(i,I)=>(t(),s("div",{class:"prompt-log-item",key:I},[e("p",null,"Q："+m(i.question),1),e("p",null,"A："+m(i.answer),1)]))),128))]),e("div",xs,[e("div",Ss,[n[6]||(n[6]=e("span",null,"USER ",-1)),a(p,null,{title:v(()=>n[5]||(n[5]=[E("本次用户的提问")])),default:v(()=>[a(C(U),{class:"question-icon"})]),_:1})]),e("div",Ts,[e("p",null,m(o.cur_question),1)])]),e("div",Ls,[e("div",Ms,[n[8]||(n[8]=e("span",null,"ASSISTANT ",-1)),a(p,null,{title:v(()=>n[7]||(n[7]=[E("语言模型输出的答案")])),default:v(()=>[a(C(U),{class:"question-icon"})]),_:1})]),e("div",Is,[e("p",null,m(o.cur_answer),1)])]),o.recall_time>0?(t(),s("div",Es,[e("div",Os,[n[10]||(n[10]=e("span",null,"Recall time ",-1)),a(p,null,{title:v(()=>n[9]||(n[9]=[E("从知识库中检索到有效分段所需要的时间，包括对分段进行排序时间。")])),default:v(()=>[a(C(U),{class:"question-icon"})]),_:1})]),e("div",Rs,[e("p",null,m(o.recall_time)+"s",1)])])):g("",!0),o.request_time>0?(t(),s("div",As,[e("div",Bs,[n[12]||(n[12]=e("span",null,"Request time ",-1)),a(p,null,{title:v(()=>n[11]||(n[11]=[E("从发送问题和上下文信息给大模型到大模型开始返回答案的时间。")])),default:v(()=>[a(C(U),{class:"question-icon"})]),_:1})]),e("div",Ds,[e("p",null,m(o.request_time)+"s",1)])])):g("",!0),e("div",Hs,[e("div",Ps,[n[14]||(n[14]=e("span",null,"Error ",-1)),a(p,null,{title:v(()=>n[13]||(n[13]=[E("报错信息，调用聊天接口报错时会显示。")])),default:v(()=>[a(C(U),{class:"question-icon"})]),_:1})]),e("div",Fs,[e("p",null,m(o.error),1)])])])]),_:1},8,["open"])}}},Us=j(Ns,[["__scopeId","data-v-6f598f2d"]]),js={class:"library-info-content"},Qs={class:"file-list"},zs=["onClick"],Js={key:0},Vs={key:1},Ks={class:"document-items"},Gs={class:"document-item-header"},Ws={class:"left-box"},Ys={class:"document-title"},Xs={key:0,class:"document-title"},Zs={class:"document-size"},eo={class:"right-box"},to=["onClick"],so={class:"document-item-body"},oo={class:"document-similarity"},no={key:0,class:"document-content"},lo={key:1,class:"document-content"},ao={class:"document-content"},io={class:"fragment-img"},ro=["src"],co={class:"iframe-box"},uo={__name:"library-info-alert",setup(L,{expose:R}){const k=pe(),{robot:o,user:f}=k;Te();const S=T(!1),w=T([]),u=T(null),n=()=>{w.value=[],u.value=null},p=(h,b)=>{if(n(),w.value=h.map(D=>{let A=null;return D.answer_source_data&&(A=JSON.parse(D.answer_source_data)),{...D,answer_source_data:A}}),u.value=b.id,S.value=!0,b.answer_source_data){i.value=JSON.parse(b.answer_source_data)||[];return}I(b)},_=h=>{if(h.id!=u.value){if(u.value=h.id,h.answer_source_data){i.value=h.answer_source_data||[];return}I(h)}},i=T([]),I=h=>{Qe({message_id:h.message_id,file_id:h.id,robot_key:o.robot_key,openid:o.openid}).then(b=>{i.value=b.data||[]})},B=()=>{let h=w.value.filter(b=>b.id==u.value)[0]||{};h.file_name?window.open(`#/library/preview?id=${u.value}`):window.open(`#/library/details/categary-manage?id=${h.library_id}`)},Q=ee(()=>{let h=w.value.filter(b=>b.id==u.value)[0]||{};return h.file_name?h.file_name:h.library_name+"-精选"}),z=T(""),H=T(!1),X=h=>{H.value=!0,z.value="/manage/getLibRawFileOnePage?id="+u.value+"&page="+h.page_num+"&admin_user_id="+f.admin_user_id},W=()=>{S.value=!1};return R({open:p}),(h,b)=>{const D=ne,A=fe,P=he,d=He,x=_e("viewer");return t(),s(q,null,[a(A,{class:"library-info-alert",open:S.value,"onUpdate:open":b[0]||(b[0]=c=>S.value=c),title:"答案来源",placement:"right",width:"746px",closable:!1,bodyStyle:{background:"#F2F4F7"}},{extra:v(()=>[e("span",{class:"close-btn",onClick:W},[a(C(ve))])]),default:v(()=>[e("div",js,[e("div",Qs,[(t(!0),s(q,null,O(w.value,c=>(t(),s("div",{class:G(["file-item",{active:u.value==c.id}]),key:c.id,onClick:$=>_(c)},[c.file_name?(t(),s("span",Js,m(c.file_name),1)):(t(),s("span",Vs,m(c.library_name)+"-精选",1))],10,zs))),128))]),e("div",Ks,[(t(!0),s(q,null,O(i.value,c=>(t(),s("div",{class:"document-item",key:c.id},[e("div",Gs,[e("div",Ws,[e("span",Ys,"id："+m(c.id),1),c.title?(t(),s("span",Xs,m(c.title),1)):g("",!0),e("span",Zs," 共"+m(c.word_total)+"个字符 ",1)]),e("div",eo,[c.page_num>0?(t(),s("a",{key:0,onClick:$=>X(c)},"预览原文件>",8,to)):g("",!0),e("a",{onClick:B},"查看源文档>")])]),e("div",so,[e("div",oo,[b[2]||(b[2]=E(" 相似度： ")),a(D,{name:"similarity",style:{"font-size":"16px"}}),E(m(c.similarity),1)]),c.question?(t(),s("div",no,"Q："+m(c.question),1)):g("",!0),c.answer?(t(),s("div",lo,"A："+m(c.answer),1)):g("",!0),e("div",ao,m(c.content),1),V((t(),s("div",io,[(t(!0),s(q,null,O(c.images,($,F)=>(t(),s("img",{key:F,src:$,alt:""},null,8,ro))),128))])),[[x]])])]))),128))])])]),_:1},8,["open"]),a(d,{open:H.value,"onUpdate:open":b[1]||(b[1]=c=>H.value=c),title:Q.value,footer:null,width:740},{default:v(()=>[e("div",co,[a(P,null,{default:v(()=>[a(C(ze),{source:z.value},null,8,["source"])]),_:1})])]),_:1},8,["open","title"])],64)}}},_o=j(uo,[["__scopeId","data-v-e8bc69ca"]]),po={class:"chat-page-wrapper"},mo={class:"chat-page-header"},go={class:"breadcrumb-box"},vo={class:"chat-page"},fo={class:"page-left"},ho={class:"page-left-top"},yo={class:"page-left-body"},bo={class:"page-body"},ko={class:"chat-box-body"},wo={style:{"margin-top":"30px"},class:"chat-box-footer"},$o={__name:"index",setup(L){const k=re().query,o=Ve(),{getRobot:f,robotInfo:S}=o,w=Oe(),u=pe(),n=Re();let p=!0;const _=T(""),i=T(null),{createChat:I,sendMessage:B,getMyChatList:Q,openChat:z,onGetChatMessage:H,changeRobotPrompt:X,$reset:W}=u,{messageList:h,sendLock:b,myChatList:D,robot:A,dialogue_id:P}=Le(u),d=re(),x=T(!1),c=async()=>{if(!_.value)return Ae("请输入消息内容");let y=await Je({robot_key:A.value.robot_key,openid:A.value.openid,question:_.value,form_ids:A.value.form_ids,dialogue_id:P.value});if(y.data&&y.data.words)return je.error(`提交的内容包含敏感词：[${y.data.words.join(";")}] 请修改后再提交`);p=!0,B({message:_.value,global:JSON.stringify(k)}),_.value=""},$=async()=>{p=!0,_.value="";let y=d.query||{},M=n.user_id,Y={robot_key:y.robot_key,avatar:y.avatar,name:y.name,nickname:y.nickname,is_background:1,openid:M,dialogue_id:0};le(),await I(Y)},F=async y=>{if(P.value==y.dialogue_id)return;p=!0;let Y={robot_key:(d.query||{}).robot_key,avatar:y.avatar,name:y.name,nickname:y.nickname,is_background:y.is_background,openid:y.openid,dialogue_id:y.id};le(),await z(Y),await H()&&Z()},J=y=>{p=!0,B({message:y})};T(!1);const l=()=>{Z()},r=async()=>{p=!1;let y=h.value[0].uid;await H()&&ye(y)},N=()=>{},Z=()=>{i.value&&p&&i.value.scrollToBottom()},ye=y=>{i.value&&i.value.scrollToMessage(y)},le=()=>{i.value&&i.value.resetScroll()},be=()=>{Q()},ae=T(null),ke=y=>{ae.value.open(y)},ie=T(null),we=(y,M)=>{ie.value.open(y,M)};return de(()=>h.value,()=>{}),Me(async()=>{$(),Q(),await f(k.id),x.value=!0,w.on("updateAiMessage",l)}),Ie(()=>{W(),w.off("updateAiMessage",l)}),(y,M)=>{const Y=Ee("router-link"),te=Ne,$e=Pe,qe=Fe;return t(),s("div",po,[e("div",mo,[e("div",go,[a($e,null,{default:v(()=>[a(te,null,{default:v(()=>[a(Y,{to:"/robot/list"},{default:v(()=>M[1]||(M[1]=[E("机器人管理")])),_:1,__:[1]})]),_:1}),a(te,null,{default:v(()=>[E(m(C(A).robot_name),1)]),_:1})]),_:1})])]),e("div",vo,[e("div",fo,[e("div",ho,[a(qe,{type:"primary",block:"",ghost:"",onClick:$},{default:v(()=>[a(C(Ue)),M[2]||(M[2]=E(" 新建对话"))]),_:1,__:[2]})]),e("div",yo,[a(ps,{list:C(D),active:C(P),onOpenChat:F,onOnScrollEnd:be},null,8,["list","active"])]),M[3]||(M[3]=e("div",{class:"page-left-footer"},null,-1))]),e("div",bo,[e("div",ko,[a(rs,{ref_key:"messageListRef",ref:i,messages:C(h),robotInfo:C(S),onClickMsgMeun:J,onScrollStart:r,onScrollEnd:N,onOpenPromptLog:ke,onOpenLibrary:we},null,8,["messages","robotInfo"])]),e("div",wo,[a(ys,{value:_.value,"onUpdate:value":M[0]||(M[0]=Ce=>_.value=Ce),onSend:c,loading:C(b)},null,8,["value","loading"])])]),e("div",null,[g("",!0)])]),a(Us,{ref_key:"promptLogAlertRef",ref:ae},null,512),a(_o,{ref_key:"libraryInfoAlertRef",ref:ie},null,512)])}}},No=j($o,[["__scopeId","data-v-7257bb7b"]]);export{No as default};
