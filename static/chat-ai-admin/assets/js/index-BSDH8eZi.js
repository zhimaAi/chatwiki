import{_ as G,bT as Z,d as Y,N as me,B as fe,bX as ee,c as be,bY as ye,bZ as ge,bP as he,at as ke,aW as xe}from"../../index-C5-B0r5-.js";import{r as T,e as W,f as x,w as we,o as H,ac as b,as as s,k as a,ar as o,ae as R,az as P,G as k,F as q,ax as ae,u as N,ad as u,at as U,c as te,aA as Se,ai as Ce,n as Le,A as $e,y as De,B as K,aw as Ue,J as Ie,p as Q}from"./vue-chunks-CGLjTDrY.js";import{C as Be}from"./config-page-menu-oNzMZoMR.js";import{u as Oe}from"./index-DqhUrknF.js";import{e as se,w as oe,x as le,ao as Re,y as Pe,I as ze,B as ne,F as re,b as z,z as Me,a1 as ie,M as Ae,a6 as Fe,k as je,D as Ne,h as Te,i as Ee,bG as Ve,aN as qe,G as Ge}from"./ui-antd-B11sc9DP.js";import{B as V,P as We,S as Ye,M as He}from"./pull-up.esm-DIiTC7VE.js";import{d as ce}from"./role_avatar-DL0r08JY.js";import"./neo4j-Bk0ySkcX.js";import"./utils-BH-4gQMj.js";import"./other-BrZCAsTs.js";const Je={class:"form-box"},Xe={class:"form-box-header"},Ze={class:"form-box-label"},Ke={class:"share-url-box"},Qe={__name:"permissions-form",props:{value:{type:Object,default:()=>({})},saveLoading:{type:Boolean,default:!1}},emits:["submit","update:value"],setup(M,{emit:I}){const{toClipboard:L}=Oe(),$=I,m=M,l=T({access_rights:"0",share_url:void 0,library_key:""}),p=W(()=>l.share_url+Z+"/home/"+l.library_key),y=()=>{$("submit",l)},f=x([]),t=()=>{me().then(_=>{f.value=_.data||[],l.share_url||f.value.length>0&&(l.share_url=f.value[0].url)})},D=_=>{l.access_rights=_.access_rights,l.share_url=_.share_url,l.library_key=_.library_key,(f.value.length==0||!l.share_url)&&t()},B=async()=>{if(!l.share_url){z.error("请选择自定义域名");return}let _=p.value;try{await L(_),z.success("复制成功")}catch{z.error("复制失败")}};return we(m.value,_=>{D({..._})}),H(()=>{t()}),(_,r)=>{const g=Y,C=le,i=oe,e=se,h=Me,d=Pe,A=ze,O=Re,F=ne,j=re;return u(),b("div",Je,[s("div",Xe,[s("div",Ze,[a(g,{name:"auth",style:{"font-size":"14px",color:"#333"}}),r[2]||(r[2]=s("span",{class:"form-box-label-text"},"访问权限",-1))]),r[3]||(r[3]=s("div",null,null,-1))]),a(j,{"label-col":{span:4},style:{width:"750px"}},{default:o(()=>[a(e,{label:"访问权限"},{default:o(()=>[a(i,{value:l.access_rights,"onUpdate:value":r[0]||(r[0]=w=>l.access_rights=w),onChange:y},{default:o(()=>[a(C,{value:"0"},{default:o(()=>[...r[4]||(r[4]=[k("私有，仅能与应用关联，作为应用知识库",-1)])]),_:1}),a(C,{value:"1"},{default:o(()=>[...r[5]||(r[5]=[k("公开，发布到互联网，所有人可访问",-1)])]),_:1})]),_:1},8,["value"])]),_:1}),l.access_rights==1?(u(),R(e,{key:0,label:"复制链接"},{default:o(()=>[s("div",Ke,[a(O,{compact:"",style:{width:"600px",display:"flex"}},{default:o(()=>[a(d,{style:{width:"250px"},value:l.share_url,"onUpdate:value":r[1]||(r[1]=w=>l.share_url=w),placeholder:"请选择自定义域名",onChange:y},{default:o(()=>[(u(!0),b(q,null,ae(f.value,w=>(u(),R(h,{value:w.url,key:w.id},{default:o(()=>[k(U(w.url),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"]),a(A,{disabled:!0,value:N(Z)+"/home/"+l.library_key,style:{width:"350px"}},null,8,["value"])]),_:1}),a(F,{class:"copy-btn",onClick:B},{default:o(()=>[...r[6]||(r[6]=[k("复制",-1)])]),_:1})]),r[7]||(r[7]=s("div",null,[s("a",{href:"/#/user/domain"},"添加自定义域名")],-1))]),_:1})):P("",!0)]),_:1})])}}},ea=G(Qe,[["__scopeId","data-v-8b2b2729"]]),aa={class:"form-box"},ta={class:"collaborator-list-tip"},sa={class:"list-content"},oa={class:"collaborator-grid"},la=["onClick"],na={class:"user-info"},ra={class:"user-details"},ia={class:"user-name"},ca={class:"user-nickname"},ua={key:0,class:"loading-more"},_a={key:1,class:"no-more"},da={__name:"add-collaborator",props:{excludedIds:{type:Array,default:()=>[]}},emits:["ok"],setup(M,{expose:I,emit:L}){V.use(We),V.use(Ye),V.use(He);const $=L,m=M,l=te("libraryState",{}),p=x(!1),y=x(null),f=x(!1),t=T({permission:"2",collaborators:[]}),D={permission:[{required:!0,message:"请选择协作权限"}],collaborators:[{required:!0,message:"请选择协作者",type:"array",min:1}]},B=c=>{let n=t.collaborators.indexOf(c.id);n>-1?t.collaborators.splice(n,1):t.collaborators.push(c.id)},_=x([]),r=W(()=>_.value.filter(c=>!m.excludedIds.includes(c.id))),g=T({page:1,size:20,total:0,search:""}),C=x(null),i=x(!1),e=x(!1);let h=x(null);const d=()=>{if(h.value){h.value.refresh();return}h.value=new V(C.value,{probeType:2,click:!0,scrollY:!0,bounce:!1,pullUpLoad:!0,scrollbar:{fade:!1,interactive:!0},mouseWheel:{speed:20,invert:!1,easeTime:300}}),h.value.on("pullingUp",A)},A=async()=>{i.value||e.value||(g.page=g.page+1,i.value=!0,await O(),h.value.finishPullUp(),i.value=!1)},O=async()=>{let c={page:g.page,size:g.size,search:g.search};return fe(c).then(n=>{let v=n.data.list||[];return g.page==1?_.value=_.value=v:_.value=_.value.concat(v),g.total=+n.data.total,_.value.length>=g.total&&(e.value=!0),De(()=>{h.value&&h.value.refresh()}),n})},F=()=>{let c={operate_rights:t.permission,user_ids:t.collaborators.join(","),type:1,library_key:l.library_key};f.value=!0,ee(c).then(()=>{p.value=!1,f.value=!1,$("ok",c),z.success("添加成功")}).catch(()=>{f.value=!1})},j=async()=>{var c;try{await((c=y.value)==null?void 0:c.validate()),F()}catch(n){console.error("表单验证失败:",n)}},w=()=>{var c;(c=y.value)==null||c.resetFields(),p.value=!1};return I({open:()=>{var c;p.value=!0,(c=y.value)==null||c.resetFields(),g.page=1,O(),setTimeout(()=>{d()},200)}}),(c,n)=>{const v=le,E=oe,X=se,ue=Se("RouterLink"),_e=Y,de=ie,pe=re,ve=Ae;return u(),R(ve,{open:p.value,"onUpdate:open":n[1]||(n[1]=S=>p.value=S),title:"添加协作者",width:"760px",confirmLoading:f.value,onOk:j,onCancel:w},{default:o(()=>[s("div",aa,[a(pe,{layout:"vertical",model:t,rules:D,ref_key:"formRef",ref:y},{default:o(()=>[a(X,{name:"permission",label:"协作权限"},{default:o(()=>[a(E,{value:t.permission,"onUpdate:value":n[0]||(n[0]=S=>t.permission=S)},{default:o(()=>[a(v,{value:"4"},{default:o(()=>[...n[2]||(n[2]=[k("可管理",-1)])]),_:1}),a(v,{value:"2"},{default:o(()=>[...n[3]||(n[3]=[k("可编辑",-1)])]),_:1})]),_:1},8,["value"])]),_:1}),a(X,{name:"collaborators",label:"协作者"},{default:o(()=>[s("div",ta,[n[5]||(n[5]=k(" 如果协作者没有账号，请先到团队管理中添加账号 ",-1)),a(ue,{to:"/user/manage",target:"_blank"},{default:o(()=>[...n[4]||(n[4]=[k("去添加",-1)])]),_:1})]),s("div",{class:"collaborator-list",ref_key:"listRef",ref:C},[s("div",sa,[s("div",oa,[(u(!0),b(q,null,ae(r.value,S=>(u(),b("div",{class:Ce(["collaborator-item",{active:t.collaborators.includes(S.id)}]),key:S.id,onClick:Pa=>B(S)},[Le(a(_e,{name:"check-arrow-filled",class:"check-icon"},null,512),[[$e,t.collaborators.includes(S.id)]]),s("div",na,[a(de,{class:"user-avatar",src:S.avatar||N(ce)},null,8,["src"]),s("div",ra,[s("div",ia,U(S.user_name),1),s("div",ca,U(S.nick_name),1)])])],10,la))),128))]),i.value?(u(),b("div",ua,"加载中...")):P("",!0),e.value?(u(),b("div",_a,"没有更多了")):P("",!0)])],512)]),_:1})]),_:1},8,["model"])])]),_:1},8,["open","confirmLoading"])}}},pa=G(da,[["__scopeId","data-v-63eab63e"]]),va={class:"collaborator-list-box"},ma={class:"list-tools-box"},fa={class:"list-label"},ba={class:"label-text"},ya={class:"tools-box-right"},ga={class:"list-box"},ha={key:0,class:"name-cell"},ka={class:"user-info"},xa={class:"username"},wa={class:"nickname"},Sa={key:0,class:"role-cell"},Ca={key:1,class:"role-cell"},La={key:1},$a={__name:"collaborator-list",setup(M){const I=be(),L=te("libraryState",{}),$=x(null),m=[{title:"姓名",key:"name",width:"40%"},{title:"角色",dataIndex:"role",key:"role",width:"40%"},{title:"操作",key:"action",width:"20%"}],l={4:{label:"可管理",value:"4"},2:{label:"可编辑",value:"2"}},p=T({current:1,pageSize:999,total:0}),y=x([]),f=W(()=>y.value.map(i=>i.user_id)),t=(i,e)=>{e.operate_rights=i.key*1,e.operate_rights_label=l[e.operate_rights].label||"",D(e)},D=i=>{let e={operate_rights:i.operate_rights,user_ids:i.user_id,type:2,library_key:L.library_key};ee(e).then(()=>{z.success("修改成功")}).catch(()=>{})},B=()=>{$.value.open()},_=i=>{let e={id:i.id,library_key:L.library_key};ge(e).then(()=>{z.success("移除成功"),C()}).catch(()=>{})},r=()=>{C()},g=i=>{Object.assign(p,i),C()},C=()=>{ye({library_key:L.library_key,page:p.current,size:p.pageSize}).then(i=>{let e=i.data.list||[],{user_id:h}=I.userInfo;p.total=i.data.total,e.forEach(d=>{d.showDelete=!0,h==d.user_id&&(d.showDelete=!1),d.role_type==1&&(d.showDelete=!1),d.operate_rights=d.operate_rights*1,d.operate_rights_label="无权限",l[d.operate_rights]&&(d.operate_rights_label=l[d.operate_rights].label)}),y.value=e})};return H(()=>{C()}),(i,e)=>{const h=Y,d=ne,A=ie,O=Ee,F=Te,j=je,w=qe,J=Ve,c=Ge;return u(),b("div",va,[s("div",ma,[s("div",fa,[a(h,{name:"collaborator"}),s("span",ba,"协助权限 ("+U(p.total)+")",1)]),s("div",ya,[a(d,{type:"primary",size:"small",onClick:B},{default:o(()=>[a(N(Fe)),e[2]||(e[2]=k(" 添加协助者",-1))]),_:1})])]),s("div",ga,[a(c,{columns:m,"data-source":y.value,pagination:p,onChange:g},{bodyCell:o(({column:n,record:v})=>[n.key==="name"?(u(),b("div",ha,[a(A,{class:"avatar",src:v.avatar||N(ce)},null,8,["src"]),s("div",ka,[s("div",xa,U(v.user_name),1),s("div",wa,U(v.nick_name),1)])])):P("",!0),n.key==="role"?(u(),b(q,{key:1},[v.showDelete?(u(),b("div",Sa,[a(j,null,{overlay:o(()=>[a(F,{onClick:E=>t(E,v)},{default:o(()=>[(u(),R(O,{key:4},{default:o(()=>[...e[3]||(e[3]=[k("可管理",-1)])]),_:1})),(u(),R(O,{key:2},{default:o(()=>[...e[4]||(e[4]=[k("可编辑",-1)])]),_:1}))]),_:1},8,["onClick"])]),default:o(()=>[s("a",{class:"dropdown-label",onClick:e[0]||(e[0]=K(()=>{},["prevent"]))},[k(U(v.operate_rights_label)+" ",1),a(N(Ne),{style:{"font-size":"12px"}})])]),_:2},1024)])):(u(),b("div",Ca,[s("a",{class:"dropdown-label disabled",onClick:e[1]||(e[1]=K(()=>{},["prevent"]))},U(v.operate_rights_label),1)]))],64)):P("",!0),n.key==="action"?(u(),b(q,{key:2},[v.showDelete?(u(),R(J,{key:0},{default:o(()=>[a(w,{title:"确定要移除此协作者吗?","ok-text":"确定","cancel-text":"取消",onConfirm:E=>_(v)},{default:o(()=>[...e[5]||(e[5]=[s("a",{href:"#"},"移除",-1)])]),_:1},8,["onConfirm"])]),_:2},1024)):(u(),b("span",La,[a(d,{style:{padding:"0"},type:"link",disabled:""},{default:o(()=>[...e[6]||(e[6]=[k("移除",-1)])]),_:1})]))],64)):P("",!0)]),_:1},8,["data-source","pagination"])]),a(pa,{excludedIds:f.value,ref_key:"addCollaboratorRef",ref:$,onOk:r},null,8,["excludedIds"])])}}},Da=G($a,[["__scopeId","data-v-36368ac1"]]),Ua={class:"permissions-page"},Ia={class:"page-container"},Ba={class:"form-box-wrapper"},Oa={class:"collaborator-list-wrapper"},Ra={__name:"index",setup(M){const I=he(),L=Ue(),$=W(()=>L.query.library_id),m=T({type:1,library_intro:"",library_name:"",model_config_id:"",model_define:"",use_model:"",is_offline:!1,access_rights:"0",share_url:"",library_key:"",avatar:"",avatar_file:""});Q("libraryState",m),Q("updateState",t=>{Object.assign(m,t)});const l=x(!1),p=t=>{Object.assign(m,t),l.value=!0,y().then(()=>{l.value=!1}).catch(()=>{l.value=!1})},y=async()=>{let t={...Ie(m)};delete t.library_key,t.avatar_file?(t.avatar=t.avatar_file,delete t.avatar_file):(delete t.avatar,delete t.avatar_file),await xe(t),I.getLibraryInfo(),z.success("修改成功")},f=()=>{ke({id:$.value}).then(t=>{Object.assign(m,t.data)})};return H(()=>{f()}),(t,D)=>(u(),b("div",Ua,[a(Be),s("div",Ia,[s("div",Ba,[a(ea,{value:m,"onUpdate:value":D[0]||(D[0]=B=>m=B),saveLoading:l.value,onSubmit:p},null,8,["value","saveLoading"])]),s("div",Oa,[m.library_key?(u(),R(Da,{key:0})):P("",!0)])])]))}},Ga=G(Ra,[["__scopeId","data-v-1390e73c"]]);export{Ga as default};
