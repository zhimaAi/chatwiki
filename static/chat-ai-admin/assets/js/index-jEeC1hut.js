import{b as N,be as ue,aa as _e,bJ as pe,d8 as he,bw as fe,d as W,bh as me,d9 as ve}from"../../index-CuFzRDH0.js";import{Z as ge,f as ye,a as we,P as ke,H as be,C as $e,b as U}from"./cu-scroll-DrKGulQh.js";import{e as k,B as L,x as X,M as r,N as d,W as e,k as p,a1 as Y,a2 as j,w as xe,G as Fe,ao as Ce,ap as Ie,u as O,a7 as I,a6 as se,z as K,a5 as Se,b as Be,Q as V,S as R,Z as B,X as Le,F as A,$ as J,Y as Q,q as Me}from"./vue-chunks-DkYK5AuX.js";import{S as De}from"./SearchOutlined-2-sBVYkv.js";import{C as Oe}from"./CaretDownFilled-P6q1_Q4R.js";import{S as oe}from"./index-YK7vZYdC.js";import{C as te}from"./CaretRightOutlined-Dcix02qs.js";import{R as ze}from"./RightOutlined-C7Gymx4e.js";import"./axios-Cm0UX6qg.js";import"./qs-g-qVsYXK.js";import"./crypto-js-CsNcoEfj.js";import"./dayjs-CHX5mXCJ.js";import"./pull-up.esm-JZ91zQ8P.js";import"./observe-dom.esm-DPKTicVt.js";const Ne=h=>(Y("data-v-20d52d07"),h=h(),j(),h),Te={class:"chart-wrapper"},Ee=Ne(()=>e("div",{class:"chart-mini-map",id:"chatMap"},null,-1)),Ze={class:"zoom-toolbar-wrapper"},Re={__name:"chart-box",emits:["nodeClick"],setup(h,{expose:F,emit:b}){const u=b,a=k(null);let n=null;const l=L({nodes:[],edges:[]}),f=k(1),g=()=>{n&&n.destroy();const _={layout:"forceDirected",initialZoom:f.value,disableTelemetry:!0,maxZoom:10,minZoom:.1,minimapContainer:document.getElementById("chatMap"),styling:{minimapViewportBoxColor:"#4399FF",selectedBorderColor:"rgba(255, 255, 255, 1)"}},m=document.getElementById("chartBox");n=new ye(m,l.nodes,l.edges,_);const i=new we(n);new ke(n),i.updateCallback("onZoom",w=>{f.value=Number(w.toFixed(1))}),new be(n,{drawShadowOnHover:!0}),new $e(n,{selectOnClick:!0}).updateCallback("onNodeClick",w=>{u("nodeClick",w)})},C=_=>{f.value=_,n&&n.setZoom(_)},o=({nodes:_,edges:m})=>{l.nodes=[l.nodes,..._],l.edges=[l.edges,...m],n&&n.addElementsToGraph(_,m)},y=({nodes:_,edges:m})=>{l.nodes=[l.nodes,..._],l.edges=[l.edges,...m],n&&n.addAndUpdateElementsInGraph(_,m)},S=({nodes:_,edges:m})=>{l.nodes=_,l.edges=m,n&&n.updateElementsInGraph(_,m)},z=({nodes:_,edges:m})=>{l.nodes=_,l.edges=m,g()};return X(()=>{}),F({render:z,add:o,addAndUpdate:y,update:S}),(_,m)=>(r(),d("div",Te,[e("div",{class:"chart",id:"chartBox",ref_key:"chartBox",ref:a},null,512),Ee,e("div",Ze,[p(ge,{value:f.value,onChange:C},null,8,["value"])])]))}},Ve=N(Re,[["__scopeId","data-v-20d52d07"]]),He={class:"search-action-box"},Ge={__name:"search-input",props:{value:{type:String,default:""}},emits:["search","clear","input","update:value"],setup(h,{emit:F}){const b=F,u=h,a=k(u.value),n=k(!1),l=k(null),f=()=>{b("update:value",a.value)},g=()=>{a.value="",K(()=>{var o;(o=l.value)==null||o.focus()}),f(),C()},C=()=>{b("search",a.value)};return xe(()=>u.value,o=>{a.value!==o&&(a.value=o)}),(o,y)=>(r(),d("div",{class:se(["search-input-box",{focused:n.value}])},[Fe(e("input",{ref_key:"searchInput",ref:l,class:"search-input","onUpdate:modelValue":y[0]||(y[0]=S=>a.value=S),placeholder:"输入关键词搜索",type:"text",onKeyup:Ie(C,["enter"]),onFocus:y[1]||(y[1]=S=>n.value=!0),onBlur:y[2]||(y[2]=S=>n.value=!1),onInput:f},null,544),[[Ce,a.value]]),e("div",He,[h.value.length>0?(r(),d("span",{key:0,class:"action-btn",onClick:g},[p(O(ue),{class:"clear-icon"})])):I("",!0),e("span",{class:"action-btn",onClick:C},[p(O(De),{class:"search-icon"})])])],2))}},Ue=N(Ge,[["__scopeId","data-v-91276234"]]),ae=h=>(Y("data-v-d6938488"),h=h(),j(),h),Ae={key:0,class:"file-list-wrapper"},Ke={class:"open-file-box"},Pe={key:0,class:"file-item active"},qe={class:"file-info"},Je=["onMouseenter","onClick"],Qe={class:"doc-content"},We={key:0,class:"loading-box"},Xe=ae(()=>e("span",{class:"loading-text"},"加载中...",-1)),Ye={class:"file-list-box"},je={class:"file-items"},et={key:0,class:"file-item"},tt=["onClick"],st={class:"file-name"},ot={key:0,class:"loading-box"},at=ae(()=>e("span",{class:"loading-text"},"加载中...",-1)),nt={class:"fragment-title"},lt={class:"fragment-details-body"},it={class:"fragment-content"},ct={__name:"file-list",props:{show:{type:Boolean,default:!1}},emits:["openFile","openFragment"],setup(h,{expose:F,emit:b}){const{getStorage:u,removeStorage:a}=_e("localStorage"),n=b,l=h,f=Se(),g=u("graph:autoOpenFileId")||null,C=Be(()=>f.query.id),o=L({list:[],library_id:C.value,status:2,page:1,size:20,total:0,showMore:!0}),y=async()=>{try{const c=await pe({library_id:o.library_id,status:o.status,page:o.page,size:o.size});if(c.res!=0)return;let $=c.data.list||[];o.total=c.data.total,g&&($=$.filter(D=>D.id!=g)),o.list=[...o.list,...$],o.list.length>=o.total&&(o.showMore=!1),o.page==1&&o.list.length>0&&M(o.list[0])}catch(c){o.showMore=!1}},S=()=>{o.list.length>=o.total||(o.page++,y())},z=k(null),_=k(null),m=k(0),i=L({show:!1,file_name:"",id:""}),s=L({show:!0,page:1,size:20,total:0,list:[],showMore:!0}),w=k(null),v=L({show:!1,title:"",content:""}),M=async c=>{if(c.id==i.id){w.value=null,n("openFile",c);return}i.show=!0,i.file_name=c.file_name,i.id=c.id,w.value=null,s.page=1,s.total=0,s.list=[],s.show=!0,s.showMore=!0,await E(),n("openFile",c)},G=()=>{s.show=!1},T=()=>{s.show=!0},t=k(300),E=async()=>{const c=await he({file_id:i.id,page:s.page,size:s.size,status:-1,graph_status:-1,category_id:-1});c.res==0&&(s.total=c.data.total,s.page==1?s.list=c.data.list||[]:s.list=[...s.list,...c.data.list],s.list.length>=s.total&&(s.showMore=!1),K(()=>{var D;let $=((D=_.value)==null?void 0:D.offsetHeight)||0;$>t.value?m.value=t.value:m.value=$,K(()=>{var Z;(Z=z.value)==null||Z.refresh()})}))},P=()=>{s.list.length>=s.total||(s.page++,E())},ne=c=>{w.value=c.id,n("openFragment",c)},le=c=>{clearTimeout(q),v.title=c.title,v.content=c.content,v.show=!0};let q=null;const ie=()=>{q=setTimeout(()=>{v.show=!1},200)},ce=()=>{clearTimeout(q)},re=()=>{v.show=!1},de=async()=>{try{const c=await fe({id:g});o.list.push(c.data)}catch(c){}};return X(async()=>{g&&(await de(),a("graph:autoOpenFileId")),y()}),F({openFile:M}),(c,$)=>{const D=W,Z=oe;return r(),V(Me,{name:"slide-fade"},{default:R(()=>[l.show?(r(),d("div",Ae,[e("div",Ke,[i.show?(r(),d("div",Pe,[e("div",qe,[s.show?(r(),V(O(Oe),{key:0,class:"caret-icon",onClick:$[0]||($[0]=x=>G())})):(r(),V(O(te),{key:1,class:"caret-icon",onClick:$[1]||($[1]=x=>T())})),p(D,{class:"file-icon",name:"doc-file",style:{}}),e("span",{class:"file-name",onClick:$[2]||($[2]=x=>M(i))},B(i.file_name),1)]),s.show?(r(),d("div",{key:0,class:"document-fragments",style:Le({maxHeight:t.value+"px",height:m.value>0?m.value+"px":"auto"})},[p(U,{ref_key:"fragmentsScrollView",ref:z,"group-id":"a",onOnScrollEnd:P},{default:R(()=>[e("div",{class:"fragment-list",ref_key:"fragmentListRef",ref:_},[(r(!0),d(A,null,J(s.list,x=>(r(),d("div",{class:se(["fragment-item",{active:w.value==x.id}]),onMouseenter:ee=>le(x),onMouseleave:ie,onClick:ee=>ne(x),key:x.id},[e("div",Qe,B(x.content),1)],42,Je))),128))],512),s.list.length<s.total?(r(),d("div",We,[p(Z,{size:"small"}),Q(),Xe])):I("",!0)]),_:1},512)],4)):I("",!0)])):I("",!0)]),e("div",Ye,[p(U,{"group-id":"a",onOnScrollEnd:S},{default:R(()=>[e("div",je,[(r(!0),d(A,null,J(o.list,x=>(r(),d(A,{key:x.id},[x.id!=i.id?(r(),d("div",et,[e("div",{class:"file-info",onClick:ee=>M(x)},[p(O(te),{class:"caret-icon"}),p(D,{class:"file-icon",name:"doc-file",style:{}}),e("span",st,B(x.file_name),1)],8,tt)])):I("",!0)],64))),128)),o.showMore?(r(),d("div",ot,[p(Z,{size:"small"}),Q(),at])):I("",!0)])]),_:1})]),v.show?(r(),d("div",{key:0,class:"fragment-details",onMouseenter:ce,onMouseleave:re},[e("div",nt,B(v.title||"无标题片段"),1),e("div",lt,[p(U,null,{default:R(()=>[e("div",it,B(v.content),1)]),_:1})])],32)):I("",!0)])):I("",!0)]),_:1})}}},rt=N(ct,[["__scopeId","data-v-d6938488"]]),H=h=>(Y("data-v-449a5d4c"),h=h(),j(),h),dt={key:0,class:"popup-wrapper entity-details-wrapper"},ut={class:"popup-header"},_t=H(()=>e("div",{class:"popup-title"},"实体详情",-1)),pt={key:0,class:"popup-body"},ht={class:"popup-content"},ft={class:"entity-details"},mt={class:"entity-item"},vt=H(()=>e("div",{class:"entity-item-header"},[e("div",{class:"entity-item-label"},"实体")],-1)),gt={class:"entity-name"},yt={class:"entity-item",style:{"margin-bottom":"8px"}},wt=H(()=>e("div",{class:"entity-item-header"},[e("div",{class:"entity-item-label"},"归属文档")],-1)),kt={class:"file-info"},bt={class:"file-name"},$t={class:"entity-item"},xt={class:"entity-item-header"},Ft=H(()=>e("div",{class:"entity-item-label"},"分段",-1)),Ct={class:"doc-item"},It={class:"fragment-content"},St={class:"entity-item"},Bt=H(()=>e("div",{class:"entity-item-header"},[e("div",{class:"entity-item-label"},"子图")],-1)),Lt={key:0,class:""},Mt={class:"fragment-content"},Dt={__name:"entity-details",emits:["toDetails"],setup(h,{expose:F,emit:b}){const u=b,a=L({show:!1,node:null,fromNodes:[]}),n=()=>{a.show=!1},l=(g,C)=>{a.node=g,a.fromNodes=C,a.show?(a.show=!1,K(()=>{a.show=!0})):a.show=!0},f=()=>{u("toDetails",a.node)};return F({open:l,close:n}),(g,C)=>{const o=W;return a.show?(r(),d("div",dt,[e("div",ut,[_t,p(O(me),{class:"close-btn",onClick:n})]),a.node?(r(),d("div",pt,[p(U,null,{default:R(()=>[e("div",ht,[e("div",ft,[e("div",mt,[vt,e("div",gt,B(a.node.name),1)]),e("div",yt,[wt,e("div",kt,[p(o,{class:"file-icon",name:"doc-file",style:{}}),e("span",bt,B(a.node.file_name),1)])]),e("div",$t,[e("div",xt,[Ft,e("span",{class:"to-details",onClick:f},[Q("详情  "),p(O(ze),{class:"right-icon"})])]),e("div",null,[e("div",Ct,[e("div",It,B(a.node.content),1)])])]),e("div",St,[Bt,e("div",null,[a.fromNodes.length==0?(r(),d("div",Lt,"无")):I("",!0),(r(!0),d(A,null,J(a.fromNodes,y=>(r(),d("div",{class:"subgraph-item",key:y.id},[e("div",Mt,B(y.name),1)]))),128))])])])])]),_:1})])):I("",!0)])):I("",!0)}}},Ot=N(Dt,[["__scopeId","data-v-449a5d4c"]]),zt={class:"collapse-icon"},Nt={class:"collapse-label"},Tt={__name:"collapse-btn",emits:["change"],setup(h,{emit:F}){const b=F,u=k(!0),a=()=>{u.value=!u.value,b("change",u.value)};return(n,l)=>{const f=W;return r(),d("div",{class:"collapse-btn",onClick:a},[e("span",zt,[u.value?(r(),V(f,{key:0,name:"collapse-close"})):(r(),V(f,{key:1,name:"collapse-open"}))]),e("span",Nt,B(u.value?"收起":"展开"),1)])}}},Et=N(Tt,[["__scopeId","data-v-ab8552b8"]]),Zt={class:"knowledge-graph-page"},Rt={key:0,class:"loading-wrapper"},Vt={class:"search-box"},Ht={class:"left-box"},Gt={class:"right-box"},Ut={__name:"index",setup(h){const F=k(null),b=k(null),u=k(!1),a=k(""),n=k(!0),l=L({file_id:"",data_id:"",search_term:""}),f=L({edges:[],nodes:[]});let g={};const C=i=>{n.value=i},o=i=>{l.file_id=i.id,l.data_id="",S()},y=i=>{l.data_id=i.id,S()},S=()=>{u.value=!0,ve({file_id:l.file_id,data_id:l.data_id,search_term:l.search_term}).then(i=>{u.value=!1;let s=i.data.edges||[],w=i.data.nodes||[];const v=new Map;s=s.filter(t=>{const E=`${t.from_id}_${t.to_id}`,P=`${t.to_id}_${t.from_id}`;return v.has(E)||v.has(P)?!1:(v.set(E,!0),!0)}),s.forEach(t=>{t.id=t.id.toString(),t.from=t.from_id.toString(),t.to=t.to_id.toString(),t.caption=t.label});const M=new Set(s.map(t=>t.from)),G=new Set(s.map(t=>t.to));w.forEach(t=>{t.id=t.id.toString(),t.nodeType=M.has(t.id)&&G.has(t.id)?"both":M.has(t.id)?"from":G.has(t.id)?"to":"normal",t.nodeType==="from"?(t.size=35,t.color="#FFB1B2"):t.nodeType==="to"?(t.size=45,t.color="#005AFF"):(t.size=30,t.color="#69E9BE"),t.captions=[{value:t.name,styles:[]}]});let T={edges:s,nodes:w};f.edges=T.edges,f.nodes=T.nodes,setTimeout(()=>{F.value.render(T)},0),g={},s.forEach(t=>{g[t.to]||(g[t.to]=[]),g[t.to].push(t.from)})}).catch(i=>{u.value=!1})},z=i=>{let s=g[i.id]||[],w=[];for(let v=0;v<f.nodes.length;v++)s.indexOf(f.nodes[v].id)>-1&&w.push(f.nodes[v]);b.value.open(i,w)},_=i=>{l.search_term=i,S()},m=i=>{window.open(`/#/library/preview?id=${i.file_id}`)};return X(()=>{}),(i,s)=>{const w=oe;return r(),d("div",Zt,[u.value?(r(),d("div",Rt,[p(w,{spinning:u.value},null,8,["spinning"])])):I("",!0),p(Ve,{ref_key:"chartBoxRef",ref:F,loading:u.value,onNodeClick:z},null,8,["loading"]),p(Et,{onChange:C}),e("div",Vt,[p(Ue,{value:a.value,"onUpdate:value":s[0]||(s[0]=v=>a.value=v),onSearch:_},null,8,["value"])]),e("div",Ht,[p(rt,{onOpenFile:o,onOpenFragment:y,show:n.value},null,8,["show"])]),e("div",Gt,[p(Ot,{ref_key:"entityDetailsRef",ref:b,onToDetails:m},null,512)])])}}},as=N(Ut,[["__scopeId","data-v-63b30116"]]);export{as as default};
