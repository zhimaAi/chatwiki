import{b as G,d as ae,a$ as Fe,ak as ke,h as Re,b9 as Ae}from"../../index-ZzVqUZIR.js";import{Y as s,_ as t,a5 as e,ae as g,ad as J,F as I,a9 as B,a7 as m,e as se,f as A,a1 as z,n as ne,k as u,a2 as q,B as Ee,G as P,u as M,A as Oe,y as me,J as _e,q as be,w as we,a6 as Be,b as $e,I as De,r as Pe,aa as He,ab as he,ag as Ue,o as je,af as Ne}from"./vue-chunks-yZ4gwLzA.js";import{u as ze}from"./useEventBus-DbXWCKa0.js";import{u as xe}from"./chat-B8UgOh4q.js";import{_ as pe}from"./index-CTzlnj_K.js";import{M as Ve}from"./multiple-message-Du9Eel5L.js";import{ah as qe,a1 as ye,am as Je,p as Ce,au as ge,a as le,W as Qe,ad as te,aw as Se,M as Ke,i as We,B as Ge,j as Ye,a2 as Xe}from"./ui-antd-BJtyvQX6.js";import{_ as Le}from"./cu-scroll-CeyRYmkN.js";import{u as Ze}from"./index-BfMA38Vj.js";import{h as et}from"./index-WejToLyd.js";import{V as tt}from"./vue3-pdf-embed-Bz3m5Jm3.js";import{a1 as st}from"./index-BT8AeJHF.js";import{u as ot}from"./robot-No_anTgb.js";import"./utils-smNh_pj2.js";import"./useIM-pdql3nFx.js";import"./pull-up.esm-DIiTC7VE.js";import"./observe-dom.esm-B25JyVKH.js";import"./vue-pdf-embed-NLNtCWar.js";const nt={class:"guess-you-want"},lt={class:"message-tabs"},it={key:1,class:"v-line"},at={key:0,class:"message-menus"},rt=["onClick"],ct={key:1,class:"message-menus"},ut=["onClick"],dt={__name:"guess-you-want",props:{item:{type:Object,default:()=>{}},common_question_list:{type:Object,default:()=>[]},enable_common_question:{type:Boolean,default:!1}},emits:["clickMeun"],setup(S,{emit:k}){const w=k,o=S,v=(p,i)=>{p.question_tabkey=i},y=p=>{w("clickMeun",p)};return(p,i)=>(t(),s("div",nt,[e("div",lt,[o.item.guess_you_want?(t(),s("div",{key:0,onClick:i[0]||(i[0]=l=>v(o.item,1)),class:J(["tab-item",{active:o.item.question_tabkey==1}])}," 猜你想问 ",2)):g("",!0),o.item.guess_you_want&&o.common_question_list&&o.enable_common_question?(t(),s("div",it)):g("",!0),o.common_question_list&&o.enable_common_question?(t(),s("div",{key:2,onClick:i[1]||(i[1]=l=>v(o.item,2)),class:J(["tab-item",{active:o.item.question_tabkey==2}])}," 常见问题 ",2)):g("",!0)]),o.item.question_tabkey==1?(t(),s("div",at,[(t(!0),s(I,null,B(o.item.guess_you_want,(l,_)=>(t(),s("div",{onClick:r=>y(l),class:"menu-item",key:_},m(l),9,rt))),128))])):(t(),s("div",ct,[(t(!0),s(I,null,B(S.common_question_list,(l,_)=>(t(),s("div",{onClick:r=>y(l),class:"menu-item",key:_},m(l),9,ut))),128))]))]))}},_t=G(dt,[["__scopeId","data-v-9c22a890"]]),pt={class:"text-message"},mt={__name:"text-message",props:{message:String},setup(S){return(k,w)=>(t(),s("div",pt,m(S.message),1))}},gt={class:"message-list-wrapper"},vt={class:"message-list"},ft=["id","data-msg_type"],ht={class:"itme-left"},yt=["src"],kt={class:"itme-right"},bt={class:"item-body"},wt={key:0,class:"message-content"},$t=["src"],xt={key:1,class:"message-content"},qt=["id"],Ct={class:"itme-left"},St=["src"],Lt={class:"itme-right"},Tt={key:0,class:"reply-list"},Mt={key:0,class:"reply-item reply-text"},It=["innerHTML"],Ft={key:1,class:"reply-item reply-image"},Rt={class:"message-content"},At=["src"],Et={key:2,class:"reply-item reply-url"},Ot={class:"url-row"},Bt=["href"],Dt={key:3,class:"reply-item reply-card"},Pt={class:"card-row"},Ht=["src"],Ut={class:"card-title-box"},jt={class:"card-title"},Nt={key:4,class:"reply-item reply-imageText"},zt=["href"],Vt=["src"],Jt={class:"imageText-text"},Qt={class:"imageText-title"},Kt={class:"imageText-desc"},Wt={key:5,class:"reply-item reply-smartMenu"},Gt={class:"smart-menu-box"},Yt={key:0,class:"card-title"},Xt={class:"card-text"},Zt={key:0,class:"line-text"},es={key:1,class:"empty-line"},ts=["innerHTML"],ss=["onClick"],os={key:0},ns={class:"label-flex-block"},ls=["onClick"],is={class:"label-text"},as=["onClick"],rs={class:"label-text"},cs={key:1,class:"item-body"},us={key:0,class:"file-items"},ds=["onClick"],_s={class:"file-name"},ps={key:0},ms={key:1},gs={key:1,class:"thinking-content"},vs={class:"message-content"},fs={class:"message-menus"},hs=["onClick"],ys=["innerHTML"],ks={class:"message-menus"},bs=["onClick"],ws={key:4,class:"message-content"},$s=["src"],xs={key:5,class:"message-action-wrap"},qs={key:0,class:"message-action"},Cs={class:"action-btn"},Ss=["onClick"],Ls={__name:"message-list",props:{messages:{type:Array,default:()=>[]},robotInfo:{type:Object,default:()=>{}}},emits:["clickMsgMeun","scroll","scrollStart","scrollEnd","openPromptLog","openLibrary"],setup(S,{expose:k,emit:w}){const o=w,v=S,y=c=>{c.show_reasoning=!c.show_reasoning},p=c=>{c.show_quote_file=!c.show_quote_file},i=se(()=>v.robotInfo.common_question_list.length?JSON.parse(v.robotInfo.common_question_list):[]),l=se(()=>(v.robotInfo.chat_type==1||v.robotInfo.chat_type==3)&&v.robotInfo.application_type=="0"),_=c=>{o("clickMsgMeun",c)},r=A(null),n={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let b=null,E=!1;function R(c){E||(b&&(clearTimeout(b),b=null),b=setTimeout(()=>{n.scrollTop-c.target.scrollTop>0&&(n.scrollDirection="up"),n.scrollTop-c.target.scrollTop<0&&(n.scrollDirection="down"),n.scrollTop=c.target.scrollTop,n.scrollHeight=c.target.scrollHeight,n.clientHeight=c.target.clientHeight,o("scroll",{...n}),Math.abs(n.scrollTop)<=n.scrollStartDiff&&n.scrollDirection==="up"&&j(),Math.abs(n.scrollHeight-n.scrollTop-n.clientHeight)<=n.scrollEndDiff&&n.scrollDirection==="down"&&H()},50))}function j(){v.messages.length!=0&&o("scrollStart",{msg:v.messages[0]})}function H(){v.messages.length!=0&&o("scrollEnd",{msg:v.messages[v.messages.length-1]})}const Y=()=>{r.value&&me(()=>{E=!0,r.value.scrollTop=r.value.scrollHeight+1,setTimeout(()=>{n.scrollTop=r.value.scrollTop,E=!1},50)})};function ie(c,h){me(()=>{E=!0,h||(h="top");let L=r.value,T=document.querySelector("#msg-"+c);h=="top"?L.scrollTop=T.offsetTop:L.scrollTop=T.offsetTop-L.clientHeight+T.clientHeight,setTimeout(()=>{n.scrollTop=r.value.scrollTop,E=!1},50)})}function $(){n.scrollTop=0,n.scrollDirection=""}function f(c){return!!(c.quote_file&&c.quote_file.length>0||c.debug&&c.debug.length>0)}function D(c){o("openPromptLog",_e(c))}function N(c,h,L){let T=_e(c);h.message_id=h.message_id||L,T.forEach(O=>{O.message_id=O.message_id||L}),o("openLibrary",T,_e(h))}function V(c){try{return c?Array.isArray(c)?c:typeof c=="string"?JSON.parse(c||"[]"):[]:[]}catch{return[]}}function X(c){const h=[];return(Array.isArray(c)?c:[]).forEach(L=>{const T=String((L==null?void 0:L.menu_type)||""),O=String((L==null?void 0:L.content)||"");if(T==="0")if(O==="")h.push({kind:"newline"});else if(/<a[\s\S]*?<\/a>/.test(O)){const Q=/href\s*=\s*['"]\s*#\s*['"]/i.test(O)?O.replace(/href\s*=\s*['"]\s*#\s*['"]/ig,'href="javascript:;"'):O.replace(/href=/ig,'target="_blank" href=');h.push({kind:"html",html:Q})}else h.push({kind:"text",text:O});else T==="1"&&h.push({kind:"keyword",text:O,serial_no:(L==null?void 0:L.serial_no)||""})}),h.slice(0,20)}function oe(c){var T,O;const h=(O=(T=c.target)==null?void 0:T.closest)==null?void 0:O.call(T,"a");if(!h)return;const L=String(h.getAttribute("href")||"");(L==="#"||L==="javascript:;")&&(c.preventDefault(),c.stopPropagation())}function x(c){const h=String(c||"").trim();h&&o("clickMsgMeun",h)}return k({scrollToBottom:Y,scrollToMessage:ie,resetScroll:$}),(c,h)=>{const L=qe,T=ae,O=Ce,Q=be("viewer");return t(),s("div",gt,[e("div",{class:"scroll-box",ref_key:"scrollBoxRef",ref:r,onScroll:R},[e("div",vt,[(t(!0),s(I,null,B(v.messages,a=>(t(),s(I,{key:a.uid},[a.is_customer==1?(t(),s("div",{key:0,class:"message-item user-message",id:"msg-"+a.uid,"data-msg_type":a.msg_type},[e("div",ht,[e("img",{class:"user-avatar",src:a.avatar},null,8,yt)]),e("div",kt,[e("div",bt,[a.msg_type==3?(t(),s("div",wt,[ne(e("img",{class:"msg-img",src:a.media_id_to_oss_url,alt:""},null,8,$t),[[Q]])])):a.msg_type==99?(t(),s("div",xt,[u(Ve,{message:a.content},null,8,["message"])])):(t(),z(mt,{key:2,class:"message-content",message:a.content},null,8,["message"]))])])],8,ft)):(t(),s("div",{key:1,class:"message-item robot-message",id:"msg-"+a.uid},[e("div",Ct,[u(L,{size:"small",spinning:a.loading},{default:q(()=>[e("img",{class:"robot-avatar",src:a.robot_avatar},null,8,St)]),_:2},1032,["spinning"])]),e("div",Lt,[V(a.reply_content_list).length?(t(),s("div",Tt,[(t(!0),s(I,null,B(V(a.reply_content_list),(d,K)=>{var Z;return t(),s(I,{key:K},[(d.reply_type||d.type)==="text"?(t(),s("div",Mt,[e("div",{class:"message-content",innerHTML:d.description},null,8,It)])):(d.reply_type||d.type)==="image"?(t(),s("div",Ft,[e("div",Rt,[ne(e("img",{class:"msg-img",src:d.pic||d.thumb_url},null,8,At),[[Q]])])])):(d.reply_type||d.type)==="url"?(t(),s("div",Et,[e("div",Ot,[e("a",{class:"url-link",href:d.url,target:"_blank"},m(d.url),9,Bt)])])):(d.reply_type||d.type)==="card"?(t(),s("div",Dt,[e("div",Pt,[d.thumb_url?(t(),s("img",{key:0,src:d.thumb_url,class:"card-thumb"},null,8,Ht)):g("",!0),e("div",Ut,[u(T,{class:"think-icon",name:"applet"}),e("span",jt,m(d.title),1)])])])):(d.reply_type||d.type)==="imageText"?(t(),s("div",Nt,[e("a",{class:"imageText-row",href:d.url,target:"_blank"},[d.thumb_url?(t(),s("img",{key:0,src:d.thumb_url,class:"imageText-thumb"},null,8,Vt)):g("",!0),e("div",Jt,[e("div",Qt,m(d.title),1),e("div",Kt,m(d.description),1)])],8,zt)])):(d.reply_type||d.type)==="smartMenu"?(t(),s("div",Wt,[e("div",Gt,[d.smart_menu&&d.smart_menu.menu_description?(t(),s("div",Yt,m(d.smart_menu.menu_description),1)):g("",!0),e("div",Xt,[(t(!0),s(I,null,B(X(((Z=d.smart_menu)==null?void 0:Z.menu_content)||[]),(U,re)=>(t(),s("div",{key:re,class:"reply-line",onClick:h[0]||(h[0]=ce=>oe(ce))},[U.kind==="text"?(t(),s("span",Zt,m(U.text),1)):U.kind==="newline"?(t(),s("div",es)):U.kind==="html"?(t(),s("span",{key:2,innerHTML:U.html},null,8,ts)):U.kind==="keyword"?(t(),s("a",{key:3,href:"javascript:;",class:"link",onClick:Ee(ce=>x(U.text),["prevent"])},[U.serial_no?(t(),s("div",os,m(U.serial_no),1)):g("",!0),P(" "+m(U.text),1)],8,ss)):g("",!0)]))),128))])])])):g("",!0)],64)}),128))])):g("",!0),e("div",ns,[a.msg_type==1&&l.value?(t(),s("div",{key:0,class:J(["thinking-label-wrapper",{reasoning_open:a.show_quote_file}])},[e("div",{class:"thinking-label",onClick:d=>p(a)},[a.quote_loading?(t(),s(I,{key:0},[u(M(ye),{class:"loading"}),h[1]||(h[1]=e("span",{class:"label-text"},"正在检索知识库...",-1))],64)):(t(),s(I,{key:1},[u(T,{class:"think-icon",name:"quote-file"}),e("span",is,"检索到"+m(a.quote_file.length)+"个知识库文档",1)],64)),a.quote_file.length?(t(),z(T,{key:2,name:"arrow-down",class:"arrow-down"})):g("",!0)],8,ls)],2)):g("",!0),a.reasoning_content?(t(),s("div",{key:1,class:J(["thinking-label-wrapper",{reasoning_open:a.show_reasoning}])},[e("div",{class:"thinking-label",onClick:d=>y(a)},[a.reasoning_status?(t(),z(M(ye),{key:0,class:"loading"})):(t(),z(T,{key:1,class:"think-icon",name:"think"})),e("span",rs,m(a.reasoning_status?"深度思考中...":"已完成深度思考"),1),a.reasoning_status?g("",!0):(t(),z(T,{key:2,name:"arrow-down",class:"arrow-down"}))],8,as),u(O,null,{title:q(()=>[...h[2]||(h[2]=[P("在应用设置中关闭推理过程开关，将不再显示推理过程",-1)])]),default:q(()=>[u(M(Je),{class:"tip"})]),_:1})],2)):g("",!0)]),a.msg_type==1&&a.content==""?g("",!0):(t(),s("div",cs,[a.show_quote_file&&a.quote_file&&a.quote_file.length>0?(t(),s("div",us,[(t(!0),s(I,null,B(a.quote_file,d=>(t(),s("div",{class:"file-item",key:d.id,onClick:K=>N(a.quote_file,d,a.id)},[e("a",_s,[u(T,{class:"think-icon",name:"quote-file"}),d.file_name?(t(),s("span",ps,m(d.file_name),1)):(t(),s("span",ms,m(d.library_name)+"-精选",1))])],8,ds))),128))])):g("",!0),a.show_reasoning?(t(),s("div",gs,[u(pe,{content:a.reasoning_content},null,8,["content"])])):g("",!0),a.msg_type==1?(t(),s(I,{key:2},[ne((t(),s("div",vs,[u(pe,{content:a.content},null,8,["content"])])),[[Q]]),e("div",fs,[(t(!0),s(I,null,B(a.question,(d,K)=>(t(),s("div",{class:"menu-item",onClick:Z=>_(d),key:K},m(d),9,hs))),128))])],64)):g("",!0),a.msg_type==2?(t(),s(I,{key:3},[a.isWelcome?(t(),z(pe,{key:0,class:"markdown-content",content:a.menu_json.content},null,8,["content"])):(t(),s("div",{key:1,class:"message-content",innerHTML:a.menu_json.content},null,8,ys)),e("div",ks,[(t(!0),s(I,null,B(a.menu_json.question,(d,K)=>(t(),s("div",{class:"menu-item",onClick:Z=>_(d),key:K},m(d),9,bs))),128))])],64)):g("",!0),a.msg_type==3?(t(),s("div",ws,[ne(e("img",{class:"msg-img",src:a.content,alt:""},null,8,$s),[[Q]])])):g("",!0),f(a)?ne((t(),s("div",xs,[a.debug&&a.debug.length>0?(t(),s("div",qs,[e("div",Cs,[e("span",null,[e("a",{onClick:d=>D(a)},"Prompt 日志",8,Ss)])])])):g("",!0)],512)),[[Oe,!a.question]]):g("",!0)])),(a.guess_you_want&&a.guess_you_want.length||i.value.length&&v.robotInfo.enable_common_question=="true")&&a.question_tabkey>0?(t(),z(_t,{key:2,item:a,enable_common_question:v.robotInfo.enable_common_question=="true",common_question_list:i.value,onClickMeun:_},null,8,["item","enable_common_question","common_question_list"])):g("",!0)])],8,qt))],64))),128))])],544)])}}},Ts=G(Ls,[["__scopeId","data-v-f2ef7d78"]]),Ms={class:"chat-list-box"},Is=["onClick"],Fs={class:"chat-item-title"},Rs={__name:"chat-list",props:{list:{type:Array,default:()=>[]},active:{type:[String,Number],default:""}},emits:["openChat","onScrollEnd"],setup(S,{emit:k}){const w=k,o=S,v=A(null),y=i=>{w("openChat",i)},p=()=>{w("onScrollEnd")};return we(()=>o.list,()=>{me(()=>{v.value.refresh()})}),(i,l)=>{const _=ae;return t(),s("div",Ms,[u(Le,{ref_key:"scroller",ref:v,onOnScrollEnd:p},{default:q(()=>[e("div",null,[(t(!0),s(I,null,B(o.list,r=>(t(),s("div",{class:J(["chat-list-item",{active:r.id==o.active}]),onClick:n=>y(r),key:r.id},[u(_,{class:"chat-item-icon",name:"message"}),e("span",Fs,m(r.subject||r.last_chat_message),1)],10,Is))),128))])]),_:1},512)])}}},As=G(Rs,[["__scopeId","data-v-8a5dd127"]]),Es={class:"file-toolbar"},Os={class:"toolbar-left"},Bs={class:"file-list"},Ds={key:0,class:"delete-btn action-btn"},Ps={key:1,class:"preview-btn action-btn"},Hs=["src"],Us={key:2,class:"progress-bar"},js={key:3,class:"error-text"},Ns={__name:"file-toolbar",props:{fileList:{type:Array,default:()=>[]}},emits:["add","delete"],setup(S,{emit:k}){const w=S,o=k,v=se(()=>w.fileList.map(i=>i.url)),y=i=>{Fe({options:{toolbar:!0,initialViewIndex:i},images:v.value}).show()},p=i=>{o("delete",i)};return(i,l)=>{const _=ae;return t(),s("div",Es,[e("div",Os,[e("div",Bs,[(t(!0),s(I,null,B(S.fileList,(r,n)=>(t(),s("div",{key:n,class:J(["file-item",{uploading:r.status==="uploading",error:r.status==="error"}])},[r.status=="done"||r.status=="error"?(t(),s("span",Ds,[u(M(ge),{class:"delete-icon",onClick:b=>p(n)},null,8,["onClick"])])):g("",!0),r.status=="done"?(t(),s("span",Ps,[u(_,{class:"preview-icon",name:"eye-open",onClick:b=>y(n)},null,8,["onClick"])])):g("",!0),e("img",{src:r.url,alt:"avatar"},null,8,Hs),l[0]||(l[0]=e("div",{class:"mask"},null,-1)),r.status==="uploading"?(t(),s("div",Us,[e("div",{class:"progress",style:Be({width:r.percent+"%"})},null,4)])):g("",!0),r.status==="error"?(t(),s("div",js,"上传失败")):g("",!0)],2))),128))])])])}}},zs=G(Ns,[["__scopeId","data-v-2f3d173b"]]),Vs=(S,k,w)=>new Promise((o,v)=>{Ze({file:S.originFile,category:w},y=>{const p=Math.round(y.loaded*100/y.total),i=k.value.find(l=>l.uid===S.uid);if(i){const l={...i,percent:p},_=k.value.findIndex(r=>r.uid===S.uid);_!==-1&&k.value.splice(_,1,l)}}).then(y=>{const p=k.value.find(i=>i.uid===S.uid);if(p){const i={...p,percent:100,status:"done",url:y.data.link||""},l=k.value.findIndex(_=>_.uid===S.uid);l!==-1&&k.value.splice(l,1,i),o(i)}}).catch(y=>{const p=k.value.find(i=>i.uid===S.uid);if(p){const i={...p,status:"error"},l=k.value.findIndex(_=>_.uid===S.uid);l!==-1&&k.value.splice(l,1,i)}v(y)})});function Js(S){const{limit:k=10,maxSize:w=10,accept:o="image/*",multiple:v=!0,category:y,fileList:p=A([])}=S||{};if(!y)throw new Error("category is required");let i=null;const l=n=>{let b=Array.from(n.target.files);const E=k-p.value.length;if(E<=0){le.error(`最多只能上传 ${k} 张图片`);return}b.length>E&&(b=b.slice(0,E),le.error(`最多只能上传 ${k} 张图片，已为您选择前 ${E} 张`)),b.forEach(R=>{if(!(R.size/1024/1024<w)){le.error(`文件大小不能超过 ${w}MB!`);return}const H=R.type;if(!o.split(",").map(f=>f.trim()).some(f=>f.endsWith("/*")?H.startsWith(f.slice(0,-1)):H===f)){le.error(`不支持的文件类型: ${H}`);return}const $={uid:R.uid||ke(16),name:R.name,status:"uploading",percent:0,originFile:R,url:URL.createObjectURL(R)};p.value.push($),Vs($,p,y).then(f=>{const D=p.value.findIndex(N=>N.uid===f.uid);D!==-1&&p.value.splice(D,1,f)}).catch(()=>{const f=p.value.findIndex(D=>D.uid===$.uid);f!==-1&&(p.value[f].status="error")})}),n.target.value=""},_=()=>{const n=document.createElement("input");return n.type="file",n.accept=o,n.multiple=v,n.style.display="none",n.onchange=l,document.body.appendChild(n),n},r=()=>{if(p.value.length>=k){le.error(`最多只能上传 ${k} 张图片`);return}i||(i=_()),i.click()};return $e(()=>{i&&document.body.contains(i)&&(document.body.removeChild(i),i=null)}),{openFileDialog:r}}const Qs={class:"message-input-wrapper"},Ks={key:0,class:"file-toolbar-box"},Ws={class:"message-input-box"},Gs={class:"message-action"},Ys=["disabled"],Xs={__name:"message-input",props:{value:{type:String,default:""},loading:{type:Boolean,default:!1},fileList:{type:Array,default:()=>[]},showUpload:{type:Boolean,default:!1}},emits:["send","update:value","update:fileList"],setup(S,{emit:k}){const w=k,o=S,{fileList:v}=De(o),{openFileDialog:y}=Js({limit:10,maxSize:10,category:"chat_image",fileList:v,multiple:!0,accept:"image/bmp,image/jpeg,image/png,image/tiff,image/heic,image/gif,image/webp"}),p=n=>{const b=o.fileList.filter((E,R)=>R!==n);w("update:fileList",b)},i=se(()=>o.fileList.length>0?!1:o.loading||o.value.trim().length===0),l=n=>{w("update:value",n.target.value.trim())},_=n=>{if(n.key==="Enter"&&!n.shiftKey){if(!n.target.value.trim())return;n.preventDefault(),n.stopPropagation(),r()}else n.key==="Enter"&&n.shiftKey&&(n.preventDefault(),n.stopPropagation(),w("update:value",o.value+`
`))},r=()=>{w("send",o.value.trim())};return(n,b)=>{const E=Qe,R=ae,j=qe;return t(),s("div",Qs,[o.fileList.length>0?(t(),s("div",Ks,[u(zs,{"file-list":o.fileList,onDelete:p},null,8,["file-list"])])):g("",!0),e("div",Ws,[u(E,{class:"message-input",value:o.value,placeholder:"在此输入您想了解的内容，Shift+Enter换行","auto-size":{minRows:2,maxRows:5},onChange:l,onKeydown:_},null,8,["value"])]),e("div",Gs,[o.showUpload?(t(),s("div",{key:0,class:"select-file-btn",onClick:b[0]||(b[0]=(...H)=>M(y)&&M(y)(...H))},[u(R,{class:"select-file-icon",name:"circularNeedle"}),M(v).length>0?(t(),s("span",{key:0,class:J(["file-number",{big:M(v).length>9}])},m(M(v).length),3)):g("",!0)])):g("",!0),e("button",{class:J(["send-msg-btn",{loading:o.loading}]),disabled:i.value,onClick:r},[o.loading?(t(),z(j,{key:0,size:"small",class:"loading-action",style:{"margin-right":"4px"}})):(t(),z(R,{key:1,class:"paper-airplane",name:"paper-airplane"}))],10,Ys)])])}}},Zs=G(Xs,[["__scopeId","data-v-123f63e8"]]),eo={class:"prompt-log-content"},to={class:"prompt-log-items"},so={class:"prompt-log-label"},oo={class:"prompt-log-item"},no={class:"prompt-log-items"},lo={class:"prompt-log-label"},io={class:"prompt-log-items"},ao={class:"prompt-log-label"},ro={class:"prompt-log-item"},co={class:"prompt-log-items"},uo={class:"prompt-log-label"},_o={class:"prompt-log-item"},po={key:0,class:"prompt-log-items"},mo={class:"prompt-log-label"},go={class:"prompt-log-item"},vo={key:1,class:"prompt-log-items"},fo={class:"prompt-log-label"},ho={class:"prompt-log-item"},yo={class:"prompt-log-items"},ko={class:"prompt-log-label"},bo={class:"prompt-log-item"},wo={__name:"prompt-log-alert",setup(S,{expose:k}){const w=A(!1),o=Pe({prompt:"",library:[],context_qa:[],cur_question:"",cur_answer:"",error:""}),v=()=>{w.value=!1},y=()=>{o.prompt="",o.library=[],o.context_qa=[],o.cur_question="",o.cur_answer="",o.error="",o.recall_time="",o.request_time=""};return k({open:i=>{y(),o.error=i.error,o.recall_time=i.recall_time?(i.recall_time/1e3).toFixed(2):"",o.request_time=i.request_time?(i.request_time/1e3).toFixed(2):"";let l=i.debug||[];for(let _=0;_<l.length;_++){let r=l[_];r.type=="library"?o.library.push(r.content):r.type=="context_qa"?o.context_qa.push(r):o[r.type]=r.content}w.value=!0}}),(i,l)=>{const _=Ce,r=Se;return t(),z(r,{class:"prompt-log-alert",open:w.value,"onUpdate:open":l[0]||(l[0]=n=>w.value=n),title:"Prompt 日志",placement:"right",width:"746px",closable:!1},{extra:q(()=>[e("span",{class:"close-btn",onClick:v},[u(M(ge))])]),default:q(()=>[e("div",eo,[e("div",to,[e("div",so,[l[2]||(l[2]=e("span",null,"提示词 ",-1)),u(_,null,{title:q(()=>[...l[1]||(l[1]=[P("系统提示词和文档分段。",-1)])]),default:q(()=>[u(M(te),{class:"question-icon"})]),_:1})]),e("div",oo,[e("p",null,m(o.prompt),1)]),(t(!0),s(I,null,B(o.library,(n,b)=>(t(),s("div",{class:"prompt-log-item",key:b},[e("p",null,m(n),1)]))),128))]),e("div",no,[e("div",lo,[l[4]||(l[4]=e("span",null,"上下文 ",-1)),u(_,null,{title:q(()=>[...l[3]||(l[3]=[P("传递的历史提问消息",-1)])]),default:q(()=>[u(M(te),{class:"question-icon"})]),_:1})]),(t(!0),s(I,null,B(o.context_qa,(n,b)=>(t(),s("div",{class:"prompt-log-item",key:b},[e("p",null,"Q："+m(n.question),1),e("p",null,"A："+m(n.answer),1)]))),128))]),e("div",io,[e("div",ao,[l[6]||(l[6]=e("span",null,"USER ",-1)),u(_,null,{title:q(()=>[...l[5]||(l[5]=[P("本次用户的提问",-1)])]),default:q(()=>[u(M(te),{class:"question-icon"})]),_:1})]),e("div",ro,[e("p",null,m(o.cur_question),1)])]),e("div",co,[e("div",uo,[l[8]||(l[8]=e("span",null,"ASSISTANT ",-1)),u(_,null,{title:q(()=>[...l[7]||(l[7]=[P("语言模型输出的答案",-1)])]),default:q(()=>[u(M(te),{class:"question-icon"})]),_:1})]),e("div",_o,[e("p",null,m(o.cur_answer),1)])]),o.recall_time>0?(t(),s("div",po,[e("div",mo,[l[10]||(l[10]=e("span",null,"Recall time ",-1)),u(_,null,{title:q(()=>[...l[9]||(l[9]=[P("从知识库中检索到有效分段所需要的时间，包括对分段进行排序时间。",-1)])]),default:q(()=>[u(M(te),{class:"question-icon"})]),_:1})]),e("div",go,[e("p",null,m(o.recall_time)+"s",1)])])):g("",!0),o.request_time>0?(t(),s("div",vo,[e("div",fo,[l[12]||(l[12]=e("span",null,"Request time ",-1)),u(_,null,{title:q(()=>[...l[11]||(l[11]=[P("从发送问题和上下文信息给大模型到大模型开始返回答案的时间。",-1)])]),default:q(()=>[u(M(te),{class:"question-icon"})]),_:1})]),e("div",ho,[e("p",null,m(o.request_time)+"s",1)])])):g("",!0),e("div",yo,[e("div",ko,[l[14]||(l[14]=e("span",null,"Error ",-1)),u(_,null,{title:q(()=>[...l[13]||(l[13]=[P("报错信息，调用聊天接口报错时会显示。",-1)])]),default:q(()=>[u(M(te),{class:"question-icon"})]),_:1})]),e("div",bo,[e("p",null,m(o.error),1)])])])]),_:1},8,["open"])}}},$o=G(wo,[["__scopeId","data-v-6f598f2d"]]),xo={class:"library-info-content"},qo={class:"file-list"},Co=["onClick"],So={key:0},Lo={key:1},To={class:"document-items"},Mo={class:"document-item-header"},Io={class:"left-box"},Fo={class:"document-title"},Ro={key:0,class:"document-title"},Ao={class:"document-size"},Eo={class:"right-box"},Oo=["onClick"],Bo={class:"document-item-body"},Do={class:"document-similarity"},Po={key:0,class:"document-content"},Ho={key:1,class:"document-content"},Uo={class:"document-content"},jo={class:"fragment-img"},No=["src"],zo={class:"iframe-box"},Vo={__name:"library-info-alert",setup(S,{expose:k}){const w=xe(),{robot:o,user:v}=w;He();const y=A(!1),p=A([]),i=A(null),l=()=>{p.value=[],i.value=null},_=($,f)=>{if(l(),p.value=$.map(D=>{let N=null;return D.answer_source_data&&(N=JSON.parse(D.answer_source_data)),{...D,answer_source_data:N}}),i.value=f.id,y.value=!0,f.answer_source_data){n.value=JSON.parse(f.answer_source_data)||[];return}b(f)},r=$=>{if($.id!=i.value){if(i.value=$.id,$.answer_source_data){n.value=$.answer_source_data||[];return}b($)}},n=A([]),b=$=>{et({message_id:$.message_id,file_id:$.id,robot_key:o.robot_key,openid:o.openid}).then(f=>{n.value=f.data||[]})},E=()=>{let $=p.value.filter(f=>f.id==i.value)[0]||{};$.file_name?window.open(`#/library/preview?id=${i.value}`):window.open(`#/library/details/categary-manage?id=${$.library_id}`)},R=se(()=>{let $=p.value.filter(f=>f.id==i.value)[0]||{};return $.file_name?$.file_name:$.library_name+"-精选"}),j=A(""),H=A(!1),Y=$=>{H.value=!0,j.value="/manage/getLibRawFileOnePage?id="+i.value+"&page="+$.page_num+"&admin_user_id="+v.admin_user_id},ie=()=>{y.value=!1};return k({open:_}),($,f)=>{const D=ae,N=Se,V=Le,X=Ke,oe=be("viewer");return t(),s(I,null,[u(N,{class:"library-info-alert",open:y.value,"onUpdate:open":f[0]||(f[0]=x=>y.value=x),title:"答案来源",placement:"right",width:"746px",closable:!1,bodyStyle:{background:"#F2F4F7"}},{extra:q(()=>[e("span",{class:"close-btn",onClick:ie},[u(M(ge))])]),default:q(()=>[e("div",xo,[e("div",qo,[(t(!0),s(I,null,B(p.value,x=>(t(),s("div",{class:J(["file-item",{active:i.value==x.id}]),key:x.id,onClick:c=>r(x)},[x.file_name?(t(),s("span",So,m(x.file_name),1)):(t(),s("span",Lo,m(x.library_name)+"-精选",1))],10,Co))),128))]),e("div",To,[(t(!0),s(I,null,B(n.value,x=>(t(),s("div",{class:"document-item",key:x.id},[e("div",Mo,[e("div",Io,[e("span",Fo,"id："+m(x.id),1),x.title?(t(),s("span",Ro,m(x.title),1)):g("",!0),e("span",Ao," 共"+m(x.word_total)+"个字符 ",1)]),e("div",Eo,[x.page_num>0?(t(),s("a",{key:0,onClick:c=>Y(x)},"预览原文件>",8,Oo)):g("",!0),e("a",{onClick:E},"查看源文档>")])]),e("div",Bo,[e("div",Do,[f[2]||(f[2]=P(" 相似度： ",-1)),u(D,{name:"similarity",style:{"font-size":"16px"}}),P(m(x.similarity),1)]),x.question?(t(),s("div",Po,"Q："+m(x.question),1)):g("",!0),x.answer?(t(),s("div",Ho,"A："+m(x.answer),1)):g("",!0),e("div",Uo,m(x.content),1),ne((t(),s("div",jo,[(t(!0),s(I,null,B(x.images,(c,h)=>(t(),s("img",{key:h,src:c,alt:""},null,8,No))),128))])),[[oe]])])]))),128))])])]),_:1},8,["open"]),u(X,{open:H.value,"onUpdate:open":f[1]||(f[1]=x=>H.value=x),title:R.value,footer:null,width:740},{default:q(()=>[e("div",zo,[u(V,null,{default:q(()=>[u(M(tt),{source:j.value},null,8,["source"])]),_:1})])]),_:1},8,["open","title"])],64)}}},Jo=G(Vo,[["__scopeId","data-v-e8bc69ca"]]),Qo={class:"chat-page-wrapper"},Ko={class:"chat-page-header"},Wo={class:"breadcrumb-box"},Go={class:"chat-page"},Yo={class:"page-left"},Xo={class:"page-left-top"},Zo={class:"page-left-body"},en={class:"page-body"},tn={class:"chat-box-body"},sn={style:{"padding-top":"30px"},class:"chat-box-footer"},on={__name:"index",setup(S){const w=he().query,o=ot(),{getRobot:v}=o,y=se(()=>o.robotInfo),p=ze(),i=xe(),l=Re();let _=!0;const r=A(""),n=A([]),b=A(null),{createChat:E,sendMessage:R,getMyChatList:j,openChat:H,onGetChatMessage:Y,changeRobotPrompt:ie,$reset:$}=i,{messageList:f,sendLock:D,myChatList:N,robot:V,dialogue_id:X}=Ue(i),oe=he(),x=A(!1),c=A(!1),h=se(()=>D.value||c.value),L=async()=>{if(!h.value){if(!r.value&&!n.value.length)return Ae("请输入消息内容");c.value=!0;try{let C=await st({robot_key:V.value.robot_key,openid:V.value.openid,question:r.value,form_ids:V.value.form_ids,dialogue_id:X.value});if(c.value=!1,C.data&&C.data.words)return le.error(`提交的内容包含敏感词：[${C.data.words.join(";")}] 请修改后再提交`);let F=1,W=r.value;if(y.value.question_multiple_switch==1){let ee=[];F=99,r.value&&(ee=[{type:"text",uid:ke(16),text:r.value}]),n.value.length&&n.value.map(ue=>{ee.push({uid:ue.uid,type:"image_url",image_url:{url:ue.url}})}),W=JSON.stringify(ee)}_=!0,R({message:W,global:JSON.stringify(w),msg_type:F}),r.value="",n.value=[]}catch{c.value=!1}}},T=async()=>{_=!0,r.value="";let C=oe.query||{},F=l.user_id,W={robot_key:C.robot_key,avatar:C.avatar,name:C.name,nickname:C.nickname,is_background:1,openid:F,dialogue_id:0};re(),await E(W)},O=async C=>{if(X.value==C.dialogue_id)return;_=!0;let W={robot_key:(oe.query||{}).robot_key,avatar:C.avatar,name:C.name,nickname:C.nickname,is_background:C.is_background,openid:C.openid,dialogue_id:C.id};re(),await H(W),await Y()&&Z()},Q=C=>{_=!0,R({message:C})};A(!1);const a=()=>{Z()},d=async()=>{_=!1;let C=f.value[0].uid;await Y()&&U(C)},K=()=>{},Z=()=>{b.value&&_&&b.value.scrollToBottom()},U=C=>{b.value&&b.value.scrollToMessage(C)},re=()=>{b.value&&b.value.resetScroll()},ce=()=>{j()},ve=A(null),Te=C=>{ve.value.open(C)},fe=A(null),Me=(C,F)=>{fe.value.open(C,F)};return we(()=>f.value,()=>{}),je(async()=>{T(),j(),await v(w.id),x.value=!0,p.on("updateAiMessage",a)}),$e(()=>{$(),p.off("updateAiMessage",a)}),(C,F)=>{const W=Ne("router-link"),ee=Ye,ue=We,Ie=Ge;return t(),s("div",Qo,[e("div",Ko,[e("div",Wo,[u(ue,null,{default:q(()=>[u(ee,null,{default:q(()=>[u(W,{to:"/robot/list"},{default:q(()=>[...F[2]||(F[2]=[P("机器人管理",-1)])]),_:1})]),_:1}),u(ee,null,{default:q(()=>[P(m(M(V).robot_name),1)]),_:1})]),_:1})])]),e("div",Go,[e("div",Yo,[e("div",Xo,[u(Ie,{type:"primary",block:"",ghost:"",onClick:T},{default:q(()=>[u(M(Xe)),F[3]||(F[3]=P(" 新建对话",-1))]),_:1})]),e("div",Zo,[u(As,{list:M(N),active:M(X),onOpenChat:O,onOnScrollEnd:ce},null,8,["list","active"])]),F[4]||(F[4]=e("div",{class:"page-left-footer"},null,-1))]),e("div",en,[e("div",tn,[u(Ts,{ref_key:"messageListRef",ref:b,messages:M(f),robotInfo:y.value,onClickMsgMeun:Q,onScrollStart:d,onScrollEnd:K,onOpenPromptLog:Te,onOpenLibrary:Me},null,8,["messages","robotInfo"])]),e("div",sn,[u(Zs,{value:r.value,"onUpdate:value":F[0]||(F[0]=de=>r.value=de),fileList:n.value,"onUpdate:fileList":F[1]||(F[1]=de=>n.value=de),loading:h.value,showUpload:y.value.question_multiple_switch==1,onSend:L},null,8,["value","fileList","loading","showUpload"])])]),e("div",null,[g("",!0)])]),u($o,{ref_key:"promptLogAlertRef",ref:ve},null,512),u(Jo,{ref_key:"libraryInfoAlertRef",ref:fe},null,512)])}}},$n=G(on,[["__scopeId","data-v-15a3f1d7"]]);export{$n as default};
