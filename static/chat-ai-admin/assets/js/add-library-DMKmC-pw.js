import{u as fe,ao as ve,ay as ye,bt as be,bu as ge,bv as he,_ as ke,bm as xe}from"../../index-DSFcP5NQ.js";import{c as w,ah as qe,r as S,E as O,j as Ne,a as b,p as f,y as n,t as d,ag as we,b as m,q as x,m as q,u as i,v as p,F as A,z as B,l as V,h as P,e as C,D as E,_ as g,Y as Ae}from"./vue-chunks-BdaA73Wf.js";import{U as Ce}from"./upload-input-C5mRP3pq.js";import{j as Se}from"./index-MT9fcN3v.js";import{A as Be}from"./avatar-input-BcFDFUIh.js";import{t as R}from"./validate-8MtiUsxW.js";import{_ as Ve}from"./emoji-mart-BBMRoEa3.js";import{b as I,F as z,c as Ee,I as Le,V as De,u as Fe,v as Me,r as Ue,s as Te,aZ as Oe,J as Pe,B as Re}from"./ui-antd-Dl1wwwCD.js";import"./neo4j-MWxXN7EM.js";import"./editor-cherry-CFIsbKoN.js";import"./lodash-Bm5sK6rN.js";import"./elkjs-BN8GIjVH.js";import"./utils-CvB22N-W.js";import"./other-LrIFyvU9.js";const Ie={class:"add-library-page"},ze={class:"form-box"},$e={class:"form-item-tip"},je={class:"upload-document-type-box"},Je=["onClick"],Ye={class:"right-block"},Ge={class:"title-block"},Qe={class:"title-text"},Xe={class:"desc"},Ze={class:"upload-document-type-box"},He=["onClick"],Ke={class:"right-block"},We={class:"title-block"},ea={class:"title-text"},aa={class:"desc"};const la=["src"],oa={key:0},ta={key:1},na={__name:"add-library",setup(ia){const{t:l}=fe("views.library.add-library.add-library"),{getStorage:$,setStorage:j}=ve("localStorage");I.config({duration:2});const L=we(),J=qe(),s=w(()=>J.query.type||0),D=["azure","ollama","xinference","openaiAgent"],Y=["azure"],ra=w(()=>[{iconName:"high",iconNameActive:"high-active",title:l("title_high_quality"),value:1,is_offline:!1,desc:l("desc_high_quality")}]),G=w(()=>{const a=[{iconName:"doc-icon",iconNameActive:"doc-icon-active",title:l("title_local_doc"),value:1,desc:s.value==2?l("desc_local_doc_open"):l("desc_local_doc_normal")},{iconName:"link-icon",iconNameActive:"link-icon-active",title:l("title_online_data"),value:2,desc:l("desc_online_data")},{iconName:"cu-doc-icon",iconNameActive:"cu-doc-active",title:l("title_custom_doc"),value:3,desc:l("desc_custom_doc")}];return s.value==2?a.filter(t=>t.value!=2):a}),Q=w(()=>[{iconName:"file-search",iconNameActive:"file-search",title:l("title_qa_index_both"),value:1,desc:l("desc_qa_index_both")},{iconName:"comment-search",iconNameActive:"comment-search",title:l("title_qa_index_question_only"),value:2,desc:l("desc_qa_index_question_only")}]),X=z.useForm,N=S(!1),Z=w(()=>$("lastEmbeddedModel")||{}),H=S(1),K=s.value==0?ye:be,e=O({type:s.value,access_rights:0,library_name:"",library_intro:"",use_model:"text-embedding-v2",model_config_id:"",library_files:void 0,avatar:K,avatar_file:void 0,is_offline:!1,urls:"",doc_type:1,file_name:"",is_qa_doc:s.value==2?1:0,qa_index_type:1,doc_auto_renew_frequency:1}),F=S(""),W=(a,t)=>s.value==1||t&&t.length>0||e.doc_type!=1?Promise.resolve():Promise.reject(new Error(l("msg_upload_file"))),ee=(a,t)=>s.value==1||e.doc_type!=2?Promise.resolve():R(t)===!1?Promise.reject(new Error(l("msg_invalid_url"))):Promise.resolve(),ae=O({library_name:[{required:!0,message:l("msg_enter_library_name"),trigger:"change"}],use_model:[{required:!0,message:l("msg_select_model"),trigger:"change"}],library_files:[{required:s.value==0,message:l("msg_select_file"),trigger:"change",validator:W}],urls:[{required:s.value==0,validator:ee}],file_name:[{required:s.value==0,validator:(a,t)=>s.value==1||e.doc_type!=3||t?Promise.resolve():Promise.reject(new Error(l("msg_enter_doc_name")))}]}),{validate:le,validateInfos:h}=X(e,ae),oe=a=>{e.library_files=a},te=(a,t)=>{const c=t.current_obj;e.use_model=D.indexOf(c.model_define)>-1&&c.deployment_name?c.deployment_name:c.name,F.value=c.model_define,e.model_config_id=c.id||t.model_config_id},ne=a=>{e.avatar=a.imageUrl,e.avatar_file=a.file},_a=a=>{e.is_offline=a.is_offline,H.value=a.value,e.use_model=void 0,M(a.is_offline)},ie=a=>{e.doc_type=a},re=a=>{e.qa_index_type=a},_e=()=>{L.back()},de=()=>{le().then(()=>{se()}).catch(a=>{})},se=()=>{let a=new FormData,t=JSON.parse(JSON.stringify(e));Y.indexOf(F.value)>-1&&(t.use_model="默认"),a.append("type",e.type),a.append("access_rights",e.access_rights),a.append("library_name",e.library_name),a.append("library_intro",e.library_intro),a.append("use_model",t.use_model),a.append("model_config_id",e.model_config_id),a.append("avatar",e.avatar_file?e.avatar_file:""),a.append("is_offline",e.is_offline),a.append("urls",JSON.stringify(R(e.urls))),a.append("doc_type",e.doc_type),a.append("file_name",e.file_name),a.append("is_qa_doc",e.is_qa_doc),a.append("qa_index_type",e.qa_index_type),a.append("doc_auto_renew_frequency",e.doc_auto_renew_frequency),a.append("is_default",2),j("lastEmbeddedModel",{});let c=!1;(s.value==0||s.value==2)&&e.doc_type==1&&e.library_files.forEach(r=>{(r.name.includes(".xlsx")||r.name.includes(".csv"))&&(c=!0),a.append("library_files",r)}),N.value=!0,xe(a).then(r=>{if(I.success(l("msg_create_success")),s.value==1){L.replace({path:"/public-library/config",query:{library_id:r.data.id}}),N.value=!1;return}let _="/library/details/knowledge-document",u={id:r.data.id};c&&(_="/library/document-segmentation",u={document_id:r.data.file_ids[0]}),e.doc_type==3&&(_="/library/preview",u={id:r.data.file_ids[0]}),L.replace({path:_,query:u}),N.value=!1}).catch(()=>{N.value=!1})},k=S([]);function ce(a,t,c){const r=new Set(a.map(_=>_.model_define));return t.filter(_=>{let u=_[c];r.has(u)&&a.filter(y=>{if(y.model_define==u)return y.children=he(y.children,_.children),!1})}),a}const M=a=>{Se({model_type:"TEXT EMBEDDING",is_offline:a}).then(t=>{let c=t.data||[],r=[];k.value=c.map(_=>{r=[];for(let u=0;u<_.model_info.vector_model_list.length;u++){const y=_.model_info.vector_model_list[u];r.push({name:y,deployment_name:_.model_config.deployment_name,id:_.model_config.id,model_define:_.model_info.model_define})}return _.model_config.id==Z.value.model_config_id,{id:_.model_config.id,name:_.model_info.model_name,model_define:_.model_info.model_define,icon:_.model_info.model_icon_url,children:r,deployment_name:_.model_config.deployment_name}}),k.value=ce(ge(k.value,"model_define"),k.value,"model_define"),k.value.forEach(_=>{_.model_define=="chatwiki"&&(e.model_config_id=_.id)})})};return Ne(()=>{M(!1)}),(a,t)=>{const c=Le,r=Ee,_=De,u=ke,y=Me,U=Fe,da=Te,sa=Ue,ue=Pe,me=Oe,T=Re,pe=z;return m(),b("div",Ie,[f("div",ze,[n(pe,{"label-col":{span:5}},{default:d(()=>[n(r,q({ref:"name",label:i(l)("label_library_name")},i(h).library_name),{default:d(()=>[n(c,{value:e.library_name,"onUpdate:value":t[0]||(t[0]=o=>e.library_name=o),type:"text",placeholder:i(l)("ph_library_name"),maxlength:20},null,8,["value","placeholder"])]),_:1},16,["label"]),n(r,{label:i(l)("label_library_intro")},{default:d(()=>[n(_,{value:e.library_intro,"onUpdate:value":t[1]||(t[1]=o=>e.library_intro=o),placeholder:i(l)("ph_library_intro")},null,8,["value","placeholder"])]),_:1},8,["label"]),n(r,q({ref:"name",label:i(l)("label_library_avatar")},i(h).avatar),{default:d(()=>[n(Be,{value:e.avatar,"onUpdate:value":t[2]||(t[2]=o=>e.avatar=o),onChange:ne},null,8,["value"]),f("div",$e,p(i(l)("msg_avatar_tip")),1)]),_:1},16,["label"]),s.value!=1?(m(),b(A,{key:0},[n(r,{label:i(l)("label_doc_type"),required:""},{default:d(()=>[f("div",je,[(m(!0),b(A,null,V(G.value,o=>(m(),b("div",{class:P(["type-item",{active:e.doc_type==o.value}]),key:o.value,onClick:v=>ie(o.value)},[f("div",Ye,[f("div",Ge,[n(u,{name:e.doc_type==o.value?o.iconNameActive:o.iconName},null,8,["name"]),f("div",Qe,p(o.title),1)]),f("div",Xe,p(o.desc),1)]),e.doc_type==o.value?(m(),C(u,{key:0,class:"check-arrow",name:"check-arrow-filled",style:{"font-size":"24px",color:"#fff"}})):x("",!0)],10,Je))),128))])]),_:1},8,["label"]),B(n(r,q({ref:"name",label:i(l)("label_library_files")},i(h).library_files),{default:d(()=>[n(Ce,{type:s.value,onChange:oe},null,8,["type"])]),_:1},16,["label"]),[[E,e.doc_type==1]]),B(n(r,q({ref:"urls",label:i(l)("label_urls")},i(h).urls),{default:d(()=>[n(_,{style:{height:"120px"},value:e.urls,"onUpdate:value":t[3]||(t[3]=o=>e.urls=o),placeholder:i(l)("ph_urls")},null,8,["value","placeholder"])]),_:1},16,["label"]),[[E,e.doc_type==2]]),B(n(r,{ref:"doc_auto_renew_frequency",label:i(l)("label_update_frequency"),required:""},{default:d(()=>[n(U,{value:e.doc_auto_renew_frequency,"onUpdate:value":t[4]||(t[4]=o=>e.doc_auto_renew_frequency=o),style:{width:"100%"}},{default:d(()=>[n(y,{value:1},{default:d(()=>[g(p(i(l)("option_no_auto_update")),1)]),_:1}),n(y,{value:2},{default:d(()=>[g(p(i(l)("option_every_day")),1)]),_:1}),n(y,{value:3},{default:d(()=>[g(p(i(l)("option_every_3_days")),1)]),_:1}),n(y,{value:4},{default:d(()=>[g(p(i(l)("option_every_7_days")),1)]),_:1}),n(y,{value:5},{default:d(()=>[g(p(i(l)("option_every_30_days")),1)]),_:1})]),_:1},8,["value"])]),_:1},8,["label"]),[[E,e.doc_type==2]]),B(f("div",null,[n(r,q({ref:"file_name",label:i(l)("label_file_name")},i(h).file_name),{default:d(()=>[n(c,{placeholder:i(l)("ph_file_name"),value:e.file_name,"onUpdate:value":t[5]||(t[5]=o=>e.file_name=o)},null,8,["placeholder","value"])]),_:1},16,["label"]),x("",!0),e.is_qa_doc==1?(m(),C(r,{key:1,label:i(l)("label_index_method"),required:""},{default:d(()=>[f("div",Ze,[(m(!0),b(A,null,V(Q.value,o=>(m(),b("div",{class:P(["type-item",{active:e.qa_index_type==o.value}]),key:o.value,onClick:v=>re(o.value)},[f("div",Ke,[f("div",We,[n(u,{name:e.qa_index_type==o.value?o.iconNameActive:o.iconName},null,8,["name"]),f("div",ea,p(o.title),1)]),f("div",aa,p(o.desc),1)]),e.qa_index_type==o.value?(m(),C(u,{key:0,class:"check-arrow",name:"check-arrow-filled",style:{"font-size":"24px",color:"#fff"}})):x("",!0)],10,He))),128))])]),_:1},8,["label"])):x("",!0)],512),[[E,e.doc_type==3]])],64)):x("",!0),n(r,q({label:i(l)("label_embedding_model")},i(h).use_model),{default:d(()=>[x("",!0),n(U,{value:e.use_model,"onUpdate:value":t[7]||(t[7]=o=>e.use_model=o),placeholder:i(l)("ph_select_model"),onChange:te},{default:d(()=>[(m(!0),b(A,null,V(k.value,o=>(m(),C(me,{key:o.id},{label:d(()=>[n(ue,{align:"center",gap:6},{default:d(()=>[f("img",{class:"model-icon",src:o.icon,alt:""},null,8,la),g(p(o.name),1)]),_:2},1024)]),default:d(()=>[(m(!0),b(A,null,V(o.children,v=>(m(),C(y,{value:D.indexOf(o.model_define)>-1&&v.deployment_name?v.deployment_name:v.name+v.id,model_config_id:o.id,current_obj:v,key:v.name+v.id},{default:d(()=>[D.indexOf(o.model_define)>-1&&v.deployment_name?(m(),b("span",oa,p(v.deployment_name),1)):(m(),b("span",ta,p(v.name),1))]),_:2},1032,["value","model_config_id","current_obj"]))),128))]),_:2},1024))),128))]),_:1},8,["value","placeholder"])]),_:1},16,["label"]),n(r,{"wrapper-col":{span:14,offset:4}},{default:d(()=>[n(T,{onClick:_e},{default:d(()=>[g(p(i(l)("btn_cancel")),1)]),_:1}),n(T,{type:"primary",style:{"margin-left":"16px"},loading:N.value,onClick:Ae(de,["prevent"])},{default:d(()=>[g(p(i(l)("btn_next")),1)]),_:1},8,["loading"])]),_:1})]),_:1})])])}}},wa=Ve(na,[["__scopeId","data-v-fce74a60"]]);export{wa as default};
//# sourceMappingURL=add-library-DMKmC-pw.js.map
