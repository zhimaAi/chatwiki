import{e as oe,f as w,w as _e,ac as u,ad as i,k as t,as as m,ar as s,u as S,at as C,F as R,ax as K,ai as ce,r as se,ae as N,az as $,G as h,y as pe,q as me,n as fe,o as ve,b as ke,av as he}from"./vue-chunks-CGLjTDrY.js";import{_ as J,c6 as ge,bv as ee,c7 as ye,c8 as xe,c as be,f as Ce,be as we,c9 as Fe,ca as $e,cb as ze,cc as De}from"../../index-C5-B0r5-.js";import{P as Oe}from"./page-tabs-8XUPaggw.js";import{_ as Se}from"./page-alert-NlbsKG4S.js";import{aw as Me,ax as Ie,b as q,F as qe,e as Te,w as Ue,x as Ae,O as Le,y as Ne,z as Re,$ as Qe,M as Y,by as Ee,B as Pe,E as Be,a5 as je,bE as ae,ai as Ve,aR as He,T as Ke,az as Ye,h as Je,i as We,k as Ge,G as Xe,d as ne,W as Ze}from"./ui-antd-B11sc9DP.js";import{M as et}from"./model-select-DkFuDwQt.js";import{I as tt}from"./import-knowledge-modal-BkXck93F.js";import"./neo4j-Bk0ySkcX.js";import"./utils-BH-4gQMj.js";import"./other-BrZCAsTs.js";import"./index-Btdd0zUd.js";import"./validate-8MtiUsxW.js";const at={class:"ant-upload-drag-icon"},nt={class:"ant-upload-hint"},ot={__name:"upload-input",props:{value:{type:Array,default:()=>[]},maxCount:{type:Number,default:1},type:{type:[String,Number],default:0}},emits:["change","update:value"],setup(L,{emit:T}){const D=T,k=L;let O=["docx","txt","md"];const a=oe(()=>O.map(v=>`.${v}`).join(",")),r=w([]);_e(()=>k.value,v=>{r.value=v},{immediate:!0});let y=null;const x=()=>{if(r.value.length>=k.maxCount)return q.error("一次最多上传"+k.maxCount+"个文件")},f=()=>{r.value.length>k.maxCount&&q.error("一次最多上传"+k.maxCount+"个文件");let v=[...r.value];D("change",v),D("update:value",v)},b=v=>{M(v),f()},M=v=>{for(let p=0;p<r.value.length;p++)if(r.value[p].uid===v.uid){r.value.splice(p,1);break}},z=v=>{const p=v.name.split(".").pop();return O.includes(p.toLowerCase())?v.size/1024/1024<100?(r.value=[...r.value||[],v],r.value.length>k.maxCount&&(r.value=r.value.splice(0,k.maxCount)),y&&clearTimeout(y),y=setTimeout(()=>{f(),clearTimeout(y)},50),!1):(q.error("文件大小不能超过100M"),!1):(q.error("不支持的文件格式"),!1)};return(v,p)=>{const F=Ie;return i(),u("div",{class:ce(["upload-input",{disabled:r.value.length>=k.maxCount}])},[t(F,{"file-list":r.value,name:"file",multiple:!0,"max-count":k.maxCount,accept:a.value,beforeUpload:z,onRemove:b,class:"ant-upload-drag"},{default:s(()=>[m("div",at,[t(S(Me))]),p[1]||(p[1]=m("div",{class:"ant-upload-text"},"点击或将文件拖拽到这里上传",-1)),m("div",nt,[m("p",null,"支持多个文档批量上传，单个文件不超过100M，最多"+C(k.maxCount)+"个文档",1),m("p",null,[p[0]||(p[0]=m("span",null,"支持文件类型：",-1)),(i(!0),u(R,null,K(S(O),_=>(i(),u("span",{class:"ant-upload-hint-ext",key:_},"."+C(_),1))),128))])])]),_:1},8,["file-list","max-count","accept"]),m("div",{class:"disabled-mask",onClick:x})],2)}}},st=J(ot,[["__scopeId","data-v-a6025391"]]),lt={key:0,class:"mt8"},it={key:1,class:"mt8"},Z=`根据user角色提供的文本，学习和分析它，并整理学习成果：
- 提出问题并给出每个问题的答案。
- 答案需详细完整，尽可能保留原文描述，可以适当扩展答案描述。
- 答案可以包含普通文字、链接、代码、表格、公示、媒体链接等 Markdown 元素。
- 最多提出 50 个问题。
- 生成的问题和答案和源文本语言相同。`,ut={__name:"upload-document",props:{separatorsOptions:{type:Array,default:()=>[]}},emits:["ok"],setup(L,{expose:T,emit:D}){const k=D,O=L,a=se({faq_files:[],chunk_model:"",chunk_model_config_id:"",chunk_type:1,chunk_size:8e3,chunk_prompt:Z,separators_no:[12,11]}),r=w({chunk_model_config_id:[{message:"请选择提取模型",required:!0}],faq_files:[{message:"请选择文件",required:!0}]}),y=w(!1),x=()=>{y.value=!0,ge().then(_=>{let l=_.data||{chunk_model:"",chunk_model_config_id:"",chunk_size:8e3,chunk_prompt:Z,separators_no:[12,11]};a.faq_files=[],a.chunk_model=l.chunk_model,a.chunk_model_config_id=l.chunk_model_config_id,a.chunk_type=1,a.chunk_size=l.chunk_size||8e3,a.chunk_prompt=l.chunk_prompt||Z,a.separators_no=ee(l.separators_no,[12,11]),setTimeout(()=>{!a.chunk_model_config_id&&p.value.length>0&&p.value[0].children&&p.value[0].children.length&&(a.chunk_model_config_id=p.value[0].model_config_id,a.chunk_model=p.value[0].children[0].name)},500)})},f=w(!1),b=w(null),M=()=>{b.value.validate().then(()=>{z()}).catch(()=>{f.value=!1})},z=()=>{let _=new FormData;a.faq_files.forEach(l=>{_.append("faq_files",l)}),_.append("chunk_type",a.chunk_type),_.append("chunk_size",a.chunk_size),_.append("chunk_model",a.chunk_model),_.append("chunk_model_config_id",a.chunk_model_config_id),_.append("chunk_prompt",a.chunk_prompt),_.append("separators_no",JSON.stringify(a.separators_no)),f.value=!0,ye(_).then(l=>{q.success("上传成功"),k("ok"),y.value=!1}).finally(()=>{f.value=!1})},v=_=>{a.faq_files=_,b.value.validate(["faq_files"])},p=w([]),F=_=>{p.value=_,pe(()=>{})};return T({show:x}),(_,l)=>{const I=Te,Q=Ae,W=Ue,E=Le,P=Re,B=Ne,G=Qe,j=qe,X=Y;return i(),u("div",null,[t(X,{open:y.value,"onUpdate:open":l[8]||(l[8]=d=>y.value=d),"confirm-loading":f.value,title:"上传文档",width:"746px",onOk:M},{default:s(()=>[t(j,{class:"url-add-form",layout:"vertical",ref_key:"formRef",ref:b,model:a,rules:r.value},{default:s(()=>[t(I,{name:"faq_files",label:null},{default:s(()=>[t(st,{maxCount:10,value:a.faq_files,"onUpdate:value":l[0]||(l[0]=d=>a.faq_files=d),onChange:v},null,8,["value"])]),_:1}),t(I,{name:"chunk_model_config_id",label:"提取模型"},{default:s(()=>[t(et,{modelType:"LLM",placeholder:"请选择AI大模型",modeName:a.chunk_model,"onUpdate:modeName":l[1]||(l[1]=d=>a.chunk_model=d),modeId:a.chunk_model_config_id,"onUpdate:modeId":l[2]||(l[2]=d=>a.chunk_model_config_id=d),style:{width:"100%"},onLoaded:F},null,8,["modeName","modeId"])]),_:1}),t(I,{label:"分块方式"},{default:s(()=>[t(W,{value:a.chunk_type,"onUpdate:value":l[3]||(l[3]=d=>a.chunk_type=d)},{default:s(()=>[t(Q,{value:1},{default:s(()=>[...l[9]||(l[9]=[h("按长度",-1)])]),_:1}),t(Q,{value:2},{default:s(()=>[...l[10]||(l[10]=[h("按分隔符",-1)])]),_:1})]),_:1},8,["value"]),a.chunk_type==1?(i(),u("div",lt,[t(E,{value:a.chunk_size,"onUpdate:value":l[4]||(l[4]=d=>a.chunk_size=d),min:1,max:1e4,step:1,placeholder:"请输入",style:{width:"300px"}},null,8,["value"])])):$("",!0),a.chunk_type==2?(i(),u("div",it,[t(B,{placeholder:"请选择",style:{width:"300px"},mode:"tags",value:a.separators_no,"onUpdate:value":l[5]||(l[5]=d=>a.separators_no=d)},{default:s(()=>[(i(!0),u(R,null,K(O.separatorsOptions,d=>(i(),N(P,{value:d.no,key:d.no},{default:s(()=>[h(C(d.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])])):$("",!0)]),_:1}),a.chunk_type==2?(i(),N(I,{key:0,label:"最大长度"},{default:s(()=>[t(E,{value:a.chunk_size,"onUpdate:value":l[6]||(l[6]=d=>a.chunk_size=d),min:1,max:1e4,step:1,placeholder:"请输入",style:{width:"300px"}},null,8,["value"])]),_:1})):$("",!0),t(I,{label:"FAQ提取提示词"},{default:s(()=>[t(G,{value:a.chunk_prompt,"onUpdate:value":l[7]||(l[7]=d=>a.chunk_prompt=d),style:{height:"150px"},placeholder:"请输入"},null,8,["value"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["open","confirm-loading"])])}}},dt=J(ut,[["__scopeId","data-v-8d68e5a4"]]),rt={class:"list-box"},_t={class:"error-tip"},ct={class:"content-block"},pt={class:"fragment-img"},mt=["src"],ft={__name:"fail-detail",setup(L,{expose:T}){const D=w(!1),k=w([]),O=r=>{D.value=!0,k.value=[],a(r.id)},a=r=>{xe({id:r}).then(y=>{let x=y.data||[];k.value=x.map(f=>({...f,images:f.images?JSON.parse(f.images):[]}))})};return T({show:O}),(r,y)=>{const x=Y,f=me("viewer");return i(),u("div",null,[t(x,{wrapClassName:"no-padding-modal",bodyStyle:{"padding-right":"24px","max-height":"650px","overflow-y":"auto"},open:D.value,"onUpdate:open":y[0]||(y[0]=b=>D.value=b),title:"提取失败分段",width:746,footer:null},{default:s(()=>[m("div",rt,[(i(!0),u(R,null,K(k.value,b=>(i(),u("div",{class:"list-item",key:b.id},[m("div",_t,C(b.split_errmsg),1),m("div",ct,C(b.content),1),fe((i(),u("div",pt,[(i(!0),u(R,null,K(b.images,(M,z)=>(i(),u("img",{key:z,src:M,alt:""},null,8,mt))),128))])),[[f]])]))),128))])]),_:1},8,["open"])])}}},vt=J(ft,[["__scopeId","data-v-4796072d"]]),kt={class:"library-page"},ht={class:"library-page-body"},gt={key:0,class:"btn-block"},yt={class:"list-box"},xt=["onClick"],bt={key:0,class:"status-block status-bule"},Ct={key:1,class:"status-block status-bule"},wt={key:2,class:"status-block status-bule"},Ft={key:3,class:"status-block status-green"},$t={key:4,class:"status-block status-red"},zt={key:0},Dt={key:1},Ot=["onClick"],St={key:1},Mt={key:2},It=["onClick"],qt={__name:"index",setup(L){const T=be(),D=he(),k=Ce();let{role_permission:O,role_type:a}=k;const r=oe(()=>a==1||O.includes("UploadDocFaq")),y=w([{title:"知识库",path:"/library/list"},{title:"数据库",path:"/database/list"},{title:"文档提取FAQ",path:"/ai-extract-faq/list"},{title:"触发次数统计",path:"/trigger-statics/list"}]),x=se({page:1,size:20,total:0}),f=w([]),b=w(!1);function M(e){return Array.isArray(e)?e.map(n=>{let c=V.value.find(g=>g.no===n);return c?c.name:n}):[]}const z=()=>{b.value=!1,Fe({...x}).then(e=>{let n=e.data.list||[];V.value,n=n.map(c=>{let g=ne(c.create_time*1e3).format("YY-MM-DD HH:mm"),U=ee(c.separators_no);return{...c,create_time_desc:g,separators_no_desc:M(U).join("、")}}),x.total=+e.data.total,f.value=n,_()}).finally(()=>{b.value=!1})},v=()=>{x.page=1,z()},p=e=>{x.page=e.current,x.size=e.pageSize,z()};let F={};const _=()=>{f.value.forEach(e=>{e.status==2&&l(e.id)})};function l(e){F[e]&&clearInterval(F[e]),F[e]=setInterval(async()=>{try{const c=(await ze({id:e})).data;c.create_time_desc=ne(c.create_time*1e3).format("YY-MM-DD HH:mm");let g=ee(c.separators_no);c.separators_no_desc=M(g).join("、");const U=f.value.findIndex(H=>H.id==e);U!==-1&&f.value.splice(U,1,c),c.status!=2&&I(e)}catch{I(e)}},5e3)}function I(e){F[e]&&(clearInterval(F[e]),delete F[e])}const Q=e=>{Y.confirm({title:"删除确认",icon:t(Ze),content:`是否删除该文件【${e.file_name}】?`,okText:"确定",cancelText:"取消",okType:"danger",onOk(){W(e)},onCancel(){}})},W=({id:e})=>{$e({id:e}).then(()=>{q.success("删除成功"),z()})},E=e=>{Y.confirm({title:"重新分段确认",icon:null,okText:"确定",cancelText:"取消",onOk(){De({id:e.id}).then(n=>{q.success("重新分段成功"),z()})},onCancel(){}})},P=e=>{if(e.status==2||e.status==3){D.push({path:"/ai-extract-faq/details",query:{id:e.id,file_name:e.file_name}});return}let n="无法查看文件详情";e.status==0&&(n="排队中,请稍候"),e.status==1&&(n="文档解析中,请稍候"),e.status==4&&(n="提取失败, 无法查看详情"),q.error(n)},B=w(null),G=()=>{B.value.show()},j=w(null),X=e=>{j.value.show({...e})},d=(e,n)=>{let c=T.getToken,g=`/manage/exportFAQFileAllQA?id=${n}&token=${c}&ext=${e}`;window.location.href=g},te=w(null),le=e=>{te.value.show({...e})},V=w([]),ie=async()=>{we().then(e=>{V.value=e.data||[]})};return ve(async()=>{await ie(),z()}),ke(()=>{Object.keys(F).forEach(e=>{clearInterval(F[e])}),F={}}),(e,n)=>{const c=Pe,g=Be,U=Ke,H=We,ue=Je,de=Ge,re=Xe;return i(),u(R,null,[m("div",kt,[t(Oe,{class:"mb-16",tabs:y.value,active:"/ai-extract-faq/list"},null,8,["tabs"]),t(Se,{style:{"margin-bottom":"16px"},title:"使用说明"},{default:s(()=>[...n[0]||(n[0]=[m("div",null,[m("p",null," 1、文档拆分成若干大段落，然后由大模型从大段落中抽取问答对。问答对类型的只是由很高的检索精度，但是大模型提取问答对的过程中也可能会导致部分细节丢失。 "),m("p",null," 2、提取成功的文档，您可以下载到本地查看（系统会自动保存成docx格式），也可以直接导入到指定的问答知识库中。 ")],-1)])]),_:1}),m("div",ht,[r.value?(i(),u("div",gt,[t(c,{onClick:G,type:"primary",icon:t(S(Ee))},{default:s(()=>[...n[1]||(n[1]=[h("上传文档提取",-1)])]),_:1},8,["icon"])])):$("",!0),m("div",yt,[t(re,{"data-source":f.value,loading:b.value,pagination:{current:x.page,total:x.total,pageSize:x.size,showQuickJumper:!0,showSizeChanger:!0,pageSizeOptions:["10","20","50","100"]},onChange:p,scroll:{x:800}},{default:s(()=>[t(g,{key:"file_name","data-index":"file_name",title:"原始文档",width:200},{default:s(({record:o})=>[m("a",{onClick:A=>P(o)},C(o.file_name),9,xt)]),_:1}),t(g,{key:"status",title:"状态",width:140},{default:s(({record:o})=>[o.status==0?(i(),u("div",bt,[t(S(je)),n[2]||(n[2]=h("排队中 ",-1))])):$("",!0),o.status==1?(i(),u("div",Ct,[t(S(ae)),n[3]||(n[3]=h("文档解析中 ",-1))])):$("",!0),o.status==2?(i(),u("div",wt,[t(S(ae)),n[4]||(n[4]=h("提取中 ",-1))])):$("",!0),o.status==3?(i(),u("div",Ft,[t(S(Ve)),n[5]||(n[5]=h("提取完成 ",-1))])):$("",!0),o.status==4?(i(),u("div",$t,[t(S(He)),n[6]||(n[6]=h("提取失败 ",-1))])):$("",!0)]),_:1}),t(g,{key:"chunk_size",title:"分块方式",width:200},{default:s(({record:o})=>[o.chunk_type==1?(i(),u("div",zt,"按长度："+C(o.chunk_size),1)):$("",!0),o.chunk_type==2?(i(),u("div",Dt,[m("div",null,"按分隔符："+C(o.separators_no_desc),1),m("div",null,"最大长度："+C(o.chunk_size),1)])):$("",!0)]),_:1}),t(g,{key:"count",title:"总分块数",width:110},{default:s(({record:o})=>[h(C(+o.success_count+ +o.fail_count),1)]),_:1}),t(g,{key:"success_count",title:"提取成功分块数",width:140},{default:s(({record:o})=>[h(C(o.success_count),1)]),_:1}),t(g,{key:"fail_count",title:"提取失败分块数",width:140},{default:s(({record:o})=>[t(U,{gap:12},{default:s(()=>[o.fail_count>0?(i(),u("a",{key:0,onClick:A=>le(o)},C(o.fail_count),9,Ot)):(i(),u("span",St,C(o.fail_count),1)),o.status==3||o.status==4?(i(),u("a",Mt,[o.fail_count>0?(i(),N(S(Ye),{key:0,onClick:A=>E(o)},null,8,["onClick"])):$("",!0)])):$("",!0)]),_:2},1024)]),_:1}),t(g,{key:"qa_count",title:"提取问答对数量",width:140},{default:s(({record:o})=>[m("a",{onClick:A=>P(o)},C(o.qa_count),9,It)]),_:1}),t(g,{key:"create_time_desc",title:"上传时间",width:150},{default:s(({record:o})=>[h(C(o.create_time_desc),1)]),_:1}),t(g,{key:"key7",title:"操作",width:190,fixed:"right"},{default:s(({record:o})=>[t(U,{gap:16},{default:s(()=>[o.status==3?(i(),N(de,{key:0},{overlay:s(()=>[t(ue,null,{default:s(()=>[t(H,{onClick:A=>d("docx",o.id),key:"1"},{default:s(()=>[...n[7]||(n[7]=[h("下载为docx",-1)])]),_:1},8,["onClick"]),t(H,{onClick:A=>d("xlsx",o.id),key:"2"},{default:s(()=>[...n[8]||(n[8]=[h("下载为xlsx",-1)])]),_:1},8,["onClick"])]),_:2},1024)]),default:s(()=>[t(c,{size:"small",type:"link",style:{padding:"0"}},{default:s(()=>[...n[9]||(n[9]=[h("下载",-1)])]),_:1})]),_:2},1024)):(i(),N(c,{key:1,disabled:"",size:"small",type:"link",style:{padding:"0"}},{default:s(()=>[...n[10]||(n[10]=[h("下载",-1)])]),_:1})),t(c,{onClick:A=>X(o),disabled:o.status!=3,size:"small",type:"link",style:{padding:"0"}},{default:s(()=>[...n[11]||(n[11]=[h("导入问答库",-1)])]),_:1},8,["onClick","disabled"]),t(c,{onClick:A=>Q(o),size:"small",type:"link",style:{padding:"0"}},{default:s(()=>[...n[12]||(n[12]=[h("删除",-1)])]),_:1},8,["onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data-source","loading","pagination"])])])]),t(dt,{separatorsOptions:V.value,ref_key:"uploadDocumentRef",ref:B,onOk:v},null,8,["separatorsOptions"]),t(tt,{ref_key:"importKnowledgeModalRef",ref:j,onOk:z},null,512),t(vt,{ref_key:"failDetailRef",ref:te},null,512)],64)}}},Ht=J(qt,[["__scopeId","data-v-22571567"]]);export{Ht as default};
