import{f as h,r as te,o as K,w as j,Y as l,_ as o,a5 as e,k as y,a2 as w,F as R,a9 as z,u as V,a1 as se,G as U,a7 as k,q as oe,ad as ke,n as N,ae as I,y as Z,ab as Se,ag as Te,b as xe,aa as De}from"./vue-chunks-Ci-XTWEs.js";import{d as L,N as $e,q as we,J as Ce,a as Le,ah as Ee,u as Ie,v as He,a4 as Me,B as Be,E as Oe,aI as Re,M as Ae}from"./ui-antd-BWf8LxGy.js";import{_ as le}from"./empty-DkpCLaix.js";import{b as F,a$ as ee,d as Ue}from"../../index-BZRrEp3V.js";import{_ as qe}from"./index-AGdtDeuS.js";import{u as Ne}from"./robot-ChheCicf.js";import{u as ze}from"./chat-PhIeNawd.js";import{c as Ve}from"./index-7T5SviPf.js";import"./utils-ChQO-_r6.js";import"./index-BOvAmdHY.js";import"./useEventBus-BwH2zX88.js";import"./useIM-BjK15RNY.js";import"./index-BpTkDq9_.js";const Pe={class:"zm-date"},Ye={class:"date-btn"},je={class:"date-content"},Fe={__name:"date",props:{datekey:{type:String,default:"1"}},emits:["dateChange"],setup(H,{emit:M}){const x=H,p=h(1),v=M;let S=te([{label:"今日",value:!0,key:2,start_time:L().startOf("day"),end_time:L().endOf("day")},{label:"昨日",value:!1,key:3,start_time:L().subtract(1,"day").startOf("day"),end_time:L().startOf("day").subtract(1,"millisecond")},{label:"近7日",value:!1,key:4,start_time:L().subtract(6,"day").startOf("day"),end_time:L().endOf("day").subtract(1,"millisecond")}]);const g=h(null),a=h(null),f=h([]),i=b=>b>=L().subtract(0,"day"),D=()=>{let b=p.value,c=null;S.forEach(r=>{r.key==b&&(c=r)}),c&&(f.value=[c.start_time,c.end_time],g.value=c.start_time.unix(),a.value=c.end_time.unix()),O()},B=b=>{const c=L(b[0]).startOf("day");if(L(b[1]).endOf("day").diff(c,"days")>29)f.value[0]=b[0].startOf("day"),f.value[1]=c.add(29,"days").endOf("day"),g.value=f.value[0].unix(),a.value=f.value[1].unix(),Le.error("最多只能选择30天");else{const m=L(b[0]).startOf("day").unix(),$=L(b[1]).endOf("day").unix();f.value=b,g.value=m,a.value=$}p.value=1,O()},O=()=>{v("dateChange",{start_time:g.value,end_time:a.value})};return K(()=>{p.value=parseInt(x.datekey),D()}),j(()=>x.datekey,(b,c)=>{p.value=parseInt(x.datekey.split("-")[0]),D()}),(b,c)=>{const r=$e,m=we,$=Ce;return o(),l("div",Pe,[e("div",Ye,[y(m,{value:p.value,"onUpdate:value":c[0]||(c[0]=s=>p.value=s),onChange:D},{default:w(()=>[(o(!0),l(R,null,z(V(S),s=>(o(),se(r,{class:"date-btn-button",value:s.key,key:s.key},{default:w(()=>[U(k(s.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),e("div",je,[y($,{value:f.value,"onUpdate:value":c[1]||(c[1]=s=>f.value=s),onChange:B,format:"YYYY-MM-DD",disabledDate:i,allowClear:!1},null,8,["value"])])])}}},Ge={key:0,class:"empty-box"},Je=["onClick"],Ke={class:"user-item-left"},Qe=["src"],We={class:"user-item-right"},Xe={class:"user-name-box"},Ze={class:"user-name"},et={class:"user-timer"},tt={class:"user-info"},st={class:"user-source-box"},ot={class:"user-source-content"},lt={__name:"user",props:{userList:{type:Array,default:null},channelItem:{type:Array,default:null}},emits:["userClick","userScroll","userScrollStart","userScrollEnd"],setup(H,{emit:M}){const x=h(null),p=H,v=M,S=h([]),g=h([]),a=h({}),f=r=>{a.value=r,v("userClick",r)},i={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let D=null;function B(r){D&&(clearTimeout(D),D=null),D=setTimeout(()=>{i.scrollTop-r.target.scrollTop>0&&(i.scrollDirection="up"),i.scrollTop-r.target.scrollTop<0&&(i.scrollDirection="down"),i.scrollTop=r.target.scrollTop,i.scrollHeight=r.target.scrollHeight,i.clientHeight=r.target.clientHeight,v("userScroll",{...i}),Math.abs(i.scrollTop)<=i.scrollStartDiff+100&&i.scrollDirection==="up"&&O(),Math.abs(i.scrollHeight-i.scrollTop-i.clientHeight)<=i.scrollEndDiff&&i.scrollDirection==="down"&&b()},50)}function O(){p.userList.length!=0&&v("userScrollStart",{msg:p.userList[0]})}function b(){p.userList.length!=0&&v("userScrollEnd",{msg:p.userList[p.userList.length-1]})}j(()=>p.userList,r=>{S.value=r,S.value.length>0&&S.value.length<=20&&(f(S.value[0]),a.value=S.value[0])},{immediate:!0}),j(()=>p.channelItem,r=>{g.value=r},{immediate:!0});const c=r=>{for(let m=0;m<g.value.length;m++)if(r.app_type==g.value[m].app_type&&(r.app_id||"")==g.value[m].app_id)return g.value[m].app_name};return K(()=>{S.value=p.userList,g.value=p.channelItem}),(r,m)=>{const $=oe("ftime");return o(),l("div",{class:"user-content",ref_key:"scrollUserBoxRef",ref:x,onScroll:B},[S.value.length===0?(o(),l("div",Ge,m[0]||(m[0]=[e("img",{src:le,alt:""},null,-1),e("div",{class:"title"},"暂无结果，请重试",-1)]))):(o(!0),l(R,{key:1},z(S.value,s=>(o(),l("div",{class:ke(["user-item",{active:s.openid==a.value.openid}]),onClick:t=>f(s),key:s.session_id},[e("div",Ke,[e("img",{class:"user-img",src:s.avatar,alt:""},null,8,Qe)]),e("div",We,[e("div",Xe,[e("div",Ze,k(s.name),1),N((o(),l("div",et,[U(k(s.last_chat_time),1)])),[[$,"MM-DD HH:mm"]])]),e("div",tt,k(s.last_chat_message),1),e("div",st,[m[1]||(m[1]=e("div",{class:"user-source-title"},"来自：",-1)),e("div",ot,k(c(s)),1)])])],10,Je))),128))],544)}}},at=F(lt,[["__scopeId","data-v-cd7bf51c"]]),nt={class:"message-box"},rt={class:"message-top-box"},it={class:"message-top-title"},ct={key:0,class:"message-top-source"},ut={class:"message-list"},dt={key:0,class:"empty-box"},_t=["id"],pt={class:"itme-right"},mt={class:"message-info"},vt={class:"item-body"},gt={key:0,class:"message-content"},ft=["src"],yt={key:1,class:"message-content"},ht={class:"user-avatar-box"},bt=["src"],kt=["id"],St={class:"itme-left"},Tt=["src"],xt={class:"itme-right"},Dt={class:"message-info"},$t={key:0,class:"reply-list"},wt={key:0,class:"reply-item reply-text"},Ct=["innerHTML"],Lt={key:1,class:"reply-item reply-image"},Et={class:"message-content"},It=["src"],Ht={key:2,class:"reply-item reply-url"},Mt={class:"url-row"},Bt=["href"],Ot={key:3,class:"reply-item reply-card"},Rt={class:"card-row"},At=["src"],Ut={class:"card-title-box"},qt={class:"card-title"},Nt={key:4,class:"reply-item reply-imageText"},zt=["href"],Vt=["src"],Pt={class:"imageText-text"},Yt={class:"imageText-title"},jt={class:"imageText-desc"},Ft={key:1,class:"item-body"},Gt={key:0,class:"message-content"},Jt=["innerHTML"],Kt={key:2,class:"message-content"},Qt=["src"],Wt={key:2,class:"loading-box"},Xt={__name:"message-list",props:{messages:{type:Array,default:()=>[]},robotInfo:{type:Object,default:()=>{}},isEmpty:{type:Boolean,default:()=>!1},sessionSource:{type:String,default:()=>null},channelItem:{type:Array,default:()=>[]}},emits:["scroll","scrollStart","scrollEnd"],setup(H,{expose:M,emit:x}){const p=x,v=H,S=h(!1),g=h(null),a={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let f=null,i=!1;const D=s=>{let t;for(let T=0;T<v.channelItem.length;T++){const C=v.channelItem[T];C.app_type===s&&(t=C.app_name)}return t};function B(s){i||(f&&(clearTimeout(f),f=null),f=setTimeout(()=>{a.scrollTop-s.target.scrollTop>0&&(a.scrollDirection="up"),a.scrollTop-s.target.scrollTop<0&&(a.scrollDirection="down"),a.scrollTop=s.target.scrollTop,a.scrollHeight=s.target.scrollHeight,a.clientHeight=s.target.clientHeight,p("scroll",{...a}),Math.abs(a.scrollTop)<=a.scrollStartDiff&&a.scrollDirection==="up"&&O(),Math.abs(a.scrollHeight-a.scrollTop-a.clientHeight)<=a.scrollEndDiff&&a.scrollDirection==="down"&&b()},100))}function O(){v.messages.length!=0&&p("scrollStart",{msg:v.messages[0]})}function b(){v.messages.length!=0&&p("scrollEnd",{msg:v.messages[v.messages.length-1]})}const c=()=>{g.value&&Z(()=>{i=!0,g.value.scrollTop=g.value.scrollHeight+1,setTimeout(()=>{a.scrollTop=g.value.scrollTop,i=!1},50)})};function r(s,t){Z(()=>{i=!0,t||(t="top");let T=g.value,C=document.querySelector("#msg-"+s);C&&(t=="top"?T.scrollTop=C.offsetTop:T.scrollTop=C.offsetTop-T.clientHeight+C.clientHeight),setTimeout(()=>{a.scrollTop=g.value.scrollTop,i=!1},50)})}function m(){a.scrollTop=0,a.scrollDirection=""}function $(s){try{return s?Array.isArray(s)?s:typeof s=="string"?JSON.parse(s||"[]"):[]:[]}catch{return[]}}return M({scrollToBottom:c,scrollToMessage:r,resetScroll:m}),(s,t)=>{const T=Ee,C=Ue,A=oe("viewer");return o(),l("div",nt,[e("div",rt,[e("div",it,k(v.robotInfo.robot_name),1),H.sessionSource?(o(),l("div",ct,"("+k(D(H.sessionSource))+")",1)):I("",!0)]),e("div",{class:"message-list-wrapper",ref_key:"scrollBoxRef",ref:g,onScroll:B},[e("div",ut,[v.isEmpty||!v.messages?(o(),l("div",dt,t[0]||(t[0]=[e("img",{src:le,alt:""},null,-1),e("div",{class:"title"},"暂无结果，请重试",-1)]))):(o(!0),l(R,{key:1},z(v.messages,n=>(o(),l(R,{key:n.uid},[n.is_customer==1?(o(),l("div",{key:0,class:"message-item user-message",id:"msg-"+n.uid},[e("div",pt,[e("div",mt,[e("span",null,k(V(ee)(n.create_time)),1),e("span",null,k(n.name),1)]),e("div",vt,[n.received_message_type=="image"&&n.media_id_to_oss_url?(o(),l("div",gt,[N(e("img",{class:"msg-img",src:n.media_id_to_oss_url,alt:""},null,8,ft),[[A]])])):(o(),l("div",yt,k(n.content),1))])]),e("div",ht,[e("img",{class:"user-avatar",src:n.avatar},null,8,bt)])],8,_t)):(o(),l("div",{key:1,class:"message-item robot-message",id:"msg-"+n.uid},[e("div",St,[y(T,{size:"small",spinning:n.loading},{default:w(()=>[e("img",{class:"robot-avatar",src:n.robot_avatar},null,8,Tt)]),_:2},1032,["spinning"])]),e("div",xt,[e("div",Dt,[e("span",null,k(V(ee)(n.create_time)),1),e("span",null,k(n.name),1)]),$(n.reply_content_list).length?(o(),l("div",$t,[(o(!0),l(R,null,z($(n.reply_content_list),(u,G)=>(o(),l(R,{key:G},[(u.reply_type||u.type)==="text"?(o(),l("div",wt,[e("div",{class:"message-content",innerHTML:u.description},null,8,Ct)])):(u.reply_type||u.type)==="image"?(o(),l("div",Lt,[e("div",Et,[N(e("img",{class:"msg-img",src:u.pic||u.thumb_url},null,8,It),[[A]])])])):(u.reply_type||u.type)==="url"?(o(),l("div",Ht,[e("div",Mt,[e("a",{class:"url-link",href:u.url,target:"_blank"},k(u.url),9,Bt)])])):(u.reply_type||u.type)==="card"?(o(),l("div",Ot,[e("div",Rt,[u.thumb_url?(o(),l("img",{key:0,src:u.thumb_url,class:"card-thumb"},null,8,At)):I("",!0),e("div",Ut,[y(C,{class:"think-icon",name:"applet"}),e("span",qt,k(u.title),1)])])])):(u.reply_type||u.type)==="imageText"?(o(),l("div",Nt,[e("a",{class:"imageText-row",href:u.url,target:"_blank"},[u.thumb_url?(o(),l("img",{key:0,src:u.thumb_url,class:"imageText-thumb"},null,8,Vt)):I("",!0),e("div",Pt,[e("div",Yt,k(u.title),1),e("div",jt,k(u.description),1)])],8,zt)])):I("",!0)],64))),128))])):I("",!0),n.msg_type==1&&n.content==""?I("",!0):(o(),l("div",Ft,[n.msg_type==1?N((o(),l("div",Gt,[y(qe,{content:n.content},null,8,["content"])])),[[A]]):I("",!0),n.msg_type==2?(o(),l("div",{key:1,class:"message-content",innerHTML:n.menu_json.content},null,8,Jt)):I("",!0),n.msg_type==3?(o(),l("div",Kt,[N(e("img",{class:"msg-img",src:n.content,alt:""},null,8,Qt),[[A]])])):I("",!0)]))])],8,kt))],64))),128)),S.value?(o(),l("div",Wt,[y(T)])):I("",!0)])],544)])}}},Zt=F(Xt,[["__scopeId","data-v-3d2d6423"]]),es={class:"team-members-pages"},ts={class:"set-model"},ss={class:"set-model-body"},os={class:"set-date"},ls={class:"set-date-body"},as={class:"set-name"},ns={class:"set-reset"},rs={class:"list-box"},is={class:"user-box"},cs={class:"records-box"},us={__name:"session-record",setup(H){const M=h(!1),x=De(),p=Se(),v=p.query,S=Ne(),{robotInfo:g}=S,a=ze(),{messageList:f}=Te(a);let i=!0;const{createMsg:D,onGetChatMessage:B,getRecordList:O,getChannelList:b}=a,c=h(null),r=h([]),m=h([]),$=h(""),s=h("1"),t=te({robot_id:v.id,app_type:"all",app_id:"all",start_time:"",end_time:"",name:"",page:1,size:20}),T=h(!1),C=d=>{t.start_time=d.start_time,t.end_time=d.end_time,J()},A=()=>{t.app_type="all",t.name="",t.page=1,s.value="1-"+Math.random()},n=h(!1),u=h(!1),G=async()=>{let d=Q();u.value=!0,await Ve(d),n.value=!0,u.value=!1},ae=()=>{x.push({path:"/robot/config/export-record",query:v})},J=()=>{t.page=1,W()},ne=d=>{t.app_type=d,J()},re=()=>{},ie=d=>{$.value=d.app_type,ve(d)},ce=async()=>{},ue=()=>{T.value&&(t.page++,W())},de=async()=>{i=!1;let d=f.value[0].uid;await B()&&pe(d)},_e=()=>{c.value&&i&&c.value.scrollToBottom()},pe=d=>{c.value&&c.value.scrollToMessage(d)},me=()=>{c.value&&c.value.resetScroll()};let P=null;const ve=async d=>{i=!0;let q={robot_key:(p.query||{}).robot_key,avatar:d.avatar,name:d.name,nickname:d.name,is_background:1,openid:d.openid};me(),await D(q),P&&(clearTimeout(P),P=null),P=setTimeout(async()=>{await B()&&_e()},100)},ge=async()=>{let d={robot_id:t.robot_id};const _=await b(d);r.value=[{app_type:"all",app_name:"全部渠道"},..._.data]},Q=()=>{let d={robot_id:t.robot_id,start_time:t.start_time,end_time:t.end_time,name:t.name,page:t.page,size:t.size};return t.app_type!=="all"&&(d.app_type=t.app_type),t.app_id!=="all"&&(d.app_id=t.app_id),d},W=async()=>{let d=Q(),_=await O(d),q=_.data.list||[];t.page==1&&(m.value=[]),m.value=[...m.value,...q],M.value=m.value.length==0,T.value=_.data.has_more};return j(()=>f.value,()=>{}),K(async()=>{ge()}),xe(()=>{}),(d,_)=>{const q=He,X=Ie,fe=Me,Y=Be,ye=Oe,he=Re,be=Ae;return o(),l("div",es,[y(ye,{justify:"flex-start",class:"screen-box"},{default:w(()=>[e("div",ts,[_[4]||(_[4]=e("div",{class:"label set-model-label"},"渠道：",-1)),e("div",ss,[y(X,{value:t.app_type,"onUpdate:value":_[0]||(_[0]=E=>t.app_type=E),placeholder:"全部渠道",onChange:ne,style:{width:"200px"}},{default:w(()=>[(o(!0),l(R,null,z(r.value,E=>(o(),se(q,{key:E.app_type,value:E.app_type},{default:w(()=>[e("span",null,k(E.app_name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])])]),e("div",os,[_[5]||(_[5]=e("div",{class:"label set-date-label"},[e("span",null,"日期：")],-1)),e("div",ls,[y(Fe,{onDateChange:C,datekey:s.value},null,8,["datekey"])])]),e("div",as,[y(fe,{value:t.name,"onUpdate:value":_[1]||(_[1]=E=>t.name=E),placeholder:"请输入用户名称搜索",style:{width:"200px"},onSearch:J},null,8,["value"])]),e("div",ns,[y(Y,{onClick:A},{default:w(()=>_[6]||(_[6]=[U("重置")])),_:1,__:[6]}),y(Y,{onClick:G,loading:u.value},{default:w(()=>_[7]||(_[7]=[U("导出")])),_:1,__:[7]},8,["loading"])])]),_:1}),e("div",rs,[e("div",is,[y(at,{channelItem:r.value,userList:m.value,onUserScrollStart:ce,onUserScrollEnd:ue,onUserClick:ie},null,8,["channelItem","userList"])]),e("div",cs,[y(Zt,{ref_key:"messageListRef",ref:c,isEmpty:M.value,messages:V(f),robotInfo:V(g),channelItem:r.value,sessionSource:$.value,onScrollStart:de,onScrollEnd:re},null,8,["isEmpty","messages","robotInfo","channelItem","sessionSource"])])]),y(be,{open:n.value,"onUpdate:open":_[3]||(_[3]=E=>n.value=E),title:null,footer:null,width:640},{default:w(()=>[y(he,{status:"success",title:"导出任务创建成功","sub-title":"系统会在后台导出。导出数据量越大，耗时越久。您可以稍后点击导出记录查看并下载导出的文件。"},{extra:w(()=>[y(Y,{style:{"margin-right":"16px"},onClick:_[2]||(_[2]=E=>n.value=!1)},{default:w(()=>_[8]||(_[8]=[U("知道了")])),_:1,__:[8]}),y(Y,{onClick:ae,type:"primary"},{default:w(()=>_[9]||(_[9]=[U("去下载")])),_:1,__:[9]})]),_:1})]),_:1},8,["open"])])}}},ds=F(us,[["__scopeId","data-v-4f2d74bb"]]),_s={class:"user-model-page"},ps={class:"list-wrapper"},ms={__name:"index",setup(H){return(M,x)=>(o(),l("div",_s,[x[0]||(x[0]=e("div",{class:"page-title"},"会话记录",-1)),e("div",ps,[y(ds)])]))}},Cs=F(ms,[["__scopeId","data-v-705cfb21"]]);export{Cs as default};
