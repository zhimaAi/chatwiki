import{ah as ye,r as i,j as xe,c as Se,J as we,a as q,q as R,p as c,y as o,t as b,u as m,v as f,e as qe,_ as C,F as K,l as Le,ag as Fe,x as De,b as y,h as Ne}from"./vue-chunks-BdaA73Wf.js";import{S as ze,E as Te,a as Ee,D as Ce}from"./edit-fragment-alert-D8mTY6SS.js";import{u as Oe,aD as Ie,bw as Je,bx as Ae,by as Be,bz as je,bA as Re,bB as Me}from"../../index-DSFcP5NQ.js";import{u as Ve}from"./useMathJax-6Oa0Io1D.js";import{_ as Pe}from"./emoji-mart-BBMRoEa3.js";import{ag as Qe,j as $e,e as Ue,M as O,b as X,k as We,O as Y}from"./ui-antd-Dl1wwwCD.js";import"./editor-cherry-CFIsbKoN.js";import"./empty-CzGZrENG.js";import"./model-select-CMPvMrAQ.js";import"./index-MT9fcN3v.js";import"./editor-code-DlsHKXTn.js";import"./index-XVLbk3qE.js";import"./index-B_UHbFfL.js";import"./other-LrIFyvU9.js";import"./neo4j-MWxXN7EM.js";import"./lodash-Bm5sK6rN.js";import"./elkjs-BN8GIjVH.js";import"./utils-CvB22N-W.js";const Ge={key:0,class:"loading-wrap"},He={class:"document-segmentation"},Ke={class:"breadcrumb-block"},Xe={class:"page-title"},Ye={class:"title"},Ze={class:"page-container"},ea={class:"page-left"},aa={class:"page-right"},ta={class:"document-fragment-preview"},na={class:"preview-header"},_a={class:"label-text"},la={class:"fragment-number"},ia={key:1,class:"loading-box"},oa={__name:"document-segmentation",setup(sa){const{t:_}=Oe("views.library.document-segmentation.document-segmentation"),Z=Ie(),I=ye(),J=Fe(),{renderMath:ee}=Ve(),{setInitDocumentFragmentList:M}=Z,{document_id:L}=I.query,F=i(!0),D=i(1),ae=i(1);let x=!1;const te=_("default_ai_chunk_prompt");let t={id:L,separators_no:"",chunk_size:512,not_merged_text:!1,chunk_overlap:50,is_qa_doc:0,question_lable:"",similar_label:"",answer_lable:"",enable_extract_image:!0,ai_chunk_size:5e3,ai_chunk_model:"",ai_chunk_model_config_id:"",ai_chunk_prumpt:te,ai_chunk_task_id:""};const h=i(null),ne=e=>{typeof e.separators_no=="object"&&(e.separators_no=JSON.stringify(e.separators_no)),typeof e.father_chunk_separators_no=="object"&&(e.father_chunk_separators_no=JSON.stringify(e.father_chunk_separators_no)),typeof e.son_chunk_separators_no=="object"&&(e.son_chunk_separators_no=JSON.stringify(e.son_chunk_separators_no)),t={...t,...e},x?O.confirm({title:_("alert_reminder"),icon:o(Y),content:_("alert_content_changed"),okText:_("alert_confirm"),okType:"danger",cancelText:_("alert_cancel"),onOk(){x=!1,E("create")},onCancel(){}}):(x=!1,E("create"))};let _e=600,V=0,P=null;const N=i({}),z=i(0),Q=()=>{F.value||(F.value=!0),Je({id:L}).then(async e=>{const{status:a}=e.data;if(z.value=e.data.library_type,N.value=e.data,t={...t,separators_no:e.data.separators_no||"[12,11]",chunk_size:+e.data.chunk_size||512,not_merged_text:e.data.not_merged_text=="true",ai_chunk_size:+e.data.ai_chunk_size||5e3,chunk_overlap:+e.data.chunk_overlap||50,is_qa_doc:z.value==2?1:0,question_lable:e.data.question_lable,similar_label:e.data.similar_label,answer_lable:e.data.answer_lable,question_column:e.data.question_column,similar_column:e.data.similar_column,answer_column:e.data.answer_column,enable_extract_image:e.data.enable_extract_image=="true",qa_index_type:+e.data.qa_index_type,chunk_type:+e.data.chunk_type,semantic_chunk_size:+e.data.semantic_chunk_size||512,semantic_chunk_overlap:+e.data.semantic_chunk_overlap||50,semantic_chunk_threshold:+e.data.semantic_chunk_threshold||90,semantic_chunk_use_model:e.data.semantic_chunk_use_model||"",ai_chunk_prumpt:e.data.ai_chunk_prumpt||"",ai_chunk_model:e.data.ai_chunk_model||"",semantic_chunk_model_config_id:e.data.semantic_chunk_model_config_id>0?e.data.semantic_chunk_model_config_id:"",ai_chunk_model_config_id:e.data.ai_chunk_model_config_id>0?e.data.ai_chunk_model_config_id:"",ai_chunk_task_id:e.data.ai_chunk_task_id||"",father_chunk_paragraph_type:+e.data.father_chunk_paragraph_type||2,father_chunk_separators_no:e.data.father_chunk_separators_no||"[12,11]",father_chunk_chunk_size:+e.data.father_chunk_chunk_size||1024,son_chunk_separators_no:e.data.son_chunk_separators_no||"[8,10]",son_chunk_chunk_size:+e.data.son_chunk_chunk_size||512},e.data.chunk_type==0&&(t={...t,separators_no:e.data.normal_chunk_default_separators_no,chunk_size:e.data.normal_chunk_default_chunk_size,not_merged_text:e.data.normal_chunk_default_not_merged_text=="true",chunk_overlap:e.data.normal_chunk_default_chunk_overlap,chunk_type:+e.data.default_chunk_type,semantic_chunk_size:+e.data.semantic_chunk_default_chunk_size,semantic_chunk_overlap:+e.data.semantic_chunk_default_chunk_overlap,semantic_chunk_threshold:+e.data.semantic_chunk_default_threshold,semantic_chunk_use_model:e.data.default_use_model||"",semantic_chunk_model_config_id:e.data.default_model_config_id>0?e.data.default_model_config_id:""}),a==0){if(V++,V>_e){O.error({title:_("alert_reminder"),content:_("alert_parse_slow")});return}setTimeout(()=>{Q()},1e3)}else a==4||a==2?(F.value=!1,D.value=parseInt(e.data.is_table_file),P=e.data.library_id,z.value==2?(t.question_lable||t.question_column)&&E():E()):J.replace("/library/details?id="+e.data.library_id);e.data.is_table_file==1&&le()})};xe(async()=>{await Q()});const $=i([]),le=()=>{Be({id:L}).then(e=>{let a=[];for(let n in e.data)a.push({lable:e.data[n],value:n});$.value=a})},U=i(!1),S=i(!1),A=i(""),w=i(null);let p=null;const l=i([]),T=i([]),k=i(0),ie=Se(()=>k.value<=0),E=e=>{let a={...t,semantic_chunk_model_config_id:t.semantic_chunk_model_config_id?+t.semantic_chunk_model_config_id:0,ai_chunk_model_config_id:t.ai_chunk_model_config_id?+t.ai_chunk_model_config_id:0};t.chunk_type==3&&(t.ai_chunk_task_id&&!e&&(a.ai_chunk_task_id=t.ai_chunk_task_id),e&&e==="create"&&(a.ai_chunk_preview=!0,delete a.ai_chunk_task_id));let n=Ae;return e=="create"&&(n=Me),n(a).then(s=>{var d;T.value=s.data.list||[],M(T.value),l.value=s.data.list||[],k.value=s.data.list.length||0,ee(j.value),t.chunk_type==3&&(A.value=((d=s.data.split_params)==null?void 0:d.ai_chunk_task_id)||"",S.value=!0,h.value.reLoading=!0,w.value=null,!t.ai_chunk_task_id&&D.value!=1||e&&e==="create"?(l.value=[],k.value=0,ue()):(S.value=!1,h.value.reLoading=!1))}).finally(()=>{t.chunk_type!=3&&(h.value.reLoading=!1,h.value.saveLoading=!1)})},oe=e=>{ae.value=e},se=async()=>{var e;try{const a=await ce();return a.data.err_msg?(w.value=a.data.err_msg,!0):((e=a.data.list)==null?void 0:e.length)>0?(T.value=a.data.list||[],M(T.value),l.value=a.data.list||[],k.value=a.data.list.length||0,!0):!1}catch{return w.value=_("message_request_exception"),!0}};function re(e){return e.split("message:")[1]}const ue=()=>{const e=async()=>{if(!await se())p=setTimeout(e,3e3);else if(S.value=!1,h.value.reLoading=!1,h.value.saveLoading=!1,p!==null&&(clearTimeout(p),p=null),U.value&&H(),w.value){let n=re(w.value);O.error({title:_("alert_segmentation_failed"),content:n?_("alert_model_failed_reason",{reason:n}):_("alert_model_failed")})}};e()},ce=()=>Re({id:t.id,task_id:A.value}),W=i(null);let u=null;const de=(e,a)=>{let{title:n,content:s,question:d,answer:g,images:r,similar_question_list:v}=e;u=a,W.value.open({title:n,content:s,question:d,answer:g,images:r,similar_question_list:v})},me=({title:e,content:a,question:n,answer:s,images:d,similar_question_list:g})=>{(l.value[u].title!=e||l.value[u].content!=a||l.value[u].question!=n||l.value[u].answer!=s)&&(x=!0),l.value[u].title=e,l.value[u].content=a,l.value[u].question=n,l.value[u].answer=s,l.value[u].images=d,l.value[u].similar_question_list=g?g.split(`
`):[],l.value[u].word_total=s.length+n.length+a.length},he=e=>{O.confirm({title:_("alert_reminder"),icon:o(Y),content:_("alert_delete_fragment"),okText:_("alert_confirm"),okType:"danger",cancelText:_("alert_cancel"),onOk(){x=!0,l.value.splice(e,1)},onCancel(){}})},B=i(""),fe=e=>{B.value=e},G=i(!1),pe=()=>{let e=h.value.formState;e=JSON.parse(JSON.stringify(e)),typeof e.separators_no=="object"&&(e.separators_no=JSON.stringify(e.separators_no)),typeof e.father_chunk_separators_no=="object"&&(e.father_chunk_separators_no=JSON.stringify(e.father_chunk_separators_no)),typeof e.son_chunk_separators_no=="object"&&(e.son_chunk_separators_no=JSON.stringify(e.son_chunk_separators_no)),t={...t,...e}},H=async()=>{if(pe(),B.value)return X.error(B.value);if(t.chunk_type==3&&!l.value.length)return U.value=!0,!1;A.value!==t.ai_chunk_task_id&&delete t.ai_chunk_task_id;let e={...t,chunk_async:!0,semantic_chunk_model_config_id:t.semantic_chunk_model_config_id?+t.semantic_chunk_model_config_id:0,ai_chunk_model_config_id:t.ai_chunk_model_config_id?+t.ai_chunk_model_config_id:0,is_table_file:D.value};delete e.id;let a={id:L,chunk_async:!0,word_total:k.value,split_params:JSON.stringify(e),list:JSON.stringify(l.value)};e.is_qa_doc==1&&(a.qa_index_type=e.qa_index_type),G.value=!0,je(a).then(()=>{X.success(_("message_save_success"));let n=1;I.query.page&&(n=I.query.page),J.replace("/library/details?id="+P+"&page="+n)}).finally(()=>{G.value=!1}).catch(n=>{n.data&&n.data.index&&ke(n.data.index)})},j=i(null),ke=e=>{e=e-1;let a=j.value.querySelectorAll(".fragment-item");a.length>=e&&a[e].scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},ge=()=>{J.back()};function ve(e,a){if(t.chunk_type!=4||a==0)return!1;let n=l.value[a-1];return e.father_chunk_paragraph_number==n.father_chunk_paragraph_number}return we(()=>{p&&(clearTimeout(p),p=null)}),(e,a)=>{const n=Qe,s=De("router-link"),d=We,g=$e;return y(),q(K,null,[F.value?(y(),q("div",Ge,[o(n)])):R("",!0),c("div",He,[c("div",Ke,[o(g,null,{default:b(()=>[o(d,null,{default:b(()=>[o(s,{to:"/library/list"},{default:b(()=>[C(f(m(_)("breadcrumb_knowledge_base")),1)]),_:1})]),_:1}),o(d,null,{default:b(()=>[o(s,{to:{path:"/library/details/knowledge-document",query:{id:N.value.library_id}}},{default:b(()=>[C(f(N.value.library_name)+f(m(_)("breadcrumb_knowledge_base_suffix")),1)]),_:1},8,["to"])]),_:1}),o(d,null,{default:b(()=>[C(f(m(_)("breadcrumb_segmentation_setting")),1)]),_:1})]),_:1})]),c("div",Xe,[o(m(Ue),{onClick:ge}),c("span",Ye,f(m(_)("page_title")),1)]),c("div",Ze,[c("div",ea,[o(ze,{excellQaLists:$.value,libFileInfo:N.value,library_type:z.value,mode:D.value,ref_key:"segmentationSettingRef",ref:h,onChange:ne,onChangeChunkType:oe,onSave:H,onValidate:fe},null,8,["excellQaLists","libFileInfo","library_type","mode"])]),c("div",aa,[c("div",ta,[c("div",na,[c("span",_a,f(m(_)("segmentation_preview")),1),c("span",la,f(m(_)("fragment_total",{total:k.value})),1)]),ie.value&&!S.value?(y(),qe(Ee,{key:0})):R("",!0),S.value?(y(),q("div",ia,[o(n),C(f(m(_)("data_processing")),1)])):R("",!0),c("div",{class:"preview-box",ref_key:"previewBoxRef",ref:j},[(y(!0),q(K,null,Le(l.value,(r,v)=>(y(),q("div",{class:Ne(["fragment-item",{"fragment-father-son-item":m(t).chunk_type==4}]),key:v},[o(Ce,{chunk_type:m(t).chunk_type,father_chunk_paragraph_number:r.father_chunk_paragraph_number,number:r.number,title:r.title,content:r.content,total:r.word_total,question:r.question,answer:r.answer,images:r.images,isNeedDashedLine:ve(r,v),similar_question_list:r.similar_question_list,onDelete:be=>he(v),onEdit:be=>de(r,v)},null,8,["chunk_type","father_chunk_paragraph_number","number","title","content","total","question","answer","images","isNeedDashedLine","similar_question_list","onDelete","onEdit"])],2))),128))],512)])])]),o(Te,{ref_key:"editFragmentAlertRef",ref:W,onOk:me},null,512)])],64)}}},Fa=Pe(oa,[["__scopeId","data-v-477403ab"]]);export{Fa as default};
//# sourceMappingURL=document-segmentation-BPNj8Ss0.js.map
