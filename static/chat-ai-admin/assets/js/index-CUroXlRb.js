import{b as le,b8 as Qe,d as ue,an as He,ao as Je}from"../../index-0TFHdij1.js";import{f as k,ab as K,aa as re,o as pe,y as Ze,b as Xe,e as et,r as tt,Y as p,_ as o,a5 as l,k as u,ae as g,ad as ee,a1 as z,F,a9 as G,a7 as w,a2 as d,G as C,u as N,n as st,A as nt,m as at}from"./vue-chunks-CXJTX1FC.js";import{e as _e}from"./index-DvPlhmYy.js";import{M as it}from"./multi-reply-BhaR3qEc.js";import{a as ot,C as te,D as lt,E as se,F as ut,G as rt,x as ne}from"./index-lMQ5W3Uj.js";import{Y as pt,B as ce,$ as _t,Z as ct,k as de,a1 as ae,u as dt,Q as yt,E as mt,p as ht,ac as ie,x as vt,q as bt,R as ft,d as kt,a as x,M as oe}from"./ui-antd-D3ZAJ1Vq.js";import{L as gt}from"./list-empty-BB4jo9v7.js";import"./utils-yZpnICoG.js";import"./index-BAHM4xhG.js";const wt={class:"user-model-page"},xt={class:"breadcrumb-wrap"},Ct={class:"mp-list-block"},Rt=["onClick"],St=["src"],At={class:"mp-name"},Lt={key:0},$t={key:1},Tt={key:2},It={key:0,class:"search-block"},Dt={class:"left-block"},zt={class:"search-item"},Et={key:1,class:"list-box"},Bt={key:0},qt={key:1},Nt={key:2},Mt={key:0,style:{color:"#595959"}},Ot={key:1,style:{color:"#595959"}},Ut={key:3,style:{color:"#595959"}},Pt={key:4,style:{color:"#595959","white-space":"pre-wrap"}},Vt=["onClick"],Yt=["onClick"],Ft=["onClick"],Wt={key:2,class:"reply-editor"},jt={class:"switch-box"},Gt={class:"nav-box"},Kt={class:"reply-main"},Qt={class:"content-box"},Ht={class:"item-box"},Jt={class:"method-box"},Zt={style:{"margin-top":"8px"}},Xt=160,es=8,ts=96,ss={__name:"received-reply",setup(ye){const S=k([]),E=K().query,R=K(),A=re(),h=k(E.subscribe_rule_type||"subscribe_reply_default"),v=k([]),_=k("0"),y=k([]),m=k(""),L=k(!1),M=k(null),B=k(0);function W(){const t=M.value;if(!t){B.value=0;return}const e=t.clientWidth||0,n=Xt+es,s=Math.floor((e-ts)/n);B.value=Math.max(s,0)}const me=async()=>{var t;try{const e=await _e({app_type:"official_account",app_name:""}),n=Array.isArray(e==null?void 0:e.data)?e.data:[];y.value=n.filter(s=>s.account_is_verify=="true").map(s=>({id:s.id,appid:s.app_id,name:s.app_name,logo:s.app_avatar})),m.value=((t=y.value[0])==null?void 0:t.appid)||""}catch{y.value=[],m.value=""}};pe(async()=>{var t;try{const e=await ot({ability_type:"robot_subscribe_reply"}),n=e==null?void 0:e.data,s=String(((t=n==null?void 0:n.user_config)==null?void 0:t.switch_status)??"0");_.value=s}catch{_.value="0"}await me(),Ze(W),window.addEventListener("resize",W),h.value==="subscribe_reply_default"&&U()}),Xe(()=>{window.removeEventListener("resize",W)});const he=[{title:"关注来源",dataIndex:"subscribe_source",key:"subscribe_source",width:120},{title:"回复内容",dataIndex:"reply_content",key:"reply_content",width:120},{title:"回复方式",dataIndex:"reply_num",key:"reply_num",width:120},{title:"创建时间",dataIndex:"create_time",key:"create_time",width:120},{title:"启用状态",dataIndex:"switch_status",key:"switch_status",width:120},{title:"操作",dataIndex:"action",key:"action",width:120}],ve=[{title:"时间段",dataIndex:"duration",key:"duration",width:220},{title:"回复内容",dataIndex:"reply_content",key:"reply_content",width:120},{title:"回复方式",dataIndex:"reply_num",key:"reply_num",width:120},{title:"优先级",dataIndex:"priority_num",key:"priority_num",width:120},{title:"创建时间",dataIndex:"create_time",key:"create_time",width:120},{title:"启用状态",dataIndex:"switch_status",key:"switch_status",width:120},{title:"操作",dataIndex:"action",key:"action",width:120}],be=et(()=>h.value==="subscribe_reply_duration"?ve:he),f=tt({page:1,size:10,total:0}),fe=He,Q=k([]),j=k(!1),O=k(""),$=()=>{const t={rule_type:h.value,reply_type:O.value||"",appid:m.value||"",page:f.page,size:f.size};j.value=!0,te({...t}).then(e=>{const n=(e==null?void 0:e.data)||{list:[],total:0,page:f.page,size:f.size};Q.value=(n.list||[]).map(s=>({...s,reply_content:Array.isArray(s.reply_content)?s.reply_content:[],switch_status:String(s.switch_status??"0"),duration_type:s.duration_type||"",start_duration:s.start_duration||"",end_duration:s.end_duration||"",priority_num:s.priority_num??"",subscribe_source:Array.isArray(s.subscribe_source)?s.subscribe_source:[]})),f.total=+n.total||0}).finally(()=>{j.value=!1})};$();const ke=t=>{f.page=t.current,f.size=t.pageSize,$()},ge=()=>{f.page=1,$()},we=t=>{O.value=t,ge()},xe=()=>{f.page=1,$(),h.value==="subscribe_reply_default"&&U()};function Ce(t){m.value=t.appid,L.value=!0,f.page=1,$(),h.value==="subscribe_reply_default"&&U()}async function H(t){const e=Number(t.priority_num);if(!Number.isInteger(e)||e<0){x.error("请输入有效的优先级");return}try{await lt({id:t.id,priority_num:e,appid:m.value||""}),x.success("优先级已更新"),$()}catch{}}const Re=()=>{A.push({path:"/explore/index/subscribe-reply/add-rule",query:{subscribe_rule_type:h.value,appid:m.value||""}})},Se=t=>{A.push({path:"/explore/index/subscribe-reply/add-rule",query:{rule_id:t.id,appid:m.value||""}})},Ae=t=>{A.push({path:"/explore/index/subscribe-reply/add-rule",query:{copy_id:t.id,appid:m.value||""}})},Le=(t,e)=>{const n=e;se({id:t.id,switch_status:n,appid:m.value||""}).then(s=>{s&&s.res==0&&(t.switch_status=n,x.success("操作成功"))})},$e=t=>{oe.confirm({title:"确认删除吗？",okText:"确认",onOk:()=>{ut({id:t.id}).then(e=>{e&&e.res==0&&(x.success("删除成功"),$())})}})};function Te(t){return(t||[]).map(e=>({...e,status:"1"}))}function Ie(t){const e={text:"2",image:"4",card:"3",imageText:"1",url:"5",smartMenu:"6"};return t.map(n=>e[n.type]||"").filter(Boolean)}async function U(){var t;try{const e=await te({rule_type:"subscribe_reply_default",appid:m.value||"",page:1,size:3}),n=Array.isArray((t=e==null?void 0:e.data)==null?void 0:t.list)?e.data.list:[];v.value=n.map(r=>({id:Number(r.id||0),priority_num:Number(r.priority_num||0),switch_status:String(r.switch_status??"0"),reply_num:Number(r.reply_num||0),replyList:(Array.isArray(r.reply_content)?r.reply_content:[]).map(a=>({type:(a==null?void 0:a.type)||(a==null?void 0:a.reply_type)||"text",description:(a==null?void 0:a.description)||"",thumb_url:(a==null?void 0:a.thumb_url)||(a==null?void 0:a.pic)||"",title:(a==null?void 0:a.title)||"",url:(a==null?void 0:a.url)||"",appid:(a==null?void 0:a.appid)||"",page_path:(a==null?void 0:a.page_path)||"",smart_menu_id:(a==null?void 0:a.smart_menu_id)||"",smart_menu:(a==null?void 0:a.smart_menu)||{}}))}));const s=3-v.value.length;if(s>0){const r=v.value.length+1;for(let a=0;a<s;a++)v.value.push({id:0,priority_num:r+a,switch_status:"0",reply_num:0,replyList:[{type:"text",description:""}]})}}catch{v.value=[{id:0,priority_num:1,switch_status:"0",reply_num:0,replyList:[{type:"text",description:""}]},{id:0,priority_num:2,switch_status:"0",reply_num:0,replyList:[{type:"text",description:""}]},{id:0,priority_num:3,switch_status:"0",reply_num:0,replyList:[{type:"text",description:""}]}]}}async function De(t){if(!m.value){x.warning("请选择公众号");return}const e=v.value[t];if(!e||!Array.isArray(e.replyList)||e.replyList.length===0){x.warning("请完善回复内容");return}for(const n of S.value)if(n&&n.validate&&!await n.validate())return;try{const n={appid:m.value,rule_type:"subscribe_reply_default",reply_content:JSON.stringify(Te(e.replyList)),reply_type:Ie(e.replyList),priority_num:Number(e.priority_num)||0,reply_num:Number(e.reply_num)||0,switch_status:Number(e.switch_status)||0,id:Number(e.id)||void 0},s=await rt(n);s&&s.res==0&&(x.success("保存成功"),U())}catch{}}function ze(t,e){const n=String(e),s=v.value[t];if(!(s!=null&&s.id)){v.value[t].switch_status=n,x.info("请先保存当前规则");return}se({id:s.id,switch_status:n,appid:m.value||""}).then(r=>{r&&r.res==0&&(v.value[t].switch_status=n,x.success("操作成功"))})}function Ee(t){return Je[t]||""}function Be(t){if(!Array.isArray(t))return"";const e=t.map(s=>Ee(s==null?void 0:s.type)).filter(s=>!!s);return[...new Set(e)].join("/")}function qe(t){const e={1:"周一",2:"周二",3:"周三",4:"周四",5:"周五",6:"周六",7:"周日"},n=String(t||"");return e[n]||n}function P(t){const e=String(t||"");return e?/^\d{4}-\d{2}-\d{2}/.test(e)?e.slice(0,10):e:""}function Ne(t,e="YYYY-MM-DD"){return t?kt(t*1e3).format(e):""}function V(t){const e=String(t||"");return e?/^\d{2}:\d{2}/.test(e)?e.slice(0,5):e:""}function Me(t){const e=(t==null?void 0:t.duration_type)||"",n=(t==null?void 0:t.week_duration)||"",s=(t==null?void 0:t.start_duration)||"",r=(t==null?void 0:t.end_duration)||"";if(e==="week"){const a=Array.isArray(n)?n.map(T=>String(T)):n?[String(n)]:[],I=a.length?a.map(T=>qe(T)).join("、"):"",D=`${V(s)} 至 ${V(r)}`;return I?`每星期${I}：${D}`:`每星期：${D}`}if(e==="day")return`每天：${P(s)} 至 ${P(r)}`;if(e==="time_range"){const a=(t==null?void 0:t.start_day)||"",I=(t==null?void 0:t.end_day)||"",D=`${P(a)} ${V(s)}`.trim(),T=`${P(I)} ${V(r)}`.trim();return`自定义时间：
${D} 至 ${T}`}return`${e||""}：${s||""} 至 ${r||""}`}const Oe=Object.fromEntries((Qe||[]).map(t=>[String(t.value),t.label]));function Ue(t){const e=Array.isArray(t==null?void 0:t.subscribe_source)?t.subscribe_source:[];if(!e.length)return"--";const n=e.map(s=>Oe[String(s)]||String(s)).filter(Boolean);return n.length?n.join("、"):"--"}function Pe(t){var n;const e=((n=v.value[t])==null?void 0:n.replyList)||[];e.length>=5||e.push({type:"text",description:""})}function Ve(t,e){var a;const{reply_index:n,...s}=e,r=((a=v.value[t])==null?void 0:a.replyList)||[];n>=0&&n<r.length&&(r[n]=s)}function Ye(t,e){var n;(((n=v.value[t])==null?void 0:n.replyList)||[]).splice(e,1)}const J=()=>{R.query.id&&R.query.robot_key?A.push({path:"/robot/config/function-center",query:{id:R.query.id,robot_key:R.query.robot_key}}):A.push({path:"/explore/index"})},Fe=t=>{const e=_.value,n=t;if(n==="0"){oe.confirm({title:"提示",content:"关闭后，该功能默认关闭不再支持使用，所有的公众号菜单都会停用，确认关闭？",onOk:()=>{ne({ability_type:"robot_subscribe_reply",switch_status:n}).then(s=>{s&&s.res==0?(_.value=n,x.success("操作成功")):_.value=e}).catch(()=>{_.value=e})},onCancel:()=>{_.value="1"}});return}ne({ability_type:"robot_subscribe_reply",switch_status:n}).then(s=>{s&&s.res==0?(_.value=n,x.success("操作成功")):_.value=e}).catch(()=>{_.value=e})};return(t,e)=>{const n=ue,s=pt,r=ce,a=_t,I=ct,D=de,T=dt,Z=ht,We=yt,je=mt,Ge=vt,X=ft,Ke=bt;return o(),p("div",wt,[l("div",xt,[u(n,{onClick:J,name:"back",style:{"font-size":"20px"}}),l("div",{onClick:J,class:"breadcrumb-title"},"关注后回复"),u(s,{checked:_.value,"onUpdate:checked":e[0]||(e[0]=i=>_.value=i),checkedValue:"1","un-checkedValue":"0","checked-children":"开","un-checked-children":"关",onChange:Fe},null,8,["checked"]),e[4]||(e[4]=l("span",{class:"switch-tip"},"开启后，用户关注公众号后，回复指定的内容，该功能仅支持公众号内回复",-1))]),l("div",Ct,[l("div",{class:ee(["mp-list",{expanded:L.value}]),ref_key:"mpListRef",ref:M},[(o(!0),p(F,null,G(L.value?y.value:y.value.slice(0,B.value),i=>(o(),p("div",{class:ee(["mp-card",{selected:i.appid===m.value}]),key:i.id,onClick:c=>Ce(i)},[l("img",{src:i.logo,class:"mp-logo"},null,8,St),l("span",At,w(i.name),1)],10,Rt))),128)),!L.value&&y.value.length>B.value?(o(),z(r,{key:0,type:"dashed",class:"more-btn",onClick:e[1]||(e[1]=i=>L.value=!0)},{default:d(()=>[C(" 更多 +"+w(y.value.length-B.value),1)]),_:1})):g("",!0)],2)]),u(I,{activeKey:h.value,"onUpdate:activeKey":e[2]||(e[2]=i=>h.value=i),onChange:xe,style:{"margin-top":"8px"}},{default:d(()=>[u(a,{key:"subscribe_reply_default",tab:"默认回复"}),u(a,{key:"subscribe_reply_duration",tab:"按时段设置"}),u(a,{key:"subscribe_reply_source",tab:"按关注来源设置"})]),_:1},8,["activeKey"]),u(D,{"show-icon":""},{message:d(()=>[h.value==="subscribe_reply_default"?(o(),p("p",Lt,"关注后1分钟内只能给粉丝发送3条消息。建议关注后自动回复数量不要超过2条。可以根据关注来源或关注时间段单独设置回复")):h.value==="subscribe_reply_duration"?(o(),p("p",$t,"优先级设置的区间为1-100的自然整数，数字越小，优先级越高。触发优先级为：按时间段回复>按关注来源回复>默认回复。")):(o(),p("p",Tt,"触发优先级为：按时间段回复>按关注来源回复>默认回复。"))]),_:1}),h.value!=="subscribe_reply_default"?(o(),p("div",It,[l("div",Dt,[u(r,{type:"primary",onClick:Re},{icon:d(()=>[u(N(ae))]),default:d(()=>[C(" "+w(h.value==="subscribe_reply_duration"?"增加时段回复":"新增回复"),1)]),_:1}),l("div",zt,[u(T,{modelValue:O.value,"onUpdate:modelValue":e[3]||(e[3]=i=>O.value=i),placeholder:"回复内容",allowClear:"",options:N(fe),style:{width:"240px"},onChange:we},null,8,["modelValue","options"])])])])):g("",!0),h.value!=="subscribe_reply_default"?(o(),p("div",Et,[u(Ge,{columns:be.value,"data-source":Q.value,loading:j.value,pagination:{current:f.page,total:f.total,pageSize:f.size,showQuickJumper:!0,showSizeChanger:!0,pageSizeOptions:["10","20","50","100"]},onChange:ke},{headerCell:d(({column:i})=>[i.key==="priority_num"?(o(),p("span",Bt,[e[5]||(e[5]=C(" 优先级 ")),u(Z,{title:"优先级设置的数值不能重复，数值越小，优先级越高"},{default:d(()=>[u(N(ie))]),_:1})])):i.key==="switch_status"?(o(),p("span",qt,[e[6]||(e[6]=C(" 启用状态 ")),u(Z,{title:h.value==="receive_reply_message_type"?"开启开关后，触发消息类型回复指定的内容":"开启后，按照设置的时间段回复指定的内容"},{default:d(()=>[u(N(ie))]),_:1},8,["title"])])):(o(),p("span",Nt,w(i.title),1))]),bodyCell:d(({column:i,record:c})=>[i.key==="subscribe_source"?(o(),p("span",Mt,w(Ue(c)),1)):g("",!0),i.key==="reply_content"?(o(),p("span",Ot,w(Be(c.reply_content)||"--"),1)):g("",!0),i.key==="reply_num"?(o(),p(F,{key:2},[C(w(c.reply_num==0?"全部回复":"随机回复一条"),1)],64)):g("",!0),i.key==="create_time"?(o(),p("span",Ut,w(Ne(c.create_time)||"--"),1)):g("",!0),i.key==="duration"?(o(),p("span",Pt,w(Me(c)),1)):g("",!0),i.key==="priority_num"?(o(),z(We,{key:5,value:c.priority_num,"onUpdate:value":b=>c.priority_num=b,min:1,max:100,precision:0,style:{width:"96px"},onBlur:b=>H(c),onPressEnter:b=>H(c)},null,8,["value","onUpdate:value","onBlur","onPressEnter"])):g("",!0),i.key==="switch_status"?(o(),z(s,{key:6,checked:c.switch_status,checkedValue:"1","un-checkedValue":"0","checked-children":"开","un-checked-children":"关",onChange:b=>Le(c,b)},null,8,["checked","onChange"])):g("",!0),i.key==="action"?(o(),z(je,{key:7,gap:8},{default:d(()=>[l("a",{onClick:b=>Se(c)},"编辑",8,Vt),l("a",{onClick:b=>$e(c)},"删除",8,Yt),l("a",{onClick:b=>Ae(c)},"复制",8,Ft)]),_:2},1024)):g("",!0)]),_:1},8,["columns","data-source","loading","pagination"])])):g("",!0),h.value==="subscribe_reply_default"?(o(),p("div",Wt,[(o(!0),p(F,null,G(v.value,(i,c)=>(o(),p("div",{class:"reply-editor-item",key:i.id},[l("div",jt,[l("div",Gt,"关注后自动回复（优先级："+w(i.priority_num)+"）",1),u(s,{checked:i.switch_status,checkedValue:"1","un-checkedValue":"0","checked-children":"开","un-checked-children":"关",onChange:b=>ze(c,b)},null,8,["checked","onChange"])]),u(at,{name:"collapse"},{default:d(()=>[st(l("div",Kt,[l("div",Qt,[e[7]||(e[7]=l("div",{class:"nav-box"},"回复内容：",-1)),l("div",Ht,[(o(!0),p(F,null,G(i.replyList,(b,Y)=>(o(),z(it,{key:Y,ref_for:!0,ref_key:"replyRefs",ref:S,value:i.replyList[Y],"onUpdate:value":q=>i.replyList[Y]=q,reply_index:Y,onChange:q=>Ve(c,q),onDel:q=>Ye(c,q)},null,8,["value","onUpdate:value","reply_index","onChange","onDel"]))),128)),u(r,{type:"dashed",style:{width:"694px"},disabled:i.replyList.length>=5,onClick:()=>Pe(c)},{icon:d(()=>[u(N(ae))]),default:d(()=>[C(" 添加回复内容("+w(i.replyList.length)+"/5) ",1)]),_:2},1032,["disabled","onClick"])])]),l("div",Jt,[e[10]||(e[10]=l("div",{class:"nav-box"},"回复方式：",-1)),u(Ke,{value:i.reply_num,"onUpdate:value":b=>i.reply_num=b},{default:d(()=>[u(X,{value:0},{default:d(()=>e[8]||(e[8]=[C("全部回复")])),_:1,__:[8]}),u(X,{value:1},{default:d(()=>e[9]||(e[9]=[C("随机回复一条")])),_:1,__:[9]})]),_:2},1032,["value","onUpdate:value"])]),l("div",Zt,[u(r,{type:"primary",onClick:b=>De(c)},{default:d(()=>e[11]||(e[11]=[C("保存")])),_:2,__:[11]},1032,["onClick"])])],512),[[nt,i.switch_status==="1"]])]),_:2},1024)]))),128))])):g("",!0)])}}},ns=le(ss,[["__scopeId","data-v-f082052a"]]),as={class:"auto-reply-home"},is={key:1,class:"user-model-page"},os={class:"empty-wrap"},ls={class:"empty-actions"},us={__name:"index",setup(ye){const S=K(),E=re(),R=k(!0),A=async()=>{try{const _=await _e({app_type:"official_account",app_name:""}),y=Array.isArray(_==null?void 0:_.data)?_.data.filter(m=>m.account_is_verify=="true"):[];R.value=y.length>0}catch{R.value=!1}},h=()=>{const _=E.resolve({path:"/user/official-account"});window.open(_.href,"_blank")},v=()=>{S.query.id&&S.query.robot_key?E.push({path:"/robot/config/function-center",query:{id:S.query.id,robot_key:S.query.robot_key}}):E.push({path:"/explore/index"})};return pe(A),(_,y)=>{const m=ue,L=de,M=ce;return o(),p("div",as,[R.value?(o(),z(ns,{key:0})):(o(),p("div",is,[l("div",{class:"breadcrumb-wrap",onClick:v},[u(m,{name:"back",style:{"font-size":"20px"}}),y[0]||(y[0]=l("div",{class:"breadcrumb-title"},"关注后回复",-1))]),u(L,{"show-icon":""},{message:d(()=>y[1]||(y[1]=[C(" 开启后，用户关注公众号后，回复指定的内容，"),l("span",{style:{color:"#FF4D4F"}},"该功能仅支持公众号内回复",-1)])),_:1}),l("div",os,[u(gt,{size:"180"},{default:d(()=>y[2]||(y[2]=[l("div",{class:"empty-default"},"暂未绑定公众号",-1),l("div",{class:"empty-sub"},"请选到系统设置>公众号管理绑定公众号",-1)])),_:1,__:[2]}),l("div",ls,[u(M,{type:"primary",onClick:h},{default:d(()=>y[3]||(y[3]=[C("绑定")])),_:1,__:[3]})])])]))])}}},bs=le(us,[["__scopeId","data-v-a708c047"]]);export{bs as default};
