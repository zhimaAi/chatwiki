import{_ as nt,bj as ot,bk as it,bb as ht,b9 as q,o as gt,d as vt}from"../../index-DxV-PNCd.js";import{_ as lt,C as ft,a as xt}from"./create-send-modal-KDYxmbcF.js";import{f,r as ct,w as _t,o as dt,b as ut,ae as g,ad as e,ar as h,as as a,ac as i,at as d,F as Ct,ax as St,k as o,u as L,az as $,G as T,y as wt,av as $t,ai as bt}from"./vue-chunks-CGLjTDrY.js";import{a as Tt}from"./index-DCeQ7cs_.js";import{ad as X,ae as zt,af as At,ag as Z,ah as tt,ai as et,aj as st,ak as Rt,al as It}from"./index-BNO9ztvM.js";import{a1 as Mt,as as mt,bB as at,an as Bt,al as Dt,aA as Ot,M as z,b as w,W as A,B as Ft,G as Lt,v as Et,Q as Nt,bH as Ut,k as Vt,h as Ht,i as Kt}from"./ui-antd-AfNpv4wx.js";import"./neo4j-L2Hgpmga.js";import"./utils-COBjqVvs.js";import"./other-BrZCAsTs.js";const jt={class:"article-card"},Gt=["src"],Jt={key:1,class:"thumb",src:lt},Pt={class:"info"},Qt={class:"title"},Wt={class:"meta"},Yt={class:"digest"},qt={class:"comment-header"},Xt={class:"comment-content"},Zt={class:"top-line"},te={class:"name"},ee={class:"time"},se={key:1,class:"delete-status"},ae={key:2,class:"actions"},ne={class:"text"},oe={key:0,class:"ai-reply"},ie={class:"top-line ai-reply-content"},le={class:"ai-replay-content-right"},ce={class:"ai-replay-content-right-top"},_e={class:"time"},de={key:0,class:"delete-status"},ue={key:1,class:"actions"},me={class:"text"},pe={key:0,class:"empty"},re={key:1,class:"load-more-tips"},ke={key:0},ye={key:1},he={key:1,class:"loading-box"},ge={__name:"comment-drawer",setup(U,{expose:j}){const R=gt,V=ht,b=f(!1),u=f({}),E=f(!1),m=ct({page:1,size:20,total:0}),C=f([]),I=f(!0),M=f(!1),k=f(null);let v=null;const G=c=>{u.value={...c},b.value=!0,m.page=1,N()},N=()=>{E.value=!0,X({task_id:u.value.id,page:m.page,size:m.size}).then(c=>{const r=(c==null?void 0:c.data)||{};C.value=Array.isArray(r.list)?r.list:[],m.page=+r.page||m.page,m.size=+r.size||m.size,m.total=+r.total||C.value.length||0,I.value=C.value.length<m.total}).finally(()=>{E.value=!1})},J=c=>{z.confirm({title:"确认删除评论吗？",icon:o(A),okText:"删除",cancelText:"取消",onOk:async()=>{await zt({msg_id:c.msg_data_id,comment_id:c.user_comment_id,access_key:u.value.access_key}),w.success("删除成功"),N()}})},P=c=>{z.confirm({title:"确认删除回复吗？",icon:o(A),okText:"删除",cancelText:"取消",onOk:async()=>{await At({msg_id:c.msg_data_id,comment_id:c.user_comment_id,access_key:u.value.access_key}),w.success("删除成功"),N()}})};j({show:G});const B=c=>c?`用户_${String(c).slice(-4)}`:"用户",Q=c=>String(c.comment_type)==="1"?!0:String(c.ai_comment_result_text||"").includes("自动精选"),W=()=>{k.value&&(v=k.value.closest(".ant-drawer-body"),v&&v.addEventListener("scroll",H,{passive:!0}))},D=()=>{v&&(v.removeEventListener("scroll",H),v=null)},H=()=>{if(!I.value||M.value||!v)return;if(v.scrollTop+v.clientHeight>=v.scrollHeight-80){M.value=!0;const O=m.page+1;X({task_id:u.value.id,page:O,size:m.size}).then(t=>{const s=(t==null?void 0:t.data)||{},l=Array.isArray(s.list)?s.list:[];m.page=+s.page||O,m.size=+s.size||m.size,m.total=+s.total||m.total,C.value=C.value.concat(l),I.value=C.value.length<m.total}).finally(()=>{M.value=!1})}};return _t(b,c=>{c?(I.value=!0,M.value=!1,wt(W)):D()}),dt(()=>{ot()}),ut(()=>{it()}),(c,r)=>{const O=Mt,t=mt,s=Bt,l=Dt,y=Ot;return e(),g(y,{open:b.value,"onUpdate:open":r[0]||(r[0]=_=>b.value=_),title:"查看评论",width:420,destroyOnClose:!0},{default:h(()=>[a("div",jt,[u.value.thumb_url?(e(),i("img",{key:0,class:"thumb",src:u.value.thumb_url},null,8,Gt)):(e(),i("img",Jt)),a("div",Pt,[a("div",Qt,d(u.value.title),1),a("div",Wt,"所属分组："+d(u.value.group_name),1),a("div",Yt,d(u.value.digest),1)])]),a("div",qt,d(m.total)+"条评论",1),E.value?(e(),i("div",he,[o(l)])):(e(),i("div",{key:0,class:"list-box",ref_key:"bodyAnchorRef",ref:k},[(e(!0),i(Ct,null,St(C.value,_=>(e(),i("div",{class:"comment-item",key:_.id},[o(O,{size:40,src:L(V)},null,8,["src"]),a("div",Xt,[a("div",Zt,[a("span",te,d(B(_.open_id)),1),Q(_)?(e(),g(t,{key:0,color:"#FF4D4F",style:{"margin-right":"0"}},{default:h(()=>[...r[1]||(r[1]=[T("精选",-1)])]),_:1})):$("",!0),a("span",ee,d(L(q)(_.comment_create_time)),1),_.delete_status=="1"?(e(),i("div",se,"已删除")):(e(),i("span",ae,[o(L(at),{class:"delete-icon",onClick:x=>J(_)},null,8,["onClick"])]))]),a("div",ne,d(_.content_text),1),_.reply_comment_text?(e(),i("div",oe,[a("div",ie,[o(O,{size:32,src:L(R),style:{"flex-basis":"32px"}},null,8,["src"]),a("div",le,[a("div",ce,[r[2]||(r[2]=a("span",{class:"name ai"},"AI机器人",-1)),a("span",_e,d(L(q)(_.reply_create_time)),1),_.delete_status=="1"?(e(),i("div",de,"已删除")):(e(),i("span",ue,[o(L(at),{class:"delete-icon",onClick:x=>P(_)},null,8,["onClick"])]))]),a("div",me,d(_.reply_comment_text),1)])])])):$("",!0)])]))),128)),C.value.length===0?(e(),i("div",pe,[o(s)])):(e(),i("div",re,[M.value?(e(),i("span",ke,"加载中...")):I.value?$("",!0):(e(),i("span",ye,"已加载全部"))]))],512))]),_:1},8,["open"])}}},ve=nt(ge,[["__scopeId","data-v-9c09c930"]]),fe={class:"group-send-wrapper"},xe={class:"toolbar"},Ce={class:"table-box"},Se={key:0},we=["onClick"],$e={class:"expanded-draft"},be=["src"],Te={key:1,class:"thumb",src:lt},ze={class:"info"},Ae={class:"title"},Re={class:"meta"},Ie={class:"digest"},Me=["onClick"],Be={key:0,class:"task-cell"},De={class:"name"},Oe={key:1,class:"send-time-cell"},Fe={key:0,class:"time"},Le={key:1,class:"time"},Ee={key:2,style:{color:"#595959"}},Ne={key:5,class:"ai-comment-cell"},Ue={class:"comment-rule-cell"},Ve={class:"rule"},He={key:0,class:"default-tag"},Ke=["onClick"],je=["onClick"],Ge={__name:"group-send",props:{appId:{type:String,default:""},accessKey:{type:String,default:""}},setup(U){const j=$t(),R=U,V=f([]),b=f(!1),u=ct({page:1,size:10,total:0}),E={"-1":"已删除",0:"未发送",1:"发送中",2:"已发送",3:"发送失败"},m={0:"全部粉丝"},C=[{title:"群发",dataIndex:"task_name",key:"task_name"},{title:"群发时间",dataIndex:"send_time",key:"send_time"},{title:"接收者",dataIndex:"receiver",key:"receiver"},{title:"启用",dataIndex:"open_status",key:"open_status"},{title:"留言",dataIndex:"comment_status",key:"comment_status"},{title:"AI评论",dataIndex:"ai_comment_status",key:"ai_comment_status"},{title:"操作",dataIndex:"actions",key:"actions"}],I=t=>{u.page=t.current,u.size=t.pageSize,k()},M=t=>t.is_top=="1"?"row-top":"",k=()=>{b.value=!0,It({page:u.page,size:u.size,app_id:R.appId}).then(t=>{const s=(t==null?void 0:t.data)||{list:[],total:0};s.list.forEach(l=>{l.send_res=JSON.parse(l.send_res||"{}")}),V.value=s.list||[],u.total=+s.total||0}).finally(()=>{b.value=!1})},v=async t=>{if(t.is_top=="1"){z.confirm({title:"确认取消置顶？",icon:o(A),onOk:async()=>{await st({task_id:t.id,is_top:t.is_top=="1"?0:1}),w.success("已取消置顶"),k()}});return}await st({task_id:t.id,is_top:t.is_top=="1"?0:1}),w.success(t.is_top=="1"?"已取消置顶":"已置顶"),k()},G=t=>{z.confirm({title:`确认删除群发任务：${t.task_name}`,icon:o(A),onOk:async()=>{await Rt({task_id:t.id}),w.success("删除成功"),k()}})},N=async(t,s)=>{const l=s?1:0;if(!s){z.confirm({title:"确认关闭群发任务？",icon:o(A),onOk:async()=>{await Z({task_id:t.id,open_status:l}),t.open_status=String(l),w.success("已关闭群发任务"),k()}});return}await Z({task_id:t.id,open_status:l}),t.open_status=String(l),w.success("操作成功")},J=async(t,s)=>{var y,_;if(s)try{const x=await Tt({ability_type:"official_account_ai_comment"}),F=(_=(y=x==null?void 0:x.data)==null?void 0:y.user_config)==null?void 0:_.switch_status;if(String(F||"0")!=="1"){z.confirm({title:"AI评论",content:o("div",null,[o("span",{style:"color: #ff4d4f;"},"AI评论功能暂未开启"),o("span",null,"，您可到探索>功能中 去开启")]),okText:"去开启",cancelText:"取消",onOk:()=>{j.push("/explore/index/ai-comment-management")}});return}}catch(x){console.error(x)}const l=s?1:0;if(!s){z.confirm({title:"确认关闭AI评论规则？",icon:o(A),onOk:async()=>{await et({task_id:t.id,ai_comment_status:l}),t.ai_comment_status=String(l),w.success("已关闭AI评论规则"),k()}});return}await et({task_id:t.id,ai_comment_status:l}),t.ai_comment_status=String(l),D.value&&D.value.show({...t})},P=async(t,s)=>{const l=s?1:0;if(!s){z.confirm({title:"确认关闭留言？",icon:o(A),onOk:async()=>{await tt({task_id:t.id,msg_id:t.msg_data_id,access_key:R.accessKey,comment_status:l}),t.comment_status=String(l),w.success("已关闭留言"),k()}});return}await tt({task_id:t.id,msg_id:t.msg_data_id,access_key:R.accessKey,comment_status:l}),t.comment_status=String(l),w.success("操作成功")},B=f(null),Q=t=>{B.value&&B.value.show({task:t})},W=()=>{B.value&&B.value.show({})},D=f(null),H=t=>{D.value&&D.value.show({...t})},c=t=>{if(!t)return"";const s=new Date(Number(t)*1e3),l=String(s.getFullYear()).slice(2),y=String(s.getMonth()+1).padStart(2,"0"),_=String(s.getDate()).padStart(2,"0"),x=String(s.getHours()).padStart(2,"0"),F=String(s.getMinutes()).padStart(2,"0");return`${l}-${y}-${_} ${x}:${F}`};_t(()=>R.appId,()=>{u.page=1,R.appId&&k()},{immediate:!0}),dt(()=>{ot()}),ut(()=>{it()});const r=f(null),O=t=>{r.value&&r.value.show({...t})};return(t,s)=>{const l=Ft,y=vt,_=mt,x=Et,F=Nt,Y=Kt,pt=Ht,rt=Vt,kt=Ut,yt=Lt;return e(),i("div",fe,[a("div",xe,[o(l,{type:"primary",onClick:W},{default:h(()=>[...s[0]||(s[0]=[T("创建群发",-1)])]),_:1})]),a("div",Ce,[o(yt,{columns:C,"data-source":V.value,loading:b.value,"row-key":"id",pagination:{current:u.page,pageSize:u.size,total:u.total,showSizeChanger:!0,pageSizeOptions:["10","20","50","100"]},onChange:I,"row-class-name":M},{headerCell:h(({column:p})=>[typeof p.title=="string"?(e(),i("span",Se,d(p.title),1)):$("",!0)]),expandIcon:h(({expanded:p,onExpand:n,record:K})=>[a("span",{class:"expand-icon",onClick:S=>n(K)},[p?(e(),g(y,{key:0,name:"table-hide",size:"16px"})):(e(),g(y,{key:1,name:"table-expand",size:"16px"}))],8,we)]),expandedRowRender:h(({record:p})=>[a("div",$e,[p.thumb_url?(e(),i("img",{key:0,class:"thumb",src:p.thumb_url},null,8,be)):(e(),i("img",Te)),a("div",ze,[a("div",Ae,d(p.title),1),a("div",Re,"所属分组："+d(p.group_name),1),a("div",Ie,d(p.digest||"暂无摘要"),1)]),a("div",{class:"expanded-meta",onClick:n=>O(p)},[o(y,{name:"comment",size:"32px",style:{color:"transparent"}}),T(" "+d(p.max_comment_id),1)],8,Me)])]),bodyCell:h(({column:p,record:n})=>{var K;return[p.key==="task_name"?(e(),i("div",Be,[n.is_top=="1"?(e(),g(_,{key:0,color:"blue"},{default:h(()=>[...s[1]||(s[1]=[T("置顶",-1)])]),_:1})):$("",!0),a("span",De,d(n.task_name),1)])):p.key==="send_time"?(e(),i("div",Oe,[a("div",{class:bt(["status-tag",{"status-sending":n.send_status=="1","status-success":n.send_status=="2"}])},[n.send_status=="-1"?(e(),g(y,{key:0,style:{color:"white"},name:"status-fail"})):n.send_status=="0"?(e(),g(y,{key:1,style:{color:"white"},name:"status-fail"})):n.send_status=="1"?(e(),g(y,{key:2,style:{color:"white"},name:"status-sending"})):n.send_status=="2"?(e(),g(y,{key:3,style:{color:"white"},name:"status-success"})):n.send_status=="3"?(e(),g(y,{key:4,style:{color:"white"},name:"status-fail"})):$("",!0),T(" "+d(E[n.send_status])+" ",1),n.send_status==="3"?(e(),g(x,{key:5,title:(K=n.send_res)==null?void 0:K.errmsg},{default:h(()=>[o(L(A),{style:{"font-size":"16px",color:"#FF4D4F"}})]),_:1},8,["title"])):$("",!0)],2),n.send_time!="0"?(e(),i("div",Fe,"定时群发："+d(c(n.send_time)),1)):(e(),i("div",Le,"立即发送："+d(c(n.create_time)),1))])):p.key==="receiver"?(e(),i("span",Ee,d(m[n.to_user_type]||"全部粉丝"),1)):p.key==="open_status"?(e(),g(F,{key:3,checked:n.open_status=="1","checked-children":"开","un-checked-children":"关",onChange:S=>N(n,S)},null,8,["checked","onChange"])):p.key==="comment_status"?(e(),g(F,{key:4,checked:n.comment_status=="1","checked-children":"开","un-checked-children":"关",onChange:S=>P(n,S)},null,8,["checked","onChange"])):p.key==="ai_comment_status"?(e(),i("div",Ne,[o(F,{checked:n.ai_comment_status=="1","checked-children":"开","un-checked-children":"关",onChange:S=>J(n,S)},null,8,["checked","onChange"]),a("div",Ue,[a("span",Ve,[n.is_default=="1"?(e(),i("span",He,"默认")):$("",!0),T(" "+d(n.comment_rule_name||"默认规则"),1)]),a("a",{class:"edit-link",onClick:S=>H(n)},"修改",8,Ke)])])):p.key==="actions"?(e(),g(kt,{key:6,style:{gap:"16px"}},{default:h(()=>[a("a",{onClick:S=>Q(n)},"编辑",8,je),o(rt,null,{overlay:h(()=>[o(pt,null,{default:h(()=>[o(Y,{onClick:S=>v(n)},{default:h(()=>[T(d(n.is_top=="1"?"取消置顶":"置 顶"),1)]),_:2},1032,["onClick"]),o(Y,{onClick:S=>G(n)},{default:h(()=>[...s[2]||(s[2]=[T("删 除",-1)])]),_:1},8,["onClick"])]),_:2},1024)]),default:h(()=>[s[3]||(s[3]=a("a",null,"更多",-1))]),_:2},1024)]),_:2},1024)):$("",!0)]}),_:1},8,["data-source","loading","pagination"])]),o(ve,{ref_key:"commentDrawerRef",ref:r},null,512),o(ft,{ref_key:"commentRuleModalRef",ref:D,onUpdated:k},null,512),o(xt,{ref_key:"editSendModalRef",ref:B,"app-id":U.appId,"access-key":U.accessKey,onUpdated:k,onCreated:k},null,8,["app-id","access-key"])])}}},es=nt(Ge,[["__scopeId","data-v-3f8fcc04"]]);export{es as default};
