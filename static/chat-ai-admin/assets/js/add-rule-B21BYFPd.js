import{b as K,d as Z}from"../../index-BLRnoXQj.js";import{ab as ee,f as D,e as te,r as ae,w as M,o as re,Y as N,k as n,a5 as y,a2 as l,aa as ne,_ as g,G as i,a7 as U,a1 as c,ae as Y,u as q,F as le,a9 as oe}from"./vue-chunks-Ci-XTWEs.js";import{M as ie}from"./multi-reply-DAkM7Sd9.js";import{e as se,c as ue}from"./index-M-GWJz6_.js";import{a as b,i as _e,F as de,d as x,j as pe,e as ye,X as me,p as fe,ab as ve,q as ge,R as be,u as ke,v as we,J as ce,bf as xe,O as Ae,B as Ye,z as Re}from"./ui-antd-BKz8sshA.js";import"./utils-ChQO-_r6.js";import"./index-BNGD8tAN.js";const De={class:"subManage-edit"},Me=["href"],Ce={class:"main"},he={class:"ml4"},Se={class:"item-box"},Ne={class:"flex-center"},Ue={class:"nav-box",style:{"margin-top":"24px"}},qe={class:"item-box"},Be={class:"radio-container"},Pe={class:"btn-container"},Ie={__name:"add-rule",setup(Oe){const m=ee().query,A=D(+m.rule_id||+m["rule-id"]||0),f=D(m.rule_type||"subscribe_reply_duration"),B=ne(),P=te(()=>`/#/robot/ability/subscribe-reply?id=${m.id}&robot_key=${m.robot_key}&rule_type=${f.value}`),C=D(null),e=ae({duration_type:"day",reply_period:[],priority_num:null,week_day:["1"],week_duration:["1"],date_range:[],start_day:"",end_day:"",reply_num:"0",message_type:"0",message_type_list:[],reply_interval:0,switch_status:!0}),I={name:[{required:!0,message:"请输入规则名称",trigger:"blur"}]};function O(o,t){return e.duration_type!=="time_range"||Array.isArray(t)&&t.length===2&&t[0]&&t[1]?Promise.resolve():Promise.reject("请选择起止日期")}function T(o,t){return e.duration_type!=="week"||Array.isArray(t)&&t.length>0?Promise.resolve():Promise.reject("请选择至少一个星期")}M(()=>e.duration_type,o=>{o==="week"?((!Array.isArray(e.week_day)||e.week_day.length===0)&&(e.week_day=["1"]),e.week_duration=Array.isArray(e.week_day)?e.week_day:[e.week_day]):o==="time_range"&&Array.isArray(e.date_range)&&e.date_range.length===2&&e.date_range[0]&&e.date_range[1]?(e.start_day=x(e.date_range[0]).format("YYYY-MM-DD"),e.end_day=x(e.date_range[1]).format("YYYY-MM-DD")):(e.start_day="",e.end_day="")}),M(()=>e.week_day,o=>{e.duration_type==="week"&&(e.week_duration=Array.isArray(o)?o:[o])}),M(()=>e.date_range,o=>{e.duration_type==="time_range"&&Array.isArray(o)&&o.length===2&&o[0]&&o[1]&&(e.start_day=x(o[0]).format("YYYY-MM-DD"),e.end_day=x(o[1]).format("YYYY-MM-DD"))});const _=D([{type:"text",description:""}]),$=()=>{if(_.value.length>=5){b.warning("最多添加5条回复内容");return}_.value.push({type:"text",description:""})},F=o=>{const{reply_index:t,...u}=o;t>=0&&t<_.value.length&&(_.value[t]=u)},j=o=>{_.value.splice(o,1)},z=()=>{};function H(o){return(o||[]).map(t=>({...t,status:"1"}))}function V(o){const t={text:"2",image:"4",card:"3",imageText:"1",url:"5"};return o.map(u=>t[u.type]||"").filter(Boolean)}const J=()=>{var o;(o=C.value)==null||o.validate().then(async()=>{if(!_.value.length){b.warning("请至少添加一条回复内容");return}if(f.value==="subscribe_reply_duration"){if(!e.reply_period||e.reply_period.length!==2){b.warning("请选择回复时段");return}const a=Number(e.priority_num);if(!Number.isInteger(a)||a<1||a>100){b.warning("优先级需为1-100之间的整数");return}if(e.duration_type==="time_range"&&!(Array.isArray(e.date_range)&&e.date_range.length===2&&e.date_range[0]&&e.date_range[1])){b.warning("请选择自定义日期范围");return}}const t={robot_id:m.id,appid:m.appid||"",switch_status:e.switch_status?"1":"0",rule_type:f.value,reply_interval:Number(e.reply_interval)||0,reply_content:JSON.stringify(H(_.value)),reply_type:V(_.value),reply_num:e.reply_num};let u={};f.value==="subscribe_reply_duration"?u={duration_type:e.duration_type,start_day:e.start_day,end_day:e.end_day,week_duration:e.week_duration,priority_num:Number(e.priority_num)||0,start_duration:Array.isArray(e.reply_period)&&e.reply_period[0].toString()||"",end_duration:Array.isArray(e.reply_period)&&e.reply_period[1].toString()||""}:u={};const v={...t,...u};A.value&&(v.id=A.value);try{const a=await ue(v);a&&a.res==0&&(b.success("保存成功"),B.push({path:"/robot/ability/subscribe-reply",query:{id:m.id,robot_key:m.robot_key,rule_type:f.value}}))}catch{b.error("保存失败，请稍后重试")}})};return re(async()=>{const o=+(m.copy_id||0),t=async u=>{const v=await se({id:u,robot_id:m.id}),a=(v==null?void 0:v.data)||{};if(f.value=(a==null?void 0:a.rule_type)||f.value,e.switch_status=String((a==null?void 0:a.switch_status)||"0")==="1",e.duration_type=(a==null?void 0:a.duration_type)||e.duration_type,e.duration_type==="week"){const r=Array.isArray(a==null?void 0:a.week_duration)?a.week_duration.map(p=>String(p)):[];e.week_day=r.length?r:["1"],e.week_duration=[...e.week_day]}if(e.duration_type==="time_range"||e.duration_type==="day"){const r=(a==null?void 0:a.start_day)||"",p=(a==null?void 0:a.end_day)||"";r&&p&&(e.date_range=[x(r),x(p)])}const w=(a==null?void 0:a.start_duration)||"",d=(a==null?void 0:a.end_duration)||"";e.reply_period=[w,d].filter(Boolean).length===2?[w,d]:[],e.start_duration=w,e.end_duration=d,e.priority_num=Number((a==null?void 0:a.priority_num)||e.priority_num||0),e.reply_interval=Number((a==null?void 0:a.reply_interval)||0);const k=Array.isArray(a==null?void 0:a.reply_content)?a.reply_content:[];_.value=k.map(r=>({type:(r==null?void 0:r.type)||(r==null?void 0:r.reply_type)||"text",description:(r==null?void 0:r.description)||"",thumb_url:(r==null?void 0:r.thumb_url)||(r==null?void 0:r.pic)||"",title:(r==null?void 0:r.title)||"",url:(r==null?void 0:r.url)||"",appid:(r==null?void 0:r.appid)||"",page_path:(r==null?void 0:r.page_path)||""})),e.reply_num=String((a==null?void 0:a.reply_num)??e.reply_num)};try{if(!A.value&&o){await t(o);return}if(!A.value)return;await t(A.value)}catch{b.error("加载规则失败，请稍后重试")}}),(o,t)=>{const u=pe,v=_e,a=fe,w=me,d=ye,k=be,r=ge,p=we,L=ke,E=ce,G=xe,h=Ae,Q=Z,S=Ye,W=de;return g(),N("div",De,[n(v,{class:"subManage-breadcrumb"},{default:l(()=>[n(u,null,{default:l(()=>[y("a",{href:P.value},"关注后回复",8,Me)]),_:1}),n(u,null,{default:l(()=>[i(U(f.value==="subscribe_reply_default"?"新增回复":"增加时段回复"),1)]),_:1})]),_:1}),y("div",Ce,[n(W,{ref_key:"formRef",ref:C,model:e,rules:I},{default:l(()=>[n(d,{name:"switch_status",rules:[{required:!0,message:"请输入规则名称"}]},{label:l(()=>[t[9]||(t[9]=i(" 是否开启 ")),n(a,null,{title:l(()=>t[8]||(t[8]=[i("开启开关后，触发消息类型回复指定的内容")])),default:l(()=>[y("span",he,[n(q(ve))])]),_:1})]),default:l(()=>[n(w,{checked:e.switch_status,"onUpdate:checked":t[0]||(t[0]=s=>e.switch_status=s),"checked-children":"开","un-checked-children":"关"},null,8,["checked"])]),_:1}),f.value==="subscribe_reply_duration"?(g(),c(d,{key:0,name:"duration_type",label:"选择回复时间"},{default:l(()=>[y("div",Se,[n(d,{name:"duration_type",rules:[{required:!0,message:"请选择回复时间类型"}]},{default:l(()=>[n(r,{value:e.duration_type,"onUpdate:value":t[1]||(t[1]=s=>e.duration_type=s)},{default:l(()=>[n(k,{value:"week"},{default:l(()=>t[10]||(t[10]=[i("每星期")])),_:1,__:[10]}),n(k,{value:"day"},{default:l(()=>t[11]||(t[11]=[i("每天")])),_:1,__:[11]}),n(k,{value:"time_range"},{default:l(()=>t[12]||(t[12]=[i("自定义时间")])),_:1,__:[12]})]),_:1},8,["value"])]),_:1}),e.duration_type==="week"?(g(),c(d,{key:0,name:"week_day",rules:[{validator:T}]},{default:l(()=>[n(L,{value:e.week_day,"onUpdate:value":t[2]||(t[2]=s=>e.week_day=s),mode:"multiple",style:{width:"200px"},allowClear:""},{default:l(()=>[n(p,{value:"1"},{default:l(()=>t[13]||(t[13]=[i("星期一")])),_:1,__:[13]}),n(p,{value:"2"},{default:l(()=>t[14]||(t[14]=[i("星期二")])),_:1,__:[14]}),n(p,{value:"3"},{default:l(()=>t[15]||(t[15]=[i("星期三")])),_:1,__:[15]}),n(p,{value:"4"},{default:l(()=>t[16]||(t[16]=[i("星期四")])),_:1,__:[16]}),n(p,{value:"5"},{default:l(()=>t[17]||(t[17]=[i("星期五")])),_:1,__:[17]}),n(p,{value:"6"},{default:l(()=>t[18]||(t[18]=[i("星期六")])),_:1,__:[18]}),n(p,{value:"7"},{default:l(()=>t[19]||(t[19]=[i("星期日")])),_:1,__:[19]})]),_:1},8,["value"])]),_:1},8,["rules"])):Y("",!0),e.duration_type==="time_range"?(g(),c(d,{key:1,name:"date_range",rules:[{validator:O}]},{default:l(()=>[n(E,{value:e.date_range,"onUpdate:value":t[3]||(t[3]=s=>e.date_range=s),format:"YYYY-MM-DD"},null,8,["value"])]),_:1},8,["rules"])):Y("",!0)])]),_:1})):Y("",!0),f.value==="subscribe_reply_duration"?(g(),c(d,{key:1,name:"reply_period",label:"回复时段",rules:[{required:!0,message:"请选择回复时段"}]},{default:l(()=>[n(G,{value:e.reply_period,"onUpdate:value":t[4]||(t[4]=s=>e.reply_period=s),valueFormat:"HH:mm",format:"HH:mm",allowClear:!1},null,8,["value"]),t[20]||(t[20]=y("div",{class:"tip-box"}," 如需跨天，请单独重新再添加一条时段回复：第一个是到23:59结束，第二个是从0点开始 ",-1))]),_:1,__:[20]})):Y("",!0),f.value==="subscribe_reply_duration"?(g(),c(d,{key:2,name:"priority_num",label:"优先级",rules:[{required:!0,message:"输入优先级，1-100之间"}]},{default:l(()=>[n(h,{value:e.priority_num,"onUpdate:value":t[5]||(t[5]=s=>e.priority_num=s),style:{width:"200px"},min:1,max:100},null,8,["value"]),t[21]||(t[21]=y("div",{class:"tip-box",style:{color:"red"}}," 数字越小，则优先级越高。优先级仅在时间相互冲突时有效，比如一个每天1-9点与一个每天310点，当8点钟触发时，则只会触发其中优先级最高的一个。 ",-1))]),_:1,__:[21]})):Y("",!0),n(d,{class:"interval-item",name:"reply_interval",label:"触发回复间隔时间"},{default:l(()=>[y("div",Ne,[n(h,{value:e.reply_interval,"onUpdate:value":t[6]||(t[6]=s=>e.reply_interval=s),style:{width:"60px"}},null,8,["value"]),t[22]||(t[22]=y("span",{class:"ml4"},"秒 在时间间隔内只会触发一次该回复，0秒为无时间间隔限制",-1))])]),_:1}),y("div",Ue,[n(Q,{name:"reply-content",style:{"font-size":"16px"}}),t[23]||(t[23]=i(" 回复内容 "))]),y("div",qe,[(g(!0),N(le,null,oe(_.value,(s,R)=>(g(),c(ie,{key:R,value:_.value[R],"onUpdate:value":X=>_.value[R]=X,reply_index:R,onChange:F,onDel:j},null,8,["value","onUpdate:value","reply_index"]))),128)),n(S,{type:"dashed",style:{width:"694px"},disabled:_.value.length>=5,onClick:$},{icon:l(()=>[n(q(Re))]),default:l(()=>[i(" 添加回复内容("+U(_.value.length)+"/5) ",1)]),_:1},8,["disabled"])]),n(d,{name:"reply_num",label:"回复方式",style:{"margin-top":"24px"}},{default:l(()=>[y("div",Be,[n(r,{value:e.reply_num,"onUpdate:value":t[7]||(t[7]=s=>e.reply_num=s),onChange:z},{default:l(()=>[n(k,{value:"0"},{default:l(()=>t[24]||(t[24]=[i("全部回复")])),_:1,__:[24]}),n(k,{value:"1"},{default:l(()=>t[25]||(t[25]=[i("随机回复一条")])),_:1,__:[25]})]),_:1},8,["value"])])]),_:1}),y("div",Pe,[n(S,{type:"primary",onClick:J},{default:l(()=>t[26]||(t[26]=[i("保存")])),_:1,__:[26]})])]),_:1},8,["model"])])])}}},Je=K(Ie,[["__scopeId","data-v-18ee1813"]]);export{Je as default};
