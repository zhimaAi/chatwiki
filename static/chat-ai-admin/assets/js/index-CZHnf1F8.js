import{M as ie,N as r,O as l,j as R,X as i,Y as ae,V as Q,Z as H,_ as p,a8 as U,d as $,w as X,q as Z,x as z,D as K,S as q,u as C,a6 as x,F as M,a1 as I,a5 as P,U as D,J as ee,G as W,a2 as ne,ag as le,H as ce}from"./vue-chunks-BRsu9_To.js";import{u as te}from"./useEventBus-BwH2zX88.js";import{g as re}from"./index-_Iji3Db_.js";import{cO as E,aD as Y,bx as G,h as de,b as B,d as V,bt as ue}from"../../index-5YmK49PT.js";import{u as _e,_ as he}from"./useIM-BSrHnxb_.js";import{B as A,M as pe,S as me,P as ve}from"./pull-up.esm-D94Swpvl.js";import{O as fe}from"./observe-dom.esm-CyCedSm-.js";import{S as ge}from"./index-c_Ya0Lit.js";import{a as ye}from"./index-GuNoAJfo.js";import{_ as be}from"./index-Df2T6qCE.js";import{S as Le,a as ke}from"./index-CY6Uw_HG.js";import"./index-CaUPg-sM.js";import{I as Se}from"./Input-BUp4aYTr.js";import"./axios-Dq7h7Pqt.js";import"./qs-BrxkIg-9.js";import"./crypto-js-ClNpte_9.js";import"./dayjs-B6IotFah.js";import"./index-1v9OrBK6.js";import"./Trigger-B4vLzRfT.js";import"./ResizeObserver.es-B1PUzC5B.js";import"./index-DKf75RQ4.js";import"./slide-D1R8ir8y.js";import"./index-D-Ceyk84.js";import"./CheckOutlined-DCEeaX0q.js";import"./DownOutlined-BGr9Ccqp.js";import"./SearchOutlined-Cw4SeIMs.js";import"./FormItemContext-CEomr4ey.js";import"./move-tLDxFMn0.js";import"./Search-CIbInPkK.js";import"./isPlainObject-vCHOGwck.js";import"./inputProps-DdSvkSVM.js";import"./TextArea-srALwtoG.js";import"./Password-DgCvYgs_.js";const Te=(n={})=>E.get({url:"/manage/getReceiverList",params:n}),Ce=(n={})=>E.post({url:"/chat/message",data:n}),$e=(n={})=>E.post({url:"/manage/setReceiverRead",data:n}),F=ie("chatMonitor",{state:()=>({im:null,selectedRobotId:"",robotList:[],selectedReceiverId:"",receiverList:[],receiverListPage:{page:0,size:10},activeChat:null,chatMessagePageSize:10,messageList:[],messageListScrollTop:0,chatMessageLoadCompleted:!1,messageListLoading:!1}),getters:{},actions:{async init(){this.selectedRobotId="",this.selectedReceiverId="",this.robotList=[],this.receiverList=[],this.messageList=[],this.receiverListPage={page:0,size:10},this.messageListScrollTop=0,this.chatMessageLoadCompleted=!1,this.messageListLoading=!1,this.activeChat=null,await this.getRobotList(),await this.getReceiverList(),this.receiverList.length>0&&await this.switchChat(this.receiverList[0]),this.initIM()},closeIM(){this.im&&this.im.close()},initIM(){const n=_e(),c=de();this.im=n,n.connect(c.user_id),n.on("message",e=>{!e.data||e.msg_type!=="receiver_notify"||((e.change=="create"||e.change=="update")&&this.onAddReceiver(e),e.change=="delete"&&this.onDeleteReceiver(e),(e.change=="c_message"||e.change=="ai_message")&&this.onAddMessage(e))})},onAddMessage(n){if(!this.activeChat)return;const c=te();let e=n.data;this.activeChat.session_id==e.session_id&&(e.displayName=e.name||e.nickname,e.dispayTime=G(e.create_time),e.uid=Y(32),e.loading=!1,e.menu_json&&typeof e.menu_json=="string"&&(e.menu_json=JSON.parse(e.menu_json)),e.quote_file&&typeof e.quote_file=="string"&&(e.quote_file=JSON.parse(e.quote_file)),this.messageList.push(e),c.emit("onAddMessage",e))},onAddReceiver(n){let c=n.data;c.displayName=c.name||c.nickname,c.come_from=JSON.parse(c.come_from);let e=this.receiverList.find(s=>s.session_id==c.session_id);e?Object.assign(e,c):(this.selectedRobotId==""||this.selectedRobotId==c.robot_id)&&this.receiverList.unshift(c)},onDeleteReceiver(n){let c=n.data,e=this.receiverList.findIndex(s=>s.id==c);e!=-1&&(this.activeChat&&this.activeChat.id==c&&(this.activeChat=null),this.receiverList.splice(e,1))},async getRobotList(n){return re(n).then(c=>(this.robotList=c.data||[],c))},async getReceiverList(n){return n!=null&&n.page?this.receiverListPage.page=n==null?void 0:n.page:this.receiverListPage.page++,Te({...this.receiverListPage,robot_id:this.selectedRobotId,...n}).then(c=>{let e=c.data.list||[];for(let s=0;s<e.length;s++)e[s].displayName=e[s].name||e[s].nickname,e[s].come_from&&(e[s].come_from=JSON.parse(e[s].come_from));return this.receiverListPage.page==1?this.receiverList=e:this.receiverList=this.receiverList.concat(e),c})},changeRobot(n){this.activeChat=null,this.resetReceiverList(n)},resetReceiverList(n){return this.receiverListPage.page=0,this.receiverList=[],this.getReceiverList(n)},async getChatMessage(){if(this.messageListLoading)return;this.messageListLoading=!0;let n=0,c=this.messageList.filter(s=>!s.isWelcome);c.length>0&&(n=c[0].id);let e={robot_key:this.activeChat.robot_key,openid:this.activeChat.openid,min_id:n,size:this.chatMessagePageSize};return Ce(e).then(s=>{var L,m;this.messageListLoading=!1;let t=s.data.list||[];const u=((L=s==null?void 0:s.data)==null?void 0:L.customer)||{},h=((m=s==null?void 0:s.data)==null?void 0:m.robot)||{};t.sort((o,v)=>o.id-v.id);for(let o=0;o<t.length;o++)t[o].displayName=t[o].name||t[o].nickname,t[o].is_customer==1?(t[o].displayName=t[o].displayName||u.name,t[o].avatar=t[o].avatar||u.avatar):(t[o].displayName=t[o].displayName||h.robot_name,t[o].avatar=t[o].avatar||h.robot_avatar),t[o].uid=Y(32),t[o].menu_json&&typeof t[o].menu_json=="string"&&(t[o].menu_json=JSON.parse(t[o].menu_json)),t[o].quote_file&&typeof t[o].menu_json=="string"&&(t[o].quote_file=JSON.parse(t[o].quote_file)),t[o].dispayTime=G(t[o].create_time);return this.messageList=[...t,...this.messageList],t.length<this.chatMessagePageSize&&(this.chatMessageLoadCompleted=!0),s}).catch(s=>{this.messageListLoading=!1})},claerUnread(){return $e({id:this.selectedReceiverId})},async switchChat(n){this.chatMessageLoadCompleted=!1,this.messageListLoading=!1,this.messageList=[],this.messageListScrollTop=0,this.selectedReceiverId=n.id,this.activeChat=n,this.claerUnread(),await this.getChatMessage()}}}),we={class:"no-data"},Re={class:"no-data-text"},xe={__name:"list-empty",props:{text:{type:String,default:"暂无数据"},size:{type:[Number,String],default:100}},setup(n){const c=n;return(e,s)=>{const t=V;return l(),r("div",we,[R(t,{name:"empty",style:ae({"font-size":`${c.size}px`})},null,8,["style"]),i("div",Re,[Q(e.$slots,"default",{},()=>[H(p(c.text),1)],!0)])])}}},se=B(xe,[["__scopeId","data-v-9f7736f0"]]),Me={key:1,class:"chat-list"},Ie=["onClick"],Ne={class:"avatar"},De=["src","alt"],Be={class:"chat-info"},Oe={class:"nickname"},qe={class:"last-message"},je={class:"webapp-source"},Ae={key:0,class:"loading-wrapper"},ze={key:1,class:"finished-text"},He={__name:"chat-list ",emits:["switchChat"],setup(n,{expose:c,emit:e}){A.use(pe),A.use(me),A.use(fe),A.use(ve);const s=e,t=F(),{getReceiverList:u}=t,{receiverList:h,selectedReceiverId:L}=U(t),m=$(null);let o=null;const v=$(!1),k=$(!1),w=()=>{o=new A(m.value,{scrollY:!0,click:!0,observeDOM:!0,mouseWheel:!0,bounce:!1,scrollbar:{fade:!0,interactive:!0},pullUpLoad:!0}),o.on("pullingUp",()=>{f()})},f=async g=>{if(v.value||k.value){o.finishPullUp();return}v.value=!0;try{(await u(g)).data.list.length===0&&!g.keyword&&(k.value=!0)}catch(S){console.error("加载更多数据失败:",S)}finally{v.value=!1,o.finishPullUp()}},_=g=>{s("switchChat",g)};return X(h,g=>{g.length>0&&z(()=>{o&&o.refresh()})}),Z(()=>{z(()=>{w()})}),K(()=>{o&&o.destroy()}),c({getData:f}),(g,S)=>{const b=ge;return l(),r("div",{class:"scroll-wrapper",ref_key:"scrollRef",ref:m},[C(h).length==0?(l(),q(se,{key:0,size:"140",text:"暂无机器人接待中会话"})):(l(),r("div",Me,[(l(!0),r(M,null,I(C(h),a=>(l(),r("div",{key:a.id,class:P(["chat-item",{active:a.id===C(L)}]),onClick:T=>_(a)},[i("div",Ne,[i("img",{src:a.avatar,alt:a.displayName},null,8,De),a.unread>0?(l(),r("span",{key:0,class:P(["dot",{plus:a.unread>9}])},p(a.unread),3)):x("",!0)]),i("div",Be,[i("div",Oe,p(a.displayName),1),i("div",qe,p(a.last_chat_message),1),i("div",je,"来自："+p(a.come_from.app_name),1)])],10,Ie))),128)),v.value?(l(),r("div",Ae,[R(b,{size:"small"}),S[0]||(S[0]=i("span",{class:"loading-text"},"加载中...",-1))])):x("",!0),k.value?(l(),r("div",ze,"没有更多了")):x("",!0)]))],512)}}},Pe=B(He,[["__scopeId","data-v-7b8e9eac"]]),Ue={__name:"chat-message-scroll",props:{topTriggerDistance:{type:Number,default:10},bottomTriggerDistance:{type:Number,default:40},isLoading:{type:Boolean,default:!1},scrollTop:{type:Number,default:0}},emits:["scroll-top","scroll-bottom","scroll"],setup(n,{expose:c,emit:e}){const s=n,t=e,u=$(null),h=$({scrollTop:0,scrollHeight:0,clientHeight:0,scrollDirection:"down",scrollStartDiff:s.topTriggerDistance,scrollEndDiff:s.bottomTriggerDistance}),L=$(null),m=_=>{const{scrollTop:g}=_,S=h.value.scrollTop-g;h.value.scrollDirection=S>0?"up":"down",Object.assign(h.value,{scrollTop:g,scrollHeight:_.scrollHeight,clientHeight:_.clientHeight})},o=()=>{const{scrollTop:_,scrollHeight:g,clientHeight:S,scrollStartDiff:b,scrollEndDiff:a,scrollDirection:T}=h.value;t("scroll",{...h.value}),s.isLoading||(Math.abs(_)<=b&&T==="up"&&t("scroll-top",{...h.value}),Math.abs(g-_-S)<=a&&T==="down"&&t("scroll-bottom",{...h.value}))},v=_=>{m(_.target),L.value&&(clearTimeout(L.value),L.value=null),L.value=setTimeout(()=>{o()},100)};function k(){u.value&&(u.value.scrollTop=0)}function w(){u.value&&(u.value.scrollTop=u.value.scrollHeight)}function f(){return u.value&&Object.assign(h.value,{scrollTop:u.value.scrollTop,scrollHeight:u.value.scrollHeight,clientHeight:u.value.clientHeight}),JSON.parse(JSON.stringify(h.value))}return X(()=>s.scrollTop,_=>{u.value&&(u.value.scrollTop=_)}),c({scrollToTop:k,scrollToBottom:w,getState:f}),(_,g)=>(l(),r("div",{class:"chat-message-scroll",ref_key:"scrollContainer",ref:u,onScroll:v},[Q(_.$slots,"default",{},void 0,!0)],544))}},Fe=B(Ue,[["__scopeId","data-v-3e3a1c2e"]]),Je={class:"chat-message-warpper"},Ee={class:"chat-message-content"},Ve={key:0,class:"is-loaded"},We={class:"avatar"},Ye=["src","alt"],Ge={class:"message-content"},Qe={class:"message-info"},Xe={class:"nickname"},Ze={class:"time"},Ke={class:"message-bubble"},et={key:0,class:"text-content"},tt={key:1},st={key:1,class:"image-content"},ot=["src"],it={key:2,class:"menu-content"},at={class:"menus-label"},nt={key:0,class:"menu-items"},lt=["onClick"],ct={key:3,class:"answer-reference-box"},rt=["onClick"],dt={__name:"chat-message",emits:["openLibrary"],setup(n,{expose:c,emit:e}){const s=e,t=$(null),u=F(),{getChatMessage:h}=u,{messageList:L,messageListScrollTop:m,messageListLoading:o,chatMessageLoadCompleted:v,activeChat:k}=U(u),w=()=>{};function f(T,y,N){let d=W(T);y.robot_key=k.value.robot_key,y.robot_id=k.value.robot_id,d.forEach(O=>{O.message_id=N.id,O.openid=N.openid,O.robot_key=k.value.robot_key,O.robot_id=k.value.robot_id}),s("openLibrary",d,W(y))}const _=T=>{const{scrollTop:y}=T;m.value=y},g=async()=>{if(v.value)return;let T=t.value.getState();await h(),z(()=>{let y=t.value.getState();y.scrollDirection=="up"&&(m.value=y.scrollHeight-T.scrollHeight)})},S=async()=>{};return c({scrollToTop:()=>{t.value.scrollToTop()},scrollToBottom:()=>{t.value.scrollToBottom()}}),(T,y)=>{const N=V;return l(),r("div",Je,[R(Fe,{ref_key:"scrollViewRef",ref:t,scrollTop:C(m),"onUpdate:scrollTop":y[0]||(y[0]=d=>ee(m)?m.value=d:null),"is-loading":C(o),onScroll:_,onScrollTop:g,onScrollBottom:S},{default:D(()=>[i("div",Ee,[C(v)?(l(),r("div",Ve,"没用更多聊天记录了")):x("",!0),(l(!0),r(M,null,I(C(L),(d,O)=>(l(),r("div",{key:O,class:P(["message-item",d.is_customer==0?"right":""])},[i("div",We,[i("img",{src:d.avatar,alt:d.displayName},null,8,Ye)]),i("div",Ge,[i("div",Qe,[i("span",Xe,p(d.displayName),1),y[1]||(y[1]=i("i",{class:"gap"},null,-1)),i("span",Ze,p(d.dispayTime),1)]),i("div",Ke,[d.msg_type==1?(l(),r("div",et,[d.is_customer==0?(l(),q(he,{key:0,content:d.content},null,8,["content"])):(l(),r("div",tt,p(d.content),1))])):d.msg_type==3?(l(),r("div",st,[i("img",{src:d.content,alt:"image"},null,8,ot)])):d.msg_type==2?(l(),r("div",it,[i("div",at,p(d.menu_json.content),1),d.menu_json.question&&d.menu_json.question.length>0?(l(),r("div",nt,[(l(!0),r(M,null,I(d.menu_json.question,(j,J)=>(l(),r("div",{key:J,class:"menu-item",onClick:oe=>w(j)},p(j),9,lt))),128))])):x("",!0)])):x("",!0),d.quote_file&&d.quote_file.length?(l(),r("div",ct,[y[2]||(y[2]=i("div",{class:"answer-reference-label"},"回答参考",-1)),i("div",null,[(l(!0),r(M,null,I(d.quote_file,(j,J)=>(l(),r("div",{class:"list-item",key:J},[R(N,{name:"attachment"}),i("span",{onClick:oe=>f(d.quote_file,j,d)},p(j.file_name),9,rt)]))),128))])])):x("",!0)])])],2))),128))])]),_:1},8,["scrollTop","is-loading"])])}}},ut=B(dt,[["__scopeId","data-v-97ee52a0"]]),_t={class:"library-info-content"},ht={class:"file-list"},pt=["onClick"],mt={class:"document-items"},vt={class:"document-item-header"},ft={class:"left-box"},gt={class:"document-title"},yt={key:0,class:"document-title"},bt={class:"document-size"},Lt={class:"document-item-body"},kt={class:"document-similarity"},St={key:0,class:"document-content"},Tt={key:1,class:"document-content"},Ct={class:"document-content"},$t={class:"fragment-img"},wt=["src"],Rt={__name:"library-info-alert",setup(n,{expose:c}){const e=ne(),s=$(!1),t=$([]),u=$(null),h=()=>{t.value=[],u.value=null},L=(f,_)=>{h(),t.value=f,u.value=_.id,s.value=!0,v(_)},m=f=>{f.id!=u.value&&(u.value=f.id,v(f))},o=$([]),v=f=>{ye({message_id:f.message_id,file_id:f.id,robot_key:f.robot_key,openid:f.openid}).then(_=>{o.value=_.data||[]})},k=()=>{e.push("/library/preview?id="+u.value)},w=()=>{s.value=!1};return c({open:L}),(f,_)=>{const g=V,S=be,b=le("viewer");return l(),q(S,{class:"library-info-alert",open:s.value,"onUpdate:open":_[0]||(_[0]=a=>s.value=a),title:"答案来源",placement:"right",width:"746px",closable:!1,bodyStyle:{background:"#F2F4F7"}},{extra:D(()=>[i("span",{class:"close-btn",onClick:w},[R(C(ue))])]),default:D(()=>[i("div",_t,[i("div",ht,[(l(!0),r(M,null,I(t.value,a=>(l(),r("div",{class:P(["file-item",{active:u.value==a.id}]),key:a.id,onClick:T=>m(a)},p(a.file_name),11,pt))),128))]),i("div",mt,[(l(!0),r(M,null,I(o.value,a=>(l(),r("div",{class:"document-item",key:a.id},[i("div",vt,[i("div",ft,[i("span",gt,"id："+p(a.id),1),a.title?(l(),r("span",yt,p(a.title),1)):x("",!0),i("span",bt," 共"+p(a.word_total)+"个字符 ",1)]),i("div",{class:"right-box"},[i("a",{onClick:k},"查看源文档>")])]),i("div",Lt,[i("div",kt,[_[1]||(_[1]=H(" 相似度： ")),R(g,{name:"similarity",style:{"font-size":"16px"}}),H(p(a.similarity),1)]),a.question?(l(),r("div",St,"Q："+p(a.question),1)):x("",!0),a.answer?(l(),r("div",Tt,"A："+p(a.answer),1)):x("",!0),i("div",Ct,p(a.content),1),ce((l(),r("div",$t,[(l(!0),r(M,null,I(a.images,(T,y)=>(l(),r("img",{key:y,src:T,alt:""},null,8,wt))),128))])),[[b]])])]))),128))])])]),_:1},8,["open"])}}},xt=B(Rt,[["__scopeId","data-v-3e30a1b1"]]),Mt={key:0,class:"chat-box-warpper"},It={class:"chat-box-header"},Nt={class:"nickname"},Dt={class:"chat-source"},Bt={class:"chat-box-content"},Ot={key:1},qt={__name:"chat-box",setup(n,{expose:c}){const e=F(),{activeChat:s}=U(e),t=$(null),u=()=>{t.value.scrollToBottom()},h=()=>{t.value.scrollToTop()},L=$(null),m=(o,v)=>{L.value.open(o,v)};return c({scrollToTop:h,scrollToBottom:u}),(o,v)=>(l(),r(M,null,[C(s)?(l(),r("div",Mt,[i("div",It,[i("div",Nt,p(C(s).name||C(s).nickname),1),i("div",Dt," 来自："+p(C(s).come_from.robot_name)+" - "+p(C(s).come_from.app_name),1)]),i("div",Bt,[R(ut,{ref_key:"chatMessageRef",ref:t,onOpenLibrary:m},null,512)])])):(l(),r("div",Ot)),R(xt,{ref_key:"libraryInfoAlertRef",ref:L},null,512)],64))}},jt=B(qt,[["__scopeId","data-v-1d47d849"]]),At={class:"chat-monitor-page"},zt={class:"page-left"},Ht={class:"app-list-box"},Pt={class:"search-box"},Ut={class:"chat-list-wrapper"},Ft={class:"page-body"},Jt={__name:"index",setup(n){const c=te(),e=F(),{init:s,changeRobot:t,switchChat:u,closeIM:h}=e,{robotList:L,selectedRobotId:m,activeChat:o}=U(e),v=$(null),k=$(null),w=$(""),f=()=>{const b={keyword:w.value,page:1};t(b)},_=async b=>{var a;await u(b),(a=k.value)==null||a.scrollToBottom()},g=()=>{z(()=>{var b;(b=k.value)==null||b.scrollToBottom()})},S=()=>{const b={keyword:w.value,page:1};v.value&&v.value.getData(b)};return Z(async()=>{await s(),z(()=>{var b;(b=k.value)==null||b.scrollToBottom()}),c.on("onAddMessage",g)}),K(()=>{c.off("onAddMessage",g),h()}),(b,a)=>{const T=ke,y=Le,N=Se;return l(),r("div",At,[i("div",zt,[i("div",Ht,[R(y,{value:C(m),"onUpdate:value":a[0]||(a[0]=d=>ee(m)?m.value=d:null),style:{width:"100%"},onChange:f},{default:D(()=>[R(T,{value:""},{default:D(()=>a[2]||(a[2]=[H("全部应用")])),_:1,__:[2]}),(l(!0),r(M,null,I(C(L),d=>(l(),q(T,{value:d.id,key:d.id},{default:D(()=>[i("span",null,p(d.robot_name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),i("div",Pt,[R(N,{value:w.value,"onUpdate:value":a[1]||(a[1]=d=>w.value=d),placeholder:"搜索客户昵称或openld，按enter搜索","enter-button":"",style:{width:"100%"},onSearch:S,allowClear:"",onPressEnter:S},null,8,["value"])]),i("div",Ut,[R(Pe,{ref_key:"chatListRef",ref:v,onSwitchChat:_},null,512)])]),i("div",Ft,[C(o)?(l(),q(jt,{key:0,ref_key:"chatBoxRef",ref:k},null,512)):(l(),q(se,{key:1,style:{background:"#F2F4F7"},size:"250"},{default:D(()=>a[3]||(a[3]=[i("div",null,[i("p",null,"请在左侧列表先选择会话"),i("p",null,"通过本功能，可以实时查看机器人接待中的会话消息，监控机器人回复效果")],-1)])),_:1,__:[3]}))])])}}},Ts=B(Jt,[["__scopeId","data-v-c690c066"]]);export{Ts as default};
