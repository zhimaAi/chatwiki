import{d as y,z as W,q as G,w as N,N as m,O as d,X as e,j as b,U as $,F as O,a1 as V,u as U,S as ee,Z as M,_ as k,ag as te,a5 as Se,H as F,a6 as R,x as K,a3 as Te,a8 as ke,D as xe,a2 as De}from"./vue-chunks-BRsu9_To.js";import{n as C,k as $e,b as j,bF as Q,B as Ce,M as we}from"../../index-Bo1NSLpy.js";import{a as Ee,_ as Ie}from"./RadioButton-CWIeNl_M.js";import{R as Le}from"./dayjs-CU3n21qy.js";import{_ as se}from"./empty-DkpCLaix.js";import{_ as He}from"./index-Gd9vpppW.js";import{S as Me}from"./index-eahgXICC.js";import{u as Be}from"./robot-ppsw7ttj.js";import{u as Re}from"./chat-DnVHVWxx.js";import{c as Oe}from"./index-z8pRRkmq.js";import{S as Ue,a as Ae}from"./index-Bs02Ec-o.js";import{R as qe}from"./index-thzOhi6-.js";import{_ as ze}from"./Search-BF8URtRh.js";import{_ as Ne}from"./index-Bbrx8UDU.js";import"./axios-Dq7h7Pqt.js";import"./qs-BrxkIg-9.js";import"./crypto-js-ClNpte_9.js";import"./dayjs-B6IotFah.js";import"./FormItemContext-Cv3f2sEj.js";import"./Checkbox-B_uQPvVs.js";import"./index-6kOkS7uh.js";import"./index-D-M8_C_F.js";import"./colors-4myZb9T8.js";import"./ClockCircleOutlined-mLHYPvMf.js";import"./useMergedState-C0iIHNGF.js";import"./Trigger-DtRTHvld.js";import"./ResizeObserver.es-B1PUzC5B.js";import"./shallowequal-C0xnIuy8.js";import"./index-CuPJUS8f.js";import"./move-DztQgbGg.js";import"./slide-CVAZ5BEM.js";import"./index-BwedndIp.js";import"./index-L62dqcZj.js";import"./useEventBus-BwH2zX88.js";import"./useIM-BHirVHcM.js";import"./index-BjF4Ni-g.js";import"./List-qVz67bUg.js";import"./DownOutlined-CrhRpWT5.js";import"./CheckOutlined-C6m5maw6.js";import"./SearchOutlined-CFTHZIcT.js";import"./Input-CCKFAS4o.js";import"./inputProps--_pnbyjO.js";import"./isPlainObject-CHj0iPA3.js";const Ve={class:"zm-date"},je={class:"date-btn"},Pe={class:"date-content"},Ye={__name:"date",props:{datekey:{type:String,default:"1"}},emits:["dateChange"],setup(E,{emit:I}){const x=E,c=y(1),p=I;let S=W([{label:"今日",value:!0,key:2,start_time:C().startOf("day"),end_time:C().endOf("day")},{label:"昨日",value:!1,key:3,start_time:C().subtract(1,"day").startOf("day"),end_time:C().startOf("day").subtract(1,"millisecond")},{label:"近7日",value:!1,key:4,start_time:C().subtract(6,"day").startOf("day"),end_time:C().endOf("day").subtract(1,"millisecond")}]);const _=y(null),s=y(null),v=y([]),a=h=>h>=C().subtract(0,"day"),D=()=>{let h=c.value,n=null;S.forEach(l=>{l.key==h&&(n=l)}),n&&(v.value=[n.start_time,n.end_time],_.value=n.start_time.unix(),s.value=n.end_time.unix()),H()},L=h=>{const n=C(h[0]).startOf("day");if(C(h[1]).endOf("day").diff(n,"days")>29)v.value[0]=h[0].startOf("day"),v.value[1]=n.add(29,"days").endOf("day"),_.value=v.value[0].unix(),s.value=v.value[1].unix(),$e.error("最多只能选择30天");else{const u=C(h[0]).startOf("day").unix(),f=C(h[1]).endOf("day").unix();v.value=h,_.value=u,s.value=f}c.value=1,H()},H=()=>{p("dateChange",{start_time:_.value,end_time:s.value})};return G(()=>{c.value=parseInt(x.datekey),D()}),N(()=>x.datekey,(h,n)=>{c.value=parseInt(x.datekey.split("-")[0]),D()}),(h,n)=>{const l=Ee,u=Ie,f=Le;return d(),m("div",Ve,[e("div",je,[b(u,{value:c.value,"onUpdate:value":n[0]||(n[0]=o=>c.value=o),onChange:D},{default:$(()=>[(d(!0),m(O,null,V(U(S),o=>(d(),ee(l,{class:"date-btn-button",value:o.key,key:o.key},{default:$(()=>[M(k(o.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),e("div",Pe,[b(f,{value:v.value,"onUpdate:value":n[1]||(n[1]=o=>v.value=o),onChange:L,format:"YYYY-MM-DD",disabledDate:a,allowClear:!1},null,8,["value"])])])}}},Fe={key:0,class:"empty-box"},Ge=["onClick"],Xe={class:"user-item-left"},Ze=["src"],Je={class:"user-item-right"},Ke={class:"user-name-box"},Qe={class:"user-name"},We={class:"user-timer"},et={class:"user-info"},tt={class:"user-source-box"},st={class:"user-source-content"},ot={__name:"user",props:{userList:{type:Array,default:null},channelItem:{type:Array,default:null}},emits:["userClick","userScroll","userScrollStart","userScrollEnd"],setup(E,{emit:I}){const x=y(null),c=E,p=I,S=y([]),_=y([]),s=y({}),v=l=>{s.value=l,p("userClick",l)},a={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let D=null;function L(l){D&&(clearTimeout(D),D=null),D=setTimeout(()=>{a.scrollTop-l.target.scrollTop>0&&(a.scrollDirection="up"),a.scrollTop-l.target.scrollTop<0&&(a.scrollDirection="down"),a.scrollTop=l.target.scrollTop,a.scrollHeight=l.target.scrollHeight,a.clientHeight=l.target.clientHeight,p("userScroll",{...a}),Math.abs(a.scrollTop)<=a.scrollStartDiff+100&&a.scrollDirection==="up"&&H(),Math.abs(a.scrollHeight-a.scrollTop-a.clientHeight)<=a.scrollEndDiff&&a.scrollDirection==="down"&&h()},50)}function H(){c.userList.length!=0&&p("userScrollStart",{msg:c.userList[0]})}function h(){c.userList.length!=0&&p("userScrollEnd",{msg:c.userList[c.userList.length-1]})}N(()=>c.userList,l=>{S.value=l,S.value.length>0&&S.value.length<=20&&(v(S.value[0]),s.value=S.value[0])},{immediate:!0}),N(()=>c.channelItem,l=>{_.value=l},{immediate:!0});const n=l=>{for(let u=0;u<_.value.length;u++)if(l.app_type==_.value[u].app_type&&(l.app_id||"")==_.value[u].app_id)return _.value[u].app_name};return G(()=>{S.value=c.userList,_.value=c.channelItem}),(l,u)=>{const f=te("ftime");return d(),m("div",{class:"user-content",ref_key:"scrollUserBoxRef",ref:x,onScroll:L},[S.value.length===0?(d(),m("div",Fe,u[0]||(u[0]=[e("img",{src:se,alt:""},null,-1),e("div",{class:"title"},"暂无结果，请重试",-1)]))):(d(!0),m(O,{key:1},V(S.value,o=>(d(),m("div",{class:Se(["user-item",{active:o.openid==s.value.openid}]),onClick:t=>v(o),key:o.session_id},[e("div",Xe,[e("img",{class:"user-img",src:o.avatar,alt:""},null,8,Ze)]),e("div",Je,[e("div",Ke,[e("div",Qe,k(o.name),1),F((d(),m("div",We,[M(k(o.last_chat_time),1)])),[[f,"MM-DD HH:mm"]])]),e("div",et,k(o.last_chat_message),1),e("div",tt,[u[1]||(u[1]=e("div",{class:"user-source-title"},"来自：",-1)),e("div",st,k(n(o)),1)])])],10,Ge))),128))],544)}}},lt=j(ot,[["__scopeId","data-v-9b907563"]]),at={class:"message-box"},nt={class:"message-top-box"},rt={class:"message-top-title"},it={key:0,class:"message-top-source"},ct={class:"message-list"},ut={key:0,class:"empty-box"},dt=["id"],pt={class:"itme-right"},_t={class:"message-info"},mt={class:"item-body"},vt={class:"message-content"},ft={class:"user-avatar-box"},gt=["src"],yt=["id"],ht={class:"itme-left"},bt=["src"],St={class:"itme-right"},Tt={class:"message-info"},kt={class:"item-body"},xt={key:0,class:"message-content"},Dt=["innerHTML"],$t={key:2,class:"message-content"},Ct=["src"],wt={key:2,class:"loading-box"},Et={__name:"message-list",props:{messages:{type:Array,default:()=>[]},robotInfo:{type:Object,default:()=>{}},isEmpty:{type:Boolean,default:()=>!1},sessionSource:{type:String,default:()=>null},channelItem:{type:Array,default:()=>[]}},emits:["scroll","scrollStart","scrollEnd"],setup(E,{expose:I,emit:x}){const c=x,p=E,S=y(!1),_=y(null),s={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let v=null,a=!1;const D=f=>{let o;for(let t=0;t<p.channelItem.length;t++){const T=p.channelItem[t];T.app_type===f&&(o=T.app_name)}return o};function L(f){a||(v&&(clearTimeout(v),v=null),v=setTimeout(()=>{s.scrollTop-f.target.scrollTop>0&&(s.scrollDirection="up"),s.scrollTop-f.target.scrollTop<0&&(s.scrollDirection="down"),s.scrollTop=f.target.scrollTop,s.scrollHeight=f.target.scrollHeight,s.clientHeight=f.target.clientHeight,c("scroll",{...s}),Math.abs(s.scrollTop)<=s.scrollStartDiff&&s.scrollDirection==="up"&&H(),Math.abs(s.scrollHeight-s.scrollTop-s.clientHeight)<=s.scrollEndDiff&&s.scrollDirection==="down"&&h()},100))}function H(){p.messages.length!=0&&c("scrollStart",{msg:p.messages[0]})}function h(){p.messages.length!=0&&c("scrollEnd",{msg:p.messages[p.messages.length-1]})}const n=()=>{_.value&&K(()=>{a=!0,_.value.scrollTop=_.value.scrollHeight+1,setTimeout(()=>{s.scrollTop=_.value.scrollTop,a=!1},50)})};function l(f,o){K(()=>{a=!0,o||(o="top");let t=_.value,T=document.querySelector("#msg-"+f);T&&(o=="top"?t.scrollTop=T.offsetTop:t.scrollTop=T.offsetTop-t.clientHeight+T.clientHeight),setTimeout(()=>{s.scrollTop=_.value.scrollTop,a=!1},50)})}function u(){s.scrollTop=0,s.scrollDirection=""}return I({scrollToBottom:n,scrollToMessage:l,resetScroll:u}),(f,o)=>{const t=Me,T=te("viewer");return d(),m("div",at,[e("div",nt,[e("div",rt,k(p.robotInfo.robot_name),1),E.sessionSource?(d(),m("div",it,"("+k(D(E.sessionSource))+")",1)):R("",!0)]),e("div",{class:"message-list-wrapper",ref_key:"scrollBoxRef",ref:_,onScroll:L},[e("div",ct,[p.isEmpty||!p.messages?(d(),m("div",ut,o[0]||(o[0]=[e("img",{src:se,alt:""},null,-1),e("div",{class:"title"},"暂无结果，请重试",-1)]))):(d(!0),m(O,{key:1},V(p.messages,g=>(d(),m(O,{key:g.uid},[g.is_customer==1?(d(),m("div",{key:0,class:"message-item user-message",id:"msg-"+g.uid},[e("div",pt,[e("div",_t,[e("span",null,k(U(Q)(g.create_time)),1),e("span",null,k(g.name),1)]),e("div",mt,[e("div",vt,k(g.content),1)])]),e("div",ft,[e("img",{class:"user-avatar",src:g.avatar},null,8,gt)])],8,dt)):(d(),m("div",{key:1,class:"message-item robot-message",id:"msg-"+g.uid},[e("div",ht,[b(t,{size:"small",spinning:g.loading},{default:$(()=>[e("img",{class:"robot-avatar",src:g.robot_avatar},null,8,bt)]),_:2},1032,["spinning"])]),e("div",St,[e("div",Tt,[e("span",null,k(U(Q)(g.create_time)),1),e("span",null,k(g.name),1)]),e("div",kt,[g.msg_type==1?F((d(),m("div",xt,[b(He,{content:g.content},null,8,["content"])])),[[T]]):R("",!0),g.msg_type==2?(d(),m("div",{key:1,class:"message-content",innerHTML:g.menu_json.content},null,8,Dt)):R("",!0),g.msg_type==3?(d(),m("div",$t,[F(e("img",{class:"msg-img",src:g.content,alt:""},null,8,Ct),[[T]])])):R("",!0)])])],8,yt))],64))),128)),S.value?(d(),m("div",wt,[b(t)])):R("",!0)])],544)])}}},It=j(Et,[["__scopeId","data-v-9b2c823e"]]),Lt={class:"team-members-pages"},Ht={class:"set-model"},Mt={class:"set-model-body"},Bt={class:"set-date"},Rt={class:"set-date-body"},Ot={class:"set-name"},Ut={class:"set-reset"},At={class:"list-box"},qt={class:"user-box"},zt={class:"records-box"},Nt={__name:"session-record",setup(E){const I=y(!1),x=De(),c=Te(),p=c.query,S=Be(),{robotInfo:_}=S,s=Re(),{messageList:v}=ke(s);let a=!0;const{createMsg:D,onGetChatMessage:L,getRecordList:H,getChannelList:h}=s,n=y(null),l=y([]),u=y([]),f=y(""),o=y("1"),t=W({robot_id:p.id,app_type:"all",app_id:"all",start_time:"",end_time:"",name:"",page:1,size:20}),T=y(!1),g=r=>{t.start_time=r.start_time,t.end_time=r.end_time,Y()},oe=()=>{t.app_type="all",t.name="",t.page=1,o.value="1-"+Math.random()},A=y(!1),P=y(!1),le=async()=>{let r=X();P.value=!0,await Oe(r),A.value=!0,P.value=!1},ae=()=>{x.push({path:"/robot/config/export-record",query:p})},Y=()=>{t.page=1,Z()},ne=r=>{t.app_type=r,Y()},re=()=>{},ie=r=>{f.value=r.app_type,ve(r)},ce=async()=>{},ue=()=>{T.value&&(t.page++,Z())},de=async()=>{a=!1;let r=v.value[0].uid;await L()&&_e(r)},pe=()=>{n.value&&a&&n.value.scrollToBottom()},_e=r=>{n.value&&n.value.scrollToMessage(r)},me=()=>{n.value&&n.value.resetScroll()};let q=null;const ve=async r=>{a=!0;let B={robot_key:(c.query||{}).robot_key,avatar:r.avatar,name:r.name,nickname:r.name,is_background:1,openid:r.openid};me(),await D(B),q&&(clearTimeout(q),q=null),q=setTimeout(async()=>{await L()&&pe()},100)},fe=async()=>{let r={robot_id:t.robot_id};const i=await h(r);l.value=[{app_type:"all",app_name:"全部渠道"},...i.data]},X=()=>{let r={robot_id:t.robot_id,start_time:t.start_time,end_time:t.end_time,name:t.name,page:t.page,size:t.size};return t.app_type!=="all"&&(r.app_type=t.app_type),t.app_id!=="all"&&(r.app_id=t.app_id),r},Z=async()=>{let r=X(),i=await H(r),B=i.data.list||[];t.page==1&&(u.value=[]),u.value=[...u.value,...B],I.value=u.value.length==0,T.value=i.data.has_more};return N(()=>v.value,()=>{}),G(async()=>{fe()}),xe(()=>{}),(r,i)=>{const B=Ae,J=Ue,ge=ze,z=Ce,ye=Ne,he=qe,be=we;return d(),m("div",Lt,[b(ye,{justify:"flex-start",class:"screen-box"},{default:$(()=>[e("div",Ht,[i[4]||(i[4]=e("div",{class:"label set-model-label"},"渠道：",-1)),e("div",Mt,[b(J,{value:t.app_type,"onUpdate:value":i[0]||(i[0]=w=>t.app_type=w),placeholder:"全部渠道",onChange:ne,style:{width:"200px"}},{default:$(()=>[(d(!0),m(O,null,V(l.value,w=>(d(),ee(B,{key:w.app_type,value:w.app_type},{default:$(()=>[e("span",null,k(w.app_name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])])]),e("div",Bt,[i[5]||(i[5]=e("div",{class:"label set-date-label"},[e("span",null,"日期：")],-1)),e("div",Rt,[b(Ye,{onDateChange:g,datekey:o.value},null,8,["datekey"])])]),e("div",Ot,[b(ge,{value:t.name,"onUpdate:value":i[1]||(i[1]=w=>t.name=w),placeholder:"请输入用户名称搜索",style:{width:"200px"},onSearch:Y},null,8,["value"])]),e("div",Ut,[b(z,{onClick:oe},{default:$(()=>i[6]||(i[6]=[M("重置")])),_:1,__:[6]}),b(z,{onClick:le,loading:P.value},{default:$(()=>i[7]||(i[7]=[M("导出")])),_:1,__:[7]},8,["loading"])])]),_:1}),e("div",At,[e("div",qt,[b(lt,{channelItem:l.value,userList:u.value,onUserScrollStart:ce,onUserScrollEnd:ue,onUserClick:ie},null,8,["channelItem","userList"])]),e("div",zt,[b(It,{ref_key:"messageListRef",ref:n,isEmpty:I.value,messages:U(v),robotInfo:U(_),channelItem:l.value,sessionSource:f.value,onScrollStart:de,onScrollEnd:re},null,8,["isEmpty","messages","robotInfo","channelItem","sessionSource"])])]),b(be,{open:A.value,"onUpdate:open":i[3]||(i[3]=w=>A.value=w),title:null,footer:null,width:640},{default:$(()=>[b(he,{status:"success",title:"导出任务创建成功","sub-title":"系统会在后台导出。导出数据量越大，耗时越久。您可以稍后点击导出记录查看并下载导出的文件。"},{extra:$(()=>[b(z,{style:{"margin-right":"16px"},onClick:i[2]||(i[2]=w=>A.value=!1)},{default:$(()=>i[8]||(i[8]=[M("知道了")])),_:1,__:[8]}),b(z,{onClick:ae,type:"primary"},{default:$(()=>i[9]||(i[9]=[M("去下载")])),_:1,__:[9]})]),_:1})]),_:1},8,["open"])])}}},Vt=j(Nt,[["__scopeId","data-v-b5e3e1a3"]]),jt={class:"user-model-page"},Pt={class:"list-wrapper"},Yt={__name:"index",setup(E){return(I,x)=>(d(),m("div",jt,[x[0]||(x[0]=e("div",{class:"page-title"},"会话记录",-1)),e("div",Pt,[b(Vt)])]))}},Rs=j(Yt,[["__scopeId","data-v-bcc51f14"]]);export{Rs as default};
