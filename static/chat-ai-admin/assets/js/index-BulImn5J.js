import{_ as H,b as Y,b$ as Z,d as J,N as be,B as he,c3 as te,c as ye,c4 as ge,c5 as ke,bX as xe,aw as we,aY as Se}from"../../index-WMhSApoa.js";import{r as q,e as W,f as L,w as Ce,o as X,ac as k,as as t,k as e,at as l,u as a,ar as o,ae as z,az as P,G as C,F as G,ax as se,ad as u,c as oe,aA as Le,ai as $e,n as De,A as Ie,y as Ue,B as ee,aw as Be,J as Oe,p as ae}from"./vue-chunks-CGLjTDrY.js";import{C as Re}from"./config-page-menu-DZBa7NgR.js";import{u as ze}from"./index-DDxZfOgt.js";import{e as le,w as ne,x as re,ao as Pe,y as Me,I as Ae,B as ie,F as ce,b as M,z as Fe,a1 as _e,M as je,a6 as Ne,k as Te,D as qe,h as Ee,i as Ve,bH as Ge,aN as He,G as We}from"./ui-antd-BDReVt-O.js";import{B as V,P as Ye,S as Je,M as Xe}from"./pull-up.esm-DIiTC7VE.js";import{d as ue}from"./role_avatar-DL0r08JY.js";import"./neo4j-CK9lNpyi.js";import"./utils-DXEytJvC.js";import"./other-BrZCAsTs.js";const Ke={class:"form-box"},Qe={class:"form-box-header"},Ze={class:"form-box-label"},ea={class:"form-box-label-text"},aa={class:"share-url-box"},ta={href:"/#/user/domain"},sa={__name:"permissions-form",props:{value:{type:Object,default:()=>({})},saveLoading:{type:Boolean,default:!1}},emits:["submit","update:value"],setup(A,{emit:r}){const{t:f}=Y("views.public-library.permissions.components.permissions-form"),{toClipboard:d}=ze(),y=r,U=A,n=q({access_rights:"0",share_url:void 0,library_key:""}),h=W(()=>n.share_url+Z+"/home/"+n.library_key),x=()=>{y("submit",n)},s=L([]),m=()=>{be().then(p=>{s.value=p.data||[],n.share_url||s.value.length>0&&(n.share_url=s.value[0].url)})},O=p=>{n.access_rights=p.access_rights,n.share_url=p.share_url,n.library_key=p.library_key,(s.value.length==0||!n.share_url)&&m()},F=async()=>{if(!n.share_url){M.error(f("please_select_domain"));return}let p=h.value;try{await d(p),M.success(f("copy_success"))}catch{M.error(f("copy_failed"))}};return Ce(U.value,p=>{O({...p})}),X(()=>{m()}),(p,$)=>{const w=J,B=re,c=ne,i=le,S=Fe,v=Me,j=Ae,R=Pe,N=ie,T=ce;return u(),k("div",Ke,[t("div",Qe,[t("div",Ze,[e(w,{name:"auth",style:{"font-size":"14px",color:"#333"}}),t("span",ea,l(a(f)("access_rights")),1)]),$[2]||($[2]=t("div",null,null,-1))]),e(T,{"label-col":{span:4},style:{width:"750px"}},{default:o(()=>[e(i,{label:a(f)("access_rights")},{default:o(()=>[e(c,{value:n.access_rights,"onUpdate:value":$[0]||($[0]=D=>n.access_rights=D),onChange:x},{default:o(()=>[e(B,{value:"0"},{default:o(()=>[C(l(a(f)("private_option")),1)]),_:1}),e(B,{value:"1"},{default:o(()=>[C(l(a(f)("public_option")),1)]),_:1})]),_:1},8,["value"])]),_:1},8,["label"]),n.access_rights==1?(u(),z(i,{key:0,label:a(f)("copy_link")},{default:o(()=>[t("div",aa,[e(R,{compact:"",style:{width:"600px",display:"flex"}},{default:o(()=>[e(v,{style:{width:"250px"},value:n.share_url,"onUpdate:value":$[1]||($[1]=D=>n.share_url=D),placeholder:a(f)("select_domain_placeholder"),onChange:x},{default:o(()=>[(u(!0),k(G,null,se(s.value,D=>(u(),z(S,{value:D.url,key:D.id},{default:o(()=>[C(l(D.url),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"]),e(j,{disabled:!0,value:a(Z)+"/home/"+n.library_key,style:{width:"350px"}},null,8,["value"])]),_:1}),e(N,{class:"copy-btn",onClick:F},{default:o(()=>[C(l(a(f)("copy")),1)]),_:1})]),t("div",null,[t("a",ta,l(a(f)("add_custom_domain")),1)])]),_:1},8,["label"])):P("",!0)]),_:1})])}}},oa=H(sa,[["__scopeId","data-v-cf51ad5c"]]),la={class:"form-box"},na={class:"collaborator-list-tip"},ra={class:"list-content"},ia={class:"collaborator-grid"},ca=["onClick"],_a={class:"user-info"},ua={class:"user-details"},da={class:"user-name"},pa={class:"user-nickname"},ma={key:0,class:"loading-more"},va={key:1,class:"no-more"},fa={__name:"add-collaborator",props:{excludedIds:{type:Array,default:()=>[]}},emits:["ok"],setup(A,{expose:r,emit:f}){const{t:d}=Y("views.public-library.permissions.components.add-collaborator");V.use(Ye),V.use(Je),V.use(Xe);const y=f,U=A,n=oe("libraryState",{}),h=L(!1),x=L(null),s=L(!1),m=q({permission:"2",collaborators:[]}),O={permission:[{required:!0,message:d("permission_required")}],collaborators:[{required:!0,message:d("collaborator_required"),type:"array",min:1}]},F=_=>{let b=m.collaborators.indexOf(_.id);b>-1?m.collaborators.splice(b,1):m.collaborators.push(_.id)},p=L([]),$=W(()=>p.value.filter(_=>!U.excludedIds.includes(_.id))),w=q({page:1,size:20,total:0,search:""}),B=L(null),c=L(!1),i=L(!1);let S=L(null);const v=()=>{if(S.value){S.value.refresh();return}S.value=new V(B.value,{probeType:2,click:!0,scrollY:!0,bounce:!1,pullUpLoad:!0,scrollbar:{fade:!1,interactive:!0},mouseWheel:{speed:20,invert:!1,easeTime:300}}),S.value.on("pullingUp",j)},j=async()=>{c.value||i.value||(w.page=w.page+1,c.value=!0,await R(),S.value.finishPullUp(),c.value=!1)},R=async()=>{let _={page:w.page,size:w.size,search:w.search};return he(_).then(b=>{let g=b.data.list||[];return w.page==1?p.value=p.value=g:p.value=p.value.concat(g),w.total=+b.data.total,p.value.length>=w.total&&(i.value=!0),Ue(()=>{S.value&&S.value.refresh()}),b})},N=()=>{let _={operate_rights:m.permission,user_ids:m.collaborators.join(","),type:1,library_key:n.library_key};s.value=!0,te(_).then(()=>{h.value=!1,s.value=!1,y("ok",_),M.success(d("add_success"))}).catch(()=>{s.value=!1})},T=async()=>{var _;try{await((_=x.value)==null?void 0:_.validate()),N()}catch(b){console.error("表单验证失败:",b)}},D=()=>{var _;(_=x.value)==null||_.resetFields(),h.value=!1};return r({open:()=>{var _;h.value=!0,(_=x.value)==null||_.resetFields(),w.page=1,R(),setTimeout(()=>{v()},200)}}),(_,b)=>{const g=re,E=ne,Q=le,de=Le("RouterLink"),pe=J,me=_e,ve=ce,fe=je;return u(),z(fe,{open:h.value,"onUpdate:open":b[1]||(b[1]=I=>h.value=I),title:a(d)("title"),width:"760px",confirmLoading:s.value,onOk:T,onCancel:D},{default:o(()=>[t("div",la,[e(ve,{layout:"vertical",model:m,rules:O,ref_key:"formRef",ref:x},{default:o(()=>[e(Q,{name:"permission",label:a(d)("permission_label")},{default:o(()=>[e(E,{value:m.permission,"onUpdate:value":b[0]||(b[0]=I=>m.permission=I)},{default:o(()=>[e(g,{value:"4"},{default:o(()=>[C(l(a(d)("can_manage")),1)]),_:1}),e(g,{value:"2"},{default:o(()=>[C(l(a(d)("can_edit")),1)]),_:1})]),_:1},8,["value"])]),_:1},8,["label"]),e(Q,{name:"collaborators",label:a(d)("collaborator_label")},{default:o(()=>[t("div",na,[C(l(a(d)("tip_text"))+" ",1),e(de,{to:"/user/manage",target:"_blank"},{default:o(()=>[C(l(a(d)("go_add")),1)]),_:1})]),t("div",{class:"collaborator-list",ref_key:"listRef",ref:B},[t("div",ra,[t("div",ia,[(u(!0),k(G,null,se($.value,I=>(u(),k("div",{class:$e(["collaborator-item",{active:m.collaborators.includes(I.id)}]),key:I.id,onClick:ja=>F(I)},[De(e(pe,{name:"check-arrow-filled",class:"check-icon"},null,512),[[Ie,m.collaborators.includes(I.id)]]),t("div",_a,[e(me,{class:"user-avatar",src:I.avatar||a(ue)},null,8,["src"]),t("div",ua,[t("div",da,l(I.user_name),1),t("div",pa,l(I.nick_name),1)])])],10,ca))),128))]),c.value?(u(),k("div",ma,l(a(d)("loading")),1)):P("",!0),i.value?(u(),k("div",va,l(a(d)("no_more")),1)):P("",!0)])],512)]),_:1},8,["label"])]),_:1},8,["model"])])]),_:1},8,["open","title","confirmLoading"])}}},ba=H(fa,[["__scopeId","data-v-54089b6a"]]),ha={class:"collaborator-list-box"},ya={class:"list-tools-box"},ga={class:"list-label"},ka={class:"label-text"},xa={class:"tools-box-right"},wa={class:"list-box"},Sa={key:0,class:"name-cell"},Ca={class:"user-info"},La={class:"username"},$a={class:"nickname"},Da={key:0,class:"role-cell"},Ia={key:1,class:"role-cell"},Ua={href:"#"},Ba={key:1},Oa={__name:"collaborator-list",setup(A){const{t:r}=Y("views.public-library.permissions.components.collaborator-list"),f=ye(),d=oe("libraryState",{}),y=L(null),U=[{title:r("name"),key:"name",width:"40%"},{title:r("role"),dataIndex:"role",key:"role",width:"40%"},{title:r("actions"),key:"action",width:"20%"}],n={4:{label:r("can_manage"),value:"4"},2:{label:r("can_edit"),value:"2"}},h=q({current:1,pageSize:999,total:0}),x=L([]),s=W(()=>x.value.map(c=>c.user_id)),m=(c,i)=>{i.operate_rights=c.key*1,i.operate_rights_label=n[i.operate_rights].label||"",O(i)},O=c=>{let i={operate_rights:c.operate_rights,user_ids:c.user_id,type:2,library_key:d.library_key};te(i).then(()=>{M.success(r("modify_success"))}).catch(()=>{})},F=()=>{y.value.open()},p=c=>{let i={id:c.id,library_key:d.library_key};ke(i).then(()=>{M.success(r("remove_success")),B()}).catch(()=>{})},$=()=>{B()},w=c=>{Object.assign(h,c),B()},B=()=>{ge({library_key:d.library_key,page:h.current,size:h.pageSize}).then(c=>{let i=c.data.list||[],{user_id:S}=f.userInfo;h.total=c.data.total,i.forEach(v=>{v.showDelete=!0,S==v.user_id&&(v.showDelete=!1),v.role_type==1&&(v.showDelete=!1),v.operate_rights=v.operate_rights*1,v.operate_rights_label=r("no_permission"),n[v.operate_rights]&&(v.operate_rights_label=n[v.operate_rights].label)}),x.value=i})};return X(()=>{B()}),(c,i)=>{const S=J,v=ie,j=_e,R=Ve,N=Ee,T=Te,D=He,K=Ge,_=We;return u(),k("div",ha,[t("div",ya,[t("div",ga,[e(S,{name:"collaborator"}),t("span",ka,l(a(r)("collaborator_permissions"))+" ("+l(h.total)+")",1)]),t("div",xa,[e(v,{type:"primary",size:"small",onClick:F},{default:o(()=>[e(a(Ne)),C(" "+l(a(r)("add_collaborator")),1)]),_:1})])]),t("div",wa,[e(_,{columns:U,"data-source":x.value,pagination:h,onChange:w},{bodyCell:o(({column:b,record:g})=>[b.key==="name"?(u(),k("div",Sa,[e(j,{class:"avatar",src:g.avatar||a(ue)},null,8,["src"]),t("div",Ca,[t("div",La,l(g.user_name),1),t("div",$a,l(g.nick_name),1)])])):P("",!0),b.key==="role"?(u(),k(G,{key:1},[g.showDelete?(u(),k("div",Da,[e(T,null,{overlay:o(()=>[e(N,{onClick:E=>m(E,g)},{default:o(()=>[(u(),z(R,{key:4},{default:o(()=>[C(l(a(r)("can_manage")),1)]),_:1})),(u(),z(R,{key:2},{default:o(()=>[C(l(a(r)("can_edit")),1)]),_:1}))]),_:1},8,["onClick"])]),default:o(()=>[t("a",{class:"dropdown-label",onClick:i[0]||(i[0]=ee(()=>{},["prevent"]))},[C(l(g.operate_rights_label)+" ",1),e(a(qe),{style:{"font-size":"12px"}})])]),_:2},1024)])):(u(),k("div",Ia,[t("a",{class:"dropdown-label disabled",onClick:i[1]||(i[1]=ee(()=>{},["prevent"]))},l(g.operate_rights_label),1)]))],64)):P("",!0),b.key==="action"?(u(),k(G,{key:2},[g.showDelete?(u(),z(K,{key:0},{default:o(()=>[e(D,{title:a(r)("confirm_remove"),"ok-text":a(r)("confirm"),"cancel-text":a(r)("cancel"),onConfirm:E=>p(g)},{default:o(()=>[t("a",Ua,l(a(r)("remove")),1)]),_:1},8,["title","ok-text","cancel-text","onConfirm"])]),_:2},1024)):(u(),k("span",Ba,[e(v,{style:{padding:"0"},type:"link",disabled:""},{default:o(()=>[C(l(a(r)("remove")),1)]),_:1})]))],64)):P("",!0)]),_:1},8,["data-source","pagination"])]),e(ba,{excludedIds:s.value,ref_key:"addCollaboratorRef",ref:y,onOk:$},null,8,["excludedIds"])])}}},Ra=H(Oa,[["__scopeId","data-v-290421b9"]]),za={class:"permissions-page"},Pa={class:"page-container"},Ma={class:"form-box-wrapper"},Aa={class:"collaborator-list-wrapper"},Fa={__name:"index",setup(A){const r=xe(),f=Be(),d=W(()=>f.query.library_id),y=q({type:1,library_intro:"",library_name:"",model_config_id:"",model_define:"",use_model:"",is_offline:!1,access_rights:"0",share_url:"",library_key:"",avatar:"",avatar_file:""});ae("libraryState",y),ae("updateState",s=>{Object.assign(y,s)});const U=L(!1),n=s=>{Object.assign(y,s),U.value=!0,h().then(()=>{U.value=!1}).catch(()=>{U.value=!1})},h=async()=>{let s={...Oe(y)};delete s.library_key,s.avatar_file?(s.avatar=s.avatar_file,delete s.avatar_file):(delete s.avatar,delete s.avatar_file),await Se(s),r.getLibraryInfo(),M.success("修改成功")},x=()=>{we({id:d.value}).then(s=>{Object.assign(y,s.data)})};return X(()=>{x()}),(s,m)=>(u(),k("div",za,[e(Re),t("div",Pa,[t("div",Ma,[e(oa,{value:y,"onUpdate:value":m[0]||(m[0]=O=>y=O),saveLoading:U.value,onSubmit:n},null,8,["value","saveLoading"])]),t("div",Aa,[y.library_key?(u(),z(Ra,{key:0})):P("",!0)])])]))}},Xa=H(Fa,[["__scopeId","data-v-3344cec9"]]);export{Xa as default};
