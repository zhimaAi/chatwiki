import{Y as s,_ as t,a5 as e,ae as g,ad as Z,F as q,a9 as R,a7 as u,e as le,f as L,n as W,k as r,a2 as f,a1 as X,B as Ce,G as E,u as S,A as Se,y as ce,J as re,q as me,w as ge,r as Te,aa as Me,ab as _e,ag as Le,o as Ie,b as Ae,af as Ee}from"./vue-chunks-Ci-XTWEs.js";import{u as Re}from"./useEventBus-BwH2zX88.js";import{u as ve}from"./chat-DVJGHeCD.js";import{b as J,d as ue,h as Oe,b7 as Be}from"../../index-CPkdGIiL.js";import{_ as de}from"./index-AGdtDeuS.js";import{ah as fe,$ as pe,am as De,p as he,Q as He,ab as Q,au as ye,aw as ke,M as Pe,i as Fe,B as Ne,j as je,z as Ue,a as ze}from"./ui-antd-Bw8cEW5z.js";import{_ as be}from"./cu-scroll-5W3_kglT.js";import{h as Qe}from"./index-S7PCNZdQ.js";import{V as Je}from"./vue3-pdf-embed-DNcosj3W.js";import{$ as Ve}from"./index-Bu5ae_-0.js";import{u as Ke}from"./robot-DsbzMi16.js";import"./useIM-iZh2iz29.js";import"./index-CvIjQ1XU.js";import"./utils-ChQO-_r6.js";import"./pull-up.esm-D94Swpvl.js";import"./observe-dom.esm-CyCedSm-.js";import"./vue-pdf-embed-B4woVYJb.js";const Ge={class:"guess-you-want"},Ye={class:"message-tabs"},We={key:1,class:"v-line"},Xe={key:0,class:"message-menus"},Ze=["onClick"],et={key:1,class:"message-menus"},tt=["onClick"],st={__name:"guess-you-want",props:{item:{type:Object,default:()=>{}},common_question_list:{type:Object,default:()=>[]},enable_common_question:{type:Boolean,default:!1}},emits:["clickMeun"],setup(I,{emit:D}){const x=D,o=I,h=(C,_)=>{C.question_tabkey=_},T=C=>{x("clickMeun",C)};return(C,_)=>(t(),s("div",Ge,[e("div",Ye,[o.item.guess_you_want?(t(),s("div",{key:0,onClick:_[0]||(_[0]=n=>h(o.item,1)),class:Z(["tab-item",{active:o.item.question_tabkey==1}])}," 猜你想问 ",2)):g("",!0),o.item.guess_you_want&&o.common_question_list&&o.enable_common_question?(t(),s("div",We)):g("",!0),o.common_question_list&&o.enable_common_question?(t(),s("div",{key:2,onClick:_[1]||(_[1]=n=>h(o.item,2)),class:Z(["tab-item",{active:o.item.question_tabkey==2}])}," 常见问题 ",2)):g("",!0)]),o.item.question_tabkey==1?(t(),s("div",Xe,[(t(!0),s(q,null,R(o.item.guess_you_want,(n,p)=>(t(),s("div",{onClick:d=>T(n),class:"menu-item",key:p},u(n),9,Ze))),128))])):(t(),s("div",et,[(t(!0),s(q,null,R(I.common_question_list,(n,p)=>(t(),s("div",{onClick:d=>T(n),class:"menu-item",key:p},u(n),9,tt))),128))]))]))}},ot=J(st,[["__scopeId","data-v-9c22a890"]]),nt={class:"message-list-wrapper"},lt={class:"message-list"},it=["id"],at={class:"itme-left"},rt=["src"],ct={class:"itme-right"},ut={class:"item-body"},_t={key:0,class:"message-content"},dt=["src"],pt={class:"message-content"},mt=["id"],gt={class:"itme-left"},vt=["src"],ft={class:"itme-right"},ht={key:0,class:"reply-list"},yt={key:0,class:"reply-item reply-text"},kt=["innerHTML"],bt={key:1,class:"reply-item reply-image"},wt={class:"message-content"},$t=["src"],qt={key:2,class:"reply-item reply-url"},xt={class:"url-row"},Ct=["href"],St={key:3,class:"reply-item reply-card"},Tt={class:"card-row"},Mt=["src"],Lt={class:"card-title-box"},It={class:"card-title"},At={key:4,class:"reply-item reply-imageText"},Et=["href"],Rt=["src"],Ot={class:"imageText-text"},Bt={class:"imageText-title"},Dt={class:"imageText-desc"},Ht={key:5,class:"reply-item reply-smartMenu"},Pt={class:"smart-menu-box"},Ft={key:0,class:"card-title"},Nt={class:"card-text"},jt={key:0,class:"line-text"},Ut={key:1,class:"empty-line"},zt=["innerHTML"],Qt=["onClick"],Jt={key:0},Vt={class:"label-flex-block"},Kt=["onClick"],Gt={class:"label-text"},Yt=["onClick"],Wt={class:"label-text"},Xt={key:1,class:"item-body"},Zt={key:0,class:"file-items"},es=["onClick"],ts={class:"file-name"},ss={key:0},os={key:1},ns={key:1,class:"thinking-content"},ls={class:"message-content"},is={class:"message-menus"},as=["onClick"],rs=["innerHTML"],cs={class:"message-menus"},us=["onClick"],_s={key:4,class:"message-content"},ds=["src"],ps={key:5,class:"message-action-wrap"},ms={key:0,class:"message-action"},gs={class:"action-btn"},vs=["onClick"],fs={__name:"message-list",props:{messages:{type:Array,default:()=>[]},robotInfo:{type:Object,default:()=>{}}},emits:["clickMsgMeun","scroll","scrollStart","scrollEnd","openPromptLog","openLibrary"],setup(I,{expose:D,emit:x}){const o=x,h=I,T=i=>{i.show_reasoning=!i.show_reasoning},C=i=>{i.show_quote_file=!i.show_quote_file},_=le(()=>h.robotInfo.common_question_list.length?JSON.parse(h.robotInfo.common_question_list):[]),n=le(()=>(h.robotInfo.chat_type==1||h.robotInfo.chat_type==3)&&h.robotInfo.application_type=="0"),p=i=>{o("clickMsgMeun",i)},d=L(null),c={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let O=null,P=!1;function V(i){P||(O&&(clearTimeout(O),O=null),O=setTimeout(()=>{c.scrollTop-i.target.scrollTop>0&&(c.scrollDirection="up"),c.scrollTop-i.target.scrollTop<0&&(c.scrollDirection="down"),c.scrollTop=i.target.scrollTop,c.scrollHeight=i.target.scrollHeight,c.clientHeight=i.target.clientHeight,o("scroll",{...c}),Math.abs(c.scrollTop)<=c.scrollStartDiff&&c.scrollDirection==="up"&&K(),Math.abs(c.scrollHeight-c.scrollTop-c.clientHeight)<=c.scrollEndDiff&&c.scrollDirection==="down"&&j()},50))}function K(){h.messages.length!=0&&o("scrollStart",{msg:h.messages[0]})}function j(){h.messages.length!=0&&o("scrollEnd",{msg:h.messages[h.messages.length-1]})}const ne=()=>{d.value&&ce(()=>{P=!0,d.value.scrollTop=d.value.scrollHeight+1,setTimeout(()=>{c.scrollTop=d.value.scrollTop,P=!1},50)})};function ee(i,m){ce(()=>{P=!0,m||(m="top");let b=d.value,w=document.querySelector("#msg-"+i);m=="top"?b.scrollTop=w.offsetTop:b.scrollTop=w.offsetTop-b.clientHeight+w.clientHeight,setTimeout(()=>{c.scrollTop=d.value.scrollTop,P=!1},50)})}function y(){c.scrollTop=0,c.scrollDirection=""}function $(i){return!!(i.quote_file&&i.quote_file.length>0||i.debug&&i.debug.length>0)}function F(i){o("openPromptLog",re(i))}function H(i,m,b){let w=re(i);m.message_id=m.message_id||b,w.forEach(M=>{M.message_id=M.message_id||b}),o("openLibrary",w,re(m))}function U(i){try{return i?Array.isArray(i)?i:typeof i=="string"?JSON.parse(i||"[]"):[]:[]}catch{return[]}}function G(i){const m=[];return(Array.isArray(i)?i:[]).forEach(b=>{const w=String((b==null?void 0:b.menu_type)||""),M=String((b==null?void 0:b.content)||"");if(w==="0")if(M==="")m.push({kind:"newline"});else if(/<a[\s\S]*?<\/a>/.test(M)){const z=/href\s*=\s*['"]\s*#\s*['"]/i.test(M)?M.replace(/href\s*=\s*['"]\s*#\s*['"]/ig,'href="javascript:;"'):M.replace(/href=/ig,'target="_blank" href=');m.push({kind:"html",html:z})}else m.push({kind:"text",text:M});else w==="1"&&m.push({kind:"keyword",text:M,serial_no:(b==null?void 0:b.serial_no)||""})}),m.slice(0,20)}function te(i){var w,M;const m=(M=(w=i.target)==null?void 0:w.closest)==null?void 0:M.call(w,"a");if(!m)return;const b=String(m.getAttribute("href")||"");(b==="#"||b==="javascript:;")&&(i.preventDefault(),i.stopPropagation())}function v(i){const m=String(i||"").trim();m&&o("clickMsgMeun",m)}return D({scrollToBottom:ne,scrollToMessage:ee,resetScroll:y}),(i,m)=>{const b=fe,w=ue,M=he,z=me("viewer");return t(),s("div",nt,[e("div",{class:"scroll-box",ref_key:"scrollBoxRef",ref:d,onScroll:V},[e("div",lt,[(t(!0),s(q,null,R(h.messages,l=>(t(),s(q,{key:l.uid},[l.is_customer==1?(t(),s("div",{key:0,class:"message-item user-message",id:"msg-"+l.uid},[e("div",at,[e("img",{class:"user-avatar",src:l.avatar},null,8,rt)]),e("div",ct,[e("div",ut,[l.received_message_type=="image"&&l.media_id_to_oss_url?(t(),s("div",_t,[W(e("img",{class:"msg-img",src:l.media_id_to_oss_url,alt:""},null,8,dt),[[z]])])):g("",!0),e("div",pt,u(l.content),1)])])],8,it)):(t(),s("div",{key:1,class:"message-item robot-message",id:"msg-"+l.uid},[e("div",gt,[r(b,{size:"small",spinning:l.loading},{default:f(()=>[e("img",{class:"robot-avatar",src:l.robot_avatar},null,8,vt)]),_:2},1032,["spinning"])]),e("div",ft,[U(l.reply_content_list).length?(t(),s("div",ht,[(t(!0),s(q,null,R(U(l.reply_content_list),(a,N)=>{var Y;return t(),s(q,{key:N},[(a.reply_type||a.type)==="text"?(t(),s("div",yt,[e("div",{class:"message-content",innerHTML:a.description},null,8,kt)])):(a.reply_type||a.type)==="image"?(t(),s("div",bt,[e("div",wt,[W(e("img",{class:"msg-img",src:a.pic||a.thumb_url},null,8,$t),[[z]])])])):(a.reply_type||a.type)==="url"?(t(),s("div",qt,[e("div",xt,[e("a",{class:"url-link",href:a.url,target:"_blank"},u(a.url),9,Ct)])])):(a.reply_type||a.type)==="card"?(t(),s("div",St,[e("div",Tt,[a.thumb_url?(t(),s("img",{key:0,src:a.thumb_url,class:"card-thumb"},null,8,Mt)):g("",!0),e("div",Lt,[r(w,{class:"think-icon",name:"applet"}),e("span",It,u(a.title),1)])])])):(a.reply_type||a.type)==="imageText"?(t(),s("div",At,[e("a",{class:"imageText-row",href:a.url,target:"_blank"},[a.thumb_url?(t(),s("img",{key:0,src:a.thumb_url,class:"imageText-thumb"},null,8,Rt)):g("",!0),e("div",Ot,[e("div",Bt,u(a.title),1),e("div",Dt,u(a.description),1)])],8,Et)])):(a.reply_type||a.type)==="smartMenu"?(t(),s("div",Ht,[e("div",Pt,[a.smart_menu&&a.smart_menu.menu_description?(t(),s("div",Ft,u(a.smart_menu.menu_description),1)):g("",!0),e("div",Nt,[(t(!0),s(q,null,R(G(((Y=a.smart_menu)==null?void 0:Y.menu_content)||[]),(B,ie)=>(t(),s("div",{key:ie,class:"reply-line",onClick:m[0]||(m[0]=se=>te(se))},[B.kind==="text"?(t(),s("span",jt,u(B.text),1)):B.kind==="newline"?(t(),s("div",Ut)):B.kind==="html"?(t(),s("span",{key:2,innerHTML:B.html},null,8,zt)):B.kind==="keyword"?(t(),s("a",{key:3,href:"javascript:;",class:"link",onClick:Ce(se=>v(B.text),["prevent"])},[B.serial_no?(t(),s("div",Jt,u(B.serial_no),1)):g("",!0),E(" "+u(B.text),1)],8,Qt)):g("",!0)]))),128))])])])):g("",!0)],64)}),128))])):g("",!0),e("div",Vt,[l.msg_type==1&&n.value?(t(),s("div",{key:0,class:Z(["thinking-label-wrapper",{reasoning_open:l.show_quote_file}])},[e("div",{class:"thinking-label",onClick:a=>C(l)},[l.quote_loading?(t(),s(q,{key:0},[r(S(pe),{class:"loading"}),m[1]||(m[1]=e("span",{class:"label-text"},"正在检索知识库...",-1))],64)):(t(),s(q,{key:1},[r(w,{class:"think-icon",name:"quote-file"}),e("span",Gt,"检索到"+u(l.quote_file.length)+"个知识库文档",1)],64)),l.quote_file.length?(t(),X(w,{key:2,name:"arrow-down",class:"arrow-down"})):g("",!0)],8,Kt)],2)):g("",!0),l.reasoning_content?(t(),s("div",{key:1,class:Z(["thinking-label-wrapper",{reasoning_open:l.show_reasoning}])},[e("div",{class:"thinking-label",onClick:a=>T(l)},[l.reasoning_status?(t(),X(S(pe),{key:0,class:"loading"})):(t(),X(w,{key:1,class:"think-icon",name:"think"})),e("span",Wt,u(l.reasoning_status?"深度思考中...":"已完成深度思考"),1),l.reasoning_status?g("",!0):(t(),X(w,{key:2,name:"arrow-down",class:"arrow-down"}))],8,Yt),r(M,null,{title:f(()=>m[2]||(m[2]=[E("在应用设置中关闭推理过程开关，将不再显示推理过程")])),default:f(()=>[r(S(De),{class:"tip"})]),_:1})],2)):g("",!0)]),l.msg_type==1&&l.content==""?g("",!0):(t(),s("div",Xt,[l.show_quote_file&&l.quote_file&&l.quote_file.length>0?(t(),s("div",Zt,[(t(!0),s(q,null,R(l.quote_file,a=>(t(),s("div",{class:"file-item",key:a.id,onClick:N=>H(l.quote_file,a,l.id)},[e("a",ts,[r(w,{class:"think-icon",name:"quote-file"}),a.file_name?(t(),s("span",ss,u(a.file_name),1)):(t(),s("span",os,u(a.library_name)+"-精选",1))])],8,es))),128))])):g("",!0),l.show_reasoning?(t(),s("div",ns,[r(de,{content:l.reasoning_content},null,8,["content"])])):g("",!0),l.msg_type==1?(t(),s(q,{key:2},[W((t(),s("div",ls,[r(de,{content:l.content},null,8,["content"])])),[[z]]),e("div",is,[(t(!0),s(q,null,R(l.question,(a,N)=>(t(),s("div",{class:"menu-item",onClick:Y=>p(a),key:N},u(a),9,as))),128))])],64)):g("",!0),l.msg_type==2?(t(),s(q,{key:3},[e("div",{class:"message-content",innerHTML:l.menu_json.content},null,8,rs),e("div",cs,[(t(!0),s(q,null,R(l.menu_json.question,(a,N)=>(t(),s("div",{class:"menu-item",onClick:Y=>p(a),key:N},u(a),9,us))),128))])],64)):g("",!0),l.msg_type==3?(t(),s("div",_s,[W(e("img",{class:"msg-img",src:l.content,alt:""},null,8,ds),[[z]])])):g("",!0),$(l)?W((t(),s("div",ps,[l.debug&&l.debug.length>0?(t(),s("div",ms,[e("div",gs,[e("span",null,[e("a",{onClick:a=>F(l)},"Prompt 日志",8,vs)])])])):g("",!0)],512)),[[Se,!l.question]]):g("",!0)])),(l.guess_you_want&&l.guess_you_want.length||_.value.length&&h.robotInfo.enable_common_question=="true")&&l.question_tabkey>0?(t(),X(ot,{key:2,item:l,enable_common_question:h.robotInfo.enable_common_question=="true",common_question_list:_.value,onClickMeun:p},null,8,["item","enable_common_question","common_question_list"])):g("",!0)])],8,mt))],64))),128))])],544)])}}},hs=J(fs,[["__scopeId","data-v-32f5e002"]]),ys={class:"chat-list-box"},ks=["onClick"],bs={class:"chat-item-title"},ws={__name:"chat-list",props:{list:{type:Array,default:()=>[]},active:{type:[String,Number],default:""}},emits:["openChat","onScrollEnd"],setup(I,{emit:D}){const x=D,o=I,h=L(null),T=_=>{x("openChat",_)},C=()=>{x("onScrollEnd")};return ge(()=>o.list,()=>{ce(()=>{h.value.refresh()})}),(_,n)=>{const p=ue;return t(),s("div",ys,[r(be,{ref_key:"scroller",ref:h,onOnScrollEnd:C},{default:f(()=>[e("div",null,[(t(!0),s(q,null,R(o.list,d=>(t(),s("div",{class:Z(["chat-list-item",{active:d.id==o.active}]),onClick:c=>T(d),key:d.id},[r(p,{class:"chat-item-icon",name:"message"}),e("span",bs,u(d.subject||d.last_chat_message),1)],10,ks))),128))])]),_:1},512)])}}},$s=J(ws,[["__scopeId","data-v-8a5dd127"]]),qs={class:"message-input-wrapper"},xs={class:"message-action"},Cs={class:"loading-action"},Ss=["disabled"],Ts={__name:"message-input",props:{value:{type:String,default:""},loading:{type:Boolean,default:!1}},emits:["send","update:value"],setup(I,{emit:D}){const x=D,o=I,h=le(()=>o.loading||o.value.trim().length===0),T=n=>{x("update:value",n.target.value.trim())},C=n=>{if(n.key==="Enter"&&!n.shiftKey){if(!n.target.value.trim())return;n.preventDefault(),_()}else n.key==="Enter"&&n.shiftKey&&(n.preventDefault(),x("update:value",o.value+`
`))},_=()=>{x("send",o.value.trim())};return(n,p)=>{const d=He,c=fe;return t(),s("div",qs,[r(d,{value:I.value,"auto-size":{minRows:5,maxRows:5},placeholder:"在此输入您想了解的内容，Shift+Enter换行",onChange:T,onKeydown:C},null,8,["value"]),e("div",xs,[e("span",Cs,[r(c,{spinning:I.loading},null,8,["spinning"])]),I.loading?g("",!0):(t(),s("button",{key:0,class:"send-msg-btn",disabled:h.value,onClick:_},p[0]||(p[0]=[e("span",null,"发送",-1)]),8,Ss))])])}}},Ms=J(Ts,[["__scopeId","data-v-47f207c0"]]),Ls={class:"prompt-log-content"},Is={class:"prompt-log-items"},As={class:"prompt-log-label"},Es={class:"prompt-log-item"},Rs={class:"prompt-log-items"},Os={class:"prompt-log-label"},Bs={class:"prompt-log-items"},Ds={class:"prompt-log-label"},Hs={class:"prompt-log-item"},Ps={class:"prompt-log-items"},Fs={class:"prompt-log-label"},Ns={class:"prompt-log-item"},js={key:0,class:"prompt-log-items"},Us={class:"prompt-log-label"},zs={class:"prompt-log-item"},Qs={key:1,class:"prompt-log-items"},Js={class:"prompt-log-label"},Vs={class:"prompt-log-item"},Ks={class:"prompt-log-items"},Gs={class:"prompt-log-label"},Ys={class:"prompt-log-item"},Ws={__name:"prompt-log-alert",setup(I,{expose:D}){const x=L(!1),o=Te({prompt:"",library:[],context_qa:[],cur_question:"",cur_answer:"",error:""}),h=()=>{x.value=!1},T=()=>{o.prompt="",o.library=[],o.context_qa=[],o.cur_question="",o.cur_answer="",o.error="",o.recall_time="",o.request_time=""};return D({open:_=>{T(),o.error=_.error,o.recall_time=_.recall_time?(_.recall_time/1e3).toFixed(2):"",o.request_time=_.request_time?(_.request_time/1e3).toFixed(2):"";let n=_.debug||[];for(let p=0;p<n.length;p++){let d=n[p];d.type=="library"?o.library.push(d.content):d.type=="context_qa"?o.context_qa.push(d):o[d.type]=d.content}x.value=!0}}),(_,n)=>{const p=he,d=ke;return t(),X(d,{class:"prompt-log-alert",open:x.value,"onUpdate:open":n[0]||(n[0]=c=>x.value=c),title:"Prompt 日志",placement:"right",width:"746px",closable:!1},{extra:f(()=>[e("span",{class:"close-btn",onClick:h},[r(S(ye))])]),default:f(()=>[e("div",Ls,[e("div",Is,[e("div",As,[n[2]||(n[2]=e("span",null,"提示词 ",-1)),r(p,null,{title:f(()=>n[1]||(n[1]=[E("系统提示词和文档分段。")])),default:f(()=>[r(S(Q),{class:"question-icon"})]),_:1})]),e("div",Es,[e("p",null,u(o.prompt),1)]),(t(!0),s(q,null,R(o.library,(c,O)=>(t(),s("div",{class:"prompt-log-item",key:O},[e("p",null,u(c),1)]))),128))]),e("div",Rs,[e("div",Os,[n[4]||(n[4]=e("span",null,"上下文 ",-1)),r(p,null,{title:f(()=>n[3]||(n[3]=[E("传递的历史提问消息")])),default:f(()=>[r(S(Q),{class:"question-icon"})]),_:1})]),(t(!0),s(q,null,R(o.context_qa,(c,O)=>(t(),s("div",{class:"prompt-log-item",key:O},[e("p",null,"Q："+u(c.question),1),e("p",null,"A："+u(c.answer),1)]))),128))]),e("div",Bs,[e("div",Ds,[n[6]||(n[6]=e("span",null,"USER ",-1)),r(p,null,{title:f(()=>n[5]||(n[5]=[E("本次用户的提问")])),default:f(()=>[r(S(Q),{class:"question-icon"})]),_:1})]),e("div",Hs,[e("p",null,u(o.cur_question),1)])]),e("div",Ps,[e("div",Fs,[n[8]||(n[8]=e("span",null,"ASSISTANT ",-1)),r(p,null,{title:f(()=>n[7]||(n[7]=[E("语言模型输出的答案")])),default:f(()=>[r(S(Q),{class:"question-icon"})]),_:1})]),e("div",Ns,[e("p",null,u(o.cur_answer),1)])]),o.recall_time>0?(t(),s("div",js,[e("div",Us,[n[10]||(n[10]=e("span",null,"Recall time ",-1)),r(p,null,{title:f(()=>n[9]||(n[9]=[E("从知识库中检索到有效分段所需要的时间，包括对分段进行排序时间。")])),default:f(()=>[r(S(Q),{class:"question-icon"})]),_:1})]),e("div",zs,[e("p",null,u(o.recall_time)+"s",1)])])):g("",!0),o.request_time>0?(t(),s("div",Qs,[e("div",Js,[n[12]||(n[12]=e("span",null,"Request time ",-1)),r(p,null,{title:f(()=>n[11]||(n[11]=[E("从发送问题和上下文信息给大模型到大模型开始返回答案的时间。")])),default:f(()=>[r(S(Q),{class:"question-icon"})]),_:1})]),e("div",Vs,[e("p",null,u(o.request_time)+"s",1)])])):g("",!0),e("div",Ks,[e("div",Gs,[n[14]||(n[14]=e("span",null,"Error ",-1)),r(p,null,{title:f(()=>n[13]||(n[13]=[E("报错信息，调用聊天接口报错时会显示。")])),default:f(()=>[r(S(Q),{class:"question-icon"})]),_:1})]),e("div",Ys,[e("p",null,u(o.error),1)])])])]),_:1},8,["open"])}}},Xs=J(Ws,[["__scopeId","data-v-6f598f2d"]]),Zs={class:"library-info-content"},eo={class:"file-list"},to=["onClick"],so={key:0},oo={key:1},no={class:"document-items"},lo={class:"document-item-header"},io={class:"left-box"},ao={class:"document-title"},ro={key:0,class:"document-title"},co={class:"document-size"},uo={class:"right-box"},_o=["onClick"],po={class:"document-item-body"},mo={class:"document-similarity"},go={key:0,class:"document-content"},vo={key:1,class:"document-content"},fo={class:"document-content"},ho={class:"fragment-img"},yo=["src"],ko={class:"iframe-box"},bo={__name:"library-info-alert",setup(I,{expose:D}){const x=ve(),{robot:o,user:h}=x;Me();const T=L(!1),C=L([]),_=L(null),n=()=>{C.value=[],_.value=null},p=(y,$)=>{if(n(),C.value=y.map(F=>{let H=null;return F.answer_source_data&&(H=JSON.parse(F.answer_source_data)),{...F,answer_source_data:H}}),_.value=$.id,T.value=!0,$.answer_source_data){c.value=JSON.parse($.answer_source_data)||[];return}O($)},d=y=>{if(y.id!=_.value){if(_.value=y.id,y.answer_source_data){c.value=y.answer_source_data||[];return}O(y)}},c=L([]),O=y=>{Qe({message_id:y.message_id,file_id:y.id,robot_key:o.robot_key,openid:o.openid}).then($=>{c.value=$.data||[]})},P=()=>{let y=C.value.filter($=>$.id==_.value)[0]||{};y.file_name?window.open(`#/library/preview?id=${_.value}`):window.open(`#/library/details/categary-manage?id=${y.library_id}`)},V=le(()=>{let y=C.value.filter($=>$.id==_.value)[0]||{};return y.file_name?y.file_name:y.library_name+"-精选"}),K=L(""),j=L(!1),ne=y=>{j.value=!0,K.value="/manage/getLibRawFileOnePage?id="+_.value+"&page="+y.page_num+"&admin_user_id="+h.admin_user_id},ee=()=>{T.value=!1};return D({open:p}),(y,$)=>{const F=ue,H=ke,U=be,G=Pe,te=me("viewer");return t(),s(q,null,[r(H,{class:"library-info-alert",open:T.value,"onUpdate:open":$[0]||($[0]=v=>T.value=v),title:"答案来源",placement:"right",width:"746px",closable:!1,bodyStyle:{background:"#F2F4F7"}},{extra:f(()=>[e("span",{class:"close-btn",onClick:ee},[r(S(ye))])]),default:f(()=>[e("div",Zs,[e("div",eo,[(t(!0),s(q,null,R(C.value,v=>(t(),s("div",{class:Z(["file-item",{active:_.value==v.id}]),key:v.id,onClick:i=>d(v)},[v.file_name?(t(),s("span",so,u(v.file_name),1)):(t(),s("span",oo,u(v.library_name)+"-精选",1))],10,to))),128))]),e("div",no,[(t(!0),s(q,null,R(c.value,v=>(t(),s("div",{class:"document-item",key:v.id},[e("div",lo,[e("div",io,[e("span",ao,"id："+u(v.id),1),v.title?(t(),s("span",ro,u(v.title),1)):g("",!0),e("span",co," 共"+u(v.word_total)+"个字符 ",1)]),e("div",uo,[v.page_num>0?(t(),s("a",{key:0,onClick:i=>ne(v)},"预览原文件>",8,_o)):g("",!0),e("a",{onClick:P},"查看源文档>")])]),e("div",po,[e("div",mo,[$[2]||($[2]=E(" 相似度： ")),r(F,{name:"similarity",style:{"font-size":"16px"}}),E(u(v.similarity),1)]),v.question?(t(),s("div",go,"Q："+u(v.question),1)):g("",!0),v.answer?(t(),s("div",vo,"A："+u(v.answer),1)):g("",!0),e("div",fo,u(v.content),1),W((t(),s("div",ho,[(t(!0),s(q,null,R(v.images,(i,m)=>(t(),s("img",{key:m,src:i,alt:""},null,8,yo))),128))])),[[te]])])]))),128))])])]),_:1},8,["open"]),r(G,{open:j.value,"onUpdate:open":$[1]||($[1]=v=>j.value=v),title:V.value,footer:null,width:740},{default:f(()=>[e("div",ko,[r(U,null,{default:f(()=>[r(S(Je),{source:K.value},null,8,["source"])]),_:1})])]),_:1},8,["open","title"])],64)}}},wo=J(bo,[["__scopeId","data-v-e8bc69ca"]]),$o={class:"chat-page-wrapper"},qo={class:"chat-page-header"},xo={class:"breadcrumb-box"},Co={class:"chat-page"},So={class:"page-left"},To={class:"page-left-top"},Mo={class:"page-left-body"},Lo={class:"page-body"},Io={class:"chat-box-body"},Ao={style:{"margin-top":"30px"},class:"chat-box-footer"},Eo={__name:"index",setup(I){const x=_e().query,o=Ke(),{getRobot:h,robotInfo:T}=o,C=Re(),_=ve(),n=Oe();let p=!0;const d=L(""),c=L(null),{createChat:O,sendMessage:P,getMyChatList:V,openChat:K,onGetChatMessage:j,changeRobotPrompt:ne,$reset:ee}=_,{messageList:y,sendLock:$,myChatList:F,robot:H,dialogue_id:U}=Le(_),G=_e(),te=L(!1),v=async()=>{if(!d.value)return Be("请输入消息内容");let k=await Ve({robot_key:H.value.robot_key,openid:H.value.openid,question:d.value,form_ids:H.value.form_ids,dialogue_id:U.value});if(k.data&&k.data.words)return ze.error(`提交的内容包含敏感词：[${k.data.words.join(";")}] 请修改后再提交`);p=!0,P({message:d.value,global:JSON.stringify(x)}),d.value=""},i=async()=>{p=!0,d.value="";let k=G.query||{},A=n.user_id,oe={robot_key:k.robot_key,avatar:k.avatar,name:k.name,nickname:k.nickname,is_background:1,openid:A,dialogue_id:0};N(),await O(oe)},m=async k=>{if(U.value==k.dialogue_id)return;p=!0;let oe={robot_key:(G.query||{}).robot_key,avatar:k.avatar,name:k.name,nickname:k.nickname,is_background:k.is_background,openid:k.openid,dialogue_id:k.id};N(),await K(oe),await j()&&l()},b=k=>{p=!0,P({message:k})};L(!1);const w=()=>{l()},M=async()=>{p=!1;let k=y.value[0].uid;await j()&&a(k)},z=()=>{},l=()=>{c.value&&p&&c.value.scrollToBottom()},a=k=>{c.value&&c.value.scrollToMessage(k)},N=()=>{c.value&&c.value.resetScroll()},Y=()=>{V()},B=L(null),ie=k=>{B.value.open(k)},se=L(null),we=(k,A)=>{se.value.open(k,A)};return ge(()=>y.value,()=>{}),Ie(async()=>{i(),V(),await h(x.id),te.value=!0,C.on("updateAiMessage",w)}),Ae(()=>{ee(),C.off("updateAiMessage",w)}),(k,A)=>{const oe=Ee("router-link"),ae=je,$e=Fe,qe=Ne;return t(),s("div",$o,[e("div",qo,[e("div",xo,[r($e,null,{default:f(()=>[r(ae,null,{default:f(()=>[r(oe,{to:"/robot/list"},{default:f(()=>A[1]||(A[1]=[E("机器人管理")])),_:1,__:[1]})]),_:1}),r(ae,null,{default:f(()=>[E(u(S(H).robot_name),1)]),_:1})]),_:1})])]),e("div",Co,[e("div",So,[e("div",To,[r(qe,{type:"primary",block:"",ghost:"",onClick:i},{default:f(()=>[r(S(Ue)),A[2]||(A[2]=E(" 新建对话"))]),_:1,__:[2]})]),e("div",Mo,[r($s,{list:S(F),active:S(U),onOpenChat:m,onOnScrollEnd:Y},null,8,["list","active"])]),A[3]||(A[3]=e("div",{class:"page-left-footer"},null,-1))]),e("div",Lo,[e("div",Io,[r(hs,{ref_key:"messageListRef",ref:c,messages:S(y),robotInfo:S(T),onClickMsgMeun:b,onScrollStart:M,onScrollEnd:z,onOpenPromptLog:ie,onOpenLibrary:we},null,8,["messages","robotInfo"])]),e("div",Ao,[r(Ms,{value:d.value,"onUpdate:value":A[0]||(A[0]=xe=>d.value=xe),onSend:v,loading:S($)},null,8,["value","loading"])])]),e("div",null,[g("",!0)])]),r(Xs,{ref_key:"promptLogAlertRef",ref:B},null,512),r(wo,{ref_key:"libraryInfoAlertRef",ref:se},null,512)])}}},Wo=J(Eo,[["__scopeId","data-v-7257bb7b"]]);export{Wo as default};
