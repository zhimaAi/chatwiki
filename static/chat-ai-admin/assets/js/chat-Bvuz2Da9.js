import{am as ee,f,r as A}from"./vue-chunks-CGLjTDrY.js";import{a as ae,s as te,q as oe,g as P,b as ne,d as ie,e as le}from"./index-DM5bNlEU.js";import{a2 as se}from"./index-AgSL8KLK.js";import{b3 as I,b4 as x,ae as g,b5 as re,b6 as j,b7 as M}from"../../index-C5-B0r5-.js";import{u as ue}from"./useEventBus-CB_rGuu7.js";import{u as _e}from"./useIM-qQDeYrid.js";const be=ee("chat",()=>{const k=ue(),o=f([]),S=_e();let d=null;const u=f(0),N=f(),v=f(""),s=A({admin_user_id:"",avatar:"",id:"",name:"",nickname:"",openid:""}),n=A({id:"",library_ids:"",form_ids:"",prompt:"",robot_avatar:"",robot_intro:"",robot_key:"",robot_name:"",openid:"",welcomes:{reasoning_content:"",content:"",question:[]},enable_question_guide:!1,enable_common_question:!1,common_question_list:[],question_multiple_switch:0}),R=async e=>{o.value=[],y.value=!1,m.value=!1,e.dialogue_id?u.value=e.dialogue_id:u.value=0,N.value=e.rel_user_id,v.value=e.openid||I(),n.robot_key=e.robot_key,n.openid=v.value,s.openid=v.value,s.avatar=e.avatar||x,s.name=e.name||"",s.nickname=e.nickname||""},b=f(!1),L=async e=>{d&&(d.abort(),d=null),o.value=[],y.value=!1,m.value=!1,e.dialogue_id?(b.value=!1,u.value=e.dialogue_id):(b.value=!0,u.value=0),v.value=e.openid||I(e.robot_key),n.robot_key=e.robot_key,n.openid=v.value,s.openid=v.value,s.avatar=e.avatar||x,s.name=e.name||"",s.nickname=e.nickname||"";const t=await ae({robot_key:n.robot_key,openid:v.value,nickname:s.nickname,name:s.name,is_background:e.is_background||void 0});try{let r=t.data.customer,a=t.data.robot;return s.admin_user_id=r.admin_user_id,s.avatar=r.avatar,s.id=r.id,s.name=r.name,s.nickname=r.nickname,n.library_ids=a.library_ids,n.prompt=a.prompt,n.robot_avatar=a.robot_avatar,n.robot_intro=a.robot_intro,n.robot_key=a.robot_key,n.robot_name=a.robot_name,n.form_ids=a.form_ids,n.id=a.id,n.enable_question_guide=a.enable_question_guide=="true",n.enable_common_question=a.enable_common_question=="true",n.common_question_list=a.common_question_list,n.question_multiple_switch=Number(a.question_multiple_switch)||0,a.welcomes&&(n.welcomes=JSON.parse(a.welcomes)),E(t.data.message),S.connect(v.value),S.on("message",z),t}catch(r){Promise.reject(r)}},z=e=>{if(e&&e.msg_type!="receiver_notify"&&e.dialogue_id==u.value){if(e.uid=g(32),e.loading=!1,e.isWelcome=!0,e.name=e.name||e.nickname,e.is_customer==1?(e.name=e.name||s.name,e.avatar=e.avatar||s.avatar):(e.name=e.name||n.name,e.robot_avatar=e.avatar||n.robot_avatar),e.menu_json&&typeof e.menu_json=="string"&&(e.menu_json=JSON.parse(e.menu_json)),e.quote_file&&typeof e.quote_file=="string"&&(e.quote_file=JSON.parse(e.quote_file)),e.reply_content_list&&typeof e.reply_content_list=="string")try{e.reply_content_list=JSON.parse(e.reply_content_list)}catch{e.reply_content_list=[]}o.value.push(e),k.emit("updateAiMessage",e)}},E=e=>{e&&(e.uid=g(32),e.loading=!1,e.isWelcome=!0,e.robot_avatar=n.robot_avatar,e.menu_json&&(e.menu_json=JSON.parse(e.menu_json)),e.quote_file&&(e.quote_file=JSON.parse(e.quote_file)),o.value.push(e))},W=e=>{e.uid=g(32),e.loading=!1,e.avatar=s.avatar,e.openid=s.openid,e.msg_type=e.msg_type||1,e.is_customer=1,o.value.push(e)},T=e=>{o.value.push(e),k.emit("updateAiMessage",e)},_=(e,t,r)=>{let a=o.value.findIndex(l=>l.uid==r);if(e=="reply_content_list"&&t!==void 0&&typeof t=="string"&&(o.value[a].reply_content_list=JSON.parse(t)),e=="reasoning_content"){let l=o.value[a].reasoning_content||"";o.value[a].reasoning_content=l+t,o.value[a].reasoning_status=!0,o.value[a].show_reasoning=!0}if(e=="sending"){o.value[a].reasoning_status=!1;let l=o.value[a].content||"";o.value[a].content=l+t,o.value[a].voice_content=j(o.value[a].content),o.value[a].content=M(o.value[a].content)}if(e=="start_quote_file"&&(o.value[a].quote_loading=!0),e=="quote_file"&&(o.value[a].quote_file=t.length>0?t:[],o.value[a].show_quote_file=!0,o.value[a].quote_loading=!1),e=="ai_message"){if(t.menu_json&&t.msg_type==2){let l=JSON.parse(t.menu_json);o.value[a].question=l.question}o.value[a].id=t.id,o.value[a].content=t.content,o.value[a].voice_content=j(o.value[a].content),o.value[a].content=M(o.value[a].content),t.reply_content_list!==void 0&&typeof t.reply_content_list=="string"&&(o.value[a].reply_content_list=JSON.parse(t.reply_content_list)),t.quote_file&&typeof t.quote_file=="string"&&(o.value[a].quote_file=JSON.parse(t.quote_file))}e=="debug"&&(o.value[a].debug=t.length>0?t:[]),e=="error"&&(o.value[a].error=t.length>0?t:[]),e=="recall_time"&&(o.value[a].recall_time=t||0),e=="request_time"&&(o.value[a].request_time=t||0),e=="guess_you_want"&&(o.value=o.value.map(l=>({...l,question_tabkey:-1,guess_you_want:[]})),o.value[a].guess_you_want=t,o.value[a].question_tabkey=t.length>0?1:2),e=="set_question_tabkey"&&(o.value=o.value.map(l=>({...l,question_tabkey:-1})),o.value[a].question_tabkey=t),k.emit("updateAiMessage",o.value[a])},U=()=>{let e=o.value.length-1;o.value[e].loading=!1},m=f(!1),V=e=>{if(m.value)return;let t={loading:!0,id:"",content:"",reasoning_content:"",uid:g(32),robot_avatar:n.robot_avatar,msg_type:1,quote_file:[],debug:[],error:"",recall_time:"",request_time:"",show_reasoning:!1,reasoning_status:!1,quote_loading:!1,show_quote_file:!0,voice_content:[]},r={robot_key:n.robot_key,openid:n.openid,question:e.message,form_ids:n.form_ids,dialogue_id:u.value,global:e.global};m.value=!0,d=te(r),d.onMessage=a=>{if(a.event!=="sending"&&re(a),a.event=="dialogue_id"&&(u.value=a.data),a.event=="c_message"){let l=JSON.parse(a.data);W(l)}if(a.event=="robot"&&(T(t),b.value&&(G(),b.value=!1)),a.event=="reply_content_list"&&_("reply_content_list",a.data,t.uid),a.event=="reasoning_content"&&_("reasoning_content",a.data,t.uid),a.event=="sending"&&_("sending",a.data,t.uid),a.event=="ai_message"){let l=JSON.parse(a.data);_("ai_message",l,t.uid)}if(a.event=="start_quote_file"&&_("start_quote_file",a.data,t.uid),a.event=="quote_file"){let l=JSON.parse(a.data);_("quote_file",l,t.uid)}if(a.event=="debug"){let l=JSON.parse(a.data);_("debug",l,t.uid)}if(a.event=="error"){let l=a.data;_("error",l,t.uid)}if(a.event=="recall_time"){let l=a.data;_("recall_time",l,t.uid)}if(a.event=="request_time"){let l=a.data;_("request_time",l,t.uid)}a.event=="finish"&&(n.enable_question_guide?oe({robot_key:n.robot_key,openid:n.openid,dialogue_id:u.value}).then(l=>{_("guess_you_want",l.data||[],t.uid)}):_("set_question_tabkey",2,t.uid))},d.onClose=()=>{U(),m.value=!1,d=null}},D=25,p=f([]),q=f(!1),w=f(!1),F=async()=>{if(w.value||q.value)return!1;let e=0;p.value.length>0&&(e=p.value[p.value.length-1].id),q.value=!0;const t=await P({min_id:e,size:D,robot_key:n.robot_key});q.value=!1;const r=t.data||[];return r.length===0?(w.value=!0,!1):(p.value=[...p.value,...r],t)},G=()=>{P({min_id:0,size:1,robot_key:n.robot_key}).then(e=>{const t=e.data||[];t[0]&&p.value.unshift(t[0])})},B=async e=>(d&&(d.abort(),d=null),await L(e)),$=20,y=f(!1),H=async()=>{var l;if(y.value)return;let e=0,t=o.value.filter(c=>!c.isWelcome);t.length>0&&(e=t[0].id);const r=u.value;let a={robot_key:n.robot_key,openid:s.openid,min_id:e,size:$,dialogue_id:r,rel_user_id:N.value};try{const c=await ne(a);if(u.value!==r)return Promise.resolve(null);const h=c.data.list||[],O=((l=c==null?void 0:c.data)==null?void 0:l.customer)||{},J=c.data.robot;if(h.length===0){y.value=!0;return}return h.sort((i,C)=>i.id-C.id),h.forEach(i=>{if(i.loading=!1,i.uid=g(32),i.name=i.name||i.nickname,i.is_customer==1?(i.name=i.name||s.name||O.name,i.avatar=i.avatar||s.avatar||O.avatar):(i.name=i.name||n.robot_name||J.robot_name,i.robot_avatar=i.avatar||n.robot_avatar||J.robot_avatar,i.avatar=i.robot_avatar),i.menu_json&&(i.menu_json=JSON.parse(i.menu_json)),i.quote_file&&(i.quote_file=JSON.parse(i.quote_file)),i.reply_content_list&&typeof i.reply_content_list=="string")try{i.reply_content_list=JSON.parse(i.reply_content_list)}catch{i.reply_content_list=[]}i.voice_content=j(i.content),i.content=M(i.content)}),o.value=[...h,...o.value],c}catch(c){Promise.reject(c)}},K=async e=>{try{const t=await ie(e);return t||Promise.reject(t)}catch(t){Promise.reject(t)}},Q=async e=>{try{const t=await le(e);return t||Promise.reject(t)}catch(t){Promise.reject(t)}},X=e=>{n.prompt=e},Y=()=>se({id:n.id,prompt:n.prompt});function Z(){S.close(),u.value=0,o.value=[],v.value="",s.admin_user_id="",s.avatar="",s.id="",s.name="",s.nickname="",s.openid="",n.id="",n.library_ids="",n.form_ids="",n.prompt="",n.robot_avatar="",n.robot_intro="",n.robot_key="",n.robot_name="",n.openid="",n.welcomes={content:"",question:[]},b.value=!1,y.value=!1,m.value=!1,q.value=!1,w.value=!1,p.value=[]}return{$reset:Z,user:s,robot:n,dialogue_id:u,openid:v,sendLock:m,messageList:o,createChat:L,createMsg:R,sendMessage:V,getMyChatList:F,myChatList:p,openChat:B,onGetChatMessage:H,changeRobotPrompt:X,saveRobotPrompt:Y,getRecordList:K,getChannelList:Q}});export{be as u};
