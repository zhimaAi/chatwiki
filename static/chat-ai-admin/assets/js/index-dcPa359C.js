import{f as y,r as Z,o as G,w as N,Y as m,_ as d,a5 as e,k as b,a2 as $,F as R,a9 as V,u as A,a1 as ee,G as M,a7 as k,q as te,ad as Se,n as F,ae as O,y as W,ab as Te,ag as ke,b as xe,aa as De}from"./vue-chunks-BSjLwu6d.js";import{d as C,N as $e,q as Ce,J as Ee,a as Ie,ah as we,u as Le,v as He,a4 as Me,B as Be,E as Oe,aI as Re,M as Ae}from"./ui-antd-BIopZvX3.js";import{_ as se}from"./empty-DkpCLaix.js";import{b as P,av as X}from"../../index-0SFcfYGN.js";import{_ as Ue}from"./index-BuQpXDoX.js";import{u as qe}from"./robot-DwqmFfQP.js";import{u as ze}from"./chat-CyTAfmtG.js";import{c as Ne}from"./index-BBPKhyB5.js";import"./utils-BMKRjDTh.js";import"./index-B4oOBcCh.js";import"./useEventBus-BwH2zX88.js";import"./useIM-CKdjTFo_.js";import"./index-1KR-OfoX.js";const Ve={class:"zm-date"},Pe={class:"date-btn"},Ye={class:"date-content"},je={__name:"date",props:{datekey:{type:String,default:"1"}},emits:["dateChange"],setup(I,{emit:w}){const x=I,c=y(1),_=w;let S=Z([{label:"今日",value:!0,key:2,start_time:C().startOf("day"),end_time:C().endOf("day")},{label:"昨日",value:!1,key:3,start_time:C().subtract(1,"day").startOf("day"),end_time:C().startOf("day").subtract(1,"millisecond")},{label:"近7日",value:!1,key:4,start_time:C().subtract(6,"day").startOf("day"),end_time:C().endOf("day").subtract(1,"millisecond")}]);const p=y(null),s=y(null),v=y([]),a=h=>h>=C().subtract(0,"day"),D=()=>{let h=c.value,n=null;S.forEach(l=>{l.key==h&&(n=l)}),n&&(v.value=[n.start_time,n.end_time],p.value=n.start_time.unix(),s.value=n.end_time.unix()),H()},L=h=>{const n=C(h[0]).startOf("day");if(C(h[1]).endOf("day").diff(n,"days")>29)v.value[0]=h[0].startOf("day"),v.value[1]=n.add(29,"days").endOf("day"),p.value=v.value[0].unix(),s.value=v.value[1].unix(),Ie.error("最多只能选择30天");else{const u=C(h[0]).startOf("day").unix(),f=C(h[1]).endOf("day").unix();v.value=h,p.value=u,s.value=f}c.value=1,H()},H=()=>{_("dateChange",{start_time:p.value,end_time:s.value})};return G(()=>{c.value=parseInt(x.datekey),D()}),N(()=>x.datekey,(h,n)=>{c.value=parseInt(x.datekey.split("-")[0]),D()}),(h,n)=>{const l=$e,u=Ce,f=Ee;return d(),m("div",Ve,[e("div",Pe,[b(u,{value:c.value,"onUpdate:value":n[0]||(n[0]=o=>c.value=o),onChange:D},{default:$(()=>[(d(!0),m(R,null,V(A(S),o=>(d(),ee(l,{class:"date-btn-button",value:o.key,key:o.key},{default:$(()=>[M(k(o.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),e("div",Ye,[b(f,{value:v.value,"onUpdate:value":n[1]||(n[1]=o=>v.value=o),onChange:L,format:"YYYY-MM-DD",disabledDate:a,allowClear:!1},null,8,["value"])])])}}},Fe={key:0,class:"empty-box"},Ge=["onClick"],Je={class:"user-item-left"},Ke=["src"],Qe={class:"user-item-right"},We={class:"user-name-box"},Xe={class:"user-name"},Ze={class:"user-timer"},et={class:"user-info"},tt={class:"user-source-box"},st={class:"user-source-content"},ot={__name:"user",props:{userList:{type:Array,default:null},channelItem:{type:Array,default:null}},emits:["userClick","userScroll","userScrollStart","userScrollEnd"],setup(I,{emit:w}){const x=y(null),c=I,_=w,S=y([]),p=y([]),s=y({}),v=l=>{s.value=l,_("userClick",l)},a={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let D=null;function L(l){D&&(clearTimeout(D),D=null),D=setTimeout(()=>{a.scrollTop-l.target.scrollTop>0&&(a.scrollDirection="up"),a.scrollTop-l.target.scrollTop<0&&(a.scrollDirection="down"),a.scrollTop=l.target.scrollTop,a.scrollHeight=l.target.scrollHeight,a.clientHeight=l.target.clientHeight,_("userScroll",{...a}),Math.abs(a.scrollTop)<=a.scrollStartDiff+100&&a.scrollDirection==="up"&&H(),Math.abs(a.scrollHeight-a.scrollTop-a.clientHeight)<=a.scrollEndDiff&&a.scrollDirection==="down"&&h()},50)}function H(){c.userList.length!=0&&_("userScrollStart",{msg:c.userList[0]})}function h(){c.userList.length!=0&&_("userScrollEnd",{msg:c.userList[c.userList.length-1]})}N(()=>c.userList,l=>{S.value=l,S.value.length>0&&S.value.length<=20&&(v(S.value[0]),s.value=S.value[0])},{immediate:!0}),N(()=>c.channelItem,l=>{p.value=l},{immediate:!0});const n=l=>{for(let u=0;u<p.value.length;u++)if(l.app_type==p.value[u].app_type&&(l.app_id||"")==p.value[u].app_id)return p.value[u].app_name};return G(()=>{S.value=c.userList,p.value=c.channelItem}),(l,u)=>{const f=te("ftime");return d(),m("div",{class:"user-content",ref_key:"scrollUserBoxRef",ref:x,onScroll:L},[S.value.length===0?(d(),m("div",Fe,u[0]||(u[0]=[e("img",{src:se,alt:""},null,-1),e("div",{class:"title"},"暂无结果，请重试",-1)]))):(d(!0),m(R,{key:1},V(S.value,o=>(d(),m("div",{class:Se(["user-item",{active:o.openid==s.value.openid}]),onClick:t=>v(o),key:o.session_id},[e("div",Je,[e("img",{class:"user-img",src:o.avatar,alt:""},null,8,Ke)]),e("div",Qe,[e("div",We,[e("div",Xe,k(o.name),1),F((d(),m("div",Ze,[M(k(o.last_chat_time),1)])),[[f,"MM-DD HH:mm"]])]),e("div",et,k(o.last_chat_message),1),e("div",tt,[u[1]||(u[1]=e("div",{class:"user-source-title"},"来自：",-1)),e("div",st,k(n(o)),1)])])],10,Ge))),128))],544)}}},lt=P(ot,[["__scopeId","data-v-9b907563"]]),at={class:"message-box"},nt={class:"message-top-box"},rt={class:"message-top-title"},it={key:0,class:"message-top-source"},ct={class:"message-list"},ut={key:0,class:"empty-box"},dt=["id"],_t={class:"itme-right"},pt={class:"message-info"},mt={class:"item-body"},vt={class:"message-content"},ft={class:"user-avatar-box"},gt=["src"],yt=["id"],ht={class:"itme-left"},bt=["src"],St={class:"itme-right"},Tt={class:"message-info"},kt={class:"item-body"},xt={key:0,class:"message-content"},Dt=["innerHTML"],$t={key:2,class:"message-content"},Ct=["src"],Et={key:2,class:"loading-box"},It={__name:"message-list",props:{messages:{type:Array,default:()=>[]},robotInfo:{type:Object,default:()=>{}},isEmpty:{type:Boolean,default:()=>!1},sessionSource:{type:String,default:()=>null},channelItem:{type:Array,default:()=>[]}},emits:["scroll","scrollStart","scrollEnd"],setup(I,{expose:w,emit:x}){const c=x,_=I,S=y(!1),p=y(null),s={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let v=null,a=!1;const D=f=>{let o;for(let t=0;t<_.channelItem.length;t++){const T=_.channelItem[t];T.app_type===f&&(o=T.app_name)}return o};function L(f){a||(v&&(clearTimeout(v),v=null),v=setTimeout(()=>{s.scrollTop-f.target.scrollTop>0&&(s.scrollDirection="up"),s.scrollTop-f.target.scrollTop<0&&(s.scrollDirection="down"),s.scrollTop=f.target.scrollTop,s.scrollHeight=f.target.scrollHeight,s.clientHeight=f.target.clientHeight,c("scroll",{...s}),Math.abs(s.scrollTop)<=s.scrollStartDiff&&s.scrollDirection==="up"&&H(),Math.abs(s.scrollHeight-s.scrollTop-s.clientHeight)<=s.scrollEndDiff&&s.scrollDirection==="down"&&h()},100))}function H(){_.messages.length!=0&&c("scrollStart",{msg:_.messages[0]})}function h(){_.messages.length!=0&&c("scrollEnd",{msg:_.messages[_.messages.length-1]})}const n=()=>{p.value&&W(()=>{a=!0,p.value.scrollTop=p.value.scrollHeight+1,setTimeout(()=>{s.scrollTop=p.value.scrollTop,a=!1},50)})};function l(f,o){W(()=>{a=!0,o||(o="top");let t=p.value,T=document.querySelector("#msg-"+f);T&&(o=="top"?t.scrollTop=T.offsetTop:t.scrollTop=T.offsetTop-t.clientHeight+T.clientHeight),setTimeout(()=>{s.scrollTop=p.value.scrollTop,a=!1},50)})}function u(){s.scrollTop=0,s.scrollDirection=""}return w({scrollToBottom:n,scrollToMessage:l,resetScroll:u}),(f,o)=>{const t=we,T=te("viewer");return d(),m("div",at,[e("div",nt,[e("div",rt,k(_.robotInfo.robot_name),1),I.sessionSource?(d(),m("div",it,"("+k(D(I.sessionSource))+")",1)):O("",!0)]),e("div",{class:"message-list-wrapper",ref_key:"scrollBoxRef",ref:p,onScroll:L},[e("div",ct,[_.isEmpty||!_.messages?(d(),m("div",ut,o[0]||(o[0]=[e("img",{src:se,alt:""},null,-1),e("div",{class:"title"},"暂无结果，请重试",-1)]))):(d(!0),m(R,{key:1},V(_.messages,g=>(d(),m(R,{key:g.uid},[g.is_customer==1?(d(),m("div",{key:0,class:"message-item user-message",id:"msg-"+g.uid},[e("div",_t,[e("div",pt,[e("span",null,k(A(X)(g.create_time)),1),e("span",null,k(g.name),1)]),e("div",mt,[e("div",vt,k(g.content),1)])]),e("div",ft,[e("img",{class:"user-avatar",src:g.avatar},null,8,gt)])],8,dt)):(d(),m("div",{key:1,class:"message-item robot-message",id:"msg-"+g.uid},[e("div",ht,[b(t,{size:"small",spinning:g.loading},{default:$(()=>[e("img",{class:"robot-avatar",src:g.robot_avatar},null,8,bt)]),_:2},1032,["spinning"])]),e("div",St,[e("div",Tt,[e("span",null,k(A(X)(g.create_time)),1),e("span",null,k(g.name),1)]),e("div",kt,[g.msg_type==1?F((d(),m("div",xt,[b(Ue,{content:g.content},null,8,["content"])])),[[T]]):O("",!0),g.msg_type==2?(d(),m("div",{key:1,class:"message-content",innerHTML:g.menu_json.content},null,8,Dt)):O("",!0),g.msg_type==3?(d(),m("div",$t,[F(e("img",{class:"msg-img",src:g.content,alt:""},null,8,Ct),[[T]])])):O("",!0)])])],8,yt))],64))),128)),S.value?(d(),m("div",Et,[b(t)])):O("",!0)])],544)])}}},wt=P(It,[["__scopeId","data-v-9b2c823e"]]),Lt={class:"team-members-pages"},Ht={class:"set-model"},Mt={class:"set-model-body"},Bt={class:"set-date"},Ot={class:"set-date-body"},Rt={class:"set-name"},At={class:"set-reset"},Ut={class:"list-box"},qt={class:"user-box"},zt={class:"records-box"},Nt={__name:"session-record",setup(I){const w=y(!1),x=De(),c=Te(),_=c.query,S=qe(),{robotInfo:p}=S,s=ze(),{messageList:v}=ke(s);let a=!0;const{createMsg:D,onGetChatMessage:L,getRecordList:H,getChannelList:h}=s,n=y(null),l=y([]),u=y([]),f=y(""),o=y("1"),t=Z({robot_id:_.id,app_type:"all",app_id:"all",start_time:"",end_time:"",name:"",page:1,size:20}),T=y(!1),g=r=>{t.start_time=r.start_time,t.end_time=r.end_time,j()},oe=()=>{t.app_type="all",t.name="",t.page=1,o.value="1-"+Math.random()},U=y(!1),Y=y(!1),le=async()=>{let r=J();Y.value=!0,await Ne(r),U.value=!0,Y.value=!1},ae=()=>{x.push({path:"/robot/config/export-record",query:_})},j=()=>{t.page=1,K()},ne=r=>{t.app_type=r,j()},re=()=>{},ie=r=>{f.value=r.app_type,ve(r)},ce=async()=>{},ue=()=>{T.value&&(t.page++,K())},de=async()=>{a=!1;let r=v.value[0].uid;await L()&&pe(r)},_e=()=>{n.value&&a&&n.value.scrollToBottom()},pe=r=>{n.value&&n.value.scrollToMessage(r)},me=()=>{n.value&&n.value.resetScroll()};let q=null;const ve=async r=>{a=!0;let B={robot_key:(c.query||{}).robot_key,avatar:r.avatar,name:r.name,nickname:r.name,is_background:1,openid:r.openid};me(),await D(B),q&&(clearTimeout(q),q=null),q=setTimeout(async()=>{await L()&&_e()},100)},fe=async()=>{let r={robot_id:t.robot_id};const i=await h(r);l.value=[{app_type:"all",app_name:"全部渠道"},...i.data]},J=()=>{let r={robot_id:t.robot_id,start_time:t.start_time,end_time:t.end_time,name:t.name,page:t.page,size:t.size};return t.app_type!=="all"&&(r.app_type=t.app_type),t.app_id!=="all"&&(r.app_id=t.app_id),r},K=async()=>{let r=J(),i=await H(r),B=i.data.list||[];t.page==1&&(u.value=[]),u.value=[...u.value,...B],w.value=u.value.length==0,T.value=i.data.has_more};return N(()=>v.value,()=>{}),G(async()=>{fe()}),xe(()=>{}),(r,i)=>{const B=He,Q=Le,ge=Me,z=Be,ye=Oe,he=Re,be=Ae;return d(),m("div",Lt,[b(ye,{justify:"flex-start",class:"screen-box"},{default:$(()=>[e("div",Ht,[i[4]||(i[4]=e("div",{class:"label set-model-label"},"渠道：",-1)),e("div",Mt,[b(Q,{value:t.app_type,"onUpdate:value":i[0]||(i[0]=E=>t.app_type=E),placeholder:"全部渠道",onChange:ne,style:{width:"200px"}},{default:$(()=>[(d(!0),m(R,null,V(l.value,E=>(d(),ee(B,{key:E.app_type,value:E.app_type},{default:$(()=>[e("span",null,k(E.app_name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])])]),e("div",Bt,[i[5]||(i[5]=e("div",{class:"label set-date-label"},[e("span",null,"日期：")],-1)),e("div",Ot,[b(je,{onDateChange:g,datekey:o.value},null,8,["datekey"])])]),e("div",Rt,[b(ge,{value:t.name,"onUpdate:value":i[1]||(i[1]=E=>t.name=E),placeholder:"请输入用户名称搜索",style:{width:"200px"},onSearch:j},null,8,["value"])]),e("div",At,[b(z,{onClick:oe},{default:$(()=>i[6]||(i[6]=[M("重置")])),_:1,__:[6]}),b(z,{onClick:le,loading:Y.value},{default:$(()=>i[7]||(i[7]=[M("导出")])),_:1,__:[7]},8,["loading"])])]),_:1}),e("div",Ut,[e("div",qt,[b(lt,{channelItem:l.value,userList:u.value,onUserScrollStart:ce,onUserScrollEnd:ue,onUserClick:ie},null,8,["channelItem","userList"])]),e("div",zt,[b(wt,{ref_key:"messageListRef",ref:n,isEmpty:w.value,messages:A(v),robotInfo:A(p),channelItem:l.value,sessionSource:f.value,onScrollStart:de,onScrollEnd:re},null,8,["isEmpty","messages","robotInfo","channelItem","sessionSource"])])]),b(be,{open:U.value,"onUpdate:open":i[3]||(i[3]=E=>U.value=E),title:null,footer:null,width:640},{default:$(()=>[b(he,{status:"success",title:"导出任务创建成功","sub-title":"系统会在后台导出。导出数据量越大，耗时越久。您可以稍后点击导出记录查看并下载导出的文件。"},{extra:$(()=>[b(z,{style:{"margin-right":"16px"},onClick:i[2]||(i[2]=E=>U.value=!1)},{default:$(()=>i[8]||(i[8]=[M("知道了")])),_:1,__:[8]}),b(z,{onClick:ae,type:"primary"},{default:$(()=>i[9]||(i[9]=[M("去下载")])),_:1,__:[9]})]),_:1})]),_:1},8,["open"])])}}},Vt=P(Nt,[["__scopeId","data-v-b5e3e1a3"]]),Pt={class:"user-model-page"},Yt={class:"list-wrapper"},jt={__name:"index",setup(I){return(w,x)=>(d(),m("div",Pt,[x[0]||(x[0]=e("div",{class:"page-title"},"会话记录",-1)),e("div",Yt,[b(Vt)])]))}},as=P(jt,[["__scopeId","data-v-bcc51f14"]]);export{as as default};
