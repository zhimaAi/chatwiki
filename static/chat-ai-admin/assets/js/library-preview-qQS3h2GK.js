import{b as $e,B as Ot,bB as vn,d as Ze,M as be,dF as gn,W as hn,E as Ee,$ as kn,dm as Et,d1 as Mt,k as he,bH as Rt,d2 as Tt,de as yn,d3 as bn,du as It,dM as Sn,dv as wn,dw as xn,dy as Cn,dN as $n,e as Pt,dO as Ln,a2 as qn,bs as On,h as En,dP as Mn,d7 as Ct,dQ as Rn,dR as Tn,dx as In}from"../../index-Bo1NSLpy.js";import{N as g,O as s,X as n,j as t,U as l,u as ne,d as c,z as Le,q as Be,a6 as U,_ as se,F as ve,a1 as xe,x as Ge,a3 as Ue,b as ke,D as Ft,ag as ot,Z as E,Y as ze,a0 as ye,H as lt,S as j,a5 as Dt,a2 as zt,a7 as Pn}from"./vue-chunks-BRsu9_To.js";import{_ as Fn}from"./empty-CzGZrENG.js";import{P as Ht}from"./PlusOutlined-vSxn8uyP.js";import{C as Nt,S as Dn}from"./classification-mark-modal-D0IzA_5Q.js";import{Z as zn,f as Hn,a as Nn,P as An,H as Bn,C as Un,b as Qn}from"./cu-scroll-DO8SSPzJ.js";import{S as Qe}from"./index-eahgXICC.js";import{S as Ve,a as At,c as We,E as jn}from"./edit-subsection-CYWKZwTV.js";import{M as st,_ as it}from"./index-Dxy-C30T.js";import{S as Bt}from"./SettingOutlined-DCgnXzhZ.js";import"./index-BZOjzqJ2.js";import{D as rt}from"./dropdown-DAy60lp8.js";import{S as Ut}from"./SyncOutlined-BFvMifVP.js";import{M as Qt}from"./MoreOutlined-BVPLZ6JB.js";import{_ as Ke}from"./index-B4MPC5xv.js";import{_ as Ae}from"./cu-scroll-bISEQWPA.js";import{F as Jn,_ as Gn}from"./index-COWZrpvC.js";import{S as jt,a as Jt}from"./index-Bs02Ec-o.js";import{R as Vn}from"./rename-modal-CYziNvqI.js";import{V as $t}from"./vue3-pdf-embed-BUNF_9cG.js";import{S as Wn,a as Zn,D as Kn,E as Xn}from"./edit-fragment-alert-DinTG-Oq.js";import{C as Yn}from"./ClockCircleFilled-CqIMCeuB.js";import{_ as ea,a as ta}from"./index-Ct9MFKxB.js";import{B as na,_ as aa}from"./index-_hVn8A6r.js";import{L as oa}from"./LeftOutlined-6ERu0fUO.js";import{S as la}from"./index-QqDDBJFR.js";import{T as sa,_ as ia}from"./index-DkO_ejiW.js";import"./index-Caod9rOO.js";import{I as ra}from"./Input-CCKFAS4o.js";import{D as Lt}from"./DownOutlined-CrhRpWT5.js";import{_ as ca,a as ua}from"./RadioButton-CWIeNl_M.js";import"./axios-Dq7h7Pqt.js";import"./qs-BrxkIg-9.js";import"./crypto-js-ClNpte_9.js";import"./dayjs-B6IotFah.js";import"./pull-up.esm-D94Swpvl.js";import"./observe-dom.esm-CyCedSm-.js";import"./index-CyCFeYRk.js";import"./index-BjF4Ni-g.js";import"./Password-CJww1n-s.js";import"./inputProps--_pnbyjO.js";import"./index-C19UYW2Z.js";import"./Trigger-DtRTHvld.js";import"./ResizeObserver.es-B1PUzC5B.js";import"./DownloadOutlined-BfFY8ehf.js";import"./index-OqAdRPIm.js";import"./CheckOutlined-C6m5maw6.js";import"./useRefs-CRRjy_qY.js";import"./collapseMotion-Brd6xpAT.js";import"./useMergedState-C0iIHNGF.js";import"./FormItemContext-Cv3f2sEj.js";import"./util-BwuffJOK.js";import"./index-CEq6_GyH.js";import"./index-BPmrcBow.js";import"./index-BMSQkwth.js";import"./index-QWfBu8FK.js";import"./TextArea--DLJ7VtX.js";import"./index-CuPJUS8f.js";import"./index-BwedndIp.js";import"./index-DrD42LNC.js";import"./UpOutlined-DWTDMQqv.js";import"./shallowequal-C0xnIuy8.js";import"./slide-CVAZ5BEM.js";import"./Dropdown-hEIgqeS3.js";import"./RightOutlined-zEOifMPB.js";import"./move-DztQgbGg.js";import"./colors-4myZb9T8.js";import"./isPlainObject-CHj0iPA3.js";import"./Col-QoogualX.js";import"./responsiveObserve-D3ho5cFZ.js";import"./hasIn-BtXuxCTT.js";import"./QuestionCircleOutlined-VG1FNUnl.js";import"./List-qVz67bUg.js";import"./SearchOutlined-CFTHZIcT.js";import"./vue-pdf-embed-C6Q-qZ65.js";import"./model-select-BSeLg_eN.js";import"./index-Bbrx8UDU.js";import"./index-Dc6vrBX7.js";import"./index-Dlji98bI.js";import"./index-CNGEafUN.js";import"./index-C_M0mW4F.js";import"./CaretDownFilled-DQ5FyPd3.js";import"./index-BeCYXilq.js";import"./index-kP7DVVOS.js";import"./Checkbox-B_uQPvVs.js";import"./index-Bb6fuwF7.js";import"./CaretDownOutlined-C8EH_hS-.js";import"./pick-CHoP6n6n.js";import"./Search-BF8URtRh.js";const da={class:"empty-box"},_a={__name:"empty",props:{detailsInfo:{type:Object}},emits:["openEditSubscription"],setup(re,{emit:ie}){const $=ie,G=()=>{$("openEditSubscription",{})};return(m,_)=>{const d=Ot;return s(),g("div",da,[_[1]||(_[1]=n("img",{src:Fn,alt:""},null,-1)),_[2]||(_[2]=n("div",{class:"title"},"知识库文档为空，请添加分段",-1)),n("div",null,[t(d,{type:"primary",onClick:G},{icon:l(()=>[t(ne(Ht))]),default:l(()=>[_[0]||(_[0]=n("span",null,"添加分段",-1))]),_:1,__:[0]})])])}}},at=$e(_a,[["__scopeId","data-v-16e77398"]]),pa={class:"chart-wrapper"},fa={class:"zoom-toolbar-wrapper"},ma={__name:"chart-box",emits:["nodeClick"],setup(re,{expose:ie,emit:$}){const G=$,m=c(null);let _=null;const d=Le({nodes:[],edges:[]}),D=c(1),z={},H=()=>{_&&_.destroy();const w={layout:"forceDirected",initialZoom:D.value,disableTelemetry:!0,maxZoom:10,minZoom:.1,minimapContainer:document.getElementById("chatMap"),styling:{minimapViewportBoxColor:"#4399FF",selectedBorderColor:"rgba(255, 255, 255, 1)"}},y=document.getElementById("chartBox");_=new Hn(y,d.nodes,d.edges,w,z);const p=new Nn(_);new An(_),p.updateCallback("onZoom",C=>{D.value=Number(C.toFixed(1))}),new Bn(_,{drawShadowOnHover:!0}),new Un(_,{selectOnClick:!0}).updateCallback("onNodeClick",C=>{G("nodeClick",C)})},q=w=>{D.value=w,_&&_.setZoom(w)},k=({nodes:w,edges:y})=>{d.nodes=[d.nodes,...w],d.edges=[d.edges,...y],_&&_.addElementsToGraph(w,y)},K=({nodes:w,edges:y})=>{d.nodes=[d.nodes,...w],d.edges=[d.edges,...y],_&&_.addAndUpdateElementsInGraph(w,y)},S=({nodes:w,edges:y})=>{d.nodes=w,d.edges=y,_&&_.updateElementsInGraph(w,y)},M=()=>{_&&_.destroy()},X=({nodes:w,edges:y})=>{d.nodes=w,d.edges=y,H()};return Be(()=>{}),ie({render:X,add:k,addAndUpdate:K,update:S,destroy:M}),(w,y)=>(s(),g("div",pa,[n("div",{class:"chart",id:"chartBox",ref_key:"chartBox",ref:m},null,512),y[0]||(y[0]=n("div",{class:"chart-mini-map",id:"chatMap"},null,-1)),n("div",fa,[t(zn,{value:D.value,onChange:q},null,8,["value"])])]))}},va=$e(ma,[["__scopeId","data-v-04d10c54"]]),ga={key:0,class:"popup-wrapper entity-details-wrapper"},ha={class:"popup-header"},ka={key:0,class:"popup-body"},ya={class:"popup-content"},ba={class:"entity-details"},Sa={class:"entity-item"},wa={class:"entity-name"},xa={class:"entity-item",style:{"margin-bottom":"8px"}},Ca={class:"file-info"},$a={class:"file-name"},La={class:"entity-item"},qa={class:"doc-item"},Oa={class:"fragment-content"},Ea={class:"entity-item"},Ma={key:0,class:""},Ra={class:"fragment-content"},Ta={__name:"entity-details",setup(re,{expose:ie}){const $=Le({show:!1,node:null,fromNodes:[]}),G=()=>{$.show=!1};return ie({open:(_,d)=>{$.node=_,$.fromNodes=d,$.show?($.show=!1,Ge(()=>{$.show=!0})):$.show=!0},close:G}),(_,d)=>{const D=Ze;return $.show?(s(),g("div",ga,[n("div",ha,[d[0]||(d[0]=n("div",{class:"popup-title"},"实体详情",-1)),t(ne(vn),{class:"close-btn",onClick:G})]),$.node?(s(),g("div",ka,[t(Qn,null,{default:l(()=>[n("div",ya,[n("div",ba,[n("div",Sa,[d[1]||(d[1]=n("div",{class:"entity-item-header"},[n("div",{class:"entity-item-label"},"实体")],-1)),n("div",wa,se($.node.name),1)]),n("div",xa,[d[2]||(d[2]=n("div",{class:"entity-item-header"},[n("div",{class:"entity-item-label"},"归属文档")],-1)),n("div",Ca,[t(D,{class:"file-icon",name:"doc-file",style:{}}),n("span",$a,se($.node.file_name),1)])]),n("div",La,[d[3]||(d[3]=n("div",{class:"entity-item-header"},[n("div",{class:"entity-item-label"},"分段")],-1)),n("div",null,[n("div",qa,[n("div",Oa,se($.node.content),1)])])]),n("div",Ea,[d[4]||(d[4]=n("div",{class:"entity-item-header"},[n("div",{class:"entity-item-label"},"子图")],-1)),n("div",null,[$.fromNodes.length==0?(s(),g("div",Ma,"无")):U("",!0),(s(!0),g(ve,null,xe($.fromNodes,z=>(s(),g("div",{class:"subgraph-item",key:z.id},[n("div",Ra,se(z.name),1)]))),128))])])])])]),_:1})])):U("",!0)])):U("",!0)}}},Ia=$e(Ta,[["__scopeId","data-v-a19c97a9"]]),Pa={class:"graph-model-body"},Fa={key:0,class:"loading-wrapper"},Da={class:"right-box"},za={__name:"index",setup(re,{expose:ie}){const $=c(!1),G=c(null),m=c(null),_=c(null),d=c(!1),D=Le({file_id:"",data_id:""}),z=Le({edges:[],nodes:[]});let H={};const q=()=>{k()},k=()=>{d.value=!0,gn({file_id:D.file_id,data_id:D.data_id,search_term:D.search_term}).then(w=>{d.value=!1;let y=w.data.edges||[],p=w.data.nodes||[];const i=new Map;y=y.filter(h=>{const ce=`${h.from_id}_${h.to_id}`,ae=`${h.to_id}_${h.from_id}`;return i.has(ce)||i.has(ae)?!1:(i.set(ce,!0),!0)}),y.forEach(h=>{h.id=h.id.toString(),h.from=h.from_id.toString(),h.to=h.to_id.toString(),h.caption=h.label});const C=new Set(y.map(h=>h.from)),W=new Set(y.map(h=>h.to));p.forEach(h=>{h.caption=h.name,h.id=h.id.toString(),h.nodeType=C.has(h.id)&&W.has(h.id)?"both":C.has(h.id)?"from":W.has(h.id)?"to":"normal",h.nodeType==="from"?(h.size=35,h.color="#FFB1B2"):h.nodeType==="to"?(h.size=45,h.color="#005AFF"):(h.size=30,h.color="#69E9BE")});let pe={edges:y,nodes:p};z.edges=pe.edges,z.nodes=pe.nodes,setTimeout(()=>{m.value.render(pe)},0),H={},y.forEach(h=>{H[h.to]||(H[h.to]=[]),H[h.to].push(h.from)})}).catch(w=>{d.value=!1})},K=w=>{let y=H[w.id]||[],p=[];for(let i=0;i<z.nodes.length;i++)y.indexOf(z.nodes[i].id)>-1&&p.push(z.nodes[i]);_.value.open(w,p)},S=()=>{m.value.destroy(),$.value=!1},M=()=>{$.value=!1};return ie({open:w=>{D.file_id=w.file_id,D.data_id=w.id,$.value=!0,setTimeout(()=>{q()},350)}}),(w,y)=>{const p=Qe,i=be;return s(),g("div",{ref_key:"mymodal",ref:G},[t(i,{wrapClassName:"graph-model-wrapper",zIndex:99999,centered:"",open:$.value,"onUpdate:open":y[0]||(y[0]=C=>$.value=C),title:"知识图谱",width:"90vw",footer:null,onOk:M,onCancel:S},{default:l(()=>[n("div",Pa,[d.value?(s(),g("div",Fa,[t(p)])):U("",!0),t(va,{ref_key:"chartBoxRef",ref:m,loading:d.value,onNodeClick:K},null,8,["loading"]),n("div",Da,[t(Ia,{ref_key:"entityDetailsRef",ref:_},null,512)])])]),_:1},8,["open"])],512)}}},Ha=$e(za,[["__scopeId","data-v-2b594227"]]),Na={class:"subsection-box-title"},Aa=["onClick"],Ba={class:"top-block"},Ua={class:"title"},Qa={class:"title-block"},ja={class:"status-box"},Ja={class:"cfb363f"},Ga={class:"split-err"},Va={key:0},Wa={class:"cfb363f"},Za={class:"right-opration"},Ka={class:"hover-btn-box"},Xa=["onClick"],Ya=["onClick"],eo=["onClick"],to={class:"hover-btn-box"},no={class:"hover-btn-box"},ao=["onClick"],oo=["onClick"],lo={key:0,class:"content-box"},so=["innerHTML"],io={key:1,class:"content-box"},ro=["innerHTML"],co=["onMouseup","innerHTML"],uo={key:2,class:"fragment-img"},_o=["src"],po={__name:"subsection-box",props:{paragraphLists:{type:Array,default:()=>[]},search:{type:String,default:""},detailsInfo:{type:Object,default:()=>{}},total:{type:[Number,String],default:0}},emits:["handleDelParagraph","handleScrollTargetPage","openEditSubscription","handleConvert","getStatrList","handleSplit","handleSplitNext","handleSplitUp","handleSplitDelete","handleSegmentation"],setup(re,{expose:ie,emit:$}){const G=Ue(),m=$,_=re,d=(u,r)=>{let{id:T,title:P,content:ue,question:V,answer:I,images:oe,category_id:f}=u,le=u.similar_questions||[];be.confirm({title:"重新转换确认",icon:null,content:`确定要重新转换【分段${r+1}】吗?`,onOk(){return new Promise(N=>{Rt({id:T,title:P,content:ue,question:V,answer:I,images:oe,category_id:f,similar_questions:JSON.stringify(le)}).then(()=>{m("handleConvert",u),N()}).catch(()=>{N()})})},onCancel(){}})},D=u=>{m("openEditSubscription",u)},z=u=>{be.confirm({title:"提示",icon:t(Ee),content:"确认是否删除该分段?",onOk(){return new Promise(r=>{Tt({id:u}).then(()=>{he.success("删除成功"),m("handleDelParagraph",u),r()}).catch(()=>{r()})})},onCancel(){}})},H=(u,r,T)=>{window.getSelection().toString().trim()||(m("handleScrollTargetPage",{page_num:u.page_num,index:r}),Ce(T))},q=u=>{m("handleSegmentation",u)},k=c([]),K=()=>{let u={file_id:G.query.id};Et(u).then(r=>{k.value=r.data||[],m("getStatrList",r.data||[])})};K();const S=c(null),M=()=>{S.value.show()},X=u=>{var T;let r=(T=k.value.filter(P=>P.id==u.category_id)[0])==null?void 0:T.type;return r?We[r]:""},w=(u,r={})=>{Mt({id:u.id,category_id:r.id||0}).then(()=>{he.success("设置成功"),u.category_id=r.id,K()})},y=c(null),p=u=>{y.value.open(u)},i=c(null),C=c(!1),W=c({x:0,y:0}),pe=c(""),h=c(null),ce=c({text:"",parentIndex:-1,originalHtml:""}),ae=ke(()=>{if(!C.value)return{};const u=162;let r=W.value.x,T=W.value.y;const P=i.value.getBoundingClientRect(),ue=window.innerWidth;r<10?r=10:r+u>ue-50&&(r=ue-u-50);const V=r-P.left,I=T;return{left:`${V}px`,top:`${I}px`}}),fe=(u,r)=>{setTimeout(()=>{const T=window.getSelection(),P=T.toString().trim();if(P){u.stopPropagation(),ce.value={text:P,parentIndex:r,originalHtml:_.paragraphLists[r].content},pe.value=P,h.value=T.getRangeAt(0).cloneRange();const V=T.getRangeAt(0).getBoundingClientRect(),I=i.value.getBoundingClientRect();W.value={x:V.left+V.width/2,y:V.top-I.top-50},C.value=!0}else C.value=!1},50)},B=u=>{const{parentIndex:r}=ce.value;switch(u){case"separate":Y(r);break;case"merge-next":x(r);break;case"merge-prev":ge(r);break;case"delete":Re(r);break}C.value=!1,window.getSelection().removeAllRanges()},O=(u,r,T)=>{if(r===0&&T===u.textContent.length&&u.textContent.trim().length>0)return["",u.innerHTML,""];const ue=document.createTreeWalker(u,NodeFilter.SHOW_TEXT);let V,I=0,oe,f,le,N;for(;V=ue.nextNode();){const o=V.nodeValue.length;if(!oe&&I+o>=r&&(oe=V,le=r-I),!f&&I+o>=T){f=V,N=T-I;break}I+=o}const Se=document.createRange();Se.setStart(oe,le),Se.setEnd(f,N);const qe=document.createRange();qe.setStart(u,0),qe.setEnd(oe,le);const De=document.createRange();return De.setStart(f,N),De.setEnd(u,u.childNodes.length),[Q(qe),Q(Se),Q(De)]},Q=u=>{const r=document.createElement("div");return r.appendChild(u.cloneContents()),r.innerHTML},Y=u=>{const r=_.paragraphLists[u].content,P=window.getSelection().getRangeAt(0);P.toString()&&be.confirm({title:"单独分段",icon:t(Ee),content:"确认将该分段内容单独分段么？分段后，原分段的内容会被删除",onOk(){const V=document.createElement("div");V.innerHTML=r;const[I,oe,f]=O(V,P.startOffset,P.endOffset),le=I.replace(/<[^>]+>/g,"").trim()==="",N=f.replace(/<[^>]+>/g,"").trim()==="";le&&N?m("handleSplit",{index:u,beforeContent:"",selectedContent:oe,afterContent:"",isFullSelection:!0}):m("handleSplit",{index:u,beforeContent:I,selectedContent:oe,afterContent:f,originalSelection:{start:P.startOffset,end:P.endOffset,parentIndex:u}})}})},x=u=>{if(u>=_.paragraphLists.length-1)return he.error("没有下一个分段");const r=_.paragraphLists[u].content,P=window.getSelection().getRangeAt(0);P.toString()&&be.confirm({title:"合并到下一个分段",icon:t(Ee),content:"确认将该分段内容合并到下一个分段么？分段后，原分段的内容会被删除",onOk(){const V=document.createElement("div");V.innerHTML=r;const[I,oe,f]=O(V,P.startOffset,P.endOffset),le=I.replace(/<[^>]+>/g,"").trim()==="",N=f.replace(/<[^>]+>/g,"").trim()==="";le&&N?m("handleSplitNext",{index:u,beforeContent:"",selectedContent:oe,afterContent:"",isFullSelection:!0}):m("handleSplitNext",{index:u,beforeContent:I,selectedContent:oe,afterContent:f,originalSelection:{start:P.startOffset,end:P.endOffset,parentIndex:u}})}})},ge=u=>{if(u<=0)return he.error("没有上一个分段");const r=_.paragraphLists[u].content,P=window.getSelection().getRangeAt(0);P.toString()&&be.confirm({title:"合并到上一个分段",icon:t(Ee),content:"确认将该分段内容合并到上一个分段么？分段后，原分段的内容会被删除",onOk(){const V=document.createElement("div");V.innerHTML=r;const[I,oe,f]=O(V,P.startOffset,P.endOffset),le=I.replace(/<[^>]+>/g,"").trim()==="",N=f.replace(/<[^>]+>/g,"").trim()==="";le&&N?m("handleSplitUp",{index:u,beforeContent:"",selectedContent:oe,afterContent:"",isFullSelection:!0}):m("handleSplitUp",{index:u,beforeContent:I,selectedContent:oe,afterContent:f,originalSelection:{start:P.startOffset,end:P.endOffset,parentIndex:u}})}})},Re=u=>{const r=_.paragraphLists[u].content,P=window.getSelection().getRangeAt(0);P.toString()&&be.confirm({title:"删除",icon:t(Ee),content:"确认将该分段内容删除么？",onOk(){const V=document.createElement("div");V.innerHTML=r;const[I,oe,f]=O(V,P.startOffset,P.endOffset),le=I.replace(/<[^>]+>/g,"").trim()==="",N=f.replace(/<[^>]+>/g,"").trim()==="";le&&N?m("handleSplitDelete",{index:u,beforeContent:"",selectedContent:"",afterContent:"",isFullSelection:!0}):m("handleSplitDelete",{index:u,beforeContent:I,selectedContent:"",afterContent:f,originalSelection:{start:P.startOffset,end:P.endOffset,parentIndex:u}})}})},Ce=u=>{C.value&&!u.target.closest(".bubble-card")&&(C.value=!1)};function Fe(u,r,T={}){if(!r||!u)return u;const{highlightClass:P="highlight",caseSensitive:ue=!1,wholeWord:V=!1}=T,I=ue?"g":"gi";let oe;return V?oe=new RegExp(`\\b${Te(r)}\\b`,I):oe=new RegExp(Te(r),I),u.replace(oe,f=>`<span class="${P}">${f}</span>`)}function Te(u){return u.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}return Be(()=>{document.addEventListener("click",Ce)}),Ft(()=>{document.removeEventListener("click",Ce)}),ie({handleOpenEditModal:D}),(u,r)=>{const T=Ke,P=it,ue=st,V=rt,I=Ze,oe=ot("viewer");return s(),g("div",{class:"subsection-box content-container",ref_key:"containerRef",ref:i},[n("div",Na,[r[4]||(r[4]=E(" 分段预览 ")),n("span",null,"共"+se(_.total)+"个分段",1)]),(s(!0),g(ve,null,xe(_.paragraphLists,(f,le)=>(s(),g("div",{class:"list-item",key:f.id,onClick:ye(N=>H(f,le,N),["stop"]),style:ze({"--status-color":X(f)})},[n("div",Ba,[n("div",Ua,[E(" 分段"+se(le+1)+" ",1),n("div",Qa,se(f.title),1),n("span",null,"共"+se(f.word_total)+"个字符",1),n("span",ja,[E(" 嵌入状态："+se(f.status_text),1),f.status==3?(s(),j(ne(hn),{key:0})):U("",!0),f.status==2&&f.errmsg?(s(),j(T,{key:1,title:f.errmsg},{default:l(()=>[n("strong",Ja,[r[5]||(r[5]=E("原因")),t(ne(Ee),{class:"err-icon cfb363f"})])]),_:2},1032,["title"])):U("",!0),f.split_status==4&&f.split_err_msg?(s(),j(T,{key:2,title:f.split_err_msg},{default:l(()=>[n("div",Ga,[t(ne(kn),{style:{"margin-left":"0"},class:"cfb363f"}),r[6]||(r[6]=E(" 分段失败 "))])]),_:2},1032,["title"])):U("",!0)]),re.detailsInfo.graph_switch?(s(),g("span",Va,[E(" 知识图谱状态："+se(f.graph_status_text)+" ",1),f.graph_status==3&&f.graph_err_msg?(s(),j(T,{key:0,title:f.graph_err_msg},{default:l(()=>[n("strong",Wa,[r[7]||(r[7]=E("原因")),t(ne(Ee),{class:"err-icon cfb363f"})])]),_:2},1032,["title"])):U("",!0)])):U("",!0)]),n("div",Za,[t(V,null,{overlay:l(()=>[t(ue,null,{default:l(()=>[(s(!0),g(ve,null,xe(k.value,N=>(s(),j(P,{key:N.id},{default:l(()=>[n("div",{class:"start-item",onClick:ye(Se=>w(f,N),["stop"])},[t(ne(Ve),{style:ze({color:ne(We)[N.type]})},null,8,["style"]),n("div",null,se(N.name||"-"),1)],8,Xa)]),_:2},1024))),128)),t(P,null,{default:l(()=>[n("div",{class:"start-item",onClick:ye(M,["stop"])},[t(ne(Bt)),r[8]||(r[8]=n("div",null,"精选设置",-1))])]),_:1})]),_:2},1024)]),default:l(()=>[n("div",Ka,[f.category_id>0?(s(),j(ne(Ve),{key:0,onClick:ye(N=>w(f,{}),["stop"]),style:ze({color:X(f),"font-size":"16px"})},null,8,["onClick","style"])):(s(),j(ne(At),{key:1,onClick:N=>w(f,k.value[0]),style:{"font-size":"16px",color:"#595959"}},null,8,["onClick"]))])]),_:2},1024),t(T,null,{title:l(()=>r[9]||(r[9]=[E("重新分段")])),default:l(()=>[n("div",{class:"hover-btn-box",onClick:ye(N=>q(f),["stop"])},[t(I,{name:"segmentation-icon",style:{"font-size":"16px"}})],8,Ya)]),_:2},1024),re.detailsInfo.graph_switch?(s(),j(T,{key:0},{title:l(()=>r[10]||(r[10]=[E("知识图谱")])),default:l(()=>[n("div",{class:"hover-btn-box",onClick:N=>p(f)},[t(I,{name:"graph-icon",style:{"font-size":"16px",color:"#595959"}})],8,eo)]),_:2},1024)):U("",!0),t(T,null,{title:l(()=>r[11]||(r[11]=[E("重新转换")])),default:l(()=>[n("div",to,[t(ne(Ut),{onClick:ye(N=>d(f,le),["stop"])},null,8,["onClick"])])]),_:2},1024),t(V,{placement:"bottomRight"},{overlay:l(()=>[t(ue,null,{default:l(()=>[t(P,null,{default:l(()=>[n("div",{onClick:ye(N=>D(f),["stop"])},"编辑",8,ao)]),_:2},1024),t(P,null,{default:l(()=>[n("div",{onClick:ye(N=>z(f.id),["stop"])},"删除",8,oo)]),_:2},1024)]),_:2},1024)]),default:l(()=>[n("div",no,[t(ne(Qt),{style:{"font-size":"16px",color:"#595959"}})])]),_:2},1024)])]),f.question?(s(),g("div",lo,[r[12]||(r[12]=E("Q： ")),n("span",{innerHTML:Fe(f.question,_.search)},null,8,so)])):U("",!0),f.answer?(s(),g("div",io,[r[13]||(r[13]=E("A：")),n("span",{innerHTML:Fe(f.answer,_.search)},null,8,ro)])):U("",!0),n("div",{class:"content-box",onMouseup:ye(N=>fe(N,le),["stop"]),innerHTML:Fe(f.content,_.search)},null,40,co),f.images.length>0?lt((s(),g("div",uo,[(s(!0),g(ve,null,xe(f.images,(N,Se)=>(s(),g("img",{key:Se,src:N,alt:""},null,8,_o))),128))])),[[oe]]):U("",!0)],12,Aa))),128)),t(Nt,{onOk:K,ref_key:"classificationMarkModalRef",ref:S},null,512),t(Ha,{ref_key:"graphModelRef",ref:y},null,512),C.value?(s(),g("div",{key:0,class:"bubble-card",style:ze(ae.value)},[n("button",{class:"bubble-item",onClick:r[0]||(r[0]=ye(f=>B("separate"),["stop"]))},[t(I,{name:"segmentation",style:{"font-size":"16px",color:"#262626","margin-right":"4px"}}),r[14]||(r[14]=E(" 单独成段 "))]),n("button",{class:"bubble-item",onClick:r[1]||(r[1]=ye(f=>B("merge-prev"),["stop"]))},[t(I,{name:"segmentation-up",style:{"font-size":"16px",color:"#262626","margin-right":"4px"}}),r[15]||(r[15]=E(" 合并到上一分段 "))]),n("button",{class:"bubble-item",onClick:r[2]||(r[2]=ye(f=>B("merge-next"),["stop"]))},[t(I,{name:"segmentation-down",style:{"font-size":"16px",color:"#262626","margin-right":"4px"}}),r[16]||(r[16]=E(" 合并到下一分段 "))]),n("button",{class:"bubble-item",onClick:r[3]||(r[3]=ye(f=>B("delete"),["stop"]))},[t(I,{name:"delete",style:{"font-size":"16px",color:"#262626","margin-right":"4px"}}),r[17]||(r[17]=E(" 删除 "))])],4)):U("",!0)],512)}}},qt=$e(po,[["__scopeId","data-v-380aa8cf"]]),fo={class:"mode-box"},mo=["innerHTML"],vo={class:"tag-item"},go={__name:"segmentation-mode",props:{detailsInfo:{type:Object}},setup(re){const ie=re,$=c(""),G=ke(()=>{const{is_table_file:m,is_qa_doc:_,is_diy_split:d,question_lable:D,answer_lable:z,separators:H,chunk_size:q,chunk_overlap:k,question_column:K,answer_column:S,qa_index_type:M,doc_type:X}=ie.detailsInfo;if(m!=1&&_!=1&&d!=1)return X==3?($.value=`分段模式：手动分段
文档类型：普通文档`,"自定义：普通文档"):($.value=`分段模式：智能分段
文档类型：普通文档`,"智能分段：普通文档");if(m!=1&&_==1)return X==3?($.value=`分段模式：手动分段
文档类型：QA文档`,"自定义：QA文档"):($.value=`分段模式：智能分段
文档类型：QA文档
问题开始标识符："${D}"
答案开始标识符："${z}"`,"智能分段：QA文档");if(m!=1&&_!=1&&d==1)return $.value=`分段模式：自定义分段
文档标识符：${H}
分段最大长度：${q}字符
文段重叠长度：${k}字符`,"自定义分段";if(m==1&&_!=1)return $.value=`分段模式：智能分段
文档类型：普通表格`,"智能分段：普通表格";if(m==1&&_==1){let w=M==1?"问题与答案一起生成索引":"仅对问题生成索引";return $.value=`分段模式：智能分段
文档类型：QA文档
问题所在列："${K}"
答案所在列："${S}"
索引方式：${w}`,"智能分段：QA文档"}});return(m,_)=>{const d=Ke;return s(),g("div",fo,[t(d,null,{title:l(()=>[n("div",{class:"tooltip-text-box",innerHTML:$.value},null,8,mo)]),default:l(()=>[n("div",vo,se(G.value),1)]),_:1})])}}},ho=$e(go,[["__scopeId","data-v-6ee0b31f"]]),ko={__name:"update-frequency",emits:["ok"],setup(re,{expose:ie,emit:$}){const G=$,m=c(!1),_=c(!1),d=Le({doc_auto_renew_frequency:1,id:""}),D=H=>{let{doc_auto_renew_frequency:q,id:k}=H;d.doc_auto_renew_frequency=+q,d.id=k,m.value=!0},z=()=>{_.value=!0,yn({...d}).then(H=>{G("ok",d.doc_auto_renew_frequency),m.value=!1,he.success("设置成功")}).finally(()=>{_.value=!1})};return ie({open:D}),(H,q)=>{const k=Jt,K=jt,S=Gn,M=Jn,X=be;return s(),g("div",null,[t(X,{open:m.value,"onUpdate:open":q[1]||(q[1]=w=>m.value=w),"confirm-loading":_.value,maskClosable:!1,title:"设置更新频率",onOk:z},{default:l(()=>[t(M,{style:{margin:"32px 0"},layout:"vertical",model:d},{default:l(()=>[t(S,{name:"doc_auto_renew_frequency",label:"更新频率",required:""},{default:l(()=>[t(K,{value:d.doc_auto_renew_frequency,"onUpdate:value":q[0]||(q[0]=w=>d.doc_auto_renew_frequency=w),style:{width:"100%"}},{default:l(()=>[t(k,{value:1},{default:l(()=>q[2]||(q[2]=[E("不自动更新")])),_:1,__:[2]}),t(k,{value:2},{default:l(()=>q[3]||(q[3]=[E("每天")])),_:1,__:[3]}),t(k,{value:3},{default:l(()=>q[4]||(q[4]=[E("每3天")])),_:1,__:[4]}),t(k,{value:4},{default:l(()=>q[5]||(q[5]=[E("每7天")])),_:1,__:[5]}),t(k,{value:5},{default:l(()=>q[6]||(q[6]=[E("每30天")])),_:1,__:[6]})]),_:1},8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open","confirm-loading"])])}}},yo={class:"loading"},bo={__name:"pdf-preview",props:{source:{type:[String],required:!0},pageSize:{type:Number,default:10}},emits:["onScrollEnd","select","rendered","scroll","getTotalPage"],setup(re,{expose:ie,emit:$}){const G=re,m=$,_=c(null),d=c([]),D=c(0),z=c(!1),H=ke(()=>z.value?null:{"border-bottom":"2px solid #d9d9d9"}),q=c({fade:!1,scrollbarTrackClickable:!0,interactive:!0,minSize:40});Be(async()=>{const y=await $t.getDocument(G.source).promise;D.value=y.numPages,m("getTotalPage",D.value),k()});const k=(y=null)=>{const p=d.value.length;if(p>=D.value||z.value)return;z.value=!0;const i=[];for(let C=1;C<=G.pageSize&&p+C<=D.value;C++)i.push(p+C);d.value.push(...i),Ge(()=>{typeof y=="function"&&y()})},K=y=>{k(),m("onScrollEnd",y)},S=y=>{Ge(()=>{y===d.value[d.value.length-1]&&(z.value=!1,m("rendered",y,D.value))})},M=y=>{m("select",y)},X=()=>_.value,w=y=>{m("scroll",y)};return ie({loadMore:k,getScrollInstance:X}),(y,p)=>{const i=Qe;return s(),j(Ae,{scrollbar:q.value,ref_key:"scrollRef",ref:_,onScroll:w,onOnScrollEnd:K},{default:l(()=>[(s(!0),g(ve,null,xe(d.value,C=>(s(),j(ne($t),{onClick:W=>M(C),key:C,source:re.source,page:C,onRendered:()=>S(C),style:ze(H.value)},null,8,["onClick","source","page","onRendered","style"]))),128)),n("div",yo,[z.value?(s(),j(i,{key:0})):U("",!0)])]),_:1},8,["scrollbar"])}}},So=$e(bo,[["__scopeId","data-v-8ffdbe19"]]),wo={key:0,class:"loading-wrap"},xo={class:"document-segmentation"},Co={class:"page-container"},$o={class:"page-left"},Lo={class:"page-right"},qo={class:"document-fragment-preview"},Oo={class:"preview-header"},Eo={class:"fragment-number"},Mo={key:1,class:"loading-box"},Ro="你是一位文章分段助手，根据文章内容的语义进行合理分段，确保每个分段表述一个完整的语义，每个分段字数控制在500字左右，最大不超过1000字。请严格按照文章内容进行分段，不要对文章内容进行加工，分段完成后输出分段后的内容。",To={__name:"document-segmentation-model",props:{pdfState:{type:Object,default:()=>{}},currentData:{type:Object,default:()=>{}},paragraphType:{type:String,default:""}},emits:["ok","finish","loading"],setup(re,{expose:ie,emit:$}){const G=bn(),{setInitDocumentFragmentList:m}=G,_=Ue(),d=$,{id:D}=_.query,z=c(!0),H=c(1);let q=!1;const k=re,K=c(1);let S={id:D,separators_no:"",chunk_size:512,not_merged_text:!1,chunk_overlap:50,is_qa_doc:0,question_lable:"",answer_lable:"",enable_extract_image:!0,ai_chunk_size:5e3,ai_chunk_model:"",ai_chunk_model_config_id:"",ai_chunk_prumpt:Ro,ai_chunk_task_id:""};const M=c(null),X=o=>{typeof o.separators_no=="object"&&(o.separators_no=o.separators_no.join(",")),S={...S,...o},q?be.confirm({title:"提醒",icon:t(Ee),content:"文档片段已被编辑重新获取文档片段会丢失当前修改过的文档片段内容，确定要重新获取吗？",okText:"确定",okType:"danger",cancelText:"取消",onOk(){q=!1,ge("create")},onCancel(){}}):(q=!1,ge("create"))};let w=60*10,y=0;const p=c({}),i=c(0),C=()=>{z.value||(z.value=!0),It({id:D}).then(async o=>{const{status:R}=o.data;if(i.value=o.data.library_type,p.value=o.data,S={...S,separators_no:o.data.separators_no||"11,12",chunk_size:+o.data.chunk_size||512,not_merged_text:o.data.not_merged_text,ai_chunk_size:+o.data.ai_chunk_size||5e3,chunk_overlap:+o.data.chunk_overlap||50,is_qa_doc:i.value==2?1:0,question_lable:o.data.question_lable,answer_lable:o.data.answer_lable,question_column:o.data.question_column,answer_column:o.data.answer_column,enable_extract_image:o.data.enable_extract_image=="true",qa_index_type:+o.data.qa_index_type,chunk_type:+o.data.chunk_type,semantic_chunk_size:+o.data.semantic_chunk_size||512,semantic_chunk_overlap:+o.data.semantic_chunk_overlap||50,semantic_chunk_threshold:+o.data.semantic_chunk_threshold||90,semantic_chunk_use_model:o.data.semantic_chunk_use_model||"",ai_chunk_prumpt:o.data.ai_chunk_prumpt||"",ai_chunk_model:o.data.ai_chunk_model||"",semantic_chunk_model_config_id:o.data.semantic_chunk_model_config_id>0?o.data.semantic_chunk_model_config_id:"",ai_chunk_model_config_id:o.data.ai_chunk_model_config_id>0?o.data.ai_chunk_model_config_id:"",ai_chunk_task_id:o.data.ai_chunk_task_id||""},o.data.chunk_type==0&&(S={...S,separators_no:o.data.normal_chunk_default_separators_no,chunk_size:o.data.normal_chunk_default_chunk_size,not_merged_text:o.data.normal_chunk_default_not_merged_text,chunk_overlap:o.data.normal_chunk_default_chunk_overlap,chunk_type:+o.data.default_chunk_type,semantic_chunk_size:+o.data.semantic_chunk_default_chunk_size,semantic_chunk_overlap:+o.data.semantic_chunk_default_chunk_overlap,semantic_chunk_threshold:+o.data.semantic_chunk_default_threshold,semantic_chunk_use_model:o.data.default_use_model||"",semantic_chunk_model_config_id:o.data.default_model_config_id>0?o.data.default_model_config_id:""}),R==0){if(y++,y>w){be.error({title:"提醒",content:"文档解析速度慢请稍后再试"});return}setTimeout(()=>{C()},1e3)}else(R==4||R==2)&&(z.value=!1,H.value=parseInt(o.data.is_table_file),o.data.library_id,i.value==2?(S.question_lable||S.question_column)&&ge():ge());o.data.is_table_file==1&&pe()})};Be(async()=>{await C()});const W=c([]),pe=()=>{xn({id:D}).then(o=>{let R=[];for(let ee in o.data)R.push({lable:o.data[ee],value:ee});W.value=R})},h=c([]),ce=c(!1),ae=c(!1),fe=c(""),B=c(null);let O=null;const Q=c([]),Y=c(0),x=ke(()=>Y.value<=0),ge=o=>{var de;d("loading",!0);let R={...S,semantic_chunk_model_config_id:S.semantic_chunk_model_config_id?+S.semantic_chunk_model_config_id:0,ai_chunk_model_config_id:S.ai_chunk_model_config_id?+S.ai_chunk_model_config_id:0,...k.pdfState};S.chunk_type==3&&(S.ai_chunk_task_id&&!o&&(R.ai_chunk_task_id=S.ai_chunk_task_id),R.ai_chunk_task_id&&o&&o==="create"&&delete R.ai_chunk_task_id);let ee=wn;return k.paragraphType&&k.paragraphType==="paragraphsSegmented"&&o=="create"&&(ee=$n,delete R.id),k.paragraphType&&k.paragraphType==="paragraphsSegmented"&&!o?(Q.value=k.currentData.list||[],Y.value=k.currentData.list.length,S.chunk_type==3&&(fe.value=((de=k.currentData.split_params)==null?void 0:de.ai_chunk_task_id)||"",ae.value=!0,M.value.reLoading=!0,B.value=null,!S.ai_chunk_task_id&&H.value!=1||o&&o==="create"?(Q.value=[],Y.value=0,Te()):(ae.value=!1,M.value.reLoading=!1)),S.chunk_type!=3&&(M.value.reLoading=!1,M.value.saveLoading=!1),d("loading",!1),!1):ee(R).then(me=>{var Me;h.value=me.data.list||[],m(h.value),Q.value=me.data.list||[],Y.value=me.data.list.length||0,S.chunk_type==3&&(fe.value=((Me=me.data.split_params)==null?void 0:Me.ai_chunk_task_id)||"",ae.value=!0,M.value.reLoading=!0,M.value.saveLoading=!0,B.value=null,!S.ai_chunk_task_id&&H.value!=1||o&&o==="create"?(Q.value=[],Y.value=0,Te()):(ae.value=!1,M.value.reLoading=!1,M.value.saveLoading=!1))}).finally(()=>{S.chunk_type!=3&&(M.value.reLoading=!1,M.value.saveLoading=!1),d("loading",!1)})},Re=o=>{K.value=o},Ce=async()=>{var o;try{const R=await u();return R.data.err_msg?(B.value=R.data.err_msg,!0):((o=R.data.list)==null?void 0:o.length)>0?(h.value=R.data.list||[],m(h.value),Q.value=R.data.list||[],Y.value=R.data.list.length||0,!0):!1}catch{return B.value="请求异常，停止轮询",!0}};function Fe(o){return o.split("message:")[1]}const Te=()=>{const o=async()=>{if(!await Ce())O=setTimeout(o,3e3);else if(ae.value=!1,M.value.reLoading=!1,M.value.saveLoading=!1,O!==null&&(clearTimeout(O),O=null),ce.value&&Se(),B.value){let ee=Fe(B.value);be.error({title:"分段失败提示",content:ee?`模型调用失败，失败原因：${ee}`:"模型调用失败"})}};o()},u=()=>Cn({id:S.id,task_id:fe.value}),r=c(null);let T=null;const P=({title:o,content:R,question:ee,answer:de,images:me},Me)=>{T=Me,r.value.open({title:o,content:R,question:ee,answer:de,images:me})},ue=({title:o,content:R,question:ee,answer:de,images:me})=>{(Q.value[T].title!=o||Q.value[T].content!=R||Q.value[T].question!=ee||Q.value[T].answer!=de)&&(q=!0),Q.value[T].title=o,Q.value[T].content=R,Q.value[T].question=ee,Q.value[T].answer=de,Q.value[T].images=me,Q.value[T].word_total=de.length+ee.length+R.length},V=o=>{be.confirm({title:"提醒",icon:t(Ee),content:"确定要删除这个片段吗?",okText:"确定",okType:"danger",cancelText:"取消",onOk(){q=!0,Q.value.splice(o,1)},onCancel(){}})},I=c(""),oe=o=>{I.value=o},f=c(!1),le=()=>{let o=M.value.formState;o=JSON.parse(JSON.stringify(o)),typeof o.separators_no=="object"&&(o.separators_no=o.separators_no.join(",")),S={...S,...o}},N=o=>{let R=0;return o.forEach(ee=>{R+=parseInt(ee.word_total)}),R},Se=async()=>{if((Y.value<=0||S.chunk_type!=K.value)&&(le(),await ge()),le(),I.value)return he.error(I.value);if(S.chunk_type==3&&!Q.value.length)return ce.value=!0,!1;fe.value&&(S.ai_chunk_task_id=fe.value);let o={...S,semantic_chunk_model_config_id:S.semantic_chunk_model_config_id?+S.semantic_chunk_model_config_id:0,ai_chunk_model_config_id:S.ai_chunk_model_config_id?+S.ai_chunk_model_config_id:0,is_table_file:H.value,...k.pdfState};delete o.id;let R={file_id:D,word_total:N(Q.value),split_params:JSON.stringify(o),list:JSON.stringify(Q.value),...k.pdfState};o.is_qa_doc==1&&(R.qa_index_type=o.qa_index_type),f.value=!0,k.paragraphType&&k.paragraphType==="paragraphsSegmented"&&(R.data_id=R.data_ids,delete R.data_ids),Sn(R).then(()=>{d("ok"),d("finish")}).finally(()=>{f.value=!1}).catch(ee=>{ee.data&&ee.data.index&&De(ee.data.index),d("finish")})},qe=c(null),De=o=>{o=o-1;let R=qe.value.querySelectorAll(".fragment-item");R.length>=o&&R[o].scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})};return Ft(()=>{O&&(clearTimeout(O),O=null)}),ie({handleSaveLibFileSplit:Se}),(o,R)=>{const ee=Qe;return s(),g(ve,null,[z.value?(s(),g("div",wo,[t(ee)])):U("",!0),n("div",xo,[n("div",Co,[n("div",$o,[t(Wn,{excellQaLists:W.value,libFileInfo:p.value,library_type:i.value,mode:H.value,hideSave:!0,status:"paragraphsSegmented",ref_key:"segmentationSettingRef",ref:M,onChange:X,onChangeChunkType:Re,onSave:Se,onValidate:oe},null,8,["excellQaLists","libFileInfo","library_type","mode"])]),n("div",Lo,[n("div",qo,[n("div",Oo,[R[0]||(R[0]=n("span",{class:"label-text"},"分段预览",-1)),n("span",Eo,"共"+se(Y.value)+"个分段",1)]),x.value&&!ae.value?(s(),j(Zn,{key:0})):U("",!0),ae.value?(s(),g("div",Mo,[t(ee),R[1]||(R[1]=E("数据处理中..."))])):U("",!0),n("div",{class:"preview-box",ref_key:"previewBoxRef",ref:qe},[(s(!0),g(ve,null,xe(Q.value,(de,me)=>(s(),g("div",{class:"fragment-item",key:de.number},[t(Kn,{status:"paragraphsSegmented",currentData:re.currentData,number:de.number,title:de.title,content:de.content,total:de.word_total,question:de.question,answer:de.answer,images:de.images,onDelete:Me=>V(me),onEdit:Me=>P(de,me)},null,8,["currentData","number","title","content","total","question","answer","images","onDelete","onEdit"])]))),128))],512)])])]),t(Xn,{ref_key:"editFragmentAlertRef",ref:r,onOk:ue},null,512)])],64)}}},Gt=$e(To,[["__scopeId","data-v-3ebddd35"]]),Io={class:"select-box"},Po=["onClick"],Fo={class:"title"},Do={class:"desc"},zo={key:0,class:"card-switch"},Ho={class:"main-content-box"},No={__name:"re-segmentation-page",props:{detailsInfo:{type:Object,default:()=>{}}},emits:["ok","enable"],setup(re,{expose:ie,emit:$}){const G=Pt(),m=ke(()=>{var B;return((B=G.companyInfo)==null?void 0:B.ali_ocr_switch)=="1"}),_=Ue().query,d=zt(),D=re,z=c(!1),H=c(!1),q=c(""),k=$;let K={};const S=c([{title:"图文OCR解析",desc:"通过OCR文字识别提取pdf文件内容，可以兼容扫描件，但是解析速度较慢。",icon:"pdf-ocr",pdf_parse_type:2},{title:"纯文本解析",desc:"只提取Pdf中的文字内容，如果文档为扫描件可能提取不到内容。",icon:"pdf-text",pdf_parse_type:1},{title:"图文解析",desc:"提取PDF文档中的图片和文字",icon:"pdf-img",pdf_parse_type:3}]),M=Le({pdf_parse_type:2,pdf_page_num:0}),X=()=>{S.value=S.value.filter(B=>B.pdf_parse_type!=4),k("enable")},w=c(!1),y=B=>{w.value=B},p=B=>{K={...B},M.pdf_parse_type=2,M.pdf_page_num=B.pdf_page_num,B.type==1&&(q.value=`当页(${B.pdf_page_num})重新分段`),B.type==2&&(q.value="将文档重新分段"),B.type==3&&(q.value="重新学习文档",S.value.push({title:"阿里云OCR解析",desc:"通过阿里云文档智能接口解析提取图片和文字",icon:"ali-ocr",pdf_parse_type:4})),z.value=!0},i=()=>{window.open("#/user/aliocr")},C=B=>{if(B.pdf_parse_type==4&&!m.value)return!1;M.pdf_parse_type=B.pdf_parse_type},W=c(!1),pe=()=>{if(K.type==3){if(M.pdf_parse_type==1){d.push("/library/document-segmentation?document_id="+_.id+"&source=preview");return}W.value=!0,Ln({id:_.id,pdf_parse_type:M.pdf_parse_type}).then(B=>{he.success("重新学习成功"),(M.pdf_parse_type==2||M.pdf_parse_type==3||M.pdf_parse_type==4)&&d.push({path:"/library/details/knowledge-document",query:{id:D.detailsInfo.library_id}}),M.pdf_parse_type==1&&d.push("/library/document-segmentation?document_id="+_.id+"&source=preview"),z.value=!1}).finally(()=>{W.value=!1});return}z.value=!1,H.value=!0},h=c(null),ce=()=>{W.value=!0,h.value.handleSaveLibFileSplit()},ae=()=>{he.success("保存成功"),H.value=!1,k("ok",K.type)},fe=()=>{W.value=!1};return ie({show:p}),(B,O)=>{const Q=Ze,Y=be;return s(),g("div",null,[t(Y,{open:z.value,"onUpdate:open":O[0]||(O[0]=x=>z.value=x),title:q.value,onOk:pe,onCancel:X,width:720,confirmLoading:W.value},{default:l(()=>[n("div",Io,[(s(!0),g(ve,null,xe(S.value,x=>(s(),g("div",{class:Dt(["select-list-item",{active:x.pdf_parse_type==M.pdf_parse_type},{disabled:x.pdf_parse_type==4&&!m.value}]),onClick:ge=>C(x),key:x.pdf_parse_type},[n("div",Fo,[t(Q,{name:x.icon,style:{"font-size":"16px"}},null,8,["name"]),E(" "+se(x.title),1)]),n("div",Do,se(x.desc),1),x.pdf_parse_type==4&&!m.value?(s(),g("div",zo,[O[2]||(O[2]=E(" 未开启阿里云OCR ")),n("div",{class:"card-switch-btn",onClick:ye(i,["stop"])},"去开启")])):U("",!0)],10,Po))),128))])]),_:1},8,["open","title","confirmLoading"]),t(Y,{open:H.value,"onUpdate:open":O[1]||(O[1]=x=>H.value=x),onCancel:X,title:q.value,maskClosable:!1,"ok-text":w.value?"文档解析中,请稍候...":"确定",confirmLoading:W.value||w.value,onOk:ce,width:1e3},{default:l(()=>[n("div",Ho,[H.value?(s(),j(Gt,{key:0,onOk:ae,onFinish:fe,onLoading:y,pdfState:M,ref_key:"documentSegmentationModalRef",ref:h},null,8,["pdfState"])):U("",!0)])]),_:1},8,["open","title","ok-text","confirmLoading"])])}}},Ao=$e(No,[["__scopeId","data-v-fdcaa00c"]]),Bo={class:"subsection-box"},Uo={class:"qa-list-box"},Qo={class:"list-item"},jo=["innerHTML"],Jo={key:0,class:"list-item"},Go=["innerHTML"],Vo={class:"list-item"},Wo=["innerHTML"],Zo={class:"fragment-img"},Ko=["src"],Xo={key:0,class:"status-tag"},Yo={key:1,class:"status-tag complete"},el={class:"status-tag status-error"},tl={key:3,class:"status-tag running"},nl={class:"right-opration"},al={class:"hover-btn-box"},ol=["onClick"],ll=["onClick"],sl={class:"hover-btn-box"},il=["onClick"],rl=["onClick"],cl={__name:"qa-subsection-box",props:{paragraphLists:{type:Array,default:()=>[]},search:{type:String,default:""},total:{type:[Number,String],default:0}},emits:["handleDelParagraph","handleScrollTargetPage","openEditSubscription","handleConvert","getStatrList"],setup(re,{expose:ie,emit:$}){const m=Ue().query,_=$,d=re,D=(p,i)=>{let{id:C,title:W,content:pe,question:h,answer:ce,images:ae,category_id:fe}=p,B=p.similar_questions||[];be.confirm({title:"重新转换确认",icon:null,content:`确定要重新转换【分段${i+1}】吗?`,onOk(){return new Promise((O,Q)=>{Rt({id:C,title:W,content:pe,question:h,answer:ce,images:ae,category_id:fe,similar_questions:JSON.stringify(B)}).then(Y=>{_("handleConvert",p),O()}).catch(()=>{O()})})},onCancel(){}})},z=p=>{_("openEditSubscription",p)},H=p=>{be.confirm({title:"提示",icon:t(Ee),content:"确认是否删除该分段?",onOk(){return new Promise((i,C)=>{Tt({id:p}).then(W=>{he.success("删除成功"),_("handleDelParagraph",p),i()}).catch(()=>{i()})})},onCancel(){}})},q=c([]),k=()=>{let p={};m.id&&(p.file_id=m.id),Et(p).then(i=>{q.value=i.data||[],_("getStatrList",i.data||[])})};k();const K=c(null),S=()=>{K.value.show()},M=p=>{var C;let i=(C=q.value.filter(W=>W.id==p.category_id)[0])==null?void 0:C.type;return i?We[i]:"#F4EA2A"},X=(p,i={})=>{Mt({id:p.id,category_id:i.id||0}).then(C=>{he.success("设置成功"),p.category_id=i.id,k()})};function w(p,i,C={}){if(!i||!p)return p;const{highlightClass:W="highlight",caseSensitive:pe=!1,wholeWord:h=!1}=C,ce=pe?"g":"gi";let ae;return h?ae=new RegExp(`\\b${y(i)}\\b`,ce):ae=new RegExp(y(i),ce),p.replace(ae,fe=>`<span class="${W}">${fe}</span>`)}function y(p){return p.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}return ie({handleOpenEditModal:z}),(p,i)=>{const C=ea,W=Ke,pe=Qe,h=it,ce=st,ae=rt,fe=ta,B=ot("viewer");return s(),g("div",Bo,[t(fe,{"data-source":re.paragraphLists,pagination:!1},{default:l(()=>[t(C,{key:"id","data-index":"id",width:1148},{title:l(()=>[E("问答（共"+se(d.total)+"个）",1)]),default:l(({record:O})=>[n("div",Uo,[n("div",Qo,[i[0]||(i[0]=n("div",{class:"list-label"},"问题",-1)),n("div",{class:"list-content",innerHTML:w(O.question,d.search)},null,8,jo)]),O.similar_questions&&O.similar_questions.length?(s(),g("div",Jo,[i[1]||(i[1]=n("div",{class:"list-label"},"相似问法",-1)),n("div",{class:"list-content",innerHTML:w(O.similar_questions.join("/"),d.search)},null,8,Go)])):U("",!0),n("div",Vo,[i[2]||(i[2]=n("div",{class:"list-label"},"答案",-1)),n("div",{class:"list-content",innerHTML:w(O.answer,d.search)},null,8,Wo)]),lt((s(),g("div",Zo,[(s(!0),g(ve,null,xe(O.images,(Q,Y)=>(s(),g("img",{key:Y,src:Q,alt:""},null,8,Ko))),128))])),[[B]])])]),_:1}),t(C,{title:"嵌入状态",key:"status_text","data-index":"status_text",width:128},{default:l(({record:O})=>[O.status==0?(s(),g("span",Xo,[t(ne(Yn)),i[3]||(i[3]=E(" 未转换"))])):U("",!0),O.status==1?(s(),g("span",Yo,[t(ne(qn)),i[4]||(i[4]=E(" 已转换"))])):U("",!0),O.status==2?(s(),j(W,{key:2,placement:"top"},{title:l(()=>[n("span",null,se(O.errmsg),1)]),default:l(()=>[n("span",null,[n("span",el,[t(ne(On)),i[5]||(i[5]=E(" 转换异常"))])])]),_:2},1024)):U("",!0),O.status==3?(s(),g("span",tl,[t(pe,{size:"small"}),i[6]||(i[6]=E(" 转换中"))])):U("",!0)]),_:1}),t(C,{title:"操作",key:"action","data-index":"action",width:120},{default:l(({record:O,index:Q})=>[n("div",nl,[t(ae,null,{overlay:l(()=>[t(ce,null,{default:l(()=>[(s(!0),g(ve,null,xe(q.value,Y=>(s(),j(h,{key:Y.id},{default:l(()=>[n("div",{class:"start-item",onClick:x=>X(O,Y)},[t(ne(Ve),{style:ze({color:ne(We)[Y.type]})},null,8,["style"]),n("div",null,se(Y.name||"-"),1)],8,ol)]),_:2},1024))),128)),t(h,null,{default:l(()=>[n("div",{class:"start-item",onClick:S},[t(ne(Bt)),i[7]||(i[7]=n("div",null,"标记设置",-1))])]),_:1})]),_:2},1024)]),default:l(()=>[n("div",al,[O.category_id>0?(s(),j(ne(Ve),{key:0,onClick:Y=>X(O,{}),style:ze({color:M(O),"font-size":"16px"})},null,8,["onClick","style"])):(s(),j(ne(At),{key:1,onClick:Y=>X(O,q.value[0]),style:{"font-size":"16px"}},null,8,["onClick"]))])]),_:2},1024),t(W,null,{title:l(()=>i[8]||(i[8]=[E("重新转换")])),default:l(()=>[n("div",{class:"hover-btn-box",onClick:Y=>D(O,Q)},[t(ne(Ut))],8,ll)]),_:2},1024),t(ae,{placement:"bottomRight"},{overlay:l(()=>[t(ce,null,{default:l(()=>[t(h,null,{default:l(()=>[n("div",{onClick:ye(Y=>z(O),["stop"])},"编辑",8,il)]),_:2},1024),t(h,null,{default:l(()=>[n("div",{onClick:ye(Y=>H(O.id),["stop"])},"删除",8,rl)]),_:2},1024)]),_:2},1024)]),default:l(()=>[n("div",sl,[t(ne(Qt))])]),_:2},1024)])]),_:1})]),_:1},8,["data-source"]),t(Nt,{onOk:k,ref_key:"classificationMarkModalRef",ref:K},null,512)])}}},ul=$e(cl,[["__scopeId","data-v-6a1ecdf2"]]),dl={class:"main-content-box"},_l={__name:"segmentation-setting-modal",emits:["ok","enable"],setup(re,{expose:ie,emit:$}){const G=c(!1),m=c("重新分段"),_=$;let d={};const D=Le({data_ids:0,file_id:0}),z={0:"未转换",1:"已转换",2:"转换异常",3:"转换中",4:"分段失败",10:"分段中"},H=Le({status:"",errmsg:"",status_text:""}),q=()=>{_("enable")},k=c(!1),K=i=>{k.value=i},S=i=>{G.value=!0,D.data_ids=i.id,D.file_id=i.file_id,H.list=[{content:i.content,number:i.number,title:i.title,word_total:i.word_total,question:i.question,answer:i.answer,images:i.images}],H.status=i.status,H.errmsg=i.errmsg,H.status_text=z[i.status]},M=c(!1),X=c(null),w=()=>{M.value=!0,X.value.handleSaveLibFileSplit()},y=()=>{he.success("保存成功"),G.value=!1,_("ok",d.type)},p=()=>{M.value=!1};return ie({show:S}),(i,C)=>{const W=be;return s(),g("div",null,[t(W,{open:G.value,"onUpdate:open":C[0]||(C[0]=pe=>G.value=pe),onCancel:q,title:m.value,maskClosable:!1,"ok-text":k.value?"文档解析中,请稍候...":"确定",confirmLoading:M.value||k.value,onOk:w,width:1084},{default:l(()=>[n("div",dl,[G.value?(s(),j(Gt,{key:0,onOk:y,onFinish:p,onLoading:K,paragraphType:"paragraphsSegmented",pdfState:D,currentData:H,ref_key:"documentSegmentationModalRef",ref:X},null,8,["pdfState","currentData"])):U("",!0)])]),_:1},8,["open","title","ok-text","confirmLoading"])])}}},pl=$e(_l,[["__scopeId","data-v-e8467ea0"]]),fl={class:"library-preview-page"},ml={class:"breadcrumb-block"},vl={class:"library-line1"},gl={class:"selct-star-box"},hl={class:"document-title-block",style:{height:"22px"}},kl={class:"title"},yl={class:"search-content-block"},bl={class:"preview-box"},Sl={key:0,class:"page-loading-box"},wl={class:"content-block"},xl={class:"content-block"},Cl={key:1,class:"pdf-view-box"},$l={key:0,class:"pdf-mode-switch"},Ll={key:0},ql={key:1,class:"segmentation-btn"},Ol={class:"view-content-box",style:{"padding-top":"60px"}},El=["onClick"],Ml={key:0,class:"content-box"},Rl={key:1,class:"content-box"},Tl=["innerHTML"],Il={class:"fragment-img"},Pl=["src"],Fl={class:"right-contnt-box"},Dl={key:0,class:"right-tabs-box"},zl={class:"content-block"},Hl="你是一位文章分段助手，根据文章内容的语义进行合理分段，确保每个分段表述一个完整的语义，每个分段字数控制在500字左右，最大不超过1000字。请严格按照文章内容进行分段，不要对文章内容进行加工，分段完成后输出分段后的内容。",Nl={__name:"library-preview",setup(re){const ie=Pt(),$=ke(()=>{var e;return((e=ie.companyInfo)==null?void 0:e.neo4j_status)=="true"}),G=c(!1),m=c(null),_=c(0),d=c(0),D={0:"待生成",4:"生成中",2:"生成成功",3:"生成失败"},z=c([]),H=e=>{z.value=e},q=c({fade:!1,scrollbarTrackClickable:!0,interactive:!0,minSize:40}),k=Ue(),K=zt(),S=En(),M=ke(()=>p.value.is_table_file=="1"),X=ke(()=>p.value.doc_type),w=ke(()=>{let e=p.value.status;return!(e=="1"||e=="2")||x.value.length==0}),y=ke(()=>p.value.is_qa_doc=="1"),p=c({}),i=Le({status:-1,graph_status:-1,category_id:-1,search:""}),C=c(1),W=ke(()=>"/manage/getLibRawFile?id="+k.query.id+"&token="+S.getToken),pe=()=>{K.back()},h=c(null),ce=c(null);let ae=-1;const fe=(e,a=1)=>{let v,L;a==1?(v=".subsection-box .list-item",L=ce.value):(v=".view-content-box .list-item",L=h.value);const A=document.querySelectorAll(v)[e];A.classList.add("flash-border"),ae>=0&&document.querySelectorAll(v)[ae].classList.remove("flash-border"),setTimeout(()=>{ae=-1,A.classList.remove("flash-border")},2500),ae=e,L.scrollToElement({el:A,time:1e3})},B=c(!0),O=c(0),Q=c({page:1,size:1e3}),Y=c({}),x=c([]),ge=c(0),Re={0:"未转换",1:"已转换",2:"转换异常",3:"转换中..."},Ce=Le({split_status_exception:0,total:0,vector_status_converted:0,vector_status_converting:0,vector_status_exception:0,vector_status_initial:0}),Fe=Le([{value:-1,label:"全部",num:ke(()=>Ce.total)},{value:4,label:"分段失败",num:ke(()=>Ce.split_status_exception)},{value:0,label:"未转换",num:ke(()=>Ce.vector_status_initial)},{value:3,label:"转换中",num:ke(()=>Ce.vector_status_converting)},{value:2,label:"转换异常",num:ke(()=>Ce.vector_status_exception)},{value:1,label:"已转换",num:ke(()=>Ce.vector_status_converted)}]),Te=c(1);let u={id:k.query.id,separators_no:"",chunk_size:512,not_merged_text:!1,chunk_overlap:50,is_qa_doc:0,question_lable:"",similar_label:"",answer_lable:"",enable_extract_image:!0,ai_chunk_size:5e3,ai_chunk_model:"",ai_chunk_model_config_id:"",ai_chunk_prumpt:Hl,ai_chunk_task_id:""};const r=c(!1);let T=!0;(async()=>{It({id:k.query.id}).then(e=>{O.value=e.data.library_type,p.value={...e.data,graph_switch:e.data.graph_switch=="1"&&$.value};let a=e.data.status;a==1||a==2?le():B.value=!1,u={...u,separators_no:e.data.separators_no||"11,12",chunk_size:+e.data.chunk_size||512,not_merged_text:e.data.not_merged_text,ai_chunk_size:+e.data.ai_chunk_size||5e3,chunk_overlap:+e.data.chunk_overlap||50,is_qa_doc:O.value==2?1:0,question_lable:e.data.question_lable,similar_label:e.data.similar_label,answer_lable:e.data.answer_lable,question_column:e.data.question_column,similar_column:e.data.similar_column,answer_column:e.data.answer_column,enable_extract_image:e.data.enable_extract_image=="true",qa_index_type:+e.data.qa_index_type,chunk_type:+e.data.chunk_type,semantic_chunk_size:+e.data.semantic_chunk_size||512,semantic_chunk_overlap:+e.data.semantic_chunk_overlap||50,semantic_chunk_threshold:+e.data.semantic_chunk_threshold||90,semantic_chunk_use_model:e.data.semantic_chunk_use_model||"",ai_chunk_prumpt:e.data.ai_chunk_prumpt||"",ai_chunk_model:e.data.ai_chunk_model||"",semantic_chunk_model_config_id:e.data.semantic_chunk_model_config_id>0?e.data.semantic_chunk_model_config_id:"",ai_chunk_model_config_id:e.data.ai_chunk_model_config_id>0?e.data.ai_chunk_model_config_id:"",ai_chunk_task_id:e.data.ai_chunk_task_id||""},e.data.chunk_type==0&&(u={...u,separators_no:e.data.normal_chunk_default_separators_no,chunk_size:+e.data.normal_chunk_default_chunk_size,not_merged_text:data.normal_chunk_default_not_merged_text,chunk_overlap:+e.data.normal_chunk_default_chunk_overlap,chunk_type:+e.data.default_chunk_type,semantic_chunk_size:+e.data.semantic_chunk_default_chunk_size,semantic_chunk_overlap:+e.data.semantic_chunk_default_chunk_overlap,semantic_chunk_threshold:+e.data.semantic_chunk_default_threshold,semantic_chunk_use_model:e.data.default_use_model||"",semantic_chunk_model_config_id:e.data.default_model_config_id>0?e.data.default_model_config_id:""}),(a==4||a==2)&&(Te.value=parseInt(e.data.is_table_file))})})();const ue=()=>{Mn({file_id:k.query.id,search:i.search}).then(e=>{Object.assign(Ce,e.data)})},V=()=>{window.location.reload()},I=()=>{Q.value.page=1,ge.value=0,x.value=[],le(),ue()},oe=e=>{i.category_id=e,I()},f=(e=null)=>{Q.value.page++,le(e)},le=(e=null)=>{T=!0,Ct({file_id:k.query.id,...Q.value,...i}).then(a=>{var b,F;B.value=!1,T=!1;let v=a.data,L=v.list||[],A=((b=v.info)==null?void 0:b.is_qa_doc)=="1"&&((F=v.info)==null?void 0:F.is_table_file)=="1";L.forEach(we=>{we.status_text=Re[we.status],we.graph_status_text=D[we.graph_status],we.isExcelQa=A,we.similar_questions&&(we.similar_questions=JSON.parse(we.similar_questions))}),Y.value=v.info,Q.value.page==1&&(x.value=[]),x.value=[...x.value,...L],ge.value=v.total,typeof e=="function"&&e()})},N=()=>{T||x.value.length>=ge.value||(f(),m.value&&m.value.loadMore())},Se=()=>{o()};let qe=null;function De(){clearInterval(qe),x.value.filter(a=>a.status==3).length?qe=setInterval(()=>{o()},5e3):clearInterval(qe)}const o=()=>{Ct({file_id:k.query.id,page:1,size:x.value.length,...i}).then(e=>{var A,b;let a=e.data,v=a.list||[],L=((A=a.info)==null?void 0:A.is_qa_doc)=="1"&&((b=a.info)==null?void 0:b.is_table_file)=="1";v.forEach(F=>{F.status_text=Re[F.status],F.graph_status_text=D[F.graph_status],F.isExcelQa=L,F.similar_questions&&(F.similar_questions=JSON.parse(F.similar_questions))}),x.value=v,De()})},R=e=>{if(!e.id){Q.value.page=1,le();return}let a=x.value,v=a.findIndex(L=>L.id==e.id);if(v>-1){let L=a[v];L.title=e.title,L.content=e.content,L.question=e.question,L.answer=e.answer,L.images=e.images,L.category_id=e.category_id,L.word_total=e.question.length+e.answer.length+e.content.length,L.similar_questions=e.similar_questions.length?JSON.parse(e.similar_questions):[],a.splice(v,1,L),x.value=a}},ee=e=>{let a=x.value,v=a.findIndex(L=>L.id==e);v>-1&&(a.splice(v,1),x.value=a,ge.value=ge.value--)},de=c(null),me=e=>{de.value.showModal(JSON.parse(JSON.stringify(e)))},Me=c(null),Vt=()=>{Rn({id:k.query.id}).then(()=>he.success("操作完成"))},Wt=()=>{Tn({id:k.query.id}).then(()=>he.success("操作完成"))},ct=c(null),Zt=()=>{ct.value.show(p.value)},ut=()=>{K.push("/library/document-segmentation?document_id="+k.query.id+"&source=preview")},Kt=()=>{Me.value.open({id:k.query.id,doc_auto_renew_frequency:p.value.doc_auto_renew_frequency})},Xt=e=>{p.value.doc_auto_renew_frequency=e},Yt=e=>{p.value.file_name=e},en=e=>{const a=()=>{for(let v in x.value)if(x.value[v].page_num==e){fe(v);return}};if(e>x.value[x.value.length-1].page_num){he.warning("分段数据正在加载，请稍后...");const v=()=>{e<=x.value[x.value.length-1].page_num?(he.success("加载完成"),Ge(()=>{a()})):f(v)};f(v)}else a()},tn=(e,a)=>{d.value=a,_.value=e,x.value[x.value.length-1].page_num<e&&f()},dt=e=>{var a;if(((a=p.value)==null?void 0:a.file_ext)=="pdf"&&C.value==1){const v=e.page_num-1,L=()=>document.querySelectorAll(".pdf-render-box > .scroll-content .vue-pdf-embed")[v],A=()=>{const F=L();F.classList.add("flash-border"),setTimeout(()=>F.classList.remove("flash-border"),2500),m.value.getScrollInstance().scrollToElement({el:F,time:1e3})};if(L())A();else{he.warning("PDF正在加载，请稍后...");const F=()=>{L()?(he.success("加载完成"),A()):m.value&&m.value.loadMore()};m.value&&m.value.loadMore(F)}}else fe(e.index,2)},Xe=c(1);let Ye=null;const je=c(0),nn=e=>{je.value=e},an=({y:e})=>{if(!Ye){const v=document.querySelectorAll(".pdf-render-box > .scroll-content .vue-pdf-embed")[0];Ye=v&&v.clientHeight}let a=Math.floor(Math.abs(e)/Ye)+1;Xe.value=Math.max(a,1)},et=c(null),tt=c(null),on=e=>{let{key:a}=e;m.value&&m.value.getScrollInstance().disable(),a==1&&et.value.show({type:a,pdf_page_num:Xe.value}),a==2&&ut(),a==3&&et.value.show({type:a,pdf_page_num:0})},_t=e=>{tt.value&&tt.value.show(e)},pt=()=>{m.value&&m.value.getScrollInstance().enable()},ln=()=>{pt(),I()},ft=()=>{G.value=!G.value},nt=(e,a)=>{let v=JSON.parse(JSON.stringify(e));return v.content=a,v.word_total=a.length,v},Ie=c(!1),Pe=c(1),mt=({index:e,beforeContent:a,selectedContent:v,afterContent:L,isFullSelection:A})=>{const b=[...x.value];Ie.value=A,Pe.value=1,A?(b.splice(e+1,0,nt(b[e],v)),b.splice(e,1)):(b[e].content=a||"",b[e].word_total=a.length||0,L.trim()&&b.splice(e+1,0,nt(b[e],L)),b.splice(e+1,0,nt(b[e],v)),b[e+1].images=[],b.splice(e,1)),x.value=b,He(b,e)},vt=({index:e,beforeContent:a,selectedContent:v,afterContent:L,isFullSelection:A})=>{const b=[...x.value];Ie.value=A,Pe.value=2;let F=b[e+1].word_total;A?(b[e+1].content=+v,b[e+1].word_total=parseInt(F)+v.length,b.splice(e,1),x.value=b,He(b,e)):(b[e].content=a||"",b[e].word_total=a.length||0,b[e+1].content+=v,b[e+1].word_total=parseInt(F)+v.length,L.trim()&&(b[e].content+=L||"",b[e].word_total+=L.length||0),x.value=b,He(b,e+1))},gt=({index:e,beforeContent:a,selectedContent:v,afterContent:L,isFullSelection:A})=>{const b=[...x.value];Ie.value=A,Pe.value=3;let F=b[e-1].word_total;A?(b[e-1].content+=v,b[e-1].word_total=parseInt(F)+v.length,b.splice(e,1),x.value=b,He(b,e)):(b[e].content=a||"",b[e].word_total=a.length||0,b[e-1].content+=v,b[e-1].word_total=parseInt(F)+v.length,L.trim()&&(b[e].content+=L||"",b[e].word_total+=L.length||0),x.value=b,He(b,e-1))},ht=({index:e,beforeContent:a,afterContent:v,isFullSelection:L})=>{const A=[...x.value];Ie.value=L,Pe.value=4,L?A.splice(e,1):(A[e].content=a||"",A[e].word_total=a.length||0,v.trim()&&(A[e].content+=v||"",A[e].word_total+=v.length||0)),x.value=A,He(A,e)};function sn(e,a,v={},L){let A=L+1;if(!Array.isArray(e)||!Array.isArray(a))return JSON.stringify([]);const b=e.map((F,we)=>{const J={};for(const te of a){const Oe=v[te]||te,_e=F[Oe];if(Object.prototype.hasOwnProperty.call(F,Oe))if(te==="number")J[te]=we+1;else if(te==="page_num"||te==="word_total")J[te]=+_e;else if(te==="content"){if(!_e)return null;J[te]=_e}else te==="images"?Pe.value==1?Ie.value?(A==J.number,J[te]=_e):A+1==J.number?J[te]=[]:J[te]=_e:Pe.value==2?(Ie.value,A==J.number,J[te]=_e):Pe.value==3?Ie.value?(A-1==J.number,J[te]=_e):(A==J.number,J[te]=_e):Pe.value==4&&(Ie.value,J[te]=_e):J[te]=_e}return J}).filter(F=>F!==null&&F.content!==void 0&&F.content!=="");return JSON.stringify(b)}const rn={similar_question_list:"similar_questions"},He=async(e,a)=>{let v={...u,semantic_chunk_model_config_id:u.semantic_chunk_model_config_id?+u.semantic_chunk_model_config_id:0,ai_chunk_model_config_id:u.ai_chunk_model_config_id?+u.ai_chunk_model_config_id:0,is_table_file:Te.value};delete v.id;let L={id:k.query.id,word_total:ge.value,split_params:JSON.stringify(v),list:sn(e,["number","page_num","title","content","question","similar_question_list","answer","word_total","images"],rn,a)};v.is_qa_doc==1&&(L.qa_index_type=v.qa_index_type),r.value=!0,In(L).then(A=>{he.success("操作成功");const b=A.data;for(let F=0;F<b.length;F++){const we=b[F],J=x.value[F];if(F<x.value.length)J.id=we.toString(),J.status="0",J.status_text=Re[J.status];else break}}).finally(()=>{r.value=!1})};return Be(()=>{ue(),k.query.graph_status&&(i.graph_status=k.query.graph_status,I())}),(e,a)=>{var bt,St,wt;const v=Pn("router-link"),L=aa,A=na,b=Ze,F=Ot,we=ra,J=Jt,te=jt,Oe=it,_e=st,kt=rt,cn=la,un=Qe,Je=Ke,yt=ua,dn=ca,_n=ia,pn=sa,fn=ot("viewer");return s(),g("div",fl,[n("div",ml,[t(A,null,{default:l(()=>[t(L,null,{default:l(()=>[t(v,{to:"/library/list"},{default:l(()=>a[8]||(a[8]=[E(" 知识库管理 ")])),_:1,__:[8]})]),_:1}),t(L,null,{default:l(()=>[t(v,{to:{path:"/library/details/knowledge-document",query:{id:p.value.library_id}}},{default:l(()=>[n("div",vl,se(p.value.library_name)+"知识库",1)]),_:1},8,["to"])]),_:1}),t(L,null,{default:l(()=>a[9]||(a[9]=[E("知识库详情")])),_:1,__:[9]})]),_:1}),n("div",gl,[t(Dn,{startLists:z.value,onChange:oe},null,8,["startLists"])])]),n("div",hl,[t(ne(oa),{onClick:pe}),n("span",kl,se(p.value.file_name),1),t(ho,{detailsInfo:p.value},null,8,["detailsInfo"])]),n("div",yl,[n("div",bl,[G.value?(s(),j(F,{key:1,onClick:a[1]||(a[1]=Z=>ft())},{default:l(()=>[t(b,{class:"preview-box-icon",name:"expand"}),a[11]||(a[11]=E(" 展开预览"))]),_:1,__:[11]})):(s(),j(F,{key:0,onClick:a[0]||(a[0]=Z=>ft())},{default:l(()=>[t(b,{class:"preview-box-icon",name:"put-away"}),a[10]||(a[10]=E(" 收起预览"))]),_:1,__:[10]}))]),t(cn,null,{default:l(()=>[t(we,{value:i.search,"onUpdate:value":a[2]||(a[2]=Z=>i.search=Z),placeholder:"搜索内容",style:{width:"200px"},allowClear:"",onChange:I},null,8,["value"]),y.value?(s(),j(te,{key:0,value:i.status,"onUpdate:value":a[3]||(a[3]=Z=>i.status=Z),placeholder:"请选择",style:{width:"160px"},onChange:I},{default:l(()=>[t(J,{value:-1},{default:l(()=>a[12]||(a[12]=[E("全部嵌入状态")])),_:1,__:[12]}),(s(),g(ve,null,xe(Re,(Z,Ne)=>t(J,{key:Z,value:Ne},{default:l(()=>[E(se(Z),1)]),_:2},1032,["value"])),64))]),_:1},8,["value"])):U("",!0),p.value.graph_switch?(s(),j(te,{key:1,value:i.graph_status,"onUpdate:value":a[4]||(a[4]=Z=>i.graph_status=Z),placeholder:"请选择",onChange:I,style:{width:"160px"}},{default:l(()=>[t(J,{value:-1},{default:l(()=>a[13]||(a[13]=[E("全部知识图谱状态")])),_:1,__:[13]}),(s(),g(ve,null,xe(D,(Z,Ne)=>t(J,{key:Z,value:Ne},{default:l(()=>[E(se(Z),1)]),_:2},1032,["value"])),64))]),_:1},8,["value"])):U("",!0),t(kt,null,{overlay:l(()=>[t(_e,null,{default:l(()=>[t(Oe,{onClick:Vt},{default:l(()=>a[14]||(a[14]=[E("重新嵌入向量")])),_:1,__:[14]}),p.value.graph_switch?(s(),j(Oe,{key:0,onClick:Wt},{default:l(()=>a[15]||(a[15]=[E("重新抽取知识图谱")])),_:1,__:[15]})):U("",!0),t(Oe,{onClick:Zt},{default:l(()=>a[16]||(a[16]=[E("重命名")])),_:1,__:[16]}),X.value==2?(s(),j(Oe,{key:1,onClick:Kt},{default:l(()=>a[17]||(a[17]=[E("设置更新频率")])),_:1,__:[17]})):U("",!0)]),_:1})]),default:l(()=>[t(F,null,{default:l(()=>[a[18]||(a[18]=E("其他操作 ")),t(ne(Lt))]),_:1,__:[18]})]),_:1}),X.value!=3?(s(),j(F,{key:2,onClick:ut},{default:l(()=>a[19]||(a[19]=[E("重新分段")])),_:1,__:[19]})):U("",!0),t(F,{onClick:a[5]||(a[5]=Z=>me({})),type:"primary"},{icon:l(()=>[t(ne(Ht))]),default:l(()=>[a[20]||(a[20]=n("span",null,"添加分段",-1))]),_:1,__:[20]})]),_:1})]),B.value?(s(),g("div",Sl,[t(un)])):(s(),g(ve,{key:1},[y.value?(s(),g(ve,{key:0},[w.value?(s(),j(at,{key:0,onOpenEditSubscription:me})):(s(),j(Ae,{key:1,scrollbar:{minSize:0},onOnScrollEnd:N},{default:l(()=>[n("div",wl,[t(ul,{ref:"subsectionBoxRef",total:ge.value,paragraphLists:x.value,search:i.search,detailsInfo:p.value,onOpenEditSubscription:me,onHandleDelParagraph:ee,onHandleConvert:Se,onGetStatrList:H},null,8,["total","paragraphLists","search","detailsInfo"])])]),_:1}))],64)):(s(),g(ve,{key:1},[M.value||X.value==3?(s(),g(ve,{key:0},[w.value?(s(),j(at,{key:0,onOpenEditSubscription:me})):(s(),j(Ae,{key:1,scrollbar:{minSize:0},onOnScrollEnd:N,disableMouse:!0},{default:l(()=>[n("div",xl,[t(qt,{ref:"subsectionBoxRef",total:ge.value,detailsInfo:p.value,paragraphLists:x.value,search:i.search,onOpenEditSubscription:me,onHandleDelParagraph:ee,onHandleConvert:Se,onHandleScrollTargetPage:dt,onGetStatrList:H,onHandleSplit:mt,onHandleSplitNext:vt,onHandleSplitUp:gt,onHandleSplitDelete:ht,onHandleSegmentation:_t},null,8,["total","detailsInfo","paragraphLists","search"])])]),_:1}))],64)):(s(),g("div",Cl,[n("div",{class:Dt(["view-content-wrap",{collapsed:G.value}])},[((bt=p.value)==null?void 0:bt.file_ext)=="pdf"?(s(),g("div",$l,[t(dn,{value:C.value,"onUpdate:value":a[6]||(a[6]=Z=>C.value=Z)},{default:l(()=>[t(yt,{value:1},{default:l(()=>[t(Je,{placement:"right",title:"原文预览模式下，会展示pdf原始文件内容，手动编辑分段的不会展示。您可以通过原文预览模式，校验分段准确性，然后手动编辑分段。"},{default:l(()=>[a[21]||(a[21]=E(" 原文预览 ")),C.value==1&&je.value>0?(s(),g("span",Ll,"("+se(Xe.value)+" / "+se(je.value)+")",1)):U("",!0)]),_:1,__:[21]})]),_:1}),t(yt,{value:2},{default:l(()=>a[22]||(a[22]=[E("纯文本预览")])),_:1,__:[22]})]),_:1},8,["value"])])):U("",!0),((St=p.value)==null?void 0:St.file_ext)=="pdf"?(s(),g("div",ql,[t(kt,null,{overlay:l(()=>[t(_e,{onClick:on},{default:l(()=>[C.value==1&&je.value>0?(s(),j(Oe,{key:1},{default:l(()=>[t(Je,{placement:"right",title:"将当前页重新解析并分段"},{default:l(()=>a[23]||(a[23]=[n("div",null,"将当页重新分段",-1)])),_:1,__:[23]})]),_:1})):U("",!0),(s(),j(Oe,{key:2},{default:l(()=>[t(Je,{placement:"right",title:"将整个文档重新分段，注意，重新分段并不会重新提取文档的内容，只是将内容重新分段。"},{default:l(()=>a[24]||(a[24]=[n("div",null,"将文档重新分段",-1)])),_:1,__:[24]})]),_:1})),(s(),j(Oe,{key:3},{default:l(()=>[t(Je,{placement:"right",title:"将整个文档重新学习，包含重新解析并提取文档内容，重新分段。"},{default:l(()=>a[25]||(a[25]=[n("div",null,"重新学习文档",-1)])),_:1,__:[25]})]),_:1}))]),_:1})]),default:l(()=>[t(F,null,{default:l(()=>[a[26]||(a[26]=E(" 重新分段 ")),t(ne(Lt))]),_:1,__:[26]})]),_:1})])):U("",!0),((wt=p.value)==null?void 0:wt.file_ext)=="pdf"&&C.value==1?(s(),j(So,{key:2,ref_key:"pdfRef",ref:m,class:"scroll-box pdf-render-box",source:W.value,onSelect:en,onScroll:an,onRendered:tn,onGetTotalPage:nn},null,8,["source"])):(s(),j(Ae,{key:3,scrollbar:q.value,ref_key:"leftScrollRef",ref:h,class:"scroll-box",onOnScrollEnd:N},{default:l(()=>[n("div",Ol,[(s(!0),g(ve,null,xe(x.value,(Z,Ne)=>(s(),g("div",{class:"list-item",onClick:xt=>fe(Ne),key:Ne},[Z.question?(s(),g("div",Ml,se(Z.question),1)):U("",!0),Z.answer?(s(),g("div",Rl,se(Z.answer),1)):U("",!0),n("div",{class:"content-box",innerHTML:Z.content},null,8,Tl),lt((s(),g("div",Il,[(s(!0),g(ve,null,xe(Z.images,(xt,mn)=>(s(),g("img",{key:mn,src:xt,alt:""},null,8,Pl))),128))])),[[fn]])],8,El))),128))])]),_:1},8,["scrollbar"]))],2),n("div",Fl,[y.value?U("",!0):(s(),g("div",Dl,[t(pn,{activeKey:i.status,"onUpdate:activeKey":a[7]||(a[7]=Z=>i.status=Z),style:{"background-color":"#f2f4f7",padding:"0px 16px","border-radius":"6px"},onChange:I},{default:l(()=>[(s(!0),g(ve,null,xe(Fe,Z=>(s(),j(_n,{key:Z.value,tab:`${Z.label} (${Z.num})`},null,8,["tab"]))),128))]),_:1},8,["activeKey"])])),w.value?(s(),j(at,{key:1,onOpenEditSubscription:me})):(s(),j(Ae,{key:2,scrollbar:q.value,disableMouse:!0,ref_key:"rightScrollRef",ref:ce,onOnScrollEnd:N},{default:l(()=>[n("div",zl,[t(qt,{ref:"subsectionBoxRef",total:ge.value,detailsInfo:p.value,paragraphLists:x.value,search:i.search,onOpenEditSubscription:me,onHandleDelParagraph:ee,onHandleConvert:Se,onHandleScrollTargetPage:dt,onGetStatrList:H,onHandleSplit:mt,onHandleSplitNext:vt,onHandleSplitUp:gt,onHandleSplitDelete:ht,onHandleSegmentation:_t},null,8,["total","detailsInfo","paragraphLists","search"])])]),_:1},8,["scrollbar"]))])]))],64))],64)),t(jn,{detailsInfo:p.value,onHandleEdit:R,ref_key:"editSubscriptionRef",ref:de},null,8,["detailsInfo"]),t(ko,{onOk:Xt,ref_key:"updateFrequencyRef",ref:Me},null,512),t(Vn,{onOk:Yt,ref_key:"renameModalRef",ref:ct},null,512),t(Ao,{onOk:ln,onEnable:pt,detailsInfo:p.value,ref_key:"reSegmentationPageRef",ref:et},null,8,["detailsInfo"]),t(pl,{ref_key:"segmentationSettingModalRef",ref:tt,onOk:V},null,512)])}}},Si=$e(Nl,[["__scopeId","data-v-1ce33a11"]]);export{Si as default};
