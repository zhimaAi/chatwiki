import{_ as Le,d as Ke,bF as kn,b0 as Rt,aB as Mt,a$ as Tt,aC as Pt,aO as yn,aD as bn,bv as zt,bK as Sn,bw as wn,bx as xn,bz as Cn,bL as $n,a as Ft,bM as Ln,c as qn,bN as On,aH as qt,bO as En,bP as In,by as Rn}from"../../index-DxV-PNCd.js";import{ac as m,ad as r,as as a,k as t,ar as i,u as Y,f as c,r as qe,o as Ue,az as U,at as ae,F as fe,ax as $e,y as Ve,aw as Je,e as he,b as Dt,q as lt,G as C,ah as De,B as ye,ai as st,n as it,ae as j,av as Nt,aA as Mn}from"./vue-chunks-CGLjTDrY.js";import{_ as Tn}from"./empty-CzGZrENG.js";import{a6 as Ht,B as At,ay as Pn,al as je,M as be,a5 as zn,W as Ie,v as Xe,a9 as Fn,bz as We,bA as Bt,h as rt,i as ut,am as Ut,k as ct,az as Jt,ab as jt,b as ge,F as Dn,e as Nn,y as Gt,z as Qt,E as Hn,bE as An,ai as Bn,aR as Un,G as Jn,m as jn,aB as Gn,bH as Qn,w as Vn,a3 as Wn,n as Zn,I as Kn,D as Ot,Z as Xn,a4 as Yn}from"./ui-antd-AfNpv4wx.js";import{C as Vt,S as ea}from"./classification-mark-modal-BRsOMxMA.js";import{h as ta,Z as na,P as aa,H as oa,C as la}from"./neo4j-L2Hgpmga.js";import{Z as sa,C as ia}from"./cu-scroll-BZ6G9aE7.js";import{c as Ze,E as ra}from"./edit-subsection-Mq4FwIa-.js";import{_ as Be}from"./cu-scroll-qHaWhCWu.js";import{R as ua,_ as ca}from"./rename-modal-Bn4xWw78.js";import{V as Et}from"./vue3-pdf-embed-BvuBfFnt.js";import{S as da,a as _a,D as pa,E as fa}from"./edit-fragment-alert-BUG2507K.js";import"./utils-COBjqVvs.js";import"./other-BrZCAsTs.js";import"./pull-up.esm-DIiTC7VE.js";import"./observe-dom.esm-B25JyVKH.js";import"./index-BHRZn_CM.js";import"./index-DwtbXc27.js";import"./util-BwuffJOK.js";import"./model-select-CjmsccZQ.js";import"./index-w0T-47HX.js";import"./editor-code-BLYX-bNv.js";import"./vue-pdf-embed-CiRf6fZ3.js";const ma={class:"empty-box"},va={__name:"empty",props:{detailsInfo:{type:Object}},emits:["openEditSubscription"],setup(ue,{emit:se}){const $=se,K=()=>{$("openEditSubscription",{})};return(y,u)=>{const _=At;return r(),m("div",ma,[u[1]||(u[1]=a("img",{src:Tn,alt:""},null,-1)),u[2]||(u[2]=a("div",{class:"title"},"知识库文档为空，请添加分段",-1)),a("div",null,[t(_,{type:"primary",onClick:K},{icon:i(()=>[t(Y(Ht))]),default:i(()=>[u[0]||(u[0]=a("span",null,"添加分段",-1))]),_:1})])])}}},ot=Le(va,[["__scopeId","data-v-16e77398"]]),ga={class:"chart-wrapper"},ha={class:"zoom-toolbar-wrapper"},ka={__name:"chart-box",emits:["nodeClick"],setup(ue,{expose:se,emit:$}){const K=$,y=c(null);let u=null;const _=qe({nodes:[],edges:[]}),D=c(1),P={},N=()=>{u&&u.destroy();const b={layout:"forceDirected",initialZoom:D.value,disableTelemetry:!0,maxZoom:10,minZoom:.1,minimapContainer:document.getElementById("chatMap"),styling:{minimapViewportBoxColor:"#4399FF",selectedBorderColor:"rgba(255, 255, 255, 1)"}},g=document.getElementById("chartBox");u=new ta(g,_.nodes,_.edges,b,P);const S=new na(u);new aa(u),S.updateCallback("onZoom",w=>{D.value=Number(w.toFixed(1))}),new oa(u,{drawShadowOnHover:!0}),new la(u,{selectOnClick:!0}).updateCallback("onNodeClick",w=>{K("nodeClick",w)})},L=b=>{D.value=b,u&&u.setZoom(b)},q=({nodes:b,edges:g})=>{_.nodes=[_.nodes,...b],_.edges=[_.edges,...g],u&&u.addElementsToGraph(b,g)},H=({nodes:b,edges:g})=>{_.nodes=[_.nodes,...b],_.edges=[_.edges,...g],u&&u.addAndUpdateElementsInGraph(b,g)},h=({nodes:b,edges:g})=>{_.nodes=b,_.edges=g,u&&u.updateElementsInGraph(b,g)},R=()=>{u&&u.destroy()},oe=({nodes:b,edges:g})=>{_.nodes=b,_.edges=g,N()};return Ue(()=>{}),se({render:oe,add:q,addAndUpdate:H,update:h,destroy:R}),(b,g)=>(r(),m("div",ga,[a("div",{class:"chart",id:"chartBox",ref_key:"chartBox",ref:y},null,512),g[0]||(g[0]=a("div",{class:"chart-mini-map",id:"chatMap"},null,-1)),a("div",ha,[t(sa,{value:D.value,onChange:L},null,8,["value"])])]))}},ya=Le(ka,[["__scopeId","data-v-04d10c54"]]),ba={key:0,class:"popup-wrapper entity-details-wrapper"},Sa={class:"popup-header"},wa={key:0,class:"popup-body"},xa={class:"popup-content"},Ca={class:"entity-details"},$a={class:"entity-item"},La={class:"entity-name"},qa={class:"entity-item",style:{"margin-bottom":"8px"}},Oa={class:"file-info"},Ea={class:"file-name"},Ia={class:"entity-item"},Ra={class:"doc-item"},Ma={class:"fragment-content"},Ta={class:"entity-item"},Pa={key:0,class:""},za={class:"fragment-content"},Fa={__name:"entity-details",setup(ue,{expose:se}){const $=qe({show:!1,node:null,fromNodes:[]}),K=()=>{$.show=!1};return se({open:(u,_)=>{$.node=u,$.fromNodes=_,$.show?($.show=!1,Ve(()=>{$.show=!0})):$.show=!0},close:K}),(u,_)=>{const D=Ke;return $.show?(r(),m("div",ba,[a("div",Sa,[_[0]||(_[0]=a("div",{class:"popup-title"},"实体详情",-1)),t(Y(Pn),{class:"close-btn",onClick:K})]),$.node?(r(),m("div",wa,[t(ia,null,{default:i(()=>[a("div",xa,[a("div",Ca,[a("div",$a,[_[1]||(_[1]=a("div",{class:"entity-item-header"},[a("div",{class:"entity-item-label"},"实体")],-1)),a("div",La,ae($.node.name),1)]),a("div",qa,[_[2]||(_[2]=a("div",{class:"entity-item-header"},[a("div",{class:"entity-item-label"},"归属文档")],-1)),a("div",Oa,[t(D,{class:"file-icon",name:"doc-file",style:{}}),a("span",Ea,ae($.node.file_name),1)])]),a("div",Ia,[_[3]||(_[3]=a("div",{class:"entity-item-header"},[a("div",{class:"entity-item-label"},"分段")],-1)),a("div",null,[a("div",Ra,[a("div",Ma,ae($.node.content),1)])])]),a("div",Ta,[_[4]||(_[4]=a("div",{class:"entity-item-header"},[a("div",{class:"entity-item-label"},"子图")],-1)),a("div",null,[$.fromNodes.length==0?(r(),m("div",Pa,"无")):U("",!0),(r(!0),m(fe,null,$e($.fromNodes,P=>(r(),m("div",{class:"subgraph-item",key:P.id},[a("div",za,ae(P.name),1)]))),128))])])])])]),_:1})])):U("",!0)])):U("",!0)}}},Da=Le(Fa,[["__scopeId","data-v-a19c97a9"]]),Na={class:"graph-model-body"},Ha={key:0,class:"loading-wrapper"},Aa={class:"right-box"},Ba={__name:"index",setup(ue,{expose:se}){const $=c(!1),K=c(null),y=c(null),u=c(null),_=c(!1),D=qe({file_id:"",data_id:""}),P=qe({edges:[],nodes:[]});let N={};const L=()=>{q()},q=()=>{_.value=!0,kn({file_id:D.file_id,data_id:D.data_id,search_term:D.search_term}).then(b=>{_.value=!1;let g=b.data.edges||[],S=b.data.nodes||[];const s=new Map;g=g.filter(v=>{const _e=`${v.from_id}_${v.to_id}`,ie=`${v.to_id}_${v.from_id}`;return s.has(_e)||s.has(ie)?!1:(s.set(_e,!0),!0)}),g.forEach(v=>{v.id=v.id.toString(),v.from=v.from_id.toString(),v.to=v.to_id.toString(),v.caption=v.label});const w=new Set(g.map(v=>v.from)),M=new Set(g.map(v=>v.to));S.forEach(v=>{v.caption=v.name,v.id=v.id.toString(),v.nodeType=w.has(v.id)&&M.has(v.id)?"both":w.has(v.id)?"from":M.has(v.id)?"to":"normal",v.nodeType==="from"?(v.size=35,v.color="#FFB1B2"):v.nodeType==="to"?(v.size=45,v.color="#005AFF"):(v.size=30,v.color="#69E9BE")});let re={edges:g,nodes:S};P.edges=re.edges,P.nodes=re.nodes,setTimeout(()=>{y.value.render(re)},0),N={},g.forEach(v=>{N[v.to]||(N[v.to]=[]),N[v.to].push(v.from)})}).catch(b=>{_.value=!1})},H=b=>{let g=N[b.id]||[],S=[];for(let s=0;s<P.nodes.length;s++)g.indexOf(P.nodes[s].id)>-1&&S.push(P.nodes[s]);u.value.open(b,S)},h=()=>{y.value.destroy(),$.value=!1},R=()=>{$.value=!1};return se({open:b=>{D.file_id=b.file_id,D.data_id=b.id,$.value=!0,setTimeout(()=>{L()},350)}}),(b,g)=>{const S=je,s=be;return r(),m("div",{ref_key:"mymodal",ref:K},[t(s,{wrapClassName:"graph-model-wrapper",zIndex:99999,centered:"",open:$.value,"onUpdate:open":g[0]||(g[0]=w=>$.value=w),title:"知识图谱",width:"90vw",footer:null,onOk:R,onCancel:h},{default:i(()=>[a("div",Na,[_.value?(r(),m("div",Ha,[t(S)])):U("",!0),t(ya,{ref_key:"chartBoxRef",ref:y,loading:_.value,onNodeClick:H},null,8,["loading"]),a("div",Aa,[t(Da,{ref_key:"entityDetailsRef",ref:u},null,512)])])]),_:1},8,["open"])],512)}}},Ua=Le(Ba,[["__scopeId","data-v-2b594227"]]),Ja={class:"subsection-box-title"},ja=["onClick"],Ga={class:"top-block"},Qa={class:"title"},Va={class:"title-block"},Wa={class:"status-box"},Za={class:"cfb363f"},Ka={class:"split-err"},Xa={key:1},Ya={class:"cfb363f"},eo={class:"right-opration"},to={class:"hover-btn-box"},no=["onClick"],ao=["onClick"],oo=["onClick"],lo={class:"hover-btn-box"},so={class:"hover-btn-box"},io=["onClick"],ro=["onClick"],uo={key:0,class:"content-box"},co=["innerHTML"],_o={key:1,class:"content-box"},po=["innerHTML"],fo=["onMouseup","innerHTML"],mo={key:2,class:"fragment-img"},vo=["src"],go={__name:"subsection-box",props:{paragraphLists:{type:Array,default:()=>[]},search:{type:String,default:""},detailsInfo:{type:Object,default:()=>{}},total:{type:[Number,String],default:0}},emits:["handleDelParagraph","handleScrollTargetPage","openEditSubscription","handleConvert","getStatrList","handleSplit","handleSplitNext","handleSplitUp","handleSplitDelete","handleSegmentation"],setup(ue,{expose:se,emit:$}){const K=Je(),y=$,u=ue,_=(d,l)=>{let{id:G,title:I,content:me,question:Q,answer:J,images:Z,category_id:p}=d,le=d.similar_questions||[];be.confirm({title:"重新转换确认",icon:null,content:`确定要重新转换【分段${l+1}】吗?`,onOk(){return new Promise(F=>{Tt({id:G,title:I,content:me,question:Q,answer:J,images:Z,category_id:p,similar_questions:JSON.stringify(le)}).then(()=>{y("handleConvert",d),F()}).catch(()=>{F()})})},onCancel(){}})},D=d=>{y("openEditSubscription",d)},P=d=>{be.confirm({title:"提示",icon:t(Ie),content:"确认是否删除该分段?",onOk(){return new Promise(l=>{Pt({id:d}).then(()=>{ge.success("删除成功"),y("handleDelParagraph",d),l()}).catch(()=>{l()})})},onCancel(){}})},N=(d,l,G)=>{window.getSelection().toString().trim()||(y("handleScrollTargetPage",{page_num:d.page_num,index:l}),Se(G))},L=d=>{y("handleSegmentation",d)},q=c([]),H=()=>{let d={file_id:K.query.id};Rt(d).then(l=>{q.value=l.data||[],y("getStatrList",l.data||[])})};H();const h=c(null),R=()=>{h.value.show()},oe=d=>{var G;let l=(G=q.value.filter(I=>I.id==d.category_id)[0])==null?void 0:G.type;return l?Ze[l]:""},b=(d,l={})=>{Mt({id:d.id,category_id:l.id||0}).then(()=>{ge.success("设置成功"),d.category_id=l.id,H()})},g=c(null),S=d=>{g.value.open(d)},s=c(null),w=c(!1),M=c({x:0,y:0}),re=c(""),v=c(null),_e=c({text:"",parentIndex:-1,originalHtml:""}),ie=he(()=>{if(!w.value)return{};const d=162;let l=M.value.x,G=M.value.y;const I=s.value.getBoundingClientRect(),me=window.innerWidth;l<10?l=10:l+d>me-50&&(l=me-d-50);const Q=l-I.left,J=G;return{left:`${Q}px`,top:`${J}px`}}),ve=(d,l)=>{setTimeout(()=>{const G=window.getSelection(),I=G.toString().trim();if(I){d.stopPropagation(),_e.value={text:I,parentIndex:l,originalHtml:u.paragraphLists[l].content},re.value=I,v.value=G.getRangeAt(0).cloneRange();const Q=G.getRangeAt(0).getBoundingClientRect(),J=s.value.getBoundingClientRect();M.value={x:Q.left+Q.width/2,y:Q.top-J.top-50},w.value=!0}else w.value=!1},50)},A=d=>{const{parentIndex:l}=_e.value;switch(d){case"separate":ee(l);break;case"merge-next":ce(l);break;case"merge-prev":Oe(l);break;case"delete":z(l);break}w.value=!1,window.getSelection().removeAllRanges()},E=(d,l,G)=>{if(l===0&&G===d.textContent.length&&d.textContent.trim().length>0)return["",d.innerHTML,""];const me=document.createTreeWalker(d,NodeFilter.SHOW_TEXT);let Q,J=0,Z,p,le,F;for(;Q=me.nextNode();){const x=Q.nodeValue.length;if(!Z&&J+x>=l&&(Z=Q,le=l-J),!p&&J+x>=G){p=Q,F=G-J;break}J+=x}const xe=document.createRange();xe.setStart(Z,le),xe.setEnd(p,F);const Me=document.createRange();Me.setStart(d,0),Me.setEnd(Z,le);const n=document.createRange();return n.setStart(p,F),n.setEnd(d,d.childNodes.length),[W(Me),W(xe),W(n)]},W=d=>{const l=document.createElement("div");return l.appendChild(d.cloneContents()),l.innerHTML},ee=d=>{const l=u.paragraphLists[d].content,I=window.getSelection().getRangeAt(0);I.toString()&&be.confirm({title:"单独分段",icon:t(Ie),content:"确认将该分段内容单独分段么？分段后，原分段的内容会被删除",onOk(){const Q=document.createElement("div");Q.innerHTML=l;const[J,Z,p]=E(Q,I.startOffset,I.endOffset),le=J.replace(/<[^>]+>/g,"").trim()==="",F=p.replace(/<[^>]+>/g,"").trim()==="";le&&F?y("handleSplit",{index:d,beforeContent:"",selectedContent:Z,afterContent:"",isFullSelection:!0}):y("handleSplit",{index:d,beforeContent:J,selectedContent:Z,afterContent:p,originalSelection:{start:I.startOffset,end:I.endOffset,parentIndex:d}})}})},ce=d=>{if(d>=u.paragraphLists.length-1)return ge.error("没有下一个分段");const l=u.paragraphLists[d].content,I=window.getSelection().getRangeAt(0);I.toString()&&be.confirm({title:"合并到下一个分段",icon:t(Ie),content:"确认将该分段内容合并到下一个分段么？分段后，原分段的内容会被删除",onOk(){const Q=document.createElement("div");Q.innerHTML=l;const[J,Z,p]=E(Q,I.startOffset,I.endOffset),le=J.replace(/<[^>]+>/g,"").trim()==="",F=p.replace(/<[^>]+>/g,"").trim()==="";le&&F?y("handleSplitNext",{index:d,beforeContent:"",selectedContent:Z,afterContent:"",isFullSelection:!0}):y("handleSplitNext",{index:d,beforeContent:J,selectedContent:Z,afterContent:p,originalSelection:{start:I.startOffset,end:I.endOffset,parentIndex:d}})}})},Oe=d=>{if(d<=0)return ge.error("没有上一个分段");const l=u.paragraphLists[d].content,I=window.getSelection().getRangeAt(0);I.toString()&&be.confirm({title:"合并到上一个分段",icon:t(Ie),content:"确认将该分段内容合并到上一个分段么？分段后，原分段的内容会被删除",onOk(){const Q=document.createElement("div");Q.innerHTML=l;const[J,Z,p]=E(Q,I.startOffset,I.endOffset),le=J.replace(/<[^>]+>/g,"").trim()==="",F=p.replace(/<[^>]+>/g,"").trim()==="";le&&F?y("handleSplitUp",{index:d,beforeContent:"",selectedContent:Z,afterContent:"",isFullSelection:!0}):y("handleSplitUp",{index:d,beforeContent:J,selectedContent:Z,afterContent:p,originalSelection:{start:I.startOffset,end:I.endOffset,parentIndex:d}})}})},z=d=>{const l=u.paragraphLists[d].content,I=window.getSelection().getRangeAt(0);I.toString()&&be.confirm({title:"删除",icon:t(Ie),content:"确认将该分段内容删除么？",onOk(){const Q=document.createElement("div");Q.innerHTML=l;const[J,Z,p]=E(Q,I.startOffset,I.endOffset),le=J.replace(/<[^>]+>/g,"").trim()==="",F=p.replace(/<[^>]+>/g,"").trim()==="";le&&F?y("handleSplitDelete",{index:d,beforeContent:"",selectedContent:"",afterContent:"",isFullSelection:!0}):y("handleSplitDelete",{index:d,beforeContent:J,selectedContent:"",afterContent:p,originalSelection:{start:I.startOffset,end:I.endOffset,parentIndex:d}})}})},Se=d=>{w.value&&!d.target.closest(".bubble-card")&&(w.value=!1)};function Re(d,l){if(u.detailsInfo.chunk_type!=4||l==0)return!1;let G=u.paragraphLists[l-1];return d.father_chunk_paragraph_number==G.father_chunk_paragraph_number}function we(d,l,G={}){if(!l||!d)return d;const{highlightClass:I="highlight",caseSensitive:me=!1,wholeWord:Q=!1}=G,J=me?"g":"gi";let Z;return Q?Z=new RegExp(`\\b${Ne(l)}\\b`,J):Z=new RegExp(Ne(l),J),d.replace(Z,p=>`<span class="${I}">${p}</span>`)}function Ne(d){return d.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}return Ue(()=>{document.addEventListener("click",Se)}),Dt(()=>{document.removeEventListener("click",Se)}),se({handleOpenEditModal:D}),(d,l)=>{const G=Xe,I=ut,me=rt,Q=ct,J=Ke,Z=lt("viewer");return r(),m("div",{class:"subsection-box content-container",ref_key:"containerRef",ref:s},[a("div",Ja,[l[4]||(l[4]=C(" 分段预览 ",-1)),a("span",null,"共"+ae(u.total)+"个分段",1)]),(r(!0),m(fe,null,$e(u.paragraphLists,(p,le)=>(r(),m("div",{class:st(["list-item",{"fragment-father-son-item":u.detailsInfo.chunk_type==4,"dashed-line":Re(p,le),mt8:u.detailsInfo.chunk_type==4&&!Re(p,le)}]),key:p.id,onClick:ye(F=>N(p,le,F),["stop"]),style:De({"--status-color":oe(p)})},[a("div",Ga,[a("div",Qa,[l[8]||(l[8]=C(" 分段 ",-1)),u.detailsInfo.chunk_type==4?(r(),m(fe,{key:0},[C(ae(p.father_chunk_paragraph_number)+"-",1)],64)):U("",!0),C(" "+ae(p.number)+" ",1),a("div",Va,ae(p.title),1),a("span",null,"共"+ae(p.word_total)+"个字符",1),a("span",Wa,[C(" 嵌入状态："+ae(p.status_text),1),p.status==3?(r(),j(Y(zn),{key:0})):U("",!0),p.status==2&&p.errmsg?(r(),j(G,{key:1,title:p.errmsg},{default:i(()=>[a("strong",Za,[l[5]||(l[5]=C("原因",-1)),t(Y(Ie),{class:"err-icon cfb363f"})])]),_:1},8,["title"])):U("",!0),p.split_status==4&&p.split_err_msg?(r(),j(G,{key:2,title:p.split_err_msg},{default:i(()=>[a("div",Ka,[t(Y(Fn),{style:{"margin-left":"0"},class:"cfb363f"}),l[6]||(l[6]=C(" 分段失败 ",-1))])]),_:1},8,["title"])):U("",!0)]),ue.detailsInfo.graph_switch?(r(),m("span",Xa,[C(" 知识图谱状态："+ae(p.graph_status_text)+" ",1),p.graph_status==3&&p.graph_err_msg?(r(),j(G,{key:0,title:p.graph_err_msg},{default:i(()=>[a("strong",Ya,[l[7]||(l[7]=C("原因",-1)),t(Y(Ie),{class:"err-icon cfb363f"})])]),_:1},8,["title"])):U("",!0)])):U("",!0)]),a("div",eo,[t(Q,null,{overlay:i(()=>[t(me,null,{default:i(()=>[(r(!0),m(fe,null,$e(q.value,F=>(r(),j(I,{key:F.id},{default:i(()=>[a("div",{class:"start-item",onClick:ye(xe=>b(p,F),["stop"])},[t(Y(We),{style:De({color:Y(Ze)[F.type]})},null,8,["style"]),a("div",null,ae(F.name||"-"),1)],8,no)]),_:2},1024))),128)),t(I,null,{default:i(()=>[a("div",{class:"start-item",onClick:ye(R,["stop"])},[t(Y(Ut)),l[9]||(l[9]=a("div",null,"精选设置",-1))])]),_:1})]),_:2},1024)]),default:i(()=>[a("div",to,[p.category_id>0?(r(),j(Y(We),{key:0,onClick:ye(F=>b(p,{}),["stop"]),style:De({color:oe(p),"font-size":"16px"})},null,8,["onClick","style"])):(r(),j(Y(Bt),{key:1,onClick:F=>b(p,q.value[0]),style:{"font-size":"16px",color:"#595959"}},null,8,["onClick"]))])]),_:2},1024),t(G,null,{title:i(()=>[...l[10]||(l[10]=[C("重新分段",-1)])]),default:i(()=>[a("div",{class:"hover-btn-box",onClick:ye(F=>L(p),["stop"])},[t(J,{name:"segmentation-icon",style:{"font-size":"16px"}})],8,ao)]),_:2},1024),ue.detailsInfo.graph_switch?(r(),j(G,{key:0},{title:i(()=>[...l[11]||(l[11]=[C("知识图谱",-1)])]),default:i(()=>[a("div",{class:"hover-btn-box",onClick:F=>S(p)},[t(J,{name:"graph-icon",style:{"font-size":"16px",color:"#595959"}})],8,oo)]),_:2},1024)):U("",!0),t(G,null,{title:i(()=>[...l[12]||(l[12]=[C("重新转换",-1)])]),default:i(()=>[a("div",lo,[t(Y(Jt),{onClick:ye(F=>_(p,le),["stop"])},null,8,["onClick"])])]),_:2},1024),t(Q,{placement:"bottomRight"},{overlay:i(()=>[t(me,null,{default:i(()=>[t(I,null,{default:i(()=>[a("div",{onClick:ye(F=>D(p),["stop"])},"编辑",8,io)]),_:2},1024),t(I,null,{default:i(()=>[a("div",{onClick:ye(F=>P(p.id),["stop"])},"删除",8,ro)]),_:2},1024)]),_:2},1024)]),default:i(()=>[a("div",so,[t(Y(jt),{style:{"font-size":"16px",color:"#595959"}})])]),_:2},1024)])]),p.question?(r(),m("div",uo,[l[13]||(l[13]=C("Q： ",-1)),a("span",{innerHTML:we(p.question,u.search)},null,8,co)])):U("",!0),p.answer?(r(),m("div",_o,[l[14]||(l[14]=C("A：",-1)),a("span",{innerHTML:we(p.answer,u.search)},null,8,po)])):U("",!0),a("div",{class:"content-box",onMouseup:ye(F=>ve(F,le),["stop"]),innerHTML:we(p.content,u.search)},null,40,fo),p.images.length>0?it((r(),m("div",mo,[(r(!0),m(fe,null,$e(p.images,(F,xe)=>(r(),m("img",{key:xe,src:F,alt:""},null,8,vo))),128))])),[[Z]]):U("",!0)],14,ja))),128)),t(Vt,{onOk:H,ref_key:"classificationMarkModalRef",ref:h},null,512),t(Ua,{ref_key:"graphModelRef",ref:g},null,512),w.value?(r(),m("div",{key:0,class:"bubble-card",style:De(ie.value)},[a("button",{class:"bubble-item",onClick:l[0]||(l[0]=ye(p=>A("separate"),["stop"]))},[t(J,{name:"segmentation",style:{"font-size":"16px",color:"#262626","margin-right":"4px"}}),l[15]||(l[15]=C(" 单独成段 ",-1))]),a("button",{class:"bubble-item",onClick:l[1]||(l[1]=ye(p=>A("merge-prev"),["stop"]))},[t(J,{name:"segmentation-up",style:{"font-size":"16px",color:"#262626","margin-right":"4px"}}),l[16]||(l[16]=C(" 合并到上一分段 ",-1))]),a("button",{class:"bubble-item",onClick:l[2]||(l[2]=ye(p=>A("merge-next"),["stop"]))},[t(J,{name:"segmentation-down",style:{"font-size":"16px",color:"#262626","margin-right":"4px"}}),l[17]||(l[17]=C(" 合并到下一分段 ",-1))]),a("button",{class:"bubble-item",onClick:l[3]||(l[3]=ye(p=>A("delete"),["stop"]))},[t(J,{name:"delete",style:{"font-size":"16px",color:"#262626","margin-right":"4px"}}),l[18]||(l[18]=C(" 删除 ",-1))])],4)):U("",!0)],512)}}},It=Le(go,[["__scopeId","data-v-69527c24"]]),ho={class:"mode-box"},ko=["innerHTML"],yo={class:"tag-item"},bo={__name:"segmentation-mode",props:{detailsInfo:{type:Object}},setup(ue){const se=ue,$=c(""),K=he(()=>{const{is_table_file:y,is_qa_doc:u,is_diy_split:_,question_lable:D,answer_lable:P,separators:N,chunk_size:L,chunk_overlap:q,question_column:H,answer_column:h,qa_index_type:R,doc_type:oe}=se.detailsInfo;if(y!=1&&u!=1&&_!=1)return oe==3?($.value=`分段模式：手动分段
文档类型：普通文档`,"自定义：普通文档"):($.value=`分段模式：智能分段
文档类型：普通文档`,"智能分段：普通文档");if(y!=1&&u==1)return oe==3?($.value=`分段模式：手动分段
文档类型：QA文档`,"自定义：QA文档"):($.value=`分段模式：智能分段
文档类型：QA文档
问题开始标识符："${D}"
答案开始标识符："${P}"`,"智能分段：QA文档");if(y!=1&&u!=1&&_==1)return $.value=`分段模式：自定义分段
文档标识符：${N}
分段最大长度：${L}字符
文段重叠长度：${q}字符`,"自定义分段";if(y==1&&u!=1)return $.value=`分段模式：智能分段
文档类型：普通表格`,"智能分段：普通表格";if(y==1&&u==1){let b=R==1?"问题与答案一起生成索引":"仅对问题生成索引";return $.value=`分段模式：智能分段
文档类型：QA文档
问题所在列："${H}"
答案所在列："${h}"
索引方式：${b}`,"智能分段：QA文档"}});return(y,u)=>{const _=Xe;return r(),m("div",ho,[t(_,null,{title:i(()=>[a("div",{class:"tooltip-text-box",innerHTML:$.value},null,8,ko)]),default:i(()=>[a("div",yo,ae(K.value),1)]),_:1})])}}},So=Le(bo,[["__scopeId","data-v-6ee0b31f"]]),wo={__name:"update-frequency",emits:["ok"],setup(ue,{expose:se,emit:$}){const K=$,y=c(!1),u=c(!1),_=qe({doc_auto_renew_frequency:1,id:""}),D=N=>{let{doc_auto_renew_frequency:L,id:q}=N;_.doc_auto_renew_frequency=+L,_.id=q,y.value=!0},P=()=>{u.value=!0,yn({..._}).then(N=>{K("ok",_.doc_auto_renew_frequency),y.value=!1,ge.success("设置成功")}).finally(()=>{u.value=!1})};return se({open:D}),(N,L)=>{const q=Qt,H=Gt,h=Nn,R=Dn,oe=be;return r(),m("div",null,[t(oe,{open:y.value,"onUpdate:open":L[1]||(L[1]=b=>y.value=b),"confirm-loading":u.value,maskClosable:!1,title:"设置更新频率",onOk:P},{default:i(()=>[t(R,{style:{margin:"32px 0"},layout:"vertical",model:_},{default:i(()=>[t(h,{name:"doc_auto_renew_frequency",label:"更新频率",required:""},{default:i(()=>[t(H,{value:_.doc_auto_renew_frequency,"onUpdate:value":L[0]||(L[0]=b=>_.doc_auto_renew_frequency=b),style:{width:"100%"}},{default:i(()=>[t(q,{value:1},{default:i(()=>[...L[2]||(L[2]=[C("不自动更新",-1)])]),_:1}),t(q,{value:2},{default:i(()=>[...L[3]||(L[3]=[C("每天",-1)])]),_:1}),t(q,{value:3},{default:i(()=>[...L[4]||(L[4]=[C("每3天",-1)])]),_:1}),t(q,{value:4},{default:i(()=>[...L[5]||(L[5]=[C("每7天",-1)])]),_:1}),t(q,{value:5},{default:i(()=>[...L[6]||(L[6]=[C("每30天",-1)])]),_:1})]),_:1},8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open","confirm-loading"])])}}},xo={class:"loading"},Co={__name:"pdf-preview",props:{source:{type:[String],required:!0},pageSize:{type:Number,default:10}},emits:["onScrollEnd","select","rendered","scroll","getTotalPage"],setup(ue,{expose:se,emit:$}){const K=ue,y=$,u=c(null),_=c([]),D=c(0),P=c(!1),N=he(()=>P.value?null:{"border-bottom":"2px solid #d9d9d9"}),L=c({fade:!1,scrollbarTrackClickable:!0,interactive:!0,minSize:40});Ue(async()=>{const g=await Et.getDocument(K.source).promise;D.value=g.numPages,y("getTotalPage",D.value),q()});const q=(g=null)=>{const S=_.value.length;if(S>=D.value||P.value)return;P.value=!0;const s=[];for(let w=1;w<=K.pageSize&&S+w<=D.value;w++)s.push(S+w);_.value.push(...s),Ve(()=>{typeof g=="function"&&g()})},H=g=>{q(),y("onScrollEnd",g)},h=g=>{Ve(()=>{g===_.value[_.value.length-1]&&(P.value=!1,y("rendered",g,D.value))})},R=g=>{y("select",g)},oe=()=>u.value,b=g=>{y("scroll",g)};return se({loadMore:q,getScrollInstance:oe}),(g,S)=>{const s=je;return r(),j(Be,{scrollbar:L.value,ref_key:"scrollRef",ref:u,onScroll:b,onOnScrollEnd:H},{default:i(()=>[(r(!0),m(fe,null,$e(_.value,w=>(r(),j(Y(Et),{onClick:M=>R(w),key:w,source:ue.source,page:w,onRendered:()=>h(w),style:De(N.value)},null,8,["onClick","source","page","onRendered","style"]))),128)),a("div",xo,[P.value?(r(),j(s,{key:0})):U("",!0)])]),_:1},8,["scrollbar"])}}},$o=Le(Co,[["__scopeId","data-v-8ffdbe19"]]),Lo={key:0,class:"loading-wrap"},qo={class:"document-segmentation"},Oo={class:"page-container"},Eo={class:"page-left"},Io={class:"page-right"},Ro={class:"document-fragment-preview"},Mo={class:"preview-header"},To={class:"fragment-number"},Po={key:1,class:"loading-box"},zo="你是一位文章分段助手，根据文章内容的语义进行合理分段，确保每个分段表述一个完整的语义，每个分段字数控制在500字左右，最大不超过1000字。请严格按照文章内容进行分段，不要对文章内容进行加工，分段完成后输出分段后的内容。",Fo={__name:"document-segmentation-model",props:{pdfState:{type:Object,default:()=>{}},currentData:{type:Object,default:()=>{}},paragraphType:{type:String,default:""}},emits:["ok","finish","loading"],setup(ue,{expose:se,emit:$}){const K=bn(),{setInitDocumentFragmentList:y}=K,u=Je(),_=$,{id:D}=u.query,P=c(!0),N=c(1);let L=!1;const q=ue,H=c(1);let h={id:D,separators_no:"",chunk_size:512,not_merged_text:!1,chunk_overlap:50,is_qa_doc:0,question_lable:"",answer_lable:"",enable_extract_image:!0,ai_chunk_size:5e3,ai_chunk_model:"",ai_chunk_model_config_id:"",ai_chunk_prumpt:zo,ai_chunk_task_id:"",father_chunk_paragraph_type:2,father_chunk_separators_no:[],father_chunk_chunk_size:1024,son_chunk_separators_no:[],son_chunk_chunk_size:512};const R=c(null),oe=n=>{typeof n.separators_no=="object"&&(n.separators_no=JSON.stringify(n.separators_no)),typeof n.father_chunk_separators_no=="object"&&(n.father_chunk_separators_no=JSON.stringify(n.father_chunk_separators_no)),typeof n.son_chunk_separators_no=="object"&&(n.son_chunk_separators_no=JSON.stringify(n.son_chunk_separators_no)),h={...h,...n},L?be.confirm({title:"提醒",icon:t(Ie),content:"文档片段已被编辑重新获取文档片段会丢失当前修改过的文档片段内容，确定要重新获取吗？",okText:"确定",okType:"danger",cancelText:"取消",onOk(){L=!1,Oe("create")},onCancel(){}}):(L=!1,Oe("create"))};let b=600,g=0;const S=c({}),s=c(0),w=()=>{P.value||(P.value=!0),zt({id:D}).then(async n=>{const{status:x}=n.data;if(s.value=n.data.library_type,S.value=n.data,h={...h,separators_no:n.data.separators_no||"[12,11]",chunk_size:+n.data.chunk_size||512,not_merged_text:n.data.not_merged_text=="true",ai_chunk_size:+n.data.ai_chunk_size||5e3,chunk_overlap:+n.data.chunk_overlap||50,is_qa_doc:s.value==2?1:0,question_lable:n.data.question_lable,answer_lable:n.data.answer_lable,question_column:n.data.question_column,answer_column:n.data.answer_column,enable_extract_image:n.data.enable_extract_image=="true",qa_index_type:+n.data.qa_index_type,chunk_type:+n.data.chunk_type,semantic_chunk_size:+n.data.semantic_chunk_size||512,semantic_chunk_overlap:+n.data.semantic_chunk_overlap||50,semantic_chunk_threshold:+n.data.semantic_chunk_threshold||90,semantic_chunk_use_model:n.data.semantic_chunk_use_model||"",ai_chunk_prumpt:n.data.ai_chunk_prumpt||"",ai_chunk_model:n.data.ai_chunk_model||"",semantic_chunk_model_config_id:n.data.semantic_chunk_model_config_id>0?n.data.semantic_chunk_model_config_id:"",ai_chunk_model_config_id:n.data.ai_chunk_model_config_id>0?n.data.ai_chunk_model_config_id:"",ai_chunk_task_id:n.data.ai_chunk_task_id||"",father_chunk_paragraph_type:+n.data.father_chunk_paragraph_type||2,father_chunk_separators_no:n.data.father_chunk_separators_no||"[12,11]",father_chunk_chunk_size:+n.data.father_chunk_chunk_size||1024,son_chunk_separators_no:n.data.son_chunk_separators_no||"[8,10]",son_chunk_chunk_size:+n.data.son_chunk_chunk_size||512},n.data.chunk_type==0&&(h={...h,separators_no:n.data.normal_chunk_default_separators_no,chunk_size:n.data.normal_chunk_default_chunk_size,not_merged_text:n.data.normal_chunk_default_not_merged_text=="true",chunk_overlap:n.data.normal_chunk_default_chunk_overlap,chunk_type:+n.data.default_chunk_type,semantic_chunk_size:+n.data.semantic_chunk_default_chunk_size,semantic_chunk_overlap:+n.data.semantic_chunk_default_chunk_overlap,semantic_chunk_threshold:+n.data.semantic_chunk_default_threshold,semantic_chunk_use_model:n.data.default_use_model||"",semantic_chunk_model_config_id:n.data.default_model_config_id>0?n.data.default_model_config_id:""}),x==0){if(g++,g>b){be.error({title:"提醒",content:"文档解析速度慢请稍后再试"});return}setTimeout(()=>{w()},1e3)}else(x==4||x==2)&&(P.value=!1,N.value=parseInt(n.data.is_table_file),n.data.library_id,s.value==2?(h.question_lable||h.question_column)&&Oe():Oe());n.data.is_table_file==1&&re()})};Ue(async()=>{await w()});const M=c([]),re=()=>{xn({id:D}).then(n=>{let x=[];for(let ne in n.data)x.push({lable:n.data[ne],value:ne});M.value=x})},v=c([]),_e=c(!1),ie=c(!1),ve=c(""),A=c(null);let E=null;const W=c([]),ee=c(0),ce=he(()=>ee.value<=0),Oe=n=>{var pe;_("loading",!0);let x={...h,semantic_chunk_model_config_id:h.semantic_chunk_model_config_id?+h.semantic_chunk_model_config_id:0,ai_chunk_model_config_id:h.ai_chunk_model_config_id?+h.ai_chunk_model_config_id:0,...q.pdfState};h.chunk_type==3&&(h.ai_chunk_task_id&&!n&&(x.ai_chunk_task_id=h.ai_chunk_task_id),x.ai_chunk_task_id&&n&&n==="create"&&delete x.ai_chunk_task_id);let ne=wn;return q.paragraphType&&q.paragraphType==="paragraphsSegmented"&&n=="create"&&(ne=$n,delete x.id),q.paragraphType&&q.paragraphType==="paragraphsSegmented"&&!n?(W.value=q.currentData.list||[],ee.value=q.currentData.list.length,h.chunk_type==3&&(ve.value=((pe=q.currentData.split_params)==null?void 0:pe.ai_chunk_task_id)||"",ie.value=!0,R.value.reLoading=!0,A.value=null,!h.ai_chunk_task_id&&N.value!=1||n&&n==="create"?(W.value=[],ee.value=0,we()):(ie.value=!1,R.value.reLoading=!1)),h.chunk_type!=3&&(R.value.reLoading=!1,R.value.saveLoading=!1),_("loading",!1),!1):ne(x).then(ke=>{var Te;v.value=ke.data.list||[],y(v.value),W.value=ke.data.list||[],ee.value=ke.data.list.length||0,h.chunk_type==3&&(ve.value=((Te=ke.data.split_params)==null?void 0:Te.ai_chunk_task_id)||"",ie.value=!0,R.value.reLoading=!0,R.value.saveLoading=!0,A.value=null,!h.ai_chunk_task_id&&N.value!=1||n&&n==="create"?(W.value=[],ee.value=0,we()):(ie.value=!1,R.value.reLoading=!1,R.value.saveLoading=!1))}).finally(()=>{h.chunk_type!=3&&(R.value.reLoading=!1,R.value.saveLoading=!1),_("loading",!1)})},z=n=>{H.value=n},Se=async()=>{var n;try{const x=await Ne();return x.data.err_msg?(A.value=x.data.err_msg,!0):((n=x.data.list)==null?void 0:n.length)>0?(v.value=x.data.list||[],y(v.value),W.value=x.data.list||[],ee.value=x.data.list.length||0,!0):!1}catch{return A.value="请求异常，停止轮询",!0}};function Re(n){return n.split("message:")[1]}const we=()=>{const n=async()=>{if(!await Se())E=setTimeout(n,3e3);else if(ie.value=!1,R.value.reLoading=!1,R.value.saveLoading=!1,E!==null&&(clearTimeout(E),E=null),_e.value&&F(),A.value){let ne=Re(A.value);be.error({title:"分段失败提示",content:ne?`模型调用失败，失败原因：${ne}`:"模型调用失败"})}};n()},Ne=()=>Cn({id:h.id,task_id:ve.value}),d=c(null);let l=null;const G=({title:n,content:x,question:ne,answer:pe,images:ke},Te)=>{l=Te,d.value.open({title:n,content:x,question:ne,answer:pe,images:ke})},I=({title:n,content:x,question:ne,answer:pe,images:ke})=>{(W.value[l].title!=n||W.value[l].content!=x||W.value[l].question!=ne||W.value[l].answer!=pe)&&(L=!0),W.value[l].title=n,W.value[l].content=x,W.value[l].question=ne,W.value[l].answer=pe,W.value[l].images=ke,W.value[l].word_total=pe.length+ne.length+x.length},me=n=>{be.confirm({title:"提醒",icon:t(Ie),content:"确定要删除这个片段吗?",okText:"确定",okType:"danger",cancelText:"取消",onOk(){L=!0,W.value.splice(n,1)},onCancel(){}})},Q=c(""),J=n=>{Q.value=n},Z=c(!1),p=()=>{let n=R.value.formState;n=JSON.parse(JSON.stringify(n)),typeof n.separators_no=="object"&&(n.separators_no=JSON.stringify(n.separators_no)),typeof n.father_chunk_separators_no=="object"&&(n.father_chunk_separators_no=JSON.stringify(n.father_chunk_separators_no)),typeof n.son_chunk_separators_no=="object"&&(n.son_chunk_separators_no=JSON.stringify(n.son_chunk_separators_no)),h={...h,...n}},le=n=>{let x=0;return n.forEach(ne=>{x+=parseInt(ne.word_total)}),x},F=async()=>{if((ee.value<=0||h.chunk_type!=H.value)&&(p(),await Oe()),p(),Q.value)return ge.error(Q.value);if(h.chunk_type==3&&!W.value.length)return _e.value=!0,!1;ve.value&&(h.ai_chunk_task_id=ve.value);let n={...h,semantic_chunk_model_config_id:h.semantic_chunk_model_config_id?+h.semantic_chunk_model_config_id:0,ai_chunk_model_config_id:h.ai_chunk_model_config_id?+h.ai_chunk_model_config_id:0,is_table_file:N.value,...q.pdfState};delete n.id;let x={file_id:D,word_total:le(W.value),split_params:JSON.stringify(n),list:JSON.stringify(W.value),...q.pdfState};n.is_qa_doc==1&&(x.qa_index_type=n.qa_index_type),Z.value=!0,q.paragraphType&&q.paragraphType==="paragraphsSegmented"&&(x.data_id=x.data_ids,delete x.data_ids),Sn(x).then(()=>{_("ok"),_("finish")}).finally(()=>{Z.value=!1}).catch(ne=>{ne.data&&ne.data.index&&Me(ne.data.index),_("finish")})},xe=c(null),Me=n=>{n=n-1;let x=xe.value.querySelectorAll(".fragment-item");x.length>=n&&x[n].scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})};return Dt(()=>{E&&(clearTimeout(E),E=null)}),se({handleSaveLibFileSplit:F}),(n,x)=>{const ne=je;return r(),m(fe,null,[P.value?(r(),m("div",Lo,[t(ne)])):U("",!0),a("div",qo,[a("div",Oo,[a("div",Eo,[t(da,{excellQaLists:M.value,libFileInfo:S.value,library_type:s.value,mode:N.value,hideSave:!0,status:"paragraphsSegmented",ref_key:"segmentationSettingRef",ref:R,onChange:oe,onChangeChunkType:z,onSave:F,onValidate:J},null,8,["excellQaLists","libFileInfo","library_type","mode"])]),a("div",Io,[a("div",Ro,[a("div",Mo,[x[0]||(x[0]=a("span",{class:"label-text"},"分段预览",-1)),a("span",To,"共"+ae(ee.value)+"个分段",1)]),ce.value&&!ie.value?(r(),j(_a,{key:0})):U("",!0),ie.value?(r(),m("div",Po,[t(ne),x[1]||(x[1]=C("数据处理中...",-1))])):U("",!0),a("div",{class:"preview-box",ref_key:"previewBoxRef",ref:xe},[(r(!0),m(fe,null,$e(W.value,(pe,ke)=>(r(),m("div",{class:"fragment-item",key:ke},[t(pa,{status:"paragraphsSegmented",chunk_type:Y(h).chunk_type,father_chunk_paragraph_number:pe.father_chunk_paragraph_number,currentData:ue.currentData,number:pe.number,title:pe.title,content:pe.content,total:pe.word_total,question:pe.question,answer:pe.answer,images:pe.images,onDelete:Te=>me(ke),onEdit:Te=>G(pe,ke)},null,8,["chunk_type","father_chunk_paragraph_number","currentData","number","title","content","total","question","answer","images","onDelete","onEdit"])]))),128))],512)])])]),t(fa,{ref_key:"editFragmentAlertRef",ref:d,onOk:I},null,512)])],64)}}},Wt=Le(Fo,[["__scopeId","data-v-16075b18"]]),Do={class:"select-box"},No=["onClick"],Ho={class:"title"},Ao={class:"desc"},Bo={key:0,class:"card-switch"},Uo={class:"main-content-box"},Jo={__name:"re-segmentation-page",props:{detailsInfo:{type:Object,default:()=>{}}},emits:["ok","enable"],setup(ue,{expose:se,emit:$}){const K=Ft(),y=he(()=>{var A;return((A=K.companyInfo)==null?void 0:A.ali_ocr_switch)=="1"}),u=Je().query,_=Nt(),D=ue,P=c(!1),N=c(!1),L=c(""),q=$;let H={};const h=c([{title:"图文OCR解析",desc:"通过OCR文字识别提取pdf文件内容，可以兼容扫描件，但是解析速度较慢。",icon:"pdf-ocr",pdf_parse_type:2},{title:"纯文本解析",desc:"只提取Pdf中的文字内容，如果文档为扫描件可能提取不到内容。",icon:"pdf-text",pdf_parse_type:1},{title:"图文解析",desc:"提取PDF文档中的图片和文字",icon:"pdf-img",pdf_parse_type:3}]),R=qe({pdf_parse_type:2,pdf_page_num:0}),oe=()=>{h.value=h.value.filter(A=>A.pdf_parse_type!=4),q("enable")},b=c(!1),g=A=>{b.value=A},S=A=>{H={...A},R.pdf_parse_type=2,R.pdf_page_num=A.pdf_page_num,A.type==1&&(L.value=`当页(${A.pdf_page_num})重新分段`),A.type==2&&(L.value="将文档重新分段"),A.type==3&&(L.value="重新学习文档",h.value.push({title:"阿里云OCR解析",desc:"通过阿里云文档智能接口解析提取图片和文字",icon:"ali-ocr",pdf_parse_type:4})),P.value=!0},s=()=>{window.open("#/user/aliocr")},w=A=>{if(A.pdf_parse_type==4&&!y.value)return!1;R.pdf_parse_type=A.pdf_parse_type},M=c(!1),re=()=>{if(H.type==3){if(R.pdf_parse_type==1){_.push("/library/document-segmentation?document_id="+u.id+"&source=preview");return}M.value=!0,Ln({id:u.id,pdf_parse_type:R.pdf_parse_type}).then(A=>{ge.success("重新学习成功"),(R.pdf_parse_type==2||R.pdf_parse_type==3||R.pdf_parse_type==4)&&_.push({path:"/library/details/knowledge-document",query:{id:D.detailsInfo.library_id}}),R.pdf_parse_type==1&&_.push("/library/document-segmentation?document_id="+u.id+"&source=preview"),P.value=!1}).finally(()=>{M.value=!1});return}P.value=!1,N.value=!0},v=c(null),_e=()=>{M.value=!0,v.value.handleSaveLibFileSplit()},ie=()=>{ge.success("保存成功"),N.value=!1,q("ok",H.type)},ve=()=>{M.value=!1};return se({show:S}),(A,E)=>{const W=Ke,ee=be;return r(),m("div",null,[t(ee,{open:P.value,"onUpdate:open":E[0]||(E[0]=ce=>P.value=ce),title:L.value,onOk:re,onCancel:oe,width:720,confirmLoading:M.value},{default:i(()=>[a("div",Do,[(r(!0),m(fe,null,$e(h.value,ce=>(r(),m("div",{class:st(["select-list-item",{active:ce.pdf_parse_type==R.pdf_parse_type},{disabled:ce.pdf_parse_type==4&&!y.value}]),onClick:Oe=>w(ce),key:ce.pdf_parse_type},[a("div",Ho,[t(W,{name:ce.icon,style:{"font-size":"16px"}},null,8,["name"]),C(" "+ae(ce.title),1)]),a("div",Ao,ae(ce.desc),1),ce.pdf_parse_type==4&&!y.value?(r(),m("div",Bo,[E[2]||(E[2]=C(" 未开启阿里云OCR ",-1)),a("div",{class:"card-switch-btn",onClick:ye(s,["stop"])},"去开启")])):U("",!0)],10,No))),128))])]),_:1},8,["open","title","confirmLoading"]),t(ee,{open:N.value,"onUpdate:open":E[1]||(E[1]=ce=>N.value=ce),onCancel:oe,title:L.value,maskClosable:!1,"ok-text":b.value?"文档解析中,请稍候...":"确定",confirmLoading:M.value||b.value,onOk:_e,width:1e3},{default:i(()=>[a("div",Uo,[N.value?(r(),j(Wt,{key:0,onOk:ie,onFinish:ve,onLoading:g,pdfState:R,ref_key:"documentSegmentationModalRef",ref:v},null,8,["pdfState"])):U("",!0)])]),_:1},8,["open","title","ok-text","confirmLoading"])])}}},jo=Le(Jo,[["__scopeId","data-v-fdcaa00c"]]),Go={class:"subsection-box"},Qo={class:"qa-list-box"},Vo={class:"list-item"},Wo=["innerHTML"],Zo={key:0,class:"list-item"},Ko=["innerHTML"],Xo={class:"list-item"},Yo=["innerHTML"],el={class:"fragment-img"},tl=["src"],nl={key:0,class:"status-tag"},al={key:1,class:"status-tag complete"},ol={class:"status-tag status-error"},ll={key:3,class:"status-tag running"},sl={class:"right-opration"},il={class:"hover-btn-box"},rl=["onClick"],ul=["onClick"],cl={class:"hover-btn-box"},dl=["onClick"],_l=["onClick"],pl={__name:"qa-subsection-box",props:{paragraphLists:{type:Array,default:()=>[]},search:{type:String,default:""},total:{type:[Number,String],default:0}},emits:["handleDelParagraph","handleScrollTargetPage","openEditSubscription","handleConvert","getStatrList"],setup(ue,{expose:se,emit:$}){const y=Je().query,u=$,_=ue,D=(S,s)=>{let{id:w,title:M,content:re,question:v,answer:_e,images:ie,category_id:ve}=S,A=S.similar_questions||[];be.confirm({title:"重新转换确认",icon:null,content:`确定要重新转换【分段${s+1}】吗?`,onOk(){return new Promise((E,W)=>{Tt({id:w,title:M,content:re,question:v,answer:_e,images:ie,category_id:ve,similar_questions:JSON.stringify(A)}).then(ee=>{u("handleConvert",S),E()}).catch(()=>{E()})})},onCancel(){}})},P=S=>{u("openEditSubscription",S)},N=S=>{be.confirm({title:"提示",icon:t(Ie),content:"确认是否删除该分段?",onOk(){return new Promise((s,w)=>{Pt({id:S}).then(M=>{ge.success("删除成功"),u("handleDelParagraph",S),s()}).catch(()=>{s()})})},onCancel(){}})},L=c([]),q=()=>{let S={};y.id&&(S.file_id=y.id),Rt(S).then(s=>{L.value=s.data||[],u("getStatrList",s.data||[])})};q();const H=c(null),h=()=>{H.value.show()},R=S=>{var w;let s=(w=L.value.filter(M=>M.id==S.category_id)[0])==null?void 0:w.type;return s?Ze[s]:"#F4EA2A"},oe=(S,s={})=>{Mt({id:S.id,category_id:s.id||0}).then(w=>{ge.success("设置成功"),S.category_id=s.id,q()})};function b(S,s,w={}){if(!s||!S)return S;const{highlightClass:M="highlight",caseSensitive:re=!1,wholeWord:v=!1}=w,_e=re?"g":"gi";let ie;return v?ie=new RegExp(`\\b${g(s)}\\b`,_e):ie=new RegExp(g(s),_e),S.replace(ie,ve=>`<span class="${M}">${ve}</span>`)}function g(S){return S.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}return se({handleOpenEditModal:P}),(S,s)=>{const w=Hn,M=Xe,re=je,v=ut,_e=rt,ie=ct,ve=Jn,A=lt("viewer");return r(),m("div",Go,[t(ve,{"data-source":ue.paragraphLists,pagination:!1},{default:i(()=>[t(w,{key:"id","data-index":"id",width:1148},{title:i(()=>[C("问答（共"+ae(_.total)+"个）",1)]),default:i(({record:E})=>[a("div",Qo,[a("div",Vo,[s[0]||(s[0]=a("div",{class:"list-label"},"问题",-1)),a("div",{class:"list-content",innerHTML:b(E.question,_.search)},null,8,Wo)]),E.similar_questions&&E.similar_questions.length?(r(),m("div",Zo,[s[1]||(s[1]=a("div",{class:"list-label"},"相似问法",-1)),a("div",{class:"list-content",innerHTML:b(E.similar_questions.join("/"),_.search)},null,8,Ko)])):U("",!0),a("div",Xo,[s[2]||(s[2]=a("div",{class:"list-label"},"答案",-1)),a("div",{class:"list-content",innerHTML:b(E.answer,_.search)},null,8,Yo)]),it((r(),m("div",el,[(r(!0),m(fe,null,$e(E.images,(W,ee)=>(r(),m("img",{key:ee,src:W,alt:""},null,8,tl))),128))])),[[A]])])]),_:1}),t(w,{title:"嵌入状态",key:"status_text","data-index":"status_text",width:128},{default:i(({record:E})=>[E.status==0?(r(),m("span",nl,[t(Y(An)),s[3]||(s[3]=C(" 未转换",-1))])):U("",!0),E.status==1?(r(),m("span",al,[t(Y(Bn)),s[4]||(s[4]=C(" 已转换",-1))])):U("",!0),E.status==2?(r(),j(M,{key:2,placement:"top"},{title:i(()=>[a("span",null,ae(E.errmsg),1)]),default:i(()=>[a("span",null,[a("span",ol,[t(Y(Un)),s[5]||(s[5]=C(" 转换异常",-1))])])]),_:2},1024)):U("",!0),E.status==3?(r(),m("span",ll,[t(re,{size:"small"}),s[6]||(s[6]=C(" 转换中",-1))])):U("",!0)]),_:1}),t(w,{title:"操作",key:"action","data-index":"action",width:120},{default:i(({record:E,index:W})=>[a("div",sl,[t(ie,null,{overlay:i(()=>[t(_e,null,{default:i(()=>[(r(!0),m(fe,null,$e(L.value,ee=>(r(),j(v,{key:ee.id},{default:i(()=>[a("div",{class:"start-item",onClick:ce=>oe(E,ee)},[t(Y(We),{style:De({color:Y(Ze)[ee.type]})},null,8,["style"]),a("div",null,ae(ee.name||"-"),1)],8,rl)]),_:2},1024))),128)),t(v,null,{default:i(()=>[a("div",{class:"start-item",onClick:h},[t(Y(Ut)),s[7]||(s[7]=a("div",null,"标记设置",-1))])]),_:1})]),_:2},1024)]),default:i(()=>[a("div",il,[E.category_id>0?(r(),j(Y(We),{key:0,onClick:ee=>oe(E,{}),style:De({color:R(E),"font-size":"16px"})},null,8,["onClick","style"])):(r(),j(Y(Bt),{key:1,onClick:ee=>oe(E,L.value[0]),style:{"font-size":"16px"}},null,8,["onClick"]))])]),_:2},1024),t(M,null,{title:i(()=>[...s[8]||(s[8]=[C("重新转换",-1)])]),default:i(()=>[a("div",{class:"hover-btn-box",onClick:ee=>D(E,W)},[t(Y(Jt))],8,ul)]),_:2},1024),t(ie,{placement:"bottomRight"},{overlay:i(()=>[t(_e,null,{default:i(()=>[t(v,null,{default:i(()=>[a("div",{onClick:ye(ee=>P(E),["stop"])},"编辑",8,dl)]),_:2},1024),t(v,null,{default:i(()=>[a("div",{onClick:ye(ee=>N(E.id),["stop"])},"删除",8,_l)]),_:2},1024)]),_:2},1024)]),default:i(()=>[a("div",cl,[t(Y(jt))])]),_:2},1024)])]),_:1})]),_:1},8,["data-source"]),t(Vt,{onOk:q,ref_key:"classificationMarkModalRef",ref:H},null,512)])}}},fl=Le(pl,[["__scopeId","data-v-6a1ecdf2"]]),ml={class:"main-content-box"},vl={__name:"segmentation-setting-modal",emits:["ok","enable"],setup(ue,{expose:se,emit:$}){const K=c(!1),y=c("重新分段"),u=$;let _={};const D=qe({data_ids:0,file_id:0}),P={0:"未转换",1:"已转换",2:"转换异常",3:"转换中",4:"分段失败",10:"分段中"},N=qe({status:"",errmsg:"",status_text:""}),L=()=>{u("enable")},q=c(!1),H=s=>{q.value=s},h=s=>{K.value=!0,D.data_ids=s.id,D.file_id=s.file_id,N.list=[{father_chunk_paragraph_number:+s.father_chunk_paragraph_number,content:s.content,number:+s.number,title:s.title,word_total:+s.word_total,question:s.question,answer:s.answer,images:s.images}],N.status=s.status,N.errmsg=s.errmsg,N.status_text=P[s.status]},R=c(!1),oe=c(null),b=()=>{R.value=!0,oe.value.handleSaveLibFileSplit()},g=()=>{ge.success("保存成功"),K.value=!1,u("ok",_.type)},S=()=>{R.value=!1};return se({show:h}),(s,w)=>{const M=be;return r(),m("div",null,[t(M,{open:K.value,"onUpdate:open":w[0]||(w[0]=re=>K.value=re),onCancel:L,title:y.value,maskClosable:!1,"ok-text":q.value?"文档解析中,请稍候...":"确定",confirmLoading:R.value||q.value,onOk:b,width:1084},{default:i(()=>[a("div",ml,[K.value?(r(),j(Wt,{key:0,onOk:g,onFinish:S,onLoading:H,paragraphType:"paragraphsSegmented",pdfState:D,currentData:N,ref_key:"documentSegmentationModalRef",ref:oe},null,8,["pdfState","currentData"])):U("",!0)])]),_:1},8,["open","title","ok-text","confirmLoading"])])}}},gl=Le(vl,[["__scopeId","data-v-484bfb17"]]),hl={class:"library-preview-page"},kl={class:"breadcrumb-block"},yl={class:"library-line1"},bl={class:"selct-star-box"},Sl={class:"document-title-block",style:{height:"22px"}},wl={class:"title"},xl={class:"search-content-block"},Cl={class:"preview-box"},$l={key:0,class:"page-loading-box"},Ll={class:"content-block"},ql={class:"content-block"},Ol={key:1,class:"pdf-view-box"},El={key:0,class:"pdf-mode-switch"},Il={key:0},Rl={key:1,class:"segmentation-btn"},Ml={class:"view-content-box",style:{"padding-top":"60px"}},Tl=["onClick"],Pl={key:0,class:"content-box"},zl={key:1,class:"content-box"},Fl=["innerHTML"],Dl={class:"fragment-img"},Nl=["src"],Hl={class:"right-contnt-box"},Al={key:0,class:"right-tabs-box"},Bl={class:"content-block"},Ul="你是一位文章分段助手，根据文章内容的语义进行合理分段，确保每个分段表述一个完整的语义，每个分段字数控制在500字左右，最大不超过1000字。请严格按照文章内容进行分段，不要对文章内容进行加工，分段完成后输出分段后的内容。",Jl={__name:"library-preview",setup(ue){const se=Ft(),$=he(()=>{var e;return((e=se.companyInfo)==null?void 0:e.neo4j_status)=="true"}),K=c(!1),y=c(!1),u=c(null),_=c(0),D=c(0),P={0:"待生成",4:"生成中",2:"生成成功",3:"生成失败"},N=c([]),L=e=>{N.value=e},q=c({fade:!1,scrollbarTrackClickable:!0,interactive:!0,minSize:40}),H=Je(),h=Nt(),R=qn(),oe=he(()=>s.value.is_table_file=="1"),b=he(()=>s.value.doc_type),g=he(()=>{let e=s.value.status;return!(e=="1"||e=="2")||z.value.length==0}),S=he(()=>s.value.is_qa_doc=="1"),s=c({}),w=c([]),M=qe({status:-1,graph_status:-1,category_id:-1,search:""}),re=c(1),v=he(()=>"/manage/getLibRawFile?id="+H.query.id+"&token="+R.getToken),_e=()=>{h.back()},ie=c(null),ve=c(null);let A=-1;const E=(e,o=1)=>{let f,O;o==1?(f=".subsection-box .list-item",O=ve.value):(f=".view-content-box .list-item",O=ie.value);const B=document.querySelectorAll(f)[e];B.classList.add("flash-border"),A>=0&&document.querySelectorAll(f)[A].classList.remove("flash-border"),setTimeout(()=>{A=-1,B.classList.remove("flash-border")},2500),A=e,O.scrollToElement({el:B,time:1e3})},W=c(!0),ee=c(0),ce=c({page:1,size:1e3}),Oe=c({}),z=c([]),Se=c(0),Re={0:"未转换",1:"已转换",2:"转换异常",3:"转换中..."},we=qe({split_status_exception:0,total:0,vector_status_converted:0,vector_status_converting:0,vector_status_exception:0,vector_status_initial:0}),Ne=qe([{value:-1,label:"全部",num:he(()=>we.total)},{value:4,label:"分段失败",num:he(()=>we.split_status_exception)},{value:0,label:"未转换",num:he(()=>we.vector_status_initial)},{value:3,label:"转换中",num:he(()=>we.vector_status_converting)},{value:2,label:"转换异常",num:he(()=>we.vector_status_exception)},{value:1,label:"已转换",num:he(()=>we.vector_status_converted)}]),d=c(1);let l={id:H.query.id,separators_no:"",chunk_size:512,not_merged_text:!1,chunk_overlap:50,is_qa_doc:0,question_lable:"",similar_label:"",answer_lable:"",enable_extract_image:!0,ai_chunk_size:5e3,ai_chunk_model:"",ai_chunk_model_config_id:"",ai_chunk_prumpt:Ul,ai_chunk_task_id:"",father_chunk_paragraph_type:2,father_chunk_separators_no:[],father_chunk_chunk_size:1024,son_chunk_separators_no:[],son_chunk_chunk_size:512};const G=c(!1);let I=!0;(async()=>{zt({id:H.query.id}).then(e=>{var f;ee.value=e.data.library_type,s.value={...e.data,graph_switch:e.data.graph_switch=="1"&&$.value},w.value=((f=e==null?void 0:e.data)==null?void 0:f.meta_list)||[];let o=e.data.status;o==1||o==2?F():W.value=!1,l={...l,separators_no:e.data.separators_no||"[12,11]",chunk_size:+e.data.chunk_size||512,not_merged_text:e.data.not_merged_text=="true",ai_chunk_size:+e.data.ai_chunk_size||5e3,chunk_overlap:+e.data.chunk_overlap||50,is_qa_doc:ee.value==2?1:0,question_lable:e.data.question_lable,similar_label:e.data.similar_label,answer_lable:e.data.answer_lable,question_column:e.data.question_column,similar_column:e.data.similar_column,answer_column:e.data.answer_column,enable_extract_image:e.data.enable_extract_image=="true",qa_index_type:+e.data.qa_index_type,chunk_type:+e.data.chunk_type,semantic_chunk_size:+e.data.semantic_chunk_size||512,semantic_chunk_overlap:+e.data.semantic_chunk_overlap||50,semantic_chunk_threshold:+e.data.semantic_chunk_threshold||90,semantic_chunk_use_model:e.data.semantic_chunk_use_model||"",ai_chunk_prumpt:e.data.ai_chunk_prumpt||"",ai_chunk_model:e.data.ai_chunk_model||"",semantic_chunk_model_config_id:e.data.semantic_chunk_model_config_id>0?e.data.semantic_chunk_model_config_id:"",ai_chunk_model_config_id:e.data.ai_chunk_model_config_id>0?e.data.ai_chunk_model_config_id:"",ai_chunk_task_id:e.data.ai_chunk_task_id||"",father_chunk_paragraph_type:+e.data.father_chunk_paragraph_type||2,father_chunk_separators_no:e.data.father_chunk_separators_no||"[12,11]",father_chunk_chunk_size:+e.data.father_chunk_chunk_size||1024,son_chunk_separators_no:e.data.son_chunk_separators_no||"[8,10]",son_chunk_chunk_size:+e.data.son_chunk_chunk_size||512},e.data.chunk_type==0&&(l={...l,separators_no:e.data.normal_chunk_default_separators_no,chunk_size:+e.data.normal_chunk_default_chunk_size,not_merged_text:e.data.normal_chunk_default_not_merged_text=="true",chunk_overlap:+e.data.normal_chunk_default_chunk_overlap,chunk_type:+e.data.default_chunk_type,semantic_chunk_size:+e.data.semantic_chunk_default_chunk_size,semantic_chunk_overlap:+e.data.semantic_chunk_default_chunk_overlap,semantic_chunk_threshold:+e.data.semantic_chunk_default_threshold,semantic_chunk_use_model:e.data.default_use_model||"",semantic_chunk_model_config_id:e.data.default_model_config_id>0?e.data.default_model_config_id:""}),(o==4||o==2)&&(d.value=parseInt(e.data.is_table_file))})})();const Q=()=>{On({file_id:H.query.id,search:M.search}).then(e=>{Object.assign(we,e.data)})},J=()=>{window.location.reload()},Z=()=>{ce.value.page=1,Se.value=0,z.value=[],F(),Q()},p=e=>{M.category_id=e,Z()},le=(e=null)=>{ce.value.page++,F(e)},F=(e=null)=>{I=!0,qt({file_id:H.query.id,...ce.value,...M}).then(o=>{var k,T;W.value=!1,I=!1;let f=o.data,O=f.list||[],B=((k=f.info)==null?void 0:k.is_qa_doc)=="1"&&((T=f.info)==null?void 0:T.is_table_file)=="1";O.forEach(Ce=>{Ce.status_text=Re[Ce.status],Ce.graph_status_text=P[Ce.graph_status],Ce.isExcelQa=B,Ce.similar_questions&&(Ce.similar_questions=JSON.parse(Ce.similar_questions))}),Oe.value=f.info,ce.value.page==1&&(z.value=[]),z.value=[...z.value,...O],Se.value=f.total,typeof e=="function"&&e()})},xe=()=>{I||z.value.length>=Se.value||(le(),u.value&&u.value.loadMore())},Me=()=>{ne()};let n=null;function x(){clearInterval(n),z.value.filter(o=>o.status==3).length?n=setInterval(()=>{ne()},5e3):clearInterval(n)}const ne=()=>{qt({file_id:H.query.id,page:1,size:z.value.length,...M}).then(e=>{var B,k;let o=e.data,f=o.list||[],O=((B=o.info)==null?void 0:B.is_qa_doc)=="1"&&((k=o.info)==null?void 0:k.is_table_file)=="1";f.forEach(T=>{T.status_text=Re[T.status],T.graph_status_text=P[T.graph_status],T.isExcelQa=O,T.similar_questions&&(T.similar_questions=JSON.parse(T.similar_questions))}),z.value=f,x()})},pe=e=>{if(!e.id){ce.value.page=1,F();return}let o=z.value,f=o.findIndex(O=>O.id==e.id);if(f>-1){let O=o[f];O.title=e.title,O.content=e.content,O.question=e.question,O.answer=e.answer,O.images=e.images,O.category_id=e.category_id,O.word_total=e.question.length+e.answer.length+e.content.length,O.similar_questions=e.similar_questions.length?JSON.parse(e.similar_questions):[],o.splice(f,1,O),z.value=o}},ke=e=>{let o=z.value,f=o.findIndex(O=>O.id==e);f>-1&&(o.splice(f,1),z.value=o,Se.value=Se.value--)},Te=c(null),Fe=e=>{Te.value.showModal(JSON.parse(JSON.stringify(e)))},dt=c(null),Zt=()=>{En({id:H.query.id}).then(()=>ge.success("操作完成"))},Kt=()=>{In({id:H.query.id}).then(()=>ge.success("操作完成"))},_t=c(null),Xt=()=>{_t.value.show(s.value)},pt=()=>{h.push("/library/document-segmentation?document_id="+H.query.id+"&source=preview")},Yt=()=>{dt.value.open({id:H.query.id,doc_auto_renew_frequency:s.value.doc_auto_renew_frequency})},en=e=>{s.value.doc_auto_renew_frequency=e},tn=e=>{s.value.file_name=e},nn=e=>{const o=()=>{for(let f in z.value)if(z.value[f].page_num==e){E(f);return}};if(e>z.value[z.value.length-1].page_num){ge.warning("分段数据正在加载，请稍后...");const f=()=>{e<=z.value[z.value.length-1].page_num?(ge.success("加载完成"),Ve(()=>{o()})):le(f)};le(f)}else o()},an=(e,o)=>{D.value=o,_.value=e,z.value[z.value.length-1].page_num<e&&le()},ft=e=>{var o;if(((o=s.value)==null?void 0:o.file_ext)=="pdf"&&re.value==1){const f=e.page_num-1,O=()=>document.querySelectorAll(".pdf-render-box > .scroll-content .vue-pdf-embed")[f],B=()=>{const T=O();T.classList.add("flash-border"),setTimeout(()=>T.classList.remove("flash-border"),2500),u.value.getScrollInstance().scrollToElement({el:T,time:1e3})};if(O())B();else{ge.warning("PDF正在加载，请稍后...");const T=()=>{O()?(ge.success("加载完成"),B()):u.value&&u.value.loadMore()};u.value&&u.value.loadMore(T)}}else E(e.index,2)},Ye=c(1);let et=null;const Ge=c(0),on=e=>{Ge.value=e},ln=({y:e})=>{if(!et){const f=document.querySelectorAll(".pdf-render-box > .scroll-content .vue-pdf-embed")[0];et=f&&f.clientHeight}let o=Math.floor(Math.abs(e)/et)+1;Ye.value=Math.max(o,1)},tt=c(null),nt=c(null),sn=e=>{let{key:o}=e;u.value&&u.value.getScrollInstance().disable(),o==1&&tt.value.show({type:o,pdf_page_num:Ye.value}),o==2&&pt(),o==3&&tt.value.show({type:o,pdf_page_num:0})},mt=e=>{nt.value&&nt.value.show(e)},vt=()=>{u.value&&u.value.getScrollInstance().enable()},rn=()=>{vt(),Z()},gt=()=>{y.value=!y.value},at=(e,o)=>{let f=JSON.parse(JSON.stringify(e));return f.content=o,f.word_total=o.length,f},Pe=c(!1),ze=c(1),ht=({index:e,beforeContent:o,selectedContent:f,afterContent:O,isFullSelection:B})=>{const k=[...z.value];Pe.value=B,ze.value=1,B?(k.splice(e+1,0,at(k[e],f)),k.splice(e,1)):(k[e].content=o||"",k[e].word_total=o.length||0,O.trim()&&k.splice(e+1,0,at(k[e],O)),k.splice(e+1,0,at(k[e],f)),k[e+1].images=[],k.splice(e,1)),z.value=k,He(k,e)},kt=({index:e,beforeContent:o,selectedContent:f,afterContent:O,isFullSelection:B})=>{const k=[...z.value];Pe.value=B,ze.value=2;let T=k[e+1].word_total;B?(k[e+1].content=+f,k[e+1].word_total=parseInt(T)+f.length,k.splice(e,1),z.value=k,He(k,e)):(k[e].content=o||"",k[e].word_total=o.length||0,k[e+1].content+=f,k[e+1].word_total=parseInt(T)+f.length,O.trim()&&(k[e].content+=O||"",k[e].word_total+=O.length||0),z.value=k,He(k,e+1))},yt=({index:e,beforeContent:o,selectedContent:f,afterContent:O,isFullSelection:B})=>{const k=[...z.value];Pe.value=B,ze.value=3;let T=k[e-1].word_total;B?(k[e-1].content+=f,k[e-1].word_total=parseInt(T)+f.length,k.splice(e,1),z.value=k,He(k,e)):(k[e].content=o||"",k[e].word_total=o.length||0,k[e-1].content+=f,k[e-1].word_total=parseInt(T)+f.length,O.trim()&&(k[e].content+=O||"",k[e].word_total+=O.length||0),z.value=k,He(k,e-1))},bt=({index:e,beforeContent:o,afterContent:f,isFullSelection:O})=>{const B=[...z.value];Pe.value=O,ze.value=4,O?B.splice(e,1):(B[e].content=o||"",B[e].word_total=o.length||0,f.trim()&&(B[e].content+=f||"",B[e].word_total+=f.length||0)),z.value=B,He(B,e)};function un(e,o,f={},O){let B=O+1;if(!Array.isArray(e)||!Array.isArray(o))return JSON.stringify([]);const k=e.map((T,Ce)=>{const V={};for(const X of o){const Ee=f[X]||X,de=T[Ee];if(Object.prototype.hasOwnProperty.call(T,Ee))if(X==="number")V[X]=Ce+1;else if(X==="father_chunk_paragraph_number")V[X]=+de;else if(X==="page_num"||X==="word_total")V[X]=+de;else if(X==="content"){if(!de)return null;V[X]=de}else X==="images"?ze.value==1?Pe.value?(B==V.number,V[X]=de):B+1==V.number?V[X]=[]:V[X]=de:ze.value==2?(Pe.value,B==V.number,V[X]=de):ze.value==3?Pe.value?(B-1==V.number,V[X]=de):(B==V.number,V[X]=de):ze.value==4&&(Pe.value,V[X]=de):V[X]=de}return V}).filter(T=>T!==null&&T.content!==void 0&&T.content!=="");return JSON.stringify(k)}const cn={similar_question_list:"similar_questions"},He=async(e,o)=>{let f={...l,semantic_chunk_model_config_id:l.semantic_chunk_model_config_id?+l.semantic_chunk_model_config_id:0,ai_chunk_model_config_id:l.ai_chunk_model_config_id?+l.ai_chunk_model_config_id:0,is_table_file:d.value};delete f.id;let O={id:H.query.id,word_total:Se.value,split_params:JSON.stringify(f),list:un(e,["number","father_chunk_paragraph_number","page_num","title","content","question","similar_question_list","answer","word_total","images"],cn,o)};f.is_qa_doc==1&&(O.qa_index_type=f.qa_index_type),G.value=!0,Rn(O).then(B=>{ge.success("操作成功");const k=B.data;for(let T=0;T<k.length;T++){const Ce=k[T],V=z.value[T];if(T<z.value.length)V.id=Ce.toString(),V.status="0",V.status_text=Re[V.status];else break}}).finally(()=>{G.value=!1})};function dn(){K.value.show(!0,w.value)}return Ue(()=>{Q(),H.query.graph_status&&(M.graph_status=H.query.graph_status,Z())}),(e,o)=>{var xt,Ct,$t;const f=Mn("router-link"),O=Zn,B=jn,k=Ke,T=At,Ce=Kn,V=Qt,X=Gt,Ee=ut,de=rt,St=ct,_n=Qn,pn=je,Qe=Xe,wt=Xn,fn=Vn,mn=Yn,vn=Wn,gn=lt("viewer");return r(),m("div",hl,[a("div",kl,[t(B,null,{default:i(()=>[t(O,null,{default:i(()=>[t(f,{to:"/library/list"},{default:i(()=>[...o[8]||(o[8]=[C(" 知识库管理 ",-1)])]),_:1})]),_:1}),t(O,null,{default:i(()=>[t(f,{to:{path:"/library/details/knowledge-document",query:{id:s.value.library_id}}},{default:i(()=>[a("div",yl,ae(s.value.library_name)+"知识库",1)]),_:1},8,["to"])]),_:1}),t(O,null,{default:i(()=>[...o[9]||(o[9]=[C("知识库详情",-1)])]),_:1})]),_:1}),a("div",bl,[t(ea,{startLists:N.value,onChange:p},null,8,["startLists"])])]),a("div",Sl,[t(Y(Gn),{onClick:_e}),a("span",wl,ae(s.value.file_name),1),t(So,{detailsInfo:s.value},null,8,["detailsInfo"])]),a("div",xl,[a("div",Cl,[y.value?(r(),j(T,{key:1,onClick:o[1]||(o[1]=te=>gt())},{default:i(()=>[t(k,{class:"preview-box-icon",name:"expand"}),o[11]||(o[11]=C(" 展开预览",-1))]),_:1})):(r(),j(T,{key:0,onClick:o[0]||(o[0]=te=>gt())},{default:i(()=>[t(k,{class:"preview-box-icon",name:"put-away"}),o[10]||(o[10]=C(" 收起预览",-1))]),_:1}))]),t(_n,null,{default:i(()=>[t(Ce,{value:M.search,"onUpdate:value":o[2]||(o[2]=te=>M.search=te),placeholder:"搜索内容",style:{width:"200px"},allowClear:"",onChange:Z},null,8,["value"]),S.value?(r(),j(X,{key:0,value:M.status,"onUpdate:value":o[3]||(o[3]=te=>M.status=te),placeholder:"请选择",style:{width:"160px"},onChange:Z},{default:i(()=>[t(V,{value:-1},{default:i(()=>[...o[12]||(o[12]=[C("全部嵌入状态",-1)])]),_:1}),(r(),m(fe,null,$e(Re,(te,Ae)=>t(V,{key:te,value:Ae},{default:i(()=>[C(ae(te),1)]),_:2},1032,["value"])),64))]),_:1},8,["value"])):U("",!0),s.value.graph_switch?(r(),j(X,{key:1,value:M.graph_status,"onUpdate:value":o[4]||(o[4]=te=>M.graph_status=te),placeholder:"请选择",onChange:Z,style:{width:"160px"}},{default:i(()=>[t(V,{value:-1},{default:i(()=>[...o[13]||(o[13]=[C("全部知识图谱状态",-1)])]),_:1}),(r(),m(fe,null,$e(P,(te,Ae)=>t(V,{key:te,value:Ae},{default:i(()=>[C(ae(te),1)]),_:2},1032,["value"])),64))]),_:1},8,["value"])):U("",!0),t(T,{onClick:dn},{default:i(()=>[...o[14]||(o[14]=[C("修改元数据",-1)])]),_:1}),t(St,null,{overlay:i(()=>[t(de,null,{default:i(()=>[t(Ee,{onClick:Zt},{default:i(()=>[...o[15]||(o[15]=[C("重新嵌入向量",-1)])]),_:1}),s.value.graph_switch?(r(),j(Ee,{key:0,onClick:Kt},{default:i(()=>[...o[16]||(o[16]=[C("重新抽取知识图谱",-1)])]),_:1})):U("",!0),t(Ee,{onClick:Xt},{default:i(()=>[...o[17]||(o[17]=[C("重命名",-1)])]),_:1}),b.value==2?(r(),j(Ee,{key:1,onClick:Yt},{default:i(()=>[...o[18]||(o[18]=[C("设置更新频率",-1)])]),_:1})):U("",!0)]),_:1})]),default:i(()=>[t(T,null,{default:i(()=>[o[19]||(o[19]=C("其他操作 ",-1)),t(Y(Ot))]),_:1})]),_:1}),b.value!=3?(r(),j(T,{key:2,onClick:pt},{default:i(()=>[...o[20]||(o[20]=[C("重新分段",-1)])]),_:1})):U("",!0),t(T,{onClick:o[5]||(o[5]=te=>Fe({})),type:"primary"},{icon:i(()=>[t(Y(Ht))]),default:i(()=>[o[21]||(o[21]=a("span",null,"添加分段",-1))]),_:1})]),_:1})]),W.value?(r(),m("div",$l,[t(pn)])):(r(),m(fe,{key:1},[S.value?(r(),m(fe,{key:0},[g.value?(r(),j(ot,{key:0,onOpenEditSubscription:Fe})):(r(),j(Be,{key:1,scrollbar:{minSize:0},onOnScrollEnd:xe},{default:i(()=>[a("div",Ll,[t(fl,{ref:"subsectionBoxRef",total:Se.value,paragraphLists:z.value,search:M.search,detailsInfo:s.value,onOpenEditSubscription:Fe,onHandleDelParagraph:ke,onHandleConvert:Me,onGetStatrList:L},null,8,["total","paragraphLists","search","detailsInfo"])])]),_:1}))],64)):(r(),m(fe,{key:1},[oe.value||b.value==3?(r(),m(fe,{key:0},[g.value?(r(),j(ot,{key:0,onOpenEditSubscription:Fe})):(r(),j(Be,{key:1,scrollbar:{minSize:0},onOnScrollEnd:xe,disableMouse:!0},{default:i(()=>[a("div",ql,[t(It,{ref:"subsectionBoxRef",total:Se.value,detailsInfo:s.value,paragraphLists:z.value,search:M.search,onOpenEditSubscription:Fe,onHandleDelParagraph:ke,onHandleConvert:Me,onHandleScrollTargetPage:ft,onGetStatrList:L,onHandleSplit:ht,onHandleSplitNext:kt,onHandleSplitUp:yt,onHandleSplitDelete:bt,onHandleSegmentation:mt},null,8,["total","detailsInfo","paragraphLists","search"])])]),_:1}))],64)):(r(),m("div",Ol,[a("div",{class:st(["view-content-wrap",{collapsed:y.value}])},[((xt=s.value)==null?void 0:xt.file_ext)=="pdf"?(r(),m("div",El,[t(fn,{value:re.value,"onUpdate:value":o[6]||(o[6]=te=>re.value=te)},{default:i(()=>[t(wt,{value:1},{default:i(()=>[t(Qe,{placement:"right",title:"原文预览模式下，会展示pdf原始文件内容，手动编辑分段的不会展示。您可以通过原文预览模式，校验分段准确性，然后手动编辑分段。"},{default:i(()=>[o[22]||(o[22]=C(" 原文预览 ",-1)),re.value==1&&Ge.value>0?(r(),m("span",Il,"("+ae(Ye.value)+" / "+ae(Ge.value)+")",1)):U("",!0)]),_:1})]),_:1}),t(wt,{value:2},{default:i(()=>[...o[23]||(o[23]=[C("纯文本预览",-1)])]),_:1})]),_:1},8,["value"])])):U("",!0),((Ct=s.value)==null?void 0:Ct.file_ext)=="pdf"?(r(),m("div",Rl,[t(St,null,{overlay:i(()=>[t(de,{onClick:sn},{default:i(()=>[re.value==1&&Ge.value>0?(r(),j(Ee,{key:1},{default:i(()=>[t(Qe,{placement:"right",title:"将当前页重新解析并分段"},{default:i(()=>[...o[24]||(o[24]=[a("div",null,"将当页重新分段",-1)])]),_:1})]),_:1})):U("",!0),(r(),j(Ee,{key:2},{default:i(()=>[t(Qe,{placement:"right",title:"将整个文档重新分段，注意，重新分段并不会重新提取文档的内容，只是将内容重新分段。"},{default:i(()=>[...o[25]||(o[25]=[a("div",null,"将文档重新分段",-1)])]),_:1})]),_:1})),(r(),j(Ee,{key:3},{default:i(()=>[t(Qe,{placement:"right",title:"将整个文档重新学习，包含重新解析并提取文档内容，重新分段。"},{default:i(()=>[...o[26]||(o[26]=[a("div",null,"重新学习文档",-1)])]),_:1})]),_:1}))]),_:1})]),default:i(()=>[t(T,null,{default:i(()=>[o[27]||(o[27]=C(" 重新分段 ",-1)),t(Y(Ot))]),_:1})]),_:1})])):U("",!0),(($t=s.value)==null?void 0:$t.file_ext)=="pdf"&&re.value==1?(r(),j($o,{key:2,ref_key:"pdfRef",ref:u,class:"scroll-box pdf-render-box",source:v.value,onSelect:nn,onScroll:ln,onRendered:an,onGetTotalPage:on},null,8,["source"])):(r(),j(Be,{key:3,scrollbar:q.value,ref_key:"leftScrollRef",ref:ie,class:"scroll-box",onOnScrollEnd:xe},{default:i(()=>[a("div",Ml,[(r(!0),m(fe,null,$e(z.value,(te,Ae)=>(r(),m("div",{class:"list-item",onClick:Lt=>E(Ae),key:Ae},[te.question?(r(),m("div",Pl,ae(te.question),1)):U("",!0),te.answer?(r(),m("div",zl,ae(te.answer),1)):U("",!0),a("div",{class:"content-box",innerHTML:te.content},null,8,Fl),it((r(),m("div",Dl,[(r(!0),m(fe,null,$e(te.images,(Lt,hn)=>(r(),m("img",{key:hn,src:Lt,alt:""},null,8,Nl))),128))])),[[gn]])],8,Tl))),128))])]),_:1},8,["scrollbar"]))],2),a("div",Hl,[S.value?U("",!0):(r(),m("div",Al,[t(vn,{activeKey:M.status,"onUpdate:activeKey":o[7]||(o[7]=te=>M.status=te),style:{"background-color":"#f2f4f7",padding:"0px 16px","border-radius":"6px"},onChange:Z},{default:i(()=>[(r(!0),m(fe,null,$e(Ne,te=>(r(),j(mn,{key:te.value,tab:`${te.label} (${te.num})`},null,8,["tab"]))),128))]),_:1},8,["activeKey"])])),g.value?(r(),j(ot,{key:1,onOpenEditSubscription:Fe})):(r(),j(Be,{key:2,scrollbar:q.value,disableMouse:!0,ref_key:"rightScrollRef",ref:ve,onOnScrollEnd:xe},{default:i(()=>[a("div",Bl,[t(It,{ref:"subsectionBoxRef",total:Se.value,detailsInfo:s.value,paragraphLists:z.value,search:M.search,onOpenEditSubscription:Fe,onHandleDelParagraph:ke,onHandleConvert:Me,onHandleScrollTargetPage:ft,onGetStatrList:L,onHandleSplit:ht,onHandleSplitNext:kt,onHandleSplitUp:yt,onHandleSplitDelete:bt,onHandleSegmentation:mt},null,8,["total","detailsInfo","paragraphLists","search"])])]),_:1},8,["scrollbar"]))])]))],64))],64)),t(ra,{detailsInfo:s.value,onHandleEdit:pe,ref_key:"editSubscriptionRef",ref:Te},null,8,["detailsInfo"]),t(wo,{onOk:en,ref_key:"updateFrequencyRef",ref:dt},null,512),t(ua,{onOk:tn,ref_key:"renameModalRef",ref:_t},null,512),t(jo,{onOk:rn,onEnable:vt,detailsInfo:s.value,ref_key:"reSegmentationPageRef",ref:tt},null,8,["detailsInfo"]),t(gl,{ref_key:"segmentationSettingModalRef",ref:nt,onOk:J},null,512),t(ca,{ref_key:"metaRef",ref:K,"library-id":s.value.library_id,"file-id":Y(H).query.id},null,8,["library-id","file-id"])])}}},fs=Le(Jl,[["__scopeId","data-v-18971d06"]]);export{fs as default};
