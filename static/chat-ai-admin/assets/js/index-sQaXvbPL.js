import{_ as X,d as ue,aj as be,c as Fe,bh as Re}from"../../index-WMhSApoa.js";import{ac as s,ad as t,as as e,az as m,ai as K,F as A,ax as D,at as g,e as Q,f as E,ae as V,n as ie,k as r,ar as q,B as Ee,G as H,u as L,A as Oe,y as he,J as ge,q as we,w as $e,ah as Be,b as xe,I as De,r as Pe,av as He,aw as ke,aB as Ue,o as je,aA as ze}from"./vue-chunks-CGLjTDrY.js";import{u as Ne}from"./useEventBus-CB_rGuu7.js";import{u as qe}from"./chat-CdFBQxGM.js";import{_ as ve,V as Ve}from"./voice-message-CPXesPS1.js";import{M as Je}from"./multiple-message-CkTA4Qle.js";import{u as Ce}from"./robot-j5RxAo6l.js";import{al as Se,a5 as fe,aq as Qe,v as Le,ay as ye,b as ae,$ as Ke,ah as se,aA as Te,M as We,m as Ge,B as Ye,n as Xe,a6 as Ze}from"./ui-antd-BDReVt-O.js";import{_ as Me}from"./cu-scroll-D6f5DzhK.js";import{q as et}from"./other-BrZCAsTs.js";import{u as tt}from"./index-CxGFxpsV.js";import{h as st}from"./index-H1WgLCGf.js";import{V as ot}from"./vue3-pdf-embed-f9sqfmzc.js";import{a9 as nt}from"./index-CtAh6k0_.js";import"./neo4j-CK9lNpyi.js";import"./utils-DXEytJvC.js";import"./useIM-DUfDhtCg.js";import"./pull-up.esm-DIiTC7VE.js";import"./observe-dom.esm-B25JyVKH.js";import"./vue-pdf-embed-CmVBwGXE.js";const lt={class:"guess-you-want"},it={class:"message-tabs"},at={key:1,class:"v-line"},rt={key:0,class:"message-menus"},ct=["onClick"],ut={key:1,class:"message-menus"},dt=["onClick"],_t={__name:"guess-you-want",props:{item:{type:Object,default:()=>{}},common_question_list:{type:Object,default:()=>[]},enable_common_question:{type:Boolean,default:!1}},emits:["clickMeun"],setup(S,{emit:y}){const $=y,n=S,T=(d,o)=>{d.question_tabkey=o},h=d=>{$("clickMeun",d)};return(d,o)=>(t(),s("div",lt,[e("div",it,[n.item.guess_you_want?(t(),s("div",{key:0,onClick:o[0]||(o[0]=l=>T(n.item,1)),class:K(["tab-item",{active:n.item.question_tabkey==1}])}," 猜你想问 ",2)):m("",!0),n.item.guess_you_want&&n.common_question_list&&n.enable_common_question?(t(),s("div",at)):m("",!0),n.common_question_list&&n.enable_common_question?(t(),s("div",{key:2,onClick:o[1]||(o[1]=l=>T(n.item,2)),class:K(["tab-item",{active:n.item.question_tabkey==2}])}," 常见问题 ",2)):m("",!0)]),n.item.question_tabkey==1?(t(),s("div",rt,[(t(!0),s(A,null,D(n.item.guess_you_want,(l,p)=>(t(),s("div",{onClick:c=>h(l),class:"menu-item",key:p},g(l),9,ct))),128))])):(t(),s("div",ut,[(t(!0),s(A,null,D(S.common_question_list,(l,p)=>(t(),s("div",{onClick:c=>h(l),class:"menu-item",key:p},g(l),9,dt))),128))]))]))}},pt=X(_t,[["__scopeId","data-v-253226a8"]]),mt={class:"text-message"},gt={__name:"text-message",props:{message:String},setup(S){return(y,$)=>(t(),s("div",mt,g(S.message),1))}},vt={class:"message-list-wrapper"},ft={class:"message-list"},ht=["id","data-msg_type"],yt={class:"itme-left"},kt=["src"],bt={class:"itme-right"},wt={class:"item-body"},$t={key:0,class:"message-content"},xt=["src"],qt={key:1,class:"message-content"},Ct=["id"],St={class:"itme-left"},Lt=["src"],Tt={class:"itme-right"},Mt={key:0,class:"reply-list"},It={key:0,class:"reply-item reply-text"},At=["innerHTML"],Ft={key:1,class:"reply-item reply-image"},Rt={class:"message-content"},Et=["src"],Ot={key:2,class:"reply-item reply-url"},Bt={class:"url-row"},Dt=["href"],Pt={key:3,class:"reply-item reply-card"},Ht={class:"card-row"},Ut=["src"],jt={class:"card-title-box"},zt={class:"card-title"},Nt={key:4,class:"reply-item reply-imageText"},Vt=["href"],Jt=["src"],Qt={class:"imageText-text"},Kt={class:"imageText-title"},Wt={class:"imageText-desc"},Gt={key:5,class:"reply-item reply-smartMenu"},Yt={class:"smart-menu-box"},Xt={key:0,class:"card-title"},Zt={class:"card-text"},es={key:0,class:"line-text"},ts={key:1,class:"empty-line"},ss=["innerHTML"],os=["onClick"],ns={key:0},ls={class:"label-flex-block"},is={key:0,class:"thinking-label-wrapper"},as={class:"thinking-label"},rs={class:"label-text"},cs=["onClick"],us={class:"label-text"},ds=["onClick"],_s={class:"label-text"},ps={class:"item-body"},ms={key:0,class:"file-items"},gs=["onClick"],vs={class:"file-name"},fs={key:0},hs={key:1},ys={key:1,class:"thinking-content"},ks={class:"message-content"},bs={class:"message-menus"},ws=["onClick"],$s=["innerHTML"],xs={class:"message-menus"},qs=["onClick"],Cs={key:4,class:"message-content"},Ss=["src"],Ls={key:5,class:"message-action-wrap"},Ts={key:0,class:"message-action"},Ms={class:"action-btn"},Is=["onClick"],As={key:1},Fs={__name:"message-list",props:{messages:{type:Array,default:()=>[]},robotInfo:{type:Object,default:()=>{}}},emits:["clickMsgMeun","scroll","scrollStart","scrollEnd","openPromptLog","openLibrary"],setup(S,{expose:y,emit:$}){const n=Ce(),T=Q(()=>n.robotInfo.tips_before_answer_content),h=Q(()=>n.robotInfo.tips_before_answer_switch=="true"),d=$,o=S,l=_=>{_.show_reasoning=!_.show_reasoning},p=_=>{_.show_quote_file=!_.show_quote_file},c=Q(()=>o.robotInfo.common_question_list.length?JSON.parse(o.robotInfo.common_question_list):[]),a=Q(()=>(o.robotInfo.chat_type==1||o.robotInfo.chat_type==3)&&o.robotInfo.application_type=="0"),k=_=>{d("clickMsgMeun",_)},F=E(null),v={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let U=null,O=!1;function Z(_){O||(U&&(clearTimeout(U),U=null),U=setTimeout(()=>{v.scrollTop-_.target.scrollTop>0&&(v.scrollDirection="up"),v.scrollTop-_.target.scrollTop<0&&(v.scrollDirection="down"),v.scrollTop=_.target.scrollTop,v.scrollHeight=_.target.scrollHeight,v.clientHeight=_.target.clientHeight,d("scroll",{...v}),Math.abs(v.scrollTop)<=v.scrollStartDiff&&v.scrollDirection==="up"&&re(),Math.abs(v.scrollHeight-v.scrollTop-v.clientHeight)<=v.scrollEndDiff&&v.scrollDirection==="down"&&x()},50))}function re(){o.messages.length!=0&&d("scrollStart",{msg:o.messages[0]})}function x(){o.messages.length!=0&&d("scrollEnd",{msg:o.messages[o.messages.length-1]})}const f=()=>{F.value&&he(()=>{O=!0,F.value.scrollTop=F.value.scrollHeight+1,setTimeout(()=>{v.scrollTop=F.value.scrollTop,O=!1},50)})};function P(_,w){he(()=>{O=!0,w||(w="top");let M=F.value,I=document.querySelector("#msg-"+_);w=="top"?M.scrollTop=I.offsetTop:M.scrollTop=I.offsetTop-M.clientHeight+I.clientHeight,setTimeout(()=>{v.scrollTop=F.value.scrollTop,O=!1},50)})}function z(){v.scrollTop=0,v.scrollDirection=""}function W(_){return!!(_.quote_file&&_.quote_file.length>0||_.debug&&_.debug.length>0)}function ee(_){d("openPromptLog",ge(_))}function oe(_,w,M){let I=ge(_);w.message_id=w.message_id||M,I.forEach(B=>{B.message_id=B.message_id||M}),d("openLibrary",I,ge(w))}function b(_){try{return _?Array.isArray(_)?_:typeof _=="string"?JSON.parse(_||"[]"):[]:[]}catch{return[]}}function N(_){const w=[];return(Array.isArray(_)?_:[]).forEach(M=>{const I=String((M==null?void 0:M.menu_type)||""),B=String((M==null?void 0:M.content)||"");if(I==="0")if(B==="")w.push({kind:"newline"});else if(/<a[\s\S]*?<\/a>/.test(B)){const G=/href\s*=\s*['"]\s*#\s*['"]/i.test(B)?B.replace(/href\s*=\s*['"]\s*#\s*['"]/ig,'href="javascript:;"'):B.replace(/href=/ig,'target="_blank" href=');w.push({kind:"html",html:G})}else w.push({kind:"text",text:B});else I==="1"&&w.push({kind:"keyword",text:B,serial_no:(M==null?void 0:M.serial_no)||""})}),w.slice(0,20)}function ne(_){var I,B;const w=(B=(I=_.target)==null?void 0:I.closest)==null?void 0:B.call(I,"a");if(!w)return;const M=String(w.getAttribute("href")||"");(M==="#"||M==="javascript:;")&&(_.preventDefault(),_.stopPropagation())}function _e(_){const w=String(_||"").trim();w&&d("clickMsgMeun",w)}return y({scrollToBottom:f,scrollToMessage:P,resetScroll:z}),(_,w)=>{const M=Se,I=ue,B=Le,G=we("viewer");return t(),s("div",vt,[e("div",{class:"scroll-box",ref_key:"scrollBoxRef",ref:F,onScroll:Z},[e("div",ft,[(t(!0),s(A,null,D(o.messages,i=>(t(),s(A,{key:i.uid},[i.is_customer==1?(t(),s("div",{key:0,class:"message-item user-message",id:"msg-"+i.uid,"data-msg_type":i.msg_type},[e("div",yt,[e("img",{class:"user-avatar",src:i.avatar},null,8,kt)]),e("div",bt,[e("div",wt,[i.msg_type==3?(t(),s("div",$t,[ie(e("img",{class:"msg-img",src:i.media_id_to_oss_url,alt:""},null,8,xt),[[G]])])):i.msg_type==99?(t(),s("div",qt,[r(Je,{message:i.content},null,8,["message"])])):(t(),V(gt,{key:2,class:"message-content",message:i.content},null,8,["message"]))])])],8,ht)):(t(),s("div",{key:1,class:"message-item robot-message",id:"msg-"+i.uid},[e("div",St,[r(M,{size:"small",spinning:i.loading},{default:q(()=>[e("img",{class:"robot-avatar",src:i.robot_avatar},null,8,Lt)]),_:2},1032,["spinning"])]),e("div",Tt,[b(i.reply_content_list).length?(t(),s("div",Mt,[(t(!0),s(A,null,D(b(i.reply_content_list),(u,J)=>{var le;return t(),s(A,{key:J},[(u.reply_type||u.type)==="text"?(t(),s("div",It,[e("div",{class:"message-content",innerHTML:u.description},null,8,At)])):(u.reply_type||u.type)==="image"?(t(),s("div",Ft,[e("div",Rt,[ie(e("img",{class:"msg-img",src:u.pic||u.thumb_url},null,8,Et),[[G]])])])):(u.reply_type||u.type)==="url"?(t(),s("div",Ot,[e("div",Bt,[e("a",{class:"url-link",href:u.url,target:"_blank"},g(u.url),9,Dt)])])):(u.reply_type||u.type)==="card"?(t(),s("div",Pt,[e("div",Ht,[u.thumb_url?(t(),s("img",{key:0,src:u.thumb_url,class:"card-thumb"},null,8,Ut)):m("",!0),e("div",jt,[r(I,{class:"think-icon",name:"applet"}),e("span",zt,g(u.title),1)])])])):(u.reply_type||u.type)==="imageText"?(t(),s("div",Nt,[e("a",{class:"imageText-row",href:u.url,target:"_blank"},[u.thumb_url?(t(),s("img",{key:0,src:u.thumb_url,class:"imageText-thumb"},null,8,Jt)):m("",!0),e("div",Qt,[e("div",Kt,g(u.title),1),e("div",Wt,g(u.description),1)])],8,Vt)])):(u.reply_type||u.type)==="smartMenu"?(t(),s("div",Gt,[e("div",Yt,[u.smart_menu&&u.smart_menu.menu_description?(t(),s("div",Xt,g(u.smart_menu.menu_description),1)):m("",!0),e("div",Zt,[(t(!0),s(A,null,D(N(((le=u.smart_menu)==null?void 0:le.menu_content)||[]),(j,pe)=>(t(),s("div",{key:pe,class:"reply-line",onClick:w[0]||(w[0]=ce=>ne(ce))},[j.kind==="text"?(t(),s("span",es,g(j.text),1)):j.kind==="newline"?(t(),s("div",ts)):j.kind==="html"?(t(),s("span",{key:2,innerHTML:j.html},null,8,ss)):j.kind==="keyword"?(t(),s("a",{key:3,href:"javascript:;",class:"link",onClick:Ee(ce=>_e(j.text),["prevent"])},[j.serial_no?(t(),s("div",ns,g(j.serial_no),1)):m("",!0),H(" "+g(j.text),1)],8,os)):m("",!0)]))),128))])])])):m("",!0)],64)}),128))])):m("",!0),e("div",ls,[h.value&&i.startLoading?(t(),s("div",is,[e("div",as,[r(L(fe),{class:"loading"}),e("span",rs,g(T.value),1)])])):m("",!0),i.msg_type==1&&a.value&&(!i.startLoading||!h.value)?(t(),s("div",{key:1,class:K(["thinking-label-wrapper",{reasoning_open:i.show_quote_file}])},[e("div",{class:"thinking-label",onClick:u=>p(i)},[i.quote_loading?(t(),s(A,{key:0},[r(L(fe),{class:"loading"}),w[1]||(w[1]=e("span",{class:"label-text"},"正在检索知识库...",-1))],64)):m("",!0),i.quote_loading?m("",!0):(t(),s(A,{key:1},[r(I,{class:"think-icon",name:"quote-file"}),e("span",us,"检索到"+g(i.quote_file.length)+"个知识库文档",1)],64)),i.quote_file.length?(t(),V(I,{key:2,name:"arrow-down",class:"arrow-down"})):m("",!0)],8,cs)],2)):m("",!0),i.reasoning_content?(t(),s("div",{key:2,class:K(["thinking-label-wrapper",{reasoning_open:i.show_reasoning}])},[e("div",{class:"thinking-label",onClick:u=>l(i)},[i.reasoning_status?(t(),V(L(fe),{key:0,class:"loading"})):(t(),V(I,{key:1,class:"think-icon",name:"think"})),e("span",_s,g(i.reasoning_status?"深度思考中...":"已完成深度思考"),1),i.reasoning_status?m("",!0):(t(),V(I,{key:2,name:"arrow-down",class:"arrow-down"}))],8,ds),r(B,null,{title:q(()=>[...w[2]||(w[2]=[H("在应用设置中关闭推理过程开关，将不再显示推理过程",-1)])]),default:q(()=>[r(L(Qe),{class:"tip"})]),_:1})],2)):m("",!0)]),e("div",ps,[i.show_quote_file&&i.quote_file&&i.quote_file.length>0?(t(),s("div",ms,[(t(!0),s(A,null,D(i.quote_file,u=>(t(),s("div",{class:"file-item",key:u.id,onClick:J=>oe(i.quote_file,u,i.id)},[e("a",vs,[r(I,{class:"think-icon",name:"quote-file"}),u.file_name?(t(),s("span",fs,g(u.file_name),1)):(t(),s("span",hs,g(u.library_name)+"-精选",1))])],8,gs))),128))])):m("",!0),i.show_reasoning&&i.reasoning_content?(t(),s("div",ys,[r(ve,{content:i.reasoning_content},null,8,["content"])])):m("",!0),i.msg_type==1?(t(),s(A,{key:2},[ie((t(),s("div",ks,[r(ve,{content:i.content},null,8,["content"])])),[[G]]),e("div",bs,[(t(!0),s(A,null,D(i.question,(u,J)=>(t(),s("div",{class:"menu-item",onClick:le=>k(u),key:J},g(u),9,ws))),128))])],64)):m("",!0),i.msg_type==2?(t(),s(A,{key:3},[i.isWelcome?(t(),V(ve,{key:0,class:"markdown-content",content:i.menu_json.content},null,8,["content"])):(t(),s("div",{key:1,class:"message-content",innerHTML:i.menu_json.content},null,8,$s)),e("div",xs,[(t(!0),s(A,null,D(i.menu_json.question,(u,J)=>(t(),s("div",{class:"menu-item",onClick:le=>k(u),key:J},g(u),9,qs))),128))])],64)):m("",!0),i.msg_type==3?(t(),s("div",Cs,[ie(e("img",{class:"msg-img",src:i.content,alt:""},null,8,Ss),[[G]])])):m("",!0),W(i)?ie((t(),s("div",Ls,[i.debug&&i.debug.length>0?(t(),s("div",Ts,[e("div",Ms,[e("span",null,[e("a",{onClick:u=>ee(i)},"Prompt 日志",8,Is)])])])):m("",!0)],512)),[[Oe,!i.question]]):m("",!0)]),i.voice_content&&i.voice_content.length?(t(),s("div",As,[r(Ve,{voice_content:i.voice_content},null,8,["voice_content"])])):m("",!0),(i.guess_you_want&&i.guess_you_want.length||c.value.length&&o.robotInfo.enable_common_question=="true")&&i.question_tabkey>0?(t(),V(pt,{key:2,item:i,enable_common_question:o.robotInfo.enable_common_question=="true",common_question_list:c.value,onClickMeun:k},null,8,["item","enable_common_question","common_question_list"])):m("",!0)])],8,Ct))],64))),128))])],544)])}}},Rs=X(Fs,[["__scopeId","data-v-c2b4c934"]]),Es={class:"chat-list-box"},Os=["onClick"],Bs={class:"chat-item-title"},Ds={__name:"chat-list",props:{list:{type:Array,default:()=>[]},active:{type:[String,Number],default:""}},emits:["openChat","onScrollEnd"],setup(S,{emit:y}){const $=y,n=S,T=E(null),h=o=>{$("openChat",o)},d=()=>{$("onScrollEnd")};return $e(()=>n.list,()=>{he(()=>{T.value.refresh()})}),(o,l)=>{const p=ue;return t(),s("div",Es,[r(Me,{ref_key:"scroller",ref:T,onOnScrollEnd:d},{default:q(()=>[e("div",null,[(t(!0),s(A,null,D(n.list,c=>(t(),s("div",{class:K(["chat-list-item",{active:c.id==n.active}]),onClick:a=>h(c),key:c.id},[r(p,{class:"chat-item-icon",name:"message"}),e("span",Bs,g(c.subject||c.last_chat_message),1)],10,Os))),128))])]),_:1},512)])}}},Ps=X(Ds,[["__scopeId","data-v-4b3af25b"]]),Hs={class:"file-toolbar"},Us={class:"toolbar-left"},js={class:"file-list"},zs={key:0,class:"delete-btn action-btn"},Ns={key:1,class:"preview-btn action-btn"},Vs=["src"],Js={key:2,class:"progress-bar"},Qs={key:3,class:"error-text"},Ks={__name:"file-toolbar",props:{fileList:{type:Array,default:()=>[]}},emits:["add","delete"],setup(S,{emit:y}){const $=S,n=y,T=Q(()=>$.fileList.map(o=>o.url)),h=o=>{et({options:{toolbar:!0,initialViewIndex:o},images:T.value}).show()},d=o=>{n("delete",o)};return(o,l)=>{const p=ue;return t(),s("div",Hs,[e("div",Us,[e("div",js,[(t(!0),s(A,null,D(S.fileList,(c,a)=>(t(),s("div",{key:a,class:K(["file-item",{uploading:c.status==="uploading",error:c.status==="error"}])},[c.status=="done"||c.status=="error"?(t(),s("span",zs,[r(L(ye),{class:"delete-icon",onClick:k=>d(a)},null,8,["onClick"])])):m("",!0),c.status=="done"?(t(),s("span",Ns,[r(p,{class:"preview-icon",name:"eye-open",onClick:k=>h(a)},null,8,["onClick"])])):m("",!0),e("img",{src:c.url,alt:"avatar"},null,8,Vs),l[0]||(l[0]=e("div",{class:"mask"},null,-1)),c.status==="uploading"?(t(),s("div",Js,[e("div",{class:"progress",style:Be({width:c.percent+"%"})},null,4)])):m("",!0),c.status==="error"?(t(),s("div",Qs,"上传失败")):m("",!0)],2))),128))])])])}}},Ws=X(Ks,[["__scopeId","data-v-69709643"]]),Gs=(S,y,$)=>new Promise((n,T)=>{tt({file:S.originFile,category:$},h=>{const d=Math.round(h.loaded*100/h.total),o=y.value.find(l=>l.uid===S.uid);if(o){const l={...o,percent:d},p=y.value.findIndex(c=>c.uid===S.uid);p!==-1&&y.value.splice(p,1,l)}}).then(h=>{const d=y.value.find(o=>o.uid===S.uid);if(d){const o={...d,percent:100,status:"done",url:h.data.link||""},l=y.value.findIndex(p=>p.uid===S.uid);l!==-1&&y.value.splice(l,1,o),n(o)}}).catch(h=>{const d=y.value.find(o=>o.uid===S.uid);if(d){const o={...d,status:"error"},l=y.value.findIndex(p=>p.uid===S.uid);l!==-1&&y.value.splice(l,1,o)}T(h)})});function Ys(S){const{limit:y=10,maxSize:$=10,accept:n="image/*",multiple:T=!0,category:h,fileList:d=E([])}=S||{};if(!h)throw new Error("category is required");let o=null;const l=a=>{let k=Array.from(a.target.files);const F=y-d.value.length;if(F<=0){ae.error(`最多只能上传 ${y} 张图片`);return}k.length>F&&(k=k.slice(0,F),ae.error(`最多只能上传 ${y} 张图片，已为您选择前 ${F} 张`)),k.forEach(v=>{if(!(v.size/1024/1024<$)){ae.error(`文件大小不能超过 ${$}MB!`);return}const O=v.type;if(!n.split(",").map(f=>f.trim()).some(f=>f.endsWith("/*")?O.startsWith(f.slice(0,-1)):O===f)){ae.error(`不支持的文件类型: ${O}`);return}const x={uid:v.uid||be(16),name:v.name,status:"uploading",percent:0,originFile:v,url:URL.createObjectURL(v)};d.value.push(x),Gs(x,d,h).then(f=>{const P=d.value.findIndex(z=>z.uid===f.uid);P!==-1&&d.value.splice(P,1,f)}).catch(()=>{const f=d.value.findIndex(P=>P.uid===x.uid);f!==-1&&(d.value[f].status="error")})}),a.target.value=""},p=()=>{const a=document.createElement("input");return a.type="file",a.accept=n,a.multiple=T,a.style.display="none",a.onchange=l,document.body.appendChild(a),a},c=()=>{if(d.value.length>=y){ae.error(`最多只能上传 ${y} 张图片`);return}o||(o=p()),o.click()};return xe(()=>{o&&document.body.contains(o)&&(document.body.removeChild(o),o=null)}),{openFileDialog:c}}const Xs={class:"message-input-wrapper"},Zs={key:0,class:"file-toolbar-box"},eo={class:"message-input-box"},to={class:"message-action"},so=["disabled"],oo={__name:"message-input",props:{value:{type:String,default:""},loading:{type:Boolean,default:!1},fileList:{type:Array,default:()=>[]},showUpload:{type:Boolean,default:!1}},emits:["send","update:value","update:fileList"],setup(S,{emit:y}){const $=y,n=S,{fileList:T}=De(n),{openFileDialog:h}=Ys({limit:10,maxSize:10,category:"chat_image",fileList:T,multiple:!0,accept:"image/bmp,image/jpeg,image/png,image/tiff,image/heic,image/gif,image/webp"}),d=a=>{const k=n.fileList.filter((F,v)=>v!==a);$("update:fileList",k)},o=Q(()=>n.fileList.length>0?!1:n.loading||n.value.trim().length===0),l=a=>{$("update:value",a.target.value.trim())},p=a=>{if(a.key==="Enter"&&!a.shiftKey){if(!a.target.value.trim())return;a.preventDefault(),a.stopPropagation(),c()}else a.key==="Enter"&&a.shiftKey&&(a.preventDefault(),a.stopPropagation(),$("update:value",n.value+`
`))},c=()=>{$("send",n.value.trim())};return(a,k)=>{const F=Ke,v=ue,U=Se;return t(),s("div",Xs,[n.fileList.length>0?(t(),s("div",Zs,[r(Ws,{"file-list":n.fileList,onDelete:d},null,8,["file-list"])])):m("",!0),e("div",eo,[r(F,{class:"message-input",value:n.value,placeholder:"在此输入您想了解的内容，Shift+Enter换行","auto-size":{minRows:2,maxRows:5},onChange:l,onKeydown:p},null,8,["value"])]),e("div",to,[n.showUpload?(t(),s("div",{key:0,class:"select-file-btn",onClick:k[0]||(k[0]=(...O)=>L(h)&&L(h)(...O))},[r(v,{class:"select-file-icon",name:"circularNeedle"}),L(T).length>0?(t(),s("span",{key:0,class:K(["file-number",{big:L(T).length>9}])},g(L(T).length),3)):m("",!0)])):m("",!0),e("button",{class:K(["send-msg-btn",{loading:n.loading}]),disabled:o.value,onClick:c},[n.loading?(t(),V(U,{key:0,size:"small",class:"loading-action",style:{"margin-right":"4px"}})):(t(),V(v,{key:1,class:"paper-airplane",name:"paper-airplane"}))],10,so)])])}}},no=X(oo,[["__scopeId","data-v-e330362d"]]),lo={class:"prompt-log-content"},io={class:"prompt-log-items"},ao={class:"prompt-log-label"},ro={class:"prompt-log-item"},co={class:"prompt-log-items"},uo={class:"prompt-log-label"},_o={class:"prompt-log-items"},po={class:"prompt-log-label"},mo={class:"prompt-log-item"},go={class:"prompt-log-items"},vo={class:"prompt-log-label"},fo={class:"prompt-log-item"},ho={key:0,class:"prompt-log-items"},yo={class:"prompt-log-label"},ko={class:"prompt-log-item"},bo={key:1,class:"prompt-log-items"},wo={class:"prompt-log-label"},$o={class:"prompt-log-item"},xo={class:"prompt-log-items"},qo={class:"prompt-log-label"},Co={class:"prompt-log-item"},So={__name:"prompt-log-alert",setup(S,{expose:y}){const $=E(!1),n=Pe({prompt:"",library:[],context_qa:[],cur_question:"",cur_answer:"",error:""}),T=()=>{$.value=!1},h=()=>{n.prompt="",n.library=[],n.context_qa=[],n.cur_question="",n.cur_answer="",n.error="",n.recall_time="",n.request_time=""};return y({open:o=>{h(),n.error=o.error,n.recall_time=o.recall_time?(o.recall_time/1e3).toFixed(2):"",n.request_time=o.request_time?(o.request_time/1e3).toFixed(2):"";let l=o.debug||[];for(let p=0;p<l.length;p++){let c=l[p];c.type=="library"?n.library.push(c.content):c.type=="context_qa"?n.context_qa.push(c):n[c.type]=c.content}$.value=!0}}),(o,l)=>{const p=Le,c=Te;return t(),V(c,{class:"prompt-log-alert",open:$.value,"onUpdate:open":l[0]||(l[0]=a=>$.value=a),title:"Prompt 日志",placement:"right",width:"746px",closable:!1},{extra:q(()=>[e("span",{class:"close-btn",onClick:T},[r(L(ye))])]),default:q(()=>[e("div",lo,[e("div",io,[e("div",ao,[l[2]||(l[2]=e("span",null,"提示词 ",-1)),r(p,null,{title:q(()=>[...l[1]||(l[1]=[H("系统提示词和文档分段。",-1)])]),default:q(()=>[r(L(se),{class:"question-icon"})]),_:1})]),e("div",ro,[e("p",null,g(n.prompt),1)]),(t(!0),s(A,null,D(n.library,(a,k)=>(t(),s("div",{class:"prompt-log-item",key:k},[e("p",null,g(a),1)]))),128))]),e("div",co,[e("div",uo,[l[4]||(l[4]=e("span",null,"上下文 ",-1)),r(p,null,{title:q(()=>[...l[3]||(l[3]=[H("传递的历史提问消息",-1)])]),default:q(()=>[r(L(se),{class:"question-icon"})]),_:1})]),(t(!0),s(A,null,D(n.context_qa,(a,k)=>(t(),s("div",{class:"prompt-log-item",key:k},[e("p",null,"Q："+g(a.question),1),e("p",null,"A："+g(a.answer),1)]))),128))]),e("div",_o,[e("div",po,[l[6]||(l[6]=e("span",null,"USER ",-1)),r(p,null,{title:q(()=>[...l[5]||(l[5]=[H("本次用户的提问",-1)])]),default:q(()=>[r(L(se),{class:"question-icon"})]),_:1})]),e("div",mo,[e("p",null,g(n.cur_question),1)])]),e("div",go,[e("div",vo,[l[8]||(l[8]=e("span",null,"ASSISTANT ",-1)),r(p,null,{title:q(()=>[...l[7]||(l[7]=[H("语言模型输出的答案",-1)])]),default:q(()=>[r(L(se),{class:"question-icon"})]),_:1})]),e("div",fo,[e("p",null,g(n.cur_answer),1)])]),n.recall_time>0?(t(),s("div",ho,[e("div",yo,[l[10]||(l[10]=e("span",null,"Recall time ",-1)),r(p,null,{title:q(()=>[...l[9]||(l[9]=[H("从知识库中检索到有效分段所需要的时间，包括对分段进行排序时间。",-1)])]),default:q(()=>[r(L(se),{class:"question-icon"})]),_:1})]),e("div",ko,[e("p",null,g(n.recall_time)+"s",1)])])):m("",!0),n.request_time>0?(t(),s("div",bo,[e("div",wo,[l[12]||(l[12]=e("span",null,"Request time ",-1)),r(p,null,{title:q(()=>[...l[11]||(l[11]=[H("从发送问题和上下文信息给大模型到大模型开始返回答案的时间。",-1)])]),default:q(()=>[r(L(se),{class:"question-icon"})]),_:1})]),e("div",$o,[e("p",null,g(n.request_time)+"s",1)])])):m("",!0),e("div",xo,[e("div",qo,[l[14]||(l[14]=e("span",null,"Error ",-1)),r(p,null,{title:q(()=>[...l[13]||(l[13]=[H("报错信息，调用聊天接口报错时会显示。",-1)])]),default:q(()=>[r(L(se),{class:"question-icon"})]),_:1})]),e("div",Co,[e("p",null,g(n.error),1)])])])]),_:1},8,["open"])}}},Lo=X(So,[["__scopeId","data-v-d8a3a35d"]]),To={class:"library-info-content"},Mo={class:"file-list"},Io=["onClick"],Ao={key:0},Fo={key:1},Ro={class:"document-items"},Eo={class:"document-item-header"},Oo={class:"left-box"},Bo={class:"document-title"},Do={key:0,class:"document-title"},Po={class:"document-size"},Ho={class:"right-box"},Uo=["onClick"],jo={class:"document-item-body"},zo={class:"document-similarity"},No={key:0,class:"document-content"},Vo={key:1,class:"document-content"},Jo={class:"document-content"},Qo={class:"fragment-img"},Ko=["src"],Wo={class:"iframe-box"},Go={__name:"library-info-alert",setup(S,{expose:y}){const $=qe(),{robot:n,user:T}=$;He();const h=E(!1),d=E([]),o=E(null),l=()=>{d.value=[],o.value=null},p=(x,f)=>{if(l(),d.value=x.map(P=>{let z=null;return P.answer_source_data&&(z=JSON.parse(P.answer_source_data)),{...P,answer_source_data:z}}),o.value=f.id,h.value=!0,f.answer_source_data){a.value=JSON.parse(f.answer_source_data)||[];return}k(f)},c=x=>{if(x.id!=o.value){if(o.value=x.id,x.answer_source_data){a.value=x.answer_source_data||[];return}k(x)}},a=E([]),k=x=>{st({message_id:x.message_id,file_id:x.id,robot_key:n.robot_key,openid:n.openid}).then(f=>{a.value=f.data||[]})},F=()=>{let x=d.value.filter(f=>f.id==o.value)[0]||{};x.file_name?window.open(`#/library/preview?id=${o.value}`):window.open(`#/library/details/categary-manage?id=${x.library_id}`)},v=Q(()=>{let x=d.value.filter(f=>f.id==o.value)[0]||{};return x.file_name?x.file_name:x.library_name+"-精选"}),U=E(""),O=E(!1),Z=x=>{O.value=!0,U.value="/manage/getLibRawFileOnePage?id="+o.value+"&page="+x.page_num+"&admin_user_id="+T.admin_user_id},re=()=>{h.value=!1};return y({open:p}),(x,f)=>{const P=ue,z=Te,W=Me,ee=We,oe=we("viewer");return t(),s(A,null,[r(z,{class:"library-info-alert",open:h.value,"onUpdate:open":f[0]||(f[0]=b=>h.value=b),title:"答案来源",placement:"right",width:"746px",closable:!1,bodyStyle:{background:"#F2F4F7"}},{extra:q(()=>[e("span",{class:"close-btn",onClick:re},[r(L(ye))])]),default:q(()=>[e("div",To,[e("div",Mo,[(t(!0),s(A,null,D(d.value,b=>(t(),s("div",{class:K(["file-item",{active:o.value==b.id}]),key:b.id,onClick:N=>c(b)},[b.file_name?(t(),s("span",Ao,g(b.file_name),1)):(t(),s("span",Fo,g(b.library_name)+"-精选",1))],10,Io))),128))]),e("div",Ro,[(t(!0),s(A,null,D(a.value,b=>(t(),s("div",{class:"document-item",key:b.id},[e("div",Eo,[e("div",Oo,[e("span",Bo,"id："+g(b.id),1),b.title?(t(),s("span",Do,g(b.title),1)):m("",!0),e("span",Po," 共"+g(b.word_total)+"个字符 ",1)]),e("div",Ho,[b.page_num>0?(t(),s("a",{key:0,onClick:N=>Z(b)},"预览原文件>",8,Uo)):m("",!0),e("a",{onClick:F},"查看源文档>")])]),e("div",jo,[e("div",zo,[f[2]||(f[2]=H(" 相似度： ",-1)),r(P,{name:"similarity",style:{"font-size":"16px"}}),H(g(b.similarity),1)]),b.question?(t(),s("div",No,"Q："+g(b.question),1)):m("",!0),b.answer?(t(),s("div",Vo,"A："+g(b.answer),1)):m("",!0),e("div",Jo,g(b.content),1),ie((t(),s("div",Qo,[(t(!0),s(A,null,D(b.images,(N,ne)=>(t(),s("img",{key:ne,src:N,alt:""},null,8,Ko))),128))])),[[oe]])])]))),128))])])]),_:1},8,["open"]),r(ee,{open:O.value,"onUpdate:open":f[1]||(f[1]=b=>O.value=b),title:v.value,footer:null,width:740},{default:q(()=>[e("div",Wo,[r(W,null,{default:q(()=>[r(L(ot),{source:U.value},null,8,["source"])]),_:1})])]),_:1},8,["open","title"])],64)}}},Yo=X(Go,[["__scopeId","data-v-e1a41673"]]),Xo={class:"chat-page-wrapper"},Zo={class:"chat-page-header"},en={class:"breadcrumb-box"},tn={class:"chat-page"},sn={class:"page-left"},on={class:"page-left-top"},nn={class:"page-left-body"},ln={class:"page-body"},an={class:"chat-box-body"},rn={style:{"padding-top":"30px"},class:"chat-box-footer"},cn={__name:"index",setup(S){const $=ke().query,n=Ce(),{getRobot:T}=n,h=Q(()=>n.robotInfo),d=Ne(),o=qe(),l=Fe();let p=!0;const c=E(""),a=E([]),k=E(null),{createChat:F,sendMessage:v,getMyChatList:U,openChat:O,onGetChatMessage:Z,changeRobotPrompt:re,$reset:x}=o,{messageList:f,sendLock:P,myChatList:z,robot:W,dialogue_id:ee}=Ue(o),oe=ke(),b=E(!1),N=E(!1),ne=Q(()=>P.value||N.value),_e=async()=>{if(!ne.value){if(!c.value&&!a.value.length)return Re("请输入消息内容");N.value=!0;try{let C=await nt({robot_key:W.value.robot_key,openid:W.value.openid,question:c.value,form_ids:W.value.form_ids,dialogue_id:ee.value});if(N.value=!1,C.data&&C.data.words)return ae.error(`提交的内容包含敏感词：[${C.data.words.join(";")}] 请修改后再提交`);let R=1,Y=c.value;if(h.value.question_multiple_switch==1){let te=[];R=99,c.value&&(te=[{type:"text",uid:be(16),text:c.value}]),a.value.length&&a.value.map(de=>{te.push({uid:de.uid,type:"image_url",image_url:{url:de.url}})}),Y=JSON.stringify(te)}p=!0,v({message:Y,global:JSON.stringify($),msg_type:R}),c.value="",a.value=[]}catch{N.value=!1}}},_=async()=>{p=!0,c.value="";let C=oe.query||{},R=l.user_id,Y={robot_key:C.robot_key,avatar:C.avatar,name:C.name,nickname:C.nickname,is_background:1,openid:R,dialogue_id:0};J(),await F(Y)},w=async C=>{if(ee.value==C.dialogue_id)return;p=!0;let Y={robot_key:(oe.query||{}).robot_key,avatar:C.avatar,name:C.name,nickname:C.nickname,is_background:C.is_background,openid:C.openid,dialogue_id:C.id};J(),await O(Y),await Z()&&i()},M=C=>{p=!0,v({message:C})};E(!1);const I=()=>{i()},B=async()=>{p=!1;let C=f.value[0].uid;await Z()&&u(C)},G=()=>{},i=()=>{k.value&&p&&k.value.scrollToBottom()},u=C=>{k.value&&k.value.scrollToMessage(C)},J=()=>{k.value&&k.value.resetScroll()},le=()=>{U()},j=E(null),pe=C=>{j.value.open(C)},ce=E(null),Ie=(C,R)=>{ce.value.open(C,R)};return $e(()=>f.value,()=>{}),je(async()=>{_(),U(),await T($.id),b.value=!0,d.on("updateAiMessage",I)}),xe(()=>{x(),d.off("updateAiMessage",I)}),(C,R)=>{const Y=ze("router-link"),te=Xe,de=Ge,Ae=Ye;return t(),s("div",Xo,[e("div",Zo,[e("div",en,[r(de,null,{default:q(()=>[r(te,null,{default:q(()=>[r(Y,{to:"/robot/list"},{default:q(()=>[...R[2]||(R[2]=[H("机器人管理",-1)])]),_:1})]),_:1}),r(te,null,{default:q(()=>[H(g(L(W).robot_name),1)]),_:1})]),_:1})])]),e("div",tn,[e("div",sn,[e("div",on,[r(Ae,{type:"primary",block:"",ghost:"",onClick:_},{default:q(()=>[r(L(Ze)),R[3]||(R[3]=H(" 新建对话",-1))]),_:1})]),e("div",nn,[r(Ps,{list:L(z),active:L(ee),onOpenChat:w,onOnScrollEnd:le},null,8,["list","active"])]),R[4]||(R[4]=e("div",{class:"page-left-footer"},null,-1))]),e("div",ln,[e("div",an,[r(Rs,{ref_key:"messageListRef",ref:k,messages:L(f),robotInfo:h.value,onClickMsgMeun:M,onScrollStart:B,onScrollEnd:G,onOpenPromptLog:pe,onOpenLibrary:Ie},null,8,["messages","robotInfo"])]),e("div",rn,[r(no,{value:c.value,"onUpdate:value":R[0]||(R[0]=me=>c.value=me),fileList:a.value,"onUpdate:fileList":R[1]||(R[1]=me=>a.value=me),loading:ne.value,showUpload:h.value.question_multiple_switch==1,onSend:_e},null,8,["value","fileList","loading","showUpload"])])]),e("div",null,[m("",!0)])]),r(Lo,{ref_key:"promptLogAlertRef",ref:j},null,512),r(Yo,{ref_key:"libraryInfoAlertRef",ref:ce},null,512)])}}},Mn=X(cn,[["__scopeId","data-v-eff860f8"]]);export{Mn as default};
