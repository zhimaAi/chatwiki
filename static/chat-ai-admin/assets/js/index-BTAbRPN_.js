import{f as S,r as le,o as X,w as J,Y as o,_ as s,a5 as e,k as b,a2 as M,F as q,a9 as N,u as Y,a1 as ae,G as z,a7 as y,q as ne,ad as be,n as P,ae as $,y as se,ab as Se,ag as Te,b as xe,aa as De}from"./vue-chunks-CXJTX1FC.js";import{d as I,O as we,q as $e,J as Le,a as Ce,ah as Ee,u as Me,v as He,a5 as Ie,B as Be,E as Ae,aL as Oe,M as Re}from"./ui-antd-D3ZAJ1Vq.js";import{_ as re}from"./empty-DkpCLaix.js";import{b as K,b1 as oe,d as Ue}from"../../index-0TFHdij1.js";import{_ as qe}from"./index-qYVIM3-2.js";import{u as ze}from"./robot-L7DXN4U8.js";import{u as je}from"./chat-B5qxBDRA.js";import{c as Ne}from"./index-CzO53uhx.js";import"./utils-yZpnICoG.js";import"./index-DvPlhmYy.js";import"./useEventBus-BwH2zX88.js";import"./useIM-Dr3RMCY8.js";import"./index-BAHM4xhG.js";const Ve={class:"zm-date"},Pe={class:"date-btn"},Ye={class:"date-content"},Fe={__name:"date",props:{datekey:{type:String,default:"1"}},emits:["dateChange"],setup(A,{emit:O}){const L=A,d=S(1),v=O;let D=le([{label:"今日",value:!0,key:2,start_time:I().startOf("day"),end_time:I().endOf("day")},{label:"昨日",value:!1,key:3,start_time:I().subtract(1,"day").startOf("day"),end_time:I().startOf("day").subtract(1,"millisecond")},{label:"近7日",value:!1,key:4,start_time:I().subtract(6,"day").startOf("day"),end_time:I().endOf("day").subtract(1,"millisecond")}]);const f=S(null),l=S(null),h=S([]),i=T=>T>=I().subtract(0,"day"),C=()=>{let T=d.value,u=null;D.forEach(r=>{r.key==T&&(u=r)}),u&&(h.value=[u.start_time,u.end_time],f.value=u.start_time.unix(),l.value=u.end_time.unix()),U()},R=T=>{const u=I(T[0]).startOf("day");if(I(T[1]).endOf("day").diff(u,"days")>29)h.value[0]=T[0].startOf("day"),h.value[1]=u.add(29,"days").endOf("day"),f.value=h.value[0].unix(),l.value=h.value[1].unix(),Ce.error("最多只能选择30天");else{const p=I(T[0]).startOf("day").unix(),E=I(T[1]).endOf("day").unix();h.value=T,f.value=p,l.value=E}d.value=1,U()},U=()=>{v("dateChange",{start_time:f.value,end_time:l.value})};return X(()=>{d.value=parseInt(L.datekey),C()}),J(()=>L.datekey,(T,u)=>{d.value=parseInt(L.datekey.split("-")[0]),C()}),(T,u)=>{const r=we,p=$e,E=Le;return s(),o("div",Ve,[e("div",Pe,[b(p,{value:d.value,"onUpdate:value":u[0]||(u[0]=g=>d.value=g),onChange:C},{default:M(()=>[(s(!0),o(q,null,N(Y(D),g=>(s(),ae(r,{class:"date-btn-button",value:g.key,key:g.key},{default:M(()=>[z(y(g.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),e("div",Ye,[b(E,{value:h.value,"onUpdate:value":u[1]||(u[1]=g=>h.value=g),onChange:R,format:"YYYY-MM-DD",disabledDate:i,allowClear:!1},null,8,["value"])])])}}},Ge={key:0,class:"empty-box"},Je=["onClick"],Ke={class:"user-item-left"},Qe=["src"],We={class:"user-item-right"},Xe={class:"user-name-box"},Ze={class:"user-name"},et={class:"user-timer"},tt={class:"user-info"},st={class:"user-source-box"},ot={class:"user-source-content"},lt={__name:"user",props:{userList:{type:Array,default:null},channelItem:{type:Array,default:null}},emits:["userClick","userScroll","userScrollStart","userScrollEnd"],setup(A,{emit:O}){const L=S(null),d=A,v=O,D=S([]),f=S([]),l=S({}),h=r=>{l.value=r,v("userClick",r)},i={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let C=null;function R(r){C&&(clearTimeout(C),C=null),C=setTimeout(()=>{i.scrollTop-r.target.scrollTop>0&&(i.scrollDirection="up"),i.scrollTop-r.target.scrollTop<0&&(i.scrollDirection="down"),i.scrollTop=r.target.scrollTop,i.scrollHeight=r.target.scrollHeight,i.clientHeight=r.target.clientHeight,v("userScroll",{...i}),Math.abs(i.scrollTop)<=i.scrollStartDiff+100&&i.scrollDirection==="up"&&U(),Math.abs(i.scrollHeight-i.scrollTop-i.clientHeight)<=i.scrollEndDiff&&i.scrollDirection==="down"&&T()},50)}function U(){d.userList.length!=0&&v("userScrollStart",{msg:d.userList[0]})}function T(){d.userList.length!=0&&v("userScrollEnd",{msg:d.userList[d.userList.length-1]})}J(()=>d.userList,r=>{D.value=r,D.value.length>0&&D.value.length<=20&&(h(D.value[0]),l.value=D.value[0])},{immediate:!0}),J(()=>d.channelItem,r=>{f.value=r},{immediate:!0});const u=r=>{for(let p=0;p<f.value.length;p++)if(r.app_type==f.value[p].app_type&&(r.app_id||"")==f.value[p].app_id)return f.value[p].app_name};return X(()=>{D.value=d.userList,f.value=d.channelItem}),(r,p)=>{const E=ne("ftime");return s(),o("div",{class:"user-content",ref_key:"scrollUserBoxRef",ref:L,onScroll:R},[D.value.length===0?(s(),o("div",Ge,p[0]||(p[0]=[e("img",{src:re,alt:""},null,-1),e("div",{class:"title"},"暂无结果，请重试",-1)]))):(s(!0),o(q,{key:1},N(D.value,g=>(s(),o("div",{class:be(["user-item",{active:g.openid==l.value.openid}]),onClick:t=>h(g),key:g.session_id},[e("div",Ke,[e("img",{class:"user-img",src:g.avatar,alt:""},null,8,Qe)]),e("div",We,[e("div",Xe,[e("div",Ze,y(g.name),1),P((s(),o("div",et,[z(y(g.last_chat_time),1)])),[[E,"MM-DD HH:mm"]])]),e("div",tt,y(g.last_chat_message),1),e("div",st,[p[1]||(p[1]=e("div",{class:"user-source-title"},"来自：",-1)),e("div",ot,y(u(g)),1)])])],10,Je))),128))],544)}}},at=K(lt,[["__scopeId","data-v-9b907563"]]),nt={class:"message-box"},rt={class:"message-top-box"},it={class:"message-top-title"},ct={key:0,class:"message-top-source"},ut={class:"message-list"},_t={key:0,class:"empty-box"},dt=["id"],pt={class:"itme-right"},mt={class:"message-info"},vt={class:"item-body"},ft={key:0,class:"message-content"},gt=["src"],yt={key:1,class:"message-content"},ht={class:"user-avatar-box"},kt=["src"],bt=["id"],St={class:"itme-left"},Tt=["src"],xt={class:"itme-right"},Dt={class:"message-info"},wt={key:0,class:"reply-list"},$t={key:0,class:"reply-item reply-text"},Lt=["innerHTML"],Ct={key:1,class:"reply-item reply-image"},Et={class:"message-content"},Mt=["src"],Ht={key:2,class:"reply-item reply-url"},It={class:"url-row"},Bt=["href"],At={key:3,class:"reply-item reply-card"},Ot={class:"card-row"},Rt=["src"],Ut={class:"card-title-box"},qt={class:"card-title"},zt={key:4,class:"reply-item reply-imageText"},jt=["href"],Nt=["src"],Vt={class:"imageText-text"},Pt={class:"imageText-title"},Yt={class:"imageText-desc"},Ft={key:5,class:"reply-item reply-smartMenu"},Gt={class:"smart-menu-box"},Jt={key:0,class:"card-title"},Kt={class:"card-text"},Qt={key:0,class:"line-text"},Wt={key:1,class:"empty-line"},Xt=["innerHTML"],Zt={key:3,href:"javascript:;",class:"link"},es={key:0},ts={key:1,class:"item-body"},ss={key:0,class:"message-content"},os=["innerHTML"],ls={key:2,class:"message-content"},as=["src"],ns={key:2,class:"loading-box"},rs={__name:"message-list",props:{messages:{type:Array,default:()=>[]},robotInfo:{type:Object,default:()=>{}},isEmpty:{type:Boolean,default:()=>!1},sessionSource:{type:String,default:()=>null},channelItem:{type:Array,default:()=>[]}},emits:["scroll","scrollStart","scrollEnd"],setup(A,{expose:O,emit:L}){const d=L,v=A,D=S(!1),f=S(null),l={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let h=null,i=!1;const C=t=>{let k;for(let m=0;m<v.channelItem.length;m++){const w=v.channelItem[m];w.app_type===t&&(k=w.app_name)}return k};function R(t){i||(h&&(clearTimeout(h),h=null),h=setTimeout(()=>{l.scrollTop-t.target.scrollTop>0&&(l.scrollDirection="up"),l.scrollTop-t.target.scrollTop<0&&(l.scrollDirection="down"),l.scrollTop=t.target.scrollTop,l.scrollHeight=t.target.scrollHeight,l.clientHeight=t.target.clientHeight,d("scroll",{...l}),Math.abs(l.scrollTop)<=l.scrollStartDiff&&l.scrollDirection==="up"&&U(),Math.abs(l.scrollHeight-l.scrollTop-l.clientHeight)<=l.scrollEndDiff&&l.scrollDirection==="down"&&T()},100))}function U(){v.messages.length!=0&&d("scrollStart",{msg:v.messages[0]})}function T(){v.messages.length!=0&&d("scrollEnd",{msg:v.messages[v.messages.length-1]})}const u=()=>{f.value&&se(()=>{i=!0,f.value.scrollTop=f.value.scrollHeight+1,setTimeout(()=>{l.scrollTop=f.value.scrollTop,i=!1},50)})};function r(t,k){se(()=>{i=!0,k||(k="top");let m=f.value,w=document.querySelector("#msg-"+t);w&&(k=="top"?m.scrollTop=w.offsetTop:m.scrollTop=w.offsetTop-m.clientHeight+w.clientHeight),setTimeout(()=>{l.scrollTop=f.value.scrollTop,i=!1},50)})}function p(){l.scrollTop=0,l.scrollDirection=""}function E(t){try{return t?Array.isArray(t)?t:typeof t=="string"?JSON.parse(t||"[]"):[]:[]}catch{return[]}}function g(t){const k=[];return(Array.isArray(t)?t:[]).forEach(m=>{const w=String((m==null?void 0:m.menu_type)||""),x=String((m==null?void 0:m.content)||"");if(w==="0")if(x==="")k.push({kind:"newline"});else if(/<a[\s\S]*?<\/a>/.test(x)){const a=/href\s*=\s*['"]\s*#\s*['"]/i.test(x)?x.replace(/href\s*=\s*['"]\s*#\s*['"]/ig,'href="javascript:;"'):x.replace(/href=/ig,'target="_blank" href=');k.push({kind:"html",html:a})}else k.push({kind:"text",text:x});else w==="1"&&k.push({kind:"keyword",text:x,serial_no:(m==null?void 0:m.serial_no)||""})}),k.slice(0,20)}return O({scrollToBottom:u,scrollToMessage:r,resetScroll:p}),(t,k)=>{const m=Ee,w=Ue,x=ne("viewer");return s(),o("div",nt,[e("div",rt,[e("div",it,y(v.robotInfo.robot_name),1),A.sessionSource?(s(),o("div",ct,"("+y(C(A.sessionSource))+")",1)):$("",!0)]),e("div",{class:"message-list-wrapper",ref_key:"scrollBoxRef",ref:f,onScroll:R},[e("div",ut,[v.isEmpty||!v.messages?(s(),o("div",_t,k[0]||(k[0]=[e("img",{src:re,alt:""},null,-1),e("div",{class:"title"},"暂无结果，请重试",-1)]))):(s(!0),o(q,{key:1},N(v.messages,a=>(s(),o(q,{key:a.uid},[a.is_customer==1?(s(),o("div",{key:0,class:"message-item user-message",id:"msg-"+a.uid},[e("div",pt,[e("div",mt,[e("span",null,y(Y(oe)(a.create_time)),1),e("span",null,y(a.name),1)]),e("div",vt,[a.received_message_type=="image"&&a.media_id_to_oss_url?(s(),o("div",ft,[P(e("img",{class:"msg-img",src:a.media_id_to_oss_url,alt:""},null,8,gt),[[x]])])):(s(),o("div",yt,y(a.content),1))])]),e("div",ht,[e("img",{class:"user-avatar",src:a.avatar},null,8,kt)])],8,dt)):(s(),o("div",{key:1,class:"message-item robot-message",id:"msg-"+a.uid},[e("div",St,[b(m,{size:"small",spinning:a.loading},{default:M(()=>[e("img",{class:"robot-avatar",src:a.robot_avatar},null,8,Tt)]),_:2},1032,["spinning"])]),e("div",xt,[e("div",Dt,[e("span",null,y(Y(oe)(a.create_time)),1),e("span",null,y(a.name),1)]),E(a.reply_content_list).length?(s(),o("div",wt,[(s(!0),o(q,null,N(E(a.reply_content_list),(n,Q)=>{var j;return s(),o(q,{key:Q},[(n.reply_type||n.type)==="text"?(s(),o("div",$t,[e("div",{class:"message-content",innerHTML:n.description},null,8,Lt)])):(n.reply_type||n.type)==="image"?(s(),o("div",Ct,[e("div",Et,[P(e("img",{class:"msg-img",src:n.pic||n.thumb_url},null,8,Mt),[[x]])])])):(n.reply_type||n.type)==="url"?(s(),o("div",Ht,[e("div",It,[e("a",{class:"url-link",href:n.url,target:"_blank"},y(n.url),9,Bt)])])):(n.reply_type||n.type)==="card"?(s(),o("div",At,[e("div",Ot,[n.thumb_url?(s(),o("img",{key:0,src:n.thumb_url,class:"card-thumb"},null,8,Rt)):$("",!0),e("div",Ut,[b(w,{class:"think-icon",name:"applet"}),e("span",qt,y(n.title),1)])])])):(n.reply_type||n.type)==="imageText"?(s(),o("div",zt,[e("a",{class:"imageText-row",href:n.url,target:"_blank"},[n.thumb_url?(s(),o("img",{key:0,src:n.thumb_url,class:"imageText-thumb"},null,8,Nt)):$("",!0),e("div",Vt,[e("div",Pt,y(n.title),1),e("div",Yt,y(n.description),1)])],8,jt)])):(n.reply_type||n.type)==="smartMenu"?(s(),o("div",Ft,[e("div",Gt,[n.smart_menu&&n.smart_menu.menu_description?(s(),o("div",Jt,y(n.smart_menu.menu_description),1)):$("",!0),e("div",Kt,[(s(!0),o(q,null,N(g(((j=n.smart_menu)==null?void 0:j.menu_content)||[]),(H,W)=>(s(),o("div",{key:W,class:"reply-line"},[H.kind==="text"?(s(),o("span",Qt,y(H.text),1)):H.kind==="newline"?(s(),o("div",Wt)):H.kind==="html"?(s(),o("span",{key:2,innerHTML:H.html},null,8,Xt)):H.kind==="keyword"?(s(),o("a",Zt,[H.serial_no?(s(),o("div",es,y(H.serial_no),1)):$("",!0),z(" "+y(H.text),1)])):$("",!0)]))),128))])])])):$("",!0)],64)}),128))])):$("",!0),a.msg_type==1&&a.content==""?$("",!0):(s(),o("div",ts,[a.msg_type==1?P((s(),o("div",ss,[b(qe,{content:a.content},null,8,["content"])])),[[x]]):$("",!0),a.msg_type==2?(s(),o("div",{key:1,class:"message-content",innerHTML:a.menu_json.content},null,8,os)):$("",!0),a.msg_type==3?(s(),o("div",ls,[P(e("img",{class:"msg-img",src:a.content,alt:""},null,8,as),[[x]])])):$("",!0)]))])],8,bt))],64))),128)),D.value?(s(),o("div",ns,[b(m)])):$("",!0)])],544)])}}},is=K(rs,[["__scopeId","data-v-dca77119"]]),cs={class:"team-members-pages"},us={class:"set-model"},_s={class:"set-model-body"},ds={class:"set-date"},ps={class:"set-date-body"},ms={class:"set-name"},vs={class:"set-reset"},fs={class:"list-box"},gs={class:"user-box"},ys={class:"records-box"},hs={__name:"session-record",setup(A){const O=S(!1),L=De(),d=Se(),v=d.query,D=ze(),{robotInfo:f}=D,l=je(),{messageList:h}=Te(l);let i=!0;const{createMsg:C,onGetChatMessage:R,getRecordList:U,getChannelList:T}=l,u=S(null),r=S([]),p=S([]),E=S(""),g=S("1"),t=le({robot_id:v.id,app_type:"all",app_id:"all",start_time:"",end_time:"",name:"",page:1,size:20}),k=S(!1),m=c=>{t.start_time=c.start_time,t.end_time=c.end_time,j()},w=()=>{t.app_type="all",t.name="",t.page=1,g.value="1-"+Math.random()},x=S(!1),a=S(!1),n=async()=>{let c=Z();a.value=!0,await Ne(c),x.value=!0,a.value=!1},Q=()=>{L.push({path:"/robot/config/export-record",query:v})},j=()=>{t.page=1,ee()},H=c=>{t.app_type=c,j()},W=()=>{},ie=c=>{E.value=c.app_type,ve(c)},ce=async()=>{},ue=()=>{k.value&&(t.page++,ee())},_e=async()=>{i=!1;let c=h.value[0].uid;await R()&&pe(c)},de=()=>{u.value&&i&&u.value.scrollToBottom()},pe=c=>{u.value&&u.value.scrollToMessage(c)},me=()=>{u.value&&u.value.resetScroll()};let F=null;const ve=async c=>{i=!0;let V={robot_key:(d.query||{}).robot_key,avatar:c.avatar,name:c.name,nickname:c.name,is_background:1,openid:c.openid,rel_user_id:c.rel_user_id};me(),await C(V),F&&(clearTimeout(F),F=null),F=setTimeout(async()=>{await R()&&de()},100)},fe=async()=>{let c={robot_id:t.robot_id};const _=await T(c);r.value=[{app_type:"all",app_name:"全部渠道"},..._.data]},Z=()=>{let c={robot_id:t.robot_id,start_time:t.start_time,end_time:t.end_time,name:t.name,page:t.page,size:t.size};return t.app_type!=="all"&&(c.app_type=t.app_type),t.app_id!=="all"&&(c.app_id=t.app_id),c},ee=async()=>{let c=Z(),_=await U(c),V=_.data.list||[];t.page==1&&(p.value=[]),p.value=[...p.value,...V],O.value=p.value.length==0,k.value=_.data.has_more};return J(()=>h.value,()=>{}),X(async()=>{fe()}),xe(()=>{}),(c,_)=>{const V=He,te=Me,ge=Ie,G=Be,ye=Ae,he=Oe,ke=Re;return s(),o("div",cs,[b(ye,{justify:"flex-start",class:"screen-box"},{default:M(()=>[e("div",us,[_[4]||(_[4]=e("div",{class:"label set-model-label"},"渠道：",-1)),e("div",_s,[b(te,{value:t.app_type,"onUpdate:value":_[0]||(_[0]=B=>t.app_type=B),placeholder:"全部渠道",onChange:H,style:{width:"200px"}},{default:M(()=>[(s(!0),o(q,null,N(r.value,B=>(s(),ae(V,{key:B.app_type,value:B.app_type},{default:M(()=>[e("span",null,y(B.app_name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])])]),e("div",ds,[_[5]||(_[5]=e("div",{class:"label set-date-label"},[e("span",null,"日期：")],-1)),e("div",ps,[b(Fe,{onDateChange:m,datekey:g.value},null,8,["datekey"])])]),e("div",ms,[b(ge,{value:t.name,"onUpdate:value":_[1]||(_[1]=B=>t.name=B),placeholder:"请输入用户名称搜索",style:{width:"200px"},onSearch:j},null,8,["value"])]),e("div",vs,[b(G,{onClick:w},{default:M(()=>_[6]||(_[6]=[z("重置")])),_:1,__:[6]}),b(G,{onClick:n,loading:a.value},{default:M(()=>_[7]||(_[7]=[z("导出")])),_:1,__:[7]},8,["loading"])])]),_:1}),e("div",fs,[e("div",gs,[b(at,{channelItem:r.value,userList:p.value,onUserScrollStart:ce,onUserScrollEnd:ue,onUserClick:ie},null,8,["channelItem","userList"])]),e("div",ys,[b(is,{ref_key:"messageListRef",ref:u,isEmpty:O.value,messages:Y(h),robotInfo:Y(f),channelItem:r.value,sessionSource:E.value,onScrollStart:_e,onScrollEnd:W},null,8,["isEmpty","messages","robotInfo","channelItem","sessionSource"])])]),b(ke,{open:x.value,"onUpdate:open":_[3]||(_[3]=B=>x.value=B),title:null,footer:null,width:640},{default:M(()=>[b(he,{status:"success",title:"导出任务创建成功","sub-title":"系统会在后台导出。导出数据量越大，耗时越久。您可以稍后点击导出记录查看并下载导出的文件。"},{extra:M(()=>[b(G,{style:{"margin-right":"16px"},onClick:_[2]||(_[2]=B=>x.value=!1)},{default:M(()=>_[8]||(_[8]=[z("知道了")])),_:1,__:[8]}),b(G,{onClick:Q,type:"primary"},{default:M(()=>_[9]||(_[9]=[z("去下载")])),_:1,__:[9]})]),_:1})]),_:1},8,["open"])])}}},ks=K(hs,[["__scopeId","data-v-6a2fb2b2"]]),bs={class:"user-model-page"},Ss={class:"list-wrapper"},Ts={__name:"index",setup(A){return(O,L)=>(s(),o("div",bs,[L[0]||(L[0]=e("div",{class:"page-title"},"会话记录",-1)),e("div",Ss,[b(ks)])]))}},Rs=K(Ts,[["__scopeId","data-v-bcc51f14"]]);export{Rs as default};
