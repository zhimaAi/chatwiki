import{b as N,bq as ue,aC as _e,d as X,bL as pe,bV as he,df as fe,bt as me,dg as ve}from"../../index-BdYv4pbp.js";import{Z as ge,f as ye,a as we,P as ke,H as be,C as $e,b as U}from"./cu-scroll--EBlKgwL.js";import{e as k,B as L,x as Y,M as d,N as r,W as e,k as p,a1 as j,a2 as J,w as xe,G as Fe,ao as Ce,ap as Ie,a7 as I,u as O,a6 as se,z as A,d as Se,a4 as Be,Q as R,S as Z,Z as B,X as Le,F as q,a0 as Q,Y as W,q as Me}from"./vue-chunks-Dagx-vSq.js";import{S as De}from"./SearchOutlined-C-SKizIr.js";import{C as Oe}from"./CaretDownFilled-7_Xowb8a.js";import{C as te}from"./CaretRightOutlined-B-YkA-6J.js";import{S as oe}from"./index-BITuwxer.js";import{R as ze}from"./RightOutlined-Dc3RESo2.js";import"./axios-BZ84_VUH.js";import"./qs-CSiAN3u4.js";import"./crypto-js-DN0vhd75.js";import"./dayjs-CZ5VaChI.js";import"./pull-up.esm-D94Swpvl.js";import"./observe-dom.esm-CyCedSm-.js";const Ne=h=>(j("data-v-20d52d07"),h=h(),J(),h),Te={class:"chart-wrapper"},Ee=Ne(()=>e("div",{class:"chart-mini-map",id:"chatMap"},null,-1)),Ve={class:"zoom-toolbar-wrapper"},Ze={__name:"chart-box",emits:["nodeClick"],setup(h,{expose:F,emit:b}){const u=b,a=k(null);let n=null;const l=L({nodes:[],edges:[]}),f=k(1),g=()=>{n&&n.destroy();const _={layout:"forceDirected",initialZoom:f.value,disableTelemetry:!0,maxZoom:10,minZoom:.1,minimapContainer:document.getElementById("chatMap"),styling:{minimapViewportBoxColor:"#4399FF",selectedBorderColor:"rgba(255, 255, 255, 1)"}},m=document.getElementById("chartBox");n=new ye(m,l.nodes,l.edges,_);const i=new we(n);new ke(n),i.updateCallback("onZoom",w=>{f.value=Number(w.toFixed(1))}),new be(n,{drawShadowOnHover:!0}),new $e(n,{selectOnClick:!0}).updateCallback("onNodeClick",w=>{u("nodeClick",w)})},C=_=>{f.value=_,n&&n.setZoom(_)},o=({nodes:_,edges:m})=>{l.nodes=[l.nodes,..._],l.edges=[l.edges,...m],n&&n.addElementsToGraph(_,m)},y=({nodes:_,edges:m})=>{l.nodes=[l.nodes,..._],l.edges=[l.edges,...m],n&&n.addAndUpdateElementsInGraph(_,m)},S=({nodes:_,edges:m})=>{l.nodes=_,l.edges=m,n&&n.updateElementsInGraph(_,m)},z=({nodes:_,edges:m})=>{l.nodes=_,l.edges=m,g()};return Y(()=>{}),F({render:z,add:o,addAndUpdate:y,update:S}),(_,m)=>(r(),d("div",Te,[e("div",{class:"chart",id:"chartBox",ref_key:"chartBox",ref:a},null,512),Ee,e("div",Ve,[p(ge,{value:f.value,onChange:C},null,8,["value"])])]))}},Re=N(Ze,[["__scopeId","data-v-20d52d07"]]),He={class:"search-action-box"},Ge={__name:"search-input",props:{value:{type:String,default:""}},emits:["search","clear","input","update:value"],setup(h,{emit:F}){const b=F,u=h,a=k(u.value),n=k(!1),l=k(null),f=()=>{b("update:value",a.value)},g=()=>{a.value="",A(()=>{var o;(o=l.value)==null||o.focus()}),f(),C()},C=()=>{b("search",a.value)};return xe(()=>u.value,o=>{a.value!==o&&(a.value=o)}),(o,y)=>(r(),d("div",{class:se(["search-input-box",{focused:n.value}])},[Fe(e("input",{ref_key:"searchInput",ref:l,class:"search-input","onUpdate:modelValue":y[0]||(y[0]=S=>a.value=S),placeholder:"输入关键词搜索",type:"text",onKeyup:Ie(C,["enter"]),onFocus:y[1]||(y[1]=S=>n.value=!0),onBlur:y[2]||(y[2]=S=>n.value=!1),onInput:f},null,544),[[Ce,a.value]]),e("div",He,[h.value.length>0?(r(),d("span",{key:0,class:"action-btn",onClick:g},[p(O(ue),{class:"clear-icon"})])):I("",!0),e("span",{class:"action-btn",onClick:C},[p(O(De),{class:"search-icon"})])])],2))}},Ue=N(Ge,[["__scopeId","data-v-91276234"]]),ae=h=>(j("data-v-d6938488"),h=h(),J(),h),qe={key:0,class:"file-list-wrapper"},Ae={class:"open-file-box"},Ke={key:0,class:"file-item active"},Pe={class:"file-info"},Qe=["onMouseenter","onClick"],We={class:"doc-content"},Xe={key:0,class:"loading-box"},Ye=ae(()=>e("span",{class:"loading-text"},"加载中...",-1)),je={class:"file-list-box"},Je={class:"file-items"},et={key:0,class:"file-item"},tt=["onClick"],st={class:"file-name"},ot={key:0,class:"loading-box"},at=ae(()=>e("span",{class:"loading-text"},"加载中...",-1)),nt={class:"fragment-title"},lt={class:"fragment-details-body"},it={class:"fragment-content"},ct={__name:"file-list",props:{show:{type:Boolean,default:!1}},emits:["openFile","openFragment"],setup(h,{expose:F,emit:b}){const{getStorage:u,removeStorage:a}=_e("localStorage"),n=b,l=h,f=Be(),g=u("graph:autoOpenFileId")||null,C=Se(()=>f.query.id),o=L({list:[],library_id:C.value,status:2,page:1,size:20,total:0,showMore:!0}),y=async()=>{try{const c=await he({library_id:o.library_id,status:o.status,page:o.page,size:o.size});if(c.res!=0)return;let $=c.data.list||[];o.total=c.data.total,g&&($=$.filter(D=>D.id!=g)),o.list=[...o.list,...$],o.list.length>=o.total&&(o.showMore=!1),o.page==1&&o.list.length>0&&M(o.list[0])}catch(c){o.showMore=!1}},S=()=>{o.list.length>=o.total||(o.page++,y())},z=k(null),_=k(null),m=k(0),i=L({show:!1,file_name:"",id:""}),s=L({show:!0,page:1,size:20,total:0,list:[],showMore:!0}),w=k(null),v=L({show:!1,title:"",content:""}),M=async c=>{if(c.id==i.id){w.value=null,n("openFile",c);return}i.show=!0,i.file_name=c.file_name,i.id=c.id,w.value=null,s.page=1,s.total=0,s.list=[],s.show=!0,s.showMore=!0,await E(),n("openFile",c)},G=()=>{s.show=!1},T=()=>{s.show=!0},t=k(300),E=async()=>{const c=await fe({file_id:i.id,page:s.page,size:s.size,status:-1,graph_status:-1,category_id:-1});c.res==0&&(s.total=c.data.total,s.page==1?s.list=c.data.list||[]:s.list=[...s.list,...c.data.list],s.list.length>=s.total&&(s.showMore=!1),A(()=>{var D;let $=((D=_.value)==null?void 0:D.offsetHeight)||0;$>t.value?m.value=t.value:m.value=$,A(()=>{var V;(V=z.value)==null||V.refresh()})}))},K=()=>{s.list.length>=s.total||(s.page++,E())},ne=c=>{w.value=c.id,n("openFragment",c)},le=c=>{clearTimeout(P),v.title=c.title,v.content=c.content,v.show=!0};let P=null;const ie=()=>{P=setTimeout(()=>{v.show=!1},200)},ce=()=>{clearTimeout(P)},re=()=>{v.show=!1},de=async()=>{try{const c=await pe({id:g});o.list.push(c.data)}catch(c){}};return Y(async()=>{g&&(await de(),a("graph:autoOpenFileId")),y()}),F({openFile:M}),(c,$)=>{const D=X,V=oe;return r(),R(Me,{name:"slide-fade"},{default:Z(()=>[l.show?(r(),d("div",qe,[e("div",Ae,[i.show?(r(),d("div",Ke,[e("div",Pe,[s.show?(r(),R(O(Oe),{key:0,class:"caret-icon",onClick:$[0]||($[0]=x=>G())})):(r(),R(O(te),{key:1,class:"caret-icon",onClick:$[1]||($[1]=x=>T())})),p(D,{class:"file-icon",name:"doc-file",style:{}}),e("span",{class:"file-name",onClick:$[2]||($[2]=x=>M(i))},B(i.file_name),1)]),s.show?(r(),d("div",{key:0,class:"document-fragments",style:Le({maxHeight:t.value+"px",height:m.value>0?m.value+"px":"auto"})},[p(U,{ref_key:"fragmentsScrollView",ref:z,"group-id":"a",onOnScrollEnd:K},{default:Z(()=>[e("div",{class:"fragment-list",ref_key:"fragmentListRef",ref:_},[(r(!0),d(q,null,Q(s.list,x=>(r(),d("div",{class:se(["fragment-item",{active:w.value==x.id}]),onMouseenter:ee=>le(x),onMouseleave:ie,onClick:ee=>ne(x),key:x.id},[e("div",We,B(x.content),1)],42,Qe))),128))],512),s.list.length<s.total?(r(),d("div",Xe,[p(V,{size:"small"}),W(),Ye])):I("",!0)]),_:1},512)],4)):I("",!0)])):I("",!0)]),e("div",je,[p(U,{"group-id":"a",onOnScrollEnd:S},{default:Z(()=>[e("div",Je,[(r(!0),d(q,null,Q(o.list,x=>(r(),d(q,{key:x.id},[x.id!=i.id?(r(),d("div",et,[e("div",{class:"file-info",onClick:ee=>M(x)},[p(O(te),{class:"caret-icon"}),p(D,{class:"file-icon",name:"doc-file",style:{}}),e("span",st,B(x.file_name),1)],8,tt)])):I("",!0)],64))),128)),o.showMore?(r(),d("div",ot,[p(V,{size:"small"}),W(),at])):I("",!0)])]),_:1})]),v.show?(r(),d("div",{key:0,class:"fragment-details",onMouseenter:ce,onMouseleave:re},[e("div",nt,B(v.title||"无标题片段"),1),e("div",lt,[p(U,null,{default:Z(()=>[e("div",it,B(v.content),1)]),_:1})])],32)):I("",!0)])):I("",!0)]),_:1})}}},rt=N(ct,[["__scopeId","data-v-d6938488"]]),H=h=>(j("data-v-449a5d4c"),h=h(),J(),h),dt={key:0,class:"popup-wrapper entity-details-wrapper"},ut={class:"popup-header"},_t=H(()=>e("div",{class:"popup-title"},"实体详情",-1)),pt={key:0,class:"popup-body"},ht={class:"popup-content"},ft={class:"entity-details"},mt={class:"entity-item"},vt=H(()=>e("div",{class:"entity-item-header"},[e("div",{class:"entity-item-label"},"实体")],-1)),gt={class:"entity-name"},yt={class:"entity-item",style:{"margin-bottom":"8px"}},wt=H(()=>e("div",{class:"entity-item-header"},[e("div",{class:"entity-item-label"},"归属文档")],-1)),kt={class:"file-info"},bt={class:"file-name"},$t={class:"entity-item"},xt={class:"entity-item-header"},Ft=H(()=>e("div",{class:"entity-item-label"},"分段",-1)),Ct={class:"doc-item"},It={class:"fragment-content"},St={class:"entity-item"},Bt=H(()=>e("div",{class:"entity-item-header"},[e("div",{class:"entity-item-label"},"子图")],-1)),Lt={key:0,class:""},Mt={class:"fragment-content"},Dt={__name:"entity-details",emits:["toDetails"],setup(h,{expose:F,emit:b}){const u=b,a=L({show:!1,node:null,fromNodes:[]}),n=()=>{a.show=!1},l=(g,C)=>{a.node=g,a.fromNodes=C,a.show?(a.show=!1,A(()=>{a.show=!0})):a.show=!0},f=()=>{u("toDetails",a.node)};return F({open:l,close:n}),(g,C)=>{const o=X;return a.show?(r(),d("div",dt,[e("div",ut,[_t,p(O(me),{class:"close-btn",onClick:n})]),a.node?(r(),d("div",pt,[p(U,null,{default:Z(()=>[e("div",ht,[e("div",ft,[e("div",mt,[vt,e("div",gt,B(a.node.name),1)]),e("div",yt,[wt,e("div",kt,[p(o,{class:"file-icon",name:"doc-file",style:{}}),e("span",bt,B(a.node.file_name),1)])]),e("div",$t,[e("div",xt,[Ft,e("span",{class:"to-details",onClick:f},[W("详情  "),p(O(ze),{class:"right-icon"})])]),e("div",null,[e("div",Ct,[e("div",It,B(a.node.content),1)])])]),e("div",St,[Bt,e("div",null,[a.fromNodes.length==0?(r(),d("div",Lt,"无")):I("",!0),(r(!0),d(q,null,Q(a.fromNodes,y=>(r(),d("div",{class:"subgraph-item",key:y.id},[e("div",Mt,B(y.name),1)]))),128))])])])])]),_:1})])):I("",!0)])):I("",!0)}}},Ot=N(Dt,[["__scopeId","data-v-449a5d4c"]]),zt={class:"collapse-icon"},Nt={class:"collapse-label"},Tt={__name:"collapse-btn",emits:["change"],setup(h,{emit:F}){const b=F,u=k(!0),a=()=>{u.value=!u.value,b("change",u.value)};return(n,l)=>{const f=X;return r(),d("div",{class:"collapse-btn",onClick:a},[e("span",zt,[u.value?(r(),R(f,{key:0,name:"collapse-close"})):(r(),R(f,{key:1,name:"collapse-open"}))]),e("span",Nt,B(u.value?"收起":"展开"),1)])}}},Et=N(Tt,[["__scopeId","data-v-ab8552b8"]]),Vt={class:"knowledge-graph-page"},Zt={key:0,class:"loading-wrapper"},Rt={class:"search-box"},Ht={class:"left-box"},Gt={class:"right-box"},Ut={__name:"index",setup(h){const F=k(null),b=k(null),u=k(!1),a=k(""),n=k(!0),l=L({file_id:"",data_id:"",search_term:""}),f=L({edges:[],nodes:[]});let g={};const C=i=>{n.value=i},o=i=>{l.file_id=i.id,l.data_id="",S()},y=i=>{l.data_id=i.id,S()},S=()=>{u.value=!0,ve({file_id:l.file_id,data_id:l.data_id,search_term:l.search_term}).then(i=>{u.value=!1;let s=i.data.edges||[],w=i.data.nodes||[];const v=new Map;s=s.filter(t=>{const E=`${t.from_id}_${t.to_id}`,K=`${t.to_id}_${t.from_id}`;return v.has(E)||v.has(K)?!1:(v.set(E,!0),!0)}),s.forEach(t=>{t.id=t.id.toString(),t.from=t.from_id.toString(),t.to=t.to_id.toString(),t.caption=t.label});const M=new Set(s.map(t=>t.from)),G=new Set(s.map(t=>t.to));w.forEach(t=>{t.id=t.id.toString(),t.nodeType=M.has(t.id)&&G.has(t.id)?"both":M.has(t.id)?"from":G.has(t.id)?"to":"normal",t.nodeType==="from"?(t.size=35,t.color="#FFB1B2"):t.nodeType==="to"?(t.size=45,t.color="#005AFF"):(t.size=30,t.color="#69E9BE"),t.captions=[{value:t.name,styles:[]}]});let T={edges:s,nodes:w};f.edges=T.edges,f.nodes=T.nodes,setTimeout(()=>{F.value.render(T)},0),g={},s.forEach(t=>{g[t.to]||(g[t.to]=[]),g[t.to].push(t.from)})}).catch(i=>{u.value=!1})},z=i=>{let s=g[i.id]||[],w=[];for(let v=0;v<f.nodes.length;v++)s.indexOf(f.nodes[v].id)>-1&&w.push(f.nodes[v]);b.value.open(i,w)},_=i=>{l.search_term=i,S()},m=i=>{window.open(`/#/library/preview?id=${i.file_id}`)};return Y(()=>{}),(i,s)=>{const w=oe;return r(),d("div",Vt,[u.value?(r(),d("div",Zt,[p(w,{spinning:u.value},null,8,["spinning"])])):I("",!0),p(Re,{ref_key:"chartBoxRef",ref:F,loading:u.value,onNodeClick:z},null,8,["loading"]),p(Et,{onChange:C}),e("div",Rt,[p(Ue,{value:a.value,"onUpdate:value":s[0]||(s[0]=v=>a.value=v),onSearch:_},null,8,["value"])]),e("div",Ht,[p(rt,{onOpenFile:o,onOpenFragment:y,show:n.value},null,8,["show"])]),e("div",Gt,[p(Ot,{ref_key:"entityDetailsRef",ref:b,onToDetails:m},null,512)])])}}},as=N(Ut,[["__scopeId","data-v-63b30116"]]);export{as as default};
