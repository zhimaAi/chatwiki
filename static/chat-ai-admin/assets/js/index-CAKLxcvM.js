import{u as F,b9 as le,_ as Se}from"../../index-DSFcP5NQ.js";import{r as S,E as ne,j as ee,w as K,a as o,b as t,p as e,y as b,t as H,F as q,l as P,u as x,e as re,_ as z,v as r,V as ie,h as Te,z as J,q as C,i as ae,ah as we,aj as $e,J as De,ag as Le}from"./vue-chunks-BdaA73Wf.js";import{d as A}from"./utils-CvB22N-W.js";import{T as Ce,r as Ee,P as Me,b as Ie,ag as He,u as Be,v as Ae,a5 as Oe,B as Re,J as Ue,aQ as Ve,M as je}from"./ui-antd-Dl1wwwCD.js";import{_ as ce}from"./empty-DkpCLaix.js";import{_ as W}from"./emoji-mart-BBMRoEa3.js";import{_ as qe,V as ze}from"./voice-message-B7-hRuYw.js";import{u as Ne}from"./robot-CIzNpArp.js";import{u as Pe}from"./chat-BLPxWtxf.js";import{c as Ye}from"./index-BuDcjXHQ.js";import"./neo4j-MWxXN7EM.js";import"./editor-cherry-CFIsbKoN.js";import"./lodash-Bm5sK6rN.js";import"./elkjs-BN8GIjVH.js";import"./other-LrIFyvU9.js";import"./index-Cg7-0swo.js";import"./useEventBus--I0IFnMo.js";import"./useIM-DZUieDUI.js";import"./index-B_UHbFfL.js";const Je={class:"zm-date"},Fe={class:"date-btn"},Ge={class:"date-content"},Qe={__name:"date",props:{datekey:{type:String,default:"1"}},emits:["dateChange"],setup(U,{emit:k}){const{t:E}=F("views.robot.robot-config.session-record.components.date"),O=U,d=S(1),m=k;let $=ne([{label:E("label_today"),value:!0,key:2,start_time:A().startOf("day"),end_time:A().endOf("day")},{label:E("label_yesterday"),value:!1,key:3,start_time:A().subtract(1,"day").startOf("day"),end_time:A().startOf("day").subtract(1,"millisecond")},{label:E("label_last_7_days"),value:!1,key:4,start_time:A().subtract(6,"day").startOf("day"),end_time:A().endOf("day").subtract(1,"millisecond")}]);const v=S(null),a=S(null),f=S([]),c=T=>T>=A().subtract(0,"day"),M=()=>{let T=d.value,u=null;$.forEach(i=>{i.key==T&&(u=i)}),u&&(f.value=[u.start_time,u.end_time],v.value=u.start_time.unix(),a.value=u.end_time.unix()),j()},V=T=>{const u=A(T[0]).startOf("day");if(A(T[1]).endOf("day").diff(u,"days")>29)f.value[0]=T[0].startOf("day"),f.value[1]=u.add(29,"days").endOf("day"),v.value=f.value[0].unix(),a.value=f.value[1].unix(),Ie.error(E("msg_max_30_days"));else{const h=A(T[0]).startOf("day").unix(),I=A(T[1]).endOf("day").unix();f.value=T,v.value=h,a.value=I}d.value=1,j()},j=()=>{m("dateChange",{start_time:v.value,end_time:a.value})};return ee(()=>{d.value=parseInt(O.datekey),M()}),K(()=>O.datekey,(T,u)=>{d.value=parseInt(O.datekey.split("-")[0]),M()}),(T,u)=>{const i=Ce,h=Ee,I=Me;return t(),o("div",Je,[e("div",Fe,[b(h,{value:d.value,"onUpdate:value":u[0]||(u[0]=g=>d.value=g),onChange:M},{default:H(()=>[(t(!0),o(q,null,P(x($),g=>(t(),re(i,{class:"date-btn-button",value:g.key,key:g.key},{default:H(()=>[z(r(g.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),e("div",Ge,[b(I,{value:f.value,"onUpdate:value":u[1]||(u[1]=g=>f.value=g),onChange:V,format:"YYYY-MM-DD",disabledDate:c,allowClear:!1},null,8,["value"])])])}}},Ke={key:0,class:"empty-box"},We={class:"title"},Xe=["onClick"],Ze={class:"user-item-left"},et=["src"],tt={class:"user-item-right"},st={class:"user-name-box"},ot={class:"user-name"},lt={class:"user-timer"},at={class:"user-info"},nt={class:"user-source-box"},rt={class:"user-source-title"},it={class:"user-source-content"},ct={__name:"user",props:{userList:{type:Array,default:null},channelItem:{type:Array,default:null}},emits:["userClick","userScroll","userScrollStart","userScrollEnd"],setup(U,{emit:k}){const{t:E}=F("views.robot.robot-config.session-record.components.user"),O=S(null),d=U,m=k,$=S([]),v=S([]),a=S({}),f=i=>{a.value=i,m("userClick",i)},c={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let M=null;function V(i){M&&(clearTimeout(M),M=null),M=setTimeout(()=>{c.scrollTop-i.target.scrollTop>0&&(c.scrollDirection="up"),c.scrollTop-i.target.scrollTop<0&&(c.scrollDirection="down"),c.scrollTop=i.target.scrollTop,c.scrollHeight=i.target.scrollHeight,c.clientHeight=i.target.clientHeight,m("userScroll",{...c}),Math.abs(c.scrollTop)<=c.scrollStartDiff+100&&c.scrollDirection==="up"&&j(),Math.abs(c.scrollHeight-c.scrollTop-c.clientHeight)<=c.scrollEndDiff&&c.scrollDirection==="down"&&T()},50)}function j(){d.userList.length!=0&&m("userScrollStart",{msg:d.userList[0]})}function T(){d.userList.length!=0&&m("userScrollEnd",{msg:d.userList[d.userList.length-1]})}K(()=>d.userList,i=>{$.value=i,$.value.length>0&&$.value.length<=20&&(f($.value[0]),a.value=$.value[0])},{immediate:!0}),K(()=>d.channelItem,i=>{v.value=i},{immediate:!0});const u=i=>{for(let h=0;h<v.value.length;h++)if(i.app_type==v.value[h].app_type&&(i.app_id||"")==v.value[h].app_id)return v.value[h].app_name};return ee(()=>{$.value=d.userList,v.value=d.channelItem}),(i,h)=>{const I=ie("ftime");return t(),o("div",{class:"user-content",ref_key:"scrollUserBoxRef",ref:O,onScroll:V},[$.value.length===0?(t(),o("div",Ke,[h[0]||(h[0]=e("img",{src:ce,alt:""},null,-1)),e("div",We,r(x(E)("msg_no_results")),1)])):(t(!0),o(q,{key:1},P($.value,g=>(t(),o("div",{class:Te(["user-item",{active:g.openid==a.value.openid}]),onClick:s=>f(g),key:g.session_id},[e("div",Ze,[e("img",{class:"user-img",src:g.avatar,alt:""},null,8,et)]),e("div",tt,[e("div",st,[e("div",ot,r(g.name),1),J((t(),o("div",lt,[z(r(g.last_chat_time),1)])),[[I,"MM-DD HH:mm"]])]),e("div",at,r(g.last_chat_message),1),e("div",nt,[e("div",rt,r(x(E)("label_from")),1),e("div",it,r(u(g)),1)])])],10,Xe))),128))],544)}}},_t=W(ct,[["__scopeId","data-v-fa678e4a"]]),ut={class:"message-box"},dt={class:"message-top-box"},pt={class:"message-top-title"},mt={key:0,class:"message-top-source"},vt={class:"message-list"},ht={key:0,class:"empty-box"},gt={class:"title"},ft=["id"],yt={class:"itme-right"},bt={class:"message-info"},kt={class:"item-body"},xt={key:0,class:"message-content"},St=["src"],Tt={key:1,class:"message-content"},wt={class:"user-avatar-box"},$t=["src"],Dt=["id"],Lt={class:"itme-left"},Ct=["src"],Et={class:"itme-right"},Mt={class:"message-info"},It={key:0,class:"reply-list"},Ht={key:0,class:"reply-item reply-text"},Bt=["innerHTML"],At={key:1,class:"reply-item reply-image"},Ot={class:"message-content"},Rt=["src"],Ut={key:2,class:"reply-item reply-url"},Vt={class:"url-row"},jt=["href"],qt={key:3,class:"reply-item reply-card"},zt={class:"card-row"},Nt=["src"],Pt={class:"card-title-box"},Yt={class:"card-title"},Jt={key:4,class:"reply-item reply-imageText"},Ft=["href"],Gt=["src"],Qt={class:"imageText-text"},Kt={class:"imageText-title"},Wt={class:"imageText-desc"},Xt={key:5,class:"reply-item reply-smartMenu"},Zt={class:"smart-menu-box"},es={key:0,class:"card-title"},ts={class:"card-text"},ss={key:0,class:"line-text"},os={key:1,class:"empty-line"},ls=["innerHTML"],as={key:3,href:"javascript:;",class:"link"},ns={key:0},rs={key:1,class:"item-body"},is={key:0,class:"message-content"},cs=["innerHTML"],_s={key:2,class:"message-content"},us=["src"],ds={key:2},ps={key:2,class:"loading-box"},ms={__name:"message-list",props:{messages:{type:Array,default:()=>[]},robotInfo:{type:Object,default:()=>{}},isEmpty:{type:Boolean,default:()=>!1},sessionSource:{type:String,default:()=>null},channelItem:{type:Array,default:()=>[]}},emits:["scroll","scrollStart","scrollEnd"],setup(U,{expose:k,emit:E}){const{t:O}=F("views.robot.robot-config.session-record.components.message-list"),d=E,m=U,$=S(!1),v=S(null),a={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let f=null,c=!1;const M=s=>{let y;for(let p=0;p<m.channelItem.length;p++){const L=m.channelItem[p];L.app_type===s&&(y=L.app_name)}return y};function V(s){c||(f&&(clearTimeout(f),f=null),f=setTimeout(()=>{a.scrollTop-s.target.scrollTop>0&&(a.scrollDirection="up"),a.scrollTop-s.target.scrollTop<0&&(a.scrollDirection="down"),a.scrollTop=s.target.scrollTop,a.scrollHeight=s.target.scrollHeight,a.clientHeight=s.target.clientHeight,d("scroll",{...a}),Math.abs(a.scrollTop)<=a.scrollStartDiff&&a.scrollDirection==="up"&&j(),Math.abs(a.scrollHeight-a.scrollTop-a.clientHeight)<=a.scrollEndDiff&&a.scrollDirection==="down"&&T()},100))}function j(){m.messages.length!=0&&d("scrollStart",{msg:m.messages[0]})}function T(){m.messages.length!=0&&d("scrollEnd",{msg:m.messages[m.messages.length-1]})}const u=()=>{v.value&&ae(()=>{c=!0,v.value.scrollTop=v.value.scrollHeight+1,setTimeout(()=>{a.scrollTop=v.value.scrollTop,c=!1},50)})};function i(s,y){ae(()=>{c=!0,y||(y="top");let p=v.value,L=document.querySelector("#msg-"+s);L&&(y=="top"?p.scrollTop=L.offsetTop:p.scrollTop=L.offsetTop-p.clientHeight+L.clientHeight),setTimeout(()=>{a.scrollTop=v.value.scrollTop,c=!1},50)})}function h(){a.scrollTop=0,a.scrollDirection=""}function I(s){try{return s?Array.isArray(s)?s:typeof s=="string"?JSON.parse(s||"[]"):[]:[]}catch{return[]}}function g(s){const y=[];return(Array.isArray(s)?s:[]).forEach(p=>{const L=String((p==null?void 0:p.menu_type)||""),w=String((p==null?void 0:p.content)||"");if(L==="0")if(w==="")y.push({kind:"newline"});else if(/<a[\s\S]*?<\/a>/.test(w)){const l=/href\s*=\s*['"]\s*#\s*['"]/i.test(w)?w.replace(/href\s*=\s*['"]\s*#\s*['"]/ig,'href="javascript:;"'):w.replace(/href=/ig,'target="_blank" href=');y.push({kind:"html",html:l})}else y.push({kind:"text",text:w});else L==="1"&&y.push({kind:"keyword",text:w,serial_no:(p==null?void 0:p.serial_no)||""})}),y.slice(0,20)}return k({scrollToBottom:u,scrollToMessage:i,resetScroll:h}),(s,y)=>{const p=He,L=Se,w=ie("viewer");return t(),o("div",ut,[e("div",dt,[e("div",pt,r(m.robotInfo.robot_name),1),U.sessionSource?(t(),o("div",mt,"("+r(M(U.sessionSource))+")",1)):C("",!0)]),e("div",{class:"message-list-wrapper",ref_key:"scrollBoxRef",ref:v,onScroll:V},[e("div",vt,[m.isEmpty||!m.messages?(t(),o("div",ht,[y[0]||(y[0]=e("img",{src:ce,alt:""},null,-1)),e("div",gt,r(x(O)("msg_empty_result")),1)])):(t(!0),o(q,{key:1},P(m.messages,l=>(t(),o(q,{key:l.uid},[l.is_customer==1?(t(),o("div",{key:0,class:"message-item user-message",id:"msg-"+l.uid},[e("div",yt,[e("div",bt,[e("span",null,r(x(le)(l.create_time)),1),e("span",null,r(l.name),1)]),e("div",kt,[l.received_message_type=="image"&&l.media_id_to_oss_url?(t(),o("div",xt,[J(e("img",{class:"msg-img",src:l.media_id_to_oss_url,alt:""},null,8,St),[[w]])])):(t(),o("div",Tt,r(l.content),1))])]),e("div",wt,[e("img",{class:"user-avatar",src:l.avatar},null,8,$t)])],8,ft)):(t(),o("div",{key:1,class:"message-item robot-message",id:"msg-"+l.uid},[e("div",Lt,[b(p,{size:"small",spinning:l.loading},{default:H(()=>[e("img",{class:"robot-avatar",src:l.robot_avatar},null,8,Ct)]),_:2},1032,["spinning"])]),e("div",Et,[e("div",Mt,[e("span",null,r(x(le)(l.create_time)),1),e("span",null,r(l.name),1)]),I(l.reply_content_list).length?(t(),o("div",It,[(t(!0),o(q,null,P(I(l.reply_content_list),(n,X)=>{var N;return t(),o(q,{key:X},[(n.reply_type||n.type)==="text"?(t(),o("div",Ht,[e("div",{class:"message-content",innerHTML:n.description},null,8,Bt)])):(n.reply_type||n.type)==="image"?(t(),o("div",At,[e("div",Ot,[J(e("img",{class:"msg-img",src:n.pic||n.thumb_url},null,8,Rt),[[w]])])])):(n.reply_type||n.type)==="url"?(t(),o("div",Ut,[e("div",Vt,[e("a",{class:"url-link",href:n.url,target:"_blank"},r(n.url),9,jt)])])):(n.reply_type||n.type)==="card"?(t(),o("div",qt,[e("div",zt,[n.thumb_url?(t(),o("img",{key:0,src:n.thumb_url,class:"card-thumb"},null,8,Nt)):C("",!0),e("div",Pt,[b(L,{class:"think-icon",name:"applet"}),e("span",Yt,r(n.title),1)])])])):(n.reply_type||n.type)==="imageText"?(t(),o("div",Jt,[e("a",{class:"imageText-row",href:n.url,target:"_blank"},[n.thumb_url?(t(),o("img",{key:0,src:n.thumb_url,class:"imageText-thumb"},null,8,Gt)):C("",!0),e("div",Qt,[e("div",Kt,r(n.title),1),e("div",Wt,r(n.description),1)])],8,Ft)])):(n.reply_type||n.type)==="smartMenu"?(t(),o("div",Xt,[e("div",Zt,[n.smart_menu&&n.smart_menu.menu_description?(t(),o("div",es,r(n.smart_menu.menu_description),1)):C("",!0),e("div",ts,[(t(!0),o(q,null,P(g(((N=n.smart_menu)==null?void 0:N.menu_content)||[]),(B,Z)=>(t(),o("div",{key:Z,class:"reply-line"},[B.kind==="text"?(t(),o("span",ss,r(B.text),1)):B.kind==="newline"?(t(),o("div",os)):B.kind==="html"?(t(),o("span",{key:2,innerHTML:B.html},null,8,ls)):B.kind==="keyword"?(t(),o("a",as,[B.serial_no?(t(),o("div",ns,r(B.serial_no),1)):C("",!0),z(" "+r(B.text),1)])):C("",!0)]))),128))])])])):C("",!0)],64)}),128))])):C("",!0),l.msg_type==1&&l.content==""?C("",!0):(t(),o("div",rs,[l.msg_type==1?J((t(),o("div",is,[b(qe,{content:l.content},null,8,["content"])])),[[w]]):C("",!0),l.msg_type==2?(t(),o("div",{key:1,class:"message-content",innerHTML:l.menu_json.content},null,8,cs)):C("",!0),l.msg_type==3?(t(),o("div",_s,[J(e("img",{class:"msg-img",src:l.content,alt:""},null,8,us),[[w]])])):C("",!0)])),l.voice_content&&l.voice_content.length?(t(),o("div",ds,[b(ze,{voice_content:l.voice_content},null,8,["voice_content"])])):C("",!0)])],8,Dt))],64))),128)),$.value?(t(),o("div",ps,[b(p)])):C("",!0)])],544)])}}},vs=W(ms,[["__scopeId","data-v-53bc4616"]]),hs={class:"team-members-pages"},gs={class:"set-model"},fs={class:"label set-model-label"},ys={class:"set-model-body"},bs={class:"set-date"},ks={class:"label set-date-label"},xs={class:"set-date-body"},Ss={class:"set-name"},Ts={class:"set-reset"},ws={class:"list-box"},$s={class:"user-box"},Ds={class:"records-box"},Ls={__name:"session-record",setup(U){const{t:k}=F("views.robot.robot-config.session-record.session-record"),E=S(!1),O=Le(),d=we(),m=d.query,$=Ne(),{robotInfo:v}=$,a=Pe(),{messageList:f}=$e(a);let c=!0;const{createMsg:M,onGetChatMessage:V,getRecordList:j,getChannelList:T}=a,u=S(null),i=S([]),h=S([]),I=S(""),g=S("1"),s=ne({robot_id:m.id,app_type:"all",app_id:"all",start_time:"",end_time:"",name:"",page:1,size:20}),y=S(!1),p=_=>{s.start_time=_.start_time,s.end_time=_.end_time,N()},L=()=>{s.app_type="all",s.name="",s.page=1,g.value="1-"+Math.random()},w=S(!1),l=S(!1),n=async()=>{let _=te();l.value=!0,await Ye(_),w.value=!0,l.value=!1},X=()=>{O.push({path:"/robot/config/export-record",query:m})},N=()=>{s.page=1,se()},B=_=>{s.app_type=_,N()},Z=()=>{},_e=_=>{I.value=_.app_type,ge(_)},ue=async()=>{},de=()=>{y.value&&(s.page++,se())},pe=async()=>{c=!1;let _=f.value[0].uid;await V()&&ve(_)},me=()=>{u.value&&c&&u.value.scrollToBottom()},ve=_=>{u.value&&u.value.scrollToMessage(_)},he=()=>{u.value&&u.value.resetScroll()};let G=null;const ge=async _=>{c=!0;let Y={robot_key:(d.query||{}).robot_key,avatar:_.avatar,name:_.name,nickname:_.name,is_background:1,openid:_.openid,rel_user_id:_.rel_user_id};he(),await M(Y),G&&(clearTimeout(G),G=null),G=setTimeout(async()=>{await V()&&me()},100)},fe=async()=>{let _={robot_id:s.robot_id};const D=await T(_);i.value=[{app_type:"all",app_name:k("ph_all_channels")},...D.data]},te=()=>{let _={robot_id:s.robot_id,start_time:s.start_time,end_time:s.end_time,name:s.name,page:s.page,size:s.size};return s.app_type!=="all"&&(_.app_type=s.app_type),s.app_id!=="all"&&(_.app_id=s.app_id),_},se=async()=>{let _=te(),D=await j(_),Y=D.data.list||[];s.page==1&&(h.value=[]),h.value=[...h.value,...Y],E.value=h.value.length==0,y.value=D.data.has_more};return K(()=>f.value,()=>{}),ee(async()=>{fe()}),De(()=>{}),(_,D)=>{const Y=Ae,oe=Be,ye=Oe,Q=Re,be=Ue,ke=Ve,xe=je;return t(),o("div",hs,[b(be,{justify:"flex-start",class:"screen-box"},{default:H(()=>[e("div",gs,[e("div",fs,r(x(k)("label_channel")),1),e("div",ys,[b(oe,{value:s.app_type,"onUpdate:value":D[0]||(D[0]=R=>s.app_type=R),placeholder:x(k)("ph_all_channels"),onChange:B,style:{width:"200px"}},{default:H(()=>[(t(!0),o(q,null,P(i.value,R=>(t(),re(Y,{key:R.app_type,value:R.app_type},{default:H(()=>[e("span",null,r(R.app_name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])])]),e("div",bs,[e("div",ks,[e("span",null,r(x(k)("label_date")),1)]),e("div",xs,[b(Qe,{onDateChange:p,datekey:g.value},null,8,["datekey"])])]),e("div",Ss,[b(ye,{value:s.name,"onUpdate:value":D[1]||(D[1]=R=>s.name=R),placeholder:x(k)("ph_search_user_name"),style:{width:"200px"},onSearch:N},null,8,["value","placeholder"])]),e("div",Ts,[b(Q,{onClick:L},{default:H(()=>[z(r(x(k)("btn_reset")),1)]),_:1}),b(Q,{onClick:n,loading:l.value},{default:H(()=>[z(r(x(k)("btn_export")),1)]),_:1},8,["loading"])])]),_:1}),e("div",ws,[e("div",$s,[b(_t,{channelItem:i.value,userList:h.value,onUserScrollStart:ue,onUserScrollEnd:de,onUserClick:_e},null,8,["channelItem","userList"])]),e("div",Ds,[b(vs,{ref_key:"messageListRef",ref:u,isEmpty:E.value,messages:x(f),robotInfo:x(v),channelItem:i.value,sessionSource:I.value,onScrollStart:pe,onScrollEnd:Z},null,8,["isEmpty","messages","robotInfo","channelItem","sessionSource"])])]),b(xe,{open:w.value,"onUpdate:open":D[3]||(D[3]=R=>w.value=R),title:null,footer:null,width:640},{default:H(()=>[b(ke,{status:"success",title:x(k)("title_export_success"),"sub-title":x(k)("msg_export_success")},{extra:H(()=>[b(Q,{style:{"margin-right":"16px"},onClick:D[2]||(D[2]=R=>w.value=!1)},{default:H(()=>[z(r(x(k)("btn_know")),1)]),_:1}),b(Q,{onClick:X,type:"primary"},{default:H(()=>[z(r(x(k)("btn_go_download")),1)]),_:1})]),_:1},8,["title","sub-title"])]),_:1},8,["open"])])}}},Cs=W(Ls,[["__scopeId","data-v-a5fa615b"]]),Es={class:"user-model-page"},Ms={class:"page-title"},Is={class:"list-wrapper"},Hs={__name:"index",setup(U){const{t:k}=F("views.robot.robot-config.session-record.index");return(E,O)=>(t(),o("div",Es,[e("div",Ms,r(x(k)("title_session_record")),1),e("div",Is,[b(Cs)])]))}},Zs=W(Hs,[["__scopeId","data-v-8a086bbc"]]);export{Zs as default};
//# sourceMappingURL=index-CAKLxcvM.js.map
