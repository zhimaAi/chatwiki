import{_ as _e,d as ye}from"../../index-WMhSApoa.js";import{aw as me,f as d,e as fe,r as ve,o as ge,ac as I,k as o,as as s,ar as u,av as be,ad as m,G as p,u as k,ae as x,F as q,ax as U,at as M,y as L}from"./vue-chunks-CGLjTDrY.js";import{M as xe}from"./multi-reply-BNWxgO4B.js";import{e as G,h as J,i as he}from"./index-CHNVlDjk.js";import{b as _,m as we,F as ke,n as ce,e as Ce,I as Re,v as Ie,ah as Q,B as Ae,a6 as N,as as Be,w as $e,x as Fe}from"./ui-antd-BDReVt-O.js";import"./neo4j-CK9lNpyi.js";import"./utils-DXEytJvC.js";import"./other-BrZCAsTs.js";import"./index-CxGFxpsV.js";import"./index-CtAh6k0_.js";const Ke={class:"subManage-edit"},qe=["href"],Ue={class:"main"},Me={class:"nav-box",style:{"padding-top":"10px"}},Ne={class:"item-box"},Te={class:"item-title-box"},ze={class:"flex",style:{gap:"8px","align-items":"center"}},He={class:"tag-container",style:{"margin-top":"8px"}},Se={class:"item-box",style:{"margin-top":"12px"}},De={class:"item-title-box"},Ee={class:"flex",style:{gap:"8px","align-items":"center"}},Oe={class:"tag-container",style:{"margin-top":"8px"}},Pe={class:"nav-box",style:{"margin-top":"24px"}},Ve={class:"item-box"},Le={class:"nav-box",style:{"margin-top":"24px"}},Ge={class:"item-box"},Je={class:"radio-container"},Qe={class:"btn-container"},We={__name:"add-rule",setup(je){const f=me().query,b=d(+f.rule_id||+f["rule-id"]||0),W=be(),j=fe(()=>`/#/robot/ability/auto-reply?id=${f.id}&robot_key=${f.robot_key}`),T=d(null),y=ve({name:"",reply_num:"0"}),X={name:[{required:!0,message:"请输入规则名称",trigger:"blur"}]},v=d([]),g=d([]),c=d(""),C=d(""),A=d(!1),B=d(!1),z=d(null),H=d(null),$=d(!1),Y=()=>{A.value=!0,L(()=>{var t,l;const n=z.value;n!=null&&n.focus?n.focus():(l=(t=n==null?void 0:n.$el)==null?void 0:t.querySelector("input"))==null||l.focus()})},S=async()=>{var t,l;if($.value)return;const n=(c.value||"").trim();if(!n){_.warning("请输入关键词");return}if(v.value.includes(n)){_.warning("已存在该关键词");return}try{$.value=!0;const a=await J({id:b.value,robot_id:f.id,keyword:n}),e=(t=a==null?void 0:a.data)==null?void 0:t.is_repeat,w=((l=a==null?void 0:a.data)==null?void 0:l.rule_name)||"";if(e){_.error(`关键词与规则「${w}」重复`);return}v.value.push(n),c.value="",A.value=!1}catch{_.error("校验失败，请稍后重试")}finally{$.value=!1}},Z=n=>{v.value=v.value.filter(t=>t!==n)},F=d(!1),ee=()=>{B.value=!0,L(()=>{var t,l;const n=H.value;n!=null&&n.focus?n.focus():(l=(t=n==null?void 0:n.$el)==null?void 0:t.querySelector("input"))==null||l.focus()})},D=async()=>{var t,l;if(F.value)return;const n=(C.value||"").trim();if(!n){_.warning("请输入关键词");return}if(g.value.includes(n)){_.warning("已存在该关键词");return}try{F.value=!0;const a=await J({id:b.value,robot_id:f.id,keyword:n}),e=(t=a==null?void 0:a.data)==null?void 0:t.is_repeat,w=((l=a==null?void 0:a.data)==null?void 0:l.rule_name)||"";if(e){_.error(`关键词与规则「${w}」重复`);return}g.value.push(n),C.value="",B.value=!1}catch{_.error("校验失败，请稍后重试")}finally{F.value=!1}},te=n=>{g.value=g.value.filter(t=>t!==n)},r=d([{type:"text",description:""}]),E=d([]),le=()=>{if(r.value.length>=5){_.warning("最多添加5条回复内容");return}r.value.push({type:"text",description:""})},ne=n=>{const{reply_index:t,...l}=n;t>=0&&t<r.value.length&&(r.value[t]=l)},ae=n=>{r.value.splice(n,1)},oe=()=>{};function se(n){return(n||[]).map(t=>({...t,status:"1"}))}function ue(n){const t={text:"2",image:"4",card:"3",imageText:"1",url:"5",smartMenu:"6"};return n.map(l=>t[l.type]||"").filter(Boolean)}const ie=()=>{var n;(n=T.value)==null||n.validate().then(async()=>{if(!v.value.length&&!g.value.length){_.warning("请至少添加一个关键词（精准或模糊）");return}if(!r.value.length){_.warning("请至少添加一条回复内容");return}for(const l of E.value)if(l&&l.validate&&!await l.validate())return;const t={robot_id:f.id,name:y.name,full_keyword:v.value,half_keyword:g.value,reply_content:JSON.stringify(se(r.value)),reply_type:ue(r.value),reply_num:y.reply_num};b.value&&(t.id=b.value);try{const l=await he(t);l&&l.res==0&&(_.success("保存成功"),W.push({path:"/robot/ability/auto-reply",query:{id:f.id,robot_key:f.robot_key}}))}catch{}})};return ge(async()=>{const n=+(f.copy_id||0);if(!b.value&&n){try{const t=await G({id:n}),l=(t==null?void 0:t.data)||{};y.name=`${(l==null?void 0:l.name)||""}副本`;const a=Array.isArray(l==null?void 0:l.reply_content)?l.reply_content:[];r.value=a.map(e=>({type:(e==null?void 0:e.type)||(e==null?void 0:e.reply_type)||"text",description:(e==null?void 0:e.description)||"",thumb_url:(e==null?void 0:e.thumb_url)||(e==null?void 0:e.pic)||"",title:(e==null?void 0:e.title)||"",url:(e==null?void 0:e.url)||"",appid:(e==null?void 0:e.appid)||"",page_path:(e==null?void 0:e.page_path)||"",smart_menu_id:(e==null?void 0:e.smart_menu_id)||"",smart_menu:(e==null?void 0:e.smart_menu)||{}})),y.reply_num=l.reply_num}catch{_.error("加载规则失败，请稍后重试")}return}if(b.value)try{const t=await G({id:b.value}),l=(t==null?void 0:t.data)||{};y.name=(l==null?void 0:l.name)||"",v.value=Array.isArray(l==null?void 0:l.full_keyword)?l.full_keyword:[],g.value=Array.isArray(l==null?void 0:l.half_keyword)?l.half_keyword:[];const a=Array.isArray(l==null?void 0:l.reply_content)?l.reply_content:[];r.value=a.map(e=>({type:(e==null?void 0:e.type)||(e==null?void 0:e.reply_type)||"text",description:(e==null?void 0:e.description)||"",thumb_url:(e==null?void 0:e.thumb_url)||(e==null?void 0:e.pic)||"",title:(e==null?void 0:e.title)||"",url:(e==null?void 0:e.url)||"",appid:(e==null?void 0:e.appid)||"",page_path:(e==null?void 0:e.page_path)||"",smart_menu_id:(e==null?void 0:e.smart_menu_id)||"",smart_menu:(e==null?void 0:e.smart_menu)||{}})),y.reply_num=l.reply_num}catch{_.error("加载规则失败，请稍后重试")}}),(n,t)=>{const l=ce,a=we,e=Re,w=Ce,K=ye,O=Ie,R=Ae,P=Be,V=Fe,re=$e,de=ke;return m(),I("div",Ke,[o(a,{class:"subManage-breadcrumb"},{default:u(()=>[o(l,null,{default:u(()=>[s("a",{href:j.value},"关键词回复",8,qe)]),_:1}),o(l,null,{default:u(()=>[...t[4]||(t[4]=[p("新增规则",-1)])]),_:1})]),_:1}),s("div",Ue,[o(de,{ref_key:"formRef",ref:T,model:y,rules:X},{default:u(()=>[o(w,{label:"规则名称",name:"name",rules:[{required:!0,message:"请输入规则名称"}]},{default:u(()=>[o(e,{value:y.name,"onUpdate:value":t[0]||(t[0]=i=>y.name=i),placeholder:"请输入",style:{width:"512px"}},null,8,["value"])]),_:1}),s("div",Me,[o(K,{name:"set-keywords",style:{"font-size":"16px"}}),t[5]||(t[5]=p(" 设置关键词 ",-1))]),s("div",Ne,[s("div",Te,[t[7]||(t[7]=s("div",{class:"item-title"},"精准匹配",-1)),o(O,null,{title:u(()=>[...t[6]||(t[6]=[p("发送消息内容只提到某个关键词，才回复指定的内容",-1)])]),default:u(()=>[o(k(Q),{style:{color:"#8C8C8C"}})]),_:1})]),s("div",ze,[A.value?(m(),x(e,{key:0,ref_key:"fullInputRef",ref:z,value:c.value,"onUpdate:value":t[1]||(t[1]=i=>c.value=i),placeholder:"输入关键词后回车或失去焦点添加",style:{width:"260px"},onPressEnter:S,onBlur:S},null,8,["value"])):(m(),x(R,{key:1,type:"dashed",class:"add-btn",onClick:Y},{icon:u(()=>[o(k(N))]),default:u(()=>[t[8]||(t[8]=p(" 添加关键词 ",-1))]),_:1}))]),s("div",He,[(m(!0),I(q,null,U(v.value,i=>(m(),x(P,{key:i,closable:"",onClose:h=>Z(i)},{default:u(()=>[p(M(i),1)]),_:2},1032,["onClose"]))),128))])]),s("div",Se,[s("div",De,[t[10]||(t[10]=s("div",{class:"item-title"},"模糊匹配",-1)),o(O,null,{title:u(()=>[...t[9]||(t[9]=[p("发送消息内容只要包含某个关键词，才回复指定的内容",-1)])]),default:u(()=>[o(k(Q),{style:{color:"#8C8C8C"}})]),_:1})]),s("div",Ee,[B.value?(m(),x(e,{key:0,ref_key:"halfInputRef",ref:H,value:C.value,"onUpdate:value":t[2]||(t[2]=i=>C.value=i),placeholder:"输入关键词后回车或失去焦点添加",style:{width:"260px"},onPressEnter:D,onBlur:D},null,8,["value"])):(m(),x(R,{key:1,type:"dashed",class:"add-btn",onClick:ee},{icon:u(()=>[o(k(N))]),default:u(()=>[t[11]||(t[11]=p(" 添加关键词 ",-1))]),_:1}))]),s("div",Oe,[(m(!0),I(q,null,U(g.value,i=>(m(),x(P,{key:i,closable:"",onClose:h=>te(i)},{default:u(()=>[p(M(i),1)]),_:2},1032,["onClose"]))),128))])]),s("div",Pe,[o(K,{name:"reply-content",style:{"font-size":"16px"}}),t[12]||(t[12]=p(" 回复内容 ",-1))]),s("div",Ve,[(m(!0),I(q,null,U(r.value,(i,h)=>(m(),x(xe,{key:h,ref_for:!0,ref_key:"replyRefs",ref:E,value:r.value[h],"onUpdate:value":pe=>r.value[h]=pe,reply_index:h,onChange:ne,onDel:ae},null,8,["value","onUpdate:value","reply_index"]))),128)),o(R,{type:"dashed",style:{width:"694px"},disabled:r.value.length>=5,onClick:le},{icon:u(()=>[o(k(N))]),default:u(()=>[p(" 添加回复内容("+M(r.value.length)+"/5) ",1)]),_:1},8,["disabled"])]),s("div",Le,[o(K,{name:"reply-settings",style:{"font-size":"16px"}}),t[13]||(t[13]=p(" 回复设置 ",-1))]),s("div",Ge,[t[16]||(t[16]=s("div",{class:"item-title-box"},[s("div",{class:"item-title"},"回复方式：")],-1)),s("div",Je,[o(re,{value:y.reply_num,"onUpdate:value":t[3]||(t[3]=i=>y.reply_num=i),onChange:oe},{default:u(()=>[o(V,{value:"0"},{default:u(()=>[...t[14]||(t[14]=[p("全部回复",-1)])]),_:1}),o(V,{value:"1"},{default:u(()=>[...t[15]||(t[15]=[p("随机回复一条",-1)])]),_:1})]),_:1},8,["value"])])]),s("div",Qe,[o(R,{type:"primary",onClick:ie},{default:u(()=>[...t[17]||(t[17]=[p("保存",-1)])]),_:1})])]),_:1},8,["model"])])])}}},ut=_e(We,[["__scopeId","data-v-486c0236"]]);export{ut as default};
