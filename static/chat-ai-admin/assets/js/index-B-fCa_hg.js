import{N as o,O as t,X as e,a6 as h,a5 as K,F as q,a1 as R,_ as m,b as Y,d as x,j as a,U as p,S as V,u as $,Z as E,H as X,I as Se,x as oe,G as te,ag as _e,w as de,z as xe,a2 as Te,a3 as re,a8 as Me,q as Le,D as Ie,a7 as Ee}from"./vue-chunks-BRsu9_To.js";import{u as Oe}from"./useEventBus-BwH2zX88.js";import{u as pe}from"./chat-DnVHVWxx.js";import{b as N,W as ce,d as se,ap as Re,bB as me,M as Be,h as Ae,B as De,bK as Pe,k as Fe}from"../../index-Bo1NSLpy.js";import{_ as ue}from"./index-Gd9vpppW.js";import{S as ge}from"./index-eahgXICC.js";import{_ as ve}from"./index-B4MPC5xv.js";import{_ as fe}from"./cu-scroll-bISEQWPA.js";import{_ as He}from"./TextArea--DLJ7VtX.js";import{Q as H}from"./QuestionCircleOutlined-VG1FNUnl.js";import{_ as he}from"./index-BtX93E4y.js";import{a as Ne}from"./index-z8pRRkmq.js";import{V as Ue}from"./vue3-pdf-embed-BUNF_9cG.js";import{P as je}from"./index-L62dqcZj.js";import{u as Qe}from"./robot-ppsw7ttj.js";import{B as ze,_ as Ve}from"./index-_hVn8A6r.js";import{P as Ke}from"./PlusOutlined-vSxn8uyP.js";import"./useIM-BHirVHcM.js";import"./index-BjF4Ni-g.js";import"./axios-Dq7h7Pqt.js";import"./qs-BrxkIg-9.js";import"./crypto-js-ClNpte_9.js";import"./dayjs-B6IotFah.js";import"./Trigger-DtRTHvld.js";import"./ResizeObserver.es-B1PUzC5B.js";import"./colors-4myZb9T8.js";import"./pull-up.esm-D94Swpvl.js";import"./observe-dom.esm-CyCedSm-.js";import"./FormItemContext-Cv3f2sEj.js";import"./index-CuPJUS8f.js";import"./index-BwedndIp.js";import"./inputProps--_pnbyjO.js";import"./vue-pdf-embed-C6Q-qZ65.js";import"./dropdown-DAy60lp8.js";import"./Dropdown-hEIgqeS3.js";import"./RightOutlined-zEOifMPB.js";import"./move-DztQgbGg.js";import"./slide-CVAZ5BEM.js";import"./index-Dxy-C30T.js";import"./shallowequal-C0xnIuy8.js";import"./collapseMotion-Brd6xpAT.js";import"./DownOutlined-CrhRpWT5.js";const Je={class:"guess-you-want"},Ge={class:"message-tabs"},We={key:1,class:"v-line"},Xe={key:0,class:"message-menus"},Ye=["onClick"],Ze={key:1,class:"message-menus"},et=["onClick"],tt={__name:"guess-you-want",props:{item:{type:Object,default:()=>{}},common_question_list:{type:Object,default:()=>[]},enable_common_question:{type:Boolean,default:!1}},emits:["clickMeun"],setup(T,{emit:O}){const b=O,s=T,g=(k,c)=>{k.question_tabkey=c},C=k=>{b("clickMeun",k)};return(k,c)=>(t(),o("div",Je,[e("div",Ge,[s.item.guess_you_want?(t(),o("div",{key:0,onClick:c[0]||(c[0]=n=>g(s.item,1)),class:K(["tab-item",{active:s.item.question_tabkey==1}])}," 猜你想问 ",2)):h("",!0),s.item.guess_you_want&&s.common_question_list&&s.enable_common_question?(t(),o("div",We)):h("",!0),s.common_question_list&&s.enable_common_question?(t(),o("div",{key:2,onClick:c[1]||(c[1]=n=>g(s.item,2)),class:K(["tab-item",{active:s.item.question_tabkey==2}])}," 常见问题 ",2)):h("",!0)]),s.item.question_tabkey==1?(t(),o("div",Xe,[(t(!0),o(q,null,R(s.item.guess_you_want,(n,_)=>(t(),o("div",{onClick:u=>C(n),class:"menu-item",key:_},m(n),9,Ye))),128))])):(t(),o("div",Ze,[(t(!0),o(q,null,R(T.common_question_list,(n,_)=>(t(),o("div",{onClick:u=>C(n),class:"menu-item",key:_},m(n),9,et))),128))]))]))}},ot=N(tt,[["__scopeId","data-v-253226a8"]]),st={class:"message-list-wrapper"},nt={class:"message-list"},lt=["id"],at={class:"itme-left"},it=["src"],rt={class:"itme-right"},ct={class:"item-body"},ut={class:"message-content"},_t=["id"],dt={class:"itme-left"},pt=["src"],mt={class:"itme-right"},gt={class:"label-flex-block"},vt=["onClick"],ft={class:"label-text"},ht=["onClick"],yt={class:"label-text"},bt={class:"item-body"},kt={key:0,class:"file-items"},$t=["onClick"],wt={class:"file-name"},qt={key:0},Ct={key:1},St={key:1,class:"thinking-content"},xt={class:"message-content"},Tt={class:"message-menus"},Mt=["onClick"],Lt=["innerHTML"],It={class:"message-menus"},Et=["onClick"],Ot={key:4,class:"message-content"},Rt=["src"],Bt={key:5,class:"message-action-wrap"},At={key:0,class:"message-action"},Dt={class:"action-btn"},Pt=["onClick"],Ft={__name:"message-list",props:{messages:{type:Array,default:()=>[]},robotInfo:{type:Object,default:()=>{}}},emits:["clickMsgMeun","scroll","scrollStart","scrollEnd","openPromptLog","openLibrary"],setup(T,{expose:O,emit:b}){const s=b,g=T,C=d=>{d.show_reasoning=!d.show_reasoning},k=d=>{d.show_quote_file=!d.show_quote_file},c=Y(()=>g.robotInfo.common_question_list.length?JSON.parse(g.robotInfo.common_question_list):[]),n=Y(()=>(g.robotInfo.chat_type==1||g.robotInfo.chat_type==3)&&g.robotInfo.application_type=="0"),_=d=>{s("clickMsgMeun",d)},u=x(null),i={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let L=null,D=!1;function U(d){D||(L&&(clearTimeout(L),L=null),L=setTimeout(()=>{i.scrollTop-d.target.scrollTop>0&&(i.scrollDirection="up"),i.scrollTop-d.target.scrollTop<0&&(i.scrollDirection="down"),i.scrollTop=d.target.scrollTop,i.scrollHeight=d.target.scrollHeight,i.clientHeight=d.target.clientHeight,s("scroll",{...i}),Math.abs(i.scrollTop)<=i.scrollStartDiff&&i.scrollDirection==="up"&&j(),Math.abs(i.scrollHeight-i.scrollTop-i.clientHeight)<=i.scrollEndDiff&&i.scrollDirection==="down"&&F()},50))}function j(){g.messages.length!=0&&s("scrollStart",{msg:g.messages[0]})}function F(){g.messages.length!=0&&s("scrollEnd",{msg:g.messages[g.messages.length-1]})}const W=()=>{u.value&&oe(()=>{D=!0,u.value.scrollTop=u.value.scrollHeight+1,setTimeout(()=>{i.scrollTop=u.value.scrollTop,D=!1},50)})};function J(d,w){oe(()=>{D=!0,w||(w="top");let I=u.value,r=document.querySelector("#msg-"+d);w=="top"?I.scrollTop=r.offsetTop:I.scrollTop=r.offsetTop-I.clientHeight+r.clientHeight,setTimeout(()=>{i.scrollTop=u.value.scrollTop,D=!1},50)})}function v(){i.scrollTop=0,i.scrollDirection=""}function y(d){return!!(d.quote_file&&d.quote_file.length>0||d.debug&&d.debug.length>0)}function P(d){s("openPromptLog",te(d))}function B(d,w,I){let r=te(d);w.message_id=w.message_id||I,r.forEach(A=>{A.message_id=A.message_id||I}),s("openLibrary",r,te(w))}return O({scrollToBottom:W,scrollToMessage:J,resetScroll:v}),(d,w)=>{const I=ge,r=se,A=ve,Q=_e("viewer");return t(),o("div",st,[e("div",{class:"scroll-box",ref_key:"scrollBoxRef",ref:u,onScroll:U},[e("div",nt,[(t(!0),o(q,null,R(g.messages,l=>(t(),o(q,{key:l.uid},[l.is_customer==1?(t(),o("div",{key:0,class:"message-item user-message",id:"msg-"+l.uid},[e("div",at,[e("img",{class:"user-avatar",src:l.avatar},null,8,it)]),e("div",rt,[e("div",ct,[e("div",ut,m(l.content),1)])])],8,lt)):(t(),o("div",{key:1,class:"message-item robot-message",id:"msg-"+l.uid},[e("div",dt,[a(I,{size:"small",spinning:l.loading},{default:p(()=>[e("img",{class:"robot-avatar",src:l.robot_avatar},null,8,pt)]),_:2},1032,["spinning"])]),e("div",mt,[e("div",gt,[l.msg_type==1&&n.value?(t(),o("div",{key:0,class:K(["thinking-label-wrapper",{reasoning_open:l.show_quote_file}])},[e("div",{class:"thinking-label",onClick:S=>k(l)},[l.quote_loading?(t(),o(q,{key:0},[a($(ce),{class:"loading"}),w[0]||(w[0]=e("span",{class:"label-text"},"正在检索知识库...",-1))],64)):(t(),o(q,{key:1},[a(r,{class:"think-icon",name:"quote-file"}),e("span",ft,"检索到"+m(l.quote_file.length)+"个知识库文档",1)],64)),l.quote_file.length?(t(),V(r,{key:2,name:"arrow-down",class:"arrow-down"})):h("",!0)],8,vt)],2)):h("",!0),l.reasoning_content?(t(),o("div",{key:1,class:K(["thinking-label-wrapper",{reasoning_open:l.show_reasoning}])},[e("div",{class:"thinking-label",onClick:S=>C(l)},[l.reasoning_status?(t(),V($(ce),{key:0,class:"loading"})):(t(),V(r,{key:1,class:"think-icon",name:"think"})),e("span",yt,m(l.reasoning_status?"深度思考中...":"已完成深度思考"),1),l.reasoning_status?h("",!0):(t(),V(r,{key:2,name:"arrow-down",class:"arrow-down"}))],8,ht),a(A,null,{title:p(()=>w[1]||(w[1]=[E("在应用设置中关闭推理过程开关，将不再显示推理过程")])),default:p(()=>[a($(Re),{class:"tip"})]),_:1})],2)):h("",!0)]),e("div",bt,[l.show_quote_file&&l.quote_file&&l.quote_file.length>0?(t(),o("div",kt,[(t(!0),o(q,null,R(l.quote_file,S=>(t(),o("div",{class:"file-item",key:S.id,onClick:z=>B(l.quote_file,S,l.id)},[e("a",wt,[a(r,{class:"think-icon",name:"quote-file"}),S.file_name?(t(),o("span",qt,m(S.file_name),1)):(t(),o("span",Ct,m(S.library_name)+"-精选",1))])],8,$t))),128))])):h("",!0),l.show_reasoning?(t(),o("div",St,[a(ue,{content:l.reasoning_content},null,8,["content"])])):h("",!0),l.msg_type==1?(t(),o(q,{key:2},[X((t(),o("div",xt,[a(ue,{content:l.content},null,8,["content"])])),[[Q]]),e("div",Tt,[(t(!0),o(q,null,R(l.question,(S,z)=>(t(),o("div",{class:"menu-item",onClick:Z=>_(S),key:z},m(S),9,Mt))),128))])],64)):h("",!0),l.msg_type==2?(t(),o(q,{key:3},[e("div",{class:"message-content",innerHTML:l.menu_json.content},null,8,Lt),e("div",It,[(t(!0),o(q,null,R(l.menu_json.question,(S,z)=>(t(),o("div",{class:"menu-item",onClick:Z=>_(S),key:z},m(S),9,Et))),128))])],64)):h("",!0),l.msg_type==3?(t(),o("div",Ot,[X(e("img",{class:"msg-img",src:l.content,alt:""},null,8,Rt),[[Q]])])):h("",!0),y(l)?X((t(),o("div",Bt,[l.debug&&l.debug.length>0?(t(),o("div",At,[e("div",Dt,[e("span",null,[e("a",{onClick:S=>P(l)},"Prompt 日志",8,Pt)])])])):h("",!0)],512)),[[Se,!l.question]]):h("",!0)]),(l.guess_you_want&&l.guess_you_want.length||c.value.length&&g.robotInfo.enable_common_question=="true")&&l.question_tabkey>0?(t(),V(ot,{key:0,item:l,enable_common_question:g.robotInfo.enable_common_question=="true",common_question_list:c.value,onClickMeun:_},null,8,["item","enable_common_question","common_question_list"])):h("",!0)])],8,_t))],64))),128))])],544)])}}},Ht=N(Ft,[["__scopeId","data-v-412d6854"]]),Nt={class:"chat-list-box"},Ut=["onClick"],jt={class:"chat-item-title"},Qt={__name:"chat-list",props:{list:{type:Array,default:()=>[]},active:{type:[String,Number],default:""}},emits:["openChat","onScrollEnd"],setup(T,{emit:O}){const b=O,s=T,g=x(null),C=c=>{b("openChat",c)},k=()=>{b("onScrollEnd")};return de(()=>s.list,()=>{oe(()=>{g.value.refresh()})}),(c,n)=>{const _=se;return t(),o("div",Nt,[a(fe,{ref_key:"scroller",ref:g,onOnScrollEnd:k},{default:p(()=>[e("div",null,[(t(!0),o(q,null,R(s.list,u=>(t(),o("div",{class:K(["chat-list-item",{active:u.id==s.active}]),onClick:i=>C(u),key:u.id},[a(_,{class:"chat-item-icon",name:"message"}),e("span",jt,m(u.subject||u.last_chat_message),1)],10,Ut))),128))])]),_:1},512)])}}},zt=N(Qt,[["__scopeId","data-v-4b3af25b"]]),Vt={class:"message-input-wrapper"},Kt={class:"message-action"},Jt={class:"loading-action"},Gt=["disabled"],Wt={__name:"message-input",props:{value:{type:String,default:""},loading:{type:Boolean,default:!1}},emits:["send","update:value"],setup(T,{emit:O}){const b=O,s=T,g=Y(()=>s.loading||s.value.trim().length===0),C=n=>{b("update:value",n.target.value.trim())},k=n=>{if(n.key==="Enter"&&!n.shiftKey){if(!n.target.value.trim())return;n.preventDefault(),c()}else n.key==="Enter"&&n.shiftKey&&(n.preventDefault(),b("update:value",s.value+`
`))},c=()=>{b("send",s.value.trim())};return(n,_)=>{const u=He,i=ge;return t(),o("div",Vt,[a(u,{value:T.value,"auto-size":{minRows:5,maxRows:5},placeholder:"在此输入您想了解的内容，Shift+Enter换行",onChange:C,onKeydown:k},null,8,["value"]),e("div",Kt,[e("span",Jt,[a(i,{spinning:T.loading},null,8,["spinning"])]),T.loading?h("",!0):(t(),o("button",{key:0,class:"send-msg-btn",disabled:g.value,onClick:c},_[0]||(_[0]=[e("span",null,"发送",-1)]),8,Gt))])])}}},Xt=N(Wt,[["__scopeId","data-v-a6f824ba"]]),Yt={class:"prompt-log-content"},Zt={class:"prompt-log-items"},eo={class:"prompt-log-label"},to={class:"prompt-log-item"},oo={class:"prompt-log-items"},so={class:"prompt-log-label"},no={class:"prompt-log-items"},lo={class:"prompt-log-label"},ao={class:"prompt-log-item"},io={class:"prompt-log-items"},ro={class:"prompt-log-label"},co={class:"prompt-log-item"},uo={key:0,class:"prompt-log-items"},_o={class:"prompt-log-label"},po={class:"prompt-log-item"},mo={key:1,class:"prompt-log-items"},go={class:"prompt-log-label"},vo={class:"prompt-log-item"},fo={class:"prompt-log-items"},ho={class:"prompt-log-label"},yo={class:"prompt-log-item"},bo={__name:"prompt-log-alert",setup(T,{expose:O}){const b=x(!1),s=xe({prompt:"",library:[],context_qa:[],cur_question:"",cur_answer:"",error:""}),g=()=>{b.value=!1},C=()=>{s.prompt="",s.library=[],s.context_qa=[],s.cur_question="",s.cur_answer="",s.error="",s.recall_time="",s.request_time=""};return O({open:c=>{C(),s.error=c.error,s.recall_time=c.recall_time?(c.recall_time/1e3).toFixed(2):"",s.request_time=c.request_time?(c.request_time/1e3).toFixed(2):"";let n=c.debug||[];for(let _=0;_<n.length;_++){let u=n[_];u.type=="library"?s.library.push(u.content):u.type=="context_qa"?s.context_qa.push(u):s[u.type]=u.content}b.value=!0}}),(c,n)=>{const _=ve,u=he;return t(),V(u,{class:"prompt-log-alert",open:b.value,"onUpdate:open":n[0]||(n[0]=i=>b.value=i),title:"Prompt 日志",placement:"right",width:"746px",closable:!1},{extra:p(()=>[e("span",{class:"close-btn",onClick:g},[a($(me))])]),default:p(()=>[e("div",Yt,[e("div",Zt,[e("div",eo,[n[2]||(n[2]=e("span",null,"提示词 ",-1)),a(_,null,{title:p(()=>n[1]||(n[1]=[E("系统提示词和文档分段。")])),default:p(()=>[a($(H),{class:"question-icon"})]),_:1})]),e("div",to,[e("p",null,m(s.prompt),1)]),(t(!0),o(q,null,R(s.library,(i,L)=>(t(),o("div",{class:"prompt-log-item",key:L},[e("p",null,m(i),1)]))),128))]),e("div",oo,[e("div",so,[n[4]||(n[4]=e("span",null,"上下文 ",-1)),a(_,null,{title:p(()=>n[3]||(n[3]=[E("传递的历史提问消息")])),default:p(()=>[a($(H),{class:"question-icon"})]),_:1})]),(t(!0),o(q,null,R(s.context_qa,(i,L)=>(t(),o("div",{class:"prompt-log-item",key:L},[e("p",null,"Q："+m(i.question),1),e("p",null,"A："+m(i.answer),1)]))),128))]),e("div",no,[e("div",lo,[n[6]||(n[6]=e("span",null,"USER ",-1)),a(_,null,{title:p(()=>n[5]||(n[5]=[E("本次用户的提问")])),default:p(()=>[a($(H),{class:"question-icon"})]),_:1})]),e("div",ao,[e("p",null,m(s.cur_question),1)])]),e("div",io,[e("div",ro,[n[8]||(n[8]=e("span",null,"ASSISTANT ",-1)),a(_,null,{title:p(()=>n[7]||(n[7]=[E("语言模型输出的答案")])),default:p(()=>[a($(H),{class:"question-icon"})]),_:1})]),e("div",co,[e("p",null,m(s.cur_answer),1)])]),s.recall_time>0?(t(),o("div",uo,[e("div",_o,[n[10]||(n[10]=e("span",null,"Recall time ",-1)),a(_,null,{title:p(()=>n[9]||(n[9]=[E("从知识库中检索到有效分段所需要的时间，包括对分段进行排序时间。")])),default:p(()=>[a($(H),{class:"question-icon"})]),_:1})]),e("div",po,[e("p",null,m(s.recall_time)+"s",1)])])):h("",!0),s.request_time>0?(t(),o("div",mo,[e("div",go,[n[12]||(n[12]=e("span",null,"Request time ",-1)),a(_,null,{title:p(()=>n[11]||(n[11]=[E("从发送问题和上下文信息给大模型到大模型开始返回答案的时间。")])),default:p(()=>[a($(H),{class:"question-icon"})]),_:1})]),e("div",vo,[e("p",null,m(s.request_time)+"s",1)])])):h("",!0),e("div",fo,[e("div",ho,[n[14]||(n[14]=e("span",null,"Error ",-1)),a(_,null,{title:p(()=>n[13]||(n[13]=[E("报错信息，调用聊天接口报错时会显示。")])),default:p(()=>[a($(H),{class:"question-icon"})]),_:1})]),e("div",yo,[e("p",null,m(s.error),1)])])])]),_:1},8,["open"])}}},ko=N(bo,[["__scopeId","data-v-d8a3a35d"]]),$o={class:"library-info-content"},wo={class:"file-list"},qo=["onClick"],Co={key:0},So={key:1},xo={class:"document-items"},To={class:"document-item-header"},Mo={class:"left-box"},Lo={class:"document-title"},Io={key:0,class:"document-title"},Eo={class:"document-size"},Oo={class:"right-box"},Ro=["onClick"],Bo={class:"document-item-body"},Ao={class:"document-similarity"},Do={key:0,class:"document-content"},Po={key:1,class:"document-content"},Fo={class:"document-content"},Ho={class:"fragment-img"},No=["src"],Uo={class:"iframe-box"},jo={__name:"library-info-alert",setup(T,{expose:O}){const b=pe(),{robot:s,user:g}=b;Te();const C=x(!1),k=x([]),c=x(null),n=()=>{k.value=[],c.value=null},_=(v,y)=>{if(n(),k.value=v.map(P=>{let B=null;return P.answer_source_data&&(B=JSON.parse(P.answer_source_data)),{...P,answer_source_data:B}}),c.value=y.id,C.value=!0,y.answer_source_data){i.value=JSON.parse(y.answer_source_data)||[];return}L(y)},u=v=>{if(v.id!=c.value){if(c.value=v.id,v.answer_source_data){i.value=v.answer_source_data||[];return}L(v)}},i=x([]),L=v=>{Ne({message_id:v.message_id,file_id:v.id,robot_key:s.robot_key,openid:s.openid}).then(y=>{i.value=y.data||[]})},D=()=>{let v=k.value.filter(y=>y.id==c.value)[0]||{};v.file_name?window.open(`#/library/preview?id=${c.value}`):window.open(`#/library/details/categary-manage?id=${v.library_id}`)},U=Y(()=>{let v=k.value.filter(y=>y.id==c.value)[0]||{};return v.file_name?v.file_name:v.library_name+"-精选"}),j=x(""),F=x(!1),W=v=>{F.value=!0,j.value="/manage/getLibRawFileOnePage?id="+c.value+"&page="+v.page_num+"&admin_user_id="+g.admin_user_id},J=()=>{C.value=!1};return O({open:_}),(v,y)=>{const P=se,B=he,d=fe,w=Be,I=_e("viewer");return t(),o(q,null,[a(B,{class:"library-info-alert",open:C.value,"onUpdate:open":y[0]||(y[0]=r=>C.value=r),title:"答案来源",placement:"right",width:"746px",closable:!1,bodyStyle:{background:"#F2F4F7"}},{extra:p(()=>[e("span",{class:"close-btn",onClick:J},[a($(me))])]),default:p(()=>[e("div",$o,[e("div",wo,[(t(!0),o(q,null,R(k.value,r=>(t(),o("div",{class:K(["file-item",{active:c.value==r.id}]),key:r.id,onClick:A=>u(r)},[r.file_name?(t(),o("span",Co,m(r.file_name),1)):(t(),o("span",So,m(r.library_name)+"-精选",1))],10,qo))),128))]),e("div",xo,[(t(!0),o(q,null,R(i.value,r=>(t(),o("div",{class:"document-item",key:r.id},[e("div",To,[e("div",Mo,[e("span",Lo,"id："+m(r.id),1),r.title?(t(),o("span",Io,m(r.title),1)):h("",!0),e("span",Eo," 共"+m(r.word_total)+"个字符 ",1)]),e("div",Oo,[r.page_num>0?(t(),o("a",{key:0,onClick:A=>W(r)},"预览原文件>",8,Ro)):h("",!0),e("a",{onClick:D},"查看源文档>")])]),e("div",Bo,[e("div",Ao,[y[2]||(y[2]=E(" 相似度： ")),a(P,{name:"similarity",style:{"font-size":"16px"}}),E(m(r.similarity),1)]),r.question?(t(),o("div",Do,"Q："+m(r.question),1)):h("",!0),r.answer?(t(),o("div",Po,"A："+m(r.answer),1)):h("",!0),e("div",Fo,m(r.content),1),X((t(),o("div",Ho,[(t(!0),o(q,null,R(r.images,(A,Q)=>(t(),o("img",{key:Q,src:A,alt:""},null,8,No))),128))])),[[I]])])]))),128))])])]),_:1},8,["open"]),a(w,{open:F.value,"onUpdate:open":y[1]||(y[1]=r=>F.value=r),title:U.value,footer:null,width:740},{default:p(()=>[e("div",Uo,[a(d,null,{default:p(()=>[a($(Ue),{source:j.value},null,8,["source"])]),_:1})])]),_:1},8,["open","title"])],64)}}},Qo=N(jo,[["__scopeId","data-v-e1a41673"]]),zo={class:"chat-page-wrapper"},Vo={class:"chat-page-header"},Ko={class:"breadcrumb-box"},Jo={class:"chat-page"},Go={class:"page-left"},Wo={class:"page-left-top"},Xo={class:"page-left-body"},Yo={class:"page-body"},Zo={class:"chat-box-body"},es={style:{"margin-top":"30px"},class:"chat-box-footer"},ts={__name:"index",setup(T){const b=re().query,s=Qe(),{getRobot:g,robotInfo:C}=s,k=Oe(),c=pe(),n=Ae();let _=!0;const u=x(""),i=x(null),{createChat:L,sendMessage:D,getMyChatList:U,openChat:j,onGetChatMessage:F,changeRobotPrompt:W,$reset:J}=c,{messageList:v,sendLock:y,myChatList:P,robot:B,dialogue_id:d}=Me(c),w=re(),I=x(!1),r=async()=>{if(!u.value)return Pe("请输入消息内容");let f=await je({robot_key:B.value.robot_key,openid:B.value.openid,question:u.value,form_ids:B.value.form_ids,dialogue_id:d.value});if(f.data&&f.data.words)return Fe.error(`提交的内容包含敏感词：[${f.data.words.join(";")}] 请修改后再提交`);_=!0,D({message:u.value,global:JSON.stringify(b)}),u.value=""},A=async()=>{_=!0,u.value="";let f=w.query||{},M=n.user_id,G={robot_key:f.robot_key,avatar:f.avatar,name:f.name,nickname:f.nickname,is_background:1,openid:M,dialogue_id:0};le(),await L(G)},Q=async f=>{if(d.value==f.dialogue_id)return;_=!0;let G={robot_key:(w.query||{}).robot_key,avatar:f.avatar,name:f.name,nickname:f.nickname,is_background:f.is_background,openid:f.openid,dialogue_id:f.id};le(),await j(G),await F()&&ne()},l=f=>{_=!0,D({message:f})};x(!1);const S=()=>{ne()},z=async()=>{_=!1;let f=v.value[0].uid;await F()&&ye(f)},Z=()=>{},ne=()=>{i.value&&_&&i.value.scrollToBottom()},ye=f=>{i.value&&i.value.scrollToMessage(f)},le=()=>{i.value&&i.value.resetScroll()},be=()=>{U()},ae=x(null),ke=f=>{ae.value.open(f)},ie=x(null),$e=(f,M)=>{ie.value.open(f,M)};return de(()=>v.value,()=>{}),Le(async()=>{A(),U(),await g(b.id),I.value=!0,k.on("updateAiMessage",S)}),Ie(()=>{J(),k.off("updateAiMessage",S)}),(f,M)=>{const G=Ee("router-link"),ee=Ve,we=ze,qe=De;return t(),o("div",zo,[e("div",Vo,[e("div",Ko,[a(we,null,{default:p(()=>[a(ee,null,{default:p(()=>[a(G,{to:"/robot/list"},{default:p(()=>M[1]||(M[1]=[E("机器人管理")])),_:1,__:[1]})]),_:1}),a(ee,null,{default:p(()=>[E(m($(B).robot_name),1)]),_:1})]),_:1})])]),e("div",Jo,[e("div",Go,[e("div",Wo,[a(qe,{type:"primary",block:"",ghost:"",onClick:A},{default:p(()=>[a($(Ke)),M[2]||(M[2]=E(" 新建对话"))]),_:1,__:[2]})]),e("div",Xo,[a(zt,{list:$(P),active:$(d),onOpenChat:Q,onOnScrollEnd:be},null,8,["list","active"])]),M[3]||(M[3]=e("div",{class:"page-left-footer"},null,-1))]),e("div",Yo,[e("div",Zo,[a(Ht,{ref_key:"messageListRef",ref:i,messages:$(v),robotInfo:$(C),onClickMsgMeun:l,onScrollStart:z,onScrollEnd:Z,onOpenPromptLog:ke,onOpenLibrary:$e},null,8,["messages","robotInfo"])]),e("div",es,[a(Xt,{value:u.value,"onUpdate:value":M[0]||(M[0]=Ce=>u.value=Ce),onSend:r,loading:$(y)},null,8,["value","loading"])])]),e("div",null,[h("",!0)])]),a(ko,{ref_key:"promptLogAlertRef",ref:ae},null,512),a(Qo,{ref_key:"libraryInfoAlertRef",ref:ie},null,512)])}}},Qs=N(ts,[["__scopeId","data-v-0c311f37"]]);export{Qs as default};
