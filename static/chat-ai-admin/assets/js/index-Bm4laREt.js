import{d as ue,e as me,f as w,r as G,w as X,o as te,Y as y,_ as m,F as Y,a1 as H,ae as V,k as l,a2 as b,G as U,l as _e,u as F,a5 as t,n as pe,A as ve,a9 as Z,ad as re,a7 as T,J as fe,a6 as he,a3 as ge,ao as ye,X as de,ag as ne,b as ke}from"./vue-chunks-yZ4gwLzA.js";import{j as be,d as se,bM as xe,b as Q,bl as $e,by as Se,b9 as W,bm as we,ah as Le,bN as Ce,b6 as Ae,bO as Me,F as Ne,au as Re,av as Ie,aw as Ue}from"../../index-ZzVqUZIR.js";import{j as qe}from"./index-CkBKI6U4.js";import{M as ie}from"./model-select-DoQzbsHY.js";import{ai as Oe,B as Te,aw as Be,J as Ee,p as ce,ad as P,H as ze,q as Fe,R as je,W as Ve,aC as Ke,G as De,M as Pe,a as ee,I as Je,N as He,E as Ge,bi as Ye}from"./ui-antd-BJtyvQX6.js";import{M as Qe}from"./index-BMSQkwth.js";import{u as We}from"./useEventBus-DbXWCKa0.js";import"./utils-smNh_pj2.js";const Xe={class:"prompt-form"},Ze={class:"form-item"},et={class:"form-item-label"},tt={class:"prompt-form-item"},st={class:"prompt-form-item"},at={class:"prompt-form-item-content"},lt={key:0,class:"prompt-form-item-tip"},ot={class:"prompt-form-item"},nt={class:"prompt-form-item-label"},it={class:"form-item-body"},rt={class:"number-box"},dt={class:"number-slider-box"},ct={class:"number-input-box"},ut={class:"prompt-form-item"},mt={class:"prompt-form-item-label"},_t={class:"form-item-body"},pt={class:"number-box"},vt={class:"number-slider-box"},ft={class:"number-input-box"},ht={class:"recall-settings-box"},gt={class:"form-box prompt-form"},yt={class:"form-item is-required"},kt={class:"form-item-body"},bt={class:"retrieval-mode-items"},xt=["onClick"],$t={class:"retrieval-mode-title"},St={class:"title-text"},wt={class:"retrieval-mode-desc"},Lt={class:"form-item"},Ct={class:"form-item-label"},At={class:"form-item-body"},Mt={class:"number-box"},Nt={class:"number-slider-box"},Rt={class:"number-input-box"},It={key:0,class:"form-item"},Ut={class:"form-item-label"},qt={class:"form-item-body"},Ot={class:"number-box"},Tt={class:"number-slider-box"},Bt={class:"number-input-box"},Et={class:"form-item"},zt={class:"form-item-label"},Ft={key:0,class:"form-item-body"},jt=ue({__name:"search-drawer",props:{librarySearchData:{type:Object,default:null},defaultLibrarySearchData:{type:Object,default:null}},setup($){let{role_permission:i,role_type:M}=be();const q=me(()=>M==1||i.includes("SearchSets")),v=$,I=w([{iconName:"mix-icon",title:"混合检索",value:1,isRecommendation:!0,desc:"同时执行三种检索模式，使用RRF算法进行排序，从三种查询结果中选择更匹配用户问题的结果。混合检索兼顾语义相似性与逻辑关联性，通过互补优势提升检索的准确性和生成结果的可信度"},{iconName:"vector-icon",title:"向量检索",value:2,desc:"将用户提问转成向量之后与知识库分段匹配相似度，返回相似度高的结果。向量检索擅长语义相似性匹配和大规模非结构化数据处理，但缺乏可解释性和精准关系验证"},{iconName:"graph-icon",title:"知识图谱检索",value:4,desc:"通过关系推理，检索出与用户问题相关联的知识。知识图谱检索擅长精准的实体关系推理和逻辑验证，但对非结构化文本和语义模糊查询支持较弱"},{iconName:"search-check-icon",title:"全文检索",value:3,desc:"通过分词匹配文档中的词汇，返回包含这些词汇的文本片段"}]),L=w(!1),s=G({use_model:"",model_config_id:"",prompt_type:"0",prompt:"",temperature:.5,max_token:2e3,context_pair:0,search_type:1,top_k:5,size:0,similarity:.4,rerank_status:0,rerank_use_model:void 0,rerank_model_config_id:void 0,summary_switch:0}),B=(A,e)=>{s.use_model=e.modelName,s.model_config_id=e.modelId,k()},E=w([]),x=A=>{var e,o,p,f,C;if(E.value=A,!((e=v.librarySearchData)!=null&&e.model_config_id)||!((o=v.librarySearchData)!=null&&o.use_model)){if(E.value.length>0){let h=E.value[0];if(h){let r=h.children[0];s.use_model=r.name,s.model_config_id=r.model_config_id}}}else s.use_model=((p=v.librarySearchData)==null?void 0:p.use_model)+"$$",s.model_config_id=((f=v.librarySearchData)==null?void 0:f.model_config_id)+"$$",s.use_model=s.use_model.split("$$")[0],s.model_config_id=(C=v.librarySearchData)==null?void 0:C.model_config_id.split("$$")[0]},n=A=>{s.search_type=A,k()},c=A=>{let e={...A};e.max_token=parseFloat(e.max_token),e.temperature=parseFloat(e.temperature),e.context_pair=parseFloat(e.context_pair),e.search_type=parseFloat(e.search_type),e.rerank_status=parseFloat(e.rerank_status),e.similarity=parseFloat(e.similarity),e.top_k=parseFloat(e.size),e.summary_switch=+e.summary_switch,e.rerank_use_model===""&&(e.rerank_use_model=void 0),Object.keys(e).forEach(o=>{s[o]=e[o]})},k=()=>{let A={...s};if(!A.prompt&&s.prompt_type=="1")return ee.error("请输入自定义提示词");(s.search_type==3||s.search_type==4)&&delete A.similarity,s.prompt_type=="0"&&delete A.prompt,A.size=A.top_k,xe(A).then(e=>{ee.success("保存成功")})},_=w(!1),u=w(""),d=()=>{s.prompt_type=="1"?(u.value=s.prompt,_.value=!0):k()},K=()=>{if(u.value)s.prompt=u.value,_.value=!1,k();else return ee.error("请输入提示语")},j=()=>{s.prompt_type="0",_.value=!1},O=A=>{},J=()=>{L.value=!0};return X(()=>v.librarySearchData,A=>{var e;(e=v.librarySearchData)!=null&&e.id&&c({...fe(v.librarySearchData)})}),te(()=>{}),(A,e)=>{const o=Te,p=ce,f=ze,C=Ee,h=je,r=Fe,S=Ve,N=Ke,R=De,z=se,g=Pe,D=Be;return m(),y(Y,null,[q.value?(m(),H(o,{key:0,onClick:J,icon:_e(F(Oe))},{default:b(()=>[...e[19]||(e[19]=[U("搜索设置",-1)])]),_:1},8,["icon"])):V("",!0),l(D,{open:L.value,"onUpdate:open":e[18]||(e[18]=a=>L.value=a),class:"custom-class","root-class-name":"root-class-name",title:"搜索设置",width:"472",placement:"right",onAfterOpenChange:O},{default:b(()=>[t("div",Xe,[e[30]||(e[30]=t("div",{class:"prompt-form-label"},"模型设置",-1)),t("div",Ze,[t("div",et,[l(C,{align:"center"},{default:b(()=>[e[21]||(e[21]=t("span",null,"AI智能总结",-1)),l(p,null,{title:b(()=>[...e[20]||(e[20]=[U("开启后，搜索知识库时，由大模型自动总结文档，并给出总结后的结果",-1)])]),default:b(()=>[l(F(P),{class:"question-icon"})]),_:1}),l(f,{style:{"margin-left":"24px"},onChange:B,checked:s.summary_switch,"onUpdate:checked":e[0]||(e[0]=a=>s.summary_switch=a),checkedValue:1,unCheckedValue:0,"checked-children":"开","un-checked-children":"关"},null,8,["checked"])]),_:1})])]),pe(t("div",null,[t("div",tt,[e[22]||(e[22]=t("div",{class:"prompt-form-item-label"},[t("span",{style:{color:"red"}},"* "),t("span",null,"模型选择")],-1)),l(ie,{modelType:"LLM",modeName:s.use_model,"onUpdate:modeName":e[1]||(e[1]=a=>s.use_model=a),modeId:s.model_config_id,"onUpdate:modeId":e[2]||(e[2]=a=>s.model_config_id=a),style:{width:"100%"},onLoaded:x,onChange:B},null,8,["modeName","modeId"])]),t("div",st,[e[25]||(e[25]=t("div",{class:"prompt-form-item-label"},[t("span",{style:{color:"red"}},"* "),t("span",null,"提示词")],-1)),l(r,{value:s.prompt_type,"onUpdate:value":e[3]||(e[3]=a=>s.prompt_type=a),onChange:d},{default:b(()=>[l(h,{value:"0"},{default:b(()=>[...e[23]||(e[23]=[U("默认提示词",-1)])]),_:1}),l(h,{value:"1"},{default:b(()=>[...e[24]||(e[24]=[U("自定义提示词",-1)])]),_:1})]),_:1},8,["value"]),t("div",at,[s.prompt_type=="0"?(m(),y("div",lt,"将提交的内容进行智能总结,不要随意发挥")):(m(),H(S,{key:1,onBlur:k,maxLength:500,style:{height:"80px"},value:s.prompt,"onUpdate:value":e[4]||(e[4]=a=>s.prompt=a),placeholder:"请输入自定义提示词"},null,8,["value"]))])]),t("div",ot,[t("div",nt,[e[27]||(e[27]=t("span",null,"温度",-1)),l(p,null,{title:b(()=>[...e[26]||(e[26]=[U("温度越低，回答越严谨。温度越高，回答越发散。",-1)])]),default:b(()=>[l(F(P),{class:"question-icon"})]),_:1})]),t("div",it,[t("div",rt,[t("div",dt,[l(N,{onBlur:k,class:"custom-slider",value:s.temperature,"onUpdate:value":e[5]||(e[5]=a=>s.temperature=a),min:0,max:2,step:.1},null,8,["value"])]),t("div",ct,[l(R,{onBlur:k,value:s.temperature,"onUpdate:value":e[6]||(e[6]=a=>s.temperature=a),min:0,max:2,step:.1},null,8,["value"])])])])]),t("div",ut,[t("div",mt,[e[29]||(e[29]=t("span",null,"最大token",-1)),l(p,null,{title:b(()=>[...e[28]||(e[28]=[t("div",null,"问题+答案的最大token数，如果出现回答被截断，可调高此值",-1)])]),default:b(()=>[l(F(P),{class:"question-icon"})]),_:1})]),t("div",_t,[t("div",pt,[t("div",vt,[l(N,{onBlur:k,class:"custom-slider",value:s.max_token,"onUpdate:value":e[7]||(e[7]=a=>s.max_token=a),min:0,max:100*1024},null,8,["value"])]),t("div",ft,[l(R,{onBlur:k,value:s.max_token,"onUpdate:value":e[8]||(e[8]=a=>s.max_token=a),min:0,max:100*1024},null,8,["value"])])])])])],512),[[ve,s.summary_switch==1]])]),t("div",ht,[t("div",gt,[e[38]||(e[38]=t("div",{class:"prompt-form-label"},"召回设置",-1)),t("div",yt,[e[31]||(e[31]=t("div",{class:"form-item-label"},[t("span",null,"检索模式")],-1)),t("div",kt,[t("div",bt,[(m(!0),y(Y,null,Z(I.value,a=>(m(),y("div",{class:re(["retrieval-mode-item",{active:s.search_type==a.value}]),key:a.value,onClick:ae=>n(a.value)},[s.search_type==a.value?(m(),H(z,{key:0,class:"check-arrow",name:"check-arrow-filled"})):V("",!0),t("div",$t,[l(z,{name:a.iconName,class:"title-icon"},null,8,["name"]),t("span",St,T(a.title),1),a.isRecommendation?(m(),H(z,{key:0,class:"recommendation-icon",name:"recommendation"})):V("",!0)]),t("div",wt,T(a.desc),1)],10,xt))),128))])])]),t("div",Lt,[t("div",Ct,[e[33]||(e[33]=t("span",null,"Top K ",-1)),l(p,null,{title:b(()=>[...e[32]||(e[32]=[U("最多从知识库中召回分段数，最低为1，最高为10。召回分段数越多，消耗的token也会越多。",-1)])]),default:b(()=>[l(F(P),{class:"question-icon"})]),_:1})]),t("div",At,[t("div",Mt,[t("div",Nt,[l(N,{onBlur:k,class:"custom-slider",value:s.top_k,"onUpdate:value":e[9]||(e[9]=a=>s.top_k=a),min:1,max:10},null,8,["value"])]),t("div",Rt,[l(R,{onBlur:k,value:s.top_k,"onUpdate:value":e[10]||(e[10]=a=>s.top_k=a),min:1,max:10},null,8,["value"])])])])]),s.search_type!=3&&s.search_type!=4?(m(),y("div",It,[t("div",Ut,[e[35]||(e[35]=t("span",null,"相似度阈值 ",-1)),l(p,null,{title:b(()=>[...e[34]||(e[34]=[U("召回时，只会召回相似度大于阈值的文本分段。取值范围：0~1，阈值越大回答的越准确，建议不超过0.9",-1)])]),default:b(()=>[l(F(P),{class:"question-icon"})]),_:1})]),t("div",qt,[t("div",Ot,[t("div",Tt,[l(N,{onBlur:k,class:"custom-slider",value:s.similarity,"onUpdate:value":e[11]||(e[11]=a=>s.similarity=a),min:0,max:1,step:.01},null,8,["value"])]),t("div",Bt,[l(R,{onBlur:k,value:s.similarity,"onUpdate:value":e[12]||(e[12]=a=>s.similarity=a),min:0,max:1,step:.01},null,8,["value"])])])])])):V("",!0),t("div",Et,[t("div",zt,[e[37]||(e[37]=t("span",null,"Rerank模型 ",-1)),l(p,null,{title:b(()=>[...e[36]||(e[36]=[U("召回时，只会召回相似度大于阈值的文本分段。取值范围：0~1，阈值越大回答的越准确，建议不超过0.9",-1)])]),default:b(()=>[l(F(P),{class:"question-icon"})]),_:1}),l(f,{onChange:k,style:{float:"right"},checkedValue:1,unCheckedValue:0,checked:s.rerank_status,"onUpdate:checked":e[13]||(e[13]=a=>s.rerank_status=a),"checked-children":"开","un-checked-children":"关"},null,8,["checked"])]),s.rerank_status==1?(m(),y("div",Ft,[l(ie,{modelType:"RERANK",modeName:s.rerank_use_model,"onUpdate:modeName":e[14]||(e[14]=a=>s.rerank_use_model=a),modeId:s.rerank_model_config_id,"onUpdate:modeId":e[15]||(e[15]=a=>s.rerank_model_config_id=a),style:{width:"100%"},placeholder:"请选择Rerank模型",onChange:k},null,8,["modeName","modeId"])])):V("",!0)])])]),l(g,{open:_.value,"onUpdate:open":e[17]||(e[17]=a=>_.value=a),onCancel:j,title:"请输入自定义提示词",onOk:K},{default:b(()=>[l(S,{value:u.value,"onUpdate:value":e[16]||(e[16]=a=>u.value=a),placeholder:"请输入",style:{"min-height":"300px"},"allow-clear":""},null,8,["value"])]),_:1},8,["open"])]),_:1},8,["open"])],64)}}}),Vt=Q(jt,[["__scopeId","data-v-9e010549"]]),Kt={class:"no-data"},Dt={class:"no-data-text"},Pt={__name:"list-empty",props:{text:{type:String,default:"暂无数据"},size:{type:[Number,String],default:100}},setup($){const i=$;return(M,q)=>{const v=se;return m(),y("div",Kt,[l(v,{name:"empty-document",style:he({"font-size":`${i.size}px`,color:"white"})},null,8,["style"]),t("div",Dt,[ge(M.$slots,"default",{},()=>[U(T(i.text),1)],!0)])])}}},Jt=Q(Pt,[["__scopeId","data-v-f4fa2763"]]),Ht={class:"search-box-warpper"},Gt={class:"search-box-content"},Yt={class:"search-set-box"},Qt={key:0,class:"search-content"},Wt={class:"search-input-box"},Xt={key:1,class:"search-content search-main"},Zt={class:"search-input-box"},es={key:1,class:"search-content-box"},ts={class:"search-tip-box"},ss={key:0,class:"tip"},as={key:1,class:"tip complete"},ls={key:0,class:"container"},os={key:1,class:"intelligent-answer"},ns=["innerHTML"],is={key:1},rs={class:"section-box"},ds={key:0,class:"section-label"},cs={class:"section-item-nav"},us={class:"section-item-nav-left"},ms=["onClick"],_s={key:0},ps={class:"section-item-nav-right"},vs=["innerHTML"],fs={__name:"search-box",props:{librarySearchData:{type:Object,default:null},messageObj:{type:Object,default:null},library_ids:{type:Array,default:()=>[]},isError:{type:Boolean,default:!1}},emits:["search","defaultParmas"],setup($,{expose:i,emit:M}){const q=M,v=$,I=new Qe({html:!0,linkify:!0,typographer:!0}),L=w(""),s=w(""),B=w(!1),E=w(!1),x=w({});X(()=>v.messageObj.content,()=>{L.value=I.render(v.messageObj.content)}),X(()=>v.messageObj.error,e=>{e&&W(e)});const n=async()=>{if(!v.library_ids.length)return W("请在左侧的知识库选择项内至少选择一个知识库");if(!s.value)return W("请输入消息内容");q("search",s.value),B.value=!0};function c(e){return e.match(/^-?\d+(?:\.\d{0,2})?/)[0]}const k=(e,o)=>{if(!e||!o.trim())return e;const p=o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),f=new RegExp(`(${p})`,"gi");return e.replace(f,'<span class="highlight">$1</span>')},_=e=>{if(!e.file_name){window.open(`#/library/details/categary-manage?id=${e.library_id}`);return}window.open(`#/library/preview?id=${e.file_id}`)},u=w(v.librarySearchData),d=G({rerank_status:"",rerank_use_model:"",prompt:"",model_config_id:"",use_model:"",temperature:.5,max_token:2e3,similarity:.4,search_type:1,summary_switch:0}),K=w({}),j=e=>{u.value=e;let o={model_config_id:e.model_config_id||d.model_config_id,use_model:e.use_model||d.use_model,temperature:e.temperature||d.temperature,max_token:e.max_token||d.max_token,size:200,similarity:e.similarity||d.similarity,search_type:e.search_type||d.search_type,summary_switch:e.summary_switch||d.summary_switch,question:s.value,id:v.library_ids.join(","),recall_type:1};e.rerank_status&&(o.rerank_status=e.rerank_status),e.rerank_use_model&&(o.rerank_use_model=e.rerank_use_model),e.prompt&&(o.prompt=e.prompt),e.rerank_status==1&&(o.rerank_model_config_id=e.rerank_model_config_id),E.value=!0,K.value=Object.assign(o),q("defaultParmas",K.value),Se(o).then(p=>{x.value=p.data}).catch(()=>{}).finally(()=>{E.value=!1})},O=w([]);function J(e,o,p){const f=new Set(e.map(C=>C.model_define));return o.filter(C=>{let h=C[p];f.has(h)&&e.filter(r=>{if(r.model_define==h)return r.children=we(r.children,C.children),!1})}),e}const A=async()=>{await qe({model_type:"LLM"}).then(e=>{let o=e.data||[],p=[];O.value=o.map(f=>{p=[];for(let C=0;C<f.model_info.llm_model_list.length;C++){const h=f.model_info.llm_model_list[C];p.push({name:h,deployment_name:f.model_config.deployment_name,model_config_id:f.model_config.id,model_define:f.model_info.model_define})}return{model_config_id:f.model_config.id,name:f.model_info.model_name,model_define:f.model_info.model_define,icon:f.model_info.model_icon_url,children:p,deployment_name:f.model_config.deployment_name}}),O.value=J($e(O.value,"model_define"),O.value,"model_define")})};return te(async()=>{await A(),setTimeout(()=>{var e,o,p,f,C;if(u.value=v.librarySearchData,v.librarySearchData,!((e=u.value)!=null&&e.model_config_id)||!((o=u.value)!=null&&o.use_model)){if(O.value.length>0){let h=O.value[0];if(h){let r=h.children[0];d.use_model=r.name,d.model_config_id=r.model_config_id}}}else d.use_model=((p=u.value)==null?void 0:p.use_model)+"$$",d.model_config_id=((f=u.value)==null?void 0:f.model_config_id)+"$$",d.use_model=d.use_model.split("$$")[0],d.model_config_id=(C=u.value)==null?void 0:C.model_config_id.split("$$")[0]},500)}),i({handleRecallTest:j}),(e,o)=>{const p=se,f=Je,C=ce;return m(),y("div",Ht,[t("div",Gt,[t("div",Yt,[l(Vt,{librarySearchData:u.value},null,8,["librarySearchData"])]),B.value?(m(),y("div",Xt,[t("div",Zt,[l(f,{class:"search-input",onPressEnter:n,value:s.value,"onUpdate:value":o[1]||(o[1]=h=>s.value=h),"allow-clear":"",placeholder:"输入关键词搜索"},{suffix:b(()=>[t("div",{class:"search-icon-box",onClick:n},[l(p,{class:"search-icon",name:"search-right"})])]),_:1},8,["value"])]),!L.value&&$.messageObj.finish&&!x.value.length?(m(),H(Jt,{key:0,style:{"margin-top":"100px"},size:"250"},{default:b(()=>[...o[4]||(o[4]=[t("div",null,[t("p",{style:{color:"#262626","font-size":"16px","font-weight":"600","line-height":"24px"}},"暂无任何内容")],-1)])]),_:1})):(m(),y("div",es,[t("div",ts,[l(p,{class:"nav-icon",name:"search-tip"}),$.messageObj.finish?(m(),y("span",as,"智能回答生成完毕")):(m(),y("span",ss,"智能回答生成中..."))]),!$.messageObj.content&&!$.messageObj.finish&&!$.isError?(m(),y("div",ls,[...o[5]||(o[5]=[ye('<div class="rect-container rect1" data-v-d07cc6e3><div class="rect" data-v-d07cc6e3></div></div><div class="rect-container rect2" data-v-d07cc6e3><div class="rect" data-v-d07cc6e3></div></div><div class="rect-container rect3" data-v-d07cc6e3><div class="rect" data-v-d07cc6e3></div></div>',3)])])):(m(),y("div",os,[L.value?(m(),y("div",{key:0,innerHTML:L.value},null,8,ns)):(m(),y("div",is,"暂无任何内容"))])),t("div",rs,[o[7]||(o[7]=t("div",{class:"tips"},[t("div",{class:"tips-text"},"以上内容由大模型生成"),t("div",{class:"tips-line"})],-1)),x.value.length?(m(),y("div",ds,[o[6]||(o[6]=U("相关分段 ",-1)),t("div",null,"("+T(x.value.length)+")",1)])):V("",!0),(m(!0),y(Y,null,Z(x.value,h=>(m(),y("div",{class:"section-item",key:h.id},[t("div",cs,[t("div",us,[l(p,{class:"section-item-icon",name:"document"}),t("div",{class:"section-item-label",onClick:r=>_(h)},[U(T(h.file_name),1),h.file_name?V("",!0):(m(),y("span",_s,T(h.library_name)+"-精选",1))],8,ms)]),t("div",ps,"相似度："+T(c(h.similarity)),1)]),l(C,{overlayClassName:"search-content-tip",placement:"top"},{title:b(()=>[U(T(h.content),1)]),default:b(()=>[t("div",{class:"section-item-content",innerHTML:k(h.content,s.value)},null,8,vs)]),_:2},1024)]))),128))])]))])):(m(),y("div",Qt,[o[2]||(o[2]=t("div",{class:"search-label"},"知识搜索",-1)),o[3]||(o[3]=t("div",{class:"search-tip"},"快速搜索所选择的知识库中内容",-1)),t("div",Wt,[l(f,{class:"search-input",onPressEnter:n,value:s.value,"onUpdate:value":o[0]||(o[0]=h=>s.value=h),"allow-clear":"",placeholder:"输入关键词搜索"},{suffix:b(()=>[t("div",{class:"search-icon-box",onClick:n},[l(p,{class:"search-icon",name:"search-right"})])]),_:1},8,["value"])])]))])])}}},hs=Q(fs,[["__scopeId","data-v-d07cc6e3"]]),gs={class:"cu-tabs"},ys=["onClick"],ks={__name:"contain-tabs",props:{value:{type:[Number,String],required:!0},tabs:{type:Array,required:!0,default:()=>[]}},emits:["update:value","change"],setup($,{emit:i}){const M=i,q=$,v=I=>{M("update:value",I),M("change",I)};return(I,L)=>(m(),y("div",gs,[(m(!0),y(Y,null,Z($.tabs,s=>(m(),y("div",{class:re(["tab-item",{active:q.value===s.value}]),onClick:B=>v(s.value),key:s.value},T(s.title),11,ys))),128))]))}},bs=Q(ks,[["__scopeId","data-v-a6e0ef08"]]),xs=de("searchStore",{state:()=>({indeterminate:!1,checkAll:!1,checkedList:[],activeKey:"all"}),getters:{getIndeterminate(){return this.indeterminate},getCheckAll(){return this.checkAll},getCheckedList(){return this.checkedList},getActiveKey(){return this.activeKey}},actions:{setIndeterminate($){this.indeterminate=$},setCheckAll($){this.checkAll=$},setCheckedList($){this.checkedList=$},setActiveKey($){this.activeKey=$}},persist:{enabled:!0,strategies:[{key:"searchStore",storage:localStorage,paths:["indeterminate","checkAll","checkedList","activeKey"]}]}}),$s=de("search-lirary",()=>{const $=We(),i=G({reasoning_content:"",show_reasoning:!1,content:"",quote_file:[],id:"",finish:!1,debug:[],error:[],recall_time:0,request_time:0,loading:!1});let M=null;const q=w(0),v=w(""),I=G({context_pair:"",create_time:"",id:"",max_token:"",model_config_id:"",rerank_model_config_id:"",rerank_status:"",rerank_use_model:"",search_type:"",similarity:"",size:"",temperature:"",update_time:"",use_model:"",user_id:"",summary_switch:0}),L=(x,n)=>{if(x=="reasoning_content"){let c=i.reasoning_content||"";i.reasoning_content=c+n,i.show_reasoning=!0}if(x=="sending"){let c=i.content||"";i.content=c+n}if(x=="quote_file"&&(i.quote_file=n.length>0?n:[]),x=="ai_message"){if(n.menu_json&&n.msg_type==2){let c=JSON.parse(n.menu_json);i.question=c.question}i.id=n.id,i.content=n.content,n.quote_file&&typeof n.quote_file=="string"&&(i.quote_file=JSON.parse(n.quote_file))}x=="finish"&&(i.finish=!0),x=="debug"&&(i.debug=n.length>0?n:[]),x=="error"&&(i.error=n.length>0?n:[]),x=="recall_time"&&(i.recall_time=n||0),x=="request_time"&&(i.request_time=n||0),$.emit("updateAiMessage",i)},s=()=>{i.loading=!1};return{searchFormState:I,dialogue_id:q,openid:v,messageObj:i,getLibrarySearchFn:async()=>{M&&(M.abort(),M=null);const x=await Me();try{let n=x.data;Object.assign(I,{...n})}catch(n){Promise.reject(n)}return x},searchMessage:(x,n,c)=>{Le(32),i.content="",i.finish=!1;let k={model_config_id:c.model_config_id,use_model:c.use_model,temperature:c.temperature,max_token:c.max_token,size:c.size,similarity:c.similarity,search_type:c.search_type,question:x,id:n.join(","),recall_type:1,summary_switch:c.summary_switch};c.rerank_status&&(k.rerank_status=c.rerank_status),c.rerank_use_model&&(k.rerank_use_model=c.rerank_use_model),c.prompt&&(k.prompt=c.prompt),c.rerank_status==1&&(k.rerank_model_config_id=c.rerank_model_config_id),M=Ce(k),M.onMessage=_=>{if(_.event!=="sending"&&Ae(_),_.event=="dialogue_id"&&(q.value=_.data),_.event=="reasoning_content"&&L("reasoning_content",_.data),_.event=="sending"&&L("sending",_.data),_.event=="ai_message"){let u=JSON.parse(_.data);L("ai_message",u)}if(_.event=="quote_file"){let u=JSON.parse(_.data);L("quote_file",u)}if(_.event=="finish"&&L("finish",_.data),_.event=="debug"){let u=JSON.parse(_.data);L("debug",u)}if(_.event=="error"){let u=_.data;L("error",u)}if(_.event=="recall_time"){let u=_.data;L("recall_time",u)}},M.onClose=()=>{s(),M=null}}}}),Ss={class:"chat-monitor-page"},ws={class:"page-left"},Ls={class:"toolbar-box"},Cs={class:"library-checkbox-box"},As={class:"app-list-box"},Ms={class:"list-box",ref:"scrollContainer"},Ns={class:"list-item"},Rs={class:"list-item-box"},Is={class:"library-icon"},Us=["onClick"],qs={class:"page-body"},Os={__name:"index",setup($){const i=xs();let{getIndeterminate:M,getCheckAll:q,getCheckedList:v,getActiveKey:I}=ne(i);const L=$s(),{getLibrarySearchFn:s,searchMessage:B}=L,{messageObj:E}=ne(L),x=w(null),n=w(null),c=w("all"),k=w([{title:"全部",value:"all"},{title:"普通",value:"0"},{title:"问答",value:"2"}]),_=w({}),u=w([]),d=G({indeterminate:!1,checkAll:!1,checkedList:[]}),K=r=>{_.value=r},j=w(!1),O=async r=>{var N;j.value=!1;let S=await s();if(n.value=S.data,n.value.id||(n.value=Object.assign(_.value)),n.value,!n.value.model_config_id||!n.value.use_model)return j.value=!0,W("请在搜索设置中配置好相应配置后再使用");(N=x.value)==null||N.handleRecallTest(n.value),B(r,d.checkedList,n.value)},J=r=>{Object.assign(d,{checkedList:r.target.checked?u.value.map(S=>S.id):[],indeterminate:!!d.checkedList.length&&d.checkedList.length<u.value.length}),i.setCheckedList(d.checkedList),i.setIndeterminate(d.indeterminate)},A=r=>{i.setCheckedList(r)},e=r=>{window.open(`#/library/details/knowledge-document?id=${r}`)};X(()=>d.checkedList,r=>{d.indeterminate=!!r.length&&r.length<u.value.length,d.checkAll=r.length>=u.value.length,i.setIndeterminate(d.indeterminate),i.setCheckAll(d.checkAll)});const o=()=>{u.value.forEach(r=>{r.type==0,r.type==2}),k.value=[{title:"全部",value:"all"},{title:"普通",value:"0"},{title:"问答",value:"2"}]},p=(r,S)=>{if(S.length===0)return!1;const N=new Set(r);return S.every(R=>N.has(R))},f=(r,S)=>!S.some(N=>r.includes(N)),C=async()=>{let r=c.value==="all"?"":c.value;await Ne({type:r}).then(S=>{var z;let N=S.data||[];N.forEach(g=>{g.file_size_str=Re(g.file_size),g.avatar||(g.avatar=g.type==0?Ie:Ue)}),u.value=N;const R=u.value.map(g=>g.id);if((z=v.value)!=null&&z.length&&(R!=null&&R.length)){const g=v.value,D=R,a=p(g,D),ae=f(g,D),le=g.length>=D.length&&a,oe={checkAll:le,indeterminate:!le&&!ae};i.$patch(oe),Object.assign(d,oe)}else{const g={checkAll:!1,indeterminate:!1};i.$patch(g),Object.assign(d,g)}d.checkedList=v.value,d.indeterminate=M.value,!q.value&&v.value.length==0&&!M.value&&I.value=="all"&&(i.setCheckAll(!0),d.checkedList=R,i.setCheckedList(R)),c.value==="all"&&o()})},h=r=>{i.setActiveKey(r),C()};return te(async()=>{I.value&&(c.value=I.value),await C();let r=await s();n.value=r.data}),ke(()=>{}),(r,S)=>{const N=He,R=Ye,z=Ge;return m(),y("div",Ss,[t("div",ws,[t("div",Ls,[l(bs,{tabs:k.value,value:c.value,"onUpdate:value":S[0]||(S[0]=g=>c.value=g),onChange:h},null,8,["tabs","value"])]),t("div",Cs,[t("div",As,[l(N,{checked:d.checkAll,"onUpdate:checked":S[1]||(S[1]=g=>d.checkAll=g),indeterminate:d.indeterminate,onChange:J},{default:b(()=>[...S[3]||(S[3]=[U(" 全选/取消 ",-1)])]),_:1},8,["checked","indeterminate"])]),l(z,{value:d.checkedList,"onUpdate:value":S[2]||(S[2]=g=>d.checkedList=g),onChange:A},{default:b(()=>[t("div",Ms,[(m(!0),y(Y,null,Z(u.value,g=>(m(),y("div",{class:"list-item-wraapper",key:g.id},[t("div",Ns,[l(N,{value:g.id},null,8,["value"]),t("div",Rs,[t("div",Is,[l(R,{preview:!1,width:32,src:g.avatar},null,8,["src"])]),t("div",{class:"library-name",onClick:D=>e(g.id)},T(g.library_name),9,Us)])])]))),128))],512)]),_:1},8,["value"])])]),t("div",qs,[l(hs,{ref_key:"searchBoxRef",ref:x,onDefaultParmas:K,onSearch:O,isError:j.value,messageObj:F(E),librarySearchData:n.value,library_ids:d.checkedList},null,8,["isError","messageObj","librarySearchData","library_ids"])])])}}},Js=Q(Os,[["__scopeId","data-v-23754b52"]]);export{Js as default};
