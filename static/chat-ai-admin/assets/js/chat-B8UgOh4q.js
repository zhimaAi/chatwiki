import{X as Q,f as c,r as C}from"./vue-chunks-yZ4gwLzA.js";import{a as Z,s as ee,q as ae,g as J,b as te,d as oe,e as ie}from"./index-WejToLyd.js";import{Y as ne}from"./index-BT8AeJHF.js";import{b4 as A,b5 as P,ah as g,b6 as se}from"../../index-ZzVqUZIR.js";import{u as re}from"./useEventBus-DbXWCKa0.js";import{u as le}from"./useIM-pdql3nFx.js";const me=Q("chat",()=>{const k=re(),i=c([]),S=le();let d=null;const u=c(0),j=c(),v=c(""),s=C({admin_user_id:"",avatar:"",id:"",name:"",nickname:"",openid:""}),o=C({id:"",library_ids:"",form_ids:"",prompt:"",robot_avatar:"",robot_intro:"",robot_key:"",robot_name:"",openid:"",welcomes:{reasoning_content:"",content:"",question:[]},enable_question_guide:!1,enable_common_question:!1,common_question_list:[],question_multiple_switch:0}),I=async e=>{i.value=[],y.value=!1,p.value=!1,e.dialogue_id?u.value=e.dialogue_id:u.value=0,j.value=e.rel_user_id,v.value=e.openid||A(),o.robot_key=e.robot_key,o.openid=v.value,s.openid=v.value,s.avatar=e.avatar||P,s.name=e.name||"",s.nickname=e.nickname||""},b=c(!1),M=async e=>{d&&(d.abort(),d=null),i.value=[],y.value=!1,p.value=!1,e.dialogue_id?(b.value=!1,u.value=e.dialogue_id):(b.value=!0,u.value=0),v.value=e.openid||A(e.robot_key),o.robot_key=e.robot_key,o.openid=v.value,s.openid=v.value,s.avatar=e.avatar||P,s.name=e.name||"",s.nickname=e.nickname||"";const t=await Z({robot_key:o.robot_key,openid:v.value,nickname:s.nickname,name:s.name,is_background:e.is_background||void 0});try{let l=t.data.customer,a=t.data.robot;return s.admin_user_id=l.admin_user_id,s.avatar=l.avatar,s.id=l.id,s.name=l.name,s.nickname=l.nickname,o.library_ids=a.library_ids,o.prompt=a.prompt,o.robot_avatar=a.robot_avatar,o.robot_intro=a.robot_intro,o.robot_key=a.robot_key,o.robot_name=a.robot_name,o.form_ids=a.form_ids,o.id=a.id,o.enable_question_guide=a.enable_question_guide=="true",o.enable_common_question=a.enable_common_question=="true",o.common_question_list=a.common_question_list,o.question_multiple_switch=Number(a.question_multiple_switch)||0,a.welcomes&&(o.welcomes=JSON.parse(a.welcomes)),x(t.data.message),S.connect(v.value),S.on("message",R),t}catch(l){Promise.reject(l)}},R=e=>{if(e&&e.msg_type!="receiver_notify"&&e.dialogue_id==u.value){if(e.uid=g(32),e.loading=!1,e.isWelcome=!0,e.name=e.name||e.nickname,e.is_customer==1?(e.name=e.name||s.name,e.avatar=e.avatar||s.avatar):(e.name=e.name||o.name,e.robot_avatar=e.avatar||o.robot_avatar),e.menu_json&&typeof e.menu_json=="string"&&(e.menu_json=JSON.parse(e.menu_json)),e.quote_file&&typeof e.quote_file=="string"&&(e.quote_file=JSON.parse(e.quote_file)),e.reply_content_list&&typeof e.reply_content_list=="string")try{e.reply_content_list=JSON.parse(e.reply_content_list)}catch{e.reply_content_list=[]}i.value.push(e),k.emit("updateAiMessage",e)}},x=e=>{e&&(e.uid=g(32),e.loading=!1,e.isWelcome=!0,e.robot_avatar=o.robot_avatar,e.menu_json&&(e.menu_json=JSON.parse(e.menu_json)),e.quote_file&&(e.quote_file=JSON.parse(e.quote_file)),i.value.push(e))},z=e=>{e.uid=g(32),e.loading=!1,e.avatar=s.avatar,e.openid=s.openid,e.msg_type=e.msg_type||1,e.is_customer=1,i.value.push(e)},E=e=>{i.value.push(e),k.emit("updateAiMessage",e)},_=(e,t,l)=>{let a=i.value.findIndex(n=>n.uid==l);if(e=="reasoning_content"){let n=i.value[a].reasoning_content||"";i.value[a].reasoning_content=n+t,i.value[a].reasoning_status=!0,i.value[a].show_reasoning=!0}if(e=="sending"){i.value[a].reasoning_status=!1;let n=i.value[a].content||"";i.value[a].content=n+t}if(e=="start_quote_file"&&(i.value[a].quote_loading=!0),e=="quote_file"&&(i.value[a].quote_file=t.length>0?t:[],i.value[a].show_quote_file=!0,i.value[a].quote_loading=!1),e=="ai_message"){if(t.menu_json&&t.msg_type==2){let n=JSON.parse(t.menu_json);i.value[a].question=n.question}i.value[a].id=t.id,i.value[a].content=t.content,t.reply_content_list!==void 0&&typeof t.reply_content_list=="string"&&(i.value[a].reply_content_list=JSON.parse(t.reply_content_list)),t.quote_file&&typeof t.quote_file=="string"&&(i.value[a].quote_file=JSON.parse(t.quote_file))}e=="debug"&&(i.value[a].debug=t.length>0?t:[]),e=="error"&&(i.value[a].error=t.length>0?t:[]),e=="recall_time"&&(i.value[a].recall_time=t||0),e=="request_time"&&(i.value[a].request_time=t||0),e=="guess_you_want"&&(i.value=i.value.map(n=>({...n,question_tabkey:-1,guess_you_want:[]})),i.value[a].guess_you_want=t,i.value[a].question_tabkey=t.length>0?1:2),e=="set_question_tabkey"&&(i.value=i.value.map(n=>({...n,question_tabkey:-1})),i.value[a].question_tabkey=t),k.emit("updateAiMessage",i.value[a])},W=()=>{let e=i.value.length-1;i.value[e].loading=!1},p=c(!1),T=e=>{if(p.value)return;let t={loading:!0,id:"",content:"",reasoning_content:"",uid:g(32),robot_avatar:o.robot_avatar,msg_type:1,quote_file:[],debug:[],error:"",recall_time:"",request_time:"",show_reasoning:!1,reasoning_status:!1,quote_loading:!1,show_quote_file:!0},l={robot_key:o.robot_key,openid:o.openid,question:e.message,form_ids:o.form_ids,dialogue_id:u.value,global:e.global};p.value=!0,d=ee(l),d.onMessage=a=>{if(a.event!=="sending"&&se(a),a.event=="dialogue_id"&&(u.value=a.data),a.event=="c_message"){let n=JSON.parse(a.data);z(n)}if(a.event=="robot"&&(E(t),b.value&&(G(),b.value=!1)),a.event=="reasoning_content"&&_("reasoning_content",a.data,t.uid),a.event=="sending"&&_("sending",a.data,t.uid),a.event=="ai_message"){let n=JSON.parse(a.data);_("ai_message",n,t.uid)}if(a.event=="start_quote_file"&&_("start_quote_file",a.data,t.uid),a.event=="quote_file"){let n=JSON.parse(a.data);_("quote_file",n,t.uid)}if(a.event=="debug"){let n=JSON.parse(a.data);_("debug",n,t.uid)}if(a.event=="error"){let n=a.data;_("error",n,t.uid)}if(a.event=="recall_time"){let n=a.data;_("recall_time",n,t.uid)}if(a.event=="request_time"){let n=a.data;_("request_time",n,t.uid)}a.event=="finish"&&(o.enable_question_guide?ae({robot_key:o.robot_key,openid:o.openid,dialogue_id:u.value}).then(n=>{_("guess_you_want",n.data||[],t.uid)}):_("set_question_tabkey",2,t.uid))},d.onClose=()=>{W(),p.value=!1,d=null}},U=25,m=c([]),q=c(!1),w=c(!1),D=async()=>{if(w.value||q.value)return!1;let e=0;m.value.length>0&&(e=m.value[m.value.length-1].id),q.value=!0;const t=await J({min_id:e,size:U,robot_key:o.robot_key});q.value=!1;const l=t.data||[];return l.length===0?(w.value=!0,!1):(m.value=[...m.value,...l],t)},G=()=>{J({min_id:0,size:1,robot_key:o.robot_key}).then(e=>{const t=e.data||[];t[0]&&m.value.unshift(t[0])})},B=async e=>(d&&(d.abort(),d=null),await M(e)),F=20,y=c(!1),V=async()=>{var n;if(y.value)return;let e=0,t=i.value.filter(f=>!f.isWelcome);t.length>0&&(e=t[0].id);const l=u.value;let a={robot_key:o.robot_key,openid:s.openid,min_id:e,size:F,dialogue_id:l,rel_user_id:j.value};try{const f=await te(a);if(u.value!==l)return Promise.resolve(null);const h=f.data.list||[],N=((n=f==null?void 0:f.data)==null?void 0:n.customer)||{},L=f.data.robot;if(h.length===0){y.value=!0;return}return h.sort((r,O)=>r.id-O.id),h.forEach(r=>{if(r.loading=!1,r.uid=g(32),r.name=r.name||r.nickname,r.is_customer==1?(r.name=r.name||s.name||N.name,r.avatar=r.avatar||s.avatar||N.avatar):(r.name=r.name||o.robot_name||L.robot_name,r.robot_avatar=r.avatar||o.robot_avatar||L.robot_avatar,r.avatar=r.robot_avatar),r.menu_json&&(r.menu_json=JSON.parse(r.menu_json)),r.quote_file&&(r.quote_file=JSON.parse(r.quote_file)),r.reply_content_list&&typeof r.reply_content_list=="string")try{r.reply_content_list=JSON.parse(r.reply_content_list)}catch{r.reply_content_list=[]}}),i.value=[...h,...i.value],f}catch(f){Promise.reject(f)}},X=async e=>{try{const t=await oe(e);return t||Promise.reject(t)}catch(t){Promise.reject(t)}},Y=async e=>{try{const t=await ie(e);return t||Promise.reject(t)}catch(t){Promise.reject(t)}},$=e=>{o.prompt=e},H=()=>ne({id:o.id,prompt:o.prompt});function K(){S.close(),u.value=0,i.value=[],v.value="",s.admin_user_id="",s.avatar="",s.id="",s.name="",s.nickname="",s.openid="",o.id="",o.library_ids="",o.form_ids="",o.prompt="",o.robot_avatar="",o.robot_intro="",o.robot_key="",o.robot_name="",o.openid="",o.welcomes={content:"",question:[]},b.value=!1,y.value=!1,p.value=!1,q.value=!1,w.value=!1,m.value=[]}return{$reset:K,user:s,robot:o,dialogue_id:u,openid:v,sendLock:p,messageList:i,createChat:M,createMsg:I,sendMessage:T,getMyChatList:D,myChatList:m,openChat:B,onGetChatMessage:V,changeRobotPrompt:$,saveRobotPrompt:H,getRecordList:X,getChannelList:Y}});export{me as u};
