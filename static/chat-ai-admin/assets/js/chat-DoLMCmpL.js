import{am as te,f as d,r as I}from"./vue-chunks-CGLjTDrY.js";import{a as oe,s as ie,q as ne,e as le,g as P,b as se,d as re,f as ue}from"./index-CmzDLrI5.js";import{a7 as _e}from"./index-BNO9ztvM.js";import{ba as x,bb as R,ag as h,bc as ve,bd as L,be as j}from"../../index-DxV-PNCd.js";import{u as de}from"./useEventBus-CB_rGuu7.js";import{u as ce}from"./useIM-CgIuP9SB.js";const he=te("chat",()=>{const S=de(),o=d([]),w=ce();let c=null;const _=d(0),M=d(),f=d(""),r=I({admin_user_id:"",avatar:"",id:"",name:"",nickname:"",openid:""}),i=I({id:"",library_ids:"",form_ids:"",prompt:"",robot_avatar:"",robot_intro:"",robot_key:"",robot_name:"",openid:"",welcomes:{reasoning_content:"",content:"",question:[]},enable_question_guide:!1,enable_common_question:!1,common_question_list:[],question_multiple_switch:0}),p=d({need_fill_variable:!1,fill_variables:[],wait_variables:[],session_id:0,dialogue_id:0}),E=async e=>{o.value=[],y.value=!1,m.value=!1,e.dialogue_id?_.value=e.dialogue_id:_.value=0,M.value=e.rel_user_id,f.value=e.openid||x(),i.robot_key=e.robot_key,i.openid=f.value,r.openid=f.value,r.avatar=e.avatar||R,r.name=e.name||"",r.nickname=e.nickname||""},g=d(!1),O=async e=>{c&&(c.abort(),c=null),o.value=[],y.value=!1,m.value=!1,e.dialogue_id?(g.value=!1,_.value=e.dialogue_id):(g.value=!0,_.value=0),f.value=e.openid||x(e.robot_key),i.robot_key=e.robot_key,i.openid=f.value,r.openid=f.value,r.avatar=e.avatar||R,r.name=e.name||"",r.nickname=e.nickname||"";const a=await oe({robot_key:i.robot_key,openid:f.value,nickname:r.nickname,name:r.name,is_background:e.is_background||void 0,dialogue_id:_.value});try{let u=a.data.customer,t=a.data.robot;return r.admin_user_id=u.admin_user_id,r.avatar=u.avatar,r.id=u.id,r.name=u.name,r.nickname=u.nickname,i.library_ids=t.library_ids,i.prompt=t.prompt,i.robot_avatar=t.robot_avatar,i.robot_intro=t.robot_intro,i.robot_key=t.robot_key,i.robot_name=t.robot_name,i.form_ids=t.form_ids,i.id=t.id,i.enable_question_guide=t.enable_question_guide=="true",i.enable_common_question=t.enable_common_question=="true",i.common_question_list=t.common_question_list,i.question_multiple_switch=Number(t.question_multiple_switch)||0,t.welcomes&&(i.welcomes=JSON.parse(t.welcomes)),p.value={},setTimeout(()=>{p.value=a.data.chat_variable||{}}),T(a.data.message),w.connect(f.value),w.on("message",z),a}catch(u){Promise.reject(u)}},z=e=>{if(e&&e.msg_type!="receiver_notify"&&e.dialogue_id==_.value){if(e.uid=h(32),e.loading=!1,e.isWelcome=!0,e.name=e.name||e.nickname,e.is_customer==1?(e.name=e.name||r.name,e.avatar=e.avatar||r.avatar):(e.name=e.name||i.name,e.robot_avatar=e.avatar||i.robot_avatar),e.menu_json&&typeof e.menu_json=="string"&&(e.menu_json=JSON.parse(e.menu_json)),e.quote_file&&typeof e.quote_file=="string"&&(e.quote_file=JSON.parse(e.quote_file)),e.reply_content_list&&typeof e.reply_content_list=="string")try{e.reply_content_list=JSON.parse(e.reply_content_list)}catch{e.reply_content_list=[]}o.value.push(e),S.emit("updateAiMessage",e)}},T=e=>{e&&(e.uid=h(32),e.loading=!1,e.isWelcome=!0,e.robot_avatar=i.robot_avatar,e.menu_json&&(e.menu_json=JSON.parse(e.menu_json)),e.quote_file&&(e.quote_file=JSON.parse(e.quote_file)),o.value.push(e))},V=e=>{e.uid=h(32),e.loading=!1,e.avatar=r.avatar,e.openid=r.openid,e.msg_type=e.msg_type||1,e.is_customer=1,o.value.push(e)},W=e=>{o.value.push(e),S.emit("updateAiMessage",e)},v=(e,a,u)=>{let t=o.value.findIndex(n=>n.uid==u);if(e=="reply_content_list"&&a!==void 0&&typeof a=="string"&&(o.value[t].reply_content_list=JSON.parse(a)),e=="reasoning_content"){let n=o.value[t].reasoning_content||"";o.value[t].reasoning_content=n+a,o.value[t].reasoning_status=!0,o.value[t].show_reasoning=!0}if(e=="sending"){o.value[t].startLoading=!1,o.value[t].reasoning_status=!1;let n=o.value[t].content||"";o.value[t].content=n+a,o.value[t].voice_content=L(o.value[t].content),o.value[t].content=j(o.value[t].content)}if(e=="start_quote_file"&&(o.value[t].quote_loading=!0),e=="quote_file"&&(o.value[t].quote_file=a.length>0?a:[],o.value[t].show_quote_file=!0,o.value[t].quote_loading=!1),e=="ai_message"){if(a.menu_json&&a.msg_type==2){let n=JSON.parse(a.menu_json);o.value[t].question=n.question}o.value[t].startLoading=!1,o.value[t].id=a.id,o.value[t].content=a.content,o.value[t].voice_content=L(o.value[t].content),o.value[t].content=j(o.value[t].content),a.reply_content_list!==void 0&&typeof a.reply_content_list=="string"&&(o.value[t].reply_content_list=JSON.parse(a.reply_content_list)),a.quote_file&&typeof a.quote_file=="string"&&(o.value[t].quote_file=JSON.parse(a.quote_file))}e=="debug"&&(o.value[t].debug=a.length>0?a:[]),e=="error"&&(o.value[t].error=a.length>0?a:[]),e=="recall_time"&&(o.value[t].recall_time=a||0),e=="request_time"&&(o.value[t].request_time=a||0),e=="guess_you_want"&&(o.value=o.value.map(n=>({...n,question_tabkey:-1,guess_you_want:[]})),o.value[t].guess_you_want=a,o.value[t].question_tabkey=a.length>0?1:2),e=="set_question_tabkey"&&(o.value=o.value.map(n=>({...n,question_tabkey:-1})),o.value[t].question_tabkey=a),S.emit("updateAiMessage",o.value[t])},U=()=>{let e=o.value.length-1;o.value[e].loading=!1},m=d(!1),D=e=>{if(m.value)return;let a={startLoading:!0,loading:!0,id:"",content:"",reasoning_content:"",uid:h(32),robot_avatar:i.robot_avatar,msg_type:1,quote_file:[],debug:[],error:"",recall_time:"",request_time:"",show_reasoning:!1,reasoning_status:!1,quote_loading:!1,show_quote_file:!0,voice_content:[]},u={robot_key:i.robot_key,openid:i.openid,question:e.message,form_ids:i.form_ids,dialogue_id:_.value,global:e.global},t=`chat_prompt_variables_${i.robot_key}`;localStorage.getItem(t)&&(u.chat_prompt_variables=localStorage.getItem(t),localStorage.removeItem(t)),m.value=!0,c=ie(u),c.onMessage=n=>{if(n.event!=="sending"&&ve(n),n.event=="dialogue_id"&&(_.value=n.data),n.event=="c_message"){let l=JSON.parse(n.data);V(l)}if(n.event=="robot"&&(W(a),g.value&&(B(),g.value=!1)),n.event=="reply_content_list"&&v("reply_content_list",n.data,a.uid),n.event=="reasoning_content"&&v("reasoning_content",n.data,a.uid),n.event=="sending"&&v("sending",n.data,a.uid),n.event=="ai_message"){let l=JSON.parse(n.data);v("ai_message",l,a.uid)}if(n.event=="start_quote_file"&&v("start_quote_file",n.data,a.uid),n.event=="quote_file"){let l=JSON.parse(n.data);v("quote_file",l,a.uid)}if(n.event=="debug"){let l=JSON.parse(n.data);v("debug",l,a.uid)}if(n.event=="error"){let l=n.data;v("error",l,a.uid)}if(n.event=="recall_time"){let l=n.data;v("recall_time",l,a.uid)}if(n.event=="request_time"){let l=n.data;v("request_time",l,a.uid)}if(n.event=="chat_prompt_variables"){let l=n.data;l&&(l=JSON.parse(l),p.value.need_fill_variable=l.need_fill_variable,p.value.fill_variables=l.fill_variables||[],p.value.session_id=l.session_id)}n.event=="finish"&&(i.enable_question_guide?ne({robot_key:i.robot_key,openid:i.openid,dialogue_id:_.value}).then(l=>{v("guess_you_want",l.data||[],a.uid)}):v("set_question_tabkey",2,a.uid))},c.onClose=()=>{U(),m.value=!1,c=null}},F=e=>{le({robot_key:i.robot_key,openid:i.openid,dialogue_id:_.value,chat_prompt_variables:JSON.stringify(e.chat_prompt_variables),session_id:p.value.session_id}).then(a=>{p.value.fill_variables=e.chat_prompt_variables})},G=25,b=d([]),q=d(!1),N=d(!1),$=async()=>{if(N.value||q.value)return!1;let e=0;b.value.length>0&&(e=b.value[b.value.length-1].id),q.value=!0;const a=await P({min_id:e,size:G,robot_key:i.robot_key});q.value=!1;const u=a.data||[];return u.length===0?(N.value=!0,!1):(b.value=[...b.value,...u],a)},B=()=>{P({min_id:0,size:1,robot_key:i.robot_key}).then(e=>{const a=e.data||[];a[0]&&b.value.unshift(a[0])})},H=async e=>(c&&(c.abort(),c=null),await O(e)),K=20,y=d(!1),Q=async()=>{var n;if(y.value)return;let e=0,a=o.value.filter(l=>!l.isWelcome);a.length>0&&(e=a[0].id);const u=_.value;let t={robot_key:i.robot_key,openid:r.openid,min_id:e,size:K,dialogue_id:u,rel_user_id:M.value};try{const l=await se(t);if(_.value!==u)return Promise.resolve(null);const k=l.data.list||[],J=((n=l==null?void 0:l.data)==null?void 0:n.customer)||{},C=l.data.robot;if(k.length===0){y.value=!0;return}return k.sort((s,A)=>s.id-A.id),k.forEach(s=>{if(s.loading=!1,s.uid=h(32),s.name=s.name||s.nickname,s.is_customer==1?(s.name=s.name||r.name||J.name,s.avatar=s.avatar||r.avatar||J.avatar):(s.name=s.name||i.robot_name||C.robot_name,s.robot_avatar=s.avatar||i.robot_avatar||C.robot_avatar,s.avatar=s.robot_avatar),s.menu_json&&(s.menu_json=JSON.parse(s.menu_json)),s.quote_file&&(s.quote_file=JSON.parse(s.quote_file)),s.reply_content_list&&typeof s.reply_content_list=="string")try{s.reply_content_list=JSON.parse(s.reply_content_list)}catch{s.reply_content_list=[]}s.voice_content=L(s.content),s.content=j(s.content)}),o.value=[...k,...o.value],l}catch(l){Promise.reject(l)}},X=async e=>{try{const a=await re(e);return a||Promise.reject(a)}catch(a){Promise.reject(a)}},Y=async e=>{try{const a=await ue(e);return a||Promise.reject(a)}catch(a){Promise.reject(a)}},Z=e=>{i.prompt=e},ee=()=>_e({id:i.id,prompt:i.prompt});function ae(){w.close(),_.value=0,o.value=[],f.value="",r.admin_user_id="",r.avatar="",r.id="",r.name="",r.nickname="",r.openid="",i.id="",i.library_ids="",i.form_ids="",i.prompt="",i.robot_avatar="",i.robot_intro="",i.robot_key="",i.robot_name="",i.openid="",i.welcomes={content:"",question:[]},g.value=!1,y.value=!1,m.value=!1,q.value=!1,N.value=!1,b.value=[]}return{$reset:ae,user:r,robot:i,dialogue_id:_,openid:f,sendLock:m,messageList:o,createChat:O,createMsg:E,sendMessage:D,getMyChatList:$,myChatList:b,openChat:H,onGetChatMessage:Q,changeRobotPrompt:Z,saveRobotPrompt:ee,getRecordList:X,getChannelList:Y,chat_variables:p,handleEditVariables:F}});export{he as u};
