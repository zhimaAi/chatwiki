import{u as re,_ as me,aj as Se,d as He,bh as Ne}from"../../index-DSFcP5NQ.js";import{a as s,b as t,p as e,q as f,h as ee,v as o,u as n,F as O,l as V,c as W,r as A,e as N,z as ue,y as _,t as w,Y as Ve,_ as P,D as ze,i as we,a1 as ye,V as Le,w as ge,n as Je,J as Me,a0 as Ke,E as Te,ag as Qe,ah as $e,aj as We,j as Ge,x as Ye}from"./vue-chunks-BdaA73Wf.js";import{u as Xe}from"./useEventBus--I0IFnMo.js";import{u as xe}from"./chat-BLPxWtxf.js";import{_ as be,V as Ze}from"./voice-message-B7-hRuYw.js";import{_ as te}from"./emoji-mart-BBMRoEa3.js";import{M as et}from"./multiple-message-B1FsoFt9.js";import{u as Ie}from"./robot-CIzNpArp.js";import{ag as Ee,a0 as ke,al as tt,q as Re,at as qe,b as _e,V as st,ac as ie,_ as Fe,M as Oe,c as ot,I as nt,G as lt,u as at,v as it,N as rt,F as ct,B as Ae,j as ut,aa as _t,k as dt,a1 as pt}from"./ui-antd-Dl1wwwCD.js";import{_ as Be}from"./cu-scroll-CpIj948h.js";import{q as mt}from"./other-LrIFyvU9.js";import{u as vt}from"./index-B_UHbFfL.js";import{u as De}from"./useMathJax-6Oa0Io1D.js";import{i as gt}from"./index-BuDcjXHQ.js";import{V as ht}from"./vue-pdf-embed-C94fDaAA.js";import{ac as ft}from"./index-Cg7-0swo.js";import"./neo4j-MWxXN7EM.js";import"./editor-cherry-CFIsbKoN.js";import"./lodash-Bm5sK6rN.js";import"./elkjs-BN8GIjVH.js";import"./utils-CvB22N-W.js";import"./useIM-DZUieDUI.js";import"./pull-up.esm-DIiTC7VE.js";import"./observe-dom.esm-B25JyVKH.js";const yt={class:"guess-you-want"},bt={class:"message-tabs"},kt={key:1,class:"v-line"},wt={key:0,class:"message-menus"},$t=["onClick"],xt={key:1,class:"message-menus"},qt=["onClick"],Ct={__name:"guess-you-want",props:{item:{type:Object,default:()=>{}},common_question_list:{type:Object,default:()=>[]},enable_common_question:{type:Boolean,default:!1}},emits:["clickMeun"],setup(I,{emit:y}){const{t:m}=re("views.robot.robot-test.components.guess-you-want"),q=y,p=I,$=(c,d)=>{c.question_tabkey=d},a=c=>{q("clickMeun",c)};return(c,d)=>(t(),s("div",yt,[e("div",bt,[p.item.guess_you_want?(t(),s("div",{key:0,onClick:d[0]||(d[0]=x=>$(p.item,1)),class:ee(["tab-item",{active:p.item.question_tabkey==1}])},o(n(m)("tab_guess_you_want")),3)):f("",!0),p.item.guess_you_want&&p.common_question_list&&p.enable_common_question?(t(),s("div",kt)):f("",!0),p.common_question_list&&p.enable_common_question?(t(),s("div",{key:2,onClick:d[1]||(d[1]=x=>$(p.item,2)),class:ee(["tab-item",{active:p.item.question_tabkey==2}])},o(n(m)("tab_common_questions")),3)):f("",!0)]),p.item.question_tabkey==1?(t(),s("div",wt,[(t(!0),s(O,null,V(p.item.guess_you_want,(x,i)=>(t(),s("div",{onClick:r=>a(x),class:"menu-item",key:i},o(x),9,$t))),128))])):(t(),s("div",xt,[(t(!0),s(O,null,V(I.common_question_list,(x,i)=>(t(),s("div",{onClick:r=>a(x),class:"menu-item",key:i},o(x),9,qt))),128))]))]))}},St=te(Ct,[["__scopeId","data-v-ed63d68a"]]),Lt={class:"text-message"},Mt={__name:"text-message",props:{message:String},setup(I){return(y,m)=>(t(),s("div",Lt,o(I.message),1))}},Tt={class:"message-list-wrapper"},It={class:"message-list"},Et=["id","data-msg_type"],Rt={class:"itme-left"},Ft=["src"],Ot={class:"itme-right"},At={class:"item-body"},Bt={key:0,class:"message-content"},Dt=["src"],Ut={key:1,class:"message-content"},Pt=["id"],jt={class:"itme-left"},Ht=["src"],Nt={class:"itme-right"},Vt={key:0,class:"reply-list"},zt={key:0,class:"reply-item reply-text"},Jt=["innerHTML"],Kt={key:1,class:"reply-item reply-image"},Qt={class:"message-content"},Wt=["src"],Gt={key:2,class:"reply-item reply-url"},Yt={class:"url-row"},Xt=["href"],Zt={key:3,class:"reply-item reply-card"},es={class:"card-row"},ts=["src"],ss={class:"card-title-box"},os={class:"card-title"},ns={key:4,class:"reply-item reply-imageText"},ls=["href"],as=["src"],is={class:"imageText-text"},rs={class:"imageText-title"},cs={class:"imageText-desc"},us={key:5,class:"reply-item reply-smartMenu"},_s={class:"smart-menu-box"},ds={key:0,class:"card-title"},ps={class:"card-text"},ms={key:0,class:"line-text"},vs={key:1,class:"empty-line"},gs=["innerHTML"],hs=["onClick"],fs={key:0},ys={class:"label-flex-block"},bs={key:0,class:"thinking-label-wrapper"},ks={class:"thinking-label"},ws={class:"label-text"},$s=["onClick"],xs={class:"label-text"},qs={class:"label-text"},Cs=["onClick"],Ss={class:"label-text"},Ls={key:1,class:"item-body"},Ms={key:0,class:"file-items"},Ts=["onClick"],Is={class:"file-name"},Es={key:0},Rs={key:1},Fs={key:1,class:"thinking-content"},Os={class:"message-content"},As={class:"message-menus"},Bs=["onClick"],Ds=["innerHTML"],Us={class:"message-menus"},Ps=["onClick"],js={key:4,class:"message-content"},Hs=["src"],Ns={key:5,class:"message-action-wrap"},Vs={key:0,class:"message-action"},zs={class:"action-btn"},Js=["onClick"],Ks={key:2},Qs={__name:"message-list",props:{messages:{type:Array,default:()=>[]},robotInfo:{type:Object,default:()=>{}}},emits:["clickMsgMeun","scroll","scrollStart","scrollEnd","openPromptLog","openLibrary"],setup(I,{expose:y,emit:m}){const{t:q}=re("views.robot.robot-test.components.message-list"),p=Ie(),$=W(()=>p.robotInfo.tips_before_answer_content),a=W(()=>p.robotInfo.tips_before_answer_switch=="true"),c=m,d=I,x=g=>{g.show_reasoning=!g.show_reasoning},i=g=>{g.show_quote_file=!g.show_quote_file},r=W(()=>d.robotInfo.common_question_list.length?JSON.parse(d.robotInfo.common_question_list):[]),v=W(()=>(d.robotInfo.chat_type==1||d.robotInfo.chat_type==3)&&d.robotInfo.application_type=="0"),C=g=>{c("clickMsgMeun",g)},L=A(null),b={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let j=null,J=!1;function S(g){J||(j&&(clearTimeout(j),j=null),j=setTimeout(()=>{b.scrollTop-g.target.scrollTop>0&&(b.scrollDirection="up"),b.scrollTop-g.target.scrollTop<0&&(b.scrollDirection="down"),b.scrollTop=g.target.scrollTop,b.scrollHeight=g.target.scrollHeight,b.clientHeight=g.target.clientHeight,c("scroll",{...b}),Math.abs(b.scrollTop)<=b.scrollStartDiff&&b.scrollDirection==="up"&&k(),Math.abs(b.scrollHeight-b.scrollTop-b.clientHeight)<=b.scrollEndDiff&&b.scrollDirection==="down"&&B()},50))}function k(){d.messages.length!=0&&c("scrollStart",{msg:d.messages[0]})}function B(){d.messages.length!=0&&c("scrollEnd",{msg:d.messages[d.messages.length-1]})}const K=()=>{L.value&&we(()=>{J=!0,L.value.scrollTop=L.value.scrollHeight+1,setTimeout(()=>{b.scrollTop=L.value.scrollTop,J=!1},50)})};function M(g,E){we(()=>{J=!0,E||(E="top");let R=L.value,F=document.querySelector("#msg-"+g);E=="top"?R.scrollTop=F.offsetTop:R.scrollTop=F.offsetTop-R.clientHeight+F.clientHeight,setTimeout(()=>{b.scrollTop=L.value.scrollTop,J=!1},50)})}function D(){b.scrollTop=0,b.scrollDirection=""}function Q(g){return!!(g.quote_file&&g.quote_file.length>0||g.debug&&g.debug.length>0)}function Y(g){c("openPromptLog",ye(g))}function ne(g,E,R){let F=ye(g);E.message_id=E.message_id||R,F.forEach(H=>{H.message_id=H.message_id||R}),c("openLibrary",F,ye(E))}function X(g){try{return g?Array.isArray(g)?g:typeof g=="string"?JSON.parse(g||"[]"):[]:[]}catch{return[]}}function le(g){const E=[];return(Array.isArray(g)?g:[]).forEach(R=>{const F=String((R==null?void 0:R.menu_type)||""),H=String((R==null?void 0:R.content)||"");if(F==="0")if(H==="")E.push({kind:"newline"});else if(/<a[\s\S]*?<\/a>/.test(H)){const se=/href\s*=\s*['"]\s*#\s*['"]/i.test(H)?H.replace(/href\s*=\s*['"]\s*#\s*['"]/ig,'href="javascript:;"'):H.replace(/href=/ig,'target="_blank" href=');E.push({kind:"html",html:se})}else E.push({kind:"text",text:H});else F==="1"&&E.push({kind:"keyword",text:H,serial_no:(R==null?void 0:R.serial_no)||""})}),E.slice(0,20)}function u(g){var F,H;const E=(H=(F=g.target)==null?void 0:F.closest)==null?void 0:H.call(F,"a");if(!E)return;const R=String(E.getAttribute("href")||"");(R==="#"||R==="javascript:;")&&(g.preventDefault(),g.stopPropagation())}function U(g){const E=String(g||"").trim();E&&c("clickMsgMeun",E)}const de=g=>!(X(g.reply_content_list).length&&g.content=="");return y({scrollToBottom:K,scrollToMessage:M,resetScroll:D}),(g,E)=>{const R=Ee,F=me,H=Re,se=Le("viewer");return t(),s("div",Tt,[e("div",{class:"scroll-box",ref_key:"scrollBoxRef",ref:L,onScroll:S},[e("div",It,[(t(!0),s(O,null,V(d.messages,l=>(t(),s(O,{key:l.uid},[l.is_customer==1?(t(),s("div",{key:0,class:"message-item user-message",id:"msg-"+l.uid,"data-msg_type":l.msg_type},[e("div",Rt,[e("img",{class:"user-avatar",src:l.avatar},null,8,Ft)]),e("div",Ot,[e("div",At,[l.msg_type==3?(t(),s("div",Bt,[ue(e("img",{class:"msg-img",src:l.media_id_to_oss_url,alt:""},null,8,Dt),[[se]])])):l.msg_type==99?(t(),s("div",Ut,[_(et,{message:l.content},null,8,["message"])])):(t(),N(Mt,{key:2,class:"message-content",message:l.content},null,8,["message"]))])])],8,Et)):(t(),s("div",{key:1,class:"message-item robot-message",id:"msg-"+l.uid},[e("div",jt,[_(R,{size:"small",spinning:l.loading},{default:w(()=>[e("img",{class:"robot-avatar",src:l.robot_avatar},null,8,Ht)]),_:2},1032,["spinning"])]),e("div",Nt,[X(l.reply_content_list).length?(t(),s("div",Vt,[(t(!0),s(O,null,V(X(l.reply_content_list),(h,Z)=>{var ce;return t(),s(O,{key:Z},[(h.reply_type||h.type)==="text"?(t(),s("div",zt,[e("div",{class:"message-content",innerHTML:h.description},null,8,Jt)])):(h.reply_type||h.type)==="image"?(t(),s("div",Kt,[e("div",Qt,[ue(e("img",{class:"msg-img",src:h.pic||h.thumb_url},null,8,Wt),[[se]])])])):(h.reply_type||h.type)==="url"?(t(),s("div",Gt,[e("div",Yt,[e("a",{class:"url-link",href:h.url,target:"_blank"},o(h.url),9,Xt)])])):(h.reply_type||h.type)==="card"?(t(),s("div",Zt,[e("div",es,[h.thumb_url?(t(),s("img",{key:0,src:h.thumb_url,class:"card-thumb"},null,8,ts)):f("",!0),e("div",ss,[_(F,{class:"think-icon",name:"applet"}),e("span",os,o(h.title),1)])])])):(h.reply_type||h.type)==="imageText"?(t(),s("div",ns,[e("a",{class:"imageText-row",href:h.url,target:"_blank"},[h.thumb_url?(t(),s("img",{key:0,src:h.thumb_url,class:"imageText-thumb"},null,8,as)):f("",!0),e("div",is,[e("div",rs,o(h.title),1),e("div",cs,o(h.description),1)])],8,ls)])):(h.reply_type||h.type)==="smartMenu"?(t(),s("div",us,[e("div",_s,[h.smart_menu&&h.smart_menu.menu_description?(t(),s("div",ds,o(h.smart_menu.menu_description),1)):f("",!0),e("div",ps,[(t(!0),s(O,null,V(le(((ce=h.smart_menu)==null?void 0:ce.menu_content)||[]),(G,he)=>(t(),s("div",{key:he,class:"reply-line",onClick:E[0]||(E[0]=pe=>u(pe))},[G.kind==="text"?(t(),s("span",ms,o(G.text),1)):G.kind==="newline"?(t(),s("div",vs)):G.kind==="html"?(t(),s("span",{key:2,innerHTML:G.html},null,8,gs)):G.kind==="keyword"?(t(),s("a",{key:3,href:"javascript:;",class:"link",onClick:Ve(pe=>U(G.text),["prevent"])},[G.serial_no?(t(),s("div",fs,o(G.serial_no),1)):f("",!0),P(" "+o(G.text),1)],8,hs)):f("",!0)]))),128))])])])):f("",!0)],64)}),128))])):f("",!0),e("div",ys,[a.value&&l.startLoading?(t(),s("div",bs,[e("div",ks,[_(n(ke),{class:"loading"}),e("span",ws,o($.value),1)])])):f("",!0),l.msg_type==1&&v.value&&(!l.startLoading||!a.value)?(t(),s("div",{key:1,class:ee(["thinking-label-wrapper",{reasoning_open:l.show_quote_file}])},[e("div",{class:"thinking-label",onClick:h=>i(l)},[l.quote_loading?(t(),s(O,{key:0},[_(n(ke),{class:"loading"}),e("span",xs,o(n(q)("label_retrieving_knowledge_base")),1)],64)):f("",!0),l.quote_loading?f("",!0):(t(),s(O,{key:1},[_(F,{class:"think-icon",name:"quote-file"}),e("span",qs,o(n(q)("label_retrieved_knowledge_base_docs",{count:l.quote_file.length})),1)],64)),l.quote_file.length?(t(),N(F,{key:2,name:"arrow-down",class:"arrow-down"})):f("",!0)],8,$s)],2)):f("",!0),l.reasoning_content?(t(),s("div",{key:2,class:ee(["thinking-label-wrapper",{reasoning_open:l.show_reasoning}])},[e("div",{class:"thinking-label",onClick:h=>x(l)},[l.reasoning_status?(t(),N(n(ke),{key:0,class:"loading"})):(t(),N(F,{key:1,class:"think-icon",name:"think"})),e("span",Ss,o(l.reasoning_status?n(q)("label_thinking"):n(q)("label_thinking_completed")),1),l.reasoning_status?f("",!0):(t(),N(F,{key:2,name:"arrow-down",class:"arrow-down"}))],8,Cs),_(H,null,{title:w(()=>[P(o(n(q)("msg_disable_reasoning_tooltip")),1)]),default:w(()=>[_(n(tt),{class:"tip"})]),_:1})],2)):f("",!0)]),de(l)?(t(),s("div",Ls,[l.show_quote_file&&l.quote_file&&l.quote_file.length>0?(t(),s("div",Ms,[(t(!0),s(O,null,V(l.quote_file,h=>(t(),s("div",{class:"file-item",key:h.id,onClick:Z=>ne(l.quote_file,h,l.id)},[e("a",Is,[_(F,{class:"think-icon",name:"quote-file"}),h.file_name?(t(),s("span",Es,o(h.file_name),1)):(t(),s("span",Rs,o(h.library_name)+"-"+o(n(q)("library_featured")),1))])],8,Ts))),128))])):f("",!0),l.show_reasoning&&l.reasoning_content?(t(),s("div",Fs,[_(be,{content:l.reasoning_content},null,8,["content"])])):f("",!0),l.msg_type==1?(t(),s(O,{key:2},[ue((t(),s("div",Os,[_(be,{content:l.content},null,8,["content"])])),[[se]]),e("div",As,[(t(!0),s(O,null,V(l.question,(h,Z)=>(t(),s("div",{class:"menu-item",onClick:ce=>C(h),key:Z},o(h),9,Bs))),128))])],64)):f("",!0),l.msg_type==2?(t(),s(O,{key:3},[l.isWelcome?(t(),N(be,{key:0,class:"markdown-content",content:l.menu_json.content},null,8,["content"])):(t(),s("div",{key:1,class:"message-content",innerHTML:l.menu_json.content},null,8,Ds)),e("div",Us,[(t(!0),s(O,null,V(l.menu_json.question,(h,Z)=>(t(),s("div",{class:"menu-item",onClick:ce=>C(h),key:Z},o(h),9,Ps))),128))])],64)):f("",!0),l.msg_type==3?(t(),s("div",js,[ue(e("img",{class:"msg-img",src:l.content,alt:""},null,8,Hs),[[se]])])):f("",!0),Q(l)?ue((t(),s("div",Ns,[l.debug&&l.debug.length>0?(t(),s("div",Vs,[e("div",zs,[e("span",null,[e("a",{onClick:h=>Y(l)},o(n(q)("btn_prompt_log")),9,Js)])])])):f("",!0)],512)),[[ze,!l.question]]):f("",!0)])):f("",!0),l.voice_content&&l.voice_content.length?(t(),s("div",Ks,[_(Ze,{voice_content:l.voice_content},null,8,["voice_content"])])):f("",!0),(l.guess_you_want&&l.guess_you_want.length||r.value.length&&d.robotInfo.enable_common_question=="true")&&l.question_tabkey>0?(t(),N(St,{key:3,item:l,enable_common_question:d.robotInfo.enable_common_question=="true",common_question_list:r.value,onClickMeun:C},null,8,["item","enable_common_question","common_question_list"])):f("",!0)])],8,Pt))],64))),128))])],544)])}}},Ws=te(Qs,[["__scopeId","data-v-654d1e69"]]),Gs={class:"chat-list-box"},Ys=["onClick"],Xs={class:"chat-item-title"},Zs={__name:"chat-list",props:{list:{type:Array,default:()=>[]},active:{type:[String,Number],default:""}},emits:["openChat","onScrollEnd"],setup(I,{emit:y}){const m=y,q=I,p=A(null),$=c=>{m("openChat",c)},a=()=>{m("onScrollEnd")};return ge(()=>q.list,()=>{we(()=>{p.value.refresh()})}),(c,d)=>{const x=me;return t(),s("div",Gs,[_(Be,{ref_key:"scroller",ref:p,onOnScrollEnd:a},{default:w(()=>[e("div",null,[(t(!0),s(O,null,V(q.list,i=>(t(),s("div",{class:ee(["chat-list-item",{active:i.id==q.active}]),onClick:r=>$(i),key:i.id},[_(x,{class:"chat-item-icon",name:"message"}),e("span",Xs,o(i.subject||i.last_chat_message),1)],10,Ys))),128))])]),_:1},512)])}}},eo=te(Zs,[["__scopeId","data-v-8a5dd127"]]),to={class:"file-toolbar"},so={class:"toolbar-left"},oo={class:"file-list"},no={key:0,class:"delete-btn action-btn"},lo={key:1,class:"preview-btn action-btn"},ao=["src"],io={key:2,class:"progress-bar"},ro={key:3,class:"error-text"},co={__name:"file-toolbar",props:{fileList:{type:Array,default:()=>[]}},emits:["add","delete"],setup(I,{emit:y}){const m=I,q=y,p=W(()=>m.fileList.map(c=>c.url)),$=c=>{mt({options:{toolbar:!0,initialViewIndex:c},images:p.value}).show()},a=c=>{q("delete",c)};return(c,d)=>{const x=me;return t(),s("div",to,[e("div",so,[e("div",oo,[(t(!0),s(O,null,V(I.fileList,(i,r)=>(t(),s("div",{key:r,class:ee(["file-item",{uploading:i.status==="uploading",error:i.status==="error"}])},[i.status=="done"||i.status=="error"?(t(),s("span",no,[_(n(qe),{class:"delete-icon",onClick:v=>a(r)},null,8,["onClick"])])):f("",!0),i.status=="done"?(t(),s("span",lo,[_(x,{class:"preview-icon",name:"eye-open",onClick:v=>$(r)},null,8,["onClick"])])):f("",!0),e("img",{src:i.url,alt:"avatar"},null,8,ao),d[0]||(d[0]=e("div",{class:"mask"},null,-1)),i.status==="uploading"?(t(),s("div",io,[e("div",{class:"progress",style:Je({width:i.percent+"%"})},null,4)])):f("",!0),i.status==="error"?(t(),s("div",ro,"上传失败")):f("",!0)],2))),128))])])])}}},uo=te(co,[["__scopeId","data-v-2f3d173b"]]),_o=(I,y,m)=>new Promise((q,p)=>{vt({file:I.originFile,category:m},$=>{const a=Math.round($.loaded*100/$.total),c=y.value.find(d=>d.uid===I.uid);if(c){const d={...c,percent:a},x=y.value.findIndex(i=>i.uid===I.uid);x!==-1&&y.value.splice(x,1,d)}}).then($=>{const a=y.value.find(c=>c.uid===I.uid);if(a){const c={...a,percent:100,status:"done",url:$.data.link||""},d=y.value.findIndex(x=>x.uid===I.uid);d!==-1&&y.value.splice(d,1,c),q(c)}}).catch($=>{const a=y.value.find(c=>c.uid===I.uid);if(a){const c={...a,status:"error"},d=y.value.findIndex(x=>x.uid===I.uid);d!==-1&&y.value.splice(d,1,c)}p($)})});function po(I){const{limit:y=10,maxSize:m=10,accept:q="image/*",multiple:p=!0,category:$,fileList:a=A([])}=I||{};if(!$)throw new Error("category is required");let c=null;const d=r=>{let v=Array.from(r.target.files);const C=y-a.value.length;if(C<=0){_e.error(`最多只能上传 ${y} 张图片`);return}v.length>C&&(v=v.slice(0,C),_e.error(`最多只能上传 ${y} 张图片，已为您选择前 ${C} 张`)),v.forEach(L=>{if(!(L.size/1024/1024<m)){_e.error(`文件大小不能超过 ${m}MB!`);return}const j=L.type;if(!q.split(",").map(B=>B.trim()).some(B=>B.endsWith("/*")?j.startsWith(B.slice(0,-1)):j===B)){_e.error(`不支持的文件类型: ${j}`);return}const k={uid:L.uid||Se(16),name:L.name,status:"uploading",percent:0,originFile:L,url:URL.createObjectURL(L)};a.value.push(k),_o(k,a,$).then(B=>{const K=a.value.findIndex(M=>M.uid===B.uid);K!==-1&&a.value.splice(K,1,B)}).catch(()=>{const B=a.value.findIndex(K=>K.uid===k.uid);B!==-1&&(a.value[B].status="error")})}),r.target.value=""},x=()=>{const r=document.createElement("input");return r.type="file",r.accept=q,r.multiple=p,r.style.display="none",r.onchange=d,document.body.appendChild(r),r},i=()=>{if(a.value.length>=y){_e.error(`最多只能上传 ${y} 张图片`);return}c||(c=x()),c.click()};return Me(()=>{c&&document.body.contains(c)&&(document.body.removeChild(c),c=null)}),{openFileDialog:i}}const mo={class:"message-input-wrapper"},vo={key:0,class:"file-toolbar-box"},go={class:"message-input-box"},ho={class:"message-action"},fo=["disabled"],yo={__name:"message-input",props:{value:{type:String,default:""},loading:{type:Boolean,default:!1},fileList:{type:Array,default:()=>[]},showUpload:{type:Boolean,default:!1}},emits:["send","update:value","update:fileList"],setup(I,{emit:y}){const{t:m}=re("views.robot.robot-test.components.message-input"),q=y,p=I,{fileList:$}=Ke(p),{openFileDialog:a}=po({limit:10,maxSize:10,category:"chat_image",fileList:$,multiple:!0,accept:"image/bmp,image/jpeg,image/png,image/tiff,image/heic,image/gif,image/webp"}),c=v=>{const C=p.fileList.filter((L,b)=>b!==v);q("update:fileList",C)},d=W(()=>p.fileList.length>0?!1:p.loading||p.value.trim().length===0),x=v=>{q("update:value",v.target.value.trim())},i=v=>{if(v.key==="Enter"&&!v.shiftKey){if(!v.target.value.trim())return;v.preventDefault(),v.stopPropagation(),r()}else v.key==="Enter"&&v.shiftKey&&(v.preventDefault(),v.stopPropagation(),q("update:value",p.value+`
`))},r=()=>{q("send",p.value.trim())};return(v,C)=>{const L=st,b=me,j=Ee;return t(),s("div",mo,[p.fileList.length>0?(t(),s("div",vo,[_(uo,{"file-list":p.fileList,onDelete:c},null,8,["file-list"])])):f("",!0),e("div",go,[_(L,{class:"message-input",value:p.value,placeholder:n(m)("ph_input_content"),"auto-size":{minRows:2,maxRows:5},onChange:x,onKeydown:i},null,8,["value","placeholder"])]),e("div",ho,[p.showUpload?(t(),s("div",{key:0,class:"select-file-btn",onClick:C[0]||(C[0]=(...J)=>n(a)&&n(a)(...J))},[_(b,{class:"select-file-icon",name:"circularNeedle"}),n($).length>0?(t(),s("span",{key:0,class:ee(["file-number",{big:n($).length>9}])},o(n($).length),3)):f("",!0)])):f("",!0),e("button",{class:ee(["send-msg-btn",{loading:p.loading}]),disabled:d.value,onClick:r},[p.loading?(t(),N(j,{key:0,size:"small",class:"loading-action",style:{"margin-right":"4px"}})):(t(),N(b,{key:1,class:"paper-airplane",name:"paper-airplane"}))],10,fo)])])}}},bo=te(yo,[["__scopeId","data-v-0f489dbd"]]),ko={class:"prompt-log-items"},wo={class:"prompt-log-label"},$o={class:"prompt-log-item"},xo={class:"prompt-log-items"},qo={class:"prompt-log-label"},Co={class:"prompt-log-items"},So={class:"prompt-log-label"},Lo={class:"prompt-log-item"},Mo={class:"prompt-log-items"},To={class:"prompt-log-label"},Io={class:"prompt-log-item"},Eo={key:0,class:"prompt-log-items"},Ro={class:"prompt-log-label"},Fo={class:"prompt-log-item"},Oo={key:1,class:"prompt-log-items"},Ao={class:"prompt-log-label"},Bo={class:"prompt-log-item"},Do={class:"prompt-log-items"},Uo={class:"prompt-log-label"},Po={class:"prompt-log-item"},jo={__name:"prompt-log-alert",setup(I,{expose:y}){const{t:m}=re("views.robot.robot-test.components.prompt-log-alert"),{renderMath:q}=De(),p=A(null),$=A(!1),a=Te({prompt:"",library:[],context_qa:[],cur_question:"",cur_answer:"",error:""}),c=()=>{$.value=!1},d=()=>{a.prompt="",a.library=[],a.context_qa=[],a.cur_question="",a.cur_answer="",a.error="",a.recall_time="",a.request_time=""};return y({open:i=>{d(),a.error=i.error,a.recall_time=i.recall_time?(i.recall_time/1e3).toFixed(2):"",a.request_time=i.request_time?(i.request_time/1e3).toFixed(2):"";let r=i.debug||[];for(let v=0;v<r.length;v++){let C=r[v];C.type=="library"?a.library.push(C.content):C.type=="context_qa"?a.context_qa.push(C):a[C.type]=C.content}$.value=!0,q(p.value)}}),(i,r)=>{const v=Re,C=Fe;return t(),N(C,{class:"prompt-log-alert",open:$.value,"onUpdate:open":r[0]||(r[0]=L=>$.value=L),title:n(m)("title_prompt_log"),placement:"right",width:"746px",closable:!1},{extra:w(()=>[e("span",{class:"close-btn",onClick:c},[_(n(qe))])]),default:w(()=>[e("div",{class:"prompt-log-content",ref_key:"contRef",ref:p},[e("div",ko,[e("div",wo,[e("span",null,o(n(m)("label_prompt")),1),_(v,null,{title:w(()=>[P(o(n(m)("msg_prompt_tooltip")),1)]),default:w(()=>[_(n(ie),{class:"question-icon"})]),_:1})]),e("div",$o,[e("p",null,o(a.prompt),1)]),(t(!0),s(O,null,V(a.library,(L,b)=>(t(),s("div",{class:"prompt-log-item",key:b},[e("p",null,o(L),1)]))),128))]),e("div",xo,[e("div",qo,[e("span",null,o(n(m)("label_context")),1),_(v,null,{title:w(()=>[P(o(n(m)("msg_context_tooltip")),1)]),default:w(()=>[_(n(ie),{class:"question-icon"})]),_:1})]),(t(!0),s(O,null,V(a.context_qa,(L,b)=>(t(),s("div",{class:"prompt-log-item",key:b},[e("p",null,"Q："+o(L.question),1),e("p",null,"A："+o(L.answer),1)]))),128))]),e("div",Co,[e("div",So,[e("span",null,o(n(m)("label_user")),1),_(v,null,{title:w(()=>[P(o(n(m)("msg_user_tooltip")),1)]),default:w(()=>[_(n(ie),{class:"question-icon"})]),_:1})]),e("div",Lo,[e("p",null,o(a.cur_question),1)])]),e("div",Mo,[e("div",To,[e("span",null,o(n(m)("label_assistant")),1),_(v,null,{title:w(()=>[P(o(n(m)("msg_assistant_tooltip")),1)]),default:w(()=>[_(n(ie),{class:"question-icon"})]),_:1})]),e("div",Io,[e("p",null,o(a.cur_answer),1)])]),a.recall_time>0?(t(),s("div",Eo,[e("div",Ro,[e("span",null,o(n(m)("label_recall_time")),1),_(v,null,{title:w(()=>[P(o(n(m)("msg_recall_time_tooltip")),1)]),default:w(()=>[_(n(ie),{class:"question-icon"})]),_:1})]),e("div",Fo,[e("p",null,o(a.recall_time)+"s",1)])])):f("",!0),a.request_time>0?(t(),s("div",Oo,[e("div",Ao,[e("span",null,o(n(m)("label_request_time")),1),_(v,null,{title:w(()=>[P(o(n(m)("msg_request_time_tooltip")),1)]),default:w(()=>[_(n(ie),{class:"question-icon"})]),_:1})]),e("div",Bo,[e("p",null,o(a.request_time)+"s",1)])])):f("",!0),e("div",Do,[e("div",Uo,[e("span",null,o(n(m)("label_error")),1),_(v,null,{title:w(()=>[P(o(n(m)("msg_error_tooltip")),1)]),default:w(()=>[_(n(ie),{class:"question-icon"})]),_:1})]),e("div",Po,[e("p",null,o(a.error),1)])])],512)]),_:1},8,["open","title"])}}},Ho=te(jo,[["__scopeId","data-v-8f3d8beb"]]),No={class:"library-info-content"},Vo={class:"file-list"},zo=["onClick"],Jo={key:0},Ko={key:1},Qo={class:"document-item-header"},Wo={class:"left-box"},Go={class:"document-title"},Yo={key:0,class:"document-title"},Xo={class:"document-size"},Zo={class:"right-box"},en=["onClick"],tn={class:"document-item-body"},sn={class:"document-similarity"},on={key:0,class:"document-content"},nn={key:1,class:"document-content"},ln={class:"document-content"},an={class:"fragment-img"},rn=["src"],cn={class:"iframe-box"},un={__name:"library-info-alert",setup(I,{expose:y}){const{t:m}=re("views.robot.robot-test.components.library-info-alert"),q=xe(),{robot:p,user:$}=q;Qe();const{renderMath:a}=De(),c=A(null),d=A(!1),x=A([]),i=A(null),r=()=>{x.value=[],i.value=null},v=(M,D)=>{if(r(),x.value=M.map(Q=>{let Y=null;return Q.answer_source_data&&(Y=JSON.parse(Q.answer_source_data)),{...Q,answer_source_data:Y}}),i.value=D.id,d.value=!0,D.answer_source_data){L.value=JSON.parse(D.answer_source_data)||[];return}b(D)},C=M=>{if(M.id!=i.value){if(i.value=M.id,M.answer_source_data){L.value=M.answer_source_data||[];return}b(M)}},L=A([]),b=M=>{gt({message_id:M.message_id,file_id:M.id,robot_key:p.robot_key,openid:p.openid}).then(D=>{L.value=D.data||[],a(c.value)})},j=()=>{let M=x.value.filter(D=>D.id==i.value)[0]||{};M.file_name?window.open(`#/library/preview?id=${i.value}`):window.open(`#/library/details/categary-manage?id=${M.library_id}`)},J=W(()=>{let M=x.value.filter(D=>D.id==i.value)[0]||{};return M.file_name?M.file_name:M.library_name+"-"+m("label_selected")}),S=A(""),k=A(!1),B=M=>{k.value=!0,S.value="/manage/getLibRawFileOnePage?id="+i.value+"&page="+M.page_num+"&admin_user_id="+$.admin_user_id},K=()=>{d.value=!1};return y({open:v}),(M,D)=>{const Q=me,Y=Fe,ne=Be,X=Oe,le=Le("viewer");return t(),s(O,null,[_(Y,{class:"library-info-alert",open:d.value,"onUpdate:open":D[0]||(D[0]=u=>d.value=u),title:n(m)("title_answer_source"),placement:"right",width:"746px",closable:!1,bodyStyle:{background:"#F2F4F7"}},{extra:w(()=>[e("span",{class:"close-btn",onClick:K},[_(n(qe))])]),default:w(()=>[e("div",No,[e("div",Vo,[(t(!0),s(O,null,V(x.value,u=>(t(),s("div",{class:ee(["file-item",{active:i.value==u.id}]),key:u.id,onClick:U=>C(u)},[u.file_name?(t(),s("span",Jo,o(u.file_name),1)):(t(),s("span",Ko,o(u.library_name)+"-"+o(n(m)("label_selected")),1))],10,zo))),128))]),e("div",{class:"document-items",ref_key:"docBoxRef",ref:c},[(t(!0),s(O,null,V(L.value,u=>(t(),s("div",{class:"document-item",key:u.id},[e("div",Qo,[e("div",Wo,[e("span",Go,o(n(m)("label_id"))+o(u.id),1),u.title?(t(),s("span",Yo,o(u.title),1)):f("",!0),e("span",Xo,o(n(m)("label_characters_count",{count:u.word_total})),1)]),e("div",Zo,[u.page_num>0?(t(),s("a",{key:0,onClick:U=>B(u)},o(n(m)("btn_preview_original_file"))+">",9,en)):f("",!0),e("a",{onClick:j},o(n(m)("btn_view_source_document"))+">",1)])]),e("div",tn,[e("div",sn,[P(o(n(m)("label_similarity"))+" ",1),_(Q,{name:"similarity",style:{"font-size":"16px"}}),P(o(u.similarity),1)]),u.question?(t(),s("div",on,o(n(m)("label_question"))+o(u.question),1)):f("",!0),u.answer?(t(),s("div",nn,o(n(m)("label_answer"))+o(u.answer),1)):f("",!0),e("div",ln,o(u.content),1),ue((t(),s("div",an,[(t(!0),s(O,null,V(u.images,(U,de)=>(t(),s("img",{key:de,src:U,alt:""},null,8,rn))),128))])),[[le]])])]))),128))],512)])]),_:1},8,["open","title"]),_(X,{open:k.value,"onUpdate:open":D[1]||(D[1]=u=>k.value=u),title:J.value,footer:null,width:740},{default:w(()=>[e("div",cn,[_(ne,null,{default:w(()=>[_(n(ht),{source:S.value},null,8,["source"])]),_:1})])]),_:1},8,["open","title"])],64)}}},_n=te(un,[["__scopeId","data-v-f2022881"]]),dn="/assets/img/form-modal-header-Dfjzr0xA.png",pn={class:"modal-header"},mn={class:"title"},vn={class:"form-body"},gn={class:"from-footer"},hn={class:"btn-box"},fn={__name:"index",setup(I,{expose:y}){const{t:m}=re("views.robot.robot-test.components.variable-modal.index"),q=$e().query,p=A(!1),$=xe(),a=W(()=>$.chat_variables||{}),c=W(()=>(a.value.wait_variables||[]).map(k=>({...k,options:k.options?JSON.parse(k.options):[]}))),d=W(()=>a.value.fill_variables||[]),x=W(()=>a.value.need_fill_variable||!1),i=A(!1),r=Te({}),v=()=>{p.value=!0,d.value.forEach(S=>{(S.variable_type=="input_string"||S.variable_type=="input_number")&&(r[S.variable_key]=S.value||""),S.variable_type=="select_one"&&(r[S.variable_key]=S.value||void 0),S.variable_type=="checkbox_switch"&&(r[S.variable_key]=S.value==1)}),i.value=!0},C=S=>{S.forEach(k=>{(k.variable_type=="input_string"||k.variable_type=="input_number")&&(r[k.variable_key]=k.default_value||""),k.variable_type=="select_one"&&(r[k.variable_key]=k.default_value||void 0),k.variable_type=="checkbox_switch"&&(r[k.variable_key]=k.default_value==1)})},L=S=>S.max_input_length>0?+S.max_input_length:50;ge(()=>c.value,S=>{S&&C(c.value)},{deep:!0}),ge(()=>x.value,S=>{S&&(p.value=!1,i.value=!0)},{deep:!0,immediate:!0});const b=A(null),j=()=>{b.value.validate().then(()=>{let S=J(),k=`chat_prompt_variables_${q.robot_key}`;p.value?$.handleEditVariables({chat_prompt_variables:S}):localStorage.setItem(k,JSON.stringify(S)),i.value=!1})};function J(){return c.value.map(k=>{let B=r[k.variable_key];return k.variable_type=="checkbox_switch"&&(B=B?1:0),{...k,value:B}})}return y({handleEdit:v}),(S,k)=>{const B=nt,K=lt,M=it,D=at,Q=rt,Y=ot,ne=ct,X=Ae,le=Oe;return t(),N(le,{wrapClassName:"variable-modal-class",open:i.value,"onUpdate:open":k[0]||(k[0]=u=>i.value=u),title:null,footer:null,closable:p.value,maskClosable:!1,width:560},{default:w(()=>[e("div",pn,[k[1]||(k[1]=e("div",{class:"banner-bg"},[e("img",{src:dn,alt:""})],-1)),e("div",mn,o(n(m)("title_fill_info")),1)]),e("div",vn,[_(ne,{model:r,ref_key:"formRef",ref:b,layout:"vertical"},{default:w(()=>[(t(!0),s(O,null,V(c.value,u=>(t(),N(Y,{key:u.variable_key,label:u.variable_type=="checkbox_switch"?null:u.variable_name,name:u.variable_key,rules:[{required:u.must_input==1,message:n(m)("msg_input_required",{name:u.variable_name})}]},{default:w(()=>[u.variable_type=="input_string"?(t(),N(B,{key:0,value:r[u.variable_key],"onUpdate:value":U=>r[u.variable_key]=U,maxLength:L(u),placeholder:n(m)("ph_input")},null,8,["value","onUpdate:value","maxLength","placeholder"])):f("",!0),u.variable_type=="input_number"?(t(),N(K,{key:1,style:{width:"100%"},value:r[u.variable_key],"onUpdate:value":U=>r[u.variable_key]=U,stringMode:"",maxLength:50,placeholder:n(m)("ph_input")},null,8,["value","onUpdate:value","placeholder"])):f("",!0),u.variable_type=="select_one"?(t(),N(D,{key:2,value:r[u.variable_key],"onUpdate:value":U=>r[u.variable_key]=U,style:{width:"100%"}},{default:w(()=>[(t(!0),s(O,null,V(u.options,U=>(t(),N(M,{value:U.label,key:U.label},{default:w(()=>[P(o(U.label),1)]),_:2},1032,["value"]))),128))]),_:2},1032,["value","onUpdate:value"])):f("",!0),u.variable_type=="checkbox_switch"?(t(),N(Q,{key:3,checked:r[u.variable_key],"onUpdate:checked":U=>r[u.variable_key]=U},{default:w(()=>[P(o(u.variable_name),1)]),_:2},1032,["checked","onUpdate:checked"])):f("",!0)]),_:2},1032,["label","name","rules"]))),128))]),_:1},8,["model"])]),e("div",gn,[e("div",hn,[_(X,{onClick:j,block:"",type:"primary"},{default:w(()=>[P(o(n(m)("btn_submit")),1)]),_:1})])])]),_:1},8,["open","closable"])}}},yn=te(fn,[["__scopeId","data-v-aa7a3459"]]),bn={class:"chat-page-wrapper"},kn={class:"chat-page-header"},wn={class:"breadcrumb-box"},$n={class:"chat-page"},xn={class:"page-left"},qn={class:"page-left-top"},Cn={class:"page-left-body"},Sn={class:"page-body"},Ln={key:0,class:"form-banner-top"},Mn={class:"title"},Tn={class:"chat-box-body"},In={style:{"padding-top":"30px"},class:"chat-box-footer"},En={__name:"index",setup(I){const{t:y}=re("views.robot.robot-test.index"),q=$e().query,p=Ie(),{getRobot:$}=p,a=W(()=>p.robotInfo),c=Xe(),d=xe(),x=He();let i=!0;const r=A(""),v=A([]),C=A(null),{createChat:L,sendMessage:b,getMyChatList:j,openChat:J,onGetChatMessage:S,changeRobotPrompt:k,$reset:B}=d,{messageList:K,sendLock:M,myChatList:D,robot:Q,dialogue_id:Y}=We(d),ne=W(()=>!d.chat_variables.need_fill_variable&&d.chat_variables.fill_variables&&d.chat_variables.fill_variables.length),X=$e(),le=A(!1),u=A(!1),U=W(()=>M.value||u.value),de=async()=>{if(!U.value){if(!r.value&&!v.value.length)return Ne(y("msg_please_input_message"));u.value=!0;try{let T=await ft({robot_key:Q.value.robot_key,openid:Q.value.openid,question:r.value,form_ids:Q.value.form_ids,dialogue_id:Y.value});if(u.value=!1,T.data&&T.data.words)return _e.error(y("msg_sensitive_words",{words:T.data.words.join(";")}));let z=1,oe=r.value;if(a.value.question_multiple_switch==1){let ae=[];z=99,r.value&&(ae=[{type:"text",uid:Se(16),text:r.value}]),v.value.length&&v.value.map(ve=>{ae.push({uid:ve.uid,type:"image_url",image_url:{url:ve.url}})}),oe=JSON.stringify(ae)}i=!0,b({message:oe,global:JSON.stringify(q),msg_type:z}),r.value="",v.value=[]}catch{u.value=!1}}},g=async()=>{i=!0,r.value="";let T=X.query||{},z=x.user_id,oe={robot_key:T.robot_key,avatar:T.avatar,name:T.name,nickname:T.nickname,is_background:1,openid:z,dialogue_id:0};Z(),await L(oe)},E=async T=>{if(Y.value==T.dialogue_id)return;i=!0;let oe={robot_key:(X.query||{}).robot_key,avatar:T.avatar,name:T.name,nickname:T.nickname,is_background:T.is_background,openid:T.openid,dialogue_id:T.id};Z(),await J(oe),await S()&&l()},R=T=>{i=!0,b({message:T})};A(!1);const F=()=>{l()},H=async()=>{i=!1;let T=K.value[0].uid;await S()&&h(T)},se=()=>{},l=()=>{C.value&&i&&C.value.scrollToBottom()},h=T=>{C.value&&C.value.scrollToMessage(T)},Z=()=>{C.value&&C.value.resetScroll()},ce=()=>{j()},G=A(null),he=T=>{G.value.open(T)},pe=A(null),Ue=(T,z)=>{pe.value.open(T,z)},Ce=A(null),Pe=()=>{Ce.value.handleEdit()};return ge(()=>K.value,()=>{}),Ge(async()=>{g(),j(),await $(q.id),le.value=!0,c.on("updateAiMessage",F)}),Me(()=>{B(),c.off("updateAiMessage",F)}),(T,z)=>{const oe=Ye("router-link"),ae=dt,ve=ut,je=Ae;return t(),s("div",bn,[e("div",kn,[e("div",wn,[_(ve,null,{default:w(()=>[_(ae,null,{default:w(()=>[_(oe,{to:"/robot/list"},{default:w(()=>[P(o(n(y)("breadcrumb_robot_management")),1)]),_:1})]),_:1}),_(ae,null,{default:w(()=>[P(o(n(Q).robot_name),1)]),_:1})]),_:1})])]),e("div",$n,[e("div",xn,[e("div",qn,[_(je,{type:"primary",block:"",ghost:"",onClick:g},{default:w(()=>[_(n(pt)),P(" "+o(n(y)("btn_new_chat")),1)]),_:1})]),e("div",Cn,[_(eo,{list:n(D),active:n(Y),onOpenChat:E,onOnScrollEnd:ce},null,8,["list","active"])]),z[2]||(z[2]=e("div",{class:"page-left-footer"},null,-1))]),e("div",Sn,[ne.value?(t(),s("div",Ln,[e("div",Mn,o(n(y)("title_form_info")),1),e("div",{class:"edit-block",onClick:Pe},[_(n(_t)),P(o(n(y)("btn_edit")),1)])])):f("",!0),e("div",Tn,[_(Ws,{ref_key:"messageListRef",ref:C,messages:n(K),robotInfo:a.value,onClickMsgMeun:R,onScrollStart:H,onScrollEnd:se,onOpenPromptLog:he,onOpenLibrary:Ue},null,8,["messages","robotInfo"])]),e("div",In,[_(bo,{value:r.value,"onUpdate:value":z[0]||(z[0]=fe=>r.value=fe),fileList:v.value,"onUpdate:fileList":z[1]||(z[1]=fe=>v.value=fe),loading:U.value,showUpload:a.value.question_multiple_switch==1,onSend:de},null,8,["value","fileList","loading","showUpload"])])]),e("div",null,[f("",!0)])]),_(Ho,{ref_key:"promptLogAlertRef",ref:G},null,512),_(_n,{ref_key:"libraryInfoAlertRef",ref:pe},null,512),_(yn,{ref_key:"variableModalRef",ref:Ce},null,512)])}}},ol=te(En,[["__scopeId","data-v-3985c7bb"]]);export{ol as default};
//# sourceMappingURL=index-vhz1opRm.js.map
