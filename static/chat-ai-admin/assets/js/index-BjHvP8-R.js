import{a5 as ee,aa as oe,b7 as ae,bb as ie,bc as ne,c as me,_ as H,b as V,d as X}from"../../index-CB2DywzJ.js";import{am as fe,e as ye,ac as o,ad as s,k as O,as as a,ah as ge,ak as ce,G as E,at as _,aB as Q,f as x,w as te,o as se,y as G,b as re,ae as U,u as p,az as T,F as B,ax as P,ai as J,q as de,ar as F,n as _e,H as ue,J as le,av as ke,r as be}from"./vue-chunks-CGLjTDrY.js";import{u as he}from"./useEventBus-CB_rGuu7.js";import{g as Le}from"./index-CoChppVN.js";import{u as we}from"./useIM-DVqx3ZzC.js";import{B as K,M as xe,S as Ce,P as Se}from"./pull-up.esm-DIiTC7VE.js";import{O as Te}from"./observe-dom.esm-B25JyVKH.js";import{al as $e,ay as Me,aA as Re,d as N,D as De,X as Oe,z as Ie,y as Ne,I as Be}from"./ui-antd-BHaxN-GS.js";import{_ as qe,V as Ae}from"./voice-message-aqbqTNw7.js";import{M as Pe}from"./multiple-message-DvHk6dXx.js";import{i as Ye}from"./index-D4Gl6KHo.js";import"./neo4j-CSfpjqgw.js";import"./utils-pAinW4BS.js";import"./other-BrZCAsTs.js";import"./index-DxgALpad.js";const ze=(d={})=>ee.get({url:"/manage/getReceiverList",params:d}),He=(d={})=>ee.post({url:"/chat/message",data:d}),je=(d={})=>ee.post({url:"/manage/setReceiverRead",data:d}),Z=fe("chatMonitor",{state:()=>({im:null,selectedRobotId:"",robotList:[],selectedReceiverId:"",receiverList:[],receiverListPage:{page:0,size:10},activeChat:null,chatMessagePageSize:10,messageList:[],messageListScrollTop:0,chatMessageLoadCompleted:!1,messageListLoading:!1}),getters:{},actions:{async init(){this.selectedRobotId="",this.selectedReceiverId="",this.robotList=[],this.receiverList=[],this.messageList=[],this.receiverListPage={page:0,size:10},this.messageListScrollTop=0,this.chatMessageLoadCompleted=!1,this.messageListLoading=!1,this.activeChat=null,await this.getRobotList(),await this.getReceiverList(),this.receiverList.length>0&&await this.switchChat(this.receiverList[0]),this.initIM()},closeIM(){this.im&&this.im.close()},initIM(){const d=we(),r=me();this.im=d,d.connect(r.user_id),d.on("message",e=>{!e.data||e.msg_type!=="receiver_notify"||((e.change=="create"||e.change=="update")&&this.onAddReceiver(e),e.change=="delete"&&this.onDeleteReceiver(e),(e.change=="c_message"||e.change=="ai_message")&&this.onAddMessage(e))})},onAddMessage(d){if(!this.activeChat)return;const r=he();let e=d.data;if(this.activeChat.session_id==e.session_id){if(e.displayName=e.name||e.nickname,e.dispayTime=ae(e.create_time),e.uid=oe(32),e.loading=!1,e.menu_json&&typeof e.menu_json=="string"&&(e.menu_json=JSON.parse(e.menu_json)),e.quote_file&&typeof e.quote_file=="string"&&(e.quote_file=JSON.parse(e.quote_file)),e.reply_content_list&&typeof e.reply_content_list=="string")try{e.reply_content_list=JSON.parse(e.reply_content_list)}catch{e.reply_content_list=[]}e.voice_content=ie(e.content),e.content=ne(e.content),this.messageList.push(e),r.emit("onAddMessage",e)}},onAddReceiver(d){let r=d.data;r.displayName=r.name||r.nickname,r.come_from=JSON.parse(r.come_from);let e=this.receiverList.findIndex(c=>c.session_id==r.session_id);e!==-1?this.receiverList.splice(e,1,r):(this.selectedRobotId==""||this.selectedRobotId==r.robot_id)&&this.receiverList.unshift(r)},onDeleteReceiver(d){let r=d.data,e=this.receiverList.findIndex(c=>c.id==r);e!=-1&&(this.activeChat&&this.activeChat.id==r&&(this.activeChat=null),this.receiverList.splice(e,1))},async getRobotList(d){try{const r=await Le(d);return this.robotList=r.data||[],r}catch(r){throw console.error("Failed to get robot list:",r),r}},async getReceiverList(d){d!=null&&d.page?this.receiverListPage.page=d.page:this.receiverListPage.page++;const r={...this.receiverListPage,robot_id:this.selectedRobotId,...d};try{const e=await ze(r);let c=e.data.list||[];for(let t=0;t<c.length;t++)if(c[t].displayName=c[t].name||c[t].nickname,c[t].come_from)try{c[t].come_from=JSON.parse(c[t].come_from)}catch(u){console.error("Failed to parse come_from:",u)}return this.receiverListPage.page===1?this.receiverList=c:this.receiverList=this.receiverList.concat(c),e}catch(e){throw console.error("Failed to get receiver list:",e),this.receiverListPage.page>1&&this.receiverListPage.page--,e}},changeRobot(d){this.activeChat=null,this.resetReceiverList(d)},resetReceiverList(d){return this.receiverListPage.page=0,this.receiverList=[],this.getReceiverList(d)},async getChatMessage(){if(this.messageListLoading)return;this.messageListLoading=!0;let d=0,r=this.messageList.filter(c=>!c.isWelcome);r.length>0&&(d=r[0].id);let e={robot_key:this.activeChat.robot_key,openid:this.activeChat.openid,min_id:d,size:this.chatMessagePageSize,rel_user_id:this.activeChat.rel_user_id};return He(e).then(c=>{var w,M;this.messageListLoading=!1;let t=c.data.list||[];const u=((w=c==null?void 0:c.data)==null?void 0:w.customer)||{},v=((M=c==null?void 0:c.data)==null?void 0:M.robot)||{};t.sort((i,k)=>i.id-k.id);for(let i=0;i<t.length;i++){if(t[i].displayName=t[i].name||t[i].nickname,t[i].is_customer==1?(t[i].displayName=t[i].displayName||u.name,t[i].avatar=t[i].avatar||u.avatar):(t[i].displayName=t[i].displayName||v.robot_name,t[i].avatar=t[i].avatar||v.robot_avatar),t[i].uid=oe(32),t[i].menu_json&&typeof t[i].menu_json=="string"&&(t[i].menu_json=JSON.parse(t[i].menu_json)),t[i].quote_file&&typeof t[i].quote_file=="string"&&(t[i].quote_file=JSON.parse(t[i].quote_file)),t[i].reply_content_list&&typeof t[i].reply_content_list=="string")try{t[i].reply_content_list=JSON.parse(t[i].reply_content_list)}catch{t[i].reply_content_list=[]}t[i].dispayTime=ae(t[i].create_time),t[i].voice_content=ie(t[i].content),t[i].content=ne(t[i].content)}return this.messageList=[...t,...this.messageList],t.length<this.chatMessagePageSize&&(this.chatMessageLoadCompleted=!0),c}).catch(c=>{this.messageListLoading=!1})},claerUnread(){return je({id:this.selectedReceiverId})},async switchChat(d){this.chatMessageLoadCompleted=!1,this.messageListLoading=!1,this.messageList=[],this.messageListScrollTop=0,this.selectedReceiverId=d.id,this.activeChat=d,this.claerUnread(),await this.getChatMessage()}}}),Fe={class:"no-data"},Ue={class:"no-data-text"},Je={__name:"list-empty",props:{text:{type:String,default:""},size:{type:[Number,String],default:100}},setup(d){const{t:r}=V("views.chat-monitor.components.list-empty"),e=d,c=ye(()=>e.text||r("no_data"));return(t,u)=>{const v=X;return s(),o("div",Fe,[O(v,{name:"empty",style:ge({"font-size":`${e.size}px`})},null,8,["style"]),a("div",Ue,[ce(t.$slots,"default",{},()=>[E(_(c.value),1)],!0)])])}}},pe=H(Je,[["__scopeId","data-v-30b2f3d9"]]),Ve={key:1,class:"chat-list"},Ee=["onClick"],We={class:"avatar"},Ke=["src","alt"],Ge={class:"chat-info"},Xe={class:"nickname"},Qe={class:"last-message"},Ze={class:"webapp-source"},et={key:0,class:"loading-wrapper"},tt={class:"loading-text"},st={key:1,class:"finished-text"},ot={__name:"chat-list ",emits:["switchChat"],setup(d,{expose:r,emit:e}){K.use(xe),K.use(Ce),K.use(Te),K.use(Se);const c=e,{t}=V("views.chat-monitor.components.chat-list"),u=Z(),{getReceiverList:v}=u,{receiverList:w,selectedReceiverId:M}=Q(u),i=x(null);let k=null;const L=x(!1),$=x(!1),m=x({}),l=()=>{k=new K(i.value,{scrollY:!0,click:!0,observeDOM:!0,mouseWheel:!0,bounce:!1,scrollbar:{fade:!0,interactive:!0},pullUpLoad:!0}),k.on("pullingUp",()=>{g(m.value)})},g=async(C={})=>{if(C.page===1&&($.value=!1),L.value||$.value){k.finishPullUp();return}L.value=!0,C&&Object.keys(C).length>0&&(m.value={...C});try{(await v(C)).data.list.length===0&&!C.keyword&&($.value=!0)}catch(A){console.error(t("load_more_failed"),A)}finally{L.value=!1,k.finishPullUp()}},b=C=>{c("switchChat",C)};return te(w,C=>{C.length>0&&G(()=>{k&&k.refresh()})}),se(()=>{G(()=>{l()})}),re(()=>{k&&k.destroy()}),r({getData:g}),(C,A)=>{const y=$e;return s(),o("div",{class:"scroll-wrapper",ref_key:"scrollRef",ref:i},[p(w).length==0?(s(),U(pe,{key:0,size:"140",text:p(t)("no_bot_sessions")},null,8,["text"])):(s(),o("div",Ve,[(s(!0),o(B,null,P(p(w),R=>(s(),o("div",{key:R.id,class:J(["chat-item",{active:R.id===p(M)}]),onClick:z=>b(R)},[a("div",We,[a("img",{src:R.avatar,alt:R.displayName},null,8,Ke),R.unread>0?(s(),o("span",{key:0,class:J(["dot",{plus:R.unread>9}])},_(R.unread),3)):T("",!0)]),a("div",Ge,[a("div",Xe,_(R.displayName),1),a("div",Qe,_(R.last_chat_message),1),a("div",Ze,_(p(t)("from_prefix"))+_(R.come_from.app_name),1)])],10,Ee))),128)),L.value?(s(),o("div",et,[O(y,{size:"small"}),a("span",tt,_(p(t)("loading")),1)])):T("",!0),$.value?(s(),o("div",st,_(p(t)("no_more")),1)):T("",!0)]))],512)}}},at=H(ot,[["__scopeId","data-v-e00c6b96"]]),it={__name:"chat-message-scroll",props:{topTriggerDistance:{type:Number,default:10},bottomTriggerDistance:{type:Number,default:40},isLoading:{type:Boolean,default:!1},scrollTop:{type:Number,default:0}},emits:["scroll-top","scroll-bottom","scroll"],setup(d,{expose:r,emit:e}){const c=d,t=e,u=x(null),v=x({scrollTop:0,scrollHeight:0,clientHeight:0,scrollDirection:"down",scrollStartDiff:c.topTriggerDistance,scrollEndDiff:c.bottomTriggerDistance}),w=x(null),M=l=>{const{scrollTop:g}=l,b=v.value.scrollTop-g;v.value.scrollDirection=b>0?"up":"down",Object.assign(v.value,{scrollTop:g,scrollHeight:l.scrollHeight,clientHeight:l.clientHeight})},i=()=>{const{scrollTop:l,scrollHeight:g,clientHeight:b,scrollStartDiff:C,scrollEndDiff:A,scrollDirection:y}=v.value;t("scroll",{...v.value}),c.isLoading||(Math.abs(l)<=C&&y==="up"&&t("scroll-top",{...v.value}),Math.abs(g-l-b)<=A&&y==="down"&&t("scroll-bottom",{...v.value}))},k=l=>{M(l.target),w.value&&(clearTimeout(w.value),w.value=null),w.value=setTimeout(()=>{i()},100)};function L(){u.value&&(u.value.scrollTop=0)}function $(){u.value&&(u.value.scrollTop=u.value.scrollHeight)}function m(){return u.value&&Object.assign(v.value,{scrollTop:u.value.scrollTop,scrollHeight:u.value.scrollHeight,clientHeight:u.value.clientHeight}),JSON.parse(JSON.stringify(v.value))}return te(()=>c.scrollTop,l=>{u.value&&(u.value.scrollTop=l)}),r({scrollToTop:L,scrollToBottom:$,getState:m}),(l,g)=>(s(),o("div",{class:"chat-message-scroll",ref_key:"scrollContainer",ref:u,onScroll:k},[ce(l.$slots,"default",{},void 0,!0)],544))}},nt=H(it,[["__scopeId","data-v-3e3a1c2e"]]),lt={class:"chat-message-warpper"},ct={class:"chat-message-content"},rt={key:0,class:"is-loaded"},dt={class:"avatar"},_t=["src","alt"],ut={class:"message-content"},ht={class:"message-info"},pt={class:"nickname"},vt={class:"time"},mt={key:0,class:"reply-list"},ft={key:0,class:"reply-item reply-text"},yt=["innerHTML"],gt={key:1,class:"reply-item reply-image"},kt={class:"message-content"},bt=["src"],Lt={key:2,class:"reply-item reply-url"},wt={class:"url-row"},xt=["href"],Ct={key:3,class:"reply-item reply-card"},St={class:"card-row"},Tt=["src"],$t={class:"card-title-box"},Mt={class:"card-title"},Rt={key:4,class:"reply-item reply-imageText"},Dt=["href"],Ot=["src"],It={class:"imageText-text"},Nt={class:"imageText-title"},Bt={class:"imageText-desc"},qt={key:5,class:"reply-item reply-smartMenu"},At={class:"smart-menu-box"},Pt={key:0,class:"card-title"},Yt={class:"card-text"},zt={key:0,class:"line-text"},Ht={key:1,class:"empty-line"},jt=["innerHTML"],Ft={key:3,href:"javascript:;",class:"link"},Ut={key:0},Jt={key:1,class:"message-bubble"},Vt={key:0,class:"text-content"},Et={key:1},Wt={key:1,class:"image-content"},Kt=["src"],Gt={key:2,class:"image-content"},Xt=["src"],Qt={key:3,class:"menu-content"},Zt={class:"menus-label"},es={key:0,class:"menu-items"},ts=["onClick"],ss={key:4,class:"multiple-content"},os={key:5,class:"answer-reference-box"},as={class:"answer-reference-label"},is=["onClick"],ns={key:2},ls={__name:"chat-message",emits:["openLibrary"],setup(d,{expose:r,emit:e}){const{t:c}=V("views.chat-monitor.components.chat-message"),t=e,u=x(null),v=Z(),{getChatMessage:w}=v,{messageList:M,messageListScrollTop:i,messageListLoading:k,chatMessageLoadCompleted:L,activeChat:$}=Q(v),m=()=>{};function l(D,S,f){let I=le(D);S.robot_key=$.value.robot_key,S.robot_id=$.value.robot_id,I.forEach(n=>{n.message_id=f.id,n.openid=f.openid,n.robot_key=$.value.robot_key,n.robot_id=$.value.robot_id}),t("openLibrary",I,le(S))}function g(D){const S=[];return(Array.isArray(D)?D:[]).forEach(f=>{const I=String((f==null?void 0:f.menu_type)||""),n=String((f==null?void 0:f.content)||"");if(I==="0")if(n==="")S.push({kind:"newline"});else if(/<a[\s\S]*?<\/a>/.test(n)){const W=/href\s*=\s*['"]\s*#\s*['"]/i.test(n)?n.replace(/href\s*=\s*['"]\s*#\s*['"]/ig,'href="javascript:;"'):n.replace(/href=/ig,'target="_blank" href=');S.push({kind:"html",html:W})}else S.push({kind:"text",text:n});else I==="1"&&S.push({kind:"keyword",text:n,serial_no:(f==null?void 0:f.serial_no)||""})}),S.slice(0,20)}const b=D=>{const{scrollTop:S}=D;i.value=S},C=async()=>{if(L.value)return;let D=u.value.getState();await w(),G(()=>{let S=u.value.getState();S.scrollDirection=="up"&&(i.value=S.scrollHeight-D.scrollHeight)})},A=async()=>{},y=()=>{u.value.scrollToBottom()},R=()=>{u.value.scrollToTop()};function z(D){try{return D?Array.isArray(D)?D:typeof D=="string"?JSON.parse(D||"[]"):[]:[]}catch{return[]}}return r({scrollToTop:R,scrollToBottom:y}),(D,S)=>{const f=X,I=de("viewer");return s(),o("div",lt,[O(nt,{ref_key:"scrollViewRef",ref:u,scrollTop:p(i),"onUpdate:scrollTop":S[0]||(S[0]=n=>ue(i)?i.value=n:null),"is-loading":p(k),onScroll:b,onScrollTop:C,onScrollBottom:A},{default:F(()=>[a("div",ct,[p(L)?(s(),o("div",rt,_(p(c)("no_more_messages")),1)):T("",!0),(s(!0),o(B,null,P(p(M),(n,W)=>(s(),o("div",{key:W,class:J(["message-item",n.is_customer==0?"right":""])},[a("div",dt,[a("img",{src:n.avatar,alt:n.displayName},null,8,_t)]),a("div",ut,[a("div",ht,[a("span",pt,_(n.displayName),1),S[1]||(S[1]=a("i",{class:"gap"},null,-1)),a("span",vt,_(n.dispayTime),1)]),z(n.reply_content_list).length?(s(),o("div",mt,[(s(!0),o(B,null,P(z(n.reply_content_list),(h,j)=>{var q;return s(),o(B,{key:j},[(h.reply_type||h.type)==="text"?(s(),o("div",ft,[a("div",{class:"message-content",innerHTML:h.description},null,8,yt)])):(h.reply_type||h.type)==="image"?(s(),o("div",gt,[a("div",kt,[_e(a("img",{class:"msg-img",src:h.pic||h.thumb_url},null,8,bt),[[I]])])])):(h.reply_type||h.type)==="url"?(s(),o("div",Lt,[a("div",wt,[a("a",{class:"url-link",href:h.url,target:"_blank"},_(h.url),9,xt)])])):(h.reply_type||h.type)==="card"?(s(),o("div",Ct,[a("div",St,[h.thumb_url?(s(),o("img",{key:0,src:h.thumb_url,class:"card-thumb"},null,8,Tt)):T("",!0),a("div",$t,[O(f,{class:"think-icon",name:"applet"}),a("span",Mt,_(h.title),1)])])])):(h.reply_type||h.type)==="imageText"?(s(),o("div",Rt,[a("a",{class:"imageText-row",href:h.url,target:"_blank"},[h.thumb_url?(s(),o("img",{key:0,src:h.thumb_url,class:"imageText-thumb"},null,8,Ot)):T("",!0),a("div",It,[a("div",Nt,_(h.title),1),a("div",Bt,_(h.description),1)])],8,Dt)])):(h.reply_type||h.type)==="smartMenu"?(s(),o("div",qt,[a("div",At,[h.smart_menu&&h.smart_menu.menu_description?(s(),o("div",Pt,_(h.smart_menu.menu_description),1)):T("",!0),a("div",Yt,[(s(!0),o(B,null,P(g(((q=h.smart_menu)==null?void 0:q.menu_content)||[]),(Y,ve)=>(s(),o("div",{key:ve,class:"reply-line"},[Y.kind==="text"?(s(),o("span",zt,_(Y.text),1)):Y.kind==="newline"?(s(),o("div",Ht)):Y.kind==="html"?(s(),o("span",{key:2,innerHTML:Y.html},null,8,jt)):Y.kind==="keyword"?(s(),o("a",Ft,[Y.serial_no?(s(),o("div",Ut,_(Y.serial_no),1)):T("",!0),E(" "+_(Y.text),1)])):T("",!0)]))),128))])])])):T("",!0)],64)}),128))])):T("",!0),n.msg_type==1&&n.content==""?T("",!0):(s(),o("div",Jt,[n.msg_type==1?(s(),o("div",Vt,[n.is_customer==0?(s(),U(qe,{key:0,style:{"text-align":"left"},content:n.content},null,8,["content"])):(s(),o("div",Et,_(n.content),1))])):n.received_message_type=="image"&&n.media_id_to_oss_url?(s(),o("div",Wt,[a("img",{src:n.media_id_to_oss_url,alt:"image"},null,8,Kt)])):n.msg_type==3?(s(),o("div",Gt,[a("img",{src:n.content,alt:"image"},null,8,Xt)])):n.msg_type==2?(s(),o("div",Qt,[a("div",Zt,_(n.menu_json.content),1),n.menu_json.question&&n.menu_json.question.length>0?(s(),o("div",es,[(s(!0),o(B,null,P(n.menu_json.question,(h,j)=>(s(),o("div",{key:j,class:"menu-item",onClick:q=>m(h)},_(h),9,ts))),128))])):T("",!0)])):n.msg_type==99?(s(),o("div",ss,[O(Pe,{message:n.content},null,8,["message"])])):T("",!0),n.quote_file&&n.quote_file.length?(s(),o("div",os,[a("div",as,_(p(c)("answer_reference")),1),a("div",null,[(s(!0),o(B,null,P(n.quote_file,(h,j)=>(s(),o("div",{class:"list-item",key:j},[O(f,{name:"attachment"}),a("span",{onClick:q=>l(n.quote_file,h,n)},_(h.file_name),9,is)]))),128))])])):T("",!0)])),n.voice_content&&n.voice_content.length?(s(),o("div",ns,[O(Ae,{voice_content:n.voice_content},null,8,["voice_content"])])):T("",!0)])],2))),128))])]),_:1},8,["scrollTop","is-loading"])])}}},cs=H(ls,[["__scopeId","data-v-52225838"]]),rs={class:"library-info-content"},ds={class:"file-list"},_s=["onClick"],us={class:"document-items"},hs={class:"document-item-header"},ps={class:"left-box"},vs={class:"document-title"},ms={key:0,class:"document-title"},fs={class:"document-size"},ys={class:"right-box"},gs={class:"document-item-body"},ks={class:"document-similarity"},bs={key:0,class:"document-content"},Ls={key:1,class:"document-content"},ws={class:"document-content"},xs={class:"fragment-img"},Cs=["src"],Ss={__name:"library-info-alert",setup(d,{expose:r}){const{t:e}=V("views.chat-monitor.components.library-info-alert"),c=ke(),t=x(!1),u=x([]),v=x(null),w=()=>{u.value=[],v.value=null},M=(l,g)=>{w(),u.value=l,v.value=g.id,t.value=!0,L(g)},i=l=>{l.id!=v.value&&(v.value=l.id,L(l))},k=x([]),L=l=>{Ye({message_id:l.message_id,file_id:l.id,robot_key:l.robot_key,openid:l.openid}).then(g=>{k.value=g.data||[]})},$=()=>{c.push("/library/preview?id="+v.value)},m=()=>{t.value=!1};return r({open:M}),(l,g)=>{const b=X,C=Re,A=de("viewer");return s(),U(C,{class:"library-info-alert",open:t.value,"onUpdate:open":g[0]||(g[0]=y=>t.value=y),title:p(e)("answer_source"),placement:"right",width:"746px",closable:!1,bodyStyle:{background:"#F2F4F7"}},{extra:F(()=>[a("span",{class:"close-btn",onClick:m},[O(p(Me))])]),default:F(()=>[a("div",rs,[a("div",ds,[(s(!0),o(B,null,P(u.value,y=>(s(),o("div",{class:J(["file-item",{active:v.value==y.id}]),key:y.id,onClick:R=>i(y)},_(y.file_name),11,_s))),128))]),a("div",us,[(s(!0),o(B,null,P(k.value,y=>(s(),o("div",{class:"document-item",key:y.id},[a("div",hs,[a("div",ps,[a("span",vs,_(p(e)("id_prefix"))+_(y.id),1),y.title?(s(),o("span",ms,_(y.title),1)):T("",!0),a("span",fs,_(p(e)("total_characters",{count:y.word_total})),1)]),a("div",ys,[a("a",{onClick:$},_(p(e)("view_source_document")),1)])]),a("div",gs,[a("div",ks,[E(_(p(e)("similarity"))+" ",1),O(b,{name:"similarity",style:{"font-size":"16px"}}),E(_(y.similarity),1)]),y.question?(s(),o("div",bs,_(p(e)("question_prefix"))+_(y.question),1)):T("",!0),y.answer?(s(),o("div",Ls,_(p(e)("answer_prefix"))+_(y.answer),1)):T("",!0),a("div",ws,_(y.content),1),_e((s(),o("div",xs,[(s(!0),o(B,null,P(y.images,(R,z)=>(s(),o("img",{key:z,src:R,alt:""},null,8,Cs))),128))])),[[A]])])]))),128))])])]),_:1},8,["open","title"])}}},Ts=H(Ss,[["__scopeId","data-v-33e46666"]]),$s={key:0,class:"chat-box-warpper"},Ms={class:"chat-box-header"},Rs={class:"nickname"},Ds={class:"chat-source"},Os={class:"chat-box-content"},Is={key:1},Ns={__name:"chat-box",setup(d,{expose:r}){const{t:e}=V("views.chat-monitor.components.chat-box"),c=Z(),{activeChat:t}=Q(c),u=x(null),v=()=>{u.value.scrollToBottom()},w=()=>{u.value.scrollToTop()},M=x(null),i=(k,L)=>{M.value.open(k,L)};return r({scrollToTop:w,scrollToBottom:v}),(k,L)=>(s(),o(B,null,[p(t)?(s(),o("div",$s,[a("div",Ms,[a("div",Rs,_(p(t).name||p(t).nickname),1),a("div",Ds,_(p(e)("from_source",{robot:p(t).come_from.robot_name,app:p(t).come_from.app_name})),1)]),a("div",Os,[O(cs,{ref_key:"chatMessageRef",ref:u,onOpenLibrary:i},null,512)])])):(s(),o("div",Is)),O(Ts,{ref_key:"libraryInfoAlertRef",ref:M},null,512)],64))}},Bs=H(Ns,[["__scopeId","data-v-2aa18c16"]]),qs={class:"zm-date-quick"},As={class:"btns"},Ps=["onClick"],Ys={key:0,class:"custom-panel"},zs={__name:"date-filter",props:{datekey:{type:String,default:"2"}},emits:["dateChange"],setup(d,{emit:r}){const{t:e}=V("views.chat-monitor.components.date-filter"),c=d,t=r,u=x(2),v=x(!1),w=x([]),M=be([{label:"label_today",key:2,start_date:N().startOf("day"),end_date:N().endOf("day")},{label:"label_yesterday",key:3,start_date:N().subtract(1,"day").startOf("day"),end_date:N().startOf("day").subtract(1,"millisecond")},{label:"label_this_week",key:6,start_date:N().startOf("week"),end_date:N().endOf("day").subtract(1,"millisecond")},{label:"label_last_3_months",key:7,start_date:N().subtract(3,"month").startOf("day"),end_date:N().endOf("day").subtract(1,"millisecond")},{label:"label_custom",key:5,start_date:N().startOf("day"),end_date:N().endOf("day")}]),i=m=>m&&m.valueOf()>N().endOf("day").valueOf(),k=(m,l)=>{t("dateChange",{start_time:m.startOf("day").format("YYYYMMDD"),end_time:l.endOf("day").format("YYYYMMDD")})},L=m=>{u.value=m;const l=M.find(g=>g.key===m);if(l){if(m===5){w.value=[l.start_date,l.end_date],v.value=!v.value,u.value=5;return}w.value=[l.start_date,l.end_date],k(l.start_date,l.end_date)}},$=m=>{if(!m||m.length<2)return;const[l,g]=m;u.value=5,M.forEach(b=>{b.key===5&&(b.start_date=l,b.end_date=g)}),k(l,g)};return se(()=>{const m=parseInt(c.datekey.split("-")[0])||2;L(m)}),te(()=>c.datekey,m=>{const l=parseInt(String(m).split("-")[0])||2;L(l)}),(m,l)=>{const g=Oe;return s(),o("div",qs,[a("div",As,[(s(!0),o(B,null,P(M,b=>(s(),o("span",{key:b.key,class:J(["btn",{active:b.key===u.value}]),onClick:C=>L(b.key)},[E(_(p(e)(b.label))+" ",1),b.key===5?(s(),U(p(De),{key:0,class:J(["down-icon",{rotate:v.value}])},null,8,["class"])):T("",!0)],10,Ps))),128))]),v.value?(s(),o("div",Ys,[O(g,{value:w.value,"onUpdate:value":l[0]||(l[0]=b=>w.value=b),format:"YYYY-MM-DD",disabledDate:i,allowClear:!1,onChange:$},null,8,["value"])])):T("",!0)])}}},Hs=H(zs,[["__scopeId","data-v-5c70e99e"]]),js={class:"chat-monitor-page"},Fs={class:"page-left"},Us={class:"app-list-box"},Js={class:"search-box"},Vs={class:"search-input-row"},Es={key:0,class:"date-filter-wrapper"},Ws={class:"chat-list-wrapper"},Ks={class:"page-body"},Gs={__name:"index",setup(d){const{t:r}=V("views.chat-monitor"),e=he(),c=Z(),{init:t,changeRobot:u,switchChat:v,closeIM:w}=c,{robotList:M,selectedRobotId:i,activeChat:k}=Q(c),L=x(null),$=x(null),m=x(""),l=x(!1),g=x("2"),b=x(""),C=x(""),A=()=>{l.value=!l.value},y=({start_time:f,end_time:I})=>{b.value=N(String(f),"YYYYMMDD").startOf("day").unix(),C.value=N(String(I),"YYYYMMDD").endOf("day").unix();const n={keyword:m.value,page:1,start_time:b.value,end_time:C.value};L.value&&L.value.getData(n)},R=()=>{const f={keyword:m.value,page:1,start_time:b.value||void 0,end_time:C.value||void 0};u(f)},z=async f=>{var I;await v(f),(I=$.value)==null||I.scrollToBottom()},D=()=>{G(()=>{var f;(f=$.value)==null||f.scrollToBottom()})},S=()=>{const f={keyword:m.value,page:1,start_time:b.value||void 0,end_time:C.value||void 0};L.value&&L.value.getData(f)};return se(async()=>{await t(),G(()=>{var f;(f=$.value)==null||f.scrollToBottom()}),e.on("onAddMessage",D)}),re(()=>{e.off("onAddMessage",D),w()}),(f,I)=>{const n=Ie,W=Ne,h=Be,j=X;return s(),o("div",js,[a("div",Fs,[a("div",Us,[O(W,{value:p(i),"onUpdate:value":I[0]||(I[0]=q=>ue(i)?i.value=q:null),style:{width:"100%"},onChange:R},{default:F(()=>[O(n,{value:""},{default:F(()=>[E(_(p(r)("all_apps")),1)]),_:1}),(s(!0),o(B,null,P(p(M),q=>(s(),U(n,{value:q.id,key:q.id},{default:F(()=>[a("span",null,_(q.robot_name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),a("div",Js,[a("div",Vs,[O(h,{value:m.value,"onUpdate:value":I[1]||(I[1]=q=>m.value=q),placeholder:p(r)("search_placeholder"),"enter-button":"",style:{flex:"1"},onSearch:S,allowClear:"",onPressEnter:S},null,8,["value","placeholder"]),a("div",{class:J(["time-filter-btn",{active:l.value}]),onClick:A},[O(j,{name:"time-line-icon",class:"time-icon"})],2)]),l.value?(s(),o("div",Es,[O(Hs,{datekey:g.value,onDateChange:y},null,8,["datekey"])])):T("",!0)]),a("div",Ws,[O(at,{ref_key:"chatListRef",ref:L,onSwitchChat:z},null,512)])]),a("div",Ks,[p(k)?(s(),U(Bs,{key:0,ref_key:"chatBoxRef",ref:$},null,512)):(s(),U(pe,{key:1,style:{background:"#F2F4F7"},size:"250"},{default:F(()=>[a("div",null,[a("p",null,_(p(r)("select_conversation_tip")),1),a("p",null,_(p(r)("feature_description")),1)])]),_:1}))])])}}},ho=H(Gs,[["__scopeId","data-v-1e49d53d"]]);export{ho as default};
