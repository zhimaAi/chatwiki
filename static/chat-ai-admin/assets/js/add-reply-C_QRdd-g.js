import{_ as te,av as ae,d as re}from"../../index-WMhSApoa.js";import{f as Y,aw as ne,e as se,r as le,w as C,o as oe,ac as D,k as n,as as m,ar as s,av as ie,ad as g,G as i,at as O,ae as c,az as A,u as S,F as ue,ax as _e}from"./vue-chunks-CGLjTDrY.js";import{M as pe}from"./multi-reply-BNWxgO4B.js";import{r as de,t as ye}from"./index-CHNVlDjk.js";import{b as w,m as me,F as ve,d as x,n as ge,e as fe,Q as ke,v as we,ah as be,w as ce,x as Ae,y as xe,z as Re,X as Ye,bt as Me,O as Ce,N as De,B as Se,a6 as Ue}from"./ui-antd-BDReVt-O.js";import"./neo4j-CK9lNpyi.js";import"./utils-DXEytJvC.js";import"./other-BrZCAsTs.js";import"./index-CxGFxpsV.js";import"./index-CtAh6k0_.js";const Ne={class:"subManage-edit"},Pe=["href"],Be={class:"main"},Oe={class:"ml4"},Te={class:"item-box"},he={class:"flex-center"},qe={key:4,style:{"margin-left":"98px"}},Ie={class:"nav-box",style:{"margin-top":"24px"}},$e={class:"item-box"},ze={class:"radio-container"},Fe={class:"btn-container"},je={__name:"add-reply",setup(Ee){const U=Y([]),v=ne().query,R=Y(+v.rule_id||+v["rule-id"]||0),d=Y(v.rule_type||"receive_reply_duration"),T=ie(),h=se(()=>`/#/robot/ability/auto-reply?id=${v.id}&robot_key=${v.robot_key}&active_key=received&rule_type=${d.value}`),N=Y(null),e=le({duration_type:"day",reply_period:[],priority_num:null,week_day:["1"],week_duration:["1"],date_range:[],start_day:"",end_day:"",reply_num:"0",message_type:"0",message_type_list:[],reply_interval:0,switch_status:!0}),q={name:[{required:!0,message:"请输入规则名称",trigger:"blur"}]},I=ae;function $(l,t){return e.duration_type!=="time_range"||Array.isArray(t)&&t.length===2&&t[0]&&t[1]?Promise.resolve():Promise.reject("请选择起止日期")}function z(l,t){return e.duration_type!=="week"||Array.isArray(t)&&t.length>0?Promise.resolve():Promise.reject("请选择至少一个星期")}C(()=>e.duration_type,l=>{l==="week"?((!Array.isArray(e.week_day)||e.week_day.length===0)&&(e.week_day=["1"]),e.week_duration=Array.isArray(e.week_day)?e.week_day:[e.week_day]):l==="time_range"&&Array.isArray(e.date_range)&&e.date_range.length===2&&e.date_range[0]&&e.date_range[1]?(e.start_day=x(e.date_range[0]).format("YYYY-MM-DD"),e.end_day=x(e.date_range[1]).format("YYYY-MM-DD")):(e.start_day="",e.end_day="")}),C(()=>e.week_day,l=>{e.duration_type==="week"&&(e.week_duration=Array.isArray(l)?l:[l])}),C(()=>e.date_range,l=>{e.duration_type==="time_range"&&Array.isArray(l)&&l.length===2&&l[0]&&l[1]&&(e.start_day=x(l[0]).format("YYYY-MM-DD"),e.end_day=x(l[1]).format("YYYY-MM-DD"))});const _=Y([{type:"text",description:""}]),F=()=>{if(_.value.length>=5){w.warning("最多添加5条回复内容");return}_.value.push({type:"text",description:""})},j=l=>{const{reply_index:t,...u}=l;t>=0&&t<_.value.length&&(_.value[t]=u)},E=l=>{_.value.splice(l,1)},H=()=>{};function V(l){return(l||[]).map(t=>({...t,status:"1"}))}function L(l){const t={text:"2",image:"4",card:"3",imageText:"1",url:"5",smartMenu:"6"};return l.map(u=>t[u.type]||"").filter(Boolean)}const Q=()=>{var l;(l=N.value)==null||l.validate().then(async()=>{if(!_.value.length){w.warning("请至少添加一条回复内容");return}if(d.value==="receive_reply_duration"){if(!e.reply_period||e.reply_period.length!==2){w.warning("请选择回复时段");return}const a=Number(e.priority_num);if(!Number.isInteger(a)||a<1||a>100){w.warning("优先级需为1-100之间的整数");return}if(e.duration_type==="time_range"&&!(Array.isArray(e.date_range)&&e.date_range.length===2&&e.date_range[0]&&e.date_range[1])){w.warning("请选择自定义日期范围");return}}if(d.value==="receive_reply_message_type"&&e.message_type==="1"&&(!Array.isArray(e.message_type_list)||e.message_type_list.length===0)){w.warning("请至少选择一种指定消息类型");return}for(const a of U.value)if(a&&a.validate&&!await a.validate())return;const t={robot_id:v.id,switch_status:e.switch_status?"1":"0",rule_type:d.value,reply_interval:Number(e.reply_interval)||0,reply_content:JSON.stringify(V(_.value)),reply_type:L(_.value),reply_num:e.reply_num};let u={};d.value==="receive_reply_message_type"?u={message_type:e.message_type,specify_message_type:Array.isArray(e.message_type_list)?e.message_type_list.join(","):""}:u={duration_type:e.duration_type,start_day:e.start_day,end_day:e.end_day,week_duration:e.week_duration,priority_num:Number(e.priority_num)||0,start_duration:Array.isArray(e.reply_period)&&e.reply_period[0].toString()||"",end_duration:Array.isArray(e.reply_period)&&e.reply_period[1].toString()||""};const k={...t,...u};R.value&&(k.id=R.value);try{const a=await ye(k);a&&a.res==0&&(w.success("保存成功"),T.push({path:"/robot/ability/auto-reply",query:{id:v.id,robot_key:v.robot_key,active_key:"received",rule_type:d.value}}))}catch{}})};return oe(async()=>{const l=+(v.copy_id||0),t=async u=>{const k=await de({id:u,robot_id:v.id}),a=(k==null?void 0:k.data)||{};if(d.value=(a==null?void 0:a.rule_type)||d.value,e.switch_status=String((a==null?void 0:a.switch_status)||"0")==="1",e.duration_type=(a==null?void 0:a.duration_type)||e.duration_type,e.duration_type==="week"){const r=Array.isArray(a==null?void 0:a.week_duration)?a.week_duration.map(y=>String(y)):[];e.week_day=r.length?r:["1"],e.week_duration=[...e.week_day]}if(e.duration_type==="time_range"||e.duration_type==="day"){const r=(a==null?void 0:a.start_day)||"",y=(a==null?void 0:a.end_day)||"";r&&y&&(e.date_range=[x(r),x(y)])}const b=(a==null?void 0:a.start_duration)||"",p=(a==null?void 0:a.end_duration)||"";e.reply_period=[b,p].filter(Boolean).length===2?[b,p]:[],e.start_duration=b,e.end_duration=p,e.priority_num=Number((a==null?void 0:a.priority_num)||e.priority_num||0),e.message_type=String((a==null?void 0:a.message_type)??e.message_type),e.message_type_list=Array.isArray(a==null?void 0:a.specify_message_type)?a.specify_message_type:[],e.reply_interval=Number((a==null?void 0:a.reply_interval)||0);const f=Array.isArray(a==null?void 0:a.reply_content)?a.reply_content:[];_.value=f.map(r=>({type:(r==null?void 0:r.type)||(r==null?void 0:r.reply_type)||"text",description:(r==null?void 0:r.description)||"",thumb_url:(r==null?void 0:r.thumb_url)||(r==null?void 0:r.pic)||"",title:(r==null?void 0:r.title)||"",url:(r==null?void 0:r.url)||"",appid:(r==null?void 0:r.appid)||"",page_path:(r==null?void 0:r.page_path)||"",smart_menu_id:(r==null?void 0:r.smart_menu_id)||"",smart_menu:(r==null?void 0:r.smart_menu)||{}})),e.reply_num=String((a==null?void 0:a.reply_num)??e.reply_num)};try{if(!R.value&&l){await t(l);return}if(!R.value)return;await t(R.value)}catch{w.error("加载规则失败，请稍后重试")}}),(l,t)=>{const u=ge,k=me,a=we,b=ke,p=fe,f=Ae,r=ce,y=Re,G=xe,J=Ye,W=Me,P=Ce,X=De,K=re,B=Se,Z=ve;return g(),D("div",Ne,[n(k,{class:"subManage-breadcrumb"},{default:s(()=>[n(u,null,{default:s(()=>[m("a",{href:h.value},"收到消息回复",8,Pe)]),_:1}),n(u,null,{default:s(()=>[i(O(d.value==="receive_reply_message_type"?"新增回复":"增加时段回复"),1)]),_:1})]),_:1}),m("div",Be,[n(Z,{ref_key:"formRef",ref:N,model:e,rules:q},{default:s(()=>[n(p,{name:"switch_status",rules:[{required:!0,message:"请输入规则名称"}]},{label:s(()=>[t[11]||(t[11]=i(" 是否开启 ",-1)),n(a,null,{title:s(()=>[...t[10]||(t[10]=[i("开启开关后，触发消息类型回复指定的内容",-1)])]),default:s(()=>[m("span",Oe,[n(S(be))])]),_:1})]),default:s(()=>[n(b,{checked:e.switch_status,"onUpdate:checked":t[0]||(t[0]=o=>e.switch_status=o),"checked-children":"开","un-checked-children":"关"},null,8,["checked"])]),_:1}),d.value==="receive_reply_duration"?(g(),c(p,{key:0,name:"duration_type",label:"选择回复时间"},{default:s(()=>[m("div",Te,[n(p,{name:"duration_type",rules:[{required:!0,message:"请选择回复时间类型"}]},{default:s(()=>[n(r,{value:e.duration_type,"onUpdate:value":t[1]||(t[1]=o=>e.duration_type=o)},{default:s(()=>[n(f,{value:"week"},{default:s(()=>[...t[12]||(t[12]=[i("每星期",-1)])]),_:1}),n(f,{value:"day"},{default:s(()=>[...t[13]||(t[13]=[i("每天",-1)])]),_:1}),n(f,{value:"time_range"},{default:s(()=>[...t[14]||(t[14]=[i("自定义时间",-1)])]),_:1})]),_:1},8,["value"])]),_:1}),e.duration_type==="week"?(g(),c(p,{key:0,name:"week_day",rules:[{validator:z}]},{default:s(()=>[n(G,{value:e.week_day,"onUpdate:value":t[2]||(t[2]=o=>e.week_day=o),mode:"multiple",style:{width:"200px"},allowClear:""},{default:s(()=>[n(y,{value:"1"},{default:s(()=>[...t[15]||(t[15]=[i("星期一",-1)])]),_:1}),n(y,{value:"2"},{default:s(()=>[...t[16]||(t[16]=[i("星期二",-1)])]),_:1}),n(y,{value:"3"},{default:s(()=>[...t[17]||(t[17]=[i("星期三",-1)])]),_:1}),n(y,{value:"4"},{default:s(()=>[...t[18]||(t[18]=[i("星期四",-1)])]),_:1}),n(y,{value:"5"},{default:s(()=>[...t[19]||(t[19]=[i("星期五",-1)])]),_:1}),n(y,{value:"6"},{default:s(()=>[...t[20]||(t[20]=[i("星期六",-1)])]),_:1}),n(y,{value:"7"},{default:s(()=>[...t[21]||(t[21]=[i("星期日",-1)])]),_:1})]),_:1},8,["value"])]),_:1},8,["rules"])):A("",!0),e.duration_type==="time_range"?(g(),c(p,{key:1,name:"date_range",rules:[{validator:$}]},{default:s(()=>[n(J,{value:e.date_range,"onUpdate:value":t[3]||(t[3]=o=>e.date_range=o),format:"YYYY-MM-DD"},null,8,["value"])]),_:1},8,["rules"])):A("",!0)])]),_:1})):A("",!0),d.value==="receive_reply_duration"?(g(),c(p,{key:1,name:"reply_period",label:"回复时段",rules:[{required:!0,message:"请选择回复时段"}]},{default:s(()=>[n(W,{value:e.reply_period,"onUpdate:value":t[4]||(t[4]=o=>e.reply_period=o),valueFormat:"HH:mm",format:"HH:mm",allowClear:!1},null,8,["value"]),t[22]||(t[22]=m("div",{class:"tip-box"}," 如需跨天，请单独重新再添加一条时段回复：第一个是到23:59结束，第二个是从0点开始 ",-1))]),_:1})):A("",!0),d.value==="receive_reply_duration"?(g(),c(p,{key:2,name:"priority_num",label:"优先级",rules:[{required:!0,message:"输入优先级，1-100之间"}]},{default:s(()=>[n(P,{value:e.priority_num,"onUpdate:value":t[5]||(t[5]=o=>e.priority_num=o),style:{width:"200px"},min:1,max:100},null,8,["value"]),t[23]||(t[23]=m("div",{class:"tip-box",style:{color:"red"}}," 数字越小，则优先级越高。优先级仅在时间相互冲突时有效，比如一个每天1-9点与一个每天310点，当8点钟触发时，则只会触发其中优先级最高的一个。 ",-1))]),_:1})):A("",!0),n(p,{class:"interval-item",name:"reply_interval",label:"触发回复间隔时间"},{default:s(()=>[m("div",he,[n(P,{value:e.reply_interval,"onUpdate:value":t[6]||(t[6]=o=>e.reply_interval=o),style:{width:"60px"}},null,8,["value"]),t[24]||(t[24]=m("span",{class:"ml4"},"秒 在时间间隔内只会触发一次该回复，0秒为无时间间隔限制",-1))])]),_:1}),d.value==="receive_reply_message_type"?(g(),c(p,{key:3,class:"message-type-item",name:"message_type",label:"消息类型"},{default:s(()=>[n(r,{value:e.message_type,"onUpdate:value":t[7]||(t[7]=o=>e.message_type=o)},{default:s(()=>[n(f,{value:"0"},{default:s(()=>[...t[25]||(t[25]=[i("全部消息",-1)])]),_:1}),n(f,{value:"1"},{default:s(()=>[...t[26]||(t[26]=[i("指定消息",-1)])]),_:1})]),_:1},8,["value"])]),_:1})):A("",!0),e.message_type==="1"?(g(),D("div",qe,[n(X,{value:e.message_type_list,"onUpdate:value":t[8]||(t[8]=o=>e.message_type_list=o),options:S(I)},null,8,["value","options"])])):A("",!0),m("div",Ie,[n(K,{name:"reply-content",style:{"font-size":"16px"}}),t[27]||(t[27]=i(" 回复内容 ",-1))]),m("div",$e,[(g(!0),D(ue,null,_e(_.value,(o,M)=>(g(),c(pe,{key:M,ref_for:!0,ref_key:"replyRefs",ref:U,value:_.value[M],"onUpdate:value":ee=>_.value[M]=ee,reply_index:M,onChange:j,onDel:E},null,8,["value","onUpdate:value","reply_index"]))),128)),n(B,{type:"dashed",style:{width:"694px"},disabled:_.value.length>=5,onClick:F},{icon:s(()=>[n(S(Ue))]),default:s(()=>[i(" 添加回复内容("+O(_.value.length)+"/5) ",1)]),_:1},8,["disabled"])]),n(p,{name:"reply_num",label:"回复方式",style:{"margin-top":"24px"}},{default:s(()=>[m("div",ze,[n(r,{value:e.reply_num,"onUpdate:value":t[9]||(t[9]=o=>e.reply_num=o),onChange:H},{default:s(()=>[n(f,{value:"0"},{default:s(()=>[...t[28]||(t[28]=[i("全部回复",-1)])]),_:1}),n(f,{value:"1"},{default:s(()=>[...t[29]||(t[29]=[i("随机回复一条",-1)])]),_:1})]),_:1},8,["value"])])]),_:1}),m("div",Fe,[n(B,{type:"primary",onClick:Q},{default:s(()=>[...t[30]||(t[30]=[i("保存",-1)])]),_:1})])]),_:1},8,["model"])])])}}},et=te(je,[["__scopeId","data-v-9452b811"]]);export{et as default};
