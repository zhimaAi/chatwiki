import{b as W,bQ as K,d as Y,S as me,G as fe,bU as ee,h as be,bV as ye,bW as ge,bM as he,ar as ke,aU as xe}from"../../index-CPkdGIiL.js";import{r as V,e as G,f as x,w as we,o as H,Y as b,a5 as s,k as a,a2 as o,a1 as B,ae as M,G as k,F as E,a9 as ae,u as T,_ as c,a7 as D,c as te,af as Se,ad as Ce,n as Le,A as $e,y as Ue,B as X,ab as De,J as Ie,p as Z}from"./vue-chunks-Ci-XTWEs.js";import{C as Re}from"./config-page-menu-m5rCHduL.js";import{u as Oe}from"./index-C71Z1axJ.js";import{e as se,q as oe,R as le,ak as Be,u as Me,I as Pe,B as ne,F as re,a as P,v as ze,V as ie,M as Ae,z as Fe,D as je,g as Te,b as Ve,c as Ne,bw as qe,bv as Ee,y as We}from"./ui-antd-Bw8cEW5z.js";import{B as q,P as Ge,S as Ye,M as He}from"./pull-up.esm-D94Swpvl.js";import{d as _e}from"./role_avatar-DL0r08JY.js";import"./utils-ChQO-_r6.js";const Je={class:"form-box"},Qe={class:"form-box-header"},Ke={class:"form-box-label"},Xe={class:"share-url-box"},Ze={__name:"permissions-form",props:{value:{type:Object,default:()=>({})},saveLoading:{type:Boolean,default:!1}},emits:["submit","update:value"],setup(z,{emit:I}){const{toClipboard:L}=Oe(),$=I,m=z,l=V({access_rights:"0",share_url:void 0,library_key:""}),p=G(()=>l.share_url+K+"/home/"+l.library_key),y=()=>{$("submit",l)},f=x([]),t=()=>{me().then(u=>{f.value=u.data||[],l.share_url||f.value.length>0&&(l.share_url=f.value[0].url)})},U=u=>{l.access_rights=u.access_rights,l.share_url=u.share_url,l.library_key=u.library_key,(f.value.length==0||!l.share_url)&&t()},R=async()=>{if(!l.share_url){P.error("请选择自定义域名");return}let u=p.value;try{await L(u),P.success("复制成功")}catch{P.error("复制失败")}};return we(m.value,u=>{U({...u})}),H(()=>{t()}),(u,r)=>{const g=Y,C=le,i=oe,e=se,h=ze,d=Me,A=Pe,O=Be,F=ne,j=re;return c(),b("div",Je,[s("div",Qe,[s("div",Ke,[a(g,{name:"auth",style:{"font-size":"14px",color:"#333"}}),r[2]||(r[2]=s("span",{class:"form-box-label-text"},"访问权限",-1))]),r[3]||(r[3]=s("div",null,null,-1))]),a(j,{"label-col":{span:4},style:{width:"750px"}},{default:o(()=>[a(e,{label:"访问权限"},{default:o(()=>[a(i,{value:l.access_rights,"onUpdate:value":r[0]||(r[0]=w=>l.access_rights=w),onChange:y},{default:o(()=>[a(C,{value:"0"},{default:o(()=>r[4]||(r[4]=[k("私有，仅能与应用关联，作为应用知识库")])),_:1,__:[4]}),a(C,{value:"1"},{default:o(()=>r[5]||(r[5]=[k("公开，发布到互联网，所有人可访问")])),_:1,__:[5]})]),_:1},8,["value"])]),_:1}),l.access_rights==1?(c(),B(e,{key:0,label:"复制链接"},{default:o(()=>[s("div",Xe,[a(O,{compact:"",style:{width:"600px",display:"flex"}},{default:o(()=>[a(d,{style:{width:"250px"},value:l.share_url,"onUpdate:value":r[1]||(r[1]=w=>l.share_url=w),placeholder:"请选择自定义域名",onChange:y},{default:o(()=>[(c(!0),b(E,null,ae(f.value,w=>(c(),B(h,{value:w.url,key:w.id},{default:o(()=>[k(D(w.url),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"]),a(A,{disabled:!0,value:T(K)+"/home/"+l.library_key,style:{width:"350px"}},null,8,["value"])]),_:1}),a(F,{class:"copy-btn",onClick:R},{default:o(()=>r[6]||(r[6]=[k("复制")])),_:1,__:[6]})]),r[7]||(r[7]=s("div",null,[s("a",{href:"/#/user/domain"},"添加自定义域名")],-1))]),_:1,__:[7]})):M("",!0)]),_:1})])}}},ea=W(Ze,[["__scopeId","data-v-8b2b2729"]]),aa={class:"form-box"},ta={class:"collaborator-list-tip"},sa={class:"list-content"},oa={class:"collaborator-grid"},la=["onClick"],na={class:"user-info"},ra={class:"user-details"},ia={class:"user-name"},_a={class:"user-nickname"},ca={key:0,class:"loading-more"},ua={key:1,class:"no-more"},da={__name:"add-collaborator",props:{excludedIds:{type:Array,default:()=>[]}},emits:["ok"],setup(z,{expose:I,emit:L}){q.use(Ge),q.use(Ye),q.use(He);const $=L,m=z,l=te("libraryState",{}),p=x(!1),y=x(null),f=x(!1),t=V({permission:"2",collaborators:[]}),U={permission:[{required:!0,message:"请选择协作权限"}],collaborators:[{required:!0,message:"请选择协作者",type:"array",min:1}]},R=_=>{let n=t.collaborators.indexOf(_.id);n>-1?t.collaborators.splice(n,1):t.collaborators.push(_.id)},u=x([]),r=G(()=>u.value.filter(_=>!m.excludedIds.includes(_.id))),g=V({page:1,size:20,total:0,search:""}),C=x(null),i=x(!1),e=x(!1);let h=x(null);const d=()=>{if(h.value){h.value.refresh();return}h.value=new q(C.value,{probeType:2,click:!0,scrollY:!0,bounce:!1,pullUpLoad:!0,scrollbar:{fade:!1,interactive:!0},mouseWheel:{speed:20,invert:!1,easeTime:300}}),h.value.on("pullingUp",A)},A=async()=>{i.value||e.value||(g.page=g.page+1,i.value=!0,await O(),h.value.finishPullUp(),i.value=!1)},O=async()=>{let _={page:g.page,size:g.size,search:g.search};return fe(_).then(n=>{let v=n.data.list||[];return g.page==1?u.value=u.value=v:u.value=u.value.concat(v),g.total=+n.data.total,u.value.length>=g.total&&(e.value=!0),Ue(()=>{h.value&&h.value.refresh()}),n})},F=()=>{let _={operate_rights:t.permission,user_ids:t.collaborators.join(","),type:1,library_key:l.library_key};f.value=!0,ee(_).then(()=>{p.value=!1,f.value=!1,$("ok",_),P.success("添加成功")}).catch(()=>{f.value=!1})},j=async()=>{var _;try{await((_=y.value)==null?void 0:_.validate()),F()}catch(n){console.error("表单验证失败:",n)}},w=()=>{var _;(_=y.value)==null||_.resetFields(),p.value=!1};return I({open:()=>{var _;p.value=!0,(_=y.value)==null||_.resetFields(),g.page=1,O(),setTimeout(()=>{d()},200)}}),(_,n)=>{const v=le,N=oe,Q=se,ce=Se("RouterLink"),ue=Y,de=ie,pe=re,ve=Ae;return c(),B(ve,{open:p.value,"onUpdate:open":n[1]||(n[1]=S=>p.value=S),title:"添加协作者",width:"760px",confirmLoading:f.value,onOk:j,onCancel:w},{default:o(()=>[s("div",aa,[a(pe,{layout:"vertical",model:t,rules:U,ref_key:"formRef",ref:y},{default:o(()=>[a(Q,{name:"permission",label:"协作权限"},{default:o(()=>[a(N,{value:t.permission,"onUpdate:value":n[0]||(n[0]=S=>t.permission=S)},{default:o(()=>[a(v,{value:"4"},{default:o(()=>n[2]||(n[2]=[k("可管理")])),_:1,__:[2]}),a(v,{value:"2"},{default:o(()=>n[3]||(n[3]=[k("可编辑")])),_:1,__:[3]})]),_:1},8,["value"])]),_:1}),a(Q,{name:"collaborators",label:"协作者"},{default:o(()=>[s("div",ta,[n[5]||(n[5]=k(" 如果协作者没有账号，请先到团队管理中添加账号 ")),a(ce,{to:"/user/manage",target:"_blank"},{default:o(()=>n[4]||(n[4]=[k("去添加")])),_:1,__:[4]})]),s("div",{class:"collaborator-list",ref_key:"listRef",ref:C},[s("div",sa,[s("div",oa,[(c(!0),b(E,null,ae(r.value,S=>(c(),b("div",{class:Ce(["collaborator-item",{active:t.collaborators.includes(S.id)}]),key:S.id,onClick:Ma=>R(S)},[Le(a(ue,{name:"check-arrow-filled",class:"check-icon"},null,512),[[$e,t.collaborators.includes(S.id)]]),s("div",na,[a(de,{class:"user-avatar",src:S.avatar||T(_e)},null,8,["src"]),s("div",ra,[s("div",ia,D(S.user_name),1),s("div",_a,D(S.nick_name),1)])])],10,la))),128))]),i.value?(c(),b("div",ca,"加载中...")):M("",!0),e.value?(c(),b("div",ua,"没有更多了")):M("",!0)])],512)]),_:1})]),_:1},8,["model"])])]),_:1},8,["open","confirmLoading"])}}},pa=W(da,[["__scopeId","data-v-63eab63e"]]),va={class:"collaborator-list-box"},ma={class:"list-tools-box"},fa={class:"list-label"},ba={class:"label-text"},ya={class:"tools-box-right"},ga={class:"list-box"},ha={key:0,class:"name-cell"},ka={class:"user-info"},xa={class:"username"},wa={class:"nickname"},Sa={key:0,class:"role-cell"},Ca={key:1,class:"role-cell"},La={key:1},$a={__name:"collaborator-list",setup(z){const I=be(),L=te("libraryState",{}),$=x(null),m=[{title:"姓名",key:"name",width:"40%"},{title:"角色",dataIndex:"role",key:"role",width:"40%"},{title:"操作",key:"action",width:"20%"}],l={4:{label:"可管理",value:"4"},2:{label:"可编辑",value:"2"}},p=V({current:1,pageSize:999,total:0}),y=x([]),f=G(()=>y.value.map(i=>i.user_id)),t=(i,e)=>{e.operate_rights=i.key*1,e.operate_rights_label=l[e.operate_rights].label||"",U(e)},U=i=>{let e={operate_rights:i.operate_rights,user_ids:i.user_id,type:2,library_key:L.library_key};ee(e).then(()=>{P.success("修改成功")}).catch(()=>{})},R=()=>{$.value.open()},u=i=>{let e={id:i.id,library_key:L.library_key};ge(e).then(()=>{P.success("移除成功"),C()}).catch(()=>{})},r=()=>{C()},g=i=>{Object.assign(p,i),C()},C=()=>{ye({library_key:L.library_key,page:p.current,size:p.pageSize}).then(i=>{let e=i.data.list||[],{user_id:h}=I.userInfo;p.total=i.data.total,e.forEach(d=>{d.showDelete=!0,h==d.user_id&&(d.showDelete=!1),d.role_type==1&&(d.showDelete=!1),d.operate_rights=d.operate_rights*1,d.operate_rights_label="无权限",l[d.operate_rights]&&(d.operate_rights_label=l[d.operate_rights].label)}),y.value=e})};return H(()=>{C()}),(i,e)=>{const h=Y,d=ne,A=ie,O=Ne,F=Ve,j=je,w=Ee,J=qe,_=We;return c(),b("div",va,[s("div",ma,[s("div",fa,[a(h,{name:"collaborator"}),s("span",ba,"协助权限 ("+D(p.total)+")",1)]),s("div",ya,[a(d,{type:"primary",size:"small",onClick:R},{default:o(()=>[a(T(Fe)),e[2]||(e[2]=k(" 添加协助者"))]),_:1,__:[2]})])]),s("div",ga,[a(_,{columns:m,"data-source":y.value,pagination:p,onChange:g},{bodyCell:o(({column:n,record:v})=>[n.key==="name"?(c(),b("div",ha,[a(A,{class:"avatar",src:v.avatar||T(_e)},null,8,["src"]),s("div",ka,[s("div",xa,D(v.user_name),1),s("div",wa,D(v.nick_name),1)])])):M("",!0),n.key==="role"?(c(),b(E,{key:1},[v.showDelete?(c(),b("div",Sa,[a(j,null,{overlay:o(()=>[a(F,{onClick:N=>t(N,v)},{default:o(()=>[(c(),B(O,{key:4},{default:o(()=>e[3]||(e[3]=[k("可管理")])),_:1,__:[3]})),(c(),B(O,{key:2},{default:o(()=>e[4]||(e[4]=[k("可编辑")])),_:1,__:[4]}))]),_:2},1032,["onClick"])]),default:o(()=>[s("a",{class:"dropdown-label",onClick:e[0]||(e[0]=X(()=>{},["prevent"]))},[k(D(v.operate_rights_label)+" ",1),a(T(Te),{style:{"font-size":"12px"}})])]),_:2},1024)])):(c(),b("div",Ca,[s("a",{class:"dropdown-label disabled",onClick:e[1]||(e[1]=X(()=>{},["prevent"]))},D(v.operate_rights_label),1)]))],64)):M("",!0),n.key==="action"?(c(),b(E,{key:2},[v.showDelete?(c(),B(J,{key:0},{default:o(()=>[a(w,{title:"确定要移除此协作者吗?","ok-text":"确定","cancel-text":"取消",onConfirm:N=>u(v)},{default:o(()=>e[5]||(e[5]=[s("a",{href:"#"},"移除",-1)])),_:2,__:[5]},1032,["onConfirm"])]),_:2},1024)):(c(),b("span",La,[a(d,{style:{padding:"0"},type:"link",disabled:""},{default:o(()=>e[6]||(e[6]=[k("移除")])),_:1,__:[6]})]))],64)):M("",!0)]),_:1},8,["data-source","pagination"])]),a(pa,{excludedIds:f.value,ref_key:"addCollaboratorRef",ref:$,onOk:r},null,8,["excludedIds"])])}}},Ua=W($a,[["__scopeId","data-v-36368ac1"]]),Da={class:"permissions-page"},Ia={class:"page-container"},Ra={class:"form-box-wrapper"},Oa={class:"collaborator-list-wrapper"},Ba={__name:"index",setup(z){const I=he(),L=De(),$=G(()=>L.query.library_id),m=V({type:1,library_intro:"",library_name:"",model_config_id:"",model_define:"",use_model:"",is_offline:!1,access_rights:"0",share_url:"",library_key:"",avatar:"",avatar_file:""});Z("libraryState",m),Z("updateState",t=>{Object.assign(m,t)});const l=x(!1),p=t=>{Object.assign(m,t),l.value=!0,y().then(()=>{l.value=!1}).catch(()=>{l.value=!1})},y=async()=>{let t={...Ie(m)};delete t.library_key,t.avatar_file?(t.avatar=t.avatar_file,delete t.avatar_file):(delete t.avatar,delete t.avatar_file),await xe(t),I.getLibraryInfo(),P.success("修改成功")},f=()=>{ke({id:$.value}).then(t=>{Object.assign(m,t.data)})};return H(()=>{f()}),(t,U)=>(c(),b("div",Da,[a(Re),s("div",Ia,[s("div",Ra,[a(ea,{value:m,"onUpdate:value":U[0]||(U[0]=R=>m=R),saveLoading:l.value,onSubmit:p},null,8,["value","saveLoading"])]),s("div",Oa,[m.library_key?(c(),B(Ua,{key:0})):M("",!0)])])]))}},qa=W(Ba,[["__scopeId","data-v-1390e73c"]]);export{qa as default};
