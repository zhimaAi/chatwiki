import{b as T,an as ie,d as X,bp as ce,aQ as re,aG as de,bC as ue}from"../../index-CuFGOJXl.js";import{Z as pe,h as _e,a as fe,P as he,H as ve,C as me,b as H}from"./cu-scroll-ChtrbNJE.js";import{f as b,r as D,o as Y,Y as p,_ as r,a5 as e,k as v,w as ge,n as ye,al as we,an as ke,ae as C,u as O,ad as W,y as A,e as be,ab as xe,a1 as R,a2 as Z,a7 as S,a6 as Fe,F as U,a9 as q,G as Q,m as $e}from"./vue-chunks-yZ4gwLzA.js";import{aN as Ce,X as Ie,bD as Se,aD as J,ah as ee,au as Be,ay as De}from"./ui-antd-BKjlZQNA.js";import"./utils-smNh_pj2.js";import"./pull-up.esm-DIiTC7VE.js";import"./observe-dom.esm-B25JyVKH.js";const Le={class:"chart-wrapper"},Me={class:"zoom-toolbar-wrapper"},Oe={__name:"chart-box",emits:["nodeClick"],setup(B,{expose:$,emit:x}){const _=x,a=b(null);let n=null;const l=D({nodes:[],edges:[]}),m=b(1),y=()=>{n&&n.destroy();const f={layout:"forceDirected",initialZoom:m.value,disableTelemetry:!0,maxZoom:10,minZoom:.1,minimapContainer:document.getElementById("chatMap"),styling:{minimapViewportBoxColor:"#4399FF",selectedBorderColor:"rgba(255, 255, 255, 1)"}},u=document.getElementById("chartBox");n=new _e(u,l.nodes,l.edges,f);const i=new fe(n);new he(n),i.updateCallback("onZoom",k=>{m.value=Number(k.toFixed(1))}),new ve(n,{drawShadowOnHover:!0}),new me(n,{selectOnClick:!0}).updateCallback("onNodeClick",k=>{_("nodeClick",k)})},d=f=>{m.value=f,n&&n.setZoom(f)},o=({nodes:f,edges:u})=>{l.nodes=[l.nodes,...f],l.edges=[l.edges,...u],n&&n.addElementsToGraph(f,u)},w=({nodes:f,edges:u})=>{l.nodes=[l.nodes,...f],l.edges=[l.edges,...u],n&&n.addAndUpdateElementsInGraph(f,u)},I=({nodes:f,edges:u})=>{l.nodes=f,l.edges=u,n&&n.updateElementsInGraph(f,u)},N=({nodes:f,edges:u})=>{l.nodes=f,l.edges=u,y()};return Y(()=>{}),$({render:N,add:o,addAndUpdate:w,update:I}),(f,u)=>(r(),p("div",Le,[e("div",{class:"chart",id:"chartBox",ref_key:"chartBox",ref:a},null,512),u[0]||(u[0]=e("div",{class:"chart-mini-map",id:"chatMap"},null,-1)),e("div",Me,[v(pe,{value:m.value,onChange:d},null,8,["value"])])]))}},Ne=T(Oe,[["__scopeId","data-v-20d52d07"]]),Te={class:"search-action-box"},ze={__name:"search-input",props:{value:{type:String,default:""}},emits:["search","clear","input","update:value"],setup(B,{emit:$}){const x=$,_=B,a=b(_.value),n=b(!1),l=b(null),m=()=>{x("update:value",a.value)},y=()=>{a.value="",A(()=>{var o;(o=l.value)==null||o.focus()}),m(),d()},d=()=>{x("search",a.value)};return ge(()=>_.value,o=>{a.value!==o&&(a.value=o)}),(o,w)=>(r(),p("div",{class:W(["search-input-box",{focused:n.value}])},[ye(e("input",{ref_key:"searchInput",ref:l,class:"search-input","onUpdate:modelValue":w[0]||(w[0]=I=>a.value=I),placeholder:"输入关键词搜索",type:"text",onKeyup:ke(d,["enter"]),onFocus:w[1]||(w[1]=I=>n.value=!0),onBlur:w[2]||(w[2]=I=>n.value=!1),onInput:m},null,544),[[we,a.value]]),e("div",Te,[B.value.length>0?(r(),p("span",{key:0,class:"action-btn",onClick:y},[v(O(Ce),{class:"clear-icon"})])):C("",!0),e("span",{class:"action-btn",onClick:d},[v(O(Ie),{class:"search-icon"})])])],2))}},Ee=T(ze,[["__scopeId","data-v-91276234"]]),Ve={key:0,class:"file-list-wrapper"},Ze={class:"open-file-box"},Re={key:0,class:"file-item active"},Ge={class:"file-info"},He=["onMouseenter","onClick"],Ue={class:"doc-content"},Ae={key:0,class:"loading-box"},Ke={class:"file-list-box"},Pe={class:"file-items"},qe={key:0,class:"file-item"},Qe=["onClick"],Xe={class:"file-name"},Ye={key:0,class:"loading-box"},je={class:"fragment-title"},Je={class:"fragment-details-body"},We={class:"fragment-content"},et={__name:"file-list",props:{show:{type:Boolean,default:!1}},emits:["openFile","openFragment"],setup(B,{expose:$,emit:x}){const{getStorage:_,removeStorage:a}=ie("localStorage"),n=x,l=B,m=xe(),y=_("graph:autoOpenFileId")||null,d=be(()=>m.query.id),o=D({list:[],library_id:d.value,status:2,page:1,size:20,total:0,showMore:!0}),w=async()=>{try{const c=await re({library_id:o.library_id,status:o.status,page:o.page,size:o.size});if(c.res!=0)return;let h=c.data.list||[];o.total=c.data.total,y&&(h=h.filter(M=>M.id!=y)),o.list=[...o.list,...h],o.list.length>=o.total&&(o.showMore=!1),o.page==1&&o.list.length>0&&L(o.list[0])}catch(c){o.showMore=!1}},I=()=>{o.list.length>=o.total||(o.page++,w())},N=b(null),f=b(null),u=b(0),i=D({show:!1,file_name:"",id:""}),s=D({show:!0,page:1,size:20,total:0,list:[],showMore:!0}),k=b(null),g=D({show:!1,title:"",content:""}),L=async c=>{if(c.id==i.id){k.value=null,n("openFile",c);return}i.show=!0,i.file_name=c.file_name,i.id=c.id,k.value=null,s.page=1,s.total=0,s.list=[],s.show=!0,s.showMore=!0,await E(),n("openFile",c)},G=()=>{s.show=!1},z=()=>{s.show=!0},t=b(300),E=async()=>{const c=await de({file_id:i.id,page:s.page,size:s.size,status:-1,graph_status:-1,category_id:-1});c.res==0&&(s.total=c.data.total,s.page==1?s.list=c.data.list||[]:s.list=[...s.list,...c.data.list],s.list.length>=s.total&&(s.showMore=!1),A(()=>{var M;let h=((M=f.value)==null?void 0:M.offsetHeight)||0;h>t.value?u.value=t.value:u.value=h,A(()=>{var V;(V=N.value)==null||V.refresh()})}))},K=()=>{s.list.length>=s.total||(s.page++,E())},te=c=>{k.value=c.id,n("openFragment",c)},se=c=>{clearTimeout(P),g.title=c.title,g.content=c.content,g.show=!0};let P=null;const oe=()=>{P=setTimeout(()=>{g.show=!1},200)},ae=()=>{clearTimeout(P)},ne=()=>{g.show=!1},le=async()=>{try{const c=await ce({id:y});o.list.push(c.data)}catch(c){}};return Y(async()=>{y&&(await le(),a("graph:autoOpenFileId")),w()}),$({openFile:L}),(c,h)=>{const M=X,V=ee;return r(),R($e,{name:"slide-fade"},{default:Z(()=>[l.show?(r(),p("div",Ve,[e("div",Ze,[i.show?(r(),p("div",Re,[e("div",Ge,[s.show?(r(),R(O(Se),{key:0,class:"caret-icon",onClick:h[0]||(h[0]=F=>G())})):(r(),R(O(J),{key:1,class:"caret-icon",onClick:h[1]||(h[1]=F=>z())})),v(M,{class:"file-icon",name:"doc-file",style:{}}),e("span",{class:"file-name",onClick:h[2]||(h[2]=F=>L(i))},S(i.file_name),1)]),s.show?(r(),p("div",{key:0,class:"document-fragments",style:Fe({maxHeight:t.value+"px",height:u.value>0?u.value+"px":"auto"})},[v(H,{ref_key:"fragmentsScrollView",ref:N,"group-id":"a",onOnScrollEnd:K},{default:Z(()=>[e("div",{class:"fragment-list",ref_key:"fragmentListRef",ref:f},[(r(!0),p(U,null,q(s.list,F=>(r(),p("div",{class:W(["fragment-item",{active:k.value==F.id}]),onMouseenter:j=>se(F),onMouseleave:oe,onClick:j=>te(F),key:F.id},[e("div",Ue,S(F.content),1)],42,He))),128))],512),s.list.length<s.total?(r(),p("div",Ae,[v(V,{size:"small"}),h[3]||(h[3]=Q()),h[4]||(h[4]=e("span",{class:"loading-text"},"加载中...",-1))])):C("",!0)]),_:1},512)],4)):C("",!0)])):C("",!0)]),e("div",Ke,[v(H,{"group-id":"a",onOnScrollEnd:I},{default:Z(()=>[e("div",Pe,[(r(!0),p(U,null,q(o.list,F=>(r(),p(U,{key:F.id},[F.id!=i.id?(r(),p("div",qe,[e("div",{class:"file-info",onClick:j=>L(F)},[v(O(J),{class:"caret-icon"}),v(M,{class:"file-icon",name:"doc-file",style:{}}),e("span",Xe,S(F.file_name),1)],8,Qe)])):C("",!0)],64))),128)),o.showMore?(r(),p("div",Ye,[v(V,{size:"small"}),h[5]||(h[5]=Q()),h[6]||(h[6]=e("span",{class:"loading-text"},"加载中...",-1))])):C("",!0)])]),_:1})]),g.show?(r(),p("div",{key:0,class:"fragment-details",onMouseenter:ae,onMouseleave:ne},[e("div",je,S(g.title||"无标题片段"),1),e("div",Je,[v(H,null,{default:Z(()=>[e("div",We,S(g.content),1)]),_:1})])],32)):C("",!0)])):C("",!0)]),_:1})}}},tt=T(et,[["__scopeId","data-v-d6938488"]]),st={key:0,class:"popup-wrapper entity-details-wrapper"},ot={class:"popup-header"},at={key:0,class:"popup-body"},nt={class:"popup-content"},lt={class:"entity-details"},it={class:"entity-item"},ct={class:"entity-name"},rt={class:"entity-item",style:{"margin-bottom":"8px"}},dt={class:"file-info"},ut={class:"file-name"},pt={class:"entity-item"},_t={class:"entity-item-header"},ft={class:"doc-item"},ht={class:"fragment-content"},vt={class:"entity-item"},mt={key:0,class:""},gt={class:"fragment-content"},yt={__name:"entity-details",emits:["toDetails"],setup(B,{expose:$,emit:x}){const _=x,a=D({show:!1,node:null,fromNodes:[]}),n=()=>{a.show=!1},l=(y,d)=>{a.node=y,a.fromNodes=d,a.show?(a.show=!1,A(()=>{a.show=!0})):a.show=!0},m=()=>{_("toDetails",a.node)};return $({open:l,close:n}),(y,d)=>{const o=X;return a.show?(r(),p("div",st,[e("div",ot,[d[0]||(d[0]=e("div",{class:"popup-title"},"实体详情",-1)),v(O(Be),{class:"close-btn",onClick:n})]),a.node?(r(),p("div",at,[v(H,null,{default:Z(()=>[e("div",nt,[e("div",lt,[e("div",it,[d[1]||(d[1]=e("div",{class:"entity-item-header"},[e("div",{class:"entity-item-label"},"实体")],-1)),e("div",ct,S(a.node.name),1)]),e("div",rt,[d[2]||(d[2]=e("div",{class:"entity-item-header"},[e("div",{class:"entity-item-label"},"归属文档")],-1)),e("div",dt,[v(o,{class:"file-icon",name:"doc-file",style:{}}),e("span",ut,S(a.node.file_name),1)])]),e("div",pt,[e("div",_t,[d[4]||(d[4]=e("div",{class:"entity-item-label"},"分段",-1)),e("span",{class:"to-details",onClick:m},[d[3]||(d[3]=Q("详情  ",-1)),v(O(De),{class:"right-icon"})])]),e("div",null,[e("div",ft,[e("div",ht,S(a.node.content),1)])])]),e("div",vt,[d[5]||(d[5]=e("div",{class:"entity-item-header"},[e("div",{class:"entity-item-label"},"子图")],-1)),e("div",null,[a.fromNodes.length==0?(r(),p("div",mt,"无")):C("",!0),(r(!0),p(U,null,q(a.fromNodes,w=>(r(),p("div",{class:"subgraph-item",key:w.id},[e("div",gt,S(w.name),1)]))),128))])])])])]),_:1})])):C("",!0)])):C("",!0)}}},wt=T(yt,[["__scopeId","data-v-449a5d4c"]]),kt={class:"collapse-icon"},bt={class:"collapse-label"},xt={__name:"collapse-btn",emits:["change"],setup(B,{emit:$}){const x=$,_=b(!0),a=()=>{_.value=!_.value,x("change",_.value)};return(n,l)=>{const m=X;return r(),p("div",{class:"collapse-btn",onClick:a},[e("span",kt,[_.value?(r(),R(m,{key:0,name:"collapse-close"})):(r(),R(m,{key:1,name:"collapse-open"}))]),e("span",bt,S(_.value?"收起":"展开"),1)])}}},Ft=T(xt,[["__scopeId","data-v-ab8552b8"]]),$t={class:"knowledge-graph-page"},Ct={key:0,class:"loading-wrapper"},It={class:"search-box"},St={class:"left-box"},Bt={class:"right-box"},Dt={__name:"index",setup(B){const $=b(null),x=b(null),_=b(!1),a=b(""),n=b(!0),l=D({file_id:"",data_id:"",search_term:""}),m=D({edges:[],nodes:[]});let y={};const d=i=>{n.value=i},o=i=>{l.file_id=i.id,l.data_id="",I()},w=i=>{l.data_id=i.id,I()},I=()=>{_.value=!0,ue({file_id:l.file_id,data_id:l.data_id,search_term:l.search_term}).then(i=>{_.value=!1;let s=i.data.edges||[],k=i.data.nodes||[];const g=new Map;s=s.filter(t=>{const E=`${t.from_id}_${t.to_id}`,K=`${t.to_id}_${t.from_id}`;return g.has(E)||g.has(K)?!1:(g.set(E,!0),!0)}),s.forEach(t=>{t.id=t.id.toString(),t.from=t.from_id.toString(),t.to=t.to_id.toString(),t.caption=t.label});const L=new Set(s.map(t=>t.from)),G=new Set(s.map(t=>t.to));k.forEach(t=>{t.id=t.id.toString(),t.nodeType=L.has(t.id)&&G.has(t.id)?"both":L.has(t.id)?"from":G.has(t.id)?"to":"normal",t.nodeType==="from"?(t.size=35,t.color="#FFB1B2"):t.nodeType==="to"?(t.size=45,t.color="#005AFF"):(t.size=30,t.color="#69E9BE"),t.captions=[{value:t.name,styles:[]}]});let z={edges:s,nodes:k};m.edges=z.edges,m.nodes=z.nodes,setTimeout(()=>{$.value.render(z)},0),y={},s.forEach(t=>{y[t.to]||(y[t.to]=[]),y[t.to].push(t.from)})}).catch(i=>{_.value=!1})},N=i=>{let s=y[i.id]||[],k=[];for(let g=0;g<m.nodes.length;g++)s.indexOf(m.nodes[g].id)>-1&&k.push(m.nodes[g]);x.value.open(i,k)},f=i=>{l.search_term=i,I()},u=i=>{window.open(`/#/library/preview?id=${i.file_id}`)};return Y(()=>{}),(i,s)=>{const k=ee;return r(),p("div",$t,[_.value?(r(),p("div",Ct,[v(k,{spinning:_.value},null,8,["spinning"])])):C("",!0),v(Ne,{ref_key:"chartBoxRef",ref:$,loading:_.value,onNodeClick:N},null,8,["loading"]),v(Ft,{onChange:d}),e("div",It,[v(Ee,{value:a.value,"onUpdate:value":s[0]||(s[0]=g=>a.value=g),onSearch:f},null,8,["value"])]),e("div",St,[v(tt,{onOpenFile:o,onOpenFragment:w,show:n.value},null,8,["show"])]),e("div",Bt,[v(wt,{ref_key:"entityDetailsRef",ref:x,onToDetails:u},null,512)])])}}},Vt=T(Dt,[["__scopeId","data-v-63b30116"]]);export{Vt as default};
