import{s as j,r as O}from"./index-BMl5QCxm.js";import{_ as C,c as K}from"../../index-WMhSApoa.js";import{o as E,F,e as J,I as L,M as B,b as U}from"./ui-antd-BDReVt-O.js";import{f as i,r as V,ae as N,ad as b,ar as _,k as p,as as q,ac as A,F as $,ax as Q,az as D,at as M,o as T}from"./vue-chunks-CGLjTDrY.js";const G={__name:"feishu-config-modal",emits:["change"],setup(I,{expose:S,emit:x}){const g=x,l=i({}),m=i(!1),d=i(!1),t=V({});function v(u={}){l.value=u,Object.assign(t,{name:"",appid:"",app_secret:"",is_default:!1}),(!l.value||!Object.keys(l.value).length)&&(t.is_default=!0),m.value=!0}function o(){try{if(d.value=!0,!t.name)throw"请输入凭证名称";if(l.value[t.name])throw"凭证名称已存在";if(!t.appid)throw"请输入APP ID";if(!t.app_secret)throw"请输入APP Secret";j({name:"feishu_bitable",data:JSON.stringify({...l.value,[t.name]:t})}).then(u=>{g("change"),m.value=!1,U.success("已保存")}).finally(()=>{d.value=!1})}catch(u){d.value=!1,U.error(u)}}return S({show:v}),(u,s)=>{const k=E,h=L,c=J,e=F,n=B;return b(),N(n,{open:m.value,"onUpdate:open":s[3]||(s[3]=r=>m.value=r),"confirm-loading":d.value,title:"API Key授权配置",width:"620px",onOk:o},{default:_(()=>[p(k,{type:"info","show-icon":"",message:"配置凭据后，工作流可直接调用此插件"}),p(e,{class:"mt16",model:t,"label-col":{span:4},"wrapper-col":{span:20}},{default:_(()=>[p(c,{label:"凭证名称",name:"name",rules:[{required:!0,message:"请输入凭证名称!"}]},{default:_(()=>[p(h,{value:t.name,"onUpdate:value":s[0]||(s[0]=r=>t.name=r),valueModifiers:{trim:!0},maxlength:16,placeholder:"请输入凭证名称"},null,8,["value"]),s[4]||(s[4]=q("div",{class:"tip-desc"},"仅用于区分多个授权配置的名称，不用于接口调用",-1))]),_:1}),p(c,{label:"APP ID",name:"appid",rules:[{required:!0,message:"请输入APP ID!"}]},{default:_(()=>[p(h,{value:t.appid,"onUpdate:value":s[1]||(s[1]=r=>t.appid=r),valueModifiers:{trim:!0},placeholder:"请输入APP ID"},null,8,["value"])]),_:1}),p(c,{label:"APP Secret",name:"app_secret",rules:[{required:!0,message:"请输入APP Secret!"}]},{default:_(()=>[p(h,{value:t.app_secret,"onUpdate:value":s[2]||(s[2]=r=>t.app_secret=r),valueModifiers:{trim:!0},placeholder:"请输入APP Secret"},null,8,["value"]),s[5]||(s[5]=q("div",{class:"tip-desc"},"如何获取APP ID和APP Secret",-1))]),_:1})]),_:1},8,["model"])]),_:1},8,["open","confirm-loading"])}}},ne=C(G,[["__scopeId","data-v-0c7a191f"]]),H={style:{display:"flex","align-items":"center",gap:"8px"}},R=["href"],W={key:0,class:"tip-desc"},X={key:1,class:"tip-desc"},Y={__name:"plugin-config-modal",emits:["change"],setup(I,{expose:S,emit:x}){const g=x,l=i({}),m=i(""),d=i({}),t=i(!1),v=i(!1),o=V({}),u=i([]);function s(e){return String(e||"").replace(/`/g,"").trim()}function k(e){const n=[];Object.keys(e||{}).forEach(f=>{const y=e[f]||{};if(y&&y.use_plugin_config===!0){const w=y.params||{};Object.keys(w).forEach(P=>{const a=w[P]||{};a.plugin_config_component===!0&&n.push({key:P,name:a.name,desc:a.desc,tip:a.tip,required:!!a.required,placeholder:a.placeholder,click_title:s(a.click_title),click_url:s(a.click_url)})})}});const r=new Set;u.value=n.filter(f=>r.has(f.key)?!1:(r.add(f.key),!0)).sort((f,y)=>{var w,P;return+(((w=e==null?void 0:e[f.key])==null?void 0:w.sort_num)||0)-+(((P=e==null?void 0:e[y.key])==null?void 0:P.sort_num)||0)})}function h(e={},n="",r={}){l.value=e,m.value=n,d.value=r,Object.keys(o).forEach(f=>delete o[f]),Object.assign(o,{name:"",is_default:!1}),(!l.value||!Object.keys(l.value).length)&&(o.is_default=!0),k(d.value),u.value.forEach(f=>{o[f.key]=""}),t.value=!0}function c(){try{if(v.value=!0,!o.name)throw"请输入凭证名称";if(l.value[o.name])throw"凭证名称已存在";u.value.forEach(e=>{const n=String(o[e.key]||"").trim();if(e.required&&!n)throw`请输入${e.name||e.key}`}),j({name:m.value,data:JSON.stringify({...l.value,[o.name]:o})}).then(()=>{g("change"),t.value=!1,U.success("已保存")}).finally(()=>{v.value=!1})}catch(e){v.value=!1,U.error(String(e||"配置保存失败"))}}return S({show:h}),(e,n)=>{const r=E,f=L,y=J,w=F,P=B;return b(),N(P,{open:t.value,"onUpdate:open":n[1]||(n[1]=a=>t.value=a),"confirm-loading":v.value,title:"API Key授权配置",width:"620px",onOk:c},{default:_(()=>[p(r,{type:"info","show-icon":"",message:"配置凭据后，工作流可直接调用此插件"}),p(w,{class:"mt16",model:o,"label-col":{span:4},"wrapper-col":{span:20}},{default:_(()=>[p(y,{label:"凭证名称",name:"name",rules:[{required:!0,message:"请输入凭证名称!"}]},{default:_(()=>[p(f,{value:o.name,"onUpdate:value":n[0]||(n[0]=a=>o.name=a),valueModifiers:{trim:!0},maxlength:16,placeholder:"请输入凭证名称"},null,8,["value"]),n[2]||(n[2]=q("div",{class:"tip-desc"},"仅用于区分多个授权配置的名称，不用于接口调用",-1))]),_:1}),(b(!0),A($,null,Q(u.value,a=>(b(),N(y,{key:a.key,label:a.name||a.key,name:a.key,rules:a.required?[{required:!0,message:"请输入"+(a.name||a.key)+"!"}]:[]},{default:_(()=>[q("div",H,[p(f,{value:o[a.key],"onUpdate:value":z=>o[a.key]=z,valueModifiers:{trim:!0},placeholder:a.placeholder||""},null,8,["value","onUpdate:value","placeholder"]),a.click_url?(b(),A("a",{key:0,style:{"flex-shrink":"0"},href:a.click_url,target:"_blank",rel:"noopener noreferrer"},M(a.click_title||"获取"),9,R)):D("",!0)]),a.tip?(b(),A("div",W,M(a.tip),1)):a.desc?(b(),A("div",X,M(a.desc),1)):D("",!0)]),_:2},1032,["label","name","rules"]))),128))]),_:1},8,["model"])]),_:1},8,["open","confirm-loading"])}}},oe=C(Y,[["__scopeId","data-v-ef02342f"]]);function se(I=!0){K();const S=i({}),x=i(!1),g=i(!1),l=i(""),m=i(""),d=()=>"admin";async function t(){await v(),await o(),k()}async function v(){const c=d();return O({name:"official_article",action:"default/exec",params:JSON.stringify({business:"register",arguments:{username:c}})})}async function o(){var e;const c=d();try{const n=await O({name:"official_article",action:"default/exec",params:JSON.stringify({business:"get_login_status",arguments:{username:c}})});x.value=!!((e=n==null?void 0:n.data)!=null&&e.online),S.value=(n==null?void 0:n.data)||{}}finally{setTimeout(()=>{g.value=!1},1200)}}function u(){g.value||(g.value=!0,o())}async function s(){const c=d(),{data:e}=await O({name:"official_article",action:"default/exec",params:JSON.stringify({business:"wechat_qrcode_login",arguments:{username:c}})});l.value=(e==null?void 0:e.qrcode_base64)||""}async function k(){const c=d(),{data:e}=await O({name:"official_article",action:"default/exec",params:JSON.stringify({business:"get_login_url",arguments:{username:c}})});m.value=e==null?void 0:e.url}I&&T(t);async function h(){m.value||await k(),window.open(m.value)}return{loginInfo:S,loginStatus:x,loginUrl:m,qrcodeUrl:l,loading:g,init:t,refresh:u,goLogin:h,getLoginUrl:k,getLoginQrcode:s}}export{ne as F,oe as P,se as u};
