import{a3 as he,d as l,q as ke,b as ve,D as ge,N as y,a6 as I,X as r,j as o,U as h,u as be,S as ye,_ as W,Z as D,F as X,a1 as Se,a2 as xe,a7 as qe,O as k}from"./vue-chunks-BRsu9_To.js";import{S as we,E as Fe,a as Le,D as Ee}from"./edit-fragment-alert-BzVMGqns.js";import{b as Te,d2 as De,dt as Ce,M as C,du as ze,dv as Ne,k as Z,dw as Oe,dx as Be,E as G,dy as Ie}from"../../index-CzPebXix.js";import{S as Ae}from"./index-0UwCX3b0.js";import{B as Re,_ as Ve}from"./index-CyLUFO3Y.js";import{L as je}from"./LeftOutlined-BKUTcRtP.js";import"./empty-CzGZrENG.js";import"./model-select-BRz1sNBY.js";import"./index-BfxXXGE8.js";import"./index-6HDf6TPN.js";import"./Trigger-Bvakuge0.js";import"./ResizeObserver.es-B1PUzC5B.js";import"./index-Bxqtz4sn.js";import"./slide-CsbPJG8I.js";import"./index-Bhf8G0AA.js";import"./List-D7uk7Chm.js";import"./useMergedState-C0iIHNGF.js";import"./DownOutlined-DXKkgIsm.js";import"./CheckOutlined-Mk6nTpyE.js";import"./SearchOutlined-a_gTycfl.js";import"./FormItemContext-B2RmG14m.js";import"./move-CkiYyFmr.js";import"./index-BhUXTHsq.js";import"./index-DGkdJwWs.js";import"./index-BMSQkwth.js";import"./index-CBmR-lHY.js";import"./index-B_XKw_Lk.js";import"./UpOutlined-B_3G2J2r.js";import"./index-BgVvqN-n.js";import"./isPlainObject-OEy0Jz8l.js";import"./Col-CFxRRwN8.js";import"./responsiveObserve-DqAe0rZk.js";import"./collapseMotion-Brd6xpAT.js";import"./index-BwqnaIPU.js";import"./colors-DfoziJR7.js";import"./QuestionCircleOutlined-DTfTQPH4.js";import"./index-BFhVTGQQ.js";import"./Input-DFtZp9vk.js";import"./inputProps-jdR54afw.js";import"./Search-Cf7bcOZJ.js";import"./TextArea-DrgXbuSS.js";import"./Password-fnCqxsm2.js";import"./index-Bd3BpNCC.js";import"./index-CO6rvZOl.js";import"./index-CYUphznb.js";import"./index-7Ecr060x.js";import"./DownloadOutlined-CeWsYko2.js";import"./index-hvcgcTJ4.js";import"./useRefs-CRRjy_qY.js";import"./index-YQhVm4Ni.js";import"./index-DlQVT6K6.js";import"./shallowequal-C0xnIuy8.js";import"./dropdown-DTOAy9tU.js";import"./RightOutlined-DH_YROnp.js";import"./pick-Sm8BXOZJ.js";import"./PlusOutlined-BlmIiILr.js";import"./axios-Dq7h7Pqt.js";import"./qs-BrxkIg-9.js";import"./crypto-js-ClNpte_9.js";import"./dayjs-B6IotFah.js";const Me={key:0,class:"loading-wrap"},Je={class:"document-segmentation"},Pe={class:"breadcrumb-block"},Qe={class:"page-title"},$e={class:"page-container"},Ue={class:"page-left"},We={class:"page-right"},Xe={class:"document-fragment-preview"},Ze={class:"preview-header"},Ge={class:"fragment-number"},He={key:1,class:"loading-box"},Ke="你是一位文章分段助手，根据文章内容的语义进行合理分段，确保每个分段表述一个完整的语义，每个分段字数控制在500字左右，最大不超过1000字。请严格按照文章内容进行分段，不要对文章内容进行加工，分段完成后输出分段后的内容。",Ye={__name:"document-segmentation",setup(et){const H=De(),z=he(),N=xe(),{setInitDocumentFragmentList:A}=H,{document_id:S}=z.query,x=l(!0),q=l(1),K=l(1);let v=!1,a={id:S,separators_no:"",chunk_size:512,chunk_overlap:50,is_qa_doc:0,question_lable:"",similar_label:"",answer_lable:"",enable_extract_image:!0,ai_chunk_size:5e3,ai_chunk_model:"",ai_chunk_model_config_id:"",ai_chunk_prumpt:Ke,ai_chunk_task_id:""};const d=l(null),Y=e=>{typeof e.separators_no=="object"&&(e.separators_no=e.separators_no.join(",")),a={...a,...e},v?C.confirm({title:"提醒",icon:o(G),content:"文档片段已被编辑重新获取文档片段会丢失当前修改过的文档片段内容，确定要重新获取吗？",okText:"确定",okType:"danger",cancelText:"取消",onOk(){v=!1,E("create")},onCancel(){}}):(v=!1,E("create"))};let ee=60*10,R=0,V=null;const w=l({}),F=l(0),j=()=>{x.value||(x.value=!0),Ce({id:S}).then(async e=>{const{status:t}=e.data;if(F.value=e.data.library_type,w.value=e.data,a={...a,separators_no:e.data.separators_no||"11,12",chunk_size:+e.data.chunk_size||512,ai_chunk_size:+e.data.ai_chunk_size||5e3,chunk_overlap:+e.data.chunk_overlap||50,is_qa_doc:F.value==2?1:0,question_lable:e.data.question_lable,similar_label:e.data.similar_label,answer_lable:e.data.answer_lable,question_column:e.data.question_column,similar_column:e.data.similar_column,answer_column:e.data.answer_column,enable_extract_image:e.data.enable_extract_image=="true",qa_index_type:+e.data.qa_index_type,chunk_type:+e.data.chunk_type,semantic_chunk_size:+e.data.semantic_chunk_size||512,semantic_chunk_overlap:+e.data.semantic_chunk_overlap||50,semantic_chunk_threshold:+e.data.semantic_chunk_threshold||90,semantic_chunk_use_model:e.data.semantic_chunk_use_model||"",ai_chunk_prumpt:e.data.ai_chunk_prumpt||"",ai_chunk_model:e.data.ai_chunk_model||"",semantic_chunk_model_config_id:e.data.semantic_chunk_model_config_id>0?e.data.semantic_chunk_model_config_id:"",ai_chunk_model_config_id:e.data.ai_chunk_model_config_id>0?e.data.ai_chunk_model_config_id:"",ai_chunk_task_id:e.data.ai_chunk_task_id||""},e.data.chunk_type==0&&(a={...a,separators_no:e.data.normal_chunk_default_separators_no,chunk_size:e.data.normal_chunk_default_chunk_size,chunk_overlap:e.data.normal_chunk_default_chunk_overlap,chunk_type:+e.data.default_chunk_type,semantic_chunk_size:+e.data.semantic_chunk_default_chunk_size,semantic_chunk_overlap:+e.data.semantic_chunk_default_chunk_overlap,semantic_chunk_threshold:+e.data.semantic_chunk_default_threshold,semantic_chunk_use_model:e.data.default_use_model||"",semantic_chunk_model_config_id:e.data.default_model_config_id>0?e.data.default_model_config_id:""}),t==0){if(R++,R>ee){C.error({title:"提醒",content:"文档解析速度慢请稍后再试"});return}setTimeout(()=>{j()},1e3)}else t==4||t==2?(x.value=!1,q.value=parseInt(e.data.is_table_file),V=e.data.library_id,F.value==2?(a.question_lable||a.question_column)&&E():E()):N.replace("/library/details?id="+e.data.library_id);e.data.is_table_file==1&&te()})};ke(async()=>{await j()});const M=l([]),te=()=>{Ne({id:S}).then(e=>{let t=[];for(let n in e.data)t.push({lable:e.data[n],value:n});M.value=t})},J=l(!1),g=l(!1),O=l(""),b=l(null);let m=null;const i=l([]),L=l([]),p=l(0),ae=ve(()=>p.value<=0),E=e=>{let t={...a,semantic_chunk_model_config_id:a.semantic_chunk_model_config_id?+a.semantic_chunk_model_config_id:0,ai_chunk_model_config_id:a.ai_chunk_model_config_id?+a.ai_chunk_model_config_id:0};a.chunk_type==3&&(a.ai_chunk_task_id&&!e&&(t.ai_chunk_task_id=a.ai_chunk_task_id),e&&e==="create"&&(t.ai_chunk_preview=!0,delete t.ai_chunk_task_id));let n=ze;return e=="create"&&(n=Ie),n(t).then(s=>{var c;L.value=s.data.list||[],A(L.value),i.value=s.data.list||[],p.value=s.data.list.length||0,a.chunk_type==3&&(O.value=((c=s.data.split_params)==null?void 0:c.ai_chunk_task_id)||"",g.value=!0,d.value.reLoading=!0,b.value=null,!a.ai_chunk_task_id&&q.value!=1||e&&e==="create"?(i.value=[],p.value=0,oe()):(g.value=!1,d.value.reLoading=!1))}).finally(()=>{a.chunk_type!=3&&(d.value.reLoading=!1,d.value.saveLoading=!1)})},ne=e=>{K.value=e},ie=async()=>{var e;try{const t=await se();return t.data.err_msg?(b.value=t.data.err_msg,!0):((e=t.data.list)==null?void 0:e.length)>0?(L.value=t.data.list||[],A(L.value),i.value=t.data.list||[],p.value=t.data.list.length||0,!0):!1}catch{return b.value="请求异常，停止轮询",!0}};function le(e){return e.split("message:")[1]}const oe=()=>{const e=async()=>{if(!await ie())m=setTimeout(e,3e3);else if(g.value=!1,d.value.reLoading=!1,d.value.saveLoading=!1,m!==null&&(clearTimeout(m),m=null),J.value&&$(),b.value){let n=le(b.value);C.error({title:"分段失败提示",content:n?`模型调用失败，失败原因：${n}`:"模型调用失败"})}};e()},se=()=>Be({id:a.id,task_id:O.value}),P=l(null);let _=null;const _e=(e,t)=>{let{title:n,content:s,question:c,answer:f,images:u,similar_question_list:T}=e;_=t,P.value.open({title:n,content:s,question:c,answer:f,images:u,similar_question_list:T})},ue=({title:e,content:t,question:n,answer:s,images:c,similar_question_list:f})=>{(i.value[_].title!=e||i.value[_].content!=t||i.value[_].question!=n||i.value[_].answer!=s)&&(v=!0),i.value[_].title=e,i.value[_].content=t,i.value[_].question=n,i.value[_].answer=s,i.value[_].images=c,i.value[_].similar_question_list=f?f.split(`
`):[],i.value[_].word_total=s.length+n.length+t.length},re=e=>{C.confirm({title:"提醒",icon:o(G),content:"确定要删除这个片段吗?",okText:"确定",okType:"danger",cancelText:"取消",onOk(){v=!0,i.value.splice(e,1)},onCancel(){}})},B=l(""),ce=e=>{B.value=e},Q=l(!1),de=()=>{let e=d.value.formState;e=JSON.parse(JSON.stringify(e)),typeof e.separators_no=="object"&&(e.separators_no=e.separators_no.join(",")),a={...a,...e}},$=async()=>{if(de(),B.value)return Z.error(B.value);if(a.chunk_type==3&&!i.value.length)return J.value=!0,!1;O.value!==a.ai_chunk_task_id&&delete a.ai_chunk_task_id;let e={...a,chunk_async:!0,semantic_chunk_model_config_id:a.semantic_chunk_model_config_id?+a.semantic_chunk_model_config_id:0,ai_chunk_model_config_id:a.ai_chunk_model_config_id?+a.ai_chunk_model_config_id:0,is_table_file:q.value};delete e.id;let t={id:S,chunk_async:!0,word_total:p.value,split_params:JSON.stringify(e),list:JSON.stringify(i.value)};e.is_qa_doc==1&&(t.qa_index_type=e.qa_index_type),Q.value=!0,Oe(t).then(()=>{Z.success("保存成功");let n=1;z.query.page&&(n=z.query.page),N.replace("/library/details?id="+V+"&page="+n)}).finally(()=>{Q.value=!1}).catch(n=>{n.data&&n.data.index&&me(n.data.index)})},U=l(null),me=e=>{e=e-1;let t=U.value.querySelectorAll(".fragment-item");t.length>=e&&t[e].scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},pe=()=>{N.back()};return ge(()=>{m&&(clearTimeout(m),m=null)}),(e,t)=>{const n=Ae,s=qe("router-link"),c=Ve,f=Re;return k(),y(X,null,[x.value?(k(),y("div",Me,[o(n)])):I("",!0),r("div",Je,[r("div",Pe,[o(f,null,{default:h(()=>[o(c,null,{default:h(()=>[o(s,{to:"/library/list"},{default:h(()=>t[0]||(t[0]=[D(" 知识库管理 ")])),_:1,__:[0]})]),_:1}),o(c,null,{default:h(()=>[o(s,{to:{path:"/library/details/knowledge-document",query:{id:w.value.library_id}}},{default:h(()=>[D(W(w.value.library_name)+"知识库",1)]),_:1},8,["to"])]),_:1}),o(c,null,{default:h(()=>t[1]||(t[1]=[D("分段设置")])),_:1,__:[1]})]),_:1})]),r("div",Qe,[o(be(je),{onClick:pe}),t[2]||(t[2]=r("span",{class:"title"},"文档分段与清洗",-1))]),r("div",$e,[r("div",Ue,[o(we,{excellQaLists:M.value,libFileInfo:w.value,library_type:F.value,mode:q.value,ref_key:"segmentationSettingRef",ref:d,onChange:Y,onChangeChunkType:ne,onSave:$,onValidate:ce},null,8,["excellQaLists","libFileInfo","library_type","mode"])]),r("div",We,[r("div",Xe,[r("div",Ze,[t[3]||(t[3]=r("span",{class:"label-text"},"分段预览",-1)),r("span",Ge,"共"+W(p.value)+"个分段",1)]),ae.value&&!g.value?(k(),ye(Le,{key:0})):I("",!0),g.value?(k(),y("div",He,[o(n),t[4]||(t[4]=D("数据处理中..."))])):I("",!0),r("div",{class:"preview-box",ref_key:"previewBoxRef",ref:U},[(k(!0),y(X,null,Se(i.value,(u,T)=>(k(),y("div",{class:"fragment-item",key:u.number},[o(Ee,{number:u.number,title:u.title,content:u.content,total:u.word_total,question:u.question,answer:u.answer,images:u.images,similar_question_list:u.similar_question_list,onDelete:fe=>re(T),onEdit:fe=>_e(u,T)},null,8,["number","title","content","total","question","answer","images","similar_question_list","onDelete","onEdit"])]))),128))],512)])])]),o(Fe,{ref_key:"editFragmentAlertRef",ref:P,onOk:ue},null,512)])],64)}}},sa=Te(Ye,[["__scopeId","data-v-5d16af8b"]]);export{sa as default};
