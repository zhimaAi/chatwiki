import{f as S,r as le,o as X,w as J,Y as o,_ as t,a5 as e,k as b,a2 as E,F as q,a9 as j,u as Y,a1 as ae,G as V,a7 as y,q as ne,ad as be,n as P,ae as $,y as se,ab as Se,ag as Te,b as xe,aa as De}from"./vue-chunks-yZ4gwLzA.js";import{d as I,V as we,q as $e,Q as Le,a as Ce,ah as Me,u as Ee,v as He,a6 as Ie,B as Be,J as Ae,aP as Oe,M as Re}from"./ui-antd-BKjlZQNA.js";import{_ as re}from"./empty-DkpCLaix.js";import{b as Q,b3 as oe,d as Ue}from"../../index-CuFGOJXl.js";import{_ as qe,V as Ve}from"./voice-message-CXRMGlhP.js";import{u as ze}from"./robot-DmLnKp5K.js";import{u as je}from"./chat-BhvMGFzz.js";import{c as Ne}from"./index-BKGOL6Hb.js";import"./utils-smNh_pj2.js";import"./index-CfeGYFjs.js";import"./useEventBus-DbXWCKa0.js";import"./useIM-BI0Yoxg2.js";import"./index-yXxWAoL0.js";const Pe={class:"zm-date"},Ye={class:"date-btn"},Fe={class:"date-content"},Ge={__name:"date",props:{datekey:{type:String,default:"1"}},emits:["dateChange"],setup(A,{emit:O}){const L=A,_=S(1),v=O;let D=le([{label:"今日",value:!0,key:2,start_time:I().startOf("day"),end_time:I().endOf("day")},{label:"昨日",value:!1,key:3,start_time:I().subtract(1,"day").startOf("day"),end_time:I().startOf("day").subtract(1,"millisecond")},{label:"近7日",value:!1,key:4,start_time:I().subtract(6,"day").startOf("day"),end_time:I().endOf("day").subtract(1,"millisecond")}]);const f=S(null),a=S(null),h=S([]),i=T=>T>=I().subtract(0,"day"),C=()=>{let T=_.value,u=null;D.forEach(r=>{r.key==T&&(u=r)}),u&&(h.value=[u.start_time,u.end_time],f.value=u.start_time.unix(),a.value=u.end_time.unix()),U()},R=T=>{const u=I(T[0]).startOf("day");if(I(T[1]).endOf("day").diff(u,"days")>29)h.value[0]=T[0].startOf("day"),h.value[1]=u.add(29,"days").endOf("day"),f.value=h.value[0].unix(),a.value=h.value[1].unix(),Ce.error("最多只能选择30天");else{const p=I(T[0]).startOf("day").unix(),M=I(T[1]).endOf("day").unix();h.value=T,f.value=p,a.value=M}_.value=1,U()},U=()=>{v("dateChange",{start_time:f.value,end_time:a.value})};return X(()=>{_.value=parseInt(L.datekey),C()}),J(()=>L.datekey,(T,u)=>{_.value=parseInt(L.datekey.split("-")[0]),C()}),(T,u)=>{const r=we,p=$e,M=Le;return t(),o("div",Pe,[e("div",Ye,[b(p,{value:_.value,"onUpdate:value":u[0]||(u[0]=g=>_.value=g),onChange:C},{default:E(()=>[(t(!0),o(q,null,j(Y(D),g=>(t(),ae(r,{class:"date-btn-button",value:g.key,key:g.key},{default:E(()=>[V(y(g.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),e("div",Fe,[b(M,{value:h.value,"onUpdate:value":u[1]||(u[1]=g=>h.value=g),onChange:R,format:"YYYY-MM-DD",disabledDate:i,allowClear:!1},null,8,["value"])])])}}},Je={key:0,class:"empty-box"},Qe=["onClick"],Ke={class:"user-item-left"},We=["src"],Xe={class:"user-item-right"},Ze={class:"user-name-box"},et={class:"user-name"},tt={class:"user-timer"},st={class:"user-info"},ot={class:"user-source-box"},lt={class:"user-source-content"},at={__name:"user",props:{userList:{type:Array,default:null},channelItem:{type:Array,default:null}},emits:["userClick","userScroll","userScrollStart","userScrollEnd"],setup(A,{emit:O}){const L=S(null),_=A,v=O,D=S([]),f=S([]),a=S({}),h=r=>{a.value=r,v("userClick",r)},i={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let C=null;function R(r){C&&(clearTimeout(C),C=null),C=setTimeout(()=>{i.scrollTop-r.target.scrollTop>0&&(i.scrollDirection="up"),i.scrollTop-r.target.scrollTop<0&&(i.scrollDirection="down"),i.scrollTop=r.target.scrollTop,i.scrollHeight=r.target.scrollHeight,i.clientHeight=r.target.clientHeight,v("userScroll",{...i}),Math.abs(i.scrollTop)<=i.scrollStartDiff+100&&i.scrollDirection==="up"&&U(),Math.abs(i.scrollHeight-i.scrollTop-i.clientHeight)<=i.scrollEndDiff&&i.scrollDirection==="down"&&T()},50)}function U(){_.userList.length!=0&&v("userScrollStart",{msg:_.userList[0]})}function T(){_.userList.length!=0&&v("userScrollEnd",{msg:_.userList[_.userList.length-1]})}J(()=>_.userList,r=>{D.value=r,D.value.length>0&&D.value.length<=20&&(h(D.value[0]),a.value=D.value[0])},{immediate:!0}),J(()=>_.channelItem,r=>{f.value=r},{immediate:!0});const u=r=>{for(let p=0;p<f.value.length;p++)if(r.app_type==f.value[p].app_type&&(r.app_id||"")==f.value[p].app_id)return f.value[p].app_name};return X(()=>{D.value=_.userList,f.value=_.channelItem}),(r,p)=>{const M=ne("ftime");return t(),o("div",{class:"user-content",ref_key:"scrollUserBoxRef",ref:L,onScroll:R},[D.value.length===0?(t(),o("div",Je,[...p[0]||(p[0]=[e("img",{src:re,alt:""},null,-1),e("div",{class:"title"},"暂无结果，请重试",-1)])])):(t(!0),o(q,{key:1},j(D.value,g=>(t(),o("div",{class:be(["user-item",{active:g.openid==a.value.openid}]),onClick:s=>h(g),key:g.session_id},[e("div",Ke,[e("img",{class:"user-img",src:g.avatar,alt:""},null,8,We)]),e("div",Xe,[e("div",Ze,[e("div",et,y(g.name),1),P((t(),o("div",tt,[V(y(g.last_chat_time),1)])),[[M,"MM-DD HH:mm"]])]),e("div",st,y(g.last_chat_message),1),e("div",ot,[p[1]||(p[1]=e("div",{class:"user-source-title"},"来自：",-1)),e("div",lt,y(u(g)),1)])])],10,Qe))),128))],544)}}},nt=Q(at,[["__scopeId","data-v-cd7bf51c"]]),rt={class:"message-box"},it={class:"message-top-box"},ct={class:"message-top-title"},ut={key:0,class:"message-top-source"},dt={class:"message-list"},_t={key:0,class:"empty-box"},pt=["id"],mt={class:"itme-right"},vt={class:"message-info"},ft={class:"item-body"},gt={key:0,class:"message-content"},yt=["src"],ht={key:1,class:"message-content"},kt={class:"user-avatar-box"},bt=["src"],St=["id"],Tt={class:"itme-left"},xt=["src"],Dt={class:"itme-right"},wt={class:"message-info"},$t={key:0,class:"reply-list"},Lt={key:0,class:"reply-item reply-text"},Ct=["innerHTML"],Mt={key:1,class:"reply-item reply-image"},Et={class:"message-content"},Ht=["src"],It={key:2,class:"reply-item reply-url"},Bt={class:"url-row"},At=["href"],Ot={key:3,class:"reply-item reply-card"},Rt={class:"card-row"},Ut=["src"],qt={class:"card-title-box"},Vt={class:"card-title"},zt={key:4,class:"reply-item reply-imageText"},jt=["href"],Nt=["src"],Pt={class:"imageText-text"},Yt={class:"imageText-title"},Ft={class:"imageText-desc"},Gt={key:5,class:"reply-item reply-smartMenu"},Jt={class:"smart-menu-box"},Qt={key:0,class:"card-title"},Kt={class:"card-text"},Wt={key:0,class:"line-text"},Xt={key:1,class:"empty-line"},Zt=["innerHTML"],es={key:3,href:"javascript:;",class:"link"},ts={key:0},ss={key:1,class:"item-body"},os={key:0,class:"message-content"},ls=["innerHTML"],as={key:2,class:"message-content"},ns=["src"],rs={key:2},is={key:2,class:"loading-box"},cs={__name:"message-list",props:{messages:{type:Array,default:()=>[]},robotInfo:{type:Object,default:()=>{}},isEmpty:{type:Boolean,default:()=>!1},sessionSource:{type:String,default:()=>null},channelItem:{type:Array,default:()=>[]}},emits:["scroll","scrollStart","scrollEnd"],setup(A,{expose:O,emit:L}){const _=L,v=A,D=S(!1),f=S(null),a={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let h=null,i=!1;const C=s=>{let k;for(let m=0;m<v.channelItem.length;m++){const w=v.channelItem[m];w.app_type===s&&(k=w.app_name)}return k};function R(s){i||(h&&(clearTimeout(h),h=null),h=setTimeout(()=>{a.scrollTop-s.target.scrollTop>0&&(a.scrollDirection="up"),a.scrollTop-s.target.scrollTop<0&&(a.scrollDirection="down"),a.scrollTop=s.target.scrollTop,a.scrollHeight=s.target.scrollHeight,a.clientHeight=s.target.clientHeight,_("scroll",{...a}),Math.abs(a.scrollTop)<=a.scrollStartDiff&&a.scrollDirection==="up"&&U(),Math.abs(a.scrollHeight-a.scrollTop-a.clientHeight)<=a.scrollEndDiff&&a.scrollDirection==="down"&&T()},100))}function U(){v.messages.length!=0&&_("scrollStart",{msg:v.messages[0]})}function T(){v.messages.length!=0&&_("scrollEnd",{msg:v.messages[v.messages.length-1]})}const u=()=>{f.value&&se(()=>{i=!0,f.value.scrollTop=f.value.scrollHeight+1,setTimeout(()=>{a.scrollTop=f.value.scrollTop,i=!1},50)})};function r(s,k){se(()=>{i=!0,k||(k="top");let m=f.value,w=document.querySelector("#msg-"+s);w&&(k=="top"?m.scrollTop=w.offsetTop:m.scrollTop=w.offsetTop-m.clientHeight+w.clientHeight),setTimeout(()=>{a.scrollTop=f.value.scrollTop,i=!1},50)})}function p(){a.scrollTop=0,a.scrollDirection=""}function M(s){try{return s?Array.isArray(s)?s:typeof s=="string"?JSON.parse(s||"[]"):[]:[]}catch{return[]}}function g(s){const k=[];return(Array.isArray(s)?s:[]).forEach(m=>{const w=String((m==null?void 0:m.menu_type)||""),x=String((m==null?void 0:m.content)||"");if(w==="0")if(x==="")k.push({kind:"newline"});else if(/<a[\s\S]*?<\/a>/.test(x)){const l=/href\s*=\s*['"]\s*#\s*['"]/i.test(x)?x.replace(/href\s*=\s*['"]\s*#\s*['"]/ig,'href="javascript:;"'):x.replace(/href=/ig,'target="_blank" href=');k.push({kind:"html",html:l})}else k.push({kind:"text",text:x});else w==="1"&&k.push({kind:"keyword",text:x,serial_no:(m==null?void 0:m.serial_no)||""})}),k.slice(0,20)}return O({scrollToBottom:u,scrollToMessage:r,resetScroll:p}),(s,k)=>{const m=Me,w=Ue,x=ne("viewer");return t(),o("div",rt,[e("div",it,[e("div",ct,y(v.robotInfo.robot_name),1),A.sessionSource?(t(),o("div",ut,"("+y(C(A.sessionSource))+")",1)):$("",!0)]),e("div",{class:"message-list-wrapper",ref_key:"scrollBoxRef",ref:f,onScroll:R},[e("div",dt,[v.isEmpty||!v.messages?(t(),o("div",_t,[...k[0]||(k[0]=[e("img",{src:re,alt:""},null,-1),e("div",{class:"title"},"暂无结果，请重试",-1)])])):(t(!0),o(q,{key:1},j(v.messages,l=>(t(),o(q,{key:l.uid},[l.is_customer==1?(t(),o("div",{key:0,class:"message-item user-message",id:"msg-"+l.uid},[e("div",mt,[e("div",vt,[e("span",null,y(Y(oe)(l.create_time)),1),e("span",null,y(l.name),1)]),e("div",ft,[l.received_message_type=="image"&&l.media_id_to_oss_url?(t(),o("div",gt,[P(e("img",{class:"msg-img",src:l.media_id_to_oss_url,alt:""},null,8,yt),[[x]])])):(t(),o("div",ht,y(l.content),1))])]),e("div",kt,[e("img",{class:"user-avatar",src:l.avatar},null,8,bt)])],8,pt)):(t(),o("div",{key:1,class:"message-item robot-message",id:"msg-"+l.uid},[e("div",Tt,[b(m,{size:"small",spinning:l.loading},{default:E(()=>[e("img",{class:"robot-avatar",src:l.robot_avatar},null,8,xt)]),_:2},1032,["spinning"])]),e("div",Dt,[e("div",wt,[e("span",null,y(Y(oe)(l.create_time)),1),e("span",null,y(l.name),1)]),M(l.reply_content_list).length?(t(),o("div",$t,[(t(!0),o(q,null,j(M(l.reply_content_list),(n,K)=>{var z;return t(),o(q,{key:K},[(n.reply_type||n.type)==="text"?(t(),o("div",Lt,[e("div",{class:"message-content",innerHTML:n.description},null,8,Ct)])):(n.reply_type||n.type)==="image"?(t(),o("div",Mt,[e("div",Et,[P(e("img",{class:"msg-img",src:n.pic||n.thumb_url},null,8,Ht),[[x]])])])):(n.reply_type||n.type)==="url"?(t(),o("div",It,[e("div",Bt,[e("a",{class:"url-link",href:n.url,target:"_blank"},y(n.url),9,At)])])):(n.reply_type||n.type)==="card"?(t(),o("div",Ot,[e("div",Rt,[n.thumb_url?(t(),o("img",{key:0,src:n.thumb_url,class:"card-thumb"},null,8,Ut)):$("",!0),e("div",qt,[b(w,{class:"think-icon",name:"applet"}),e("span",Vt,y(n.title),1)])])])):(n.reply_type||n.type)==="imageText"?(t(),o("div",zt,[e("a",{class:"imageText-row",href:n.url,target:"_blank"},[n.thumb_url?(t(),o("img",{key:0,src:n.thumb_url,class:"imageText-thumb"},null,8,Nt)):$("",!0),e("div",Pt,[e("div",Yt,y(n.title),1),e("div",Ft,y(n.description),1)])],8,jt)])):(n.reply_type||n.type)==="smartMenu"?(t(),o("div",Gt,[e("div",Jt,[n.smart_menu&&n.smart_menu.menu_description?(t(),o("div",Qt,y(n.smart_menu.menu_description),1)):$("",!0),e("div",Kt,[(t(!0),o(q,null,j(g(((z=n.smart_menu)==null?void 0:z.menu_content)||[]),(H,W)=>(t(),o("div",{key:W,class:"reply-line"},[H.kind==="text"?(t(),o("span",Wt,y(H.text),1)):H.kind==="newline"?(t(),o("div",Xt)):H.kind==="html"?(t(),o("span",{key:2,innerHTML:H.html},null,8,Zt)):H.kind==="keyword"?(t(),o("a",es,[H.serial_no?(t(),o("div",ts,y(H.serial_no),1)):$("",!0),V(" "+y(H.text),1)])):$("",!0)]))),128))])])])):$("",!0)],64)}),128))])):$("",!0),l.msg_type==1&&l.content==""?$("",!0):(t(),o("div",ss,[l.msg_type==1?P((t(),o("div",os,[b(qe,{content:l.content},null,8,["content"])])),[[x]]):$("",!0),l.msg_type==2?(t(),o("div",{key:1,class:"message-content",innerHTML:l.menu_json.content},null,8,ls)):$("",!0),l.msg_type==3?(t(),o("div",as,[P(e("img",{class:"msg-img",src:l.content,alt:""},null,8,ns),[[x]])])):$("",!0)])),l.voice_content&&l.voice_content.length?(t(),o("div",rs,[b(Ve,{voice_content:l.voice_content},null,8,["voice_content"])])):$("",!0)])],8,St))],64))),128)),D.value?(t(),o("div",is,[b(m)])):$("",!0)])],544)])}}},us=Q(cs,[["__scopeId","data-v-c2df526a"]]),ds={class:"team-members-pages"},_s={class:"set-model"},ps={class:"set-model-body"},ms={class:"set-date"},vs={class:"set-date-body"},fs={class:"set-name"},gs={class:"set-reset"},ys={class:"list-box"},hs={class:"user-box"},ks={class:"records-box"},bs={__name:"session-record",setup(A){const O=S(!1),L=De(),_=Se(),v=_.query,D=ze(),{robotInfo:f}=D,a=je(),{messageList:h}=Te(a);let i=!0;const{createMsg:C,onGetChatMessage:R,getRecordList:U,getChannelList:T}=a,u=S(null),r=S([]),p=S([]),M=S(""),g=S("1"),s=le({robot_id:v.id,app_type:"all",app_id:"all",start_time:"",end_time:"",name:"",page:1,size:20}),k=S(!1),m=c=>{s.start_time=c.start_time,s.end_time=c.end_time,z()},w=()=>{s.app_type="all",s.name="",s.page=1,g.value="1-"+Math.random()},x=S(!1),l=S(!1),n=async()=>{let c=Z();l.value=!0,await Ne(c),x.value=!0,l.value=!1},K=()=>{L.push({path:"/robot/config/export-record",query:v})},z=()=>{s.page=1,ee()},H=c=>{s.app_type=c,z()},W=()=>{},ie=c=>{M.value=c.app_type,ve(c)},ce=async()=>{},ue=()=>{k.value&&(s.page++,ee())},de=async()=>{i=!1;let c=h.value[0].uid;await R()&&pe(c)},_e=()=>{u.value&&i&&u.value.scrollToBottom()},pe=c=>{u.value&&u.value.scrollToMessage(c)},me=()=>{u.value&&u.value.resetScroll()};let F=null;const ve=async c=>{i=!0;let N={robot_key:(_.query||{}).robot_key,avatar:c.avatar,name:c.name,nickname:c.name,is_background:1,openid:c.openid,rel_user_id:c.rel_user_id};me(),await C(N),F&&(clearTimeout(F),F=null),F=setTimeout(async()=>{await R()&&_e()},100)},fe=async()=>{let c={robot_id:s.robot_id};const d=await T(c);r.value=[{app_type:"all",app_name:"全部渠道"},...d.data]},Z=()=>{let c={robot_id:s.robot_id,start_time:s.start_time,end_time:s.end_time,name:s.name,page:s.page,size:s.size};return s.app_type!=="all"&&(c.app_type=s.app_type),s.app_id!=="all"&&(c.app_id=s.app_id),c},ee=async()=>{let c=Z(),d=await U(c),N=d.data.list||[];s.page==1&&(p.value=[]),p.value=[...p.value,...N],O.value=p.value.length==0,k.value=d.data.has_more};return J(()=>h.value,()=>{}),X(async()=>{fe()}),xe(()=>{}),(c,d)=>{const N=He,te=Ee,ge=Ie,G=Be,ye=Ae,he=Oe,ke=Re;return t(),o("div",ds,[b(ye,{justify:"flex-start",class:"screen-box"},{default:E(()=>[e("div",_s,[d[4]||(d[4]=e("div",{class:"label set-model-label"},"渠道：",-1)),e("div",ps,[b(te,{value:s.app_type,"onUpdate:value":d[0]||(d[0]=B=>s.app_type=B),placeholder:"全部渠道",onChange:H,style:{width:"200px"}},{default:E(()=>[(t(!0),o(q,null,j(r.value,B=>(t(),ae(N,{key:B.app_type,value:B.app_type},{default:E(()=>[e("span",null,y(B.app_name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])])]),e("div",ms,[d[5]||(d[5]=e("div",{class:"label set-date-label"},[e("span",null,"日期：")],-1)),e("div",vs,[b(Ge,{onDateChange:m,datekey:g.value},null,8,["datekey"])])]),e("div",fs,[b(ge,{value:s.name,"onUpdate:value":d[1]||(d[1]=B=>s.name=B),placeholder:"请输入用户名称搜索",style:{width:"200px"},onSearch:z},null,8,["value"])]),e("div",gs,[b(G,{onClick:w},{default:E(()=>[...d[6]||(d[6]=[V("重置",-1)])]),_:1}),b(G,{onClick:n,loading:l.value},{default:E(()=>[...d[7]||(d[7]=[V("导出",-1)])]),_:1},8,["loading"])])]),_:1}),e("div",ys,[e("div",hs,[b(nt,{channelItem:r.value,userList:p.value,onUserScrollStart:ce,onUserScrollEnd:ue,onUserClick:ie},null,8,["channelItem","userList"])]),e("div",ks,[b(us,{ref_key:"messageListRef",ref:u,isEmpty:O.value,messages:Y(h),robotInfo:Y(f),channelItem:r.value,sessionSource:M.value,onScrollStart:de,onScrollEnd:W},null,8,["isEmpty","messages","robotInfo","channelItem","sessionSource"])])]),b(ke,{open:x.value,"onUpdate:open":d[3]||(d[3]=B=>x.value=B),title:null,footer:null,width:640},{default:E(()=>[b(he,{status:"success",title:"导出任务创建成功","sub-title":"系统会在后台导出。导出数据量越大，耗时越久。您可以稍后点击导出记录查看并下载导出的文件。"},{extra:E(()=>[b(G,{style:{"margin-right":"16px"},onClick:d[2]||(d[2]=B=>x.value=!1)},{default:E(()=>[...d[8]||(d[8]=[V("知道了",-1)])]),_:1}),b(G,{onClick:K,type:"primary"},{default:E(()=>[...d[9]||(d[9]=[V("去下载",-1)])]),_:1})]),_:1})]),_:1},8,["open"])])}}},Ss=Q(bs,[["__scopeId","data-v-d90565be"]]),Ts={class:"user-model-page"},xs={class:"list-wrapper"},Ds={__name:"index",setup(A){return(O,L)=>(t(),o("div",Ts,[L[0]||(L[0]=e("div",{class:"page-title"},"会话记录",-1)),e("div",xs,[b(Ss)])]))}},qs=Q(Ds,[["__scopeId","data-v-705cfb21"]]);export{qs as default};
