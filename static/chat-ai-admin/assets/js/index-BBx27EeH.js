import{b as re,ba as Xe,d as ce,ap as Ze,aq as et}from"../../index-ZzVqUZIR.js";import{f as g,ab as Q,aa as pe,o as _e,y as tt,b as st,e as at,r as nt,Y as d,_ as c,a5 as l,k as p,ae as R,ad as ne,a1 as q,F as W,a9 as K,a7 as S,a2 as y,G as A,u as U,n as it,A as ot,m as lt}from"./vue-chunks-yZ4gwLzA.js";import{e as de}from"./index-BT8AeJHF.js";import{M as ut}from"./multi-reply-DnBpJTmN.js";import{a as ye,C as ie,D as rt,E as oe,F as ct,G as pt,x as j}from"./index-CT0SjT0W.js";import{H as he,B as me,a0 as _t,$ as dt,k as ve,a2 as le,u as yt,G as ht,J as mt,p as vt,ad as ue,x as bt,q as ft,R as kt,d as gt,a as C,M as X}from"./ui-antd-BJtyvQX6.js";import{L as wt}from"./list-empty-CgSZ-k0P.js";import"./utils-smNh_pj2.js";import"./index-BfMA38Vj.js";const xt={class:"user-model-page"},Ct={class:"breadcrumb-wrap"},Rt={class:"mp-list-block"},St=["onClick"],At=["src"],Lt={class:"mp-name"},$t={key:0},Tt={key:1},It={key:2},Dt={key:0,class:"search-block"},zt={class:"left-block"},Bt={class:"search-item"},Et={key:1,class:"list-box"},qt={key:0},Nt={key:1},Mt={key:2},Ot={key:0,style:{color:"#595959"}},Ut={key:1,style:{color:"#595959"}},Vt={key:3,style:{color:"#595959"}},Pt={key:4,style:{color:"#595959","white-space":"pre-wrap"}},Yt=["onClick"],Ft=["onClick"],Wt=["onClick"],jt={key:2,class:"reply-editor"},Gt={class:"switch-box"},Ht={class:"nav-box"},Jt={class:"reply-main"},Kt={class:"content-box"},Qt={class:"item-box"},Xt={class:"method-box"},Zt={style:{"margin-top":"8px"}},es=160,ts=8,ss=96,as={__name:"received-reply",setup(be){g([]);const $=g({}),N=Q().query,T=Q(),h=pe(),m=g(N.subscribe_rule_type||"subscribe_reply_default"),b=g([]),f=g("0"),L=g([]),u=g(""),r=g(!1),v=g(null),k=g(0);function M(){const t=v.value;if(!t){k.value=0;return}const e=t.clientWidth||0,a=es+ts,s=Math.floor((e-ss)/a);k.value=Math.max(s,0)}const G=async()=>{var t;try{const e=await de({app_type:"official_account",app_name:""}),a=Array.isArray(e==null?void 0:e.data)?e.data:[];L.value=a.filter(s=>s.account_is_verify=="true").map(s=>({id:s.id,appid:s.app_id,name:s.app_name,logo:s.app_avatar})),u.value=((t=L.value[0])==null?void 0:t.appid)||""}catch{L.value=[],u.value=""}};_e(async()=>{var t;try{const e=await ye({ability_type:"robot_subscribe_reply"}),a=e==null?void 0:e.data,s=String(((t=a==null?void 0:a.user_config)==null?void 0:t.switch_status)??"0");f.value=s}catch{f.value="0"}await G(),tt(M),window.addEventListener("resize",M),m.value==="subscribe_reply_default"&&P()}),st(()=>{window.removeEventListener("resize",M)});const H=[{title:"关注来源",dataIndex:"subscribe_source",key:"subscribe_source",width:120},{title:"回复内容",dataIndex:"reply_content",key:"reply_content",width:120},{title:"回复方式",dataIndex:"reply_num",key:"reply_num",width:120},{title:"创建时间",dataIndex:"create_time",key:"create_time",width:120},{title:"启用状态",dataIndex:"switch_status",key:"switch_status",width:120},{title:"操作",dataIndex:"action",key:"action",width:120}],fe=[{title:"时间段",dataIndex:"duration",key:"duration",width:220},{title:"回复内容",dataIndex:"reply_content",key:"reply_content",width:120},{title:"回复方式",dataIndex:"reply_num",key:"reply_num",width:120},{title:"优先级",dataIndex:"priority_num",key:"priority_num",width:120},{title:"创建时间",dataIndex:"create_time",key:"create_time",width:120},{title:"启用状态",dataIndex:"switch_status",key:"switch_status",width:120},{title:"操作",dataIndex:"action",key:"action",width:120}],ke=at(()=>m.value==="subscribe_reply_duration"?fe:H),x=nt({page:1,size:10,total:0}),ge=Ze,Z=g([]),J=g(!1),V=g(""),I=()=>{const t={rule_type:m.value,reply_type:V.value||"",appid:u.value||"",page:x.page,size:x.size};J.value=!0,ie({...t}).then(e=>{const a=(e==null?void 0:e.data)||{list:[],total:0,page:x.page,size:x.size};Z.value=(a.list||[]).map(s=>({...s,reply_content:Array.isArray(s.reply_content)?s.reply_content:[],switch_status:String(s.switch_status??"0"),duration_type:s.duration_type||"",start_duration:s.start_duration||"",end_duration:s.end_duration||"",priority_num:s.priority_num??"",subscribe_source:Array.isArray(s.subscribe_source)?s.subscribe_source:[]})),x.total=+a.total||0}).finally(()=>{J.value=!1})};I();const we=t=>{x.page=t.current,x.size=t.pageSize,I()},xe=()=>{x.page=1,I()},Ce=t=>{V.value=t,xe()},Re=()=>{x.page=1,I(),m.value==="subscribe_reply_default"&&P()};function Se(t){u.value=t.appid,r.value=!0,x.page=1,I(),m.value==="subscribe_reply_default"&&P()}async function ee(t){const e=Number(t.priority_num);if(!Number.isInteger(e)||e<0){C.error("请输入有效的优先级");return}try{await rt({id:t.id,priority_num:e,appid:u.value||""}),C.success("优先级已更新"),I()}catch{}}const Ae=()=>{h.push({path:"/explore/index/subscribe-reply/add-rule",query:{subscribe_rule_type:m.value,appid:u.value||""}})},Le=t=>{h.push({path:"/explore/index/subscribe-reply/add-rule",query:{rule_id:t.id,appid:u.value||""}})},$e=t=>{h.push({path:"/explore/index/subscribe-reply/add-rule",query:{copy_id:t.id,appid:u.value||""}})},Te=(t,e)=>{const a=e;oe({id:t.id,switch_status:a,appid:u.value||""}).then(s=>{s&&s.res==0&&(t.switch_status=a,C.success("操作成功"))})},Ie=t=>{X.confirm({title:"确认删除吗？",okText:"确认",onOk:()=>{ct({id:t.id}).then(e=>{e&&e.res==0&&(C.success("删除成功"),I())})}})};function De(t){return(t||[]).map(e=>({...e,status:"1"}))}function ze(t){const e={text:"2",image:"4",card:"3",imageText:"1",url:"5",smartMenu:"6"};return t.map(a=>e[a.type]||"").filter(Boolean)}async function P(){var t;try{const e=await ie({rule_type:"subscribe_reply_default",appid:u.value||"",page:1,size:3}),a=Array.isArray((t=e==null?void 0:e.data)==null?void 0:t.list)?e.data.list:[];b.value=a.map(o=>({id:Number(o.id||0),priority_num:Number(o.priority_num||0),switch_status:String(o.switch_status??"0"),reply_num:Number(o.reply_num||0),replyList:(Array.isArray(o.reply_content)?o.reply_content:[]).map(n=>({type:(n==null?void 0:n.type)||(n==null?void 0:n.reply_type)||"text",description:(n==null?void 0:n.description)||"",thumb_url:(n==null?void 0:n.thumb_url)||(n==null?void 0:n.pic)||"",title:(n==null?void 0:n.title)||"",url:(n==null?void 0:n.url)||"",appid:(n==null?void 0:n.appid)||"",page_path:(n==null?void 0:n.page_path)||"",smart_menu_id:(n==null?void 0:n.smart_menu_id)||"",smart_menu:(n==null?void 0:n.smart_menu)||{}}))}));const s=3-b.value.length;if(s>0){const o=b.value.length+1;for(let n=0;n<s;n++)b.value.push({id:0,priority_num:o+n,switch_status:"0",reply_num:0,replyList:[{type:"text",description:""}]})}}catch{b.value=[{id:0,priority_num:1,switch_status:"0",reply_num:0,replyList:[{type:"text",description:""}]},{id:0,priority_num:2,switch_status:"0",reply_num:0,replyList:[{type:"text",description:""}]},{id:0,priority_num:3,switch_status:"0",reply_num:0,replyList:[{type:"text",description:""}]}]}}async function Be(t){if(!u.value){C.warning("请选择公众号");return}const e=b.value[t];if(!e||!Array.isArray(e.replyList)||e.replyList.length===0){C.warning("请完善回复内容");return}const a=Array.isArray($.value[t])?$.value[t].filter(Boolean):[];for(const s of a)if(s&&s.validate&&!await s.validate())return;try{const s={appid:u.value,rule_type:"subscribe_reply_default",reply_content:JSON.stringify(De(e.replyList)),reply_type:ze(e.replyList),priority_num:Number(e.priority_num)||0,reply_num:Number(e.reply_num)||0,switch_status:Number(e.switch_status)||0,id:Number(e.id)||void 0},o=await pt(s);o&&o.res==0&&(C.success("保存成功"),P())}catch{}}function Ee(t,e){const a=String(e),s=b.value[t];if(!(s!=null&&s.id)){b.value[t].switch_status=a,C.info("请先保存当前规则");return}oe({id:s.id,switch_status:a,appid:u.value||""}).then(o=>{o&&o.res==0&&(b.value[t].switch_status=a,C.success("操作成功"))})}function qe(t){return et[t]||""}function Ne(t){if(!Array.isArray(t))return"";const e=t.map(s=>qe(s==null?void 0:s.type)).filter(s=>!!s);return[...new Set(e)].join("/")}function Me(t){const e={1:"周一",2:"周二",3:"周三",4:"周四",5:"周五",6:"周六",7:"周日"},a=String(t||"");return e[a]||a}function Y(t){const e=String(t||"");return e?/^\d{4}-\d{2}-\d{2}/.test(e)?e.slice(0,10):e:""}function Oe(t,e="YYYY-MM-DD"){return t?gt(t*1e3).format(e):""}function F(t){const e=String(t||"");return e?/^\d{2}:\d{2}/.test(e)?e.slice(0,5):e:""}function Ue(t){const e=(t==null?void 0:t.duration_type)||"",a=(t==null?void 0:t.week_duration)||"",s=(t==null?void 0:t.start_duration)||"",o=(t==null?void 0:t.end_duration)||"";if(e==="week"){const n=Array.isArray(a)?a.map(D=>String(D)):a?[String(a)]:[],B=n.length?n.map(D=>Me(D)).join("、"):"",E=`${F(s)} 至 ${F(o)}`;return B?`每星期${B}：${E}`:`每星期：${E}`}if(e==="day")return`每天：${Y(s)} 至 ${Y(o)}`;if(e==="time_range"){const n=(t==null?void 0:t.start_day)||"",B=(t==null?void 0:t.end_day)||"",E=`${Y(n)} ${F(s)}`.trim(),D=`${Y(B)} ${F(o)}`.trim();return`自定义时间：
${E} 至 ${D}`}return`${e||""}：${s||""} 至 ${o||""}`}const Ve=Object.fromEntries((Xe||[]).map(t=>[String(t.value),t.label]));function Pe(t){const e=Array.isArray(t==null?void 0:t.subscribe_source)?t.subscribe_source:[];if(!e.length)return"--";const a=e.map(s=>Ve[String(s)]||String(s)).filter(Boolean);return a.length?a.join("、"):"--"}function Ye(t){var a;const e=((a=b.value[t])==null?void 0:a.replyList)||[];e.length>=5||e.push({type:"text",description:""})}function Fe(t,e){var n;const{reply_index:a,...s}=e,o=((n=b.value[t])==null?void 0:n.replyList)||[];a>=0&&a<o.length&&(o[a]=s)}function We(t,e){var a;(((a=b.value[t])==null?void 0:a.replyList)||[]).splice(e,1)}function je(t,e,a){const s=$.value,o=Array.isArray(s[t])?s[t]:[];o[e]=a,s[t]=o}const te=()=>{T.query.id&&T.query.robot_key?h.push({path:"/robot/config/function-center",query:{id:T.query.id,robot_key:T.query.robot_key}}):h.push({path:"/explore/index"})},Ge=t=>{const e=f.value,a=t;if(a==="0"){X.confirm({title:"提示",content:"关闭后，该功能默认关闭不再支持使用，所有的公众号菜单都会停用，确认关闭？",onOk:()=>{j({ability_type:"robot_subscribe_reply",switch_status:a}).then(s=>{s&&s.res==0?(f.value=a,C.success("操作成功")):f.value=e}).catch(()=>{f.value=e})},onCancel:()=>{f.value="1"}});return}j({ability_type:"robot_subscribe_reply",switch_status:a}).then(s=>{s&&s.res==0?(f.value=a,C.success("操作成功")):f.value=e}).catch(()=>{f.value=e})};return(t,e)=>{const a=ce,s=he,o=me,n=_t,B=dt,E=ve,D=yt,se=vt,He=ht,Je=mt,Ke=bt,ae=kt,Qe=ft;return c(),d("div",xt,[l("div",Ct,[p(a,{onClick:te,name:"back",style:{"font-size":"20px"}}),l("div",{onClick:te,class:"breadcrumb-title"},"关注后回复"),p(s,{checked:f.value,"onUpdate:checked":e[0]||(e[0]=i=>f.value=i),checkedValue:"1","un-checkedValue":"0","checked-children":"开","un-checked-children":"关",onChange:Ge},null,8,["checked"]),e[4]||(e[4]=l("span",{class:"switch-tip"},"开启后，用户关注公众号后，回复指定的内容，该功能仅支持公众号内回复",-1))]),l("div",Rt,[l("div",{class:ne(["mp-list",{expanded:r.value}]),ref_key:"mpListRef",ref:v},[(c(!0),d(W,null,K(r.value?L.value:L.value.slice(0,k.value),i=>(c(),d("div",{class:ne(["mp-card",{selected:i.appid===u.value}]),key:i.id,onClick:_=>Se(i)},[l("img",{src:i.logo,class:"mp-logo"},null,8,At),l("span",Lt,S(i.name),1)],10,St))),128)),!r.value&&L.value.length>k.value?(c(),q(o,{key:0,type:"dashed",class:"more-btn",onClick:e[1]||(e[1]=i=>r.value=!0)},{default:y(()=>[A(" 更多 +"+S(L.value.length-k.value),1)]),_:1})):R("",!0)],2)]),p(B,{activeKey:m.value,"onUpdate:activeKey":e[2]||(e[2]=i=>m.value=i),onChange:Re,style:{"margin-top":"8px"}},{default:y(()=>[p(n,{key:"subscribe_reply_default",tab:"默认回复"}),p(n,{key:"subscribe_reply_duration",tab:"按时段设置"}),p(n,{key:"subscribe_reply_source",tab:"按关注来源设置"})]),_:1},8,["activeKey"]),p(E,{"show-icon":""},{message:y(()=>[m.value==="subscribe_reply_default"?(c(),d("p",$t,"关注后1分钟内只能给粉丝发送3条消息。建议关注后自动回复数量不要超过2条。可以根据关注来源或关注时间段单独设置回复")):m.value==="subscribe_reply_duration"?(c(),d("p",Tt,"优先级设置的区间为1-100的自然整数，数字越小，优先级越高。触发优先级为：按时间段回复>按关注来源回复>默认回复。")):(c(),d("p",It,"触发优先级为：按时间段回复>按关注来源回复>默认回复。"))]),_:1}),m.value!=="subscribe_reply_default"?(c(),d("div",Dt,[l("div",zt,[p(o,{type:"primary",onClick:Ae},{icon:y(()=>[p(U(le))]),default:y(()=>[A(" "+S(m.value==="subscribe_reply_duration"?"增加时段回复":"新增回复"),1)]),_:1}),l("div",Bt,[p(D,{modelValue:V.value,"onUpdate:modelValue":e[3]||(e[3]=i=>V.value=i),placeholder:"回复内容",allowClear:"",options:U(ge),style:{width:"240px"},onChange:Ce},null,8,["modelValue","options"])])])])):R("",!0),m.value!=="subscribe_reply_default"?(c(),d("div",Et,[p(Ke,{columns:ke.value,"data-source":Z.value,loading:J.value,pagination:{current:x.page,total:x.total,pageSize:x.size,showQuickJumper:!0,showSizeChanger:!0,pageSizeOptions:["10","20","50","100"]},onChange:we},{headerCell:y(({column:i})=>[i.key==="priority_num"?(c(),d("span",qt,[e[5]||(e[5]=A(" 优先级 ",-1)),p(se,{title:"优先级设置的数值不能重复，数值越小，优先级越高"},{default:y(()=>[p(U(ue))]),_:1})])):i.key==="switch_status"?(c(),d("span",Nt,[e[6]||(e[6]=A(" 启用状态 ",-1)),p(se,{title:m.value==="receive_reply_message_type"?"开启开关后，触发消息类型回复指定的内容":"开启后，按照设置的时间段回复指定的内容"},{default:y(()=>[p(U(ue))]),_:1},8,["title"])])):(c(),d("span",Mt,S(i.title),1))]),bodyCell:y(({column:i,record:_})=>[i.key==="subscribe_source"?(c(),d("span",Ot,S(Pe(_)),1)):R("",!0),i.key==="reply_content"?(c(),d("span",Ut,S(Ne(_.reply_content)||"--"),1)):R("",!0),i.key==="reply_num"?(c(),d(W,{key:2},[A(S(_.reply_num==0?"全部回复":"随机回复一条"),1)],64)):R("",!0),i.key==="create_time"?(c(),d("span",Vt,S(Oe(_.create_time)||"--"),1)):R("",!0),i.key==="duration"?(c(),d("span",Pt,S(Ue(_)),1)):R("",!0),i.key==="priority_num"?(c(),q(He,{key:5,value:_.priority_num,"onUpdate:value":w=>_.priority_num=w,min:1,max:100,precision:0,style:{width:"96px"},onBlur:w=>ee(_),onPressEnter:w=>ee(_)},null,8,["value","onUpdate:value","onBlur","onPressEnter"])):R("",!0),i.key==="switch_status"?(c(),q(s,{key:6,checked:_.switch_status,checkedValue:"1","un-checkedValue":"0","checked-children":"开","un-checked-children":"关",onChange:w=>Te(_,w)},null,8,["checked","onChange"])):R("",!0),i.key==="action"?(c(),q(Je,{key:7,gap:8},{default:y(()=>[l("a",{onClick:w=>Le(_)},"编辑",8,Yt),l("a",{onClick:w=>Ie(_)},"删除",8,Ft),l("a",{onClick:w=>$e(_)},"复制",8,Wt)]),_:2},1024)):R("",!0)]),_:1},8,["columns","data-source","loading","pagination"])])):R("",!0),m.value==="subscribe_reply_default"?(c(),d("div",jt,[(c(!0),d(W,null,K(b.value,(i,_)=>(c(),d("div",{class:"reply-editor-item",key:i.id},[l("div",Gt,[l("div",Ht,"关注后自动回复（优先级："+S(i.priority_num)+"）",1),p(s,{checked:i.switch_status,checkedValue:"1","un-checkedValue":"0","checked-children":"开","un-checked-children":"关",onChange:w=>Ee(_,w)},null,8,["checked","onChange"])]),p(lt,{name:"collapse"},{default:y(()=>[it(l("div",Jt,[l("div",Kt,[e[7]||(e[7]=l("div",{class:"nav-box"},"回复内容：",-1)),l("div",Qt,[(c(!0),d(W,null,K(i.replyList,(w,O)=>(c(),q(ut,{key:O,ref_for:!0,ref:z=>je(_,O,z),value:i.replyList[O],"onUpdate:value":z=>i.replyList[O]=z,reply_index:O,onChange:z=>Fe(_,z),onDel:z=>We(_,z)},null,8,["value","onUpdate:value","reply_index","onChange","onDel"]))),128)),p(o,{type:"dashed",style:{width:"694px"},disabled:i.replyList.length>=5,onClick:()=>Ye(_)},{icon:y(()=>[p(U(le))]),default:y(()=>[A(" 添加回复内容("+S(i.replyList.length)+"/5) ",1)]),_:2},1032,["disabled","onClick"])])]),l("div",Xt,[e[10]||(e[10]=l("div",{class:"nav-box"},"回复方式：",-1)),p(Qe,{value:i.reply_num,"onUpdate:value":w=>i.reply_num=w},{default:y(()=>[p(ae,{value:0},{default:y(()=>[...e[8]||(e[8]=[A("全部回复",-1)])]),_:1}),p(ae,{value:1},{default:y(()=>[...e[9]||(e[9]=[A("随机回复一条",-1)])]),_:1})]),_:1},8,["value","onUpdate:value"])]),l("div",Zt,[p(o,{type:"primary",onClick:w=>Be(_)},{default:y(()=>[...e[11]||(e[11]=[A("保存",-1)])]),_:1},8,["onClick"])])],512),[[ot,i.switch_status==="1"]])]),_:2},1024)]))),128))])):R("",!0)])}}},ns=re(as,[["__scopeId","data-v-6d2327d6"]]),is={class:"auto-reply-home"},os={key:1,class:"user-model-page"},ls={class:"breadcrumb-wrap"},us={class:"empty-wrap"},rs={class:"empty-actions"},cs={__name:"index",setup(be){const $=Q(),N=pe(),T=g(!0),h=g("0"),m=async()=>{try{const u=await de({app_type:"official_account",app_name:""}),r=Array.isArray(u==null?void 0:u.data)?u.data.filter(v=>v.account_is_verify=="true"):[];T.value=r.length>0}catch{T.value=!1}};_e(async()=>{var u;try{const r=await ye({ability_type:"robot_subscribe_reply"}),v=r==null?void 0:r.data,k=String(((u=v==null?void 0:v.user_config)==null?void 0:u.switch_status)??"0");h.value=k}catch{h.value="0"}m()});const b=()=>{const u=N.resolve({path:"/user/official-account"});window.open(u.href,"_blank")},f=()=>{$.query.id&&$.query.robot_key?N.push({path:"/robot/config/function-center",query:{id:$.query.id,robot_key:$.query.robot_key}}):N.push({path:"/explore/index"})},L=u=>{const r=h.value,v=u;if(v==="0"){X.confirm({title:"提示",content:"关闭后，该功能默认关闭不再支持使用，所有的公众号菜单都会停用，确认关闭？",onOk:()=>{j({ability_type:"robot_subscribe_reply",switch_status:v}).then(k=>{k&&k.res==0?(h.value=v,C.success("操作成功")):h.value=r}).catch(()=>{h.value=r})},onCancel:()=>{h.value="1"}});return}j({ability_type:"robot_subscribe_reply",switch_status:v}).then(k=>{k&&k.res==0?(h.value=v,C.success("操作成功")):h.value=r}).catch(()=>{h.value=r})};return(u,r)=>{const v=ce,k=he,M=ve,G=me;return c(),d("div",is,[T.value?(c(),q(ns,{key:0})):(c(),d("div",os,[l("div",ls,[p(v,{onClick:f,name:"back",style:{"font-size":"20px"}}),l("div",{onClick:f,class:"breadcrumb-title"},"关注后回复"),p(k,{checked:h.value,"onUpdate:checked":r[0]||(r[0]=H=>h.value=H),checkedValue:"1","un-checkedValue":"0","checked-children":"开","un-checked-children":"关",onChange:L},null,8,["checked"]),r[1]||(r[1]=l("span",{class:"switch-tip"},"开启后，用户关注公众号后，回复指定的内容，该功能仅支持公众号内回复",-1))]),p(M,{"show-icon":""},{message:y(()=>[...r[2]||(r[2]=[A(" 开启后，用户关注公众号后，回复指定的内容，",-1),l("span",{style:{color:"#FF4D4F"}},"该功能仅支持公众号内回复",-1)])]),_:1}),l("div",us,[p(wt,{size:"180"},{default:y(()=>[...r[3]||(r[3]=[l("div",{class:"empty-default"},"暂未绑定公众号",-1),l("div",{class:"empty-sub"},"请选到系统设置>公众号管理绑定公众号",-1)])]),_:1}),l("div",rs,[p(G,{type:"primary",onClick:b},{default:y(()=>[...r[4]||(r[4]=[A("去绑定公众号",-1)])]),_:1})])])]))])}}},ks=re(cs,[["__scopeId","data-v-c829dcef"]]);export{ks as default};
