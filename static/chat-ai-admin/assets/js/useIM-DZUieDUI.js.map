{"version":3,"file":"useIM-DZUieDUI.js","sources":["../../../../front-end/chat-ai-admin-vue/src/utils/http/websocket/reconnectableSocket.js","../../../../front-end/chat-ai-admin-vue/src/hooks/event/useIM.js"],"sourcesContent":["export default class Socket {\r\n  constructor(url, options) {\r\n    this.debug = options.debug || false\r\n    this.socketOpen = false\r\n    this.socketMsgQueue = []\r\n    this.heartbeatInterval = 5 * 1000\r\n    this.heartbeatTimer = null\r\n    this.disableHeartbeat = options.disableHeartbeat\r\n    // 禁止重连，手动关闭socket（退出登录）等场景不需要在重连了\r\n    this.disableReconnect = false\r\n    this.reconnectAttempts = 0\r\n    this.reconnectInterval = 5 * 1000\r\n    this.reconnectTimer = null\r\n    this.events = {}\r\n\r\n    this.url = url\r\n    this.ws = null\r\n\r\n    this.options = options\r\n\r\n    this.connect()\r\n\r\n    this.log = function () {}\r\n\r\n    if (this.debug) {\r\n      this.log = console.log\r\n    }\r\n  }\r\n\r\n  connect() {\r\n    if (this.ws && this.socketOpen) {\r\n      // console.log('Socket is already connected');\r\n      return\r\n    }\r\n\r\n    this.ws = new WebSocket(this.url)\r\n\r\n    this.ws.onopen = () => {\r\n      this.log('WebSocket open')\r\n      this.onOpen()\r\n    }\r\n\r\n    this.ws.onmessage = (event) => {\r\n      this.log('WebSocket message')\r\n      this.log(event)\r\n      this.onMessage(event)\r\n    }\r\n\r\n    this.ws.onerror = (error) => {\r\n      this.log('WebSocket error')\r\n      this.log(error)\r\n      this.onError(error)\r\n    }\r\n\r\n    this.ws.onclose = (event) => {\r\n      this.log('WebSocket closed')\r\n      this.log(event)\r\n      this.onClose(event)\r\n    }\r\n  }\r\n\r\n  onOpen() {\r\n    this.socketOpen = true\r\n    this.reconnectAttempts = 0 // 重连成功重置重连次数\r\n    this.disableReconnect = false // 恢复断线重连功能\r\n\r\n    // 清除重连定时器\r\n    if (this.reconnectTimer) {\r\n      clearTimeout(this.reconnectTimer)\r\n      this.reconnectTimer = null\r\n    }\r\n\r\n    this.sendHeartBeat() // 发送心跳包\r\n\r\n    // 离线消息重发\r\n    for (var i = 0; i < this.socketMsgQueue.length; i++) {\r\n      this.send(this.socketMsgQueue[i])\r\n    }\r\n\r\n    this.socketMsgQueue = []\r\n\r\n    this.emit('open')\r\n  }\r\n\r\n  onMessage(event) {\r\n    // 可以在这里添加接收到消息后的逻辑\r\n    if (event && event.data === 'ping') {\r\n      this.pong(event)\r\n    } else {\r\n      this.emit('message', JSON.parse(event.data))\r\n    }\r\n  }\r\n\r\n  onError(error) {\r\n    // 可以在这里添加错误处理逻辑\r\n    this.emit('error', error)\r\n  }\r\n\r\n  onClose(event) {\r\n    // 可以在这里添加断开连接后的逻辑，例如重新连接等\r\n    this.emit('close', event)\r\n\r\n    this.ws = null\r\n    this.socketOpen = false\r\n\r\n    // 清除重连定时器\r\n    if (this.reconnectTimer) {\r\n      clearTimeout(this.reconnectTimer)\r\n      this.reconnectTimer = null\r\n    }\r\n\r\n    // 停止心跳包\r\n    this.stopHeartBeat()\r\n\r\n    // 判断是否需要重连\r\n    if (this.shouldReconnect() && !this.disableReconnect) {\r\n      this.reconnect()\r\n    }\r\n  }\r\n\r\n  send(message) {\r\n    if (this.ws && this.socketOpen) {\r\n      this.ws.send(JSON.stringify(message))\r\n    } else {\r\n      this.socketMsgQueue.push(message)\r\n    }\r\n  }\r\n  pong() {\r\n    this.ws.send('pong')\r\n  }\r\n  sendHeartBeat() {\r\n    if (this.disableHeartbeat) {\r\n      return\r\n    }\r\n    clearTimeout(this.heartbeatTimer) // 清除之前的心跳超时定时器\r\n    // 每5秒发送一次心跳包\r\n    this.heartbeatTimer = setTimeout(() => {\r\n      this.send({\r\n        type: 'ping'\r\n      })\r\n\r\n      // 继续发送心跳包\r\n      this.sendHeartBeat()\r\n      this.emit('ping')\r\n    }, this.heartbeatInterval)\r\n  }\r\n\r\n  stopHeartBeat() {\r\n    if (this.disableHeartbeat) {\r\n      return\r\n    }\r\n    clearTimeout(this.heartbeatTimer) // 清除心跳超时定时器\r\n  }\r\n\r\n  // 是否需要重连\r\n  shouldReconnect() {\r\n    const maxReconnectAttempts = this.options.maxReconnectAttempts || Infinity\r\n    return this.reconnectAttempts < maxReconnectAttempts\r\n  }\r\n\r\n  reconnect() {\r\n    if (this.reconnectTimer) {\r\n      return\r\n    }\r\n\r\n    this.disableReconnect = false\r\n    this.reconnectAttempts++\r\n\r\n    // 每5秒尝试连接一次\r\n    this.reconnectTimer = setTimeout(() => {\r\n      if (this.ws) {\r\n        this.ws.close()\r\n        this.socketOpen = false\r\n        this.ws = null\r\n      } else {\r\n        this.connect()\r\n      }\r\n    }, this.reconnectInterval)\r\n  }\r\n\r\n  close(disableReconnect = true) {\r\n    this.disableReconnect = disableReconnect\r\n\r\n    if (this.reconnectTimer) {\r\n      clearTimeout(this.reconnectTimer)\r\n    }\r\n\r\n    if (this.ws) {\r\n      this.ws.close()\r\n    }\r\n  }\r\n\r\n  // 事件发射器\r\n  emit(event, ...args) {\r\n    if (this.events && Array.isArray(this.events[event])) {\r\n      this.events[event].forEach((listener) => listener(...args))\r\n    }\r\n  }\r\n\r\n  // 添加事件监听器\r\n  on(event, listener) {\r\n    if (!this.events) {\r\n      this.events = {}\r\n    }\r\n    // 如果 events[event] 不存在或者不是数组，则初始化为数组\r\n    if (!this.events[event]) {\r\n      this.events[event] = []\r\n    }\r\n    // 添加监听器到数组\r\n    this.events[event].push(listener)\r\n  }\r\n\r\n  // 移除事件监听器\r\n  off(event, listener) {\r\n    if (this.events && Array.isArray(this.events[event])) {\r\n      // 如果没有指定 listener，则移除所有监听器\r\n      if (!listener) {\r\n        this.events[event] = []\r\n      } else {\r\n        // 否则，移除指定的监听器\r\n        const index = this.events[event].indexOf(listener)\r\n        if (index !== -1) {\r\n          this.events[event].splice(index, 1)\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { getWsUrl } from '@/api/app/index'\r\nimport { ref, reactive } from 'vue'\r\nimport reconnectableSocket from '../../utils/http/websocket/reconnectableSocket'\r\n\r\nconst wsUrl = ref(null)\r\nconst ws = ref(null)\r\nconst events = reactive({})\r\n\r\nexport const useIM = () => {\r\n  async function connect(openid, cb) {\r\n    let res = await getWsUrl({ openid: openid })\r\n\r\n    if (res) {\r\n      wsUrl.value = res.data.ws_url\r\n    }\r\n\r\n    if (ws.value) {\r\n      ws.value.close()\r\n    }\r\n\r\n    ws.value = new reconnectableSocket(wsUrl.value, {\r\n      disableHeartbeat: true\r\n    })\r\n\r\n    cb && cb()\r\n\r\n    ws.value.on('message', (data) => {\r\n      emit('message', data)\r\n    })\r\n\r\n    ws.value.on('error', onError)\r\n  }\r\n\r\n  function on(event, listener) {\r\n    if (!events[event]) {\r\n      events[event] = []\r\n    }\r\n\r\n    events[event].push(listener)\r\n  }\r\n\r\n  function emit(event, ...args) {\r\n    if (events && Array.isArray(events[event])) {\r\n      events[event].forEach((listener) => listener(...args))\r\n    }\r\n  }\r\n\r\n  function onError(err) {\r\n    console.log(err)\r\n  }\r\n\r\n  function close() {\r\n    Object.keys(events).forEach((event) => {\r\n      events[event] = []\r\n\r\n      delete events[event]\r\n    })\r\n\r\n    ws.value && ws.value.close()\r\n  }\r\n\r\n  return {\r\n    connect,\r\n    on: on,\r\n    close\r\n  }\r\n}\r\n"],"names":["Socket","url","options","event","error","i","message","maxReconnectAttempts","disableReconnect","args","listener","index","wsUrl","ref","ws","events","reactive","useIM","connect","openid","cb","res","getWsUrl","reconnectableSocket","data","emit","onError","on","err","close"],"mappings":"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"}