import{e as J,ab as ce,aa as pe,f as $,r as de,Y as r,_ as o,a5 as l,k as s,a2 as _,G as C,u as K,ae as b,a1 as U,F as B,a9 as F,n as Q,a7 as S,A as W}from"./vue-chunks-Ci-XTWEs.js";import{h as qe,i as Ee,j as Ke,s as he,k as Ve,l as Le,m as Me,n as Oe,o as Pe}from"./index-DzgHDarz.js";import{b as re,an as ke,ao as me}from"../../index-BZRrEp3V.js";import{u as ge}from"./robot-ChheCicf.js";import{X as we,k as ve,z as fe,B as be,u as Se,a4 as Ye,ab as ue,p as Re,ao as Be,a8 as Ue,E as Ce,y as $e,a as I,M as xe,Z as Ae,Y as Ie,O as Ne,d as je}from"./ui-antd-BWf8LxGy.js";import"./utils-ChQO-_r6.js";import"./index-BOvAmdHY.js";const Fe={class:"user-model-page"},Qe={class:"switch-block"},We={class:"search-block"},Je={class:"left-block"},Ge={class:"search-item"},Xe={class:"search-item"},Ze={class:"right-block"},He={class:"list-box"},et={key:0,class:"tags-wra flex"},tt={class:"popover-cont flex"},at={key:0,class:"more-tag"},nt={key:1,class:"tags-wra flex"},st={class:"popover-cont flex"},ot={key:0,class:"more-tag"},it={key:2,style:{color:"#595959"}},lt=["onClick"],_t=["onClick"],ut=["onClick"],ct={__name:"keywords-reply",setup(ye){const x=ge(),V=J(()=>x.keywordReplySwitchStatus==="1"),m=J(()=>x.keywordReplyAiReplyStatus==="1"),p=ce().query,w=pe(),P=$([{title:"规则名",dataIndex:"name",key:"name",width:120},{title:"模糊匹配",dataIndex:"half_keyword",key:"half_keyword",width:220},{title:"精准匹配",dataIndex:"full_keyword",key:"full_keyword",width:220},{title:"回复内容",dataIndex:"reply_content",key:"reply_content",width:120},{title:"启用状态",dataIndex:"switch_status",key:"switch_status",width:120},{title:"操作",dataIndex:"action",key:"action",width:120}]),v=de({page:1,size:10,total:0}),G=ke,f=$([]),Y=$(!1),T=$(""),z=$(""),A=()=>{z.value,T.value;const i={robot_id:p.id,keyword:z.value||"",reply_type:T.value||"",page:v.page,size:v.size};Y.value=!0,qe({...i}).then(a=>{const h=(a==null?void 0:a.data)||{list:[],total:0,page:v.page,size:v.size};f.value=(h.list||[]).map(c=>({...c,full_keyword:Array.isArray(c.full_keyword)?c.full_keyword:[],half_keyword:Array.isArray(c.half_keyword)?c.half_keyword:[],reply_content:Array.isArray(c.reply_content)?c.reply_content:[],switch_status:String(c.switch_status??"0")})),v.total=+h.total||0}).finally(()=>{Y.value=!1})};A();const D=i=>{v.page=i.current,v.size=i.pageSize,A()},N=()=>{v.page=1,A()},X=i=>{T.value=i,N()},Z=()=>{w.push({path:"/robot/ability/auto-reply/add-rule",query:{id:p.id,robot_key:p.robot_key}})},H=i=>{w.push({path:"/robot/ability/auto-reply/add-rule",query:{id:p.id,robot_key:p.robot_key,rule_id:i.id}})},j=i=>{w.push({path:"/robot/ability/auto-reply/add-rule",query:{id:p.id,robot_key:p.robot_key,copy_id:i.id}})},ee=i=>{const a=i?"1":"0";he({robot_id:p.id,ability_type:"robot_auto_reply",switch_status:a}).then(h=>{h&&h.res==0&&(x.setKeywordReplySwitchStatus(a),I.success("操作成功"),window.dispatchEvent(new CustomEvent("robotAbilityUpdated",{detail:{robotId:p.id}})))})},te=(i,a)=>{const h=a;Ee({id:i.id,robot_id:p.id,switch_status:h}).then(c=>{c&&c.res==0&&(i.switch_status=h,I.success("操作成功"))})},ae=i=>{const a=i?"1":"0";Ve({robot_id:p.id,ability_type:"robot_auto_reply",ai_reply_status:a}).then(h=>{h&&h.res==0&&(x.setKeywordReplyAiReplyStatus(a),I.success("操作成功"))})},ne=i=>{xe.confirm({title:"确认删除吗？",okText:"确认",onOk:()=>{Ke({id:i.id,robot_id:p.id}).then(a=>{a&&a.res==0&&(I.success("删除成功"),A())})}})};function se(i){return me[i]||""}function oe(i){if(!Array.isArray(i))return"";const a=i.map(c=>se(c==null?void 0:c.type)).filter(c=>!!c);return[...new Set(a)].join("/")}return(i,a)=>{const h=we,c=ve,ie=be,L=Se,le=Ye,_e=Re,M=Be,e=Ue,t=Ce,u=$e;return o(),r("div",Fe,[l("div",Qe,[a[2]||(a[2]=l("span",{class:"switch-title"},"自动回复",-1)),s(h,{onChange:ee,checked:V.value,"checked-children":"开","un-checked-children":"关"},null,8,["checked"]),a[3]||(a[3]=l("span",{class:"switch-desc"},"开启后，按照关键词回复和收到消息回复规则，回复指定的内容，优先级关键词回复>收到消息回复",-1))]),s(c,{"show-icon":""},{message:_(()=>a[4]||(a[4]=[l("p",null,"关键词回复内容支持设置图文链接，文字，图片，链接，小程序卡片",-1)])),_:1}),l("div",We,[l("div",Je,[s(ie,{type:"primary",onClick:Z},{icon:_(()=>[s(K(fe))]),default:_(()=>[a[5]||(a[5]=C(" 新增规则 "))]),_:1,__:[5]}),l("div",Ge,[s(L,{modelValue:T.value,"onUpdate:modelValue":a[0]||(a[0]=n=>T.value=n),placeholder:"回复类型",allowClear:"",options:K(G),style:{width:"240px"},onChange:X},null,8,["modelValue","options"])]),l("div",Xe,[s(le,{value:z.value,"onUpdate:value":a[1]||(a[1]=n=>z.value=n),placeholder:"关键词/规则名称搜索",allowClear:"",style:{width:"240px"},onSearch:N},null,8,["value"])])]),l("div",Ze,[a[8]||(a[8]=l("span",null,"触发后继续回复",-1)),s(_e,null,{title:_(()=>a[6]||(a[6]=[C("开关开启后，关键词回复后，继续触发收到消息自动回复，最后触发机器人回复")])),default:_(()=>[s(K(ue)),a[7]||(a[7]=C("： "))]),_:1,__:[7]}),s(h,{onChange:ae,checked:m.value,"checked-children":"开","un-checked-children":"关"},null,8,["checked"])])]),l("div",He,[s(u,{columns:P.value,"data-source":f.value,loading:Y.value,pagination:{current:v.page,total:v.total,pageSize:v.size,showQuickJumper:!0,showSizeChanger:!0,pageSizeOptions:["10","20","50","100"]},onChange:D},{bodyCell:_(({column:n,record:y})=>[n.key==="half_keyword"?(o(),r("div",et,[(o(!0),r(B,null,F(y.half_keyword,(d,k)=>Q((o(),r("div",{class:"tag",key:k},[s(M,null,{default:_(()=>[C(S(d),1)]),_:2},1024)])),[[W,k<3]])),128)),s(e,null,{content:_(()=>[l("div",tt,[(o(!0),r(B,null,F(y.half_keyword,(d,k)=>Q((o(),r("div",{class:"tag",key:k},[s(M,null,{default:_(()=>[C(S(d),1)]),_:2},1024)])),[[W,k>=3]])),128))])]),default:_(()=>[y.half_keyword.length>3?(o(),r("div",at,"+"+S(y.half_keyword.length-3),1)):b("",!0)]),_:2},1024)])):b("",!0),n.key==="full_keyword"?(o(),r("div",nt,[(o(!0),r(B,null,F(y.full_keyword,(d,k)=>Q((o(),r("div",{class:"tag",key:k},[s(M,null,{default:_(()=>[C(S(d),1)]),_:2},1024)])),[[W,k<3]])),128)),s(e,null,{content:_(()=>[l("div",st,[(o(!0),r(B,null,F(y.full_keyword,(d,k)=>Q((o(),r("div",{class:"tag",key:k},[s(M,null,{default:_(()=>[C(S(d),1)]),_:2},1024)])),[[W,k>=3]])),128))])]),default:_(()=>[y.full_keyword.length>3?(o(),r("div",ot,"+"+S(y.full_keyword.length-3),1)):b("",!0)]),_:2},1024)])):b("",!0),n.key==="reply_content"?(o(),r("span",it,S(oe(y.reply_content)||"--"),1)):b("",!0),n.key==="switch_status"?(o(),U(h,{key:3,checked:y.switch_status,checkedValue:"1","un-checkedValue":"0","checked-children":"开","un-checked-children":"关",onChange:d=>te(y,d)},null,8,["checked","onChange"])):b("",!0),n.key==="action"?(o(),U(t,{key:4,gap:8},{default:_(()=>[l("a",{onClick:d=>H(y)},"编辑",8,lt),l("a",{onClick:d=>ne(y)},"删除",8,_t),l("a",{onClick:d=>j(y)},"复制",8,ut)]),_:2},1024)):b("",!0)]),_:1},8,["columns","data-source","loading","pagination"])])])}}},rt=re(ct,[["__scopeId","data-v-dd0086a6"]]),yt={class:"user-model-page"},pt={class:"switch-block"},dt={class:"switch-desc"},ht={class:"search-block"},kt={class:"left-block"},mt={class:"search-item"},gt={class:"list-box"},wt={key:0},vt={key:1},ft={key:2},bt={key:0,style:{color:"#595959"}},St={key:1,style:{color:"#595959"}},Rt={key:3,style:{color:"#595959"}},Ct={key:4,style:{color:"#595959","white-space":"pre-wrap"}},$t=["onClick"],xt=["onClick"],At=["onClick"],It={__name:"received-reply",setup(ye){const x=ge(),V=J(()=>x.keywordReplySwitchStatus==="1"),m=ce().query,p=pe(),w=$(m.rule_type||"receive_reply_message_type"),P=[{title:"消息类型",dataIndex:"message_type",key:"message_type",width:120},{title:"回复内容",dataIndex:"reply_content",key:"reply_content",width:120},{title:"回复方式",dataIndex:"reply_num",key:"reply_num",width:120},{title:"创建时间",dataIndex:"create_time",key:"create_time",width:120},{title:"启用状态",dataIndex:"switch_status",key:"switch_status",width:120},{title:"操作",dataIndex:"action",key:"action",width:120}],v=[{title:"时间段",dataIndex:"duration",key:"duration",width:220},{title:"回复内容",dataIndex:"reply_content",key:"reply_content",width:120},{title:"回复方式",dataIndex:"reply_num",key:"reply_num",width:120},{title:"优先级",dataIndex:"priority_num",key:"priority_num",width:120},{title:"创建时间",dataIndex:"create_time",key:"create_time",width:120},{title:"启用状态",dataIndex:"switch_status",key:"switch_status",width:120},{title:"操作",dataIndex:"action",key:"action",width:120}],G=J(()=>w.value==="receive_reply_duration"?v:P),f=de({page:1,size:10,total:0}),Y=ke,T=$([]),z=$(!1),A=$(""),D=()=>{const e={robot_id:m.id,rule_type:w.value,reply_type:A.value||"",page:f.page,size:f.size};z.value=!0,Le({...e}).then(t=>{const u=(t==null?void 0:t.data)||{list:[],total:0,page:f.page,size:f.size};T.value=(u.list||[]).map(n=>({...n,reply_content:Array.isArray(n.reply_content)?n.reply_content:[],switch_status:String(n.switch_status??"0"),duration_type:n.duration_type||"",start_duration:n.start_duration||"",end_duration:n.end_duration||"",priority_num:n.priority_num??"",message_type:String(n.message_type??""),specify_message_type:Array.isArray(n.specify_message_type)?n.specify_message_type:[]})),f.total=+u.total||0}).finally(()=>{z.value=!1})};D();const N=e=>{f.page=e.current,f.size=e.pageSize,D()},X=()=>{f.page=1,D()},Z=e=>{A.value=e,X()},H=()=>{f.page=1,D()};async function j(e){const t=Number(e.priority_num);if(!Number.isInteger(t)||t<0){I.error("请输入有效的优先级");return}try{await Me({id:e.id,robot_id:m.id,priority_num:t}),I.success("优先级已更新"),D()}catch{}}const ee=()=>{p.push({path:"/robot/ability/auto-reply/add-reply",query:{id:m.id,robot_key:m.robot_key,rule_type:w.value}})},te=e=>{p.push({path:"/robot/ability/auto-reply/add-reply",query:{id:m.id,robot_key:m.robot_key,rule_id:e.id}})},ae=e=>{p.push({path:"/robot/ability/auto-reply/add-reply",query:{id:m.id,robot_key:m.robot_key,copy_id:e.id}})},ne=e=>{const t=e?"1":"0";he({robot_id:m.id,ability_type:"robot_auto_reply",switch_status:t}).then(u=>{u&&u.res==0&&(x.setKeywordReplySwitchStatus(t),I.success("操作成功"),window.dispatchEvent(new CustomEvent("robotAbilityUpdated",{detail:{robotId:m.id}})))})},se=(e,t)=>{const u=t;Oe({id:e.id,robot_id:m.id,switch_status:u}).then(n=>{n&&n.res==0&&(e.switch_status=u,I.success("操作成功"))})},oe=e=>{xe.confirm({title:"确认删除吗？",okText:"确认",onOk:()=>{Pe({id:e.id,robot_id:m.id}).then(t=>{t&&t.res==0&&(I.success("删除成功"),D())})}})};function i(e){return me[e]||""}function a(e){if(!Array.isArray(e))return"";const t=e.map(n=>i(n==null?void 0:n.type)).filter(n=>!!n);return[...new Set(t)].join("/")}function h(e){const t={1:"周一",2:"周二",3:"周三",4:"周四",5:"周五",6:"周六",7:"周日"},u=String(e||"");return t[u]||u}function c(e){const t=String(e||"");return t?/^\d{4}-\d{2}-\d{2}/.test(t)?t.slice(0,10):t:""}function ie(e,t="YYYY-MM-DD"){return e?je(e*1e3).format(t):""}function L(e){const t=String(e||"");return t?/^\d{2}:\d{2}/.test(t)?t.slice(0,5):t:""}function le(e){const t=(e==null?void 0:e.duration_type)||"",u=(e==null?void 0:e.week_duration)||"",n=(e==null?void 0:e.start_duration)||"",y=(e==null?void 0:e.end_duration)||"";if(t==="week"){const d=Array.isArray(u)?u.map(q=>String(q)):u?[String(u)]:[],k=d.length?d.map(q=>h(q)).join("、"):"",O=`${L(n)} 至 ${L(y)}`;return k?`每星期${k}：${O}`:`每星期：${O}`}if(t==="day")return`每天：${c(n)} 至 ${c(y)}`;if(t==="time_range"){const d=(e==null?void 0:e.start_day)||"",k=(e==null?void 0:e.end_day)||"",O=`${c(d)} ${L(n)}`.trim(),q=`${c(k)} ${L(y)}`.trim();return`自定义时间：
${O} 至 ${q}`}return`${t||""}：${n||""} 至 ${y||""}`}function _e(e){return{text:"文本",image:"图片",voice:"音频",video:"视频"}[String(e)]||String(e)}function M(e){if(String((e==null?void 0:e.message_type)??"")==="0")return"全部消息";const u=Array.isArray(e==null?void 0:e.specify_message_type)?e.specify_message_type:[];return u.length?u.map(_e).join("/"):"--"}return(e,t)=>{const u=we,n=ve,y=Ae,d=Ie,k=be,O=Se,q=Re,Te=Ne,ze=Ce,De=$e;return o(),r("div",yt,[l("div",pt,[s(u,{onChange:ne,checked:V.value,"checked-children":"开","un-checked-children":"关"},null,8,["checked"]),l("span",dt,S(w.value==="receive_reply_message_type"?"开启后，如果消息触发了关键词回复，直接回复设置的内容，无需机器人检索回复":"开启后，发送指定消息类型的内容自动回复对应的消息内容无需机器人检索回复"),1)]),s(n,{"show-icon":""},{message:_(()=>t[2]||(t[2]=[l("p",null,"发送指定消息类型的内容自动回复对应的消息内容，相同的消息类型只会有一条生效的规则，优先级按时间设置>默认回复",-1),l("p",null,"数字越小，则优先级越高。优先级仅在时间相互冲突时有效，比如一个每天1-9点与一个每天3-10点，当8点钟触发时，则只会触发其中优先级最高的一个，满足时间段后，在时间间隔内不会再触发其他的规则",-1)])),_:1}),s(d,{activeKey:w.value,"onUpdate:activeKey":t[0]||(t[0]=g=>w.value=g),onChange:H,style:{"margin-top":"8px"}},{default:_(()=>[s(y,{key:"receive_reply_message_type",tab:"默认回复"}),s(y,{key:"receive_reply_duration",tab:"按时段设置"})]),_:1},8,["activeKey"]),l("div",ht,[l("div",kt,[s(k,{type:"primary",onClick:ee},{icon:_(()=>[s(K(fe))]),default:_(()=>[C(" "+S(w.value==="receive_reply_message_type"?"新增回复":"增加时段回复"),1)]),_:1}),l("div",mt,[s(O,{modelValue:A.value,"onUpdate:modelValue":t[1]||(t[1]=g=>A.value=g),placeholder:"回复内容",allowClear:"",options:K(Y),style:{width:"240px"},onChange:Z},null,8,["modelValue","options"])])])]),l("div",gt,[s(De,{columns:G.value,"data-source":T.value,loading:z.value,pagination:{current:f.page,total:f.total,pageSize:f.size,showQuickJumper:!0,showSizeChanger:!0,pageSizeOptions:["10","20","50","100"]},onChange:N},{headerCell:_(({column:g})=>[g.key==="priority_num"?(o(),r("span",wt,[t[3]||(t[3]=C(" 优先级 ")),s(q,{title:"优先级设置的数值不能重复，数值越小，优先级越高"},{default:_(()=>[s(K(ue))]),_:1})])):g.key==="switch_status"?(o(),r("span",vt,[t[4]||(t[4]=C(" 启用状态 ")),s(q,{title:w.value==="receive_reply_message_type"?"开启开关后，触发消息类型回复指定的内容":"开启后，按照设置的时间段回复指定的内容"},{default:_(()=>[s(K(ue))]),_:1},8,["title"])])):(o(),r("span",ft,S(g.title),1))]),bodyCell:_(({column:g,record:R})=>[g.key==="message_type"?(o(),r("span",bt,S(M(R)),1)):b("",!0),g.key==="reply_content"?(o(),r("span",St,S(a(R.reply_content)||"--"),1)):b("",!0),g.key==="reply_num"?(o(),r(B,{key:2},[C(S(R.reply_num==0?"全部回复":"随机回复一条"),1)],64)):b("",!0),g.key==="create_time"?(o(),r("span",Rt,S(ie(R.create_time)||"--"),1)):b("",!0),g.key==="duration"?(o(),r("span",Ct,S(le(R)),1)):b("",!0),g.key==="priority_num"?(o(),U(Te,{key:5,value:R.priority_num,"onUpdate:value":E=>R.priority_num=E,min:1,max:100,precision:0,style:{width:"96px"},onBlur:E=>j(R),onPressEnter:E=>j(R)},null,8,["value","onUpdate:value","onBlur","onPressEnter"])):b("",!0),g.key==="switch_status"?(o(),U(u,{key:6,checked:R.switch_status,checkedValue:"1","un-checkedValue":"0","checked-children":"开","un-checked-children":"关",onChange:E=>se(R,E)},null,8,["checked","onChange"])):b("",!0),g.key==="action"?(o(),U(ze,{key:7,gap:8},{default:_(()=>[l("a",{onClick:E=>te(R)},"编辑",8,$t),l("a",{onClick:E=>oe(R)},"删除",8,xt),l("a",{onClick:E=>ae(R)},"复制",8,At)]),_:2},1024)):b("",!0)]),_:1},8,["columns","data-source","loading","pagination"])])])}}},Tt=re(It,[["__scopeId","data-v-b912c13b"]]),zt={class:"auto-reply-home"},Dt={__name:"index",setup(ye){const x=ce(),V=$(x.query.active_key||"keywords");return(m,p)=>{const w=Ae,P=Ie;return o(),r("div",zt,[s(P,{activeKey:V.value,"onUpdate:activeKey":p[0]||(p[0]=v=>V.value=v)},{default:_(()=>[s(w,{key:"keywords",tab:"关键词回复"},{default:_(()=>[s(rt)]),_:1}),s(w,{key:"received",tab:"收到消息回复"},{default:_(()=>[s(Tt)]),_:1})]),_:1},8,["activeKey"])])}}},Pt=re(Dt,[["__scopeId","data-v-a63ffd6c"]]);export{Pt as default};
