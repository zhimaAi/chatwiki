import{a6 as ee,ab as oe,b9 as ae,bd as ie,be as ne,d as me,u as V,_ as Q}from"../../index-DSFcP5NQ.js";import{ab as fe,c as ye,a as o,b as t,y as I,p as a,n as ge,C as ce,_ as W,v as d,aj as X,r as k,w as te,j as se,i as G,J as re,e as U,u as p,q as M,F as P,l as A,h as J,V as de,t as F,z as _e,$ as ue,a1 as le,ag as be,E as ke}from"./vue-chunks-BdaA73Wf.js";import{u as he}from"./useEventBus--I0IFnMo.js";import{g as Le}from"./index-Cg7-0swo.js";import{u as we}from"./useIM-DZUieDUI.js";import{B as K,M as xe,S as Ce,P as Se}from"./pull-up.esm-DIiTC7VE.js";import{O as Te}from"./observe-dom.esm-B25JyVKH.js";import{_ as z}from"./emoji-mart-BBMRoEa3.js";import{ag as Me,at as $e,_ as Re,D as De,P as Oe,v as Ie,u as Ne,I as Be}from"./ui-antd-Dl1wwwCD.js";import{_ as qe,V as Pe}from"./voice-message-B7-hRuYw.js";import{M as Ae}from"./multiple-message-B1FsoFt9.js";import{i as Ye}from"./index-BuDcjXHQ.js";import{u as je}from"./useMathJax-6Oa0Io1D.js";import{d as q}from"./utils-CvB22N-W.js";import"./neo4j-MWxXN7EM.js";import"./editor-cherry-CFIsbKoN.js";import"./lodash-Bm5sK6rN.js";import"./elkjs-BN8GIjVH.js";import"./other-LrIFyvU9.js";import"./index-B_UHbFfL.js";const ze=(r={})=>ee.get({url:"/manage/getReceiverList",params:r}),He=(r={})=>ee.post({url:"/chat/message",data:r}),Fe=(r={})=>ee.post({url:"/manage/setReceiverRead",data:r}),Z=fe("chatMonitor",{state:()=>({im:null,selectedRobotId:"",robotList:[],selectedReceiverId:"",receiverList:[],receiverListPage:{page:0,size:10},activeChat:null,chatMessagePageSize:10,messageList:[],messageListScrollTop:0,chatMessageLoadCompleted:!1,messageListLoading:!1}),getters:{},actions:{async init(){this.selectedRobotId="",this.selectedReceiverId="",this.robotList=[],this.receiverList=[],this.messageList=[],this.receiverListPage={page:0,size:10},this.messageListScrollTop=0,this.chatMessageLoadCompleted=!1,this.messageListLoading=!1,this.activeChat=null,await this.getRobotList(),await this.getReceiverList(),this.receiverList.length>0&&await this.switchChat(this.receiverList[0]),this.initIM()},closeIM(){this.im&&this.im.close()},initIM(){const r=we(),c=me();this.im=r,r.connect(c.user_id),r.on("message",e=>{!e.data||e.msg_type!=="receiver_notify"||((e.change=="create"||e.change=="update")&&this.onAddReceiver(e),e.change=="delete"&&this.onDeleteReceiver(e),(e.change=="c_message"||e.change=="ai_message")&&this.onAddMessage(e))})},onAddMessage(r){if(!this.activeChat)return;const c=he();let e=r.data;if(this.activeChat.session_id==e.session_id){if(e.displayName=e.name||e.nickname,e.dispayTime=ae(e.create_time),e.uid=oe(32),e.loading=!1,e.menu_json&&typeof e.menu_json=="string"&&(e.menu_json=JSON.parse(e.menu_json)),e.quote_file&&typeof e.quote_file=="string"&&(e.quote_file=JSON.parse(e.quote_file)),e.reply_content_list&&typeof e.reply_content_list=="string")try{e.reply_content_list=JSON.parse(e.reply_content_list)}catch{e.reply_content_list=[]}e.voice_content=ie(e.content),e.content=ne(e.content),this.messageList.push(e),c.emit("onAddMessage",e)}},onAddReceiver(r){let c=r.data;c.displayName=c.name||c.nickname,c.come_from=JSON.parse(c.come_from);let e=this.receiverList.findIndex(l=>l.session_id==c.session_id);e!==-1?this.receiverList.splice(e,1,c):(this.selectedRobotId==""||this.selectedRobotId==c.robot_id)&&this.receiverList.unshift(c)},onDeleteReceiver(r){let c=r.data,e=this.receiverList.findIndex(l=>l.id==c);e!=-1&&(this.activeChat&&this.activeChat.id==c&&(this.activeChat=null),this.receiverList.splice(e,1))},async getRobotList(r){try{const c=await Le(r);return this.robotList=c.data||[],c}catch(c){throw console.error("Failed to get robot list:",c),c}},async getReceiverList(r){r!=null&&r.page?this.receiverListPage.page=r.page:this.receiverListPage.page++;const c={...this.receiverListPage,robot_id:this.selectedRobotId,...r};try{const e=await ze(c);let l=e.data.list||[];for(let s=0;s<l.length;s++)if(l[s].displayName=l[s].name||l[s].nickname,l[s].come_from)try{l[s].come_from=JSON.parse(l[s].come_from)}catch(_){console.error("Failed to parse come_from:",_)}return this.receiverListPage.page===1?this.receiverList=l:this.receiverList=this.receiverList.concat(l),e}catch(e){throw console.error("Failed to get receiver list:",e),this.receiverListPage.page>1&&this.receiverListPage.page--,e}},changeRobot(r){this.activeChat=null,this.resetReceiverList(r)},resetReceiverList(r){return this.receiverListPage.page=0,this.receiverList=[],this.getReceiverList(r)},async getChatMessage(){if(this.messageListLoading)return;this.messageListLoading=!0;let r=0,c=this.messageList.filter(l=>!l.isWelcome);c.length>0&&(r=c[0].id);let e={robot_key:this.activeChat.robot_key,openid:this.activeChat.openid,min_id:r,size:this.chatMessagePageSize,rel_user_id:this.activeChat.rel_user_id};return He(e).then(l=>{var g,x;this.messageListLoading=!1;let s=l.data.list||[];const _=((g=l==null?void 0:l.data)==null?void 0:g.customer)||{},f=((x=l==null?void 0:l.data)==null?void 0:x.robot)||{};s.sort((n,L)=>n.id-L.id);for(let n=0;n<s.length;n++){if(s[n].displayName=s[n].name||s[n].nickname,s[n].is_customer==1?(s[n].displayName=s[n].displayName||_.name,s[n].avatar=s[n].avatar||_.avatar):(s[n].displayName=s[n].displayName||f.robot_name,s[n].avatar=s[n].avatar||f.robot_avatar),s[n].uid=oe(32),s[n].menu_json&&typeof s[n].menu_json=="string"&&(s[n].menu_json=JSON.parse(s[n].menu_json)),s[n].quote_file&&typeof s[n].quote_file=="string"&&(s[n].quote_file=JSON.parse(s[n].quote_file)),s[n].reply_content_list&&typeof s[n].reply_content_list=="string")try{s[n].reply_content_list=JSON.parse(s[n].reply_content_list)}catch{s[n].reply_content_list=[]}s[n].dispayTime=ae(s[n].create_time),s[n].voice_content=ie(s[n].content),s[n].content=ne(s[n].content)}return this.messageList=[...s,...this.messageList],s.length<this.chatMessagePageSize&&(this.chatMessageLoadCompleted=!0),l}).catch(l=>{this.messageListLoading=!1})},claerUnread(){return Fe({id:this.selectedReceiverId})},async switchChat(r){this.chatMessageLoadCompleted=!1,this.messageListLoading=!1,this.messageList=[],this.messageListScrollTop=0,this.selectedReceiverId=r.id,this.activeChat=r,this.claerUnread(),await this.getChatMessage()}}}),Ue={class:"no-data"},Je={class:"no-data-text"},Ve={__name:"list-empty",props:{text:{type:String,default:""},size:{type:[Number,String],default:100}},setup(r){const{t:c}=V("views.chat-monitor.components.list-empty"),e=r,l=ye(()=>e.text||c("no_data"));return(s,_)=>{const f=Q;return t(),o("div",Ue,[I(f,{name:"empty",style:ge({"font-size":`${e.size}px`})},null,8,["style"]),a("div",Je,[ce(s.$slots,"default",{},()=>[W(d(l.value),1)],!0)])])}}},pe=z(Ve,[["__scopeId","data-v-9ff0bbfe"]]),Ee={key:1,class:"chat-list"},We=["onClick"],Ke={class:"avatar"},Ge=["src","alt"],Qe={class:"chat-info"},Xe={class:"nickname"},Ze={class:"last-message"},et={class:"webapp-source"},tt={key:0,class:"loading-wrapper"},st={class:"loading-text"},ot={key:1,class:"finished-text"},at={__name:"chat-list ",emits:["switchChat"],setup(r,{expose:c,emit:e}){K.use(xe),K.use(Ce),K.use(Te),K.use(Se);const l=e,{t:s}=V("views.chat-monitor.components.chat-list"),_=Z(),{getReceiverList:f}=_,{receiverList:g,selectedReceiverId:x}=X(_),n=k(null);let L=null;const $=k(!1),S=k(!1),m=k({}),u=()=>{L=new K(n.value,{scrollY:!0,click:!0,observeDOM:!0,mouseWheel:!0,bounce:!1,scrollbar:{fade:!0,interactive:!0},pullUpLoad:!0}),L.on("pullingUp",()=>{C(m.value)})},C=async(y={})=>{if(y.page===1&&(S.value=!1),$.value||S.value){L.finishPullUp();return}$.value=!0,y&&Object.keys(y).length>0&&(m.value={...y});try{(await f(y)).data.list.length===0&&!y.keyword&&(S.value=!0)}catch(B){console.error(s("load_more_failed"),B)}finally{$.value=!1,L.finishPullUp()}},v=y=>{l("switchChat",y)};return te(g,y=>{y.length>0&&G(()=>{L&&L.refresh()})}),se(()=>{G(()=>{u()})}),re(()=>{L&&L.destroy()}),c({getData:C}),(y,B)=>{const Y=Me;return t(),o("div",{class:"scroll-wrapper",ref_key:"scrollRef",ref:n},[p(g).length==0?(t(),U(pe,{key:0,size:"140",text:p(s)("no_bot_sessions")},null,8,["text"])):(t(),o("div",Ee,[(t(!0),o(P,null,A(p(g),D=>(t(),o("div",{key:D.id,class:J(["chat-item",{active:D.id===p(x)}]),onClick:b=>v(D)},[a("div",Ke,[a("img",{src:D.avatar,alt:D.displayName},null,8,Ge),D.unread>0?(t(),o("span",{key:0,class:J(["dot",{plus:D.unread>9}])},d(D.unread),3)):M("",!0)]),a("div",Qe,[a("div",Xe,d(D.displayName),1),a("div",Ze,d(D.last_chat_message),1),a("div",et,d(p(s)("from_prefix"))+d(D.come_from.app_name),1)])],10,We))),128)),$.value?(t(),o("div",tt,[I(Y,{size:"small"}),a("span",st,d(p(s)("loading")),1)])):M("",!0),S.value?(t(),o("div",ot,d(p(s)("no_more")),1)):M("",!0)]))],512)}}},it=z(at,[["__scopeId","data-v-d3b06dbd"]]),nt={__name:"chat-message-scroll",props:{topTriggerDistance:{type:Number,default:10},bottomTriggerDistance:{type:Number,default:40},isLoading:{type:Boolean,default:!1},scrollTop:{type:Number,default:0}},emits:["scroll-top","scroll-bottom","scroll"],setup(r,{expose:c,emit:e}){const l=r,s=e,_=k(null),f=k({scrollTop:0,scrollHeight:0,clientHeight:0,scrollDirection:"down",scrollStartDiff:l.topTriggerDistance,scrollEndDiff:l.bottomTriggerDistance}),g=k(null),x=u=>{const{scrollTop:C}=u,v=f.value.scrollTop-C;f.value.scrollDirection=v>0?"up":"down",Object.assign(f.value,{scrollTop:C,scrollHeight:u.scrollHeight,clientHeight:u.clientHeight})},n=()=>{const{scrollTop:u,scrollHeight:C,clientHeight:v,scrollStartDiff:y,scrollEndDiff:B,scrollDirection:Y}=f.value;s("scroll",{...f.value}),l.isLoading||(Math.abs(u)<=y&&Y==="up"&&s("scroll-top",{...f.value}),Math.abs(C-u-v)<=B&&Y==="down"&&s("scroll-bottom",{...f.value}))},L=u=>{x(u.target),g.value&&(clearTimeout(g.value),g.value=null),g.value=setTimeout(()=>{n()},100)};function $(){_.value&&(_.value.scrollTop=0)}function S(){_.value&&(_.value.scrollTop=_.value.scrollHeight)}function m(){return _.value&&Object.assign(f.value,{scrollTop:_.value.scrollTop,scrollHeight:_.value.scrollHeight,clientHeight:_.value.clientHeight}),JSON.parse(JSON.stringify(f.value))}return te(()=>l.scrollTop,u=>{_.value&&(_.value.scrollTop=u)}),c({scrollToTop:$,scrollToBottom:S,getState:m}),(u,C)=>(t(),o("div",{class:"chat-message-scroll",ref_key:"scrollContainer",ref:_,onScroll:L},[ce(u.$slots,"default",{},void 0,!0)],544))}},lt=z(nt,[["__scopeId","data-v-23d37ca8"]]),ct={class:"chat-message-warpper"},rt={class:"chat-message-content"},dt={key:0,class:"is-loaded"},_t={class:"avatar"},ut=["src","alt"],ht={class:"message-content"},pt={class:"message-info"},vt={class:"nickname"},mt={class:"time"},ft={key:0,class:"reply-list"},yt={key:0,class:"reply-item reply-text"},gt=["innerHTML"],bt={key:1,class:"reply-item reply-image"},kt={class:"message-content"},Lt=["src"],wt={key:2,class:"reply-item reply-url"},xt={class:"url-row"},Ct=["href"],St={key:3,class:"reply-item reply-card"},Tt={class:"card-row"},Mt=["src"],$t={class:"card-title-box"},Rt={class:"card-title"},Dt={key:4,class:"reply-item reply-imageText"},Ot=["href"],It=["src"],Nt={class:"imageText-text"},Bt={class:"imageText-title"},qt={class:"imageText-desc"},Pt={key:5,class:"reply-item reply-smartMenu"},At={class:"smart-menu-box"},Yt={key:0,class:"card-title"},jt={class:"card-text"},zt={key:0,class:"line-text"},Ht={key:1,class:"empty-line"},Ft=["innerHTML"],Ut={key:3,href:"javascript:;",class:"link"},Jt={key:0},Vt={key:1,class:"message-bubble"},Et={key:0,class:"text-content"},Wt={key:1},Kt={key:1,class:"image-content"},Gt=["src"],Qt={key:2,class:"image-content"},Xt=["src"],Zt={key:3,class:"menu-content"},es={class:"menus-label"},ts={key:0,class:"menu-items"},ss=["onClick"],os={key:4,class:"multiple-content"},as={key:5,class:"answer-reference-box"},is={class:"answer-reference-label"},ns=["onClick"],ls={key:2},cs={__name:"chat-message",emits:["openLibrary"],setup(r,{expose:c,emit:e}){const{t:l}=V("views.chat-monitor.components.chat-message"),s=e,_=k(null),f=Z(),{getChatMessage:g}=f,{messageList:x,messageListScrollTop:n,messageListLoading:L,chatMessageLoadCompleted:$,activeChat:S}=X(f),m=()=>{};function u(R,w,O){let T=le(R);w.robot_key=S.value.robot_key,w.robot_id=S.value.robot_id,T.forEach(i=>{i.message_id=O.id,i.openid=O.openid,i.robot_key=S.value.robot_key,i.robot_id=S.value.robot_id}),s("openLibrary",T,le(w))}function C(R){const w=[];return(Array.isArray(R)?R:[]).forEach(O=>{const T=String((O==null?void 0:O.menu_type)||""),i=String((O==null?void 0:O.content)||"");if(T==="0")if(i==="")w.push({kind:"newline"});else if(/<a[\s\S]*?<\/a>/.test(i)){const j=/href\s*=\s*['"]\s*#\s*['"]/i.test(i)?i.replace(/href\s*=\s*['"]\s*#\s*['"]/ig,'href="javascript:;"'):i.replace(/href=/ig,'target="_blank" href=');w.push({kind:"html",html:j})}else w.push({kind:"text",text:i});else T==="1"&&w.push({kind:"keyword",text:i,serial_no:(O==null?void 0:O.serial_no)||""})}),w.slice(0,20)}const v=R=>{const{scrollTop:w}=R;n.value=w},y=async()=>{if($.value)return;let R=_.value.getState();await g(),G(()=>{let w=_.value.getState();w.scrollDirection=="up"&&(n.value=w.scrollHeight-R.scrollHeight)})},B=async()=>{},Y=()=>{_.value.scrollToBottom()},D=()=>{_.value.scrollToTop()};function b(R){try{return R?Array.isArray(R)?R:typeof R=="string"?JSON.parse(R||"[]"):[]:[]}catch{return[]}}return c({scrollToTop:D,scrollToBottom:Y}),(R,w)=>{const O=Q,T=de("viewer");return t(),o("div",ct,[I(lt,{ref_key:"scrollViewRef",ref:_,scrollTop:p(n),"onUpdate:scrollTop":w[0]||(w[0]=i=>ue(n)?n.value=i:null),"is-loading":p(L),onScroll:v,onScrollTop:y,onScrollBottom:B},{default:F(()=>[a("div",rt,[p($)?(t(),o("div",dt,d(p(l)("no_more_messages")),1)):M("",!0),(t(!0),o(P,null,A(p(x),(i,j)=>(t(),o("div",{key:j,class:J(["message-item",i.is_customer==0?"right":""])},[a("div",_t,[a("img",{src:i.avatar,alt:i.displayName},null,8,ut)]),a("div",ht,[a("div",pt,[a("span",vt,d(i.displayName),1),w[1]||(w[1]=a("i",{class:"gap"},null,-1)),a("span",mt,d(i.dispayTime),1)]),b(i.reply_content_list).length?(t(),o("div",ft,[(t(!0),o(P,null,A(b(i.reply_content_list),(h,H)=>{var E;return t(),o(P,{key:H},[(h.reply_type||h.type)==="text"?(t(),o("div",yt,[a("div",{class:"message-content",innerHTML:h.description},null,8,gt)])):(h.reply_type||h.type)==="image"?(t(),o("div",bt,[a("div",kt,[_e(a("img",{class:"msg-img",src:h.pic||h.thumb_url},null,8,Lt),[[T]])])])):(h.reply_type||h.type)==="url"?(t(),o("div",wt,[a("div",xt,[a("a",{class:"url-link",href:h.url,target:"_blank"},d(h.url),9,Ct)])])):(h.reply_type||h.type)==="card"?(t(),o("div",St,[a("div",Tt,[h.thumb_url?(t(),o("img",{key:0,src:h.thumb_url,class:"card-thumb"},null,8,Mt)):M("",!0),a("div",$t,[I(O,{class:"think-icon",name:"applet"}),a("span",Rt,d(h.title),1)])])])):(h.reply_type||h.type)==="imageText"?(t(),o("div",Dt,[a("a",{class:"imageText-row",href:h.url,target:"_blank"},[h.thumb_url?(t(),o("img",{key:0,src:h.thumb_url,class:"imageText-thumb"},null,8,It)):M("",!0),a("div",Nt,[a("div",Bt,d(h.title),1),a("div",qt,d(h.description),1)])],8,Ot)])):(h.reply_type||h.type)==="smartMenu"?(t(),o("div",Pt,[a("div",At,[h.smart_menu&&h.smart_menu.menu_description?(t(),o("div",Yt,d(h.smart_menu.menu_description),1)):M("",!0),a("div",jt,[(t(!0),o(P,null,A(C(((E=h.smart_menu)==null?void 0:E.menu_content)||[]),(N,ve)=>(t(),o("div",{key:ve,class:"reply-line"},[N.kind==="text"?(t(),o("span",zt,d(N.text),1)):N.kind==="newline"?(t(),o("div",Ht)):N.kind==="html"?(t(),o("span",{key:2,innerHTML:N.html},null,8,Ft)):N.kind==="keyword"?(t(),o("a",Ut,[N.serial_no?(t(),o("div",Jt,d(N.serial_no),1)):M("",!0),W(" "+d(N.text),1)])):M("",!0)]))),128))])])])):M("",!0)],64)}),128))])):M("",!0),i.msg_type==1&&i.content==""?M("",!0):(t(),o("div",Vt,[i.msg_type==1?(t(),o("div",Et,[i.is_customer==0?(t(),U(qe,{key:0,style:{"text-align":"left"},content:i.content},null,8,["content"])):(t(),o("div",Wt,d(i.content),1))])):i.received_message_type=="image"&&i.media_id_to_oss_url?(t(),o("div",Kt,[a("img",{src:i.media_id_to_oss_url,alt:"image"},null,8,Gt)])):i.msg_type==3?(t(),o("div",Qt,[a("img",{src:i.content,alt:"image"},null,8,Xt)])):i.msg_type==2?(t(),o("div",Zt,[a("div",es,d(i.menu_json.content),1),i.menu_json.question&&i.menu_json.question.length>0?(t(),o("div",ts,[(t(!0),o(P,null,A(i.menu_json.question,(h,H)=>(t(),o("div",{key:H,class:"menu-item",onClick:E=>m(h)},d(h),9,ss))),128))])):M("",!0)])):i.msg_type==99?(t(),o("div",os,[I(Ae,{message:i.content},null,8,["message"])])):M("",!0),i.quote_file&&i.quote_file.length?(t(),o("div",as,[a("div",is,d(p(l)("answer_reference")),1),a("div",null,[(t(!0),o(P,null,A(i.quote_file,(h,H)=>(t(),o("div",{class:"list-item",key:H},[I(O,{name:"attachment"}),a("span",{onClick:E=>u(i.quote_file,h,i)},d(h.file_name),9,ns)]))),128))])])):M("",!0)])),i.voice_content&&i.voice_content.length?(t(),o("div",ls,[I(Pe,{voice_content:i.voice_content},null,8,["voice_content"])])):M("",!0)])],2))),128))])]),_:1},8,["scrollTop","is-loading"])])}}},rs=z(cs,[["__scopeId","data-v-974803a0"]]),ds={class:"library-info-content"},_s={class:"file-list"},us=["onClick"],hs={class:"document-item-header"},ps={class:"left-box"},vs={class:"document-title"},ms={key:0,class:"document-title"},fs={class:"document-size"},ys={class:"right-box"},gs={class:"document-item-body"},bs={class:"document-similarity"},ks={key:0,class:"document-content"},Ls={key:1,class:"document-content"},ws={class:"document-content"},xs={class:"fragment-img"},Cs=["src"],Ss={__name:"library-info-alert",setup(r,{expose:c}){const{t:e}=V("views.chat-monitor.components.library-info-alert"),l=be(),{renderMath:s}=je(),_=k(!1),f=k(null),g=k([]),x=k(null),n=()=>{g.value=[],x.value=null},L=(v,y)=>{n(),g.value=v,x.value=y.id,_.value=!0,m(y)},$=v=>{v.id!=x.value&&(x.value=v.id,m(v))},S=k([]),m=v=>{Ye({message_id:v.message_id,file_id:v.id,robot_key:v.robot_key,openid:v.openid}).then(y=>{S.value=y.data||[],s(f.value)})},u=()=>{l.push("/library/preview?id="+x.value)},C=()=>{_.value=!1};return c({open:L}),(v,y)=>{const B=Q,Y=Re,D=de("viewer");return t(),U(Y,{class:"library-info-alert",open:_.value,"onUpdate:open":y[0]||(y[0]=b=>_.value=b),title:p(e)("answer_source"),placement:"right",width:"746px",closable:!1,bodyStyle:{background:"#F2F4F7"}},{extra:F(()=>[a("span",{class:"close-btn",onClick:C},[I(p($e))])]),default:F(()=>[a("div",ds,[a("div",_s,[(t(!0),o(P,null,A(g.value,b=>(t(),o("div",{class:J(["file-item",{active:x.value==b.id}]),key:b.id,onClick:R=>$(b)},d(b.file_name),11,us))),128))]),a("div",{class:"document-items",ref_key:"docBoxRef",ref:f},[(t(!0),o(P,null,A(S.value,b=>(t(),o("div",{class:"document-item",key:b.id},[a("div",hs,[a("div",ps,[a("span",vs,d(p(e)("id_prefix"))+d(b.id),1),b.title?(t(),o("span",ms,d(b.title),1)):M("",!0),a("span",fs,d(p(e)("total_characters",{count:b.word_total})),1)]),a("div",ys,[a("a",{onClick:u},d(p(e)("view_source_document")),1)])]),a("div",gs,[a("div",bs,[W(d(p(e)("similarity"))+" ",1),I(B,{name:"similarity",style:{"font-size":"16px"}}),W(d(b.similarity),1)]),b.question?(t(),o("div",ks,d(p(e)("question_prefix"))+d(b.question),1)):M("",!0),b.answer?(t(),o("div",Ls,d(p(e)("answer_prefix"))+d(b.answer),1)):M("",!0),a("div",ws,d(b.content),1),_e((t(),o("div",xs,[(t(!0),o(P,null,A(b.images,(R,w)=>(t(),o("img",{key:w,src:R,alt:""},null,8,Cs))),128))])),[[D]])])]))),128))],512)])]),_:1},8,["open","title"])}}},Ts=z(Ss,[["__scopeId","data-v-05bdcb82"]]),Ms={key:0,class:"chat-box-warpper"},$s={class:"chat-box-header"},Rs={class:"nickname"},Ds={class:"chat-source"},Os={class:"chat-box-content"},Is={key:1},Ns={__name:"chat-box",setup(r,{expose:c}){const{t:e}=V("views.chat-monitor.components.chat-box"),l=Z(),{activeChat:s}=X(l),_=k(null),f=()=>{_.value.scrollToBottom()},g=()=>{_.value.scrollToTop()},x=k(null),n=(L,$)=>{x.value.open(L,$)};return c({scrollToTop:g,scrollToBottom:f}),(L,$)=>(t(),o(P,null,[p(s)?(t(),o("div",Ms,[a("div",$s,[a("div",Rs,d(p(s).name||p(s).nickname),1),a("div",Ds,d(p(e)("from_source",{robot:p(s).come_from.robot_name,app:p(s).come_from.app_name})),1)]),a("div",Os,[I(rs,{ref_key:"chatMessageRef",ref:_,onOpenLibrary:n},null,512)])])):(t(),o("div",Is)),I(Ts,{ref_key:"libraryInfoAlertRef",ref:x},null,512)],64))}},Bs=z(Ns,[["__scopeId","data-v-60f64657"]]),qs={class:"zm-date-quick"},Ps={class:"btns"},As=["onClick"],Ys={key:0,class:"custom-panel"},js={__name:"date-filter",props:{datekey:{type:String,default:"2"}},emits:["dateChange"],setup(r,{emit:c}){const{t:e}=V("views.chat-monitor.components.date-filter"),l=r,s=c,_=k(2),f=k(!1),g=k([]),x=ke([{label:"label_today",key:2,start_date:q().startOf("day"),end_date:q().endOf("day")},{label:"label_yesterday",key:3,start_date:q().subtract(1,"day").startOf("day"),end_date:q().startOf("day").subtract(1,"millisecond")},{label:"label_this_week",key:6,start_date:q().startOf("week"),end_date:q().endOf("day").subtract(1,"millisecond")},{label:"label_last_3_months",key:7,start_date:q().subtract(3,"month").startOf("day"),end_date:q().endOf("day").subtract(1,"millisecond")},{label:"label_custom",key:5,start_date:q().startOf("day"),end_date:q().endOf("day")}]),n=m=>m&&m.valueOf()>q().endOf("day").valueOf(),L=(m,u)=>{s("dateChange",{start_time:m.startOf("day").format("YYYYMMDD"),end_time:u.endOf("day").format("YYYYMMDD")})},$=m=>{_.value=m;const u=x.find(C=>C.key===m);if(u){if(m===5){g.value=[u.start_date,u.end_date],f.value=!f.value,_.value=5;return}g.value=[u.start_date,u.end_date],L(u.start_date,u.end_date)}},S=m=>{if(!m||m.length<2)return;const[u,C]=m;_.value=5,x.forEach(v=>{v.key===5&&(v.start_date=u,v.end_date=C)}),L(u,C)};return se(()=>{const m=parseInt(l.datekey.split("-")[0])||2;$(m)}),te(()=>l.datekey,m=>{const u=parseInt(String(m).split("-")[0])||2;$(u)}),(m,u)=>{const C=Oe;return t(),o("div",qs,[a("div",Ps,[(t(!0),o(P,null,A(x,v=>(t(),o("span",{key:v.key,class:J(["btn",{active:v.key===_.value}]),onClick:y=>$(v.key)},[W(d(p(e)(v.label))+" ",1),v.key===5?(t(),U(p(De),{key:0,class:J(["down-icon",{rotate:f.value}])},null,8,["class"])):M("",!0)],10,As))),128))]),f.value?(t(),o("div",Ys,[I(C,{value:g.value,"onUpdate:value":u[0]||(u[0]=v=>g.value=v),format:"YYYY-MM-DD",disabledDate:n,allowClear:!1,onChange:S},null,8,["value"])])):M("",!0)])}}},zs=z(js,[["__scopeId","data-v-5e3f75ee"]]),Hs={class:"chat-monitor-page"},Fs={class:"page-left"},Us={class:"app-list-box"},Js={class:"search-box"},Vs={class:"search-input-row"},Es={key:0,class:"date-filter-wrapper"},Ws={class:"chat-list-wrapper"},Ks={__name:"index",setup(r){const{t:c}=V("views.chat-monitor"),e=he(),l=Z(),{init:s,changeRobot:_,switchChat:f,closeIM:g}=l,{robotList:x,selectedRobotId:n,activeChat:L}=X(l),$=k(null),S=k(null),m=k(null),u=k(""),C=k(!1),v=k("2"),y=k(""),B=k(""),Y=()=>{C.value=!C.value},D=({start_time:T,end_time:i})=>{y.value=q(String(T),"YYYYMMDD").startOf("day").unix(),B.value=q(String(i),"YYYYMMDD").endOf("day").unix();const j={keyword:u.value,page:1,start_time:y.value,end_time:B.value};S.value&&S.value.getData(j)},b=()=>{const T={keyword:u.value,page:1,start_time:y.value||void 0,end_time:B.value||void 0};_(T)},R=async T=>{var i;await f(T),(i=m.value)==null||i.scrollToBottom()},w=()=>{G(()=>{var T;(T=m.value)==null||T.scrollToBottom()})},O=()=>{const T={keyword:u.value,page:1,start_time:y.value||void 0,end_time:B.value||void 0};S.value&&S.value.getData(T)};return se(async()=>{await s(),G(()=>{var T;(T=m.value)==null||T.scrollToBottom()}),e.on("onAddMessage",w)}),re(()=>{e.off("onAddMessage",w),g()}),(T,i)=>{const j=Ie,h=Ne,H=Be,E=Q;return t(),o("div",Hs,[a("div",Fs,[a("div",Us,[I(h,{value:p(n),"onUpdate:value":i[0]||(i[0]=N=>ue(n)?n.value=N:null),style:{width:"100%"},onChange:b},{default:F(()=>[I(j,{value:""},{default:F(()=>[W(d(p(c)("all_apps")),1)]),_:1}),(t(!0),o(P,null,A(p(x),N=>(t(),U(j,{value:N.id,key:N.id},{default:F(()=>[a("span",null,d(N.robot_name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),a("div",Js,[a("div",Vs,[I(H,{value:u.value,"onUpdate:value":i[1]||(i[1]=N=>u.value=N),placeholder:p(c)("search_placeholder"),"enter-button":"",style:{flex:"1"},onSearch:O,allowClear:"",onPressEnter:O},null,8,["value","placeholder"]),a("div",{class:J(["time-filter-btn",{active:C.value}]),onClick:Y},[I(E,{name:"time-line-icon",class:"time-icon"})],2)]),C.value?(t(),o("div",Es,[I(zs,{datekey:v.value,onDateChange:D},null,8,["datekey"])])):M("",!0)]),a("div",Ws,[I(it,{ref_key:"chatListRef",ref:S,onSwitchChat:R},null,512)])]),a("div",{class:"page-body",ref_key:"bodyRef",ref:$},[p(L)?(t(),U(Bs,{key:0,ref_key:"chatBoxRef",ref:m},null,512)):(t(),U(pe,{key:1,style:{background:"#F2F4F7"},size:"250"},{default:F(()=>[a("div",null,[a("p",null,d(p(c)("select_conversation_tip")),1),a("p",null,d(p(c)("feature_description")),1)])]),_:1}))],512)])}}},fo=z(Ks,[["__scopeId","data-v-f49bfc36"]]);export{fo as default};
//# sourceMappingURL=index-uU5lg-kw.js.map
