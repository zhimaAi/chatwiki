import{a3 as ke,d as o,q as ge,b as ve,D as ye,N as S,a6 as J,X as u,j as l,U as f,u as A,S as be,Z as x,_ as I,F as Z,a1 as Se,a2 as xe,a7 as qe,O as k}from"./vue-chunks-BRsu9_To.js";import{S as Fe,E as we,a as Le,D as Ee}from"./edit-fragment-alert-DZ3A98CI.js";import{b as Te,d7 as ze,dy as De,M as D,dz as Ne,dA as Ce,k as G,dB as Oe,dC as Be,E as H,dD as Je}from"../../index-M_xDbIir.js";import{S as Ae}from"./index-D_6sH2t0.js";import{B as Ie,_ as Re}from"./index-BNf5X5et.js";import{L as je}from"./LeftOutlined-DbHJ8blF.js";import"./empty-CzGZrENG.js";import"./model-select-Cwu3Of2q.js";import"./index-Bm5IPe57.js";import"./index-khLftDou.js";import"./Trigger-CkoSoTBd.js";import"./ResizeObserver.es-B1PUzC5B.js";import"./index-Btmz2D3B.js";import"./slide-DzpBPoRp.js";import"./index-CMIXnI2Z.js";import"./List-DKTpjnke.js";import"./useMergedState-C0iIHNGF.js";import"./DownOutlined-CI2wWtcJ.js";import"./CheckOutlined-DVulUWsT.js";import"./SearchOutlined-KUcJKUZw.js";import"./FormItemContext-DRzYyKbC.js";import"./move-DD64vPeJ.js";import"./index-CSIZCO5e.js";import"./index-DDHNcNyv.js";import"./index-BMSQkwth.js";import"./index-BF4PinvW.js";import"./index-tezmKtYb.js";import"./UpOutlined-DzDRcb4z.js";import"./index-V0sRhm34.js";import"./isPlainObject-A-SljaBF.js";import"./Col-CFWsj1wI.js";import"./responsiveObserve-CRSSr9-w.js";import"./hasIn-DEwqUvIo.js";import"./collapseMotion-Brd6xpAT.js";import"./index-B0RyY99D.js";import"./colors-C56HAaAp.js";import"./QuestionCircleOutlined-B5SgdGK5.js";import"./index-UA7y0weg.js";import"./Input-Bx6Hhp2b.js";import"./inputProps-DsSGhBt6.js";import"./Search-w33R1D1l.js";import"./TextArea-C57yjED6.js";import"./Password-5njtOUlo.js";import"./index-Dob-Z8xa.js";import"./RadioButton-Bb2kU0Fd.js";import"./Checkbox-pA5GUfu7.js";import"./index-pt58wSpn.js";import"./index-Csj0hcBP.js";import"./index-C8hUWloT.js";import"./index-BR_iTZbN.js";import"./index-BSroSjtu.js";import"./DownloadOutlined-Cn7Sl8HY.js";import"./index-CsySi7_q.js";import"./useRefs-CRRjy_qY.js";import"./index-WJK8Aswe.js";import"./index-B3CPYV6x.js";import"./shallowequal-C0xnIuy8.js";import"./Dropdown-Dh4cjnmT.js";import"./pick-BW-qU63h.js";import"./PlusOutlined-DQ91YM1E.js";import"./axios-Dq7h7Pqt.js";import"./qs-BrxkIg-9.js";import"./crypto-js-ClNpte_9.js";import"./dayjs-B6IotFah.js";import"./dropdown-DCrM-GKY.js";import"./RightOutlined-og3IpneX.js";const Ve={key:0,class:"loading-wrap"},Me={class:"document-segmentation"},Pe={class:"breadcrumb-block"},Qe={class:"page-title"},$e={class:"page-container"},Ue={class:"page-left"},We={class:"page-right"},Xe={class:"document-fragment-preview"},Ze={class:"preview-header"},Ge={class:"fragment-number"},He={key:1,class:"loading-box"},Ke="你是一位文章分段助手，根据文章内容的语义进行合理分段，确保每个分段表述一个完整的语义，每个分段字数控制在500字左右，最大不超过1000字。请严格按照文章内容进行分段，不要对文章内容进行加工，分段完成后输出分段后的内容。",Ye={__name:"document-segmentation",setup(et){const K=ze(),N=ke(),C=xe(),{setInitDocumentFragmentList:R}=K,{document_id:q}=N.query,F=o(!0),w=o(1),Y=o(1);let g=!1,a={id:q,separators_no:"",chunk_size:512,not_merged_text:!1,chunk_overlap:50,is_qa_doc:0,question_lable:"",similar_label:"",answer_lable:"",enable_extract_image:!0,ai_chunk_size:5e3,ai_chunk_model:"",ai_chunk_model_config_id:"",ai_chunk_prumpt:Ke,ai_chunk_task_id:""};const d=o(null),ee=e=>{typeof e.separators_no=="object"&&(e.separators_no=JSON.stringify(e.separators_no)),typeof e.father_chunk_separators_no=="object"&&(e.father_chunk_separators_no=JSON.stringify(e.father_chunk_separators_no)),typeof e.son_chunk_separators_no=="object"&&(e.son_chunk_separators_no=JSON.stringify(e.son_chunk_separators_no)),a={...a,...e},g?D.confirm({title:"提醒",icon:l(H),content:"文档片段已被编辑重新获取文档片段会丢失当前修改过的文档片段内容，确定要重新获取吗？",okText:"确定",okType:"danger",cancelText:"取消",onOk(){g=!1,z("create")},onCancel(){}}):(g=!1,z("create"))};let te=60*10,j=0,V=null;const L=o({}),E=o(0),M=()=>{F.value||(F.value=!0),De({id:q}).then(async e=>{const{status:t}=e.data;if(E.value=e.data.library_type,L.value=e.data,a={...a,separators_no:e.data.separators_no||"[12,11]",chunk_size:+e.data.chunk_size||512,not_merged_text:e.data.not_merged_text=="true",ai_chunk_size:+e.data.ai_chunk_size||5e3,chunk_overlap:+e.data.chunk_overlap||50,is_qa_doc:E.value==2?1:0,question_lable:e.data.question_lable,similar_label:e.data.similar_label,answer_lable:e.data.answer_lable,question_column:e.data.question_column,similar_column:e.data.similar_column,answer_column:e.data.answer_column,enable_extract_image:e.data.enable_extract_image=="true",qa_index_type:+e.data.qa_index_type,chunk_type:+e.data.chunk_type,semantic_chunk_size:+e.data.semantic_chunk_size||512,semantic_chunk_overlap:+e.data.semantic_chunk_overlap||50,semantic_chunk_threshold:+e.data.semantic_chunk_threshold||90,semantic_chunk_use_model:e.data.semantic_chunk_use_model||"",ai_chunk_prumpt:e.data.ai_chunk_prumpt||"",ai_chunk_model:e.data.ai_chunk_model||"",semantic_chunk_model_config_id:e.data.semantic_chunk_model_config_id>0?e.data.semantic_chunk_model_config_id:"",ai_chunk_model_config_id:e.data.ai_chunk_model_config_id>0?e.data.ai_chunk_model_config_id:"",ai_chunk_task_id:e.data.ai_chunk_task_id||"",father_chunk_paragraph_type:+e.data.father_chunk_paragraph_type||2,father_chunk_separators_no:e.data.father_chunk_separators_no||"[12,11]",father_chunk_chunk_size:+e.data.father_chunk_chunk_size||1024,son_chunk_separators_no:e.data.son_chunk_separators_no||"[8,10]",son_chunk_chunk_size:+e.data.son_chunk_chunk_size||512},e.data.chunk_type==0&&(a={...a,separators_no:e.data.normal_chunk_default_separators_no,chunk_size:e.data.normal_chunk_default_chunk_size,not_merged_text:e.data.normal_chunk_default_not_merged_text=="true",chunk_overlap:e.data.normal_chunk_default_chunk_overlap,chunk_type:+e.data.default_chunk_type,semantic_chunk_size:+e.data.semantic_chunk_default_chunk_size,semantic_chunk_overlap:+e.data.semantic_chunk_default_chunk_overlap,semantic_chunk_threshold:+e.data.semantic_chunk_default_threshold,semantic_chunk_use_model:e.data.default_use_model||"",semantic_chunk_model_config_id:e.data.default_model_config_id>0?e.data.default_model_config_id:""}),t==0){if(j++,j>te){D.error({title:"提醒",content:"文档解析速度慢请稍后再试"});return}setTimeout(()=>{M()},1e3)}else t==4||t==2?(F.value=!1,w.value=parseInt(e.data.is_table_file),V=e.data.library_id,E.value==2?(a.question_lable||a.question_column)&&z():z()):C.replace("/library/details?id="+e.data.library_id);e.data.is_table_file==1&&ae()})};ge(async()=>{await M()});const P=o([]),ae=()=>{Ce({id:q}).then(e=>{let t=[];for(let n in e.data)t.push({lable:e.data[n],value:n});P.value=t})},Q=o(!1),v=o(!1),O=o(""),y=o(null);let m=null;const i=o([]),T=o([]),p=o(0),ne=ve(()=>p.value<=0),z=e=>{let t={...a,semantic_chunk_model_config_id:a.semantic_chunk_model_config_id?+a.semantic_chunk_model_config_id:0,ai_chunk_model_config_id:a.ai_chunk_model_config_id?+a.ai_chunk_model_config_id:0};a.chunk_type==3&&(a.ai_chunk_task_id&&!e&&(t.ai_chunk_task_id=a.ai_chunk_task_id),e&&e==="create"&&(t.ai_chunk_preview=!0,delete t.ai_chunk_task_id));let n=Ne;return e=="create"&&(n=Je),n(t).then(_=>{var c;T.value=_.data.list||[],R(T.value),i.value=_.data.list||[],p.value=_.data.list.length||0,a.chunk_type==3&&(O.value=((c=_.data.split_params)==null?void 0:c.ai_chunk_task_id)||"",v.value=!0,d.value.reLoading=!0,y.value=null,!a.ai_chunk_task_id&&w.value!=1||e&&e==="create"?(i.value=[],p.value=0,_e()):(v.value=!1,d.value.reLoading=!1))}).finally(()=>{a.chunk_type!=3&&(d.value.reLoading=!1,d.value.saveLoading=!1)})},ie=e=>{Y.value=e},oe=async()=>{var e;try{const t=await se();return t.data.err_msg?(y.value=t.data.err_msg,!0):((e=t.data.list)==null?void 0:e.length)>0?(T.value=t.data.list||[],R(T.value),i.value=t.data.list||[],p.value=t.data.list.length||0,!0):!1}catch{return y.value="请求异常，停止轮询",!0}};function le(e){return e.split("message:")[1]}const _e=()=>{const e=async()=>{if(!await oe())m=setTimeout(e,3e3);else if(v.value=!1,d.value.reLoading=!1,d.value.saveLoading=!1,m!==null&&(clearTimeout(m),m=null),Q.value&&W(),y.value){let n=le(y.value);D.error({title:"分段失败提示",content:n?`模型调用失败，失败原因：${n}`:"模型调用失败"})}};e()},se=()=>Be({id:a.id,task_id:O.value}),$=o(null);let s=null;const re=(e,t)=>{let{title:n,content:_,question:c,answer:h,images:r,similar_question_list:b}=e;s=t,$.value.open({title:n,content:_,question:c,answer:h,images:r,similar_question_list:b})},ue=({title:e,content:t,question:n,answer:_,images:c,similar_question_list:h})=>{(i.value[s].title!=e||i.value[s].content!=t||i.value[s].question!=n||i.value[s].answer!=_)&&(g=!0),i.value[s].title=e,i.value[s].content=t,i.value[s].question=n,i.value[s].answer=_,i.value[s].images=c,i.value[s].similar_question_list=h?h.split(`
`):[],i.value[s].word_total=_.length+n.length+t.length},ce=e=>{D.confirm({title:"提醒",icon:l(H),content:"确定要删除这个片段吗?",okText:"确定",okType:"danger",cancelText:"取消",onOk(){g=!0,i.value.splice(e,1)},onCancel(){}})},B=o(""),de=e=>{B.value=e},U=o(!1),me=()=>{let e=d.value.formState;e=JSON.parse(JSON.stringify(e)),typeof e.separators_no=="object"&&(e.separators_no=JSON.stringify(e.separators_no)),typeof e.father_chunk_separators_no=="object"&&(e.father_chunk_separators_no=JSON.stringify(e.father_chunk_separators_no)),typeof e.son_chunk_separators_no=="object"&&(e.son_chunk_separators_no=JSON.stringify(e.son_chunk_separators_no)),a={...a,...e}},W=async()=>{if(me(),B.value)return G.error(B.value);if(a.chunk_type==3&&!i.value.length)return Q.value=!0,!1;O.value!==a.ai_chunk_task_id&&delete a.ai_chunk_task_id;let e={...a,chunk_async:!0,semantic_chunk_model_config_id:a.semantic_chunk_model_config_id?+a.semantic_chunk_model_config_id:0,ai_chunk_model_config_id:a.ai_chunk_model_config_id?+a.ai_chunk_model_config_id:0,is_table_file:w.value};delete e.id;let t={id:q,chunk_async:!0,word_total:p.value,split_params:JSON.stringify(e),list:JSON.stringify(i.value)};e.is_qa_doc==1&&(t.qa_index_type=e.qa_index_type),U.value=!0,Oe(t).then(()=>{G.success("保存成功");let n=1;N.query.page&&(n=N.query.page),C.replace("/library/details?id="+V+"&page="+n)}).finally(()=>{U.value=!1}).catch(n=>{n.data&&n.data.index&&pe(n.data.index)})},X=o(null),pe=e=>{e=e-1;let t=X.value.querySelectorAll(".fragment-item");t.length>=e&&t[e].scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},he=()=>{C.back()};return ye(()=>{m&&(clearTimeout(m),m=null)}),(e,t)=>{const n=Ae,_=qe("router-link"),c=Re,h=Ie;return k(),S(Z,null,[F.value?(k(),S("div",Ve,[l(n)])):J("",!0),u("div",Me,[u("div",Pe,[l(h,null,{default:f(()=>[l(c,null,{default:f(()=>[l(_,{to:"/library/list"},{default:f(()=>t[0]||(t[0]=[x(" 知识库管理 ")])),_:1,__:[0]})]),_:1}),l(c,null,{default:f(()=>[l(_,{to:{path:"/library/details/knowledge-document",query:{id:L.value.library_id}}},{default:f(()=>[x(I(L.value.library_name)+"知识库",1)]),_:1},8,["to"])]),_:1}),l(c,null,{default:f(()=>t[1]||(t[1]=[x("分段设置")])),_:1,__:[1]})]),_:1})]),u("div",Qe,[l(A(je),{onClick:he}),t[2]||(t[2]=u("span",{class:"title"},"文档分段与清洗",-1))]),u("div",$e,[u("div",Ue,[l(Fe,{excellQaLists:P.value,libFileInfo:L.value,library_type:E.value,mode:w.value,ref_key:"segmentationSettingRef",ref:d,onChange:ee,onChangeChunkType:ie,onSave:W,onValidate:de},null,8,["excellQaLists","libFileInfo","library_type","mode"])]),u("div",We,[u("div",Xe,[u("div",Ze,[x(I(A(a).chunk_type)+" ",1),t[3]||(t[3]=u("span",{class:"label-text"},"分段预览",-1)),u("span",Ge,"共"+I(p.value)+"个分段",1)]),ne.value&&!v.value?(k(),be(Le,{key:0})):J("",!0),v.value?(k(),S("div",He,[l(n),t[4]||(t[4]=x("数据处理中..."))])):J("",!0),u("div",{class:"preview-box",ref_key:"previewBoxRef",ref:X},[(k(!0),S(Z,null,Se(i.value,(r,b)=>(k(),S("div",{class:"fragment-item",key:b},[l(Ee,{chunk_type:A(a).chunk_type,father_chunk_paragraph_number:r.father_chunk_paragraph_number,number:r.number,title:r.title,content:r.content,total:r.word_total,question:r.question,answer:r.answer,images:r.images,similar_question_list:r.similar_question_list,onDelete:fe=>ce(b),onEdit:fe=>re(r,b)},null,8,["chunk_type","father_chunk_paragraph_number","number","title","content","total","question","answer","images","similar_question_list","onDelete","onEdit"])]))),128))],512)])])]),l(we,{ref_key:"editFragmentAlertRef",ref:$,onOk:ue},null,512)])],64)}}},ma=Te(Ye,[["__scopeId","data-v-001fb170"]]);export{ma as default};
