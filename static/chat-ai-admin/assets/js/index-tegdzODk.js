import{d as ve,e as fe,f as w,r as X,w as ae,o as ne,Y as y,_,F as P,a1 as K,ae as j,k as o,a2 as f,G as q,l as he,u as F,a5 as t,n as ge,A as ye,a9 as H,ad as ue,a7 as I,J as ke,a6 as be,a3 as xe,ao as $e,X as _e,ag as ce,b as Se}from"./vue-chunks-Ci-XTWEs.js";import{k as we,d as ie,bC as Le,b as W,ag as Ce,bo as Ae,b5 as se,ah as Me,ai as Re,bD as qe,b2 as Ue,bE as Ne,F as Ie,aq as Oe,ar as Be,as as Te}from"../../index-BZRrEp3V.js";import{h as me}from"./index-UUVUVnDU.js";import{M as Ee}from"./model-select-S5ievtWN.js";import{ai as ze,B as Fe,aw as Ve,E as De,p as pe,ab as J,X as Ke,q as je,R as Pe,Q as Je,aB as He,O as Ge,u as Qe,v as Ye,aC as Xe,M as We,a as oe,I as Ze,ag as et,ad as tt,bw as st}from"./ui-antd-BWf8LxGy.js";import{M as at}from"./index-BMSQkwth.js";import{u as lt}from"./useEventBus-BwH2zX88.js";import"./utils-ChQO-_r6.js";const ot={class:"prompt-form"},nt={class:"form-item"},it={class:"form-item-label"},rt={class:"prompt-form-item"},dt={class:"prompt-form-item"},ct={class:"prompt-form-item-content"},ut={key:0,class:"prompt-form-item-tip"},_t={class:"prompt-form-item"},mt={class:"prompt-form-item-label"},pt={class:"form-item-body"},vt={class:"number-box"},ft={class:"number-slider-box"},ht={class:"number-input-box"},gt={class:"prompt-form-item"},yt={class:"prompt-form-item-label"},kt={class:"form-item-body"},bt={class:"number-box"},xt={class:"number-slider-box"},$t={class:"number-input-box"},St={class:"recall-settings-box"},wt={class:"form-box prompt-form"},Lt={class:"form-item is-required"},Ct={class:"form-item-body"},At={class:"retrieval-mode-items"},Mt=["onClick"],Rt={class:"retrieval-mode-title"},qt={class:"title-text"},Ut={class:"retrieval-mode-desc"},Nt={class:"form-item"},It={class:"form-item-label"},Ot={class:"form-item-body"},Bt={class:"number-box"},Tt={class:"number-slider-box"},Et={class:"number-input-box"},zt={key:0,class:"form-item"},Ft={class:"form-item-label"},Vt={class:"form-item-body"},Dt={class:"number-box"},Kt={class:"number-slider-box"},jt={class:"number-input-box"},Pt={class:"form-item"},Jt={class:"form-item-label"},Ht={key:0,class:"form-item-body"},Gt=["src"],Qt=ve({__name:"search-drawer",props:{librarySearchData:{type:Object,default:null},defaultLibrarySearchData:{type:Object,default:null}},setup(S){let{role_permission:r,role_type:C}=we();const U=fe(()=>C==1||r.includes("SearchSets")),k=S,R=w([{iconName:"mix-icon",title:"混合检索",value:1,isRecommendation:!0,desc:"同时执行三种检索模式，使用RRF算法进行排序，从三种查询结果中选择更匹配用户问题的结果。混合检索兼顾语义相似性与逻辑关联性，通过互补优势提升检索的准确性和生成结果的可信度"},{iconName:"vector-icon",title:"向量检索",value:2,desc:"将用户提问转成向量之后与知识库分段匹配相似度，返回相似度高的结果。向量检索擅长语义相似性匹配和大规模非结构化数据处理，但缺乏可解释性和精准关系验证"},{iconName:"graph-icon",title:"知识图谱检索",value:4,desc:"通过关系推理，检索出与用户问题相关联的知识。知识图谱检索擅长精准的实体关系推理和逻辑验证，但对非结构化文本和语义模糊查询支持较弱"},{iconName:"search-check-icon",title:"全文检索",value:3,desc:"通过分词匹配文档中的词汇，返回包含这些词汇的文本片段"}]),L=w(!1),s=X({use_model:"",model_config_id:"",prompt_type:"0",prompt:"",temperature:.5,max_token:2e3,context_pair:0,search_type:1,top_k:5,size:0,similarity:.4,rerank_status:0,rerank_use_model:void 0,rerank_model_config_id:void 0,summary_switch:0}),E=w([]),V=()=>{me({model_type:"RERANK"}).then(c=>{let e=c.data||[];E.value=e.map(g=>({id:g.model_config.id,name:g.model_info.model_name,icon:g.model_info.model_icon_url,children:g.model_info.rerank_model_list}))})},x=(c,e)=>{s.use_model=e.modelName,s.model_config_id=e.modelId,a()},n=w([]),m=c=>{var e,g,p,d,$;if(n.value=c,!((e=k.librarySearchData)!=null&&e.model_config_id)||!((g=k.librarySearchData)!=null&&g.use_model)){if(n.value.length>0){let A=n.value[0];if(A){let M=A.children[0];s.use_model=M.name,s.model_config_id=M.model_config_id}}}else s.use_model=((p=k.librarySearchData)==null?void 0:p.use_model)+"$$",s.model_config_id=((d=k.librarySearchData)==null?void 0:d.model_config_id)+"$$",s.use_model=s.use_model.split("$$")[0],s.model_config_id=($=k.librarySearchData)==null?void 0:$.model_config_id.split("$$")[0]},N=c=>{s.search_type=c,a()},b=(c,e)=>{s.rerank_model_config_id=e.rerank_model_config_id,a()},h=c=>{let e={...c};e.max_token=parseFloat(e.max_token),e.temperature=parseFloat(e.temperature),e.context_pair=parseFloat(e.context_pair),e.search_type=parseFloat(e.search_type),e.rerank_status=parseFloat(e.rerank_status),e.similarity=parseFloat(e.similarity),e.top_k=parseFloat(e.size),e.summary_switch=+e.summary_switch,e.rerank_use_model===""&&(e.rerank_use_model=void 0),Object.keys(e).forEach(g=>{s[g]=e[g]})},a=()=>{let c={...s};if(!c.prompt&&s.prompt_type=="1")return oe.error("请输入自定义提示词");(s.search_type==3||s.search_type==4)&&delete c.similarity,s.prompt_type=="0"&&delete c.prompt,c.size=c.top_k,Le(c).then(e=>{oe.success("保存成功")})},B=w(!1),O=w(""),T=()=>{s.prompt_type=="1"?(O.value=s.prompt,B.value=!0):a()},G=()=>{if(O.value)s.prompt=O.value,B.value=!1,a();else return oe.error("请输入提示语")},Q=()=>{s.prompt_type="0",B.value=!1},i=c=>{},u=()=>{L.value=!0};return ae(()=>k.librarySearchData,c=>{var e;(e=k.librarySearchData)!=null&&e.id&&h({...ke(k.librarySearchData)})}),ne(()=>{V()}),(c,e)=>{const g=Fe,p=pe,d=Ke,$=De,A=Pe,M=je,D=Je,v=He,z=Ge,Y=ie,le=Ye,re=Xe,Z=Qe,de=We,ee=Ve;return _(),y(P,null,[U.value?(_(),K(g,{key:0,onClick:u,icon:he(F(ze))},{default:f(()=>e[18]||(e[18]=[q("搜索设置")])),_:1,__:[18]},8,["icon"])):j("",!0),o(ee,{open:L.value,"onUpdate:open":e[17]||(e[17]=l=>L.value=l),class:"custom-class","root-class-name":"root-class-name",title:"搜索设置",width:"472",placement:"right",onAfterOpenChange:i},{default:f(()=>[t("div",ot,[e[29]||(e[29]=t("div",{class:"prompt-form-label"},"模型设置",-1)),t("div",nt,[t("div",it,[o($,{align:"center"},{default:f(()=>[e[20]||(e[20]=t("span",null,"AI智能总结",-1)),o(p,null,{title:f(()=>e[19]||(e[19]=[q("开启后，搜索知识库时，由大模型自动总结文档，并给出总结后的结果")])),default:f(()=>[o(F(J),{class:"question-icon"})]),_:1}),o(d,{style:{"margin-left":"24px"},onChange:x,checked:s.summary_switch,"onUpdate:checked":e[0]||(e[0]=l=>s.summary_switch=l),checkedValue:1,unCheckedValue:0,"checked-children":"开","un-checked-children":"关"},null,8,["checked"])]),_:1,__:[20]})])]),ge(t("div",null,[t("div",rt,[e[21]||(e[21]=t("div",{class:"prompt-form-item-label"},[t("span",{style:{color:"red"}},"* "),t("span",null,"模型选择")],-1)),o(Ee,{modelType:"LLM",modeName:s.use_model,"onUpdate:modeName":e[1]||(e[1]=l=>s.use_model=l),modeId:s.model_config_id,"onUpdate:modeId":e[2]||(e[2]=l=>s.model_config_id=l),style:{width:"100%"},onLoaded:m,onChange:x},null,8,["modeName","modeId"])]),t("div",dt,[e[24]||(e[24]=t("div",{class:"prompt-form-item-label"},[t("span",{style:{color:"red"}},"* "),t("span",null,"提示词")],-1)),o(M,{value:s.prompt_type,"onUpdate:value":e[3]||(e[3]=l=>s.prompt_type=l),onChange:T},{default:f(()=>[o(A,{value:"0"},{default:f(()=>e[22]||(e[22]=[q("默认提示词")])),_:1,__:[22]}),o(A,{value:"1"},{default:f(()=>e[23]||(e[23]=[q("自定义提示词")])),_:1,__:[23]})]),_:1},8,["value"]),t("div",ct,[s.prompt_type=="0"?(_(),y("div",ut,"将提交的内容进行智能总结,不要随意发挥")):(_(),K(D,{key:1,onBlur:a,maxLength:500,style:{height:"80px"},value:s.prompt,"onUpdate:value":e[4]||(e[4]=l=>s.prompt=l),placeholder:"请输入自定义提示词"},null,8,["value"]))])]),t("div",_t,[t("div",mt,[e[26]||(e[26]=t("span",null,"温度",-1)),o(p,null,{title:f(()=>e[25]||(e[25]=[q("温度越低，回答越严谨。温度越高，回答越发散。")])),default:f(()=>[o(F(J),{class:"question-icon"})]),_:1})]),t("div",pt,[t("div",vt,[t("div",ft,[o(v,{onBlur:a,class:"custom-slider",value:s.temperature,"onUpdate:value":e[5]||(e[5]=l=>s.temperature=l),min:0,max:2,step:.1},null,8,["value"])]),t("div",ht,[o(z,{onBlur:a,value:s.temperature,"onUpdate:value":e[6]||(e[6]=l=>s.temperature=l),min:0,max:2,step:.1},null,8,["value"])])])])]),t("div",gt,[t("div",yt,[e[28]||(e[28]=t("span",null,"最大token",-1)),o(p,null,{title:f(()=>e[27]||(e[27]=[t("div",null,"问题+答案的最大token数，如果出现回答被截断，可调高此值",-1)])),default:f(()=>[o(F(J),{class:"question-icon"})]),_:1})]),t("div",kt,[t("div",bt,[t("div",xt,[o(v,{onBlur:a,class:"custom-slider",value:s.max_token,"onUpdate:value":e[7]||(e[7]=l=>s.max_token=l),min:0,max:100*1024},null,8,["value"])]),t("div",$t,[o(z,{onBlur:a,value:s.max_token,"onUpdate:value":e[8]||(e[8]=l=>s.max_token=l),min:0,max:100*1024},null,8,["value"])])])])])],512),[[ye,s.summary_switch==1]])]),t("div",St,[t("div",wt,[e[37]||(e[37]=t("div",{class:"prompt-form-label"},"召回设置",-1)),t("div",Lt,[e[30]||(e[30]=t("div",{class:"form-item-label"},[t("span",null,"检索模式")],-1)),t("div",Ct,[t("div",At,[(_(!0),y(P,null,H(R.value,l=>(_(),y("div",{class:ue(["retrieval-mode-item",{active:s.search_type==l.value}]),key:l.value,onClick:te=>N(l.value)},[s.search_type==l.value?(_(),K(Y,{key:0,class:"check-arrow",name:"check-arrow-filled"})):j("",!0),t("div",Rt,[o(Y,{name:l.iconName,class:"title-icon"},null,8,["name"]),t("span",qt,I(l.title),1),l.isRecommendation?(_(),K(Y,{key:0,class:"recommendation-icon",name:"recommendation"})):j("",!0)]),t("div",Ut,I(l.desc),1)],10,Mt))),128))])])]),t("div",Nt,[t("div",It,[e[32]||(e[32]=t("span",null,"Top K ",-1)),o(p,null,{title:f(()=>e[31]||(e[31]=[q("最多从知识库中召回分段数，最低为1，最高为10。召回分段数越多，消耗的token也会越多。")])),default:f(()=>[o(F(J),{class:"question-icon"})]),_:1})]),t("div",Ot,[t("div",Bt,[t("div",Tt,[o(v,{onBlur:a,class:"custom-slider",value:s.top_k,"onUpdate:value":e[9]||(e[9]=l=>s.top_k=l),min:1,max:10},null,8,["value"])]),t("div",Et,[o(z,{onBlur:a,value:s.top_k,"onUpdate:value":e[10]||(e[10]=l=>s.top_k=l),min:1,max:10},null,8,["value"])])])])]),s.search_type!=3&&s.search_type!=4?(_(),y("div",zt,[t("div",Ft,[e[34]||(e[34]=t("span",null,"相似度阈值 ",-1)),o(p,null,{title:f(()=>e[33]||(e[33]=[q("召回时，只会召回相似度大于阈值的文本分段。取值范围：0~1，阈值越大回答的越准确，建议不超过0.9")])),default:f(()=>[o(F(J),{class:"question-icon"})]),_:1})]),t("div",Vt,[t("div",Dt,[t("div",Kt,[o(v,{onBlur:a,class:"custom-slider",value:s.similarity,"onUpdate:value":e[11]||(e[11]=l=>s.similarity=l),min:0,max:1,step:.01},null,8,["value"])]),t("div",jt,[o(z,{onBlur:a,value:s.similarity,"onUpdate:value":e[12]||(e[12]=l=>s.similarity=l),min:0,max:1,step:.01},null,8,["value"])])])])])):j("",!0),t("div",Pt,[t("div",Jt,[e[36]||(e[36]=t("span",null,"Rerank模型 ",-1)),o(p,null,{title:f(()=>e[35]||(e[35]=[q("召回时，只会召回相似度大于阈值的文本分段。取值范围：0~1，阈值越大回答的越准确，建议不超过0.9")])),default:f(()=>[o(F(J),{class:"question-icon"})]),_:1}),o(d,{onChange:a,style:{float:"right"},checkedValue:1,unCheckedValue:0,checked:s.rerank_status,"onUpdate:checked":e[13]||(e[13]=l=>s.rerank_status=l),"checked-children":"开","un-checked-children":"关"},null,8,["checked"])]),s.rerank_status==1?(_(),y("div",Ht,[o(Z,{value:s.rerank_use_model,"onUpdate:value":e[14]||(e[14]=l=>s.rerank_use_model=l),placeholder:"请选择Rerank模型",onChange:b,style:{width:"100%"}},{default:f(()=>[(_(!0),y(P,null,H(E.value,l=>(_(),K(re,{key:l.id},{label:f(()=>[o($,{align:"center",gap:8},{default:f(()=>[t("img",{class:"model-icon",src:l.icon,alt:""},null,8,Gt),q(I(l.name),1)]),_:2},1024)]),default:f(()=>[(_(!0),y(P,null,H(l.children,te=>(_(),K(le,{value:te,rerank_model_config_id:l.id,key:te},{default:f(()=>[t("span",null,I(te),1)]),_:2},1032,["value","rerank_model_config_id"]))),128))]),_:2},1024))),128))]),_:1},8,["value"])])):j("",!0)])])]),o(de,{open:B.value,"onUpdate:open":e[16]||(e[16]=l=>B.value=l),onCancel:Q,title:"请输入自定义提示词",onOk:G},{default:f(()=>[o(D,{value:O.value,"onUpdate:value":e[15]||(e[15]=l=>O.value=l),placeholder:"请输入",style:{"min-height":"300px"},"allow-clear":""},null,8,["value"])]),_:1},8,["open"])]),_:1},8,["open"])],64)}}}),Yt=W(Qt,[["__scopeId","data-v-f633888f"]]),Xt={class:"no-data"},Wt={class:"no-data-text"},Zt={__name:"list-empty",props:{text:{type:String,default:"暂无数据"},size:{type:[Number,String],default:100}},setup(S){const r=S;return(C,U)=>{const k=ie;return _(),y("div",Xt,[o(k,{name:"empty-document",style:be({"font-size":`${r.size}px`,color:"white"})},null,8,["style"]),t("div",Wt,[xe(C.$slots,"default",{},()=>[q(I(r.text),1)],!0)])])}}},es=W(Zt,[["__scopeId","data-v-f4fa2763"]]),ts={class:"search-box-warpper"},ss={class:"search-box-content"},as={class:"search-set-box"},ls={key:0,class:"search-content"},os={class:"search-input-box"},ns={key:1,class:"search-content search-main"},is={class:"search-input-box"},rs={key:1,class:"search-content-box"},ds={class:"search-tip-box"},cs={key:0,class:"tip"},us={key:1,class:"tip complete"},_s={key:0,class:"container"},ms={key:1,class:"intelligent-answer"},ps=["innerHTML"],vs={key:1},fs={class:"section-box"},hs={key:0,class:"section-label"},gs={class:"section-item-nav"},ys={class:"section-item-nav-left"},ks=["onClick"],bs={key:0},xs={class:"section-item-nav-right"},$s=["innerHTML"],Ss={__name:"search-box",props:{librarySearchData:{type:Object,default:null},messageObj:{type:Object,default:null},library_ids:{type:Array,default:()=>[]},isError:{type:Boolean,default:!1}},emits:["search","defaultParmas"],setup(S,{expose:r,emit:C}){const U=C,k=S,R=new at({html:!0,linkify:!0,typographer:!0}),L=w(""),s=w(""),E=w(!1),V=w(!1),x=w({});ae(()=>k.messageObj.content,()=>{L.value=R.render(k.messageObj.content)}),ae(()=>k.messageObj.error,i=>{i&&se(i)});const n=async()=>{if(!k.library_ids.length)return se("请在左侧的知识库选择项内至少选择一个知识库");if(!s.value)return se("请输入消息内容");U("search",s.value),E.value=!0};function m(i){return i.match(/^-?\d+(?:\.\d{0,2})?/)[0]}const N=(i,u)=>{if(!i||!u.trim())return i;const c=u.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),e=new RegExp(`(${c})`,"gi");return i.replace(e,'<span class="highlight">$1</span>')},b=i=>{if(!i.file_name){window.open(`#/library/details/categary-manage?id=${i.library_id}`);return}window.open(`#/library/preview?id=${i.file_id}`)},h=w(k.librarySearchData),a=X({rerank_status:"",rerank_use_model:"",prompt:"",model_config_id:"",use_model:"",temperature:.5,max_token:2e3,similarity:.4,search_type:1,summary_switch:0}),B=w({}),O=i=>{h.value=i;let u={model_config_id:i.model_config_id||a.model_config_id,use_model:i.use_model||a.use_model,temperature:i.temperature||a.temperature,max_token:i.max_token||a.max_token,size:200,similarity:i.similarity||a.similarity,search_type:i.search_type||a.search_type,summary_switch:i.summary_switch||a.summary_switch,question:s.value,id:k.library_ids.join(","),recall_type:1};i.rerank_status&&(u.rerank_status=i.rerank_status),i.rerank_use_model&&(u.rerank_use_model=i.rerank_use_model),i.prompt&&(u.prompt=i.prompt),i.rerank_status==1&&(u.rerank_model_config_id=i.rerank_model_config_id),V.value=!0,B.value=Object.assign(u),U("defaultParmas",B.value),Ae(u).then(c=>{x.value=c.data}).catch(()=>{}).finally(()=>{V.value=!1})},T=w([]);function G(i,u,c){const e=new Set(i.map(g=>g.model_define));return u.filter(g=>{let p=g[c];e.has(p)&&i.filter(d=>{if(d.model_define==p)return d.children=Me(d.children,g.children),!1})}),i}const Q=async()=>{await me({model_type:"LLM"}).then(i=>{let u=i.data||[],c=[];T.value=u.map(e=>{c=[];for(let g=0;g<e.model_info.llm_model_list.length;g++){const p=e.model_info.llm_model_list[g];c.push({name:p,deployment_name:e.model_config.deployment_name,model_config_id:e.model_config.id,model_define:e.model_info.model_define})}return{model_config_id:e.model_config.id,name:e.model_info.model_name,model_define:e.model_info.model_define,icon:e.model_info.model_icon_url,children:c,deployment_name:e.model_config.deployment_name}}),T.value=G(Ce(T.value,"model_define"),T.value,"model_define")})};return ne(async()=>{await Q(),setTimeout(()=>{var i,u,c,e,g;if(h.value=k.librarySearchData,k.librarySearchData,!((i=h.value)!=null&&i.model_config_id)||!((u=h.value)!=null&&u.use_model)){if(T.value.length>0){let p=T.value[0];if(p){let d=p.children[0];a.use_model=d.name,a.model_config_id=d.model_config_id}}}else a.use_model=((c=h.value)==null?void 0:c.use_model)+"$$",a.model_config_id=((e=h.value)==null?void 0:e.model_config_id)+"$$",a.use_model=a.use_model.split("$$")[0],a.model_config_id=(g=h.value)==null?void 0:g.model_config_id.split("$$")[0]},500)}),r({handleRecallTest:O}),(i,u)=>{const c=ie,e=Ze,g=pe;return _(),y("div",ts,[t("div",ss,[t("div",as,[o(Yt,{librarySearchData:h.value},null,8,["librarySearchData"])]),E.value?(_(),y("div",ns,[t("div",is,[o(e,{class:"search-input",onPressEnter:n,value:s.value,"onUpdate:value":u[1]||(u[1]=p=>s.value=p),"allow-clear":"",placeholder:"输入关键词搜索"},{suffix:f(()=>[t("div",{class:"search-icon-box",onClick:n},[o(c,{class:"search-icon",name:"search-right"})])]),_:1},8,["value"])]),!L.value&&S.messageObj.finish&&!x.value.length?(_(),K(es,{key:0,style:{"margin-top":"100px"},size:"250"},{default:f(()=>u[4]||(u[4]=[t("div",null,[t("p",{style:{color:"#262626","font-size":"16px","font-weight":"600","line-height":"24px"}},"暂无任何内容")],-1)])),_:1,__:[4]})):(_(),y("div",rs,[t("div",ds,[o(c,{class:"nav-icon",name:"search-tip"}),S.messageObj.finish?(_(),y("span",us,"智能回答生成完毕")):(_(),y("span",cs,"智能回答生成中..."))]),!S.messageObj.content&&!S.messageObj.finish&&!S.isError?(_(),y("div",_s,u[5]||(u[5]=[$e('<div class="rect-container rect1" data-v-d07cc6e3><div class="rect" data-v-d07cc6e3></div></div><div class="rect-container rect2" data-v-d07cc6e3><div class="rect" data-v-d07cc6e3></div></div><div class="rect-container rect3" data-v-d07cc6e3><div class="rect" data-v-d07cc6e3></div></div>',3)]))):(_(),y("div",ms,[L.value?(_(),y("div",{key:0,innerHTML:L.value},null,8,ps)):(_(),y("div",vs,"暂无任何内容"))])),t("div",fs,[u[7]||(u[7]=t("div",{class:"tips"},[t("div",{class:"tips-text"},"以上内容由大模型生成"),t("div",{class:"tips-line"})],-1)),x.value.length?(_(),y("div",hs,[u[6]||(u[6]=q("相关分段 ")),t("div",null,"("+I(x.value.length)+")",1)])):j("",!0),(_(!0),y(P,null,H(x.value,p=>(_(),y("div",{class:"section-item",key:p.id},[t("div",gs,[t("div",ys,[o(c,{class:"section-item-icon",name:"document"}),t("div",{class:"section-item-label",onClick:d=>b(p)},[q(I(p.file_name),1),p.file_name?j("",!0):(_(),y("span",bs,I(p.library_name)+"-精选",1))],8,ks)]),t("div",xs,"相似度："+I(m(p.similarity)),1)]),o(g,{overlayClassName:"search-content-tip",placement:"top"},{title:f(()=>[q(I(p.content),1)]),default:f(()=>[t("div",{class:"section-item-content",innerHTML:N(p.content,s.value)},null,8,$s)]),_:2},1024)]))),128))])]))])):(_(),y("div",ls,[u[2]||(u[2]=t("div",{class:"search-label"},"知识搜索",-1)),u[3]||(u[3]=t("div",{class:"search-tip"},"快速搜索所选择的知识库中内容",-1)),t("div",os,[o(e,{class:"search-input",onPressEnter:n,value:s.value,"onUpdate:value":u[0]||(u[0]=p=>s.value=p),"allow-clear":"",placeholder:"输入关键词搜索"},{suffix:f(()=>[t("div",{class:"search-icon-box",onClick:n},[o(c,{class:"search-icon",name:"search-right"})])]),_:1},8,["value"])])]))])])}}},ws=W(Ss,[["__scopeId","data-v-d07cc6e3"]]),Ls={class:"cu-tabs"},Cs=["onClick"],As={__name:"contain-tabs",props:{value:{type:[Number,String],required:!0},tabs:{type:Array,required:!0,default:()=>[]}},emits:["update:value","change"],setup(S,{emit:r}){const C=r,U=S,k=R=>{C("update:value",R),C("change",R)};return(R,L)=>(_(),y("div",Ls,[(_(!0),y(P,null,H(S.tabs,s=>(_(),y("div",{class:ue(["tab-item",{active:U.value===s.value}]),onClick:E=>k(s.value),key:s.value},I(s.title),11,Cs))),128))]))}},Ms=W(As,[["__scopeId","data-v-a6e0ef08"]]),Rs=_e("searchStore",{state:()=>({indeterminate:!1,checkAll:!1,checkedList:[],activeKey:"all"}),getters:{getIndeterminate(){return this.indeterminate},getCheckAll(){return this.checkAll},getCheckedList(){return this.checkedList},getActiveKey(){return this.activeKey}},actions:{setIndeterminate(S){this.indeterminate=S},setCheckAll(S){this.checkAll=S},setCheckedList(S){this.checkedList=S},setActiveKey(S){this.activeKey=S}},persist:{enabled:!0,strategies:[{key:"searchStore",storage:localStorage,paths:["indeterminate","checkAll","checkedList","activeKey"]}]}}),qs=_e("search-lirary",()=>{const S=lt(),r=X({reasoning_content:"",show_reasoning:!1,content:"",quote_file:[],id:"",finish:!1,debug:[],error:[],recall_time:0,request_time:0,loading:!1});let C=null;const U=w(0),k=w(""),R=X({context_pair:"",create_time:"",id:"",max_token:"",model_config_id:"",rerank_model_config_id:"",rerank_status:"",rerank_use_model:"",search_type:"",similarity:"",size:"",temperature:"",update_time:"",use_model:"",user_id:"",summary_switch:0}),L=(x,n)=>{if(x=="reasoning_content"){let m=r.reasoning_content||"";r.reasoning_content=m+n,r.show_reasoning=!0}if(x=="sending"){let m=r.content||"";r.content=m+n}if(x=="quote_file"&&(r.quote_file=n.length>0?n:[]),x=="ai_message"){if(n.menu_json&&n.msg_type==2){let m=JSON.parse(n.menu_json);r.question=m.question}r.id=n.id,r.content=n.content,n.quote_file&&typeof n.quote_file=="string"&&(r.quote_file=JSON.parse(n.quote_file))}x=="finish"&&(r.finish=!0),x=="debug"&&(r.debug=n.length>0?n:[]),x=="error"&&(r.error=n.length>0?n:[]),x=="recall_time"&&(r.recall_time=n||0),x=="request_time"&&(r.request_time=n||0),S.emit("updateAiMessage",r)},s=()=>{r.loading=!1};return{searchFormState:R,dialogue_id:U,openid:k,messageObj:r,getLibrarySearchFn:async()=>{C&&(C.abort(),C=null);const x=await Ne();try{let n=x.data;Object.assign(R,{...n})}catch(n){Promise.reject(n)}return x},searchMessage:(x,n,m)=>{Re(32),r.content="",r.finish=!1;let N={model_config_id:m.model_config_id,use_model:m.use_model,temperature:m.temperature,max_token:m.max_token,size:m.size,similarity:m.similarity,search_type:m.search_type,question:x,id:n.join(","),recall_type:1,summary_switch:m.summary_switch};m.rerank_status&&(N.rerank_status=m.rerank_status),m.rerank_use_model&&(N.rerank_use_model=m.rerank_use_model),m.prompt&&(N.prompt=m.prompt),m.rerank_status==1&&(N.rerank_model_config_id=m.rerank_model_config_id),C=qe(N),C.onMessage=b=>{if(b.event!=="sending"&&Ue(b),b.event=="dialogue_id"&&(U.value=b.data),b.event=="reasoning_content"&&L("reasoning_content",b.data),b.event=="sending"&&L("sending",b.data),b.event=="ai_message"){let h=JSON.parse(b.data);L("ai_message",h)}if(b.event=="quote_file"){let h=JSON.parse(b.data);L("quote_file",h)}if(b.event=="finish"&&L("finish",b.data),b.event=="debug"){let h=JSON.parse(b.data);L("debug",h)}if(b.event=="error"){let h=b.data;L("error",h)}if(b.event=="recall_time"){let h=b.data;L("recall_time",h)}},C.onClose=()=>{s(),C=null}}}}),Us={class:"chat-monitor-page"},Ns={class:"page-left"},Is={class:"toolbar-box"},Os={class:"library-checkbox-box"},Bs={class:"app-list-box"},Ts={class:"list-box",ref:"scrollContainer"},Es={class:"list-item"},zs={class:"list-item-box"},Fs={class:"library-icon"},Vs=["onClick"],Ds={class:"page-body"},Ks={__name:"index",setup(S){const r=Rs();let{getIndeterminate:C,getCheckAll:U,getCheckedList:k,getActiveKey:R}=ce(r);const L=qs(),{getLibrarySearchFn:s,searchMessage:E}=L,{messageObj:V}=ce(L),x=w(null),n=w(null),m=w("all"),N=w([{title:"全部",value:"all"},{title:"普通",value:"0"},{title:"问答",value:"2"}]),b=w({}),h=w([]),a=X({indeterminate:!1,checkAll:!1,checkedList:[]}),B=d=>{b.value=d},O=w(!1),T=async d=>{var A;O.value=!1;let $=await s();if(n.value=$.data,n.value.id||(n.value=Object.assign(b.value)),n.value,!n.value.model_config_id||!n.value.use_model)return O.value=!0,se("请在搜索设置中配置好相应配置后再使用");(A=x.value)==null||A.handleRecallTest(n.value),E(d,a.checkedList,n.value)},G=d=>{Object.assign(a,{checkedList:d.target.checked?h.value.map($=>$.id):[],indeterminate:!!a.checkedList.length&&a.checkedList.length<h.value.length}),r.setCheckedList(a.checkedList),r.setIndeterminate(a.indeterminate)},Q=d=>{r.setCheckedList(d)},i=d=>{window.open(`#/library/details/knowledge-document?id=${d}`)};ae(()=>a.checkedList,d=>{a.indeterminate=!!d.length&&d.length<h.value.length,a.checkAll=d.length>=h.value.length,r.setIndeterminate(a.indeterminate),r.setCheckAll(a.checkAll)});const u=()=>{h.value.forEach(d=>{d.type==0,d.type==2}),N.value=[{title:"全部",value:"all"},{title:"普通",value:"0"},{title:"问答",value:"2"}]},c=(d,$)=>{if($.length===0)return!1;const A=new Set(d);return $.every(M=>A.has(M))},e=(d,$)=>!$.some(A=>d.includes(A)),g=async()=>{let d=m.value==="all"?"":m.value;await Ie({type:d}).then($=>{var D;let A=$.data||[];A.forEach(v=>{v.file_size_str=Oe(v.file_size),v.avatar||(v.avatar=v.type==0?Be:Te)}),h.value=A;const M=h.value.map(v=>v.id);if((D=k.value)!=null&&D.length&&(M!=null&&M.length)){const v=k.value,z=M,Y=c(v,z),le=e(v,z),Z=v.length>=z.length&&Y,ee={checkAll:Z,indeterminate:!Z&&!le};r.$patch(ee),Object.assign(a,ee)}else{const v={checkAll:!1,indeterminate:!1};r.$patch(v),Object.assign(a,v)}a.checkedList=k.value,a.indeterminate=C.value,!U.value&&k.value.length==0&&!C.value&&R.value=="all"&&(r.setCheckAll(!0),a.checkedList=M,r.setCheckedList(M)),m.value==="all"&&u()})},p=d=>{r.setActiveKey(d),g()};return ne(async()=>{R.value&&(m.value=R.value),await g();let d=await s();n.value=d.data}),Se(()=>{}),(d,$)=>{const A=et,M=st,D=tt;return _(),y("div",Us,[t("div",Ns,[t("div",Is,[o(Ms,{tabs:N.value,value:m.value,"onUpdate:value":$[0]||($[0]=v=>m.value=v),onChange:p},null,8,["tabs","value"])]),t("div",Os,[t("div",Bs,[o(A,{checked:a.checkAll,"onUpdate:checked":$[1]||($[1]=v=>a.checkAll=v),indeterminate:a.indeterminate,onChange:G},{default:f(()=>$[3]||($[3]=[q(" 全选/取消 ")])),_:1,__:[3]},8,["checked","indeterminate"])]),o(D,{value:a.checkedList,"onUpdate:value":$[2]||($[2]=v=>a.checkedList=v),onChange:Q},{default:f(()=>[t("div",Ts,[(_(!0),y(P,null,H(h.value,v=>(_(),y("div",{class:"list-item-wraapper",key:v.id},[t("div",Es,[o(A,{value:v.id},null,8,["value"]),t("div",zs,[t("div",Fs,[o(M,{preview:!1,width:32,src:v.avatar},null,8,["src"])]),t("div",{class:"library-name",onClick:z=>i(v.id)},I(v.library_name),9,Vs)])])]))),128))],512)]),_:1},8,["value"])])]),t("div",Ds,[o(ws,{ref_key:"searchBoxRef",ref:x,onDefaultParmas:B,onSearch:T,isError:O.value,messageObj:F(V),librarySearchData:n.value,library_ids:a.checkedList},null,8,["isError","messageObj","librarySearchData","library_ids"])])])}}},Ws=W(Ks,[["__scopeId","data-v-23754b52"]]);export{Ws as default};
