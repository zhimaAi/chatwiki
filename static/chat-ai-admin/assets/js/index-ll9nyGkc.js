import{_ as te,d as _e,ai as qe,c as De,bf as Pe}from"../../index-CB2DywzJ.js";import{ac as s,ad as t,as as e,az as m,ai as ee,F as A,ax as z,at as v,e as Q,f as U,ae as N,n as re,k as r,ar as y,B as He,G as P,u as E,A as Ne,y as be,J as fe,q as Se,w as pe,ah as ze,b as Ce,I as Ve,r as Le,av as je,aw as ke,aB as Je,o as Qe,aA as Ke}from"./vue-chunks-CGLjTDrY.js";import{u as We}from"./useEventBus-CB_rGuu7.js";import{u as we}from"./chat-BQmtIBXf.js";import{_ as he,V as Ge}from"./voice-message-aqbqTNw7.js";import{M as Ye}from"./multiple-message-DvHk6dXx.js";import{u as Me}from"./robot-BQqgDPGj.js";import{al as Te,a5 as ye,aq as Xe,v as Ie,ay as $e,b as ce,$ as Ze,ah as ae,aA as Ee,M as Fe,e as et,I as tt,O as st,y as ot,z as nt,V as lt,F as at,B as Re,m as it,af as rt,n as ct,a6 as ut}from"./ui-antd-BHaxN-GS.js";import{_ as Ae}from"./cu-scroll-D9utH_KS.js";import{q as _t}from"./other-BrZCAsTs.js";import{u as dt}from"./index-DxgALpad.js";import{i as pt}from"./index-D4Gl6KHo.js";import{V as mt}from"./vue3-pdf-embed-DPaah1_2.js";import{ac as vt}from"./index-CoChppVN.js";import"./neo4j-CSfpjqgw.js";import"./utils-pAinW4BS.js";import"./useIM-DVqx3ZzC.js";import"./pull-up.esm-DIiTC7VE.js";import"./observe-dom.esm-B25JyVKH.js";import"./vue-pdf-embed-Bj6uRJ-9.js";const gt={class:"guess-you-want"},ft={class:"message-tabs"},ht={key:1,class:"v-line"},yt={key:0,class:"message-menus"},bt=["onClick"],kt={key:1,class:"message-menus"},wt=["onClick"],$t={__name:"guess-you-want",props:{item:{type:Object,default:()=>{}},common_question_list:{type:Object,default:()=>[]},enable_common_question:{type:Boolean,default:!1}},emits:["clickMeun"],setup(T,{emit:w}){const C=w,n=T,I=(u,o)=>{u.question_tabkey=o},f=u=>{C("clickMeun",u)};return(u,o)=>(t(),s("div",gt,[e("div",ft,[n.item.guess_you_want?(t(),s("div",{key:0,onClick:o[0]||(o[0]=l=>I(n.item,1)),class:ee(["tab-item",{active:n.item.question_tabkey==1}])}," 猜你想问 ",2)):m("",!0),n.item.guess_you_want&&n.common_question_list&&n.enable_common_question?(t(),s("div",ht)):m("",!0),n.common_question_list&&n.enable_common_question?(t(),s("div",{key:2,onClick:o[1]||(o[1]=l=>I(n.item,2)),class:ee(["tab-item",{active:n.item.question_tabkey==2}])}," 常见问题 ",2)):m("",!0)]),n.item.question_tabkey==1?(t(),s("div",yt,[(t(!0),s(A,null,z(n.item.guess_you_want,(l,_)=>(t(),s("div",{onClick:a=>f(l),class:"menu-item",key:_},v(l),9,bt))),128))])):(t(),s("div",kt,[(t(!0),s(A,null,z(T.common_question_list,(l,_)=>(t(),s("div",{onClick:a=>f(l),class:"menu-item",key:_},v(l),9,wt))),128))]))]))}},xt=te($t,[["__scopeId","data-v-253226a8"]]),qt={class:"text-message"},St={__name:"text-message",props:{message:String},setup(T){return(w,C)=>(t(),s("div",qt,v(T.message),1))}},Ct={class:"message-list-wrapper"},Lt={class:"message-list"},Mt=["id","data-msg_type"],Tt={class:"itme-left"},It=["src"],Et={class:"itme-right"},Ft={class:"item-body"},Rt={key:0,class:"message-content"},At=["src"],Ot={key:1,class:"message-content"},Ut=["id"],Bt={class:"itme-left"},Dt=["src"],Pt={class:"itme-right"},Ht={key:0,class:"reply-list"},Nt={key:0,class:"reply-item reply-text"},zt=["innerHTML"],Vt={key:1,class:"reply-item reply-image"},jt={class:"message-content"},Jt=["src"],Qt={key:2,class:"reply-item reply-url"},Kt={class:"url-row"},Wt=["href"],Gt={key:3,class:"reply-item reply-card"},Yt={class:"card-row"},Xt=["src"],Zt={class:"card-title-box"},es={class:"card-title"},ts={key:4,class:"reply-item reply-imageText"},ss=["href"],os=["src"],ns={class:"imageText-text"},ls={class:"imageText-title"},as={class:"imageText-desc"},is={key:5,class:"reply-item reply-smartMenu"},rs={class:"smart-menu-box"},cs={key:0,class:"card-title"},us={class:"card-text"},_s={key:0,class:"line-text"},ds={key:1,class:"empty-line"},ps=["innerHTML"],ms=["onClick"],vs={key:0},gs={class:"label-flex-block"},fs={key:0,class:"thinking-label-wrapper"},hs={class:"thinking-label"},ys={class:"label-text"},bs=["onClick"],ks={class:"label-text"},ws=["onClick"],$s={class:"label-text"},xs={key:1,class:"item-body"},qs={key:0,class:"file-items"},Ss=["onClick"],Cs={class:"file-name"},Ls={key:0},Ms={key:1},Ts={key:1,class:"thinking-content"},Is={class:"message-content"},Es={class:"message-menus"},Fs=["onClick"],Rs=["innerHTML"],As={class:"message-menus"},Os=["onClick"],Us={key:4,class:"message-content"},Bs=["src"],Ds={key:5,class:"message-action-wrap"},Ps={key:0,class:"message-action"},Hs={class:"action-btn"},Ns=["onClick"],zs={key:2},Vs={__name:"message-list",props:{messages:{type:Array,default:()=>[]},robotInfo:{type:Object,default:()=>{}}},emits:["clickMsgMeun","scroll","scrollStart","scrollEnd","openPromptLog","openLibrary"],setup(T,{expose:w,emit:C}){const n=Me(),I=Q(()=>n.robotInfo.tips_before_answer_content),f=Q(()=>n.robotInfo.tips_before_answer_switch=="true"),u=C,o=T,l=d=>{d.show_reasoning=!d.show_reasoning},_=d=>{d.show_quote_file=!d.show_quote_file},a=Q(()=>o.robotInfo.common_question_list.length?JSON.parse(o.robotInfo.common_question_list):[]),c=Q(()=>(o.robotInfo.chat_type==1||o.robotInfo.chat_type==3)&&o.robotInfo.application_type=="0"),q=d=>{u("clickMsgMeun",d)},B=U(null),g={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let J=null,D=!1;function $(d){D||(J&&(clearTimeout(J),J=null),J=setTimeout(()=>{g.scrollTop-d.target.scrollTop>0&&(g.scrollDirection="up"),g.scrollTop-d.target.scrollTop<0&&(g.scrollDirection="down"),g.scrollTop=d.target.scrollTop,g.scrollHeight=d.target.scrollHeight,g.clientHeight=d.target.clientHeight,u("scroll",{...g}),Math.abs(g.scrollTop)<=g.scrollStartDiff&&g.scrollDirection==="up"&&x(),Math.abs(g.scrollHeight-g.scrollTop-g.clientHeight)<=g.scrollEndDiff&&g.scrollDirection==="down"&&b()},50))}function x(){o.messages.length!=0&&u("scrollStart",{msg:o.messages[0]})}function b(){o.messages.length!=0&&u("scrollEnd",{msg:o.messages[o.messages.length-1]})}const h=()=>{B.value&&be(()=>{D=!0,B.value.scrollTop=B.value.scrollHeight+1,setTimeout(()=>{g.scrollTop=B.value.scrollTop,D=!1},50)})};function V(d,L){be(()=>{D=!0,L||(L="top");let F=B.value,R=document.querySelector("#msg-"+d);L=="top"?F.scrollTop=R.offsetTop:F.scrollTop=R.offsetTop-F.clientHeight+R.clientHeight,setTimeout(()=>{g.scrollTop=B.value.scrollTop,D=!1},50)})}function W(){g.scrollTop=0,g.scrollDirection=""}function G(d){return!!(d.quote_file&&d.quote_file.length>0||d.debug&&d.debug.length>0)}function Y(d){u("openPromptLog",fe(d))}function ne(d,L,F){let R=fe(d);L.message_id=L.message_id||F,R.forEach(H=>{H.message_id=H.message_id||F}),u("openLibrary",R,fe(L))}function k(d){try{return d?Array.isArray(d)?d:typeof d=="string"?JSON.parse(d||"[]"):[]:[]}catch{return[]}}function X(d){const L=[];return(Array.isArray(d)?d:[]).forEach(F=>{const R=String((F==null?void 0:F.menu_type)||""),H=String((F==null?void 0:F.content)||"");if(R==="0")if(H==="")L.push({kind:"newline"});else if(/<a[\s\S]*?<\/a>/.test(H)){const se=/href\s*=\s*['"]\s*#\s*['"]/i.test(H)?H.replace(/href\s*=\s*['"]\s*#\s*['"]/ig,'href="javascript:;"'):H.replace(/href=/ig,'target="_blank" href=');L.push({kind:"html",html:se})}else L.push({kind:"text",text:H});else R==="1"&&L.push({kind:"keyword",text:H,serial_no:(F==null?void 0:F.serial_no)||""})}),L.slice(0,20)}function S(d){var R,H;const L=(H=(R=d.target)==null?void 0:R.closest)==null?void 0:H.call(R,"a");if(!L)return;const F=String(L.getAttribute("href")||"");(F==="#"||F==="javascript:;")&&(d.preventDefault(),d.stopPropagation())}function j(d){const L=String(d||"").trim();L&&u("clickMsgMeun",L)}const me=d=>!(k(d.reply_content_list).length&&d.content=="");return w({scrollToBottom:h,scrollToMessage:V,resetScroll:W}),(d,L)=>{const F=Te,R=_e,H=Ie,se=Se("viewer");return t(),s("div",Ct,[e("div",{class:"scroll-box",ref_key:"scrollBoxRef",ref:B,onScroll:$},[e("div",Lt,[(t(!0),s(A,null,z(o.messages,i=>(t(),s(A,{key:i.uid},[i.is_customer==1?(t(),s("div",{key:0,class:"message-item user-message",id:"msg-"+i.uid,"data-msg_type":i.msg_type},[e("div",Tt,[e("img",{class:"user-avatar",src:i.avatar},null,8,It)]),e("div",Et,[e("div",Ft,[i.msg_type==3?(t(),s("div",Rt,[re(e("img",{class:"msg-img",src:i.media_id_to_oss_url,alt:""},null,8,At),[[se]])])):i.msg_type==99?(t(),s("div",Ot,[r(Ye,{message:i.content},null,8,["message"])])):(t(),N(St,{key:2,class:"message-content",message:i.content},null,8,["message"]))])])],8,Mt)):(t(),s("div",{key:1,class:"message-item robot-message",id:"msg-"+i.uid},[e("div",Bt,[r(F,{size:"small",spinning:i.loading},{default:y(()=>[e("img",{class:"robot-avatar",src:i.robot_avatar},null,8,Dt)]),_:2},1032,["spinning"])]),e("div",Pt,[k(i.reply_content_list).length?(t(),s("div",Ht,[(t(!0),s(A,null,z(k(i.reply_content_list),(p,Z)=>{var ie;return t(),s(A,{key:Z},[(p.reply_type||p.type)==="text"?(t(),s("div",Nt,[e("div",{class:"message-content",innerHTML:p.description},null,8,zt)])):(p.reply_type||p.type)==="image"?(t(),s("div",Vt,[e("div",jt,[re(e("img",{class:"msg-img",src:p.pic||p.thumb_url},null,8,Jt),[[se]])])])):(p.reply_type||p.type)==="url"?(t(),s("div",Qt,[e("div",Kt,[e("a",{class:"url-link",href:p.url,target:"_blank"},v(p.url),9,Wt)])])):(p.reply_type||p.type)==="card"?(t(),s("div",Gt,[e("div",Yt,[p.thumb_url?(t(),s("img",{key:0,src:p.thumb_url,class:"card-thumb"},null,8,Xt)):m("",!0),e("div",Zt,[r(R,{class:"think-icon",name:"applet"}),e("span",es,v(p.title),1)])])])):(p.reply_type||p.type)==="imageText"?(t(),s("div",ts,[e("a",{class:"imageText-row",href:p.url,target:"_blank"},[p.thumb_url?(t(),s("img",{key:0,src:p.thumb_url,class:"imageText-thumb"},null,8,os)):m("",!0),e("div",ns,[e("div",ls,v(p.title),1),e("div",as,v(p.description),1)])],8,ss)])):(p.reply_type||p.type)==="smartMenu"?(t(),s("div",is,[e("div",rs,[p.smart_menu&&p.smart_menu.menu_description?(t(),s("div",cs,v(p.smart_menu.menu_description),1)):m("",!0),e("div",us,[(t(!0),s(A,null,z(X(((ie=p.smart_menu)==null?void 0:ie.menu_content)||[]),(K,ve)=>(t(),s("div",{key:ve,class:"reply-line",onClick:L[0]||(L[0]=ue=>S(ue))},[K.kind==="text"?(t(),s("span",_s,v(K.text),1)):K.kind==="newline"?(t(),s("div",ds)):K.kind==="html"?(t(),s("span",{key:2,innerHTML:K.html},null,8,ps)):K.kind==="keyword"?(t(),s("a",{key:3,href:"javascript:;",class:"link",onClick:He(ue=>j(K.text),["prevent"])},[K.serial_no?(t(),s("div",vs,v(K.serial_no),1)):m("",!0),P(" "+v(K.text),1)],8,ms)):m("",!0)]))),128))])])])):m("",!0)],64)}),128))])):m("",!0),e("div",gs,[f.value&&i.startLoading?(t(),s("div",fs,[e("div",hs,[r(E(ye),{class:"loading"}),e("span",ys,v(I.value),1)])])):m("",!0),i.msg_type==1&&c.value&&(!i.startLoading||!f.value)?(t(),s("div",{key:1,class:ee(["thinking-label-wrapper",{reasoning_open:i.show_quote_file}])},[e("div",{class:"thinking-label",onClick:p=>_(i)},[i.quote_loading?(t(),s(A,{key:0},[r(E(ye),{class:"loading"}),L[1]||(L[1]=e("span",{class:"label-text"},"正在检索知识库...",-1))],64)):m("",!0),i.quote_loading?m("",!0):(t(),s(A,{key:1},[r(R,{class:"think-icon",name:"quote-file"}),e("span",ks,"检索到"+v(i.quote_file.length)+"个知识库文档",1)],64)),i.quote_file.length?(t(),N(R,{key:2,name:"arrow-down",class:"arrow-down"})):m("",!0)],8,bs)],2)):m("",!0),i.reasoning_content?(t(),s("div",{key:2,class:ee(["thinking-label-wrapper",{reasoning_open:i.show_reasoning}])},[e("div",{class:"thinking-label",onClick:p=>l(i)},[i.reasoning_status?(t(),N(E(ye),{key:0,class:"loading"})):(t(),N(R,{key:1,class:"think-icon",name:"think"})),e("span",$s,v(i.reasoning_status?"深度思考中...":"已完成深度思考"),1),i.reasoning_status?m("",!0):(t(),N(R,{key:2,name:"arrow-down",class:"arrow-down"}))],8,ws),r(H,null,{title:y(()=>[...L[2]||(L[2]=[P("在应用设置中关闭推理过程开关，将不再显示推理过程",-1)])]),default:y(()=>[r(E(Xe),{class:"tip"})]),_:1})],2)):m("",!0)]),me(i)?(t(),s("div",xs,[i.show_quote_file&&i.quote_file&&i.quote_file.length>0?(t(),s("div",qs,[(t(!0),s(A,null,z(i.quote_file,p=>(t(),s("div",{class:"file-item",key:p.id,onClick:Z=>ne(i.quote_file,p,i.id)},[e("a",Cs,[r(R,{class:"think-icon",name:"quote-file"}),p.file_name?(t(),s("span",Ls,v(p.file_name),1)):(t(),s("span",Ms,v(p.library_name)+"-精选",1))])],8,Ss))),128))])):m("",!0),i.show_reasoning&&i.reasoning_content?(t(),s("div",Ts,[r(he,{content:i.reasoning_content},null,8,["content"])])):m("",!0),i.msg_type==1?(t(),s(A,{key:2},[re((t(),s("div",Is,[r(he,{content:i.content},null,8,["content"])])),[[se]]),e("div",Es,[(t(!0),s(A,null,z(i.question,(p,Z)=>(t(),s("div",{class:"menu-item",onClick:ie=>q(p),key:Z},v(p),9,Fs))),128))])],64)):m("",!0),i.msg_type==2?(t(),s(A,{key:3},[i.isWelcome?(t(),N(he,{key:0,class:"markdown-content",content:i.menu_json.content},null,8,["content"])):(t(),s("div",{key:1,class:"message-content",innerHTML:i.menu_json.content},null,8,Rs)),e("div",As,[(t(!0),s(A,null,z(i.menu_json.question,(p,Z)=>(t(),s("div",{class:"menu-item",onClick:ie=>q(p),key:Z},v(p),9,Os))),128))])],64)):m("",!0),i.msg_type==3?(t(),s("div",Us,[re(e("img",{class:"msg-img",src:i.content,alt:""},null,8,Bs),[[se]])])):m("",!0),G(i)?re((t(),s("div",Ds,[i.debug&&i.debug.length>0?(t(),s("div",Ps,[e("div",Hs,[e("span",null,[e("a",{onClick:p=>Y(i)},"Prompt 日志",8,Ns)])])])):m("",!0)],512)),[[Ne,!i.question]]):m("",!0)])):m("",!0),i.voice_content&&i.voice_content.length?(t(),s("div",zs,[r(Ge,{voice_content:i.voice_content},null,8,["voice_content"])])):m("",!0),(i.guess_you_want&&i.guess_you_want.length||a.value.length&&o.robotInfo.enable_common_question=="true")&&i.question_tabkey>0?(t(),N(xt,{key:3,item:i,enable_common_question:o.robotInfo.enable_common_question=="true",common_question_list:a.value,onClickMeun:q},null,8,["item","enable_common_question","common_question_list"])):m("",!0)])],8,Ut))],64))),128))])],544)])}}},js=te(Vs,[["__scopeId","data-v-7a7b3feb"]]),Js={class:"chat-list-box"},Qs=["onClick"],Ks={class:"chat-item-title"},Ws={__name:"chat-list",props:{list:{type:Array,default:()=>[]},active:{type:[String,Number],default:""}},emits:["openChat","onScrollEnd"],setup(T,{emit:w}){const C=w,n=T,I=U(null),f=o=>{C("openChat",o)},u=()=>{C("onScrollEnd")};return pe(()=>n.list,()=>{be(()=>{I.value.refresh()})}),(o,l)=>{const _=_e;return t(),s("div",Js,[r(Ae,{ref_key:"scroller",ref:I,onOnScrollEnd:u},{default:y(()=>[e("div",null,[(t(!0),s(A,null,z(n.list,a=>(t(),s("div",{class:ee(["chat-list-item",{active:a.id==n.active}]),onClick:c=>f(a),key:a.id},[r(_,{class:"chat-item-icon",name:"message"}),e("span",Ks,v(a.subject||a.last_chat_message),1)],10,Qs))),128))])]),_:1},512)])}}},Gs=te(Ws,[["__scopeId","data-v-4b3af25b"]]),Ys={class:"file-toolbar"},Xs={class:"toolbar-left"},Zs={class:"file-list"},eo={key:0,class:"delete-btn action-btn"},to={key:1,class:"preview-btn action-btn"},so=["src"],oo={key:2,class:"progress-bar"},no={key:3,class:"error-text"},lo={__name:"file-toolbar",props:{fileList:{type:Array,default:()=>[]}},emits:["add","delete"],setup(T,{emit:w}){const C=T,n=w,I=Q(()=>C.fileList.map(o=>o.url)),f=o=>{_t({options:{toolbar:!0,initialViewIndex:o},images:I.value}).show()},u=o=>{n("delete",o)};return(o,l)=>{const _=_e;return t(),s("div",Ys,[e("div",Xs,[e("div",Zs,[(t(!0),s(A,null,z(T.fileList,(a,c)=>(t(),s("div",{key:c,class:ee(["file-item",{uploading:a.status==="uploading",error:a.status==="error"}])},[a.status=="done"||a.status=="error"?(t(),s("span",eo,[r(E($e),{class:"delete-icon",onClick:q=>u(c)},null,8,["onClick"])])):m("",!0),a.status=="done"?(t(),s("span",to,[r(_,{class:"preview-icon",name:"eye-open",onClick:q=>f(c)},null,8,["onClick"])])):m("",!0),e("img",{src:a.url,alt:"avatar"},null,8,so),l[0]||(l[0]=e("div",{class:"mask"},null,-1)),a.status==="uploading"?(t(),s("div",oo,[e("div",{class:"progress",style:ze({width:a.percent+"%"})},null,4)])):m("",!0),a.status==="error"?(t(),s("div",no,"上传失败")):m("",!0)],2))),128))])])])}}},ao=te(lo,[["__scopeId","data-v-69709643"]]),io=(T,w,C)=>new Promise((n,I)=>{dt({file:T.originFile,category:C},f=>{const u=Math.round(f.loaded*100/f.total),o=w.value.find(l=>l.uid===T.uid);if(o){const l={...o,percent:u},_=w.value.findIndex(a=>a.uid===T.uid);_!==-1&&w.value.splice(_,1,l)}}).then(f=>{const u=w.value.find(o=>o.uid===T.uid);if(u){const o={...u,percent:100,status:"done",url:f.data.link||""},l=w.value.findIndex(_=>_.uid===T.uid);l!==-1&&w.value.splice(l,1,o),n(o)}}).catch(f=>{const u=w.value.find(o=>o.uid===T.uid);if(u){const o={...u,status:"error"},l=w.value.findIndex(_=>_.uid===T.uid);l!==-1&&w.value.splice(l,1,o)}I(f)})});function ro(T){const{limit:w=10,maxSize:C=10,accept:n="image/*",multiple:I=!0,category:f,fileList:u=U([])}=T||{};if(!f)throw new Error("category is required");let o=null;const l=c=>{let q=Array.from(c.target.files);const B=w-u.value.length;if(B<=0){ce.error(`最多只能上传 ${w} 张图片`);return}q.length>B&&(q=q.slice(0,B),ce.error(`最多只能上传 ${w} 张图片，已为您选择前 ${B} 张`)),q.forEach(g=>{if(!(g.size/1024/1024<C)){ce.error(`文件大小不能超过 ${C}MB!`);return}const D=g.type;if(!n.split(",").map(h=>h.trim()).some(h=>h.endsWith("/*")?D.startsWith(h.slice(0,-1)):D===h)){ce.error(`不支持的文件类型: ${D}`);return}const b={uid:g.uid||qe(16),name:g.name,status:"uploading",percent:0,originFile:g,url:URL.createObjectURL(g)};u.value.push(b),io(b,u,f).then(h=>{const V=u.value.findIndex(W=>W.uid===h.uid);V!==-1&&u.value.splice(V,1,h)}).catch(()=>{const h=u.value.findIndex(V=>V.uid===b.uid);h!==-1&&(u.value[h].status="error")})}),c.target.value=""},_=()=>{const c=document.createElement("input");return c.type="file",c.accept=n,c.multiple=I,c.style.display="none",c.onchange=l,document.body.appendChild(c),c},a=()=>{if(u.value.length>=w){ce.error(`最多只能上传 ${w} 张图片`);return}o||(o=_()),o.click()};return Ce(()=>{o&&document.body.contains(o)&&(document.body.removeChild(o),o=null)}),{openFileDialog:a}}const co={class:"message-input-wrapper"},uo={key:0,class:"file-toolbar-box"},_o={class:"message-input-box"},po={class:"message-action"},mo=["disabled"],vo={__name:"message-input",props:{value:{type:String,default:""},loading:{type:Boolean,default:!1},fileList:{type:Array,default:()=>[]},showUpload:{type:Boolean,default:!1}},emits:["send","update:value","update:fileList"],setup(T,{emit:w}){const C=w,n=T,{fileList:I}=Ve(n),{openFileDialog:f}=ro({limit:10,maxSize:10,category:"chat_image",fileList:I,multiple:!0,accept:"image/bmp,image/jpeg,image/png,image/tiff,image/heic,image/gif,image/webp"}),u=c=>{const q=n.fileList.filter((B,g)=>g!==c);C("update:fileList",q)},o=Q(()=>n.fileList.length>0?!1:n.loading||n.value.trim().length===0),l=c=>{C("update:value",c.target.value.trim())},_=c=>{if(c.key==="Enter"&&!c.shiftKey){if(!c.target.value.trim())return;c.preventDefault(),c.stopPropagation(),a()}else c.key==="Enter"&&c.shiftKey&&(c.preventDefault(),c.stopPropagation(),C("update:value",n.value+`
`))},a=()=>{C("send",n.value.trim())};return(c,q)=>{const B=Ze,g=_e,J=Te;return t(),s("div",co,[n.fileList.length>0?(t(),s("div",uo,[r(ao,{"file-list":n.fileList,onDelete:u},null,8,["file-list"])])):m("",!0),e("div",_o,[r(B,{class:"message-input",value:n.value,placeholder:"在此输入您想了解的内容，Shift+Enter换行","auto-size":{minRows:2,maxRows:5},onChange:l,onKeydown:_},null,8,["value"])]),e("div",po,[n.showUpload?(t(),s("div",{key:0,class:"select-file-btn",onClick:q[0]||(q[0]=(...D)=>E(f)&&E(f)(...D))},[r(g,{class:"select-file-icon",name:"circularNeedle"}),E(I).length>0?(t(),s("span",{key:0,class:ee(["file-number",{big:E(I).length>9}])},v(E(I).length),3)):m("",!0)])):m("",!0),e("button",{class:ee(["send-msg-btn",{loading:n.loading}]),disabled:o.value,onClick:a},[n.loading?(t(),N(J,{key:0,size:"small",class:"loading-action",style:{"margin-right":"4px"}})):(t(),N(g,{key:1,class:"paper-airplane",name:"paper-airplane"}))],10,mo)])])}}},go=te(vo,[["__scopeId","data-v-e330362d"]]),fo={class:"prompt-log-content"},ho={class:"prompt-log-items"},yo={class:"prompt-log-label"},bo={class:"prompt-log-item"},ko={class:"prompt-log-items"},wo={class:"prompt-log-label"},$o={class:"prompt-log-items"},xo={class:"prompt-log-label"},qo={class:"prompt-log-item"},So={class:"prompt-log-items"},Co={class:"prompt-log-label"},Lo={class:"prompt-log-item"},Mo={key:0,class:"prompt-log-items"},To={class:"prompt-log-label"},Io={class:"prompt-log-item"},Eo={key:1,class:"prompt-log-items"},Fo={class:"prompt-log-label"},Ro={class:"prompt-log-item"},Ao={class:"prompt-log-items"},Oo={class:"prompt-log-label"},Uo={class:"prompt-log-item"},Bo={__name:"prompt-log-alert",setup(T,{expose:w}){const C=U(!1),n=Le({prompt:"",library:[],context_qa:[],cur_question:"",cur_answer:"",error:""}),I=()=>{C.value=!1},f=()=>{n.prompt="",n.library=[],n.context_qa=[],n.cur_question="",n.cur_answer="",n.error="",n.recall_time="",n.request_time=""};return w({open:o=>{f(),n.error=o.error,n.recall_time=o.recall_time?(o.recall_time/1e3).toFixed(2):"",n.request_time=o.request_time?(o.request_time/1e3).toFixed(2):"";let l=o.debug||[];for(let _=0;_<l.length;_++){let a=l[_];a.type=="library"?n.library.push(a.content):a.type=="context_qa"?n.context_qa.push(a):n[a.type]=a.content}C.value=!0}}),(o,l)=>{const _=Ie,a=Ee;return t(),N(a,{class:"prompt-log-alert",open:C.value,"onUpdate:open":l[0]||(l[0]=c=>C.value=c),title:"Prompt 日志",placement:"right",width:"746px",closable:!1},{extra:y(()=>[e("span",{class:"close-btn",onClick:I},[r(E($e))])]),default:y(()=>[e("div",fo,[e("div",ho,[e("div",yo,[l[2]||(l[2]=e("span",null,"提示词 ",-1)),r(_,null,{title:y(()=>[...l[1]||(l[1]=[P("系统提示词和文档分段。",-1)])]),default:y(()=>[r(E(ae),{class:"question-icon"})]),_:1})]),e("div",bo,[e("p",null,v(n.prompt),1)]),(t(!0),s(A,null,z(n.library,(c,q)=>(t(),s("div",{class:"prompt-log-item",key:q},[e("p",null,v(c),1)]))),128))]),e("div",ko,[e("div",wo,[l[4]||(l[4]=e("span",null,"上下文 ",-1)),r(_,null,{title:y(()=>[...l[3]||(l[3]=[P("传递的历史提问消息",-1)])]),default:y(()=>[r(E(ae),{class:"question-icon"})]),_:1})]),(t(!0),s(A,null,z(n.context_qa,(c,q)=>(t(),s("div",{class:"prompt-log-item",key:q},[e("p",null,"Q："+v(c.question),1),e("p",null,"A："+v(c.answer),1)]))),128))]),e("div",$o,[e("div",xo,[l[6]||(l[6]=e("span",null,"USER ",-1)),r(_,null,{title:y(()=>[...l[5]||(l[5]=[P("本次用户的提问",-1)])]),default:y(()=>[r(E(ae),{class:"question-icon"})]),_:1})]),e("div",qo,[e("p",null,v(n.cur_question),1)])]),e("div",So,[e("div",Co,[l[8]||(l[8]=e("span",null,"ASSISTANT ",-1)),r(_,null,{title:y(()=>[...l[7]||(l[7]=[P("语言模型输出的答案",-1)])]),default:y(()=>[r(E(ae),{class:"question-icon"})]),_:1})]),e("div",Lo,[e("p",null,v(n.cur_answer),1)])]),n.recall_time>0?(t(),s("div",Mo,[e("div",To,[l[10]||(l[10]=e("span",null,"Recall time ",-1)),r(_,null,{title:y(()=>[...l[9]||(l[9]=[P("从知识库中检索到有效分段所需要的时间，包括对分段进行排序时间。",-1)])]),default:y(()=>[r(E(ae),{class:"question-icon"})]),_:1})]),e("div",Io,[e("p",null,v(n.recall_time)+"s",1)])])):m("",!0),n.request_time>0?(t(),s("div",Eo,[e("div",Fo,[l[12]||(l[12]=e("span",null,"Request time ",-1)),r(_,null,{title:y(()=>[...l[11]||(l[11]=[P("从发送问题和上下文信息给大模型到大模型开始返回答案的时间。",-1)])]),default:y(()=>[r(E(ae),{class:"question-icon"})]),_:1})]),e("div",Ro,[e("p",null,v(n.request_time)+"s",1)])])):m("",!0),e("div",Ao,[e("div",Oo,[l[14]||(l[14]=e("span",null,"Error ",-1)),r(_,null,{title:y(()=>[...l[13]||(l[13]=[P("报错信息，调用聊天接口报错时会显示。",-1)])]),default:y(()=>[r(E(ae),{class:"question-icon"})]),_:1})]),e("div",Uo,[e("p",null,v(n.error),1)])])])]),_:1},8,["open"])}}},Do=te(Bo,[["__scopeId","data-v-d8a3a35d"]]),Po={class:"library-info-content"},Ho={class:"file-list"},No=["onClick"],zo={key:0},Vo={key:1},jo={class:"document-items"},Jo={class:"document-item-header"},Qo={class:"left-box"},Ko={class:"document-title"},Wo={key:0,class:"document-title"},Go={class:"document-size"},Yo={class:"right-box"},Xo=["onClick"],Zo={class:"document-item-body"},en={class:"document-similarity"},tn={key:0,class:"document-content"},sn={key:1,class:"document-content"},on={class:"document-content"},nn={class:"fragment-img"},ln=["src"],an={class:"iframe-box"},rn={__name:"library-info-alert",setup(T,{expose:w}){const C=we(),{robot:n,user:I}=C;je();const f=U(!1),u=U([]),o=U(null),l=()=>{u.value=[],o.value=null},_=(b,h)=>{if(l(),u.value=b.map(V=>{let W=null;return V.answer_source_data&&(W=JSON.parse(V.answer_source_data)),{...V,answer_source_data:W}}),o.value=h.id,f.value=!0,h.answer_source_data){c.value=JSON.parse(h.answer_source_data)||[];return}q(h)},a=b=>{if(b.id!=o.value){if(o.value=b.id,b.answer_source_data){c.value=b.answer_source_data||[];return}q(b)}},c=U([]),q=b=>{pt({message_id:b.message_id,file_id:b.id,robot_key:n.robot_key,openid:n.openid}).then(h=>{c.value=h.data||[]})},B=()=>{let b=u.value.filter(h=>h.id==o.value)[0]||{};b.file_name?window.open(`#/library/preview?id=${o.value}`):window.open(`#/library/details/categary-manage?id=${b.library_id}`)},g=Q(()=>{let b=u.value.filter(h=>h.id==o.value)[0]||{};return b.file_name?b.file_name:b.library_name+"-精选"}),J=U(""),D=U(!1),$=b=>{D.value=!0,J.value="/manage/getLibRawFileOnePage?id="+o.value+"&page="+b.page_num+"&admin_user_id="+I.admin_user_id},x=()=>{f.value=!1};return w({open:_}),(b,h)=>{const V=_e,W=Ee,G=Ae,Y=Fe,ne=Se("viewer");return t(),s(A,null,[r(W,{class:"library-info-alert",open:f.value,"onUpdate:open":h[0]||(h[0]=k=>f.value=k),title:"答案来源",placement:"right",width:"746px",closable:!1,bodyStyle:{background:"#F2F4F7"}},{extra:y(()=>[e("span",{class:"close-btn",onClick:x},[r(E($e))])]),default:y(()=>[e("div",Po,[e("div",Ho,[(t(!0),s(A,null,z(u.value,k=>(t(),s("div",{class:ee(["file-item",{active:o.value==k.id}]),key:k.id,onClick:X=>a(k)},[k.file_name?(t(),s("span",zo,v(k.file_name),1)):(t(),s("span",Vo,v(k.library_name)+"-精选",1))],10,No))),128))]),e("div",jo,[(t(!0),s(A,null,z(c.value,k=>(t(),s("div",{class:"document-item",key:k.id},[e("div",Jo,[e("div",Qo,[e("span",Ko,"id："+v(k.id),1),k.title?(t(),s("span",Wo,v(k.title),1)):m("",!0),e("span",Go," 共"+v(k.word_total)+"个字符 ",1)]),e("div",Yo,[k.page_num>0?(t(),s("a",{key:0,onClick:X=>$(k)},"预览原文件>",8,Xo)):m("",!0),e("a",{onClick:B},"查看源文档>")])]),e("div",Zo,[e("div",en,[h[2]||(h[2]=P(" 相似度： ",-1)),r(V,{name:"similarity",style:{"font-size":"16px"}}),P(v(k.similarity),1)]),k.question?(t(),s("div",tn,"Q："+v(k.question),1)):m("",!0),k.answer?(t(),s("div",sn,"A："+v(k.answer),1)):m("",!0),e("div",on,v(k.content),1),re((t(),s("div",nn,[(t(!0),s(A,null,z(k.images,(X,S)=>(t(),s("img",{key:S,src:X,alt:""},null,8,ln))),128))])),[[ne]])])]))),128))])])]),_:1},8,["open"]),r(Y,{open:D.value,"onUpdate:open":h[1]||(h[1]=k=>D.value=k),title:g.value,footer:null,width:740},{default:y(()=>[e("div",an,[r(G,null,{default:y(()=>[r(E(mt),{source:J.value},null,8,["source"])]),_:1})])]),_:1},8,["open","title"])],64)}}},cn=te(rn,[["__scopeId","data-v-e1a41673"]]),un="/assets/img/form-modal-header-Dfjzr0xA.png",_n={class:"form-body"},dn={class:"from-footer"},pn={class:"btn-box"},mn={__name:"index",setup(T,{expose:w}){const C=ke().query,n=U(!1),I=we(),f=Q(()=>I.chat_variables||{}),u=Q(()=>(f.value.wait_variables||[]).map(x=>({...x,options:x.options?JSON.parse(x.options):[]}))),o=Q(()=>f.value.fill_variables||[]),l=Q(()=>f.value.need_fill_variable||!1),_=U(!1),a=Le({}),c=()=>{n.value=!0,o.value.forEach($=>{($.variable_type=="input_string"||$.variable_type=="input_number")&&(a[$.variable_key]=$.value||""),$.variable_type=="select_one"&&(a[$.variable_key]=$.value||void 0),$.variable_type=="checkbox_switch"&&(a[$.variable_key]=$.value==1)}),_.value=!0},q=$=>{$.forEach(x=>{(x.variable_type=="input_string"||x.variable_type=="input_number")&&(a[x.variable_key]=x.default_value||""),x.variable_type=="select_one"&&(a[x.variable_key]=x.default_value||void 0),x.variable_type=="checkbox_switch"&&(a[x.variable_key]=x.default_value==1)})},B=$=>$.max_input_length>0?+$.max_input_length:50;pe(()=>u.value,$=>{f.value,$&&q(u.value)},{deep:!0}),pe(()=>l.value,$=>{$&&(n.value=!1,_.value=!0)},{deep:!0,immediate:!0});const g=U(null),J=()=>{g.value.validate().then(()=>{let $=D(),x=`chat_prompt_variables_${C.robot_key}`;n.value?I.handleEditVariables({chat_prompt_variables:$}):localStorage.setItem(x,JSON.stringify($)),_.value=!1})};function D(){return u.value.map(x=>{let b=a[x.variable_key];return x.variable_type=="checkbox_switch"&&(b=b?1:0),{...x,value:b}})}return w({handleEdit:c}),($,x)=>{const b=tt,h=st,V=nt,W=ot,G=lt,Y=et,ne=at,k=Re,X=Fe;return t(),N(X,{wrapClassName:"variable-modal-class",open:_.value,"onUpdate:open":x[0]||(x[0]=S=>_.value=S),title:null,footer:null,closable:n.value,maskClosable:!1,width:560},{default:y(()=>[x[2]||(x[2]=e("div",{class:"modal-header"},[e("div",{class:"banner-bg"},[e("img",{src:un,alt:""})]),e("div",{class:"title"},"请先填写信息")],-1)),e("div",_n,[r(ne,{model:a,ref_key:"formRef",ref:g,layout:"vertical"},{default:y(()=>[(t(!0),s(A,null,z(u.value,S=>(t(),N(Y,{key:S.variable_key,label:S.variable_type=="checkbox_switch"?null:S.variable_name,name:S.variable_key,rules:[{required:S.must_input==1,message:`请输入${S.variable_name}`}]},{default:y(()=>[S.variable_type=="input_string"?(t(),N(b,{key:0,value:a[S.variable_key],"onUpdate:value":j=>a[S.variable_key]=j,maxLength:B(S),placeholder:"请输入"},null,8,["value","onUpdate:value","maxLength"])):m("",!0),S.variable_type=="input_number"?(t(),N(h,{key:1,style:{width:"100%"},value:a[S.variable_key],"onUpdate:value":j=>a[S.variable_key]=j,stringMode:"",maxLength:50,placeholder:"请输入"},null,8,["value","onUpdate:value"])):m("",!0),S.variable_type=="select_one"?(t(),N(W,{key:2,value:a[S.variable_key],"onUpdate:value":j=>a[S.variable_key]=j,style:{width:"100%"}},{default:y(()=>[(t(!0),s(A,null,z(S.options,j=>(t(),N(V,{value:j.label,key:j.label},{default:y(()=>[P(v(j.label),1)]),_:2},1032,["value"]))),128))]),_:2},1032,["value","onUpdate:value"])):m("",!0),S.variable_type=="checkbox_switch"?(t(),N(G,{key:3,checked:a[S.variable_key],"onUpdate:checked":j=>a[S.variable_key]=j},{default:y(()=>[P(v(S.variable_name),1)]),_:2},1032,["checked","onUpdate:checked"])):m("",!0)]),_:2},1032,["label","name","rules"]))),128))]),_:1},8,["model"])]),e("div",dn,[e("div",pn,[r(k,{onClick:J,block:"",type:"primary"},{default:y(()=>[...x[1]||(x[1]=[P("提 交",-1)])]),_:1})])])]),_:1},8,["open","closable"])}}},vn=te(mn,[["__scopeId","data-v-87d84d0c"]]),gn={class:"chat-page-wrapper"},fn={class:"chat-page-header"},hn={class:"breadcrumb-box"},yn={class:"chat-page"},bn={class:"page-left"},kn={class:"page-left-top"},wn={class:"page-left-body"},$n={class:"page-body"},xn={key:0,class:"form-banner-top"},qn={class:"chat-box-body"},Sn={style:{"padding-top":"30px"},class:"chat-box-footer"},Cn={__name:"index",setup(T){const C=ke().query,n=Me(),{getRobot:I}=n,f=Q(()=>n.robotInfo),u=We(),o=we(),l=De();let _=!0;const a=U(""),c=U([]),q=U(null),{createChat:B,sendMessage:g,getMyChatList:J,openChat:D,onGetChatMessage:$,changeRobotPrompt:x,$reset:b}=o,{messageList:h,sendLock:V,myChatList:W,robot:G,dialogue_id:Y}=Je(o),ne=Q(()=>!o.chat_variables.need_fill_variable&&o.chat_variables.fill_variables&&o.chat_variables.fill_variables.length),k=ke(),X=U(!1),S=U(!1),j=Q(()=>V.value||S.value),me=async()=>{if(!j.value){if(!a.value&&!c.value.length)return Pe("请输入消息内容");S.value=!0;try{let M=await vt({robot_key:G.value.robot_key,openid:G.value.openid,question:a.value,form_ids:G.value.form_ids,dialogue_id:Y.value});if(S.value=!1,M.data&&M.data.words)return ce.error(`提交的内容包含敏感词：[${M.data.words.join(";")}] 请修改后再提交`);let O=1,oe=a.value;if(f.value.question_multiple_switch==1){let le=[];O=99,a.value&&(le=[{type:"text",uid:qe(16),text:a.value}]),c.value.length&&c.value.map(de=>{le.push({uid:de.uid,type:"image_url",image_url:{url:de.url}})}),oe=JSON.stringify(le)}_=!0,g({message:oe,global:JSON.stringify(C),msg_type:O}),a.value="",c.value=[]}catch{S.value=!1}}},d=async()=>{_=!0,a.value="";let M=k.query||{},O=l.user_id,oe={robot_key:M.robot_key,avatar:M.avatar,name:M.name,nickname:M.nickname,is_background:1,openid:O,dialogue_id:0};Z(),await B(oe)},L=async M=>{if(Y.value==M.dialogue_id)return;_=!0;let oe={robot_key:(k.query||{}).robot_key,avatar:M.avatar,name:M.name,nickname:M.nickname,is_background:M.is_background,openid:M.openid,dialogue_id:M.id};Z(),await D(oe),await $()&&i()},F=M=>{_=!0,g({message:M})};U(!1);const R=()=>{i()},H=async()=>{_=!1;let M=h.value[0].uid;await $()&&p(M)},se=()=>{},i=()=>{q.value&&_&&q.value.scrollToBottom()},p=M=>{q.value&&q.value.scrollToMessage(M)},Z=()=>{q.value&&q.value.resetScroll()},ie=()=>{J()},K=U(null),ve=M=>{K.value.open(M)},ue=U(null),Oe=(M,O)=>{ue.value.open(M,O)},xe=U(null),Ue=()=>{xe.value.handleEdit()};return pe(()=>h.value,()=>{}),Qe(async()=>{d(),J(),await I(C.id),X.value=!0,u.on("updateAiMessage",R)}),Ce(()=>{b(),u.off("updateAiMessage",R)}),(M,O)=>{const oe=Ke("router-link"),le=ct,de=it,Be=Re;return t(),s("div",gn,[e("div",fn,[e("div",hn,[r(de,null,{default:y(()=>[r(le,null,{default:y(()=>[r(oe,{to:"/robot/list"},{default:y(()=>[...O[2]||(O[2]=[P("机器人管理",-1)])]),_:1})]),_:1}),r(le,null,{default:y(()=>[P(v(E(G).robot_name),1)]),_:1})]),_:1})])]),e("div",yn,[e("div",bn,[e("div",kn,[r(Be,{type:"primary",block:"",ghost:"",onClick:d},{default:y(()=>[r(E(ut)),O[3]||(O[3]=P(" 新建对话",-1))]),_:1})]),e("div",wn,[r(Gs,{list:E(W),active:E(Y),onOpenChat:L,onOnScrollEnd:ie},null,8,["list","active"])]),O[4]||(O[4]=e("div",{class:"page-left-footer"},null,-1))]),e("div",$n,[ne.value?(t(),s("div",xn,[O[6]||(O[6]=e("div",{class:"title"},"表单信息",-1)),e("div",{class:"edit-block",onClick:Ue},[r(E(rt)),O[5]||(O[5]=P("编辑 ",-1))])])):m("",!0),e("div",qn,[r(js,{ref_key:"messageListRef",ref:q,messages:E(h),robotInfo:f.value,onClickMsgMeun:F,onScrollStart:H,onScrollEnd:se,onOpenPromptLog:ve,onOpenLibrary:Oe},null,8,["messages","robotInfo"])]),e("div",Sn,[r(go,{value:a.value,"onUpdate:value":O[0]||(O[0]=ge=>a.value=ge),fileList:c.value,"onUpdate:fileList":O[1]||(O[1]=ge=>c.value=ge),loading:j.value,showUpload:f.value.question_multiple_switch==1,onSend:me},null,8,["value","fileList","loading","showUpload"])])]),e("div",null,[m("",!0)])]),r(Do,{ref_key:"promptLogAlertRef",ref:K},null,512),r(cn,{ref_key:"libraryInfoAlertRef",ref:ue},null,512),r(vn,{ref_key:"variableModalRef",ref:xe},null,512)])}}},Kn=te(Cn,[["__scopeId","data-v-65f2c312"]]);export{Kn as default};
