import{b as nt,b9 as ot,ba as it,b3 as ht,b1 as Q,w as gt,d as vt}from"../../index-0TFHdij1.js";import{_ as lt,C as ft,a as xt}from"./create-send-modal-dipG9kZB.js";import{f,r as ct,w as _t,o as dt,b as ut,a1 as g,_ as e,a2 as h,a5 as a,Y as i,a7 as d,F as Ct,a9 as wt,k as o,u as L,ae as $,G as T,y as St,aa as $t,ad as bt}from"./vue-chunks-CXJTX1FC.js";import{a as Tt}from"./index-lMQ5W3Uj.js";import{a2 as X,a3 as zt,a4 as At,a5 as Z,a6 as tt,a7 as et,a8 as st,a9 as Rt,aa as It}from"./index-DvPlhmYy.js";import{W as Mt,ao as mt,bq as at,aj as Dt,ah as Ot,aw as Bt,M as z,a as S,H as A,B as Ft,x as Lt,p as Et,Y as Nt,bw as Ut,D as Vt,b as Ht,c as Kt}from"./ui-antd-D3ZAJ1Vq.js";import"./utils-yZpnICoG.js";const Yt={class:"article-card"},jt=["src"],qt={key:1,class:"thumb",src:lt},Gt={class:"info"},Jt={class:"title"},Pt={class:"meta"},Wt={class:"digest"},Qt={class:"comment-header"},Xt={class:"comment-content"},Zt={class:"top-line"},te={class:"name"},ee={class:"time"},se={key:1,class:"delete-status"},ae={key:2,class:"actions"},ne={class:"text"},oe={key:0,class:"ai-reply"},ie={class:"top-line ai-reply-content"},le={class:"ai-replay-content-right"},ce={class:"ai-replay-content-right-top"},_e={class:"time"},de={key:0,class:"delete-status"},ue={key:1,class:"actions"},me={class:"text"},pe={key:0,class:"empty"},re={key:1,class:"load-more-tips"},ye={key:0},ke={key:1},he={key:1,class:"loading-box"},ge={__name:"comment-drawer",setup(U,{expose:Y}){const R=gt,V=ht,b=f(!1),u=f({}),E=f(!1),m=ct({page:1,size:20,total:0}),C=f([]),I=f(!0),M=f(!1),y=f(null);let v=null;const j=c=>{u.value={...c},b.value=!0,m.page=1,N()},N=()=>{E.value=!0,X({task_id:u.value.id,page:m.page,size:m.size}).then(c=>{const r=(c==null?void 0:c.data)||{};C.value=Array.isArray(r.list)?r.list:[],m.page=+r.page||m.page,m.size=+r.size||m.size,m.total=+r.total||C.value.length||0,I.value=C.value.length<m.total}).finally(()=>{E.value=!1})},q=c=>{z.confirm({title:"确认删除评论吗？",icon:o(A),okText:"删除",cancelText:"取消",onOk:async()=>{await zt({msg_id:c.msg_data_id,comment_id:c.user_comment_id,access_key:u.value.access_key}),S.success("删除成功"),N()}})},G=c=>{z.confirm({title:"确认删除回复吗？",icon:o(A),okText:"删除",cancelText:"取消",onOk:async()=>{await At({msg_id:c.msg_data_id,comment_id:c.user_comment_id,access_key:u.value.access_key}),S.success("删除成功"),N()}})};Y({show:j});const D=c=>c?`用户_${String(c).slice(-4)}`:"用户",J=c=>String(c.comment_type)==="1"?!0:String(c.ai_comment_result_text||"").includes("自动精选"),P=()=>{y.value&&(v=y.value.closest(".ant-drawer-body"),v&&v.addEventListener("scroll",H,{passive:!0}))},O=()=>{v&&(v.removeEventListener("scroll",H),v=null)},H=()=>{if(!I.value||M.value||!v)return;if(v.scrollTop+v.clientHeight>=v.scrollHeight-80){M.value=!0;const B=m.page+1;X({task_id:u.value.id,page:B,size:m.size}).then(t=>{const s=(t==null?void 0:t.data)||{},l=Array.isArray(s.list)?s.list:[];m.page=+s.page||B,m.size=+s.size||m.size,m.total=+s.total||m.total,C.value=C.value.concat(l),I.value=C.value.length<m.total}).finally(()=>{M.value=!1})}};return _t(b,c=>{c?(I.value=!0,M.value=!1,St(P)):O()}),dt(()=>{ot()}),ut(()=>{it()}),(c,r)=>{const B=Mt,t=mt,s=Dt,l=Ot,k=Bt;return e(),g(k,{open:b.value,"onUpdate:open":r[0]||(r[0]=_=>b.value=_),title:"查看评论",width:420,destroyOnClose:!0},{default:h(()=>[a("div",Yt,[u.value.thumb_url?(e(),i("img",{key:0,class:"thumb",src:u.value.thumb_url},null,8,jt)):(e(),i("img",qt)),a("div",Gt,[a("div",Jt,d(u.value.title),1),a("div",Pt,"所属分组："+d(u.value.group_name),1),a("div",Wt,d(u.value.digest),1)])]),a("div",Qt,d(m.total)+"条评论",1),E.value?(e(),i("div",he,[o(l)])):(e(),i("div",{key:0,class:"list-box",ref_key:"bodyAnchorRef",ref:y},[(e(!0),i(Ct,null,wt(C.value,_=>(e(),i("div",{class:"comment-item",key:_.id},[o(B,{size:40,src:L(V)},null,8,["src"]),a("div",Xt,[a("div",Zt,[a("span",te,d(D(_.open_id)),1),J(_)?(e(),g(t,{key:0,color:"#FF4D4F",style:{"margin-right":"0"}},{default:h(()=>r[1]||(r[1]=[T("精选")])),_:1,__:[1]})):$("",!0),a("span",ee,d(L(Q)(_.comment_create_time)),1),_.delete_status=="1"?(e(),i("div",se,"已删除")):(e(),i("span",ae,[o(L(at),{class:"delete-icon",onClick:x=>q(_)},null,8,["onClick"])]))]),a("div",ne,d(_.content_text),1),_.reply_comment_text?(e(),i("div",oe,[a("div",ie,[o(B,{size:32,src:L(R),style:{"flex-basis":"32px"}},null,8,["src"]),a("div",le,[a("div",ce,[r[2]||(r[2]=a("span",{class:"name ai"},"AI机器人",-1)),a("span",_e,d(L(Q)(_.reply_create_time)),1),_.delete_status=="1"?(e(),i("div",de,"已删除")):(e(),i("span",ue,[o(L(at),{class:"delete-icon",onClick:x=>G(_)},null,8,["onClick"])]))]),a("div",me,d(_.reply_comment_text),1)])])])):$("",!0)])]))),128)),C.value.length===0?(e(),i("div",pe,[o(s)])):(e(),i("div",re,[M.value?(e(),i("span",ye,"加载中...")):I.value?$("",!0):(e(),i("span",ke,"已加载全部"))]))],512))]),_:1},8,["open"])}}},ve=nt(ge,[["__scopeId","data-v-9c09c930"]]),fe={class:"group-send-wrapper"},xe={class:"toolbar"},Ce={class:"table-box"},we={key:0},Se=["onClick"],$e={class:"expanded-draft"},be=["src"],Te={key:1,class:"thumb",src:lt},ze={class:"info"},Ae={class:"title"},Re={class:"meta"},Ie={class:"digest"},Me=["onClick"],De={key:0,class:"task-cell"},Oe={class:"name"},Be={key:1,class:"send-time-cell"},Fe={key:0,class:"time"},Le={key:1,class:"time"},Ee={key:2,style:{color:"#595959"}},Ne={key:5,class:"ai-comment-cell"},Ue={class:"comment-rule-cell"},Ve={class:"rule"},He={key:0,class:"default-tag"},Ke=["onClick"],Ye=["onClick"],je={__name:"group-send",props:{appId:{type:String,default:""},accessKey:{type:String,default:""}},setup(U){const Y=$t(),R=U,V=f([]),b=f(!1),u=ct({page:1,size:10,total:0}),E={"-1":"已删除",0:"未发送",1:"发送中",2:"已发送",3:"发送失败"},m={0:"全部粉丝"},C=[{title:"群发",dataIndex:"task_name",key:"task_name"},{title:"群发时间",dataIndex:"send_time",key:"send_time"},{title:"接收者",dataIndex:"receiver",key:"receiver"},{title:"启用",dataIndex:"open_status",key:"open_status"},{title:"留言",dataIndex:"comment_status",key:"comment_status"},{title:"AI评论",dataIndex:"ai_comment_status",key:"ai_comment_status"},{title:"操作",dataIndex:"actions",key:"actions"}],I=t=>{u.page=t.current,u.size=t.pageSize,y()},M=t=>t.is_top=="1"?"row-top":"",y=()=>{b.value=!0,It({page:u.page,size:u.size,app_id:R.appId}).then(t=>{const s=(t==null?void 0:t.data)||{list:[],total:0};s.list.forEach(l=>{l.send_res=JSON.parse(l.send_res||"{}")}),V.value=s.list||[],u.total=+s.total||0}).finally(()=>{b.value=!1})},v=async t=>{if(t.is_top=="1"){z.confirm({title:"确认取消置顶？",icon:o(A),onOk:async()=>{await st({task_id:t.id,is_top:t.is_top=="1"?0:1}),S.success("已取消置顶"),y()}});return}await st({task_id:t.id,is_top:t.is_top=="1"?0:1}),S.success(t.is_top=="1"?"已取消置顶":"已置顶"),y()},j=t=>{z.confirm({title:`确认删除群发任务：${t.task_name}`,icon:o(A),onOk:async()=>{await Rt({task_id:t.id}),S.success("删除成功"),y()}})},N=async(t,s)=>{const l=s?1:0;if(!s){z.confirm({title:"确认关闭群发任务？",icon:o(A),onOk:async()=>{await Z({task_id:t.id,open_status:l}),t.open_status=String(l),S.success("已关闭群发任务"),y()}});return}await Z({task_id:t.id,open_status:l}),t.open_status=String(l),S.success("操作成功")},q=async(t,s)=>{var k,_;if(s)try{const x=await Tt({ability_type:"official_account_ai_comment"}),F=(_=(k=x==null?void 0:x.data)==null?void 0:k.user_config)==null?void 0:_.switch_status;if(String(F||"0")!=="1"){z.confirm({title:"AI评论",content:o("div",null,[o("span",{style:"color: #ff4d4f;"},"AI评论功能暂未开启"),o("span",null,"，您可到探索>功能中 去开启")]),okText:"去开启",cancelText:"取消",onOk:()=>{Y.push("/explore/index/ai-comment-management")}});return}}catch(x){console.error(x)}const l=s?1:0;if(!s){z.confirm({title:"确认关闭AI评论规则？",icon:o(A),onOk:async()=>{await et({task_id:t.id,ai_comment_status:l}),t.ai_comment_status=String(l),S.success("已关闭AI评论规则"),y()}});return}await et({task_id:t.id,ai_comment_status:l}),t.ai_comment_status=String(l),O.value&&O.value.show({...t})},G=async(t,s)=>{const l=s?1:0;if(!s){z.confirm({title:"确认关闭留言？",icon:o(A),onOk:async()=>{await tt({task_id:t.id,msg_id:t.msg_data_id,access_key:R.accessKey,comment_status:l}),t.comment_status=String(l),S.success("已关闭留言"),y()}});return}await tt({task_id:t.id,msg_id:t.msg_data_id,access_key:R.accessKey,comment_status:l}),t.comment_status=String(l),S.success("操作成功")},D=f(null),J=t=>{D.value&&D.value.show({task:t})},P=()=>{D.value&&D.value.show({})},O=f(null),H=t=>{O.value&&O.value.show({...t})},c=t=>{if(!t)return"";const s=new Date(Number(t)*1e3),l=String(s.getFullYear()).slice(2),k=String(s.getMonth()+1).padStart(2,"0"),_=String(s.getDate()).padStart(2,"0"),x=String(s.getHours()).padStart(2,"0"),F=String(s.getMinutes()).padStart(2,"0");return`${l}-${k}-${_} ${x}:${F}`};_t(()=>R.appId,()=>{u.page=1,R.appId&&y()},{immediate:!0}),dt(()=>{ot()}),ut(()=>{it()});const r=f(null),B=t=>{r.value&&r.value.show({...t})};return(t,s)=>{const l=Ft,k=vt,_=mt,x=Et,F=Nt,W=Kt,pt=Ht,rt=Vt,yt=Ut,kt=Lt;return e(),i("div",fe,[a("div",xe,[o(l,{type:"primary",onClick:P},{default:h(()=>s[0]||(s[0]=[T("创建群发")])),_:1,__:[0]})]),a("div",Ce,[o(kt,{columns:C,"data-source":V.value,loading:b.value,"row-key":"id",pagination:{current:u.page,pageSize:u.size,total:u.total,showSizeChanger:!0,pageSizeOptions:["10","20","50","100"]},onChange:I,"row-class-name":M},{headerCell:h(({column:p})=>[typeof p.title=="string"?(e(),i("span",we,d(p.title),1)):$("",!0)]),expandIcon:h(({expanded:p,onExpand:n,record:K})=>[a("span",{class:"expand-icon",onClick:w=>n(K)},[p?(e(),g(k,{key:0,name:"table-hide",size:"16px"})):(e(),g(k,{key:1,name:"table-expand",size:"16px"}))],8,Se)]),expandedRowRender:h(({record:p})=>[a("div",$e,[p.thumb_url?(e(),i("img",{key:0,class:"thumb",src:p.thumb_url},null,8,be)):(e(),i("img",Te)),a("div",ze,[a("div",Ae,d(p.title),1),a("div",Re,"所属分组："+d(p.group_name),1),a("div",Ie,d(p.digest||"暂无摘要"),1)]),a("div",{class:"expanded-meta",onClick:n=>B(p)},[o(k,{name:"comment",size:"32px",style:{color:"transparent"}}),T(" "+d(p.max_comment_id),1)],8,Me)])]),bodyCell:h(({column:p,record:n})=>{var K;return[p.key==="task_name"?(e(),i("div",De,[n.is_top=="1"?(e(),g(_,{key:0,color:"blue"},{default:h(()=>s[1]||(s[1]=[T("置顶")])),_:1,__:[1]})):$("",!0),a("span",Oe,d(n.task_name),1)])):p.key==="send_time"?(e(),i("div",Be,[a("div",{class:bt(["status-tag",{"status-sending":n.send_status=="1","status-success":n.send_status=="2"}])},[n.send_status=="-1"?(e(),g(k,{key:0,style:{color:"white"},name:"status-fail"})):n.send_status=="0"?(e(),g(k,{key:1,style:{color:"white"},name:"status-fail"})):n.send_status=="1"?(e(),g(k,{key:2,style:{color:"white"},name:"status-sending"})):n.send_status=="2"?(e(),g(k,{key:3,style:{color:"white"},name:"status-success"})):n.send_status=="3"?(e(),g(k,{key:4,style:{color:"white"},name:"status-fail"})):$("",!0),T(" "+d(E[n.send_status])+" ",1),n.send_status==="3"?(e(),g(x,{key:5,title:(K=n.send_res)==null?void 0:K.errmsg},{default:h(()=>[o(L(A),{style:{"font-size":"16px",color:"#FF4D4F"}})]),_:2},1032,["title"])):$("",!0)],2),n.send_time!="0"?(e(),i("div",Fe,"定时群发："+d(c(n.send_time)),1)):(e(),i("div",Le,"立即发送："+d(c(n.create_time)),1))])):p.key==="receiver"?(e(),i("span",Ee,d(m[n.to_user_type]||"全部粉丝"),1)):p.key==="open_status"?(e(),g(F,{key:3,checked:n.open_status=="1","checked-children":"开","un-checked-children":"关",onChange:w=>N(n,w)},null,8,["checked","onChange"])):p.key==="comment_status"?(e(),g(F,{key:4,checked:n.comment_status=="1","checked-children":"开","un-checked-children":"关",onChange:w=>G(n,w)},null,8,["checked","onChange"])):p.key==="ai_comment_status"?(e(),i("div",Ne,[o(F,{checked:n.ai_comment_status=="1","checked-children":"开","un-checked-children":"关",onChange:w=>q(n,w)},null,8,["checked","onChange"]),a("div",Ue,[a("span",Ve,[n.is_default=="1"?(e(),i("span",He,"默认")):$("",!0),T(" "+d(n.comment_rule_name||"默认规则"),1)]),a("a",{class:"edit-link",onClick:w=>H(n)},"修改",8,Ke)])])):p.key==="actions"?(e(),g(yt,{key:6,style:{gap:"16px"}},{default:h(()=>[a("a",{onClick:w=>J(n)},"编辑",8,Ye),o(rt,null,{overlay:h(()=>[o(pt,null,{default:h(()=>[o(W,{onClick:w=>v(n)},{default:h(()=>[T(d(n.is_top=="1"?"取消置顶":"置 顶"),1)]),_:2},1032,["onClick"]),o(W,{onClick:w=>j(n)},{default:h(()=>s[2]||(s[2]=[T("删 除")])),_:2,__:[2]},1032,["onClick"])]),_:2},1024)]),default:h(()=>[s[3]||(s[3]=a("a",null,"更多",-1))]),_:2,__:[3]},1024)]),_:2},1024)):$("",!0)]}),_:1},8,["data-source","loading","pagination"])]),o(ve,{ref_key:"commentDrawerRef",ref:r},null,512),o(ft,{ref_key:"commentRuleModalRef",ref:O,onUpdated:y},null,512),o(xt,{ref_key:"editSendModalRef",ref:D,"app-id":U.appId,"access-key":U.accessKey,onUpdated:y,onCreated:y},null,8,["app-id","access-key"])])}}},Ze=nt(je,[["__scopeId","data-v-3f8fcc04"]]);export{Ze as default};
