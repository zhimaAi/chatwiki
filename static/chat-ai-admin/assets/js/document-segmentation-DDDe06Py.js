import{aw as ge,f as i,o as ve,e as be,b as ye,ac as S,az as A,as as r,k as o,ar as k,u as J,ae as Se,at as U,G as N,F as H,ax as xe,av as we,aA as Le,ad as g,ai as qe}from"./vue-chunks-CGLjTDrY.js";import{S as Fe,E as ze,a as De,D as Ne}from"./edit-fragment-alert-BUG2507K.js";import{_ as Te,aD as Ee,bv as Ce,bw as Oe,bx as Ie,by as Ae,bz as Je,bA as Be}from"../../index-DxV-PNCd.js";import{al as Re,m as Ve,aB as je,M as T,b as K,n as Me,W as X}from"./ui-antd-AfNpv4wx.js";import"./empty-CzGZrENG.js";import"./model-select-CjmsccZQ.js";import"./index-w0T-47HX.js";import"./editor-code-BLYX-bNv.js";import"./index-BHRZn_CM.js";import"./index-DwtbXc27.js";import"./other-BrZCAsTs.js";import"./neo4j-L2Hgpmga.js";import"./utils-COBjqVvs.js";const Pe={key:0,class:"loading-wrap"},Qe={class:"document-segmentation"},$e={class:"breadcrumb-block"},We={class:"page-title"},Ge={class:"page-container"},Ue={class:"page-left"},He={class:"page-right"},Ke={class:"document-fragment-preview"},Xe={class:"preview-header"},Ye={class:"fragment-number"},Ze={key:1,class:"loading-box"},ea="你是一位文章分段助手，根据文章内容的语义进行合理分段，确保每个分段表述一个完整的语义，每个分段字数控制在500字左右，最大不超过1000字。请严格按照文章内容进行分段，不要对文章内容进行加工，分段完成后输出分段后的内容。",aa={__name:"document-segmentation",setup(ta){const Y=Ee(),E=ge(),C=we(),{setInitDocumentFragmentList:B}=Y,{document_id:x}=E.query,w=i(!0),L=i(1),Z=i(1);let v=!1,t={id:x,separators_no:"",chunk_size:512,not_merged_text:!1,chunk_overlap:50,is_qa_doc:0,question_lable:"",similar_label:"",answer_lable:"",enable_extract_image:!0,ai_chunk_size:5e3,ai_chunk_model:"",ai_chunk_model_config_id:"",ai_chunk_prumpt:ea,ai_chunk_task_id:""};const d=i(null),ee=e=>{typeof e.separators_no=="object"&&(e.separators_no=JSON.stringify(e.separators_no)),typeof e.father_chunk_separators_no=="object"&&(e.father_chunk_separators_no=JSON.stringify(e.father_chunk_separators_no)),typeof e.son_chunk_separators_no=="object"&&(e.son_chunk_separators_no=JSON.stringify(e.son_chunk_separators_no)),t={...t,...e},v?T.confirm({title:"提醒",icon:o(X),content:"文档片段已被编辑重新获取文档片段会丢失当前修改过的文档片段内容，确定要重新获取吗？",okText:"确定",okType:"danger",cancelText:"取消",onOk(){v=!1,D("create")},onCancel(){}}):(v=!1,D("create"))};let ae=600,R=0,V=null;const q=i({}),F=i(0),j=()=>{w.value||(w.value=!0),Ce({id:x}).then(async e=>{const{status:a}=e.data;if(F.value=e.data.library_type,q.value=e.data,t={...t,separators_no:e.data.separators_no||"[12,11]",chunk_size:+e.data.chunk_size||512,not_merged_text:e.data.not_merged_text=="true",ai_chunk_size:+e.data.ai_chunk_size||5e3,chunk_overlap:+e.data.chunk_overlap||50,is_qa_doc:F.value==2?1:0,question_lable:e.data.question_lable,similar_label:e.data.similar_label,answer_lable:e.data.answer_lable,question_column:e.data.question_column,similar_column:e.data.similar_column,answer_column:e.data.answer_column,enable_extract_image:e.data.enable_extract_image=="true",qa_index_type:+e.data.qa_index_type,chunk_type:+e.data.chunk_type,semantic_chunk_size:+e.data.semantic_chunk_size||512,semantic_chunk_overlap:+e.data.semantic_chunk_overlap||50,semantic_chunk_threshold:+e.data.semantic_chunk_threshold||90,semantic_chunk_use_model:e.data.semantic_chunk_use_model||"",ai_chunk_prumpt:e.data.ai_chunk_prumpt||"",ai_chunk_model:e.data.ai_chunk_model||"",semantic_chunk_model_config_id:e.data.semantic_chunk_model_config_id>0?e.data.semantic_chunk_model_config_id:"",ai_chunk_model_config_id:e.data.ai_chunk_model_config_id>0?e.data.ai_chunk_model_config_id:"",ai_chunk_task_id:e.data.ai_chunk_task_id||"",father_chunk_paragraph_type:+e.data.father_chunk_paragraph_type||2,father_chunk_separators_no:e.data.father_chunk_separators_no||"[12,11]",father_chunk_chunk_size:+e.data.father_chunk_chunk_size||1024,son_chunk_separators_no:e.data.son_chunk_separators_no||"[8,10]",son_chunk_chunk_size:+e.data.son_chunk_chunk_size||512},e.data.chunk_type==0&&(t={...t,separators_no:e.data.normal_chunk_default_separators_no,chunk_size:e.data.normal_chunk_default_chunk_size,not_merged_text:e.data.normal_chunk_default_not_merged_text=="true",chunk_overlap:e.data.normal_chunk_default_chunk_overlap,chunk_type:+e.data.default_chunk_type,semantic_chunk_size:+e.data.semantic_chunk_default_chunk_size,semantic_chunk_overlap:+e.data.semantic_chunk_default_chunk_overlap,semantic_chunk_threshold:+e.data.semantic_chunk_default_threshold,semantic_chunk_use_model:e.data.default_use_model||"",semantic_chunk_model_config_id:e.data.default_model_config_id>0?e.data.default_model_config_id:""}),a==0){if(R++,R>ae){T.error({title:"提醒",content:"文档解析速度慢请稍后再试"});return}setTimeout(()=>{j()},1e3)}else a==4||a==2?(w.value=!1,L.value=parseInt(e.data.is_table_file),V=e.data.library_id,F.value==2?(t.question_lable||t.question_column)&&D():D()):C.replace("/library/details?id="+e.data.library_id);e.data.is_table_file==1&&te()})};ve(async()=>{await j()});const M=i([]),te=()=>{Ie({id:x}).then(e=>{let a=[];for(let n in e.data)a.push({lable:e.data[n],value:n});M.value=a})},P=i(!1),b=i(!1),O=i(""),y=i(null);let m=null;const l=i([]),z=i([]),h=i(0),ne=be(()=>h.value<=0),D=e=>{let a={...t,semantic_chunk_model_config_id:t.semantic_chunk_model_config_id?+t.semantic_chunk_model_config_id:0,ai_chunk_model_config_id:t.ai_chunk_model_config_id?+t.ai_chunk_model_config_id:0};t.chunk_type==3&&(t.ai_chunk_task_id&&!e&&(a.ai_chunk_task_id=t.ai_chunk_task_id),e&&e==="create"&&(a.ai_chunk_preview=!0,delete a.ai_chunk_task_id));let n=Oe;return e=="create"&&(n=Be),n(a).then(_=>{var c;z.value=_.data.list||[],B(z.value),l.value=_.data.list||[],h.value=_.data.list.length||0,t.chunk_type==3&&(O.value=((c=_.data.split_params)==null?void 0:c.ai_chunk_task_id)||"",b.value=!0,d.value.reLoading=!0,y.value=null,!t.ai_chunk_task_id&&L.value!=1||e&&e==="create"?(l.value=[],h.value=0,_e()):(b.value=!1,d.value.reLoading=!1))}).finally(()=>{t.chunk_type!=3&&(d.value.reLoading=!1,d.value.saveLoading=!1)})},le=e=>{Z.value=e},ie=async()=>{var e;try{const a=await se();return a.data.err_msg?(y.value=a.data.err_msg,!0):((e=a.data.list)==null?void 0:e.length)>0?(z.value=a.data.list||[],B(z.value),l.value=a.data.list||[],h.value=a.data.list.length||0,!0):!1}catch{return y.value="请求异常，停止轮询",!0}};function oe(e){return e.split("message:")[1]}const _e=()=>{const e=async()=>{if(!await ie())m=setTimeout(e,3e3);else if(b.value=!1,d.value.reLoading=!1,d.value.saveLoading=!1,m!==null&&(clearTimeout(m),m=null),P.value&&W(),y.value){let n=oe(y.value);T.error({title:"分段失败提示",content:n?`模型调用失败，失败原因：${n}`:"模型调用失败"})}};e()},se=()=>Je({id:t.id,task_id:O.value}),Q=i(null);let u=null;const ue=(e,a)=>{let{title:n,content:_,question:c,answer:f,images:s,similar_question_list:p}=e;u=a,Q.value.open({title:n,content:_,question:c,answer:f,images:s,similar_question_list:p})},re=({title:e,content:a,question:n,answer:_,images:c,similar_question_list:f})=>{(l.value[u].title!=e||l.value[u].content!=a||l.value[u].question!=n||l.value[u].answer!=_)&&(v=!0),l.value[u].title=e,l.value[u].content=a,l.value[u].question=n,l.value[u].answer=_,l.value[u].images=c,l.value[u].similar_question_list=f?f.split(`
`):[],l.value[u].word_total=_.length+n.length+a.length},ce=e=>{T.confirm({title:"提醒",icon:o(X),content:"确定要删除这个片段吗?",okText:"确定",okType:"danger",cancelText:"取消",onOk(){v=!0,l.value.splice(e,1)},onCancel(){}})},I=i(""),de=e=>{I.value=e},$=i(!1),me=()=>{let e=d.value.formState;e=JSON.parse(JSON.stringify(e)),typeof e.separators_no=="object"&&(e.separators_no=JSON.stringify(e.separators_no)),typeof e.father_chunk_separators_no=="object"&&(e.father_chunk_separators_no=JSON.stringify(e.father_chunk_separators_no)),typeof e.son_chunk_separators_no=="object"&&(e.son_chunk_separators_no=JSON.stringify(e.son_chunk_separators_no)),t={...t,...e}},W=async()=>{if(me(),I.value)return K.error(I.value);if(t.chunk_type==3&&!l.value.length)return P.value=!0,!1;O.value!==t.ai_chunk_task_id&&delete t.ai_chunk_task_id;let e={...t,chunk_async:!0,semantic_chunk_model_config_id:t.semantic_chunk_model_config_id?+t.semantic_chunk_model_config_id:0,ai_chunk_model_config_id:t.ai_chunk_model_config_id?+t.ai_chunk_model_config_id:0,is_table_file:L.value};delete e.id;let a={id:x,chunk_async:!0,word_total:h.value,split_params:JSON.stringify(e),list:JSON.stringify(l.value)};e.is_qa_doc==1&&(a.qa_index_type=e.qa_index_type),$.value=!0,Ae(a).then(()=>{K.success("保存成功");let n=1;E.query.page&&(n=E.query.page),C.replace("/library/details?id="+V+"&page="+n)}).finally(()=>{$.value=!1}).catch(n=>{n.data&&n.data.index&&he(n.data.index)})},G=i(null),he=e=>{e=e-1;let a=G.value.querySelectorAll(".fragment-item");a.length>=e&&a[e].scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},fe=()=>{C.back()};function pe(e,a){if(t.chunk_type!=4||a==0)return!1;let n=l.value[a-1];return e.father_chunk_paragraph_number==n.father_chunk_paragraph_number}return ye(()=>{m&&(clearTimeout(m),m=null)}),(e,a)=>{const n=Re,_=Le("router-link"),c=Me,f=Ve;return g(),S(H,null,[w.value?(g(),S("div",Pe,[o(n)])):A("",!0),r("div",Qe,[r("div",$e,[o(f,null,{default:k(()=>[o(c,null,{default:k(()=>[o(_,{to:"/library/list"},{default:k(()=>[...a[0]||(a[0]=[N(" 知识库管理 ",-1)])]),_:1})]),_:1}),o(c,null,{default:k(()=>[o(_,{to:{path:"/library/details/knowledge-document",query:{id:q.value.library_id}}},{default:k(()=>[N(U(q.value.library_name)+"知识库",1)]),_:1},8,["to"])]),_:1}),o(c,null,{default:k(()=>[...a[1]||(a[1]=[N("分段设置",-1)])]),_:1})]),_:1})]),r("div",We,[o(J(je),{onClick:fe}),a[2]||(a[2]=r("span",{class:"title"},"文档分段与清洗",-1))]),r("div",Ge,[r("div",Ue,[o(Fe,{excellQaLists:M.value,libFileInfo:q.value,library_type:F.value,mode:L.value,ref_key:"segmentationSettingRef",ref:d,onChange:ee,onChangeChunkType:le,onSave:W,onValidate:de},null,8,["excellQaLists","libFileInfo","library_type","mode"])]),r("div",He,[r("div",Ke,[r("div",Xe,[a[3]||(a[3]=r("span",{class:"label-text"},"分段预览",-1)),r("span",Ye,"共"+U(h.value)+"个分段",1)]),ne.value&&!b.value?(g(),Se(De,{key:0})):A("",!0),b.value?(g(),S("div",Ze,[o(n),a[4]||(a[4]=N("数据处理中...",-1))])):A("",!0),r("div",{class:"preview-box",ref_key:"previewBoxRef",ref:G},[(g(!0),S(H,null,xe(l.value,(s,p)=>(g(),S("div",{class:qe(["fragment-item",{"fragment-father-son-item":J(t).chunk_type==4}]),key:p},[o(Ne,{chunk_type:J(t).chunk_type,father_chunk_paragraph_number:s.father_chunk_paragraph_number,number:s.number,title:s.title,content:s.content,total:s.word_total,question:s.question,answer:s.answer,images:s.images,isNeedDashedLine:pe(s,p),similar_question_list:s.similar_question_list,onDelete:ke=>ce(p),onEdit:ke=>ue(s,p)},null,8,["chunk_type","father_chunk_paragraph_number","number","title","content","total","question","answer","images","isNeedDashedLine","similar_question_list","onDelete","onEdit"])],2))),128))],512)])])]),o(ze,{ref_key:"editFragmentAlertRef",ref:Q,onOk:re},null,512)])],64)}}},pa=Te(aa,[["__scopeId","data-v-893f7382"]]);export{pa as default};
