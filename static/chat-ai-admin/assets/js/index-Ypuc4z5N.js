import{e as se,f as w,w as re,Y as u,_ as i,k as t,a5 as m,a2 as o,u as O,a7 as C,F as R,a9 as Y,ad as ce,r as oe,a1 as N,ae as $,G as h,y as pe,q as me,n as fe,o as ve,b as ke,aa as he}from"./vue-chunks-CXJTX1FC.js";import{b as J,c5 as ge,bs as ee,c6 as ye,c7 as xe,h as be,j as Ce,bb as we,c8 as Fe,c9 as $e,ca as De,cb as ze}from"../../index-0TFHdij1.js";import{P as Se}from"./page-tabs-CiJyaoEm.js";import{_ as Oe}from"./page-alert-z0sRBORa.js";import{as as Me,at as qe,a as I,F as Ie,e as Te,q as Ue,R as Ae,Q as Le,u as Ne,v as Re,T as Qe,M as K,bn as Ee,B as Pe,w as je,a0 as Be,bt as ae,ad as He,bd as Ve,E as Ye,av as Ke,b as Je,c as We,D as Ge,x as Xe,d as ne,H as Ze}from"./ui-antd-D3ZAJ1Vq.js";import{M as et}from"./model-select-Dks01hRk.js";import{I as tt}from"./import-knowledge-modal-DYjWuJ4p.js";import"./utils-yZpnICoG.js";import"./index-B551IHpY.js";import"./validate-8MtiUsxW.js";const at={class:"ant-upload-drag-icon"},nt={class:"ant-upload-hint"},st={__name:"upload-input",props:{value:{type:Array,default:()=>[]},maxCount:{type:Number,default:1},type:{type:[String,Number],default:0}},emits:["change","update:value"],setup(L,{emit:T}){const z=T,k=L;let S=["docx","txt","md"];const a=se(()=>S.map(v=>`.${v}`).join(",")),_=w([]);re(()=>k.value,v=>{_.value=v},{immediate:!0});let y=null;const x=()=>{if(_.value.length>=k.maxCount)return I.error("一次最多上传"+k.maxCount+"个文件")},f=()=>{_.value.length>k.maxCount&&I.error("一次最多上传"+k.maxCount+"个文件");let v=[..._.value];z("change",v),z("update:value",v)},b=v=>{M(v),f()},M=v=>{for(let p=0;p<_.value.length;p++)if(_.value[p].uid===v.uid){_.value.splice(p,1);break}},D=v=>{const p=v.name.split(".").pop();return S.includes(p.toLowerCase())?v.size/1024/1024<100?(_.value=[..._.value||[],v],_.value.length>k.maxCount&&(_.value=_.value.splice(0,k.maxCount)),y&&clearTimeout(y),y=setTimeout(()=>{f(),clearTimeout(y)},50),!1):(I.error("文件大小不能超过100M"),!1):(I.error("不支持的文件格式"),!1)};return(v,p)=>{const F=qe;return i(),u("div",{class:ce(["upload-input",{disabled:_.value.length>=k.maxCount}])},[t(F,{"file-list":_.value,name:"file",multiple:!0,"max-count":k.maxCount,accept:a.value,beforeUpload:D,onRemove:b,class:"ant-upload-drag"},{default:o(()=>[m("div",at,[t(O(Me))]),p[1]||(p[1]=m("div",{class:"ant-upload-text"},"点击或将文件拖拽到这里上传",-1)),m("div",nt,[m("p",null,"支持多个文档批量上传，单个文件不超过100M，最多"+C(k.maxCount)+"个文档",1),m("p",null,[p[0]||(p[0]=m("span",null,"支持文件类型：",-1)),(i(!0),u(R,null,Y(O(S),r=>(i(),u("span",{class:"ant-upload-hint-ext",key:r},"."+C(r),1))),128))])])]),_:1,__:[1]},8,["file-list","max-count","accept"]),m("div",{class:"disabled-mask",onClick:x})],2)}}},ot=J(st,[["__scopeId","data-v-530a30e2"]]),lt={key:0,class:"mt8"},it={key:1,class:"mt8"},Z=`根据user角色提供的文本，学习和分析它，并整理学习成果：
- 提出问题并给出每个问题的答案。
- 答案需详细完整，尽可能保留原文描述，可以适当扩展答案描述。
- 答案可以包含普通文字、链接、代码、表格、公示、媒体链接等 Markdown 元素。
- 最多提出 50 个问题。
- 生成的问题和答案和源文本语言相同。`,ut={__name:"upload-document",props:{separatorsOptions:{type:Array,default:()=>[]}},emits:["ok"],setup(L,{expose:T,emit:z}){const k=z,S=L,a=oe({faq_files:[],chunk_model:"",chunk_model_config_id:"",chunk_type:1,chunk_size:8e3,chunk_prompt:Z,separators_no:[12,11]}),_=w({chunk_model_config_id:[{message:"请选择提取模型",required:!0}],faq_files:[{message:"请选择文件",required:!0}]}),y=w(!1),x=()=>{y.value=!0,ge().then(r=>{let l=r.data||{chunk_model:"",chunk_model_config_id:"",chunk_size:8e3,chunk_prompt:Z,separators_no:[12,11]};a.faq_files=[],a.chunk_model=l.chunk_model,a.chunk_model_config_id=l.chunk_model_config_id,a.chunk_type=1,a.chunk_size=l.chunk_size||8e3,a.chunk_prompt=l.chunk_prompt||Z,a.separators_no=ee(l.separators_no,[12,11]),setTimeout(()=>{!a.chunk_model_config_id&&p.value.length>0&&p.value[0].children&&p.value[0].children.length&&(a.chunk_model_config_id=p.value[0].model_config_id,a.chunk_model=p.value[0].children[0].name)},500)})},f=w(!1),b=w(null),M=()=>{b.value.validate().then(()=>{D()}).catch(()=>{f.value=!1})},D=()=>{let r=new FormData;a.faq_files.forEach(l=>{r.append("faq_files",l)}),r.append("chunk_type",a.chunk_type),r.append("chunk_size",a.chunk_size),r.append("chunk_model",a.chunk_model),r.append("chunk_model_config_id",a.chunk_model_config_id),r.append("chunk_prompt",a.chunk_prompt),r.append("separators_no",JSON.stringify(a.separators_no)),f.value=!0,ye(r).then(l=>{I.success("上传成功"),k("ok"),y.value=!1}).finally(()=>{f.value=!1})},v=r=>{a.faq_files=r,b.value.validate(["faq_files"])},p=w([]),F=r=>{p.value=r,pe(()=>{})};return T({show:x}),(r,l)=>{const q=Te,Q=Ae,W=Ue,E=Le,P=Re,j=Ne,G=Qe,B=Ie,X=K;return i(),u("div",null,[t(X,{open:y.value,"onUpdate:open":l[8]||(l[8]=d=>y.value=d),"confirm-loading":f.value,title:"上传文档",width:"746px",onOk:M},{default:o(()=>[t(B,{class:"url-add-form",layout:"vertical",ref_key:"formRef",ref:b,model:a,rules:_.value},{default:o(()=>[t(q,{name:"faq_files",label:null},{default:o(()=>[t(ot,{maxCount:10,value:a.faq_files,"onUpdate:value":l[0]||(l[0]=d=>a.faq_files=d),onChange:v},null,8,["value"])]),_:1}),t(q,{name:"chunk_model_config_id",label:"提取模型"},{default:o(()=>[t(et,{modelType:"LLM",placeholder:"请选择AI大模型",modeName:a.chunk_model,"onUpdate:modeName":l[1]||(l[1]=d=>a.chunk_model=d),modeId:a.chunk_model_config_id,"onUpdate:modeId":l[2]||(l[2]=d=>a.chunk_model_config_id=d),style:{width:"100%"},onLoaded:F},null,8,["modeName","modeId"])]),_:1}),t(q,{label:"分块方式"},{default:o(()=>[t(W,{value:a.chunk_type,"onUpdate:value":l[3]||(l[3]=d=>a.chunk_type=d)},{default:o(()=>[t(Q,{value:1},{default:o(()=>l[9]||(l[9]=[h("按长度")])),_:1,__:[9]}),t(Q,{value:2},{default:o(()=>l[10]||(l[10]=[h("按分隔符")])),_:1,__:[10]})]),_:1},8,["value"]),a.chunk_type==1?(i(),u("div",lt,[t(E,{value:a.chunk_size,"onUpdate:value":l[4]||(l[4]=d=>a.chunk_size=d),min:1,max:1e4,step:1,placeholder:"请输入",style:{width:"300px"}},null,8,["value"])])):$("",!0),a.chunk_type==2?(i(),u("div",it,[t(j,{placeholder:"请选择",style:{width:"300px"},mode:"tags",value:a.separators_no,"onUpdate:value":l[5]||(l[5]=d=>a.separators_no=d)},{default:o(()=>[(i(!0),u(R,null,Y(S.separatorsOptions,d=>(i(),N(P,{value:d.no,key:d.no},{default:o(()=>[h(C(d.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])])):$("",!0)]),_:1}),a.chunk_type==2?(i(),N(q,{key:0,label:"最大长度"},{default:o(()=>[t(E,{value:a.chunk_size,"onUpdate:value":l[6]||(l[6]=d=>a.chunk_size=d),min:1,max:1e4,step:1,placeholder:"请输入",style:{width:"300px"}},null,8,["value"])]),_:1})):$("",!0),t(q,{label:"FAQ提取提示词"},{default:o(()=>[t(G,{value:a.chunk_prompt,"onUpdate:value":l[7]||(l[7]=d=>a.chunk_prompt=d),style:{height:"150px"},placeholder:"请输入"},null,8,["value"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["open","confirm-loading"])])}}},dt=J(ut,[["__scopeId","data-v-0a879b12"]]),_t={class:"list-box"},rt={class:"error-tip"},ct={class:"content-block"},pt={class:"fragment-img"},mt=["src"],ft={__name:"fail-detail",setup(L,{expose:T}){const z=w(!1),k=w([]),S=_=>{z.value=!0,k.value=[],a(_.id)},a=_=>{xe({id:_}).then(y=>{let x=y.data||[];k.value=x.map(f=>({...f,images:f.images?JSON.parse(f.images):[]}))})};return T({show:S}),(_,y)=>{const x=K,f=me("viewer");return i(),u("div",null,[t(x,{wrapClassName:"no-padding-modal",bodyStyle:{"padding-right":"24px","max-height":"650px","overflow-y":"auto"},open:z.value,"onUpdate:open":y[0]||(y[0]=b=>z.value=b),title:"提取失败分段",width:746,footer:null},{default:o(()=>[m("div",_t,[(i(!0),u(R,null,Y(k.value,b=>(i(),u("div",{class:"list-item",key:b.id},[m("div",rt,C(b.split_errmsg),1),m("div",ct,C(b.content),1),fe((i(),u("div",pt,[(i(!0),u(R,null,Y(b.images,(M,D)=>(i(),u("img",{key:D,src:M,alt:""},null,8,mt))),128))])),[[f]])]))),128))])]),_:1},8,["open"])])}}},vt=J(ft,[["__scopeId","data-v-e5fa761a"]]),kt={class:"library-page"},ht={class:"library-page-body"},gt={key:0,class:"btn-block"},yt={class:"list-box"},xt=["onClick"],bt={key:0,class:"status-block status-bule"},Ct={key:1,class:"status-block status-bule"},wt={key:2,class:"status-block status-bule"},Ft={key:3,class:"status-block status-green"},$t={key:4,class:"status-block status-red"},Dt={key:0},zt={key:1},St=["onClick"],Ot={key:1},Mt={key:2},qt=["onClick"],It={__name:"index",setup(L){const T=be(),z=he(),k=Ce();let{role_permission:S,role_type:a}=k;const _=se(()=>a==1||S.includes("UploadDocFaq")),y=w([{title:"知识库",path:"/library/list"},{title:"数据库",path:"/database/list"},{title:"文档提取FAQ",path:"/ai-extract-faq/list"},{title:"触发次数统计",path:"/trigger-statics/list"}]),x=oe({page:1,size:20,total:0}),f=w([]),b=w(!1);function M(e){return Array.isArray(e)?e.map(n=>{let c=H.value.find(g=>g.no===n);return c?c.name:n}):[]}const D=()=>{b.value=!1,Fe({...x}).then(e=>{let n=e.data.list||[];H.value,n=n.map(c=>{let g=ne(c.create_time*1e3).format("YY-MM-DD HH:mm"),U=ee(c.separators_no);return{...c,create_time_desc:g,separators_no_desc:M(U).join("、")}}),x.total=+e.data.total,f.value=n,r()}).finally(()=>{b.value=!1})},v=()=>{x.page=1,D()},p=e=>{x.page=e.current,x.size=e.pageSize,D()};let F={};const r=()=>{f.value.forEach(e=>{e.status==2&&l(e.id)})};function l(e){F[e]&&clearInterval(F[e]),F[e]=setInterval(async()=>{try{const c=(await De({id:e})).data;c.create_time_desc=ne(c.create_time*1e3).format("YY-MM-DD HH:mm");let g=ee(c.separators_no);c.separators_no_desc=M(g).join("、");const U=f.value.findIndex(V=>V.id==e);U!==-1&&f.value.splice(U,1,c),c.status!=2&&q(e)}catch{q(e)}},5e3)}function q(e){F[e]&&(clearInterval(F[e]),delete F[e])}const Q=e=>{K.confirm({title:"删除确认",icon:t(Ze),content:`是否删除该文件【${e.file_name}】?`,okText:"确定",cancelText:"取消",okType:"danger",onOk(){W(e)},onCancel(){}})},W=({id:e})=>{$e({id:e}).then(()=>{I.success("删除成功"),D()})},E=e=>{K.confirm({title:"重新分段确认",icon:null,okText:"确定",cancelText:"取消",onOk(){ze({id:e.id}).then(n=>{I.success("重新分段成功"),D()})},onCancel(){}})},P=e=>{if(e.status==2||e.status==3){z.push({path:"/ai-extract-faq/details",query:{id:e.id,file_name:e.file_name}});return}let n="无法查看文件详情";e.status==0&&(n="排队中,请稍候"),e.status==1&&(n="文档解析中,请稍候"),e.status==4&&(n="提取失败, 无法查看详情"),I.error(n)},j=w(null),G=()=>{j.value.show()},B=w(null),X=e=>{B.value.show({...e})},d=(e,n)=>{let c=T.getToken,g=`/manage/exportFAQFileAllQA?id=${n}&token=${c}&ext=${e}`;window.location.href=g},te=w(null),le=e=>{te.value.show({...e})},H=w([]),ie=async()=>{we().then(e=>{H.value=e.data||[]})};return ve(async()=>{await ie(),D()}),ke(()=>{Object.keys(F).forEach(e=>{clearInterval(F[e])}),F={}}),(e,n)=>{const c=Pe,g=je,U=Ye,V=We,ue=Je,de=Ge,_e=Xe;return i(),u(R,null,[m("div",kt,[t(Se,{class:"mb-16",tabs:y.value,active:"/ai-extract-faq/list"},null,8,["tabs"]),t(Oe,{style:{"margin-bottom":"16px"},title:"使用说明"},{default:o(()=>n[0]||(n[0]=[m("div",null,[m("p",null," 1、文档拆分成若干大段落，然后由大模型从大段落中抽取问答对。问答对类型的只是由很高的检索精度，但是大模型提取问答对的过程中也可能会导致部分细节丢失。 "),m("p",null," 2、提取成功的文档，您可以下载到本地查看（系统会自动保存成docx格式），也可以直接导入到指定的问答知识库中。 ")],-1)])),_:1,__:[0]}),m("div",ht,[_.value?(i(),u("div",gt,[t(c,{onClick:G,type:"primary",icon:t(O(Ee))},{default:o(()=>n[1]||(n[1]=[h("上传文档提取")])),_:1,__:[1]},8,["icon"])])):$("",!0),m("div",yt,[t(_e,{"data-source":f.value,loading:b.value,pagination:{current:x.page,total:x.total,pageSize:x.size,showQuickJumper:!0,showSizeChanger:!0,pageSizeOptions:["10","20","50","100"]},onChange:p,scroll:{x:800}},{default:o(()=>[t(g,{key:"file_name","data-index":"file_name",title:"原始文档",width:200},{default:o(({record:s})=>[m("a",{onClick:A=>P(s)},C(s.file_name),9,xt)]),_:1}),t(g,{key:"status",title:"状态",width:140},{default:o(({record:s})=>[s.status==0?(i(),u("div",bt,[t(O(Be)),n[2]||(n[2]=h("排队中 "))])):$("",!0),s.status==1?(i(),u("div",Ct,[t(O(ae)),n[3]||(n[3]=h("文档解析中 "))])):$("",!0),s.status==2?(i(),u("div",wt,[t(O(ae)),n[4]||(n[4]=h("提取中 "))])):$("",!0),s.status==3?(i(),u("div",Ft,[t(O(He)),n[5]||(n[5]=h("提取完成 "))])):$("",!0),s.status==4?(i(),u("div",$t,[t(O(Ve)),n[6]||(n[6]=h("提取失败 "))])):$("",!0)]),_:1}),t(g,{key:"chunk_size",title:"分块方式",width:200},{default:o(({record:s})=>[s.chunk_type==1?(i(),u("div",Dt,"按长度："+C(s.chunk_size),1)):$("",!0),s.chunk_type==2?(i(),u("div",zt,[m("div",null,"按分隔符："+C(s.separators_no_desc),1),m("div",null,"最大长度："+C(s.chunk_size),1)])):$("",!0)]),_:1}),t(g,{key:"count",title:"总分块数",width:110},{default:o(({record:s})=>[h(C(+s.success_count+ +s.fail_count),1)]),_:1}),t(g,{key:"success_count",title:"提取成功分块数",width:140},{default:o(({record:s})=>[h(C(s.success_count),1)]),_:1}),t(g,{key:"fail_count",title:"提取失败分块数",width:140},{default:o(({record:s})=>[t(U,{gap:12},{default:o(()=>[s.fail_count>0?(i(),u("a",{key:0,onClick:A=>le(s)},C(s.fail_count),9,St)):(i(),u("span",Ot,C(s.fail_count),1)),s.status==3||s.status==4?(i(),u("a",Mt,[s.fail_count>0?(i(),N(O(Ke),{key:0,onClick:A=>E(s)},null,8,["onClick"])):$("",!0)])):$("",!0)]),_:2},1024)]),_:1}),t(g,{key:"qa_count",title:"提取问答对数量",width:140},{default:o(({record:s})=>[m("a",{onClick:A=>P(s)},C(s.qa_count),9,qt)]),_:1}),t(g,{key:"create_time_desc",title:"上传时间",width:150},{default:o(({record:s})=>[h(C(s.create_time_desc),1)]),_:1}),t(g,{key:"key7",title:"操作",width:190,fixed:"right"},{default:o(({record:s})=>[t(U,{gap:16},{default:o(()=>[s.status==3?(i(),N(de,{key:0},{overlay:o(()=>[t(ue,null,{default:o(()=>[t(V,{onClick:A=>d("docx",s.id),key:"1"},{default:o(()=>n[7]||(n[7]=[h("下载为docx")])),_:2,__:[7]},1032,["onClick"]),t(V,{onClick:A=>d("xlsx",s.id),key:"2"},{default:o(()=>n[8]||(n[8]=[h("下载为xlsx")])),_:2,__:[8]},1032,["onClick"])]),_:2},1024)]),default:o(()=>[t(c,{size:"small",type:"link",style:{padding:"0"}},{default:o(()=>n[9]||(n[9]=[h("下载")])),_:1,__:[9]})]),_:2},1024)):(i(),N(c,{key:1,disabled:"",size:"small",type:"link",style:{padding:"0"}},{default:o(()=>n[10]||(n[10]=[h("下载")])),_:1,__:[10]})),t(c,{onClick:A=>X(s),disabled:s.status!=3,size:"small",type:"link",style:{padding:"0"}},{default:o(()=>n[11]||(n[11]=[h("导入问答库")])),_:2,__:[11]},1032,["onClick","disabled"]),t(c,{onClick:A=>Q(s),size:"small",type:"link",style:{padding:"0"}},{default:o(()=>n[12]||(n[12]=[h("删除")])),_:2,__:[12]},1032,["onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data-source","loading","pagination"])])])]),t(dt,{separatorsOptions:H.value,ref_key:"uploadDocumentRef",ref:j,onOk:v},null,8,["separatorsOptions"]),t(tt,{ref_key:"importKnowledgeModalRef",ref:B,onOk:D},null,512),t(vt,{ref_key:"failDetailRef",ref:te},null,512)],64)}}},Bt=J(It,[["__scopeId","data-v-971aaf92"]]);export{Bt as default};
