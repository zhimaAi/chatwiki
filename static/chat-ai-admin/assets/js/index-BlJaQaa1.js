import{_ as W,bV as K,d as Z,O as fe,C as me,bZ as ee,c as be,b_ as ye,b$ as ge,bR as he,av as ke,aW as xe}from"../../index-C1Xsov4S.js";import{r as N,e as Y,f as x,w as we,o as G,Y as b,a5 as s,k as a,a2 as o,a1 as B,ae as P,G as k,F as E,ab as ae,u as T,_ as u,a7 as U,c as te,af as Ce,ac as Se,n as Le,A as $e,y as De,B as Q,aa as Ue,J as Ie,p as X}from"./vue-chunks-DCKTEHpB.js";import{C as Oe}from"./config-page-menu-DnScj8of.js";import{u as Re}from"./index-vKYvnhYI.js";import{b as se,q as oe,u as le,al as Be,v as Pe,I as Me,B as ne,F as re,a as M,w as ze,Z as ie,M as Ae,a3 as Fe,h as je,D as Te,e as Ne,f as Ve,bC as qe,bB as Ee,y as We}from"./ui-antd-D64OvTpt.js";import{B as q,P as Ye,S as Ze,M as Ge}from"./pull-up.esm-DIiTC7VE.js";import{d as ce}from"./role_avatar-DL0r08JY.js";import"./utils-D9NMMoMR.js";const He={class:"form-box"},Je={class:"form-box-header"},Ke={class:"form-box-label"},Qe={class:"share-url-box"},Xe={__name:"permissions-form",props:{value:{type:Object,default:()=>({})},saveLoading:{type:Boolean,default:!1}},emits:["submit","update:value"],setup(z,{emit:I}){const{toClipboard:L}=Re(),$=I,f=z,l=N({access_rights:"0",share_url:void 0,library_key:""}),p=Y(()=>l.share_url+K+"/home/"+l.library_key),y=()=>{$("submit",l)},m=x([]),t=()=>{fe().then(_=>{m.value=_.data||[],l.share_url||m.value.length>0&&(l.share_url=m.value[0].url)})},D=_=>{l.access_rights=_.access_rights,l.share_url=_.share_url,l.library_key=_.library_key,(m.value.length==0||!l.share_url)&&t()},O=async()=>{if(!l.share_url){M.error("请选择自定义域名");return}let _=p.value;try{await L(_),M.success("复制成功")}catch{M.error("复制失败")}};return we(f.value,_=>{D({..._})}),G(()=>{t()}),(_,r)=>{const g=Z,S=le,i=oe,e=se,h=ze,d=Pe,A=Me,R=Be,F=ne,j=re;return u(),b("div",He,[s("div",Je,[s("div",Ke,[a(g,{name:"auth",style:{"font-size":"14px",color:"#333"}}),r[2]||(r[2]=s("span",{class:"form-box-label-text"},"访问权限",-1))]),r[3]||(r[3]=s("div",null,null,-1))]),a(j,{"label-col":{span:4},style:{width:"750px"}},{default:o(()=>[a(e,{label:"访问权限"},{default:o(()=>[a(i,{value:l.access_rights,"onUpdate:value":r[0]||(r[0]=w=>l.access_rights=w),onChange:y},{default:o(()=>[a(S,{value:"0"},{default:o(()=>[...r[4]||(r[4]=[k("私有，仅能与应用关联，作为应用知识库",-1)])]),_:1}),a(S,{value:"1"},{default:o(()=>[...r[5]||(r[5]=[k("公开，发布到互联网，所有人可访问",-1)])]),_:1})]),_:1},8,["value"])]),_:1}),l.access_rights==1?(u(),B(e,{key:0,label:"复制链接"},{default:o(()=>[s("div",Qe,[a(R,{compact:"",style:{width:"600px",display:"flex"}},{default:o(()=>[a(d,{style:{width:"250px"},value:l.share_url,"onUpdate:value":r[1]||(r[1]=w=>l.share_url=w),placeholder:"请选择自定义域名",onChange:y},{default:o(()=>[(u(!0),b(E,null,ae(m.value,w=>(u(),B(h,{value:w.url,key:w.id},{default:o(()=>[k(U(w.url),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"]),a(A,{disabled:!0,value:T(K)+"/home/"+l.library_key,style:{width:"350px"}},null,8,["value"])]),_:1}),a(F,{class:"copy-btn",onClick:O},{default:o(()=>[...r[6]||(r[6]=[k("复制",-1)])]),_:1})]),r[7]||(r[7]=s("div",null,[s("a",{href:"/#/user/domain"},"添加自定义域名")],-1))]),_:1})):P("",!0)]),_:1})])}}},ea=W(Xe,[["__scopeId","data-v-6562f3a7"]]),aa={class:"form-box"},ta={class:"collaborator-list-tip"},sa={class:"list-content"},oa={class:"collaborator-grid"},la=["onClick"],na={class:"user-info"},ra={class:"user-details"},ia={class:"user-name"},ca={class:"user-nickname"},ua={key:0,class:"loading-more"},_a={key:1,class:"no-more"},da={__name:"add-collaborator",props:{excludedIds:{type:Array,default:()=>[]}},emits:["ok"],setup(z,{expose:I,emit:L}){q.use(Ye),q.use(Ze),q.use(Ge);const $=L,f=z,l=te("libraryState",{}),p=x(!1),y=x(null),m=x(!1),t=N({permission:"2",collaborators:[]}),D={permission:[{required:!0,message:"请选择协作权限"}],collaborators:[{required:!0,message:"请选择协作者",type:"array",min:1}]},O=c=>{let n=t.collaborators.indexOf(c.id);n>-1?t.collaborators.splice(n,1):t.collaborators.push(c.id)},_=x([]),r=Y(()=>_.value.filter(c=>!f.excludedIds.includes(c.id))),g=N({page:1,size:20,total:0,search:""}),S=x(null),i=x(!1),e=x(!1);let h=x(null);const d=()=>{if(h.value){h.value.refresh();return}h.value=new q(S.value,{probeType:2,click:!0,scrollY:!0,bounce:!1,pullUpLoad:!0,scrollbar:{fade:!1,interactive:!0},mouseWheel:{speed:20,invert:!1,easeTime:300}}),h.value.on("pullingUp",A)},A=async()=>{i.value||e.value||(g.page=g.page+1,i.value=!0,await R(),h.value.finishPullUp(),i.value=!1)},R=async()=>{let c={page:g.page,size:g.size,search:g.search};return me(c).then(n=>{let v=n.data.list||[];return g.page==1?_.value=_.value=v:_.value=_.value.concat(v),g.total=+n.data.total,_.value.length>=g.total&&(e.value=!0),De(()=>{h.value&&h.value.refresh()}),n})},F=()=>{let c={operate_rights:t.permission,user_ids:t.collaborators.join(","),type:1,library_key:l.library_key};m.value=!0,ee(c).then(()=>{p.value=!1,m.value=!1,$("ok",c),M.success("添加成功")}).catch(()=>{m.value=!1})},j=async()=>{var c;try{await((c=y.value)==null?void 0:c.validate()),F()}catch(n){console.error("表单验证失败:",n)}},w=()=>{var c;(c=y.value)==null||c.resetFields(),p.value=!1};return I({open:()=>{var c;p.value=!0,(c=y.value)==null||c.resetFields(),g.page=1,R(),setTimeout(()=>{d()},200)}}),(c,n)=>{const v=le,V=oe,J=se,ue=Ce("RouterLink"),_e=Z,de=ie,pe=re,ve=Ae;return u(),B(ve,{open:p.value,"onUpdate:open":n[1]||(n[1]=C=>p.value=C),title:"添加协作者",width:"760px",confirmLoading:m.value,onOk:j,onCancel:w},{default:o(()=>[s("div",aa,[a(pe,{layout:"vertical",model:t,rules:D,ref_key:"formRef",ref:y},{default:o(()=>[a(J,{name:"permission",label:"协作权限"},{default:o(()=>[a(V,{value:t.permission,"onUpdate:value":n[0]||(n[0]=C=>t.permission=C)},{default:o(()=>[a(v,{value:"4"},{default:o(()=>[...n[2]||(n[2]=[k("可管理",-1)])]),_:1}),a(v,{value:"2"},{default:o(()=>[...n[3]||(n[3]=[k("可编辑",-1)])]),_:1})]),_:1},8,["value"])]),_:1}),a(J,{name:"collaborators",label:"协作者"},{default:o(()=>[s("div",ta,[n[5]||(n[5]=k(" 如果协作者没有账号，请先到团队管理中添加账号 ",-1)),a(ue,{to:"/user/manage",target:"_blank"},{default:o(()=>[...n[4]||(n[4]=[k("去添加",-1)])]),_:1})]),s("div",{class:"collaborator-list",ref_key:"listRef",ref:S},[s("div",sa,[s("div",oa,[(u(!0),b(E,null,ae(r.value,C=>(u(),b("div",{class:Se(["collaborator-item",{active:t.collaborators.includes(C.id)}]),key:C.id,onClick:Pa=>O(C)},[Le(a(_e,{name:"check-arrow-filled",class:"check-icon"},null,512),[[$e,t.collaborators.includes(C.id)]]),s("div",na,[a(de,{class:"user-avatar",src:C.avatar||T(ce)},null,8,["src"]),s("div",ra,[s("div",ia,U(C.user_name),1),s("div",ca,U(C.nick_name),1)])])],10,la))),128))]),i.value?(u(),b("div",ua,"加载中...")):P("",!0),e.value?(u(),b("div",_a,"没有更多了")):P("",!0)])],512)]),_:1})]),_:1},8,["model"])])]),_:1},8,["open","confirmLoading"])}}},pa=W(da,[["__scopeId","data-v-49f98487"]]),va={class:"collaborator-list-box"},fa={class:"list-tools-box"},ma={class:"list-label"},ba={class:"label-text"},ya={class:"tools-box-right"},ga={class:"list-box"},ha={key:0,class:"name-cell"},ka={class:"user-info"},xa={class:"username"},wa={class:"nickname"},Ca={key:0,class:"role-cell"},Sa={key:1,class:"role-cell"},La={key:1},$a={__name:"collaborator-list",setup(z){const I=be(),L=te("libraryState",{}),$=x(null),f=[{title:"姓名",key:"name",width:"40%"},{title:"角色",dataIndex:"role",key:"role",width:"40%"},{title:"操作",key:"action",width:"20%"}],l={4:{label:"可管理",value:"4"},2:{label:"可编辑",value:"2"}},p=N({current:1,pageSize:999,total:0}),y=x([]),m=Y(()=>y.value.map(i=>i.user_id)),t=(i,e)=>{e.operate_rights=i.key*1,e.operate_rights_label=l[e.operate_rights].label||"",D(e)},D=i=>{let e={operate_rights:i.operate_rights,user_ids:i.user_id,type:2,library_key:L.library_key};ee(e).then(()=>{M.success("修改成功")}).catch(()=>{})},O=()=>{$.value.open()},_=i=>{let e={id:i.id,library_key:L.library_key};ge(e).then(()=>{M.success("移除成功"),S()}).catch(()=>{})},r=()=>{S()},g=i=>{Object.assign(p,i),S()},S=()=>{ye({library_key:L.library_key,page:p.current,size:p.pageSize}).then(i=>{let e=i.data.list||[],{user_id:h}=I.userInfo;p.total=i.data.total,e.forEach(d=>{d.showDelete=!0,h==d.user_id&&(d.showDelete=!1),d.role_type==1&&(d.showDelete=!1),d.operate_rights=d.operate_rights*1,d.operate_rights_label="无权限",l[d.operate_rights]&&(d.operate_rights_label=l[d.operate_rights].label)}),y.value=e})};return G(()=>{S()}),(i,e)=>{const h=Z,d=ne,A=ie,R=Ve,F=Ne,j=je,w=Ee,H=qe,c=We;return u(),b("div",va,[s("div",fa,[s("div",ma,[a(h,{name:"collaborator"}),s("span",ba,"协助权限 ("+U(p.total)+")",1)]),s("div",ya,[a(d,{type:"primary",size:"small",onClick:O},{default:o(()=>[a(T(Fe)),e[2]||(e[2]=k(" 添加协助者",-1))]),_:1})])]),s("div",ga,[a(c,{columns:f,"data-source":y.value,pagination:p,onChange:g},{bodyCell:o(({column:n,record:v})=>[n.key==="name"?(u(),b("div",ha,[a(A,{class:"avatar",src:v.avatar||T(ce)},null,8,["src"]),s("div",ka,[s("div",xa,U(v.user_name),1),s("div",wa,U(v.nick_name),1)])])):P("",!0),n.key==="role"?(u(),b(E,{key:1},[v.showDelete?(u(),b("div",Ca,[a(j,null,{overlay:o(()=>[a(F,{onClick:V=>t(V,v)},{default:o(()=>[(u(),B(R,{key:4},{default:o(()=>[...e[3]||(e[3]=[k("可管理",-1)])]),_:1})),(u(),B(R,{key:2},{default:o(()=>[...e[4]||(e[4]=[k("可编辑",-1)])]),_:1}))]),_:1},8,["onClick"])]),default:o(()=>[s("a",{class:"dropdown-label",onClick:e[0]||(e[0]=Q(()=>{},["prevent"]))},[k(U(v.operate_rights_label)+" ",1),a(T(Te),{style:{"font-size":"12px"}})])]),_:2},1024)])):(u(),b("div",Sa,[s("a",{class:"dropdown-label disabled",onClick:e[1]||(e[1]=Q(()=>{},["prevent"]))},U(v.operate_rights_label),1)]))],64)):P("",!0),n.key==="action"?(u(),b(E,{key:2},[v.showDelete?(u(),B(H,{key:0},{default:o(()=>[a(w,{title:"确定要移除此协作者吗?","ok-text":"确定","cancel-text":"取消",onConfirm:V=>_(v)},{default:o(()=>[...e[5]||(e[5]=[s("a",{href:"#"},"移除",-1)])]),_:1},8,["onConfirm"])]),_:2},1024)):(u(),b("span",La,[a(d,{style:{padding:"0"},type:"link",disabled:""},{default:o(()=>[...e[6]||(e[6]=[k("移除",-1)])]),_:1})]))],64)):P("",!0)]),_:1},8,["data-source","pagination"])]),a(pa,{excludedIds:m.value,ref_key:"addCollaboratorRef",ref:$,onOk:r},null,8,["excludedIds"])])}}},Da=W($a,[["__scopeId","data-v-bd0b2d18"]]),Ua={class:"permissions-page"},Ia={class:"page-container"},Oa={class:"form-box-wrapper"},Ra={class:"collaborator-list-wrapper"},Ba={__name:"index",setup(z){const I=he(),L=Ue(),$=Y(()=>L.query.library_id),f=N({type:1,library_intro:"",library_name:"",model_config_id:"",model_define:"",use_model:"",is_offline:!1,access_rights:"0",share_url:"",library_key:"",avatar:"",avatar_file:""});X("libraryState",f),X("updateState",t=>{Object.assign(f,t)});const l=x(!1),p=t=>{Object.assign(f,t),l.value=!0,y().then(()=>{l.value=!1}).catch(()=>{l.value=!1})},y=async()=>{let t={...Ie(f)};delete t.library_key,t.avatar_file?(t.avatar=t.avatar_file,delete t.avatar_file):(delete t.avatar,delete t.avatar_file),await xe(t),I.getLibraryInfo(),M.success("修改成功")},m=()=>{ke({id:$.value}).then(t=>{Object.assign(f,t.data)})};return G(()=>{m()}),(t,D)=>(u(),b("div",Ua,[a(Oe),s("div",Ia,[s("div",Oa,[a(ea,{value:f,"onUpdate:value":D[0]||(D[0]=O=>f=O),saveLoading:l.value,onSubmit:p},null,8,["value","saveLoading"])]),s("div",Ra,[f.library_key?(u(),B(Da,{key:0})):P("",!0)])])]))}},qa=W(Ba,[["__scopeId","data-v-3344cec9"]]);export{qa as default};
