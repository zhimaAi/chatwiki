import{_ as re,bi as ae,d as ne}from"../../index-WMhSApoa.js";import{f as Y,aw as se,e as le,r as ue,w as M,o as oe,ac as D,k as s,as as m,ar as n,av as ie,ad as f,at as h,G as o,ae as v,az as k,u as U,F as q,ax as I}from"./vue-chunks-CGLjTDrY.js";import{M as _e}from"./multi-reply-BNWxgO4B.js";import{H as de,G as pe}from"./index-CHNVlDjk.js";import{m as ye,F as me,d as w,n as fe,e as ve,Q as be,v as ge,ah as ce,y as ke,z as we,w as xe,x as Ae,X as Re,bt as Ye,O as Se,B as Ce,a6 as Me,b as x}from"./ui-antd-BDReVt-O.js";import"./neo4j-CK9lNpyi.js";import"./utils-DXEytJvC.js";import"./other-BrZCAsTs.js";import"./index-CxGFxpsV.js";import"./index-CtAh6k0_.js";const De={class:"subManage-edit"},he=["href"],Ue={class:"main"},Be={class:"ml4"},Ne={class:"item-box"},Oe={class:"flex-center"},Pe={class:"nav-box",style:{"margin-top":"24px"}},qe={class:"reply-content-box"},Ie={class:"radio-container"},Te={class:"btn-container"},ze={__name:"add-rule",setup(Fe){const B=Y([]),A=se().query,R=Y(+A.rule_id||+A["rule-id"]||0),y=Y(A.subscribe_rule_type||"subscribe_reply_duration"),T=ie(),z=le(()=>`/#/explore/index/subscribe-reply?subscribe_rule_type=${y.value}`),N=Y(null),e=ue({duration_type:"day",reply_period:[],priority_num:null,week_day:["1"],week_duration:["1"],date_range:[],start_day:"",end_day:"",reply_num:"0",message_type:"0",message_type_list:[],reply_interval:0,switch_status:!0,subscribe_source:[]}),F={name:[{required:!0,message:"请输入规则名称",trigger:"blur"}]},H=ae;function j(l,t){return e.duration_type!=="time_range"||Array.isArray(t)&&t.length===2&&t[0]&&t[1]?Promise.resolve():Promise.reject("请选择起止日期")}function V(l,t){return e.duration_type!=="week"||Array.isArray(t)&&t.length>0?Promise.resolve():Promise.reject("请选择至少一个星期")}M(()=>e.duration_type,l=>{l==="week"?((!Array.isArray(e.week_day)||e.week_day.length===0)&&(e.week_day=["1"]),e.week_duration=Array.isArray(e.week_day)?e.week_day:[e.week_day]):l==="time_range"&&Array.isArray(e.date_range)&&e.date_range.length===2&&e.date_range[0]&&e.date_range[1]?(e.start_day=w(e.date_range[0]).format("YYYY-MM-DD"),e.end_day=w(e.date_range[1]).format("YYYY-MM-DD")):(e.start_day="",e.end_day="")}),M(()=>e.week_day,l=>{e.duration_type==="week"&&(e.week_duration=Array.isArray(l)?l:[l])}),M(()=>e.date_range,l=>{e.duration_type==="time_range"&&Array.isArray(l)&&l.length===2&&l[0]&&l[1]&&(e.start_day=w(l[0]).format("YYYY-MM-DD"),e.end_day=w(l[1]).format("YYYY-MM-DD"))});const d=Y([{type:"text",description:""}]),$=()=>{if(d.value.length>=5){x.warning("最多添加5条回复内容");return}d.value.push({type:"text",description:""})},E=l=>{const{reply_index:t,..._}=l;t>=0&&t<d.value.length&&(d.value[t]=_)},G=l=>{d.value.splice(l,1)},J=()=>{};function L(l){return(l||[]).map(t=>({...t,status:"1"}))}function Q(l){const t={text:"2",image:"4",card:"3",imageText:"1",url:"5",smartMenu:"6"};return l.map(_=>t[_.type]||"").filter(Boolean)}const W=()=>{var l;(l=N.value)==null||l.validate().then(async()=>{if(!d.value.length){x.warning("请至少添加一条回复内容");return}if(y.value==="subscribe_reply_duration"){if(!e.reply_period||e.reply_period.length!==2){x.warning("请选择回复时段");return}const r=Number(e.priority_num);if(!Number.isInteger(r)||r<1||r>100){x.warning("优先级需为1-100之间的整数");return}if(e.duration_type==="time_range"&&!(Array.isArray(e.date_range)&&e.date_range.length===2&&e.date_range[0]&&e.date_range[1])){x.warning("请选择自定义日期范围");return}}for(const r of B.value)if(r&&r.validate&&!await r.validate())return;const t={appid:A.appid||"",switch_status:e.switch_status?"1":"0",rule_type:y.value,reply_content:JSON.stringify(L(d.value)),reply_type:Q(d.value),reply_num:e.reply_num};let _={};y.value==="subscribe_reply_duration"?_={duration_type:e.duration_type,start_day:e.start_day,end_day:e.end_day,reply_interval:Number(e.reply_interval)||0,week_duration:e.week_duration,priority_num:Number(e.priority_num)||0,start_duration:Array.isArray(e.reply_period)&&e.reply_period[0].toString()||"",end_duration:Array.isArray(e.reply_period)&&e.reply_period[1].toString()||""}:_={subscribe_source:Array.isArray(e.subscribe_source)?e.subscribe_source.join(","):e.subscribe_source||""};const b={...t,..._};R.value&&(b.id=R.value);try{const r=await pe(b);r&&r.res==0&&(x.success("保存成功"),T.push({path:"/explore/index/subscribe-reply",query:{subscribe_rule_type:y.value}}))}catch{}})};return oe(async()=>{const l=+(A.copy_id||0),t=async _=>{const b=await de({id:_}),r=(b==null?void 0:b.data)||{};if(y.value=(r==null?void 0:r.rule_type)||y.value,e.switch_status=String((r==null?void 0:r.switch_status)||"0")==="1",e.duration_type=(r==null?void 0:r.duration_type)||e.duration_type,e.duration_type==="week"){const a=Array.isArray(r==null?void 0:r.week_duration)?r.week_duration.map(c=>String(c)):[];e.week_day=a.length?a:["1"],e.week_duration=[...e.week_day]}if(e.duration_type==="time_range"||e.duration_type==="day"){const a=(r==null?void 0:r.start_day)||"",c=(r==null?void 0:r.end_day)||"";a&&c&&(e.date_range=[w(a),w(c)])}const g=(r==null?void 0:r.start_duration)||"",p=(r==null?void 0:r.end_duration)||"";e.reply_period=[g,p].filter(Boolean).length===2?[g,p]:[],e.start_duration=g,e.end_duration=p,e.priority_num=Number((r==null?void 0:r.priority_num)||e.priority_num||0);const i=r==null?void 0:r.subscribe_source;if(Array.isArray(i))e.subscribe_source=i;else if(typeof i=="string")try{const a=JSON.parse(i);e.subscribe_source=Array.isArray(a)?a:i?i.split(",").filter(Boolean):[]}catch{e.subscribe_source=i?i.split(",").filter(Boolean):[]}e.reply_interval=Number((r==null?void 0:r.reply_interval)||0);const S=Array.isArray(r==null?void 0:r.reply_content)?r.reply_content:[];d.value=S.map(a=>({type:(a==null?void 0:a.type)||(a==null?void 0:a.reply_type)||"text",description:(a==null?void 0:a.description)||"",thumb_url:(a==null?void 0:a.thumb_url)||(a==null?void 0:a.pic)||"",title:(a==null?void 0:a.title)||"",url:(a==null?void 0:a.url)||"",appid:(a==null?void 0:a.appid)||"",page_path:(a==null?void 0:a.page_path)||"",smart_menu_id:(a==null?void 0:a.smart_menu_id)||"",smart_menu:(a==null?void 0:a.smart_menu)||{}})),e.reply_num=String((r==null?void 0:r.reply_num)??e.reply_num)};try{if(!R.value&&l){await t(l);return}if(!R.value)return;await t(R.value)}catch{}}),(l,t)=>{const _=fe,b=ye,r=ge,g=be,p=ve,i=we,S=ke,a=Ae,c=xe,X=Re,K=Ye,O=Se,Z=ne,P=Ce,ee=me;return f(),D("div",De,[s(b,{class:"subManage-breadcrumb"},{default:n(()=>[s(_,null,{default:n(()=>[m("a",{href:z.value},h(y.value==="subscribe_reply_duration"?"按时段设置":"按关注来源设置"),9,he)]),_:1}),s(_,null,{default:n(()=>[...t[9]||(t[9]=[o("新增规则",-1)])]),_:1})]),_:1}),m("div",Ue,[s(ee,{ref_key:"formRef",ref:N,model:e,rules:F},{default:n(()=>[s(p,{name:"switch_status",rules:[{required:!0,message:"请输入规则名称"}]},{label:n(()=>[t[11]||(t[11]=o(" 是否开启 ",-1)),s(r,null,{title:n(()=>[...t[10]||(t[10]=[o("开启开关后，触发消息类型回复指定的内容",-1)])]),default:n(()=>[m("span",Be,[s(U(ce))])]),_:1})]),default:n(()=>[s(g,{checked:e.switch_status,"onUpdate:checked":t[0]||(t[0]=u=>e.switch_status=u),"checked-children":"开","un-checked-children":"关"},null,8,["checked"])]),_:1}),y.value==="subscribe_reply_source"?(f(),v(p,{key:0,name:"subscribe_source",label:"关注来源",rules:[{required:!0,message:"请选择关注来源"}]},{default:n(()=>[s(S,{value:e.subscribe_source,"onUpdate:value":t[1]||(t[1]=u=>e.subscribe_source=u),mode:"multiple",style:{width:"480px"},placeholder:"请选择关注来源",allowClear:"",showSearch:""},{default:n(()=>[(f(!0),D(q,null,I(U(H),u=>(f(),v(i,{key:u.value,value:u.value},{default:n(()=>[o(h(u.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1})):k("",!0),y.value==="subscribe_reply_duration"?(f(),v(p,{key:1,name:"duration_type",label:"选择回复时间"},{default:n(()=>[m("div",Ne,[s(p,{name:"duration_type",rules:[{required:!0,message:"请选择回复时间类型"}]},{default:n(()=>[s(c,{value:e.duration_type,"onUpdate:value":t[2]||(t[2]=u=>e.duration_type=u)},{default:n(()=>[s(a,{value:"week"},{default:n(()=>[...t[12]||(t[12]=[o("每星期",-1)])]),_:1}),s(a,{value:"day"},{default:n(()=>[...t[13]||(t[13]=[o("每天",-1)])]),_:1}),s(a,{value:"time_range"},{default:n(()=>[...t[14]||(t[14]=[o("自定义时间",-1)])]),_:1})]),_:1},8,["value"])]),_:1}),e.duration_type==="week"?(f(),v(p,{key:0,name:"week_day",rules:[{validator:V}]},{default:n(()=>[s(S,{value:e.week_day,"onUpdate:value":t[3]||(t[3]=u=>e.week_day=u),mode:"multiple",style:{width:"200px"},allowClear:""},{default:n(()=>[s(i,{value:"1"},{default:n(()=>[...t[15]||(t[15]=[o("星期一",-1)])]),_:1}),s(i,{value:"2"},{default:n(()=>[...t[16]||(t[16]=[o("星期二",-1)])]),_:1}),s(i,{value:"3"},{default:n(()=>[...t[17]||(t[17]=[o("星期三",-1)])]),_:1}),s(i,{value:"4"},{default:n(()=>[...t[18]||(t[18]=[o("星期四",-1)])]),_:1}),s(i,{value:"5"},{default:n(()=>[...t[19]||(t[19]=[o("星期五",-1)])]),_:1}),s(i,{value:"6"},{default:n(()=>[...t[20]||(t[20]=[o("星期六",-1)])]),_:1}),s(i,{value:"7"},{default:n(()=>[...t[21]||(t[21]=[o("星期日",-1)])]),_:1})]),_:1},8,["value"])]),_:1},8,["rules"])):k("",!0),e.duration_type==="time_range"?(f(),v(p,{key:1,name:"date_range",rules:[{validator:j}]},{default:n(()=>[s(X,{value:e.date_range,"onUpdate:value":t[4]||(t[4]=u=>e.date_range=u),format:"YYYY-MM-DD"},null,8,["value"])]),_:1},8,["rules"])):k("",!0)])]),_:1})):k("",!0),y.value==="subscribe_reply_duration"?(f(),v(p,{key:2,name:"reply_period",label:"回复时段",rules:[{required:!0,message:"请选择回复时段"}]},{default:n(()=>[s(K,{value:e.reply_period,"onUpdate:value":t[5]||(t[5]=u=>e.reply_period=u),valueFormat:"HH:mm",format:"HH:mm",allowClear:!1},null,8,["value"]),t[22]||(t[22]=m("div",{class:"tip-box"}," 如需跨天，请单独重新再添加一条时段回复：第一个是到23:59结束，第二个是从0点开始 ",-1))]),_:1})):k("",!0),y.value==="subscribe_reply_duration"?(f(),v(p,{key:3,name:"priority_num",label:"优先级",rules:[{required:!0,message:"输入优先级，1-100之间"}]},{default:n(()=>[s(O,{value:e.priority_num,"onUpdate:value":t[6]||(t[6]=u=>e.priority_num=u),style:{width:"200px"},min:1,max:100},null,8,["value"]),t[23]||(t[23]=m("div",{class:"tip-box",style:{color:"red"}}," 数字越小，则优先级越高。优先级仅在时间相互冲突时有效，比如一个每天1-9点与一个每天310点，当8点钟触发时，则只会触发其中优先级最高的一个。 ",-1))]),_:1})):k("",!0),y.value==="subscribe_reply_duration"?(f(),v(p,{key:4,class:"interval-item",name:"reply_interval",label:"触发回复间隔时间"},{default:n(()=>[m("div",Oe,[s(O,{value:e.reply_interval,"onUpdate:value":t[7]||(t[7]=u=>e.reply_interval=u),style:{width:"60px"}},null,8,["value"]),t[24]||(t[24]=m("span",{class:"ml4"},"秒 在时间间隔内只会触发一次该回复，0秒为无时间间隔限制",-1))])]),_:1})):k("",!0),m("div",Pe,[s(Z,{name:"reply-content",style:{"font-size":"16px"}}),t[25]||(t[25]=o(" 回复内容 ",-1))]),m("div",qe,[(f(!0),D(q,null,I(d.value,(u,C)=>(f(),v(_e,{key:C,ref_for:!0,ref_key:"replyRefs",ref:B,value:d.value[C],"onUpdate:value":te=>d.value[C]=te,reply_index:C,onChange:E,onDel:G},null,8,["value","onUpdate:value","reply_index"]))),128)),s(P,{type:"dashed",style:{width:"694px"},disabled:d.value.length>=5,onClick:$},{icon:n(()=>[s(U(Me))]),default:n(()=>[o(" 添加回复内容("+h(d.value.length)+"/5) ",1)]),_:1},8,["disabled"])]),s(p,{name:"reply_num",label:"回复方式",style:{"margin-top":"24px"}},{default:n(()=>[m("div",Ie,[s(c,{value:e.reply_num,"onUpdate:value":t[8]||(t[8]=u=>e.reply_num=u),onChange:J},{default:n(()=>[s(a,{value:"0"},{default:n(()=>[...t[26]||(t[26]=[o("全部回复",-1)])]),_:1}),s(a,{value:"1"},{default:n(()=>[...t[27]||(t[27]=[o("随机回复一条",-1)])]),_:1})]),_:1},8,["value"])])]),_:1}),m("div",Te,[s(P,{type:"primary",onClick:W},{default:n(()=>[...t[28]||(t[28]=[o("保存",-1)])]),_:1})])]),_:1},8,["model"])])])}}},Xe=re(ze,[["__scopeId","data-v-5152963c"]]);export{Xe as default};
