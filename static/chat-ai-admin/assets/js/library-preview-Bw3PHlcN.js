import{b as $e,d as Ze,bp as vn,aW as Ot,aw as Et,aV as It,ax as Rt,aK as gn,ay as hn,bd as Tt,bu as kn,be as yn,bf as bn,bh as Sn,bv as wn,e as Mt,bw as xn,h as Cn,bx as $n,aC as Ct,by as Ln,bz as qn,bg as On}from"../../index-OnalErht.js";import{Y as v,_ as l,a5 as a,k as t,a2 as s,u as Y,f as u,r as Le,o as Be,ae as B,a7 as oe,F as fe,a9 as xe,y as Ge,ab as Ue,e as ke,b as Pt,q as ot,G as q,a6 as De,B as ye,n as st,a1 as j,ad as zt,aa as Ft,af as En}from"./vue-chunks-Ci-XTWEs.js";import{_ as In}from"./empty-CzGZrENG.js";import{z as Dt,B as Nt,au as Rn,ah as Je,M as be,$ as Tn,H as Ee,p as Ke,a3 as Mn,bm as Ve,bn as Ht,b as lt,c as it,ai as At,D as rt,av as Bt,a5 as Ut,a as he,F as Pn,e as zn,u as Jt,v as jt,w as Fn,bs as Dn,ac as Nn,bb as Hn,y as An,i as Bn,ax as Un,bx as Jn,q as jn,Y as Qn,j as Gn,I as Vn,g as $t,N as Wn,Z as Zn}from"./ui-antd-BgeWxFcI.js";import{C as Qt,S as Kn}from"./classification-mark-modal-BoHWGxDy.js";import{Z as Yn,f as Xn,a as ea,P as ta,H as na,C as aa,b as oa}from"./cu-scroll-BSuggAPn.js";import{c as We,E as sa}from"./edit-subsection-Cb32iH-p.js";import{_ as Ae}from"./cu-scroll-BmUgdtgQ.js";import{R as la}from"./rename-modal-Bb0QQcZy.js";import{V as Lt}from"./vue3-pdf-embed-DNcosj3W.js";import{S as ia,a as ra,D as ua,E as ca}from"./edit-fragment-alert-WD4ImmqT.js";import"./utils-ChQO-_r6.js";import"./index-Ds5Umk46.js";import"./pull-up.esm-D94Swpvl.js";import"./observe-dom.esm-CyCedSm-.js";import"./index-DIhX1V7E.js";import"./index-BdOGHXRM.js";import"./util-BwuffJOK.js";import"./index-BbXKX7WL.js";import"./index-DXDs1xHg.js";import"./index-BMSQkwth.js";import"./vue-pdf-embed-B4woVYJb.js";import"./model-select-BWi4a3Y6.js";const _a={class:"empty-box"},da={__name:"empty",props:{detailsInfo:{type:Object}},emits:["openEditSubscription"],setup(re,{emit:le}){const $=le,G=()=>{$("openEditSubscription",{})};return(m,d)=>{const _=Nt;return l(),v("div",_a,[d[1]||(d[1]=a("img",{src:In,alt:""},null,-1)),d[2]||(d[2]=a("div",{class:"title"},"知识库文档为空，请添加分段",-1)),a("div",null,[t(_,{type:"primary",onClick:G},{icon:s(()=>[t(Y(Dt))]),default:s(()=>[d[0]||(d[0]=a("span",null,"添加分段",-1))]),_:1,__:[0]})])])}}},at=$e(da,[["__scopeId","data-v-16e77398"]]),pa={class:"chart-wrapper"},fa={class:"zoom-toolbar-wrapper"},ma={__name:"chart-box",emits:["nodeClick"],setup(re,{expose:le,emit:$}){const G=$,m=u(null);let d=null;const _=Le({nodes:[],edges:[]}),F=u(1),D={},N=()=>{d&&d.destroy();const w={layout:"forceDirected",initialZoom:F.value,disableTelemetry:!0,maxZoom:10,minZoom:.1,minimapContainer:document.getElementById("chatMap"),styling:{minimapViewportBoxColor:"#4399FF",selectedBorderColor:"rgba(255, 255, 255, 1)"}},y=document.getElementById("chartBox");d=new Xn(y,_.nodes,_.edges,w,D);const p=new ea(d);new ta(d),p.updateCallback("onZoom",C=>{F.value=Number(C.toFixed(1))}),new na(d,{drawShadowOnHover:!0}),new aa(d,{selectOnClick:!0}).updateCallback("onNodeClick",C=>{G("nodeClick",C)})},O=w=>{F.value=w,d&&d.setZoom(w)},k=({nodes:w,edges:y})=>{_.nodes=[_.nodes,...w],_.edges=[_.edges,...y],d&&d.addElementsToGraph(w,y)},X=({nodes:w,edges:y})=>{_.nodes=[_.nodes,...w],_.edges=[_.edges,...y],d&&d.addAndUpdateElementsInGraph(w,y)},b=({nodes:w,edges:y})=>{_.nodes=w,_.edges=y,d&&d.updateElementsInGraph(w,y)},I=()=>{d&&d.destroy()},ee=({nodes:w,edges:y})=>{_.nodes=w,_.edges=y,N()};return Be(()=>{}),le({render:ee,add:k,addAndUpdate:X,update:b,destroy:I}),(w,y)=>(l(),v("div",pa,[a("div",{class:"chart",id:"chartBox",ref_key:"chartBox",ref:m},null,512),y[0]||(y[0]=a("div",{class:"chart-mini-map",id:"chatMap"},null,-1)),a("div",fa,[t(Yn,{value:F.value,onChange:O},null,8,["value"])])]))}},va=$e(ma,[["__scopeId","data-v-04d10c54"]]),ga={key:0,class:"popup-wrapper entity-details-wrapper"},ha={class:"popup-header"},ka={key:0,class:"popup-body"},ya={class:"popup-content"},ba={class:"entity-details"},Sa={class:"entity-item"},wa={class:"entity-name"},xa={class:"entity-item",style:{"margin-bottom":"8px"}},Ca={class:"file-info"},$a={class:"file-name"},La={class:"entity-item"},qa={class:"doc-item"},Oa={class:"fragment-content"},Ea={class:"entity-item"},Ia={key:0,class:""},Ra={class:"fragment-content"},Ta={__name:"entity-details",setup(re,{expose:le}){const $=Le({show:!1,node:null,fromNodes:[]}),G=()=>{$.show=!1};return le({open:(d,_)=>{$.node=d,$.fromNodes=_,$.show?($.show=!1,Ge(()=>{$.show=!0})):$.show=!0},close:G}),(d,_)=>{const F=Ze;return $.show?(l(),v("div",ga,[a("div",ha,[_[0]||(_[0]=a("div",{class:"popup-title"},"实体详情",-1)),t(Y(Rn),{class:"close-btn",onClick:G})]),$.node?(l(),v("div",ka,[t(oa,null,{default:s(()=>[a("div",ya,[a("div",ba,[a("div",Sa,[_[1]||(_[1]=a("div",{class:"entity-item-header"},[a("div",{class:"entity-item-label"},"实体")],-1)),a("div",wa,oe($.node.name),1)]),a("div",xa,[_[2]||(_[2]=a("div",{class:"entity-item-header"},[a("div",{class:"entity-item-label"},"归属文档")],-1)),a("div",Ca,[t(F,{class:"file-icon",name:"doc-file",style:{}}),a("span",$a,oe($.node.file_name),1)])]),a("div",La,[_[3]||(_[3]=a("div",{class:"entity-item-header"},[a("div",{class:"entity-item-label"},"分段")],-1)),a("div",null,[a("div",qa,[a("div",Oa,oe($.node.content),1)])])]),a("div",Ea,[_[4]||(_[4]=a("div",{class:"entity-item-header"},[a("div",{class:"entity-item-label"},"子图")],-1)),a("div",null,[$.fromNodes.length==0?(l(),v("div",Ia,"无")):B("",!0),(l(!0),v(fe,null,xe($.fromNodes,D=>(l(),v("div",{class:"subgraph-item",key:D.id},[a("div",Ra,oe(D.name),1)]))),128))])])])])]),_:1})])):B("",!0)])):B("",!0)}}},Ma=$e(Ta,[["__scopeId","data-v-a19c97a9"]]),Pa={class:"graph-model-body"},za={key:0,class:"loading-wrapper"},Fa={class:"right-box"},Da={__name:"index",setup(re,{expose:le}){const $=u(!1),G=u(null),m=u(null),d=u(null),_=u(!1),F=Le({file_id:"",data_id:""}),D=Le({edges:[],nodes:[]});let N={};const O=()=>{k()},k=()=>{_.value=!0,vn({file_id:F.file_id,data_id:F.data_id,search_term:F.search_term}).then(w=>{_.value=!1;let y=w.data.edges||[],p=w.data.nodes||[];const i=new Map;y=y.filter(h=>{const ue=`${h.from_id}_${h.to_id}`,ae=`${h.to_id}_${h.from_id}`;return i.has(ue)||i.has(ae)?!1:(i.set(ue,!0),!0)}),y.forEach(h=>{h.id=h.id.toString(),h.from=h.from_id.toString(),h.to=h.to_id.toString(),h.caption=h.label});const C=new Set(y.map(h=>h.from)),W=new Set(y.map(h=>h.to));p.forEach(h=>{h.caption=h.name,h.id=h.id.toString(),h.nodeType=C.has(h.id)&&W.has(h.id)?"both":C.has(h.id)?"from":W.has(h.id)?"to":"normal",h.nodeType==="from"?(h.size=35,h.color="#FFB1B2"):h.nodeType==="to"?(h.size=45,h.color="#005AFF"):(h.size=30,h.color="#69E9BE")});let me={edges:y,nodes:p};D.edges=me.edges,D.nodes=me.nodes,setTimeout(()=>{m.value.render(me)},0),N={},y.forEach(h=>{N[h.to]||(N[h.to]=[]),N[h.to].push(h.from)})}).catch(w=>{_.value=!1})},X=w=>{let y=N[w.id]||[],p=[];for(let i=0;i<D.nodes.length;i++)y.indexOf(D.nodes[i].id)>-1&&p.push(D.nodes[i]);d.value.open(w,p)},b=()=>{m.value.destroy(),$.value=!1},I=()=>{$.value=!1};return le({open:w=>{F.file_id=w.file_id,F.data_id=w.id,$.value=!0,setTimeout(()=>{O()},350)}}),(w,y)=>{const p=Je,i=be;return l(),v("div",{ref_key:"mymodal",ref:G},[t(i,{wrapClassName:"graph-model-wrapper",zIndex:99999,centered:"",open:$.value,"onUpdate:open":y[0]||(y[0]=C=>$.value=C),title:"知识图谱",width:"90vw",footer:null,onOk:I,onCancel:b},{default:s(()=>[a("div",Pa,[_.value?(l(),v("div",za,[t(p)])):B("",!0),t(va,{ref_key:"chartBoxRef",ref:m,loading:_.value,onNodeClick:X},null,8,["loading"]),a("div",Fa,[t(Ma,{ref_key:"entityDetailsRef",ref:d},null,512)])])]),_:1},8,["open"])],512)}}},Na=$e(Da,[["__scopeId","data-v-2b594227"]]),Ha={class:"subsection-box-title"},Aa=["onClick"],Ba={class:"top-block"},Ua={class:"title"},Ja={class:"title-block"},ja={class:"status-box"},Qa={class:"cfb363f"},Ga={class:"split-err"},Va={key:1},Wa={class:"cfb363f"},Za={class:"right-opration"},Ka={class:"hover-btn-box"},Ya=["onClick"],Xa=["onClick"],eo=["onClick"],to={class:"hover-btn-box"},no={class:"hover-btn-box"},ao=["onClick"],oo=["onClick"],so={key:0,class:"content-box"},lo=["innerHTML"],io={key:1,class:"content-box"},ro=["innerHTML"],uo=["onMouseup","innerHTML"],co={key:2,class:"fragment-img"},_o=["src"],po={__name:"subsection-box",props:{paragraphLists:{type:Array,default:()=>[]},search:{type:String,default:""},detailsInfo:{type:Object,default:()=>{}},total:{type:[Number,String],default:0}},emits:["handleDelParagraph","handleScrollTargetPage","openEditSubscription","handleConvert","getStatrList","handleSplit","handleSplitNext","handleSplitUp","handleSplitDelete","handleSegmentation"],setup(re,{expose:le,emit:$}){const G=Ue(),m=$,d=re,_=(c,r)=>{let{id:T,title:P,content:ce,question:V,answer:M,images:se,category_id:f}=c,ie=c.similar_questions||[];be.confirm({title:"重新转换确认",icon:null,content:`确定要重新转换【分段${r+1}】吗?`,onOk(){return new Promise(H=>{It({id:T,title:P,content:ce,question:V,answer:M,images:se,category_id:f,similar_questions:JSON.stringify(ie)}).then(()=>{m("handleConvert",c),H()}).catch(()=>{H()})})},onCancel(){}})},F=c=>{m("openEditSubscription",c)},D=c=>{be.confirm({title:"提示",icon:t(Ee),content:"确认是否删除该分段?",onOk(){return new Promise(r=>{Rt({id:c}).then(()=>{he.success("删除成功"),m("handleDelParagraph",c),r()}).catch(()=>{r()})})},onCancel(){}})},N=(c,r,T)=>{window.getSelection().toString().trim()||(m("handleScrollTargetPage",{page_num:c.page_num,index:r}),Ce(T))},O=c=>{m("handleSegmentation",c)},k=u([]),X=()=>{let c={file_id:G.query.id};Ot(c).then(r=>{k.value=r.data||[],m("getStatrList",r.data||[])})};X();const b=u(null),I=()=>{b.value.show()},ee=c=>{var T;let r=(T=k.value.filter(P=>P.id==c.category_id)[0])==null?void 0:T.type;return r?We[r]:""},w=(c,r={})=>{Et({id:c.id,category_id:r.id||0}).then(()=>{he.success("设置成功"),c.category_id=r.id,X()})},y=u(null),p=c=>{y.value.open(c)},i=u(null),C=u(!1),W=u({x:0,y:0}),me=u(""),h=u(null),ue=u({text:"",parentIndex:-1,originalHtml:""}),ae=ke(()=>{if(!C.value)return{};const c=162;let r=W.value.x,T=W.value.y;const P=i.value.getBoundingClientRect(),ce=window.innerWidth;r<10?r=10:r+c>ce-50&&(r=ce-c-50);const V=r-P.left,M=T;return{left:`${V}px`,top:`${M}px`}}),ve=(c,r)=>{setTimeout(()=>{const T=window.getSelection(),P=T.toString().trim();if(P){c.stopPropagation(),ue.value={text:P,parentIndex:r,originalHtml:d.paragraphLists[r].content},me.value=P,h.value=T.getRangeAt(0).cloneRange();const V=T.getRangeAt(0).getBoundingClientRect(),M=i.value.getBoundingClientRect();W.value={x:V.left+V.width/2,y:V.top-M.top-50},C.value=!0}else C.value=!1},50)},U=c=>{const{parentIndex:r}=ue.value;switch(c){case"separate":te(r);break;case"merge-next":x(r);break;case"merge-prev":ge(r);break;case"delete":Re(r);break}C.value=!1,window.getSelection().removeAllRanges()},E=(c,r,T)=>{if(r===0&&T===c.textContent.length&&c.textContent.trim().length>0)return["",c.innerHTML,""];const ce=document.createTreeWalker(c,NodeFilter.SHOW_TEXT);let V,M=0,se,f,ie,H;for(;V=ce.nextNode();){const n=V.nodeValue.length;if(!se&&M+n>=r&&(se=V,ie=r-M),!f&&M+n>=T){f=V,H=T-M;break}M+=n}const Se=document.createRange();Se.setStart(se,ie),Se.setEnd(f,H);const qe=document.createRange();qe.setStart(c,0),qe.setEnd(se,ie);const Fe=document.createRange();return Fe.setStart(f,H),Fe.setEnd(c,c.childNodes.length),[J(qe),J(Se),J(Fe)]},J=c=>{const r=document.createElement("div");return r.appendChild(c.cloneContents()),r.innerHTML},te=c=>{const r=d.paragraphLists[c].content,P=window.getSelection().getRangeAt(0);P.toString()&&be.confirm({title:"单独分段",icon:t(Ee),content:"确认将该分段内容单独分段么？分段后，原分段的内容会被删除",onOk(){const V=document.createElement("div");V.innerHTML=r;const[M,se,f]=E(V,P.startOffset,P.endOffset),ie=M.replace(/<[^>]+>/g,"").trim()==="",H=f.replace(/<[^>]+>/g,"").trim()==="";ie&&H?m("handleSplit",{index:c,beforeContent:"",selectedContent:se,afterContent:"",isFullSelection:!0}):m("handleSplit",{index:c,beforeContent:M,selectedContent:se,afterContent:f,originalSelection:{start:P.startOffset,end:P.endOffset,parentIndex:c}})}})},x=c=>{if(c>=d.paragraphLists.length-1)return he.error("没有下一个分段");const r=d.paragraphLists[c].content,P=window.getSelection().getRangeAt(0);P.toString()&&be.confirm({title:"合并到下一个分段",icon:t(Ee),content:"确认将该分段内容合并到下一个分段么？分段后，原分段的内容会被删除",onOk(){const V=document.createElement("div");V.innerHTML=r;const[M,se,f]=E(V,P.startOffset,P.endOffset),ie=M.replace(/<[^>]+>/g,"").trim()==="",H=f.replace(/<[^>]+>/g,"").trim()==="";ie&&H?m("handleSplitNext",{index:c,beforeContent:"",selectedContent:se,afterContent:"",isFullSelection:!0}):m("handleSplitNext",{index:c,beforeContent:M,selectedContent:se,afterContent:f,originalSelection:{start:P.startOffset,end:P.endOffset,parentIndex:c}})}})},ge=c=>{if(c<=0)return he.error("没有上一个分段");const r=d.paragraphLists[c].content,P=window.getSelection().getRangeAt(0);P.toString()&&be.confirm({title:"合并到上一个分段",icon:t(Ee),content:"确认将该分段内容合并到上一个分段么？分段后，原分段的内容会被删除",onOk(){const V=document.createElement("div");V.innerHTML=r;const[M,se,f]=E(V,P.startOffset,P.endOffset),ie=M.replace(/<[^>]+>/g,"").trim()==="",H=f.replace(/<[^>]+>/g,"").trim()==="";ie&&H?m("handleSplitUp",{index:c,beforeContent:"",selectedContent:se,afterContent:"",isFullSelection:!0}):m("handleSplitUp",{index:c,beforeContent:M,selectedContent:se,afterContent:f,originalSelection:{start:P.startOffset,end:P.endOffset,parentIndex:c}})}})},Re=c=>{const r=d.paragraphLists[c].content,P=window.getSelection().getRangeAt(0);P.toString()&&be.confirm({title:"删除",icon:t(Ee),content:"确认将该分段内容删除么？",onOk(){const V=document.createElement("div");V.innerHTML=r;const[M,se,f]=E(V,P.startOffset,P.endOffset),ie=M.replace(/<[^>]+>/g,"").trim()==="",H=f.replace(/<[^>]+>/g,"").trim()==="";ie&&H?m("handleSplitDelete",{index:c,beforeContent:"",selectedContent:"",afterContent:"",isFullSelection:!0}):m("handleSplitDelete",{index:c,beforeContent:M,selectedContent:"",afterContent:f,originalSelection:{start:P.startOffset,end:P.endOffset,parentIndex:c}})}})},Ce=c=>{C.value&&!c.target.closest(".bubble-card")&&(C.value=!1)};function ze(c,r,T={}){if(!r||!c)return c;const{highlightClass:P="highlight",caseSensitive:ce=!1,wholeWord:V=!1}=T,M=ce?"g":"gi";let se;return V?se=new RegExp(`\\b${Te(r)}\\b`,M):se=new RegExp(Te(r),M),c.replace(se,f=>`<span class="${P}">${f}</span>`)}function Te(c){return c.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}return Be(()=>{document.addEventListener("click",Ce)}),Pt(()=>{document.removeEventListener("click",Ce)}),le({handleOpenEditModal:F}),(c,r)=>{const T=Ke,P=it,ce=lt,V=rt,M=Ze,se=ot("viewer");return l(),v("div",{class:"subsection-box content-container",ref_key:"containerRef",ref:i},[a("div",Ha,[r[4]||(r[4]=q(" 分段预览 ")),a("span",null,"共"+oe(d.total)+"个分段",1)]),(l(!0),v(fe,null,xe(d.paragraphLists,(f,ie)=>(l(),v("div",{class:"list-item",key:f.id,onClick:ye(H=>N(f,ie,H),["stop"]),style:De({"--status-color":ee(f)})},[a("div",Ba,[a("div",Ua,[r[8]||(r[8]=q(" 分段 ")),d.detailsInfo.chunk_type==4?(l(),v(fe,{key:0},[q(oe(f.father_chunk_paragraph_number)+"-",1)],64)):B("",!0),q(" "+oe(f.number)+" ",1),a("div",Ja,oe(f.title),1),a("span",null,"共"+oe(f.word_total)+"个字符",1),a("span",ja,[q(" 嵌入状态："+oe(f.status_text),1),f.status==3?(l(),j(Y(Tn),{key:0})):B("",!0),f.status==2&&f.errmsg?(l(),j(T,{key:1,title:f.errmsg},{default:s(()=>[a("strong",Qa,[r[5]||(r[5]=q("原因")),t(Y(Ee),{class:"err-icon cfb363f"})])]),_:2},1032,["title"])):B("",!0),f.split_status==4&&f.split_err_msg?(l(),j(T,{key:2,title:f.split_err_msg},{default:s(()=>[a("div",Ga,[t(Y(Mn),{style:{"margin-left":"0"},class:"cfb363f"}),r[6]||(r[6]=q(" 分段失败 "))])]),_:2},1032,["title"])):B("",!0)]),re.detailsInfo.graph_switch?(l(),v("span",Va,[q(" 知识图谱状态："+oe(f.graph_status_text)+" ",1),f.graph_status==3&&f.graph_err_msg?(l(),j(T,{key:0,title:f.graph_err_msg},{default:s(()=>[a("strong",Wa,[r[7]||(r[7]=q("原因")),t(Y(Ee),{class:"err-icon cfb363f"})])]),_:2},1032,["title"])):B("",!0)])):B("",!0)]),a("div",Za,[t(V,null,{overlay:s(()=>[t(ce,null,{default:s(()=>[(l(!0),v(fe,null,xe(k.value,H=>(l(),j(P,{key:H.id},{default:s(()=>[a("div",{class:"start-item",onClick:ye(Se=>w(f,H),["stop"])},[t(Y(Ve),{style:De({color:Y(We)[H.type]})},null,8,["style"]),a("div",null,oe(H.name||"-"),1)],8,Ya)]),_:2},1024))),128)),t(P,null,{default:s(()=>[a("div",{class:"start-item",onClick:ye(I,["stop"])},[t(Y(At)),r[9]||(r[9]=a("div",null,"精选设置",-1))])]),_:1})]),_:2},1024)]),default:s(()=>[a("div",Ka,[f.category_id>0?(l(),j(Y(Ve),{key:0,onClick:ye(H=>w(f,{}),["stop"]),style:De({color:ee(f),"font-size":"16px"})},null,8,["onClick","style"])):(l(),j(Y(Ht),{key:1,onClick:H=>w(f,k.value[0]),style:{"font-size":"16px",color:"#595959"}},null,8,["onClick"]))])]),_:2},1024),t(T,null,{title:s(()=>r[10]||(r[10]=[q("重新分段")])),default:s(()=>[a("div",{class:"hover-btn-box",onClick:ye(H=>O(f),["stop"])},[t(M,{name:"segmentation-icon",style:{"font-size":"16px"}})],8,Xa)]),_:2},1024),re.detailsInfo.graph_switch?(l(),j(T,{key:0},{title:s(()=>r[11]||(r[11]=[q("知识图谱")])),default:s(()=>[a("div",{class:"hover-btn-box",onClick:H=>p(f)},[t(M,{name:"graph-icon",style:{"font-size":"16px",color:"#595959"}})],8,eo)]),_:2},1024)):B("",!0),t(T,null,{title:s(()=>r[12]||(r[12]=[q("重新转换")])),default:s(()=>[a("div",to,[t(Y(Bt),{onClick:ye(H=>_(f,ie),["stop"])},null,8,["onClick"])])]),_:2},1024),t(V,{placement:"bottomRight"},{overlay:s(()=>[t(ce,null,{default:s(()=>[t(P,null,{default:s(()=>[a("div",{onClick:ye(H=>F(f),["stop"])},"编辑",8,ao)]),_:2},1024),t(P,null,{default:s(()=>[a("div",{onClick:ye(H=>D(f.id),["stop"])},"删除",8,oo)]),_:2},1024)]),_:2},1024)]),default:s(()=>[a("div",no,[t(Y(Ut),{style:{"font-size":"16px",color:"#595959"}})])]),_:2},1024)])]),f.question?(l(),v("div",so,[r[13]||(r[13]=q("Q： ")),a("span",{innerHTML:ze(f.question,d.search)},null,8,lo)])):B("",!0),f.answer?(l(),v("div",io,[r[14]||(r[14]=q("A：")),a("span",{innerHTML:ze(f.answer,d.search)},null,8,ro)])):B("",!0),a("div",{class:"content-box",onMouseup:ye(H=>ve(H,ie),["stop"]),innerHTML:ze(f.content,d.search)},null,40,uo),f.images.length>0?st((l(),v("div",co,[(l(!0),v(fe,null,xe(f.images,(H,Se)=>(l(),v("img",{key:Se,src:H,alt:""},null,8,_o))),128))])),[[se]]):B("",!0)],12,Aa))),128)),t(Qt,{onOk:X,ref_key:"classificationMarkModalRef",ref:b},null,512),t(Na,{ref_key:"graphModelRef",ref:y},null,512),C.value?(l(),v("div",{key:0,class:"bubble-card",style:De(ae.value)},[a("button",{class:"bubble-item",onClick:r[0]||(r[0]=ye(f=>U("separate"),["stop"]))},[t(M,{name:"segmentation",style:{"font-size":"16px",color:"#262626","margin-right":"4px"}}),r[15]||(r[15]=q(" 单独成段 "))]),a("button",{class:"bubble-item",onClick:r[1]||(r[1]=ye(f=>U("merge-prev"),["stop"]))},[t(M,{name:"segmentation-up",style:{"font-size":"16px",color:"#262626","margin-right":"4px"}}),r[16]||(r[16]=q(" 合并到上一分段 "))]),a("button",{class:"bubble-item",onClick:r[2]||(r[2]=ye(f=>U("merge-next"),["stop"]))},[t(M,{name:"segmentation-down",style:{"font-size":"16px",color:"#262626","margin-right":"4px"}}),r[17]||(r[17]=q(" 合并到下一分段 "))]),a("button",{class:"bubble-item",onClick:r[3]||(r[3]=ye(f=>U("delete"),["stop"]))},[t(M,{name:"delete",style:{"font-size":"16px",color:"#262626","margin-right":"4px"}}),r[18]||(r[18]=q(" 删除 "))])],4)):B("",!0)],512)}}},qt=$e(po,[["__scopeId","data-v-c301d2b3"]]),fo={class:"mode-box"},mo=["innerHTML"],vo={class:"tag-item"},go={__name:"segmentation-mode",props:{detailsInfo:{type:Object}},setup(re){const le=re,$=u(""),G=ke(()=>{const{is_table_file:m,is_qa_doc:d,is_diy_split:_,question_lable:F,answer_lable:D,separators:N,chunk_size:O,chunk_overlap:k,question_column:X,answer_column:b,qa_index_type:I,doc_type:ee}=le.detailsInfo;if(m!=1&&d!=1&&_!=1)return ee==3?($.value=`分段模式：手动分段
文档类型：普通文档`,"自定义：普通文档"):($.value=`分段模式：智能分段
文档类型：普通文档`,"智能分段：普通文档");if(m!=1&&d==1)return ee==3?($.value=`分段模式：手动分段
文档类型：QA文档`,"自定义：QA文档"):($.value=`分段模式：智能分段
文档类型：QA文档
问题开始标识符："${F}"
答案开始标识符："${D}"`,"智能分段：QA文档");if(m!=1&&d!=1&&_==1)return $.value=`分段模式：自定义分段
文档标识符：${N}
分段最大长度：${O}字符
文段重叠长度：${k}字符`,"自定义分段";if(m==1&&d!=1)return $.value=`分段模式：智能分段
文档类型：普通表格`,"智能分段：普通表格";if(m==1&&d==1){let w=I==1?"问题与答案一起生成索引":"仅对问题生成索引";return $.value=`分段模式：智能分段
文档类型：QA文档
问题所在列："${X}"
答案所在列："${b}"
索引方式：${w}`,"智能分段：QA文档"}});return(m,d)=>{const _=Ke;return l(),v("div",fo,[t(_,null,{title:s(()=>[a("div",{class:"tooltip-text-box",innerHTML:$.value},null,8,mo)]),default:s(()=>[a("div",vo,oe(G.value),1)]),_:1})])}}},ho=$e(go,[["__scopeId","data-v-6ee0b31f"]]),ko={__name:"update-frequency",emits:["ok"],setup(re,{expose:le,emit:$}){const G=$,m=u(!1),d=u(!1),_=Le({doc_auto_renew_frequency:1,id:""}),F=N=>{let{doc_auto_renew_frequency:O,id:k}=N;_.doc_auto_renew_frequency=+O,_.id=k,m.value=!0},D=()=>{d.value=!0,gn({..._}).then(N=>{G("ok",_.doc_auto_renew_frequency),m.value=!1,he.success("设置成功")}).finally(()=>{d.value=!1})};return le({open:F}),(N,O)=>{const k=jt,X=Jt,b=zn,I=Pn,ee=be;return l(),v("div",null,[t(ee,{open:m.value,"onUpdate:open":O[1]||(O[1]=w=>m.value=w),"confirm-loading":d.value,maskClosable:!1,title:"设置更新频率",onOk:D},{default:s(()=>[t(I,{style:{margin:"32px 0"},layout:"vertical",model:_},{default:s(()=>[t(b,{name:"doc_auto_renew_frequency",label:"更新频率",required:""},{default:s(()=>[t(X,{value:_.doc_auto_renew_frequency,"onUpdate:value":O[0]||(O[0]=w=>_.doc_auto_renew_frequency=w),style:{width:"100%"}},{default:s(()=>[t(k,{value:1},{default:s(()=>O[2]||(O[2]=[q("不自动更新")])),_:1,__:[2]}),t(k,{value:2},{default:s(()=>O[3]||(O[3]=[q("每天")])),_:1,__:[3]}),t(k,{value:3},{default:s(()=>O[4]||(O[4]=[q("每3天")])),_:1,__:[4]}),t(k,{value:4},{default:s(()=>O[5]||(O[5]=[q("每7天")])),_:1,__:[5]}),t(k,{value:5},{default:s(()=>O[6]||(O[6]=[q("每30天")])),_:1,__:[6]})]),_:1},8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open","confirm-loading"])])}}},yo={class:"loading"},bo={__name:"pdf-preview",props:{source:{type:[String],required:!0},pageSize:{type:Number,default:10}},emits:["onScrollEnd","select","rendered","scroll","getTotalPage"],setup(re,{expose:le,emit:$}){const G=re,m=$,d=u(null),_=u([]),F=u(0),D=u(!1),N=ke(()=>D.value?null:{"border-bottom":"2px solid #d9d9d9"}),O=u({fade:!1,scrollbarTrackClickable:!0,interactive:!0,minSize:40});Be(async()=>{const y=await Lt.getDocument(G.source).promise;F.value=y.numPages,m("getTotalPage",F.value),k()});const k=(y=null)=>{const p=_.value.length;if(p>=F.value||D.value)return;D.value=!0;const i=[];for(let C=1;C<=G.pageSize&&p+C<=F.value;C++)i.push(p+C);_.value.push(...i),Ge(()=>{typeof y=="function"&&y()})},X=y=>{k(),m("onScrollEnd",y)},b=y=>{Ge(()=>{y===_.value[_.value.length-1]&&(D.value=!1,m("rendered",y,F.value))})},I=y=>{m("select",y)},ee=()=>d.value,w=y=>{m("scroll",y)};return le({loadMore:k,getScrollInstance:ee}),(y,p)=>{const i=Je;return l(),j(Ae,{scrollbar:O.value,ref_key:"scrollRef",ref:d,onScroll:w,onOnScrollEnd:X},{default:s(()=>[(l(!0),v(fe,null,xe(_.value,C=>(l(),j(Y(Lt),{onClick:W=>I(C),key:C,source:re.source,page:C,onRendered:()=>b(C),style:De(N.value)},null,8,["onClick","source","page","onRendered","style"]))),128)),a("div",yo,[D.value?(l(),j(i,{key:0})):B("",!0)])]),_:1},8,["scrollbar"])}}},So=$e(bo,[["__scopeId","data-v-8ffdbe19"]]),wo={key:0,class:"loading-wrap"},xo={class:"document-segmentation"},Co={class:"page-container"},$o={class:"page-left"},Lo={class:"page-right"},qo={class:"document-fragment-preview"},Oo={class:"preview-header"},Eo={class:"fragment-number"},Io={key:1,class:"loading-box"},Ro="你是一位文章分段助手，根据文章内容的语义进行合理分段，确保每个分段表述一个完整的语义，每个分段字数控制在500字左右，最大不超过1000字。请严格按照文章内容进行分段，不要对文章内容进行加工，分段完成后输出分段后的内容。",To={__name:"document-segmentation-model",props:{pdfState:{type:Object,default:()=>{}},currentData:{type:Object,default:()=>{}},paragraphType:{type:String,default:""}},emits:["ok","finish","loading"],setup(re,{expose:le,emit:$}){const G=hn(),{setInitDocumentFragmentList:m}=G,d=Ue(),_=$,{id:F}=d.query,D=u(!0),N=u(1);let O=!1;const k=re,X=u(1);let b={id:F,separators_no:"",chunk_size:512,not_merged_text:!1,chunk_overlap:50,is_qa_doc:0,question_lable:"",answer_lable:"",enable_extract_image:!0,ai_chunk_size:5e3,ai_chunk_model:"",ai_chunk_model_config_id:"",ai_chunk_prumpt:Ro,ai_chunk_task_id:"",father_chunk_paragraph_type:2,father_chunk_separators_no:[],father_chunk_chunk_size:1024,son_chunk_separators_no:[],son_chunk_chunk_size:512};const I=u(null),ee=n=>{typeof n.separators_no=="object"&&(n.separators_no=JSON.stringify(n.separators_no)),typeof n.father_chunk_separators_no=="object"&&(n.father_chunk_separators_no=JSON.stringify(n.father_chunk_separators_no)),typeof n.son_chunk_separators_no=="object"&&(n.son_chunk_separators_no=JSON.stringify(n.son_chunk_separators_no)),b={...b,...n},O?be.confirm({title:"提醒",icon:t(Ee),content:"文档片段已被编辑重新获取文档片段会丢失当前修改过的文档片段内容，确定要重新获取吗？",okText:"确定",okType:"danger",cancelText:"取消",onOk(){O=!1,ge("create")},onCancel(){}}):(O=!1,ge("create"))};let w=60*10,y=0;const p=u({}),i=u(0),C=()=>{D.value||(D.value=!0),Tt({id:F}).then(async n=>{const{status:R}=n.data;if(i.value=n.data.library_type,p.value=n.data,b={...b,separators_no:n.data.separators_no||"[12,11]",chunk_size:+n.data.chunk_size||512,not_merged_text:n.data.not_merged_text=="true",ai_chunk_size:+n.data.ai_chunk_size||5e3,chunk_overlap:+n.data.chunk_overlap||50,is_qa_doc:i.value==2?1:0,question_lable:n.data.question_lable,answer_lable:n.data.answer_lable,question_column:n.data.question_column,answer_column:n.data.answer_column,enable_extract_image:n.data.enable_extract_image=="true",qa_index_type:+n.data.qa_index_type,chunk_type:+n.data.chunk_type,semantic_chunk_size:+n.data.semantic_chunk_size||512,semantic_chunk_overlap:+n.data.semantic_chunk_overlap||50,semantic_chunk_threshold:+n.data.semantic_chunk_threshold||90,semantic_chunk_use_model:n.data.semantic_chunk_use_model||"",ai_chunk_prumpt:n.data.ai_chunk_prumpt||"",ai_chunk_model:n.data.ai_chunk_model||"",semantic_chunk_model_config_id:n.data.semantic_chunk_model_config_id>0?n.data.semantic_chunk_model_config_id:"",ai_chunk_model_config_id:n.data.ai_chunk_model_config_id>0?n.data.ai_chunk_model_config_id:"",ai_chunk_task_id:n.data.ai_chunk_task_id||"",father_chunk_paragraph_type:+n.data.father_chunk_paragraph_type||2,father_chunk_separators_no:n.data.father_chunk_separators_no||"[12,11]",father_chunk_chunk_size:+n.data.father_chunk_chunk_size||1024,son_chunk_separators_no:n.data.son_chunk_separators_no||"[8,10]",son_chunk_chunk_size:+n.data.son_chunk_chunk_size||512},n.data.chunk_type==0&&(b={...b,separators_no:n.data.normal_chunk_default_separators_no,chunk_size:n.data.normal_chunk_default_chunk_size,not_merged_text:n.data.normal_chunk_default_not_merged_text=="true",chunk_overlap:n.data.normal_chunk_default_chunk_overlap,chunk_type:+n.data.default_chunk_type,semantic_chunk_size:+n.data.semantic_chunk_default_chunk_size,semantic_chunk_overlap:+n.data.semantic_chunk_default_chunk_overlap,semantic_chunk_threshold:+n.data.semantic_chunk_default_threshold,semantic_chunk_use_model:n.data.default_use_model||"",semantic_chunk_model_config_id:n.data.default_model_config_id>0?n.data.default_model_config_id:""}),R==0){if(y++,y>w){be.error({title:"提醒",content:"文档解析速度慢请稍后再试"});return}setTimeout(()=>{C()},1e3)}else(R==4||R==2)&&(D.value=!1,N.value=parseInt(n.data.is_table_file),n.data.library_id,i.value==2?(b.question_lable||b.question_column)&&ge():ge());n.data.is_table_file==1&&me()})};Be(async()=>{await C()});const W=u([]),me=()=>{bn({id:F}).then(n=>{let R=[];for(let ne in n.data)R.push({lable:n.data[ne],value:ne});W.value=R})},h=u([]),ue=u(!1),ae=u(!1),ve=u(""),U=u(null);let E=null;const J=u([]),te=u(0),x=ke(()=>te.value<=0),ge=n=>{var _e;_("loading",!0);let R={...b,semantic_chunk_model_config_id:b.semantic_chunk_model_config_id?+b.semantic_chunk_model_config_id:0,ai_chunk_model_config_id:b.ai_chunk_model_config_id?+b.ai_chunk_model_config_id:0,...k.pdfState};b.chunk_type==3&&(b.ai_chunk_task_id&&!n&&(R.ai_chunk_task_id=b.ai_chunk_task_id),R.ai_chunk_task_id&&n&&n==="create"&&delete R.ai_chunk_task_id);let ne=yn;return k.paragraphType&&k.paragraphType==="paragraphsSegmented"&&n=="create"&&(ne=wn,delete R.id),k.paragraphType&&k.paragraphType==="paragraphsSegmented"&&!n?(J.value=k.currentData.list||[],te.value=k.currentData.list.length,b.chunk_type==3&&(ve.value=((_e=k.currentData.split_params)==null?void 0:_e.ai_chunk_task_id)||"",ae.value=!0,I.value.reLoading=!0,U.value=null,!b.ai_chunk_task_id&&N.value!=1||n&&n==="create"?(J.value=[],te.value=0,Te()):(ae.value=!1,I.value.reLoading=!1)),b.chunk_type!=3&&(I.value.reLoading=!1,I.value.saveLoading=!1),_("loading",!1),!1):ne(R).then(pe=>{var Ie;h.value=pe.data.list||[],m(h.value),J.value=pe.data.list||[],te.value=pe.data.list.length||0,b.chunk_type==3&&(ve.value=((Ie=pe.data.split_params)==null?void 0:Ie.ai_chunk_task_id)||"",ae.value=!0,I.value.reLoading=!0,I.value.saveLoading=!0,U.value=null,!b.ai_chunk_task_id&&N.value!=1||n&&n==="create"?(J.value=[],te.value=0,Te()):(ae.value=!1,I.value.reLoading=!1,I.value.saveLoading=!1))}).finally(()=>{b.chunk_type!=3&&(I.value.reLoading=!1,I.value.saveLoading=!1),_("loading",!1)})},Re=n=>{X.value=n},Ce=async()=>{var n;try{const R=await c();return R.data.err_msg?(U.value=R.data.err_msg,!0):((n=R.data.list)==null?void 0:n.length)>0?(h.value=R.data.list||[],m(h.value),J.value=R.data.list||[],te.value=R.data.list.length||0,!0):!1}catch{return U.value="请求异常，停止轮询",!0}};function ze(n){return n.split("message:")[1]}const Te=()=>{const n=async()=>{if(!await Ce())E=setTimeout(n,3e3);else if(ae.value=!1,I.value.reLoading=!1,I.value.saveLoading=!1,E!==null&&(clearTimeout(E),E=null),ue.value&&Se(),U.value){let ne=ze(U.value);be.error({title:"分段失败提示",content:ne?`模型调用失败，失败原因：${ne}`:"模型调用失败"})}};n()},c=()=>Sn({id:b.id,task_id:ve.value}),r=u(null);let T=null;const P=({title:n,content:R,question:ne,answer:_e,images:pe},Ie)=>{T=Ie,r.value.open({title:n,content:R,question:ne,answer:_e,images:pe})},ce=({title:n,content:R,question:ne,answer:_e,images:pe})=>{(J.value[T].title!=n||J.value[T].content!=R||J.value[T].question!=ne||J.value[T].answer!=_e)&&(O=!0),J.value[T].title=n,J.value[T].content=R,J.value[T].question=ne,J.value[T].answer=_e,J.value[T].images=pe,J.value[T].word_total=_e.length+ne.length+R.length},V=n=>{be.confirm({title:"提醒",icon:t(Ee),content:"确定要删除这个片段吗?",okText:"确定",okType:"danger",cancelText:"取消",onOk(){O=!0,J.value.splice(n,1)},onCancel(){}})},M=u(""),se=n=>{M.value=n},f=u(!1),ie=()=>{let n=I.value.formState;n=JSON.parse(JSON.stringify(n)),typeof n.separators_no=="object"&&(n.separators_no=JSON.stringify(n.separators_no)),typeof n.father_chunk_separators_no=="object"&&(n.father_chunk_separators_no=JSON.stringify(n.father_chunk_separators_no)),typeof n.son_chunk_separators_no=="object"&&(n.son_chunk_separators_no=JSON.stringify(n.son_chunk_separators_no)),b={...b,...n}},H=n=>{let R=0;return n.forEach(ne=>{R+=parseInt(ne.word_total)}),R},Se=async()=>{if((te.value<=0||b.chunk_type!=X.value)&&(ie(),await ge()),ie(),M.value)return he.error(M.value);if(b.chunk_type==3&&!J.value.length)return ue.value=!0,!1;ve.value&&(b.ai_chunk_task_id=ve.value);let n={...b,semantic_chunk_model_config_id:b.semantic_chunk_model_config_id?+b.semantic_chunk_model_config_id:0,ai_chunk_model_config_id:b.ai_chunk_model_config_id?+b.ai_chunk_model_config_id:0,is_table_file:N.value,...k.pdfState};delete n.id;let R={file_id:F,word_total:H(J.value),split_params:JSON.stringify(n),list:JSON.stringify(J.value),...k.pdfState};n.is_qa_doc==1&&(R.qa_index_type=n.qa_index_type),f.value=!0,k.paragraphType&&k.paragraphType==="paragraphsSegmented"&&(R.data_id=R.data_ids,delete R.data_ids),kn(R).then(()=>{_("ok"),_("finish")}).finally(()=>{f.value=!1}).catch(ne=>{ne.data&&ne.data.index&&Fe(ne.data.index),_("finish")})},qe=u(null),Fe=n=>{n=n-1;let R=qe.value.querySelectorAll(".fragment-item");R.length>=n&&R[n].scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})};return Pt(()=>{E&&(clearTimeout(E),E=null)}),le({handleSaveLibFileSplit:Se}),(n,R)=>{const ne=Je;return l(),v(fe,null,[D.value?(l(),v("div",wo,[t(ne)])):B("",!0),a("div",xo,[a("div",Co,[a("div",$o,[t(ia,{excellQaLists:W.value,libFileInfo:p.value,library_type:i.value,mode:N.value,hideSave:!0,status:"paragraphsSegmented",ref_key:"segmentationSettingRef",ref:I,onChange:ee,onChangeChunkType:Re,onSave:Se,onValidate:se},null,8,["excellQaLists","libFileInfo","library_type","mode"])]),a("div",Lo,[a("div",qo,[a("div",Oo,[R[0]||(R[0]=a("span",{class:"label-text"},"分段预览",-1)),a("span",Eo,"共"+oe(te.value)+"个分段",1)]),x.value&&!ae.value?(l(),j(ra,{key:0})):B("",!0),ae.value?(l(),v("div",Io,[t(ne),R[1]||(R[1]=q("数据处理中..."))])):B("",!0),a("div",{class:"preview-box",ref_key:"previewBoxRef",ref:qe},[(l(!0),v(fe,null,xe(J.value,(_e,pe)=>(l(),v("div",{class:"fragment-item",key:pe},[t(ua,{status:"paragraphsSegmented",chunk_type:Y(b).chunk_type,father_chunk_paragraph_number:_e.father_chunk_paragraph_number,currentData:re.currentData,number:_e.number,title:_e.title,content:_e.content,total:_e.word_total,question:_e.question,answer:_e.answer,images:_e.images,onDelete:Ie=>V(pe),onEdit:Ie=>P(_e,pe)},null,8,["chunk_type","father_chunk_paragraph_number","currentData","number","title","content","total","question","answer","images","onDelete","onEdit"])]))),128))],512)])])]),t(ca,{ref_key:"editFragmentAlertRef",ref:r,onOk:ce},null,512)])],64)}}},Gt=$e(To,[["__scopeId","data-v-16075b18"]]),Mo={class:"select-box"},Po=["onClick"],zo={class:"title"},Fo={class:"desc"},Do={key:0,class:"card-switch"},No={class:"main-content-box"},Ho={__name:"re-segmentation-page",props:{detailsInfo:{type:Object,default:()=>{}}},emits:["ok","enable"],setup(re,{expose:le,emit:$}){const G=Mt(),m=ke(()=>{var U;return((U=G.companyInfo)==null?void 0:U.ali_ocr_switch)=="1"}),d=Ue().query,_=Ft(),F=re,D=u(!1),N=u(!1),O=u(""),k=$;let X={};const b=u([{title:"图文OCR解析",desc:"通过OCR文字识别提取pdf文件内容，可以兼容扫描件，但是解析速度较慢。",icon:"pdf-ocr",pdf_parse_type:2},{title:"纯文本解析",desc:"只提取Pdf中的文字内容，如果文档为扫描件可能提取不到内容。",icon:"pdf-text",pdf_parse_type:1},{title:"图文解析",desc:"提取PDF文档中的图片和文字",icon:"pdf-img",pdf_parse_type:3}]),I=Le({pdf_parse_type:2,pdf_page_num:0}),ee=()=>{b.value=b.value.filter(U=>U.pdf_parse_type!=4),k("enable")},w=u(!1),y=U=>{w.value=U},p=U=>{X={...U},I.pdf_parse_type=2,I.pdf_page_num=U.pdf_page_num,U.type==1&&(O.value=`当页(${U.pdf_page_num})重新分段`),U.type==2&&(O.value="将文档重新分段"),U.type==3&&(O.value="重新学习文档",b.value.push({title:"阿里云OCR解析",desc:"通过阿里云文档智能接口解析提取图片和文字",icon:"ali-ocr",pdf_parse_type:4})),D.value=!0},i=()=>{window.open("#/user/aliocr")},C=U=>{if(U.pdf_parse_type==4&&!m.value)return!1;I.pdf_parse_type=U.pdf_parse_type},W=u(!1),me=()=>{if(X.type==3){if(I.pdf_parse_type==1){_.push("/library/document-segmentation?document_id="+d.id+"&source=preview");return}W.value=!0,xn({id:d.id,pdf_parse_type:I.pdf_parse_type}).then(U=>{he.success("重新学习成功"),(I.pdf_parse_type==2||I.pdf_parse_type==3||I.pdf_parse_type==4)&&_.push({path:"/library/details/knowledge-document",query:{id:F.detailsInfo.library_id}}),I.pdf_parse_type==1&&_.push("/library/document-segmentation?document_id="+d.id+"&source=preview"),D.value=!1}).finally(()=>{W.value=!1});return}D.value=!1,N.value=!0},h=u(null),ue=()=>{W.value=!0,h.value.handleSaveLibFileSplit()},ae=()=>{he.success("保存成功"),N.value=!1,k("ok",X.type)},ve=()=>{W.value=!1};return le({show:p}),(U,E)=>{const J=Ze,te=be;return l(),v("div",null,[t(te,{open:D.value,"onUpdate:open":E[0]||(E[0]=x=>D.value=x),title:O.value,onOk:me,onCancel:ee,width:720,confirmLoading:W.value},{default:s(()=>[a("div",Mo,[(l(!0),v(fe,null,xe(b.value,x=>(l(),v("div",{class:zt(["select-list-item",{active:x.pdf_parse_type==I.pdf_parse_type},{disabled:x.pdf_parse_type==4&&!m.value}]),onClick:ge=>C(x),key:x.pdf_parse_type},[a("div",zo,[t(J,{name:x.icon,style:{"font-size":"16px"}},null,8,["name"]),q(" "+oe(x.title),1)]),a("div",Fo,oe(x.desc),1),x.pdf_parse_type==4&&!m.value?(l(),v("div",Do,[E[2]||(E[2]=q(" 未开启阿里云OCR ")),a("div",{class:"card-switch-btn",onClick:ye(i,["stop"])},"去开启")])):B("",!0)],10,Po))),128))])]),_:1},8,["open","title","confirmLoading"]),t(te,{open:N.value,"onUpdate:open":E[1]||(E[1]=x=>N.value=x),onCancel:ee,title:O.value,maskClosable:!1,"ok-text":w.value?"文档解析中,请稍候...":"确定",confirmLoading:W.value||w.value,onOk:ue,width:1e3},{default:s(()=>[a("div",No,[N.value?(l(),j(Gt,{key:0,onOk:ae,onFinish:ve,onLoading:y,pdfState:I,ref_key:"documentSegmentationModalRef",ref:h},null,8,["pdfState"])):B("",!0)])]),_:1},8,["open","title","ok-text","confirmLoading"])])}}},Ao=$e(Ho,[["__scopeId","data-v-fdcaa00c"]]),Bo={class:"subsection-box"},Uo={class:"qa-list-box"},Jo={class:"list-item"},jo=["innerHTML"],Qo={key:0,class:"list-item"},Go=["innerHTML"],Vo={class:"list-item"},Wo=["innerHTML"],Zo={class:"fragment-img"},Ko=["src"],Yo={key:0,class:"status-tag"},Xo={key:1,class:"status-tag complete"},es={class:"status-tag status-error"},ts={key:3,class:"status-tag running"},ns={class:"right-opration"},as={class:"hover-btn-box"},os=["onClick"],ss=["onClick"],ls={class:"hover-btn-box"},is=["onClick"],rs=["onClick"],us={__name:"qa-subsection-box",props:{paragraphLists:{type:Array,default:()=>[]},search:{type:String,default:""},total:{type:[Number,String],default:0}},emits:["handleDelParagraph","handleScrollTargetPage","openEditSubscription","handleConvert","getStatrList"],setup(re,{expose:le,emit:$}){const m=Ue().query,d=$,_=re,F=(p,i)=>{let{id:C,title:W,content:me,question:h,answer:ue,images:ae,category_id:ve}=p,U=p.similar_questions||[];be.confirm({title:"重新转换确认",icon:null,content:`确定要重新转换【分段${i+1}】吗?`,onOk(){return new Promise((E,J)=>{It({id:C,title:W,content:me,question:h,answer:ue,images:ae,category_id:ve,similar_questions:JSON.stringify(U)}).then(te=>{d("handleConvert",p),E()}).catch(()=>{E()})})},onCancel(){}})},D=p=>{d("openEditSubscription",p)},N=p=>{be.confirm({title:"提示",icon:t(Ee),content:"确认是否删除该分段?",onOk(){return new Promise((i,C)=>{Rt({id:p}).then(W=>{he.success("删除成功"),d("handleDelParagraph",p),i()}).catch(()=>{i()})})},onCancel(){}})},O=u([]),k=()=>{let p={};m.id&&(p.file_id=m.id),Ot(p).then(i=>{O.value=i.data||[],d("getStatrList",i.data||[])})};k();const X=u(null),b=()=>{X.value.show()},I=p=>{var C;let i=(C=O.value.filter(W=>W.id==p.category_id)[0])==null?void 0:C.type;return i?We[i]:"#F4EA2A"},ee=(p,i={})=>{Et({id:p.id,category_id:i.id||0}).then(C=>{he.success("设置成功"),p.category_id=i.id,k()})};function w(p,i,C={}){if(!i||!p)return p;const{highlightClass:W="highlight",caseSensitive:me=!1,wholeWord:h=!1}=C,ue=me?"g":"gi";let ae;return h?ae=new RegExp(`\\b${y(i)}\\b`,ue):ae=new RegExp(y(i),ue),p.replace(ae,ve=>`<span class="${W}">${ve}</span>`)}function y(p){return p.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}return le({handleOpenEditModal:D}),(p,i)=>{const C=Fn,W=Ke,me=Je,h=it,ue=lt,ae=rt,ve=An,U=ot("viewer");return l(),v("div",Bo,[t(ve,{"data-source":re.paragraphLists,pagination:!1},{default:s(()=>[t(C,{key:"id","data-index":"id",width:1148},{title:s(()=>[q("问答（共"+oe(_.total)+"个）",1)]),default:s(({record:E})=>[a("div",Uo,[a("div",Jo,[i[0]||(i[0]=a("div",{class:"list-label"},"问题",-1)),a("div",{class:"list-content",innerHTML:w(E.question,_.search)},null,8,jo)]),E.similar_questions&&E.similar_questions.length?(l(),v("div",Qo,[i[1]||(i[1]=a("div",{class:"list-label"},"相似问法",-1)),a("div",{class:"list-content",innerHTML:w(E.similar_questions.join("/"),_.search)},null,8,Go)])):B("",!0),a("div",Vo,[i[2]||(i[2]=a("div",{class:"list-label"},"答案",-1)),a("div",{class:"list-content",innerHTML:w(E.answer,_.search)},null,8,Wo)]),st((l(),v("div",Zo,[(l(!0),v(fe,null,xe(E.images,(J,te)=>(l(),v("img",{key:te,src:J,alt:""},null,8,Ko))),128))])),[[U]])])]),_:1}),t(C,{title:"嵌入状态",key:"status_text","data-index":"status_text",width:128},{default:s(({record:E})=>[E.status==0?(l(),v("span",Yo,[t(Y(Dn)),i[3]||(i[3]=q(" 未转换"))])):B("",!0),E.status==1?(l(),v("span",Xo,[t(Y(Nn)),i[4]||(i[4]=q(" 已转换"))])):B("",!0),E.status==2?(l(),j(W,{key:2,placement:"top"},{title:s(()=>[a("span",null,oe(E.errmsg),1)]),default:s(()=>[a("span",null,[a("span",es,[t(Y(Hn)),i[5]||(i[5]=q(" 转换异常"))])])]),_:2},1024)):B("",!0),E.status==3?(l(),v("span",ts,[t(me,{size:"small"}),i[6]||(i[6]=q(" 转换中"))])):B("",!0)]),_:1}),t(C,{title:"操作",key:"action","data-index":"action",width:120},{default:s(({record:E,index:J})=>[a("div",ns,[t(ae,null,{overlay:s(()=>[t(ue,null,{default:s(()=>[(l(!0),v(fe,null,xe(O.value,te=>(l(),j(h,{key:te.id},{default:s(()=>[a("div",{class:"start-item",onClick:x=>ee(E,te)},[t(Y(Ve),{style:De({color:Y(We)[te.type]})},null,8,["style"]),a("div",null,oe(te.name||"-"),1)],8,os)]),_:2},1024))),128)),t(h,null,{default:s(()=>[a("div",{class:"start-item",onClick:b},[t(Y(At)),i[7]||(i[7]=a("div",null,"标记设置",-1))])]),_:1})]),_:2},1024)]),default:s(()=>[a("div",as,[E.category_id>0?(l(),j(Y(Ve),{key:0,onClick:te=>ee(E,{}),style:De({color:I(E),"font-size":"16px"})},null,8,["onClick","style"])):(l(),j(Y(Ht),{key:1,onClick:te=>ee(E,O.value[0]),style:{"font-size":"16px"}},null,8,["onClick"]))])]),_:2},1024),t(W,null,{title:s(()=>i[8]||(i[8]=[q("重新转换")])),default:s(()=>[a("div",{class:"hover-btn-box",onClick:te=>F(E,J)},[t(Y(Bt))],8,ss)]),_:2},1024),t(ae,{placement:"bottomRight"},{overlay:s(()=>[t(ue,null,{default:s(()=>[t(h,null,{default:s(()=>[a("div",{onClick:ye(te=>D(E),["stop"])},"编辑",8,is)]),_:2},1024),t(h,null,{default:s(()=>[a("div",{onClick:ye(te=>N(E.id),["stop"])},"删除",8,rs)]),_:2},1024)]),_:2},1024)]),default:s(()=>[a("div",ls,[t(Y(Ut))])]),_:2},1024)])]),_:1})]),_:1},8,["data-source"]),t(Qt,{onOk:k,ref_key:"classificationMarkModalRef",ref:X},null,512)])}}},cs=$e(us,[["__scopeId","data-v-6a1ecdf2"]]),_s={class:"main-content-box"},ds={__name:"segmentation-setting-modal",emits:["ok","enable"],setup(re,{expose:le,emit:$}){const G=u(!1),m=u("重新分段"),d=$;let _={};const F=Le({data_ids:0,file_id:0}),D={0:"未转换",1:"已转换",2:"转换异常",3:"转换中",4:"分段失败",10:"分段中"},N=Le({status:"",errmsg:"",status_text:""}),O=()=>{d("enable")},k=u(!1),X=i=>{k.value=i},b=i=>{G.value=!0,F.data_ids=i.id,F.file_id=i.file_id,N.list=[{father_chunk_paragraph_number:+i.father_chunk_paragraph_number,content:i.content,number:+i.number,title:i.title,word_total:+i.word_total,question:i.question,answer:i.answer,images:i.images}],N.status=i.status,N.errmsg=i.errmsg,N.status_text=D[i.status]},I=u(!1),ee=u(null),w=()=>{I.value=!0,ee.value.handleSaveLibFileSplit()},y=()=>{he.success("保存成功"),G.value=!1,d("ok",_.type)},p=()=>{I.value=!1};return le({show:b}),(i,C)=>{const W=be;return l(),v("div",null,[t(W,{open:G.value,"onUpdate:open":C[0]||(C[0]=me=>G.value=me),onCancel:O,title:m.value,maskClosable:!1,"ok-text":k.value?"文档解析中,请稍候...":"确定",confirmLoading:I.value||k.value,onOk:w,width:1084},{default:s(()=>[a("div",_s,[G.value?(l(),j(Gt,{key:0,onOk:y,onFinish:p,onLoading:X,paragraphType:"paragraphsSegmented",pdfState:F,currentData:N,ref_key:"documentSegmentationModalRef",ref:ee},null,8,["pdfState","currentData"])):B("",!0)])]),_:1},8,["open","title","ok-text","confirmLoading"])])}}},ps=$e(ds,[["__scopeId","data-v-484bfb17"]]),fs={class:"library-preview-page"},ms={class:"breadcrumb-block"},vs={class:"library-line1"},gs={class:"selct-star-box"},hs={class:"document-title-block",style:{height:"22px"}},ks={class:"title"},ys={class:"search-content-block"},bs={class:"preview-box"},Ss={key:0,class:"page-loading-box"},ws={class:"content-block"},xs={class:"content-block"},Cs={key:1,class:"pdf-view-box"},$s={key:0,class:"pdf-mode-switch"},Ls={key:0},qs={key:1,class:"segmentation-btn"},Os={class:"view-content-box",style:{"padding-top":"60px"}},Es=["onClick"],Is={key:0,class:"content-box"},Rs={key:1,class:"content-box"},Ts=["innerHTML"],Ms={class:"fragment-img"},Ps=["src"],zs={class:"right-contnt-box"},Fs={key:0,class:"right-tabs-box"},Ds={class:"content-block"},Ns="你是一位文章分段助手，根据文章内容的语义进行合理分段，确保每个分段表述一个完整的语义，每个分段字数控制在500字左右，最大不超过1000字。请严格按照文章内容进行分段，不要对文章内容进行加工，分段完成后输出分段后的内容。",Hs={__name:"library-preview",setup(re){const le=Mt(),$=ke(()=>{var e;return((e=le.companyInfo)==null?void 0:e.neo4j_status)=="true"}),G=u(!1),m=u(null),d=u(0),_=u(0),F={0:"待生成",4:"生成中",2:"生成成功",3:"生成失败"},D=u([]),N=e=>{D.value=e},O=u({fade:!1,scrollbarTrackClickable:!0,interactive:!0,minSize:40}),k=Ue(),X=Ft(),b=Cn(),I=ke(()=>p.value.is_table_file=="1"),ee=ke(()=>p.value.doc_type),w=ke(()=>{let e=p.value.status;return!(e=="1"||e=="2")||x.value.length==0}),y=ke(()=>p.value.is_qa_doc=="1"),p=u({}),i=Le({status:-1,graph_status:-1,category_id:-1,search:""}),C=u(1),W=ke(()=>"/manage/getLibRawFile?id="+k.query.id+"&token="+b.getToken),me=()=>{X.back()},h=u(null),ue=u(null);let ae=-1;const ve=(e,o=1)=>{let g,L;o==1?(g=".subsection-box .list-item",L=ue.value):(g=".view-content-box .list-item",L=h.value);const A=document.querySelectorAll(g)[e];A.classList.add("flash-border"),ae>=0&&document.querySelectorAll(g)[ae].classList.remove("flash-border"),setTimeout(()=>{ae=-1,A.classList.remove("flash-border")},2500),ae=e,L.scrollToElement({el:A,time:1e3})},U=u(!0),E=u(0),J=u({page:1,size:1e3}),te=u({}),x=u([]),ge=u(0),Re={0:"未转换",1:"已转换",2:"转换异常",3:"转换中..."},Ce=Le({split_status_exception:0,total:0,vector_status_converted:0,vector_status_converting:0,vector_status_exception:0,vector_status_initial:0}),ze=Le([{value:-1,label:"全部",num:ke(()=>Ce.total)},{value:4,label:"分段失败",num:ke(()=>Ce.split_status_exception)},{value:0,label:"未转换",num:ke(()=>Ce.vector_status_initial)},{value:3,label:"转换中",num:ke(()=>Ce.vector_status_converting)},{value:2,label:"转换异常",num:ke(()=>Ce.vector_status_exception)},{value:1,label:"已转换",num:ke(()=>Ce.vector_status_converted)}]),Te=u(1);let c={id:k.query.id,separators_no:"",chunk_size:512,not_merged_text:!1,chunk_overlap:50,is_qa_doc:0,question_lable:"",similar_label:"",answer_lable:"",enable_extract_image:!0,ai_chunk_size:5e3,ai_chunk_model:"",ai_chunk_model_config_id:"",ai_chunk_prumpt:Ns,ai_chunk_task_id:"",father_chunk_paragraph_type:2,father_chunk_separators_no:[],father_chunk_chunk_size:1024,son_chunk_separators_no:[],son_chunk_chunk_size:512};const r=u(!1);let T=!0;(async()=>{Tt({id:k.query.id}).then(e=>{E.value=e.data.library_type,p.value={...e.data,graph_switch:e.data.graph_switch=="1"&&$.value};let o=e.data.status;o==1||o==2?ie():U.value=!1,c={...c,separators_no:e.data.separators_no||"[12,11]",chunk_size:+e.data.chunk_size||512,not_merged_text:e.data.not_merged_text=="true",ai_chunk_size:+e.data.ai_chunk_size||5e3,chunk_overlap:+e.data.chunk_overlap||50,is_qa_doc:E.value==2?1:0,question_lable:e.data.question_lable,similar_label:e.data.similar_label,answer_lable:e.data.answer_lable,question_column:e.data.question_column,similar_column:e.data.similar_column,answer_column:e.data.answer_column,enable_extract_image:e.data.enable_extract_image=="true",qa_index_type:+e.data.qa_index_type,chunk_type:+e.data.chunk_type,semantic_chunk_size:+e.data.semantic_chunk_size||512,semantic_chunk_overlap:+e.data.semantic_chunk_overlap||50,semantic_chunk_threshold:+e.data.semantic_chunk_threshold||90,semantic_chunk_use_model:e.data.semantic_chunk_use_model||"",ai_chunk_prumpt:e.data.ai_chunk_prumpt||"",ai_chunk_model:e.data.ai_chunk_model||"",semantic_chunk_model_config_id:e.data.semantic_chunk_model_config_id>0?e.data.semantic_chunk_model_config_id:"",ai_chunk_model_config_id:e.data.ai_chunk_model_config_id>0?e.data.ai_chunk_model_config_id:"",ai_chunk_task_id:e.data.ai_chunk_task_id||"",father_chunk_paragraph_type:+e.data.father_chunk_paragraph_type||2,father_chunk_separators_no:e.data.father_chunk_separators_no||"[12,11]",father_chunk_chunk_size:+e.data.father_chunk_chunk_size||1024,son_chunk_separators_no:e.data.son_chunk_separators_no||"[8,10]",son_chunk_chunk_size:+e.data.son_chunk_chunk_size||512},e.data.chunk_type==0&&(c={...c,separators_no:e.data.normal_chunk_default_separators_no,chunk_size:+e.data.normal_chunk_default_chunk_size,not_merged_text:e.data.normal_chunk_default_not_merged_text=="true",chunk_overlap:+e.data.normal_chunk_default_chunk_overlap,chunk_type:+e.data.default_chunk_type,semantic_chunk_size:+e.data.semantic_chunk_default_chunk_size,semantic_chunk_overlap:+e.data.semantic_chunk_default_chunk_overlap,semantic_chunk_threshold:+e.data.semantic_chunk_default_threshold,semantic_chunk_use_model:e.data.default_use_model||"",semantic_chunk_model_config_id:e.data.default_model_config_id>0?e.data.default_model_config_id:""}),(o==4||o==2)&&(Te.value=parseInt(e.data.is_table_file))})})();const ce=()=>{$n({file_id:k.query.id,search:i.search}).then(e=>{Object.assign(Ce,e.data)})},V=()=>{window.location.reload()},M=()=>{J.value.page=1,ge.value=0,x.value=[],ie(),ce()},se=e=>{i.category_id=e,M()},f=(e=null)=>{J.value.page++,ie(e)},ie=(e=null)=>{T=!0,Ct({file_id:k.query.id,...J.value,...i}).then(o=>{var S,z;U.value=!1,T=!1;let g=o.data,L=g.list||[],A=((S=g.info)==null?void 0:S.is_qa_doc)=="1"&&((z=g.info)==null?void 0:z.is_table_file)=="1";L.forEach(we=>{we.status_text=Re[we.status],we.graph_status_text=F[we.graph_status],we.isExcelQa=A,we.similar_questions&&(we.similar_questions=JSON.parse(we.similar_questions))}),te.value=g.info,J.value.page==1&&(x.value=[]),x.value=[...x.value,...L],ge.value=g.total,typeof e=="function"&&e()})},H=()=>{T||x.value.length>=ge.value||(f(),m.value&&m.value.loadMore())},Se=()=>{n()};let qe=null;function Fe(){clearInterval(qe),x.value.filter(o=>o.status==3).length?qe=setInterval(()=>{n()},5e3):clearInterval(qe)}const n=()=>{Ct({file_id:k.query.id,page:1,size:x.value.length,...i}).then(e=>{var A,S;let o=e.data,g=o.list||[],L=((A=o.info)==null?void 0:A.is_qa_doc)=="1"&&((S=o.info)==null?void 0:S.is_table_file)=="1";g.forEach(z=>{z.status_text=Re[z.status],z.graph_status_text=F[z.graph_status],z.isExcelQa=L,z.similar_questions&&(z.similar_questions=JSON.parse(z.similar_questions))}),x.value=g,Fe()})},R=e=>{if(!e.id){J.value.page=1,ie();return}let o=x.value,g=o.findIndex(L=>L.id==e.id);if(g>-1){let L=o[g];L.title=e.title,L.content=e.content,L.question=e.question,L.answer=e.answer,L.images=e.images,L.category_id=e.category_id,L.word_total=e.question.length+e.answer.length+e.content.length,L.similar_questions=e.similar_questions.length?JSON.parse(e.similar_questions):[],o.splice(g,1,L),x.value=o}},ne=e=>{let o=x.value,g=o.findIndex(L=>L.id==e);g>-1&&(o.splice(g,1),x.value=o,ge.value=ge.value--)},_e=u(null),pe=e=>{_e.value.showModal(JSON.parse(JSON.stringify(e)))},Ie=u(null),Vt=()=>{Ln({id:k.query.id}).then(()=>he.success("操作完成"))},Wt=()=>{qn({id:k.query.id}).then(()=>he.success("操作完成"))},ut=u(null),Zt=()=>{ut.value.show(p.value)},ct=()=>{X.push("/library/document-segmentation?document_id="+k.query.id+"&source=preview")},Kt=()=>{Ie.value.open({id:k.query.id,doc_auto_renew_frequency:p.value.doc_auto_renew_frequency})},Yt=e=>{p.value.doc_auto_renew_frequency=e},Xt=e=>{p.value.file_name=e},en=e=>{const o=()=>{for(let g in x.value)if(x.value[g].page_num==e){ve(g);return}};if(e>x.value[x.value.length-1].page_num){he.warning("分段数据正在加载，请稍后...");const g=()=>{e<=x.value[x.value.length-1].page_num?(he.success("加载完成"),Ge(()=>{o()})):f(g)};f(g)}else o()},tn=(e,o)=>{_.value=o,d.value=e,x.value[x.value.length-1].page_num<e&&f()},_t=e=>{var o;if(((o=p.value)==null?void 0:o.file_ext)=="pdf"&&C.value==1){const g=e.page_num-1,L=()=>document.querySelectorAll(".pdf-render-box > .scroll-content .vue-pdf-embed")[g],A=()=>{const z=L();z.classList.add("flash-border"),setTimeout(()=>z.classList.remove("flash-border"),2500),m.value.getScrollInstance().scrollToElement({el:z,time:1e3})};if(L())A();else{he.warning("PDF正在加载，请稍后...");const z=()=>{L()?(he.success("加载完成"),A()):m.value&&m.value.loadMore()};m.value&&m.value.loadMore(z)}}else ve(e.index,2)},Ye=u(1);let Xe=null;const je=u(0),nn=e=>{je.value=e},an=({y:e})=>{if(!Xe){const g=document.querySelectorAll(".pdf-render-box > .scroll-content .vue-pdf-embed")[0];Xe=g&&g.clientHeight}let o=Math.floor(Math.abs(e)/Xe)+1;Ye.value=Math.max(o,1)},et=u(null),tt=u(null),on=e=>{let{key:o}=e;m.value&&m.value.getScrollInstance().disable(),o==1&&et.value.show({type:o,pdf_page_num:Ye.value}),o==2&&ct(),o==3&&et.value.show({type:o,pdf_page_num:0})},dt=e=>{tt.value&&tt.value.show(e)},pt=()=>{m.value&&m.value.getScrollInstance().enable()},sn=()=>{pt(),M()},ft=()=>{G.value=!G.value},nt=(e,o)=>{let g=JSON.parse(JSON.stringify(e));return g.content=o,g.word_total=o.length,g},Me=u(!1),Pe=u(1),mt=({index:e,beforeContent:o,selectedContent:g,afterContent:L,isFullSelection:A})=>{const S=[...x.value];Me.value=A,Pe.value=1,A?(S.splice(e+1,0,nt(S[e],g)),S.splice(e,1)):(S[e].content=o||"",S[e].word_total=o.length||0,L.trim()&&S.splice(e+1,0,nt(S[e],L)),S.splice(e+1,0,nt(S[e],g)),S[e+1].images=[],S.splice(e,1)),x.value=S,Ne(S,e)},vt=({index:e,beforeContent:o,selectedContent:g,afterContent:L,isFullSelection:A})=>{const S=[...x.value];Me.value=A,Pe.value=2;let z=S[e+1].word_total;A?(S[e+1].content=+g,S[e+1].word_total=parseInt(z)+g.length,S.splice(e,1),x.value=S,Ne(S,e)):(S[e].content=o||"",S[e].word_total=o.length||0,S[e+1].content+=g,S[e+1].word_total=parseInt(z)+g.length,L.trim()&&(S[e].content+=L||"",S[e].word_total+=L.length||0),x.value=S,Ne(S,e+1))},gt=({index:e,beforeContent:o,selectedContent:g,afterContent:L,isFullSelection:A})=>{const S=[...x.value];Me.value=A,Pe.value=3;let z=S[e-1].word_total;A?(S[e-1].content+=g,S[e-1].word_total=parseInt(z)+g.length,S.splice(e,1),x.value=S,Ne(S,e)):(S[e].content=o||"",S[e].word_total=o.length||0,S[e-1].content+=g,S[e-1].word_total=parseInt(z)+g.length,L.trim()&&(S[e].content+=L||"",S[e].word_total+=L.length||0),x.value=S,Ne(S,e-1))},ht=({index:e,beforeContent:o,afterContent:g,isFullSelection:L})=>{const A=[...x.value];Me.value=L,Pe.value=4,L?A.splice(e,1):(A[e].content=o||"",A[e].word_total=o.length||0,g.trim()&&(A[e].content+=g||"",A[e].word_total+=g.length||0)),x.value=A,Ne(A,e)};function ln(e,o,g={},L){let A=L+1;if(!Array.isArray(e)||!Array.isArray(o))return JSON.stringify([]);const S=e.map((z,we)=>{const Q={};for(const Z of o){const Oe=g[Z]||Z,de=z[Oe];if(Object.prototype.hasOwnProperty.call(z,Oe))if(Z==="number")Q[Z]=we+1;else if(Z==="father_chunk_paragraph_number")Q[Z]=+de;else if(Z==="page_num"||Z==="word_total")Q[Z]=+de;else if(Z==="content"){if(!de)return null;Q[Z]=de}else Z==="images"?Pe.value==1?Me.value?(A==Q.number,Q[Z]=de):A+1==Q.number?Q[Z]=[]:Q[Z]=de:Pe.value==2?(Me.value,A==Q.number,Q[Z]=de):Pe.value==3?Me.value?(A-1==Q.number,Q[Z]=de):(A==Q.number,Q[Z]=de):Pe.value==4&&(Me.value,Q[Z]=de):Q[Z]=de}return Q}).filter(z=>z!==null&&z.content!==void 0&&z.content!=="");return JSON.stringify(S)}const rn={similar_question_list:"similar_questions"},Ne=async(e,o)=>{let g={...c,semantic_chunk_model_config_id:c.semantic_chunk_model_config_id?+c.semantic_chunk_model_config_id:0,ai_chunk_model_config_id:c.ai_chunk_model_config_id?+c.ai_chunk_model_config_id:0,is_table_file:Te.value};delete g.id;let L={id:k.query.id,word_total:ge.value,split_params:JSON.stringify(g),list:ln(e,["number","father_chunk_paragraph_number","page_num","title","content","question","similar_question_list","answer","word_total","images"],rn,o)};g.is_qa_doc==1&&(L.qa_index_type=g.qa_index_type),r.value=!0,On(L).then(A=>{he.success("操作成功");const S=A.data;for(let z=0;z<S.length;z++){const we=S[z],Q=x.value[z];if(z<x.value.length)Q.id=we.toString(),Q.status="0",Q.status_text=Re[Q.status];else break}}).finally(()=>{r.value=!1})};return Be(()=>{ce(),k.query.graph_status&&(i.graph_status=k.query.graph_status,M())}),(e,o)=>{var bt,St,wt;const g=En("router-link"),L=Gn,A=Bn,S=Ze,z=Nt,we=Vn,Q=jt,Z=Jt,Oe=it,de=lt,kt=rt,un=Jn,cn=Je,Qe=Ke,yt=Wn,_n=jn,dn=Zn,pn=Qn,fn=ot("viewer");return l(),v("div",fs,[a("div",ms,[t(A,null,{default:s(()=>[t(L,null,{default:s(()=>[t(g,{to:"/library/list"},{default:s(()=>o[8]||(o[8]=[q(" 知识库管理 ")])),_:1,__:[8]})]),_:1}),t(L,null,{default:s(()=>[t(g,{to:{path:"/library/details/knowledge-document",query:{id:p.value.library_id}}},{default:s(()=>[a("div",vs,oe(p.value.library_name)+"知识库",1)]),_:1},8,["to"])]),_:1}),t(L,null,{default:s(()=>o[9]||(o[9]=[q("知识库详情")])),_:1,__:[9]})]),_:1}),a("div",gs,[t(Kn,{startLists:D.value,onChange:se},null,8,["startLists"])])]),a("div",hs,[t(Y(Un),{onClick:me}),a("span",ks,oe(p.value.file_name),1),t(ho,{detailsInfo:p.value},null,8,["detailsInfo"])]),a("div",ys,[a("div",bs,[G.value?(l(),j(z,{key:1,onClick:o[1]||(o[1]=K=>ft())},{default:s(()=>[t(S,{class:"preview-box-icon",name:"expand"}),o[11]||(o[11]=q(" 展开预览"))]),_:1,__:[11]})):(l(),j(z,{key:0,onClick:o[0]||(o[0]=K=>ft())},{default:s(()=>[t(S,{class:"preview-box-icon",name:"put-away"}),o[10]||(o[10]=q(" 收起预览"))]),_:1,__:[10]}))]),t(un,null,{default:s(()=>[t(we,{value:i.search,"onUpdate:value":o[2]||(o[2]=K=>i.search=K),placeholder:"搜索内容",style:{width:"200px"},allowClear:"",onChange:M},null,8,["value"]),y.value?(l(),j(Z,{key:0,value:i.status,"onUpdate:value":o[3]||(o[3]=K=>i.status=K),placeholder:"请选择",style:{width:"160px"},onChange:M},{default:s(()=>[t(Q,{value:-1},{default:s(()=>o[12]||(o[12]=[q("全部嵌入状态")])),_:1,__:[12]}),(l(),v(fe,null,xe(Re,(K,He)=>t(Q,{key:K,value:He},{default:s(()=>[q(oe(K),1)]),_:2},1032,["value"])),64))]),_:1},8,["value"])):B("",!0),p.value.graph_switch?(l(),j(Z,{key:1,value:i.graph_status,"onUpdate:value":o[4]||(o[4]=K=>i.graph_status=K),placeholder:"请选择",onChange:M,style:{width:"160px"}},{default:s(()=>[t(Q,{value:-1},{default:s(()=>o[13]||(o[13]=[q("全部知识图谱状态")])),_:1,__:[13]}),(l(),v(fe,null,xe(F,(K,He)=>t(Q,{key:K,value:He},{default:s(()=>[q(oe(K),1)]),_:2},1032,["value"])),64))]),_:1},8,["value"])):B("",!0),t(kt,null,{overlay:s(()=>[t(de,null,{default:s(()=>[t(Oe,{onClick:Vt},{default:s(()=>o[14]||(o[14]=[q("重新嵌入向量")])),_:1,__:[14]}),p.value.graph_switch?(l(),j(Oe,{key:0,onClick:Wt},{default:s(()=>o[15]||(o[15]=[q("重新抽取知识图谱")])),_:1,__:[15]})):B("",!0),t(Oe,{onClick:Zt},{default:s(()=>o[16]||(o[16]=[q("重命名")])),_:1,__:[16]}),ee.value==2?(l(),j(Oe,{key:1,onClick:Kt},{default:s(()=>o[17]||(o[17]=[q("设置更新频率")])),_:1,__:[17]})):B("",!0)]),_:1})]),default:s(()=>[t(z,null,{default:s(()=>[o[18]||(o[18]=q("其他操作 ")),t(Y($t))]),_:1,__:[18]})]),_:1}),ee.value!=3?(l(),j(z,{key:2,onClick:ct},{default:s(()=>o[19]||(o[19]=[q("重新分段")])),_:1,__:[19]})):B("",!0),t(z,{onClick:o[5]||(o[5]=K=>pe({})),type:"primary"},{icon:s(()=>[t(Y(Dt))]),default:s(()=>[o[20]||(o[20]=a("span",null,"添加分段",-1))]),_:1,__:[20]})]),_:1})]),U.value?(l(),v("div",Ss,[t(cn)])):(l(),v(fe,{key:1},[y.value?(l(),v(fe,{key:0},[w.value?(l(),j(at,{key:0,onOpenEditSubscription:pe})):(l(),j(Ae,{key:1,scrollbar:{minSize:0},onOnScrollEnd:H},{default:s(()=>[a("div",ws,[t(cs,{ref:"subsectionBoxRef",total:ge.value,paragraphLists:x.value,search:i.search,detailsInfo:p.value,onOpenEditSubscription:pe,onHandleDelParagraph:ne,onHandleConvert:Se,onGetStatrList:N},null,8,["total","paragraphLists","search","detailsInfo"])])]),_:1}))],64)):(l(),v(fe,{key:1},[I.value||ee.value==3?(l(),v(fe,{key:0},[w.value?(l(),j(at,{key:0,onOpenEditSubscription:pe})):(l(),j(Ae,{key:1,scrollbar:{minSize:0},onOnScrollEnd:H,disableMouse:!0},{default:s(()=>[a("div",xs,[t(qt,{ref:"subsectionBoxRef",total:ge.value,detailsInfo:p.value,paragraphLists:x.value,search:i.search,onOpenEditSubscription:pe,onHandleDelParagraph:ne,onHandleConvert:Se,onHandleScrollTargetPage:_t,onGetStatrList:N,onHandleSplit:mt,onHandleSplitNext:vt,onHandleSplitUp:gt,onHandleSplitDelete:ht,onHandleSegmentation:dt},null,8,["total","detailsInfo","paragraphLists","search"])])]),_:1}))],64)):(l(),v("div",Cs,[a("div",{class:zt(["view-content-wrap",{collapsed:G.value}])},[((bt=p.value)==null?void 0:bt.file_ext)=="pdf"?(l(),v("div",$s,[t(_n,{value:C.value,"onUpdate:value":o[6]||(o[6]=K=>C.value=K)},{default:s(()=>[t(yt,{value:1},{default:s(()=>[t(Qe,{placement:"right",title:"原文预览模式下，会展示pdf原始文件内容，手动编辑分段的不会展示。您可以通过原文预览模式，校验分段准确性，然后手动编辑分段。"},{default:s(()=>[o[21]||(o[21]=q(" 原文预览 ")),C.value==1&&je.value>0?(l(),v("span",Ls,"("+oe(Ye.value)+" / "+oe(je.value)+")",1)):B("",!0)]),_:1,__:[21]})]),_:1}),t(yt,{value:2},{default:s(()=>o[22]||(o[22]=[q("纯文本预览")])),_:1,__:[22]})]),_:1},8,["value"])])):B("",!0),((St=p.value)==null?void 0:St.file_ext)=="pdf"?(l(),v("div",qs,[t(kt,null,{overlay:s(()=>[t(de,{onClick:on},{default:s(()=>[C.value==1&&je.value>0?(l(),j(Oe,{key:1},{default:s(()=>[t(Qe,{placement:"right",title:"将当前页重新解析并分段"},{default:s(()=>o[23]||(o[23]=[a("div",null,"将当页重新分段",-1)])),_:1,__:[23]})]),_:1})):B("",!0),(l(),j(Oe,{key:2},{default:s(()=>[t(Qe,{placement:"right",title:"将整个文档重新分段，注意，重新分段并不会重新提取文档的内容，只是将内容重新分段。"},{default:s(()=>o[24]||(o[24]=[a("div",null,"将文档重新分段",-1)])),_:1,__:[24]})]),_:1})),(l(),j(Oe,{key:3},{default:s(()=>[t(Qe,{placement:"right",title:"将整个文档重新学习，包含重新解析并提取文档内容，重新分段。"},{default:s(()=>o[25]||(o[25]=[a("div",null,"重新学习文档",-1)])),_:1,__:[25]})]),_:1}))]),_:1})]),default:s(()=>[t(z,null,{default:s(()=>[o[26]||(o[26]=q(" 重新分段 ")),t(Y($t))]),_:1,__:[26]})]),_:1})])):B("",!0),((wt=p.value)==null?void 0:wt.file_ext)=="pdf"&&C.value==1?(l(),j(So,{key:2,ref_key:"pdfRef",ref:m,class:"scroll-box pdf-render-box",source:W.value,onSelect:en,onScroll:an,onRendered:tn,onGetTotalPage:nn},null,8,["source"])):(l(),j(Ae,{key:3,scrollbar:O.value,ref_key:"leftScrollRef",ref:h,class:"scroll-box",onOnScrollEnd:H},{default:s(()=>[a("div",Os,[(l(!0),v(fe,null,xe(x.value,(K,He)=>(l(),v("div",{class:"list-item",onClick:xt=>ve(He),key:He},[K.question?(l(),v("div",Is,oe(K.question),1)):B("",!0),K.answer?(l(),v("div",Rs,oe(K.answer),1)):B("",!0),a("div",{class:"content-box",innerHTML:K.content},null,8,Ts),st((l(),v("div",Ms,[(l(!0),v(fe,null,xe(K.images,(xt,mn)=>(l(),v("img",{key:mn,src:xt,alt:""},null,8,Ps))),128))])),[[fn]])],8,Es))),128))])]),_:1},8,["scrollbar"]))],2),a("div",zs,[y.value?B("",!0):(l(),v("div",Fs,[t(pn,{activeKey:i.status,"onUpdate:activeKey":o[7]||(o[7]=K=>i.status=K),style:{"background-color":"#f2f4f7",padding:"0px 16px","border-radius":"6px"},onChange:M},{default:s(()=>[(l(!0),v(fe,null,xe(ze,K=>(l(),j(dn,{key:K.value,tab:`${K.label} (${K.num})`},null,8,["tab"]))),128))]),_:1},8,["activeKey"])])),w.value?(l(),j(at,{key:1,onOpenEditSubscription:pe})):(l(),j(Ae,{key:2,scrollbar:O.value,disableMouse:!0,ref_key:"rightScrollRef",ref:ue,onOnScrollEnd:H},{default:s(()=>[a("div",Ds,[t(qt,{ref:"subsectionBoxRef",total:ge.value,detailsInfo:p.value,paragraphLists:x.value,search:i.search,onOpenEditSubscription:pe,onHandleDelParagraph:ne,onHandleConvert:Se,onHandleScrollTargetPage:_t,onGetStatrList:N,onHandleSplit:mt,onHandleSplitNext:vt,onHandleSplitUp:gt,onHandleSplitDelete:ht,onHandleSegmentation:dt},null,8,["total","detailsInfo","paragraphLists","search"])])]),_:1},8,["scrollbar"]))])]))],64))],64)),t(sa,{detailsInfo:p.value,onHandleEdit:R,ref_key:"editSubscriptionRef",ref:_e},null,8,["detailsInfo"]),t(ko,{onOk:Yt,ref_key:"updateFrequencyRef",ref:Ie},null,512),t(la,{onOk:Xt,ref_key:"renameModalRef",ref:ut},null,512),t(Ao,{onOk:sn,onEnable:pt,detailsInfo:p.value,ref_key:"reSegmentationPageRef",ref:et},null,8,["detailsInfo"]),t(ps,{ref_key:"segmentationSettingModalRef",ref:tt,onOk:V},null,512)])}}},cl=$e(Hs,[["__scopeId","data-v-ef9fc281"]]);export{cl as default};
