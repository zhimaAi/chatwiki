import{_ as Le,d as Ze,by as vn,a_ as Et,az as It,aZ as Rt,aA as Tt,aM as gn,aB as hn,bo as Mt,bD as kn,bp as yn,bq as bn,bs as Sn,bE as wn,a as Pt,bF as xn,c as Cn,bG as $n,aF as $t,bH as Ln,bI as qn,br as On}from"../../index-C5-B0r5-.js";import{ac as v,ad as i,as as a,k as t,ar as l,u as Y,f as u,r as qe,o as Be,az as A,at as se,F as fe,ax as xe,y as Qe,aw as Ue,e as ke,b as zt,q as ot,G as O,ah as Fe,B as ye,ai as st,n as lt,ae as G,av as Ft,aA as En}from"./vue-chunks-CGLjTDrY.js";import{_ as In}from"./empty-CzGZrENG.js";import{a6 as Dt,B as Nt,ay as Rn,al as Je,M as be,a5 as Tn,W as Ee,v as Ke,a9 as Mn,bz as Ve,bA as Ht,h as it,i as rt,am as At,k as ut,az as Bt,ab as Ut,b as he,F as Pn,e as zn,y as Jt,z as Gt,E as Fn,bE as Dn,ai as Nn,aR as Hn,G as An,m as Bn,aB as Un,bG as Jn,w as Gn,a3 as jn,n as Qn,I as Vn,D as Lt,Z as Wn,a4 as Zn}from"./ui-antd-B11sc9DP.js";import{C as jt,S as Kn}from"./classification-mark-modal-BIw1WBrz.js";import{h as Xn,Z as Yn,P as ea,H as ta,C as na}from"./neo4j-Bk0ySkcX.js";import{Z as aa,C as oa}from"./cu-scroll-Crp_3Js4.js";import{c as We,E as sa}from"./edit-subsection-xJH9lVnk.js";import{_ as Ae}from"./cu-scroll-C_QJcxx1.js";import{R as la}from"./rename-modal-DrrHe3kB.js";import{V as qt}from"./vue3-pdf-embed-DgOucjo9.js";import{S as ia,a as ra,D as ua,E as ca}from"./edit-fragment-alert-CyyUQ1Zg.js";import"./utils-BH-4gQMj.js";import"./other-BrZCAsTs.js";import"./pull-up.esm-DIiTC7VE.js";import"./observe-dom.esm-B25JyVKH.js";import"./index-B2MTQrOC.js";import"./index-GO4nEZEO.js";import"./util-BwuffJOK.js";import"./model-select-DkFuDwQt.js";import"./index-Btdd0zUd.js";import"./editor-code-DDvPSeJb.js";import"./vue-pdf-embed-DYPuxmVf.js";const da={class:"empty-box"},_a={__name:"empty",props:{detailsInfo:{type:Object}},emits:["openEditSubscription"],setup(re,{emit:ie}){const L=ie,V=()=>{L("openEditSubscription",{})};return(m,c)=>{const _=Nt;return i(),v("div",da,[c[1]||(c[1]=a("img",{src:In,alt:""},null,-1)),c[2]||(c[2]=a("div",{class:"title"},"知识库文档为空，请添加分段",-1)),a("div",null,[t(_,{type:"primary",onClick:V},{icon:l(()=>[t(Y(Dt))]),default:l(()=>[c[0]||(c[0]=a("span",null,"添加分段",-1))]),_:1})])])}}},at=Le(_a,[["__scopeId","data-v-8eb7d862"]]),pa={class:"chart-wrapper"},fa={class:"zoom-toolbar-wrapper"},ma={__name:"chart-box",emits:["nodeClick"],setup(re,{expose:ie,emit:L}){const V=L,m=u(null);let c=null;const _=qe({nodes:[],edges:[]}),P=u(1),z={},F=()=>{c&&c.destroy();const w={layout:"forceDirected",initialZoom:P.value,disableTelemetry:!0,maxZoom:10,minZoom:.1,minimapContainer:document.getElementById("chatMap"),styling:{minimapViewportBoxColor:"#4399FF",selectedBorderColor:"rgba(255, 255, 255, 1)"}},y=document.getElementById("chartBox");c=new Xn(y,_.nodes,_.edges,w,z);const p=new Yn(c);new ea(c),p.updateCallback("onZoom",C=>{P.value=Number(C.toFixed(1))}),new ta(c,{drawShadowOnHover:!0}),new na(c,{selectOnClick:!0}).updateCallback("onNodeClick",C=>{V("nodeClick",C)})},E=w=>{P.value=w,c&&c.setZoom(w)},k=({nodes:w,edges:y})=>{_.nodes=[_.nodes,...w],_.edges=[_.edges,...y],c&&c.addElementsToGraph(w,y)},ee=({nodes:w,edges:y})=>{_.nodes=[_.nodes,...w],_.edges=[_.edges,...y],c&&c.addAndUpdateElementsInGraph(w,y)},b=({nodes:w,edges:y})=>{_.nodes=w,_.edges=y,c&&c.updateElementsInGraph(w,y)},R=()=>{c&&c.destroy()},te=({nodes:w,edges:y})=>{_.nodes=w,_.edges=y,F()};return Be(()=>{}),ie({render:te,add:k,addAndUpdate:ee,update:b,destroy:R}),(w,y)=>(i(),v("div",pa,[a("div",{class:"chart",id:"chartBox",ref_key:"chartBox",ref:m},null,512),y[0]||(y[0]=a("div",{class:"chart-mini-map",id:"chatMap"},null,-1)),a("div",fa,[t(aa,{value:P.value,onChange:E},null,8,["value"])])]))}},va=Le(ma,[["__scopeId","data-v-f0ead6c0"]]),ga={key:0,class:"popup-wrapper entity-details-wrapper"},ha={class:"popup-header"},ka={key:0,class:"popup-body"},ya={class:"popup-content"},ba={class:"entity-details"},Sa={class:"entity-item"},wa={class:"entity-name"},xa={class:"entity-item",style:{"margin-bottom":"8px"}},Ca={class:"file-info"},$a={class:"file-name"},La={class:"entity-item"},qa={class:"doc-item"},Oa={class:"fragment-content"},Ea={class:"entity-item"},Ia={key:0,class:""},Ra={class:"fragment-content"},Ta={__name:"entity-details",setup(re,{expose:ie}){const L=qe({show:!1,node:null,fromNodes:[]}),V=()=>{L.show=!1};return ie({open:(c,_)=>{L.node=c,L.fromNodes=_,L.show?(L.show=!1,Qe(()=>{L.show=!0})):L.show=!0},close:V}),(c,_)=>{const P=Ze;return L.show?(i(),v("div",ga,[a("div",ha,[_[0]||(_[0]=a("div",{class:"popup-title"},"实体详情",-1)),t(Y(Rn),{class:"close-btn",onClick:V})]),L.node?(i(),v("div",ka,[t(oa,null,{default:l(()=>[a("div",ya,[a("div",ba,[a("div",Sa,[_[1]||(_[1]=a("div",{class:"entity-item-header"},[a("div",{class:"entity-item-label"},"实体")],-1)),a("div",wa,se(L.node.name),1)]),a("div",xa,[_[2]||(_[2]=a("div",{class:"entity-item-header"},[a("div",{class:"entity-item-label"},"归属文档")],-1)),a("div",Ca,[t(P,{class:"file-icon",name:"doc-file",style:{}}),a("span",$a,se(L.node.file_name),1)])]),a("div",La,[_[3]||(_[3]=a("div",{class:"entity-item-header"},[a("div",{class:"entity-item-label"},"分段")],-1)),a("div",null,[a("div",qa,[a("div",Oa,se(L.node.content),1)])])]),a("div",Ea,[_[4]||(_[4]=a("div",{class:"entity-item-header"},[a("div",{class:"entity-item-label"},"子图")],-1)),a("div",null,[L.fromNodes.length==0?(i(),v("div",Ia,"无")):A("",!0),(i(!0),v(fe,null,xe(L.fromNodes,z=>(i(),v("div",{class:"subgraph-item",key:z.id},[a("div",Ra,se(z.name),1)]))),128))])])])])]),_:1})])):A("",!0)])):A("",!0)}}},Ma=Le(Ta,[["__scopeId","data-v-bb7b1011"]]),Pa={class:"graph-model-body"},za={key:0,class:"loading-wrapper"},Fa={class:"right-box"},Da={__name:"index",setup(re,{expose:ie}){const L=u(!1),V=u(null),m=u(null),c=u(null),_=u(!1),P=qe({file_id:"",data_id:""}),z=qe({edges:[],nodes:[]});let F={};const E=()=>{k()},k=()=>{_.value=!0,vn({file_id:P.file_id,data_id:P.data_id,search_term:P.search_term}).then(w=>{_.value=!1;let y=w.data.edges||[],p=w.data.nodes||[];const r=new Map;y=y.filter(h=>{const ue=`${h.from_id}_${h.to_id}`,oe=`${h.to_id}_${h.from_id}`;return r.has(ue)||r.has(oe)?!1:(r.set(ue,!0),!0)}),y.forEach(h=>{h.id=h.id.toString(),h.from=h.from_id.toString(),h.to=h.to_id.toString(),h.caption=h.label});const C=new Set(y.map(h=>h.from)),W=new Set(y.map(h=>h.to));p.forEach(h=>{h.caption=h.name,h.id=h.id.toString(),h.nodeType=C.has(h.id)&&W.has(h.id)?"both":C.has(h.id)?"from":W.has(h.id)?"to":"normal",h.nodeType==="from"?(h.size=35,h.color="#FFB1B2"):h.nodeType==="to"?(h.size=45,h.color="#005AFF"):(h.size=30,h.color="#69E9BE")});let me={edges:y,nodes:p};z.edges=me.edges,z.nodes=me.nodes,setTimeout(()=>{m.value.render(me)},0),F={},y.forEach(h=>{F[h.to]||(F[h.to]=[]),F[h.to].push(h.from)})}).catch(w=>{_.value=!1})},ee=w=>{let y=F[w.id]||[],p=[];for(let r=0;r<z.nodes.length;r++)y.indexOf(z.nodes[r].id)>-1&&p.push(z.nodes[r]);c.value.open(w,p)},b=()=>{m.value.destroy(),L.value=!1},R=()=>{L.value=!1};return ie({open:w=>{P.file_id=w.file_id,P.data_id=w.id,L.value=!0,setTimeout(()=>{E()},350)}}),(w,y)=>{const p=Je,r=be;return i(),v("div",{ref_key:"mymodal",ref:V},[t(r,{wrapClassName:"graph-model-wrapper",zIndex:99999,centered:"",open:L.value,"onUpdate:open":y[0]||(y[0]=C=>L.value=C),title:"知识图谱",width:"90vw",footer:null,onOk:R,onCancel:b},{default:l(()=>[a("div",Pa,[_.value?(i(),v("div",za,[t(p)])):A("",!0),t(va,{ref_key:"chartBoxRef",ref:m,loading:_.value,onNodeClick:ee},null,8,["loading"]),a("div",Fa,[t(Ma,{ref_key:"entityDetailsRef",ref:c},null,512)])])]),_:1},8,["open"])],512)}}},Na=Le(Da,[["__scopeId","data-v-56e1b6be"]]),Ha={class:"subsection-box-title"},Aa=["onClick"],Ba={class:"top-block"},Ua={class:"title"},Ja={class:"title-block"},Ga={class:"status-box"},ja={class:"cfb363f"},Qa={class:"split-err"},Va={key:1},Wa={class:"cfb363f"},Za={class:"right-opration"},Ka={class:"hover-btn-box"},Xa=["onClick"],Ya=["onClick"],eo=["onClick"],to={class:"hover-btn-box"},no={class:"hover-btn-box"},ao=["onClick"],oo=["onClick"],so={key:0,class:"content-box"},lo=["innerHTML"],io={key:1,class:"content-box"},ro=["innerHTML"],uo=["onMouseup","innerHTML"],co={key:2,class:"fragment-img"},_o=["src"],po={__name:"subsection-box",props:{paragraphLists:{type:Array,default:()=>[]},search:{type:String,default:""},detailsInfo:{type:Object,default:()=>{}},total:{type:[Number,String],default:0}},emits:["handleDelParagraph","handleScrollTargetPage","openEditSubscription","handleConvert","getStatrList","handleSplit","handleSplitNext","handleSplitUp","handleSplitDelete","handleSegmentation"],setup(re,{expose:ie,emit:L}){const V=Ue(),m=L,c=re,_=(d,s)=>{let{id:Q,title:T,content:_e,question:D,answer:J,images:Z,category_id:f}=d,le=d.similar_questions||[];be.confirm({title:"重新转换确认",icon:null,content:`确定要重新转换【分段${s+1}】吗?`,onOk(){return new Promise(N=>{Rt({id:Q,title:T,content:_e,question:D,answer:J,images:Z,category_id:f,similar_questions:JSON.stringify(le)}).then(()=>{m("handleConvert",d),N()}).catch(()=>{N()})})},onCancel(){}})},P=d=>{m("openEditSubscription",d)},z=d=>{be.confirm({title:"提示",icon:t(Ee),content:"确认是否删除该分段?",onOk(){return new Promise(s=>{Tt({id:d}).then(()=>{he.success("删除成功"),m("handleDelParagraph",d),s()}).catch(()=>{s()})})},onCancel(){}})},F=(d,s,Q)=>{window.getSelection().toString().trim()||(m("handleScrollTargetPage",{page_num:d.page_num,index:s}),Ce(Q))},E=d=>{m("handleSegmentation",d)},k=u([]),ee=()=>{let d={file_id:V.query.id};Et(d).then(s=>{k.value=s.data||[],m("getStatrList",s.data||[])})};ee();const b=u(null),R=()=>{b.value.show()},te=d=>{var Q;let s=(Q=k.value.filter(T=>T.id==d.category_id)[0])==null?void 0:Q.type;return s?We[s]:""},w=(d,s={})=>{It({id:d.id,category_id:s.id||0}).then(()=>{he.success("设置成功"),d.category_id=s.id,ee()})},y=u(null),p=d=>{y.value.open(d)},r=u(null),C=u(!1),W=u({x:0,y:0}),me=u(""),h=u(null),ue=u({text:"",parentIndex:-1,originalHtml:""}),oe=ke(()=>{if(!C.value)return{};const d=162;let s=W.value.x,Q=W.value.y;const T=r.value.getBoundingClientRect(),_e=window.innerWidth;s<10?s=10:s+d>_e-50&&(s=_e-d-50);const D=s-T.left,J=Q;return{left:`${D}px`,top:`${J}px`}}),ve=(d,s)=>{setTimeout(()=>{const Q=window.getSelection(),T=Q.toString().trim();if(T){d.stopPropagation(),ue.value={text:T,parentIndex:s,originalHtml:c.paragraphLists[s].content},me.value=T,h.value=Q.getRangeAt(0).cloneRange();const D=Q.getRangeAt(0).getBoundingClientRect(),J=r.value.getBoundingClientRect();W.value={x:D.left+D.width/2,y:D.top-J.top-50},C.value=!0}else C.value=!1},50)},B=d=>{const{parentIndex:s}=ue.value;switch(d){case"separate":ne(s);break;case"merge-next":x(s);break;case"merge-prev":ge(s);break;case"delete":Te(s);break}C.value=!1,window.getSelection().removeAllRanges()},I=(d,s,Q)=>{if(s===0&&Q===d.textContent.length&&d.textContent.trim().length>0)return["",d.innerHTML,""];const _e=document.createTreeWalker(d,NodeFilter.SHOW_TEXT);let D,J=0,Z,f,le,N;for(;D=_e.nextNode();){const $=D.nodeValue.length;if(!Z&&J+$>=s&&(Z=D,le=s-J),!f&&J+$>=Q){f=D,N=Q-J;break}J+=$}const $e=document.createRange();$e.setStart(Z,le),$e.setEnd(f,N);const ze=document.createRange();ze.setStart(d,0),ze.setEnd(Z,le);const n=document.createRange();return n.setStart(f,N),n.setEnd(d,d.childNodes.length),[U(ze),U($e),U(n)]},U=d=>{const s=document.createElement("div");return s.appendChild(d.cloneContents()),s.innerHTML},ne=d=>{const s=c.paragraphLists[d].content,T=window.getSelection().getRangeAt(0);T.toString()&&be.confirm({title:"单独分段",icon:t(Ee),content:"确认将该分段内容单独分段么？分段后，原分段的内容会被删除",onOk(){const D=document.createElement("div");D.innerHTML=s;const[J,Z,f]=I(D,T.startOffset,T.endOffset),le=J.replace(/<[^>]+>/g,"").trim()==="",N=f.replace(/<[^>]+>/g,"").trim()==="";le&&N?m("handleSplit",{index:d,beforeContent:"",selectedContent:Z,afterContent:"",isFullSelection:!0}):m("handleSplit",{index:d,beforeContent:J,selectedContent:Z,afterContent:f,originalSelection:{start:T.startOffset,end:T.endOffset,parentIndex:d}})}})},x=d=>{if(d>=c.paragraphLists.length-1)return he.error("没有下一个分段");const s=c.paragraphLists[d].content,T=window.getSelection().getRangeAt(0);T.toString()&&be.confirm({title:"合并到下一个分段",icon:t(Ee),content:"确认将该分段内容合并到下一个分段么？分段后，原分段的内容会被删除",onOk(){const D=document.createElement("div");D.innerHTML=s;const[J,Z,f]=I(D,T.startOffset,T.endOffset),le=J.replace(/<[^>]+>/g,"").trim()==="",N=f.replace(/<[^>]+>/g,"").trim()==="";le&&N?m("handleSplitNext",{index:d,beforeContent:"",selectedContent:Z,afterContent:"",isFullSelection:!0}):m("handleSplitNext",{index:d,beforeContent:J,selectedContent:Z,afterContent:f,originalSelection:{start:T.startOffset,end:T.endOffset,parentIndex:d}})}})},ge=d=>{if(d<=0)return he.error("没有上一个分段");const s=c.paragraphLists[d].content,T=window.getSelection().getRangeAt(0);T.toString()&&be.confirm({title:"合并到上一个分段",icon:t(Ee),content:"确认将该分段内容合并到上一个分段么？分段后，原分段的内容会被删除",onOk(){const D=document.createElement("div");D.innerHTML=s;const[J,Z,f]=I(D,T.startOffset,T.endOffset),le=J.replace(/<[^>]+>/g,"").trim()==="",N=f.replace(/<[^>]+>/g,"").trim()==="";le&&N?m("handleSplitUp",{index:d,beforeContent:"",selectedContent:Z,afterContent:"",isFullSelection:!0}):m("handleSplitUp",{index:d,beforeContent:J,selectedContent:Z,afterContent:f,originalSelection:{start:T.startOffset,end:T.endOffset,parentIndex:d}})}})},Te=d=>{const s=c.paragraphLists[d].content,T=window.getSelection().getRangeAt(0);T.toString()&&be.confirm({title:"删除",icon:t(Ee),content:"确认将该分段内容删除么？",onOk(){const D=document.createElement("div");D.innerHTML=s;const[J,Z,f]=I(D,T.startOffset,T.endOffset),le=J.replace(/<[^>]+>/g,"").trim()==="",N=f.replace(/<[^>]+>/g,"").trim()==="";le&&N?m("handleSplitDelete",{index:d,beforeContent:"",selectedContent:"",afterContent:"",isFullSelection:!0}):m("handleSplitDelete",{index:d,beforeContent:J,selectedContent:"",afterContent:f,originalSelection:{start:T.startOffset,end:T.endOffset,parentIndex:d}})}})},Ce=d=>{C.value&&!d.target.closest(".bubble-card")&&(C.value=!1)};function De(d,s){if(c.detailsInfo.chunk_type!=4||s==0)return!1;let Q=c.paragraphLists[s-1];return d.father_chunk_paragraph_number==Q.father_chunk_paragraph_number}function Ie(d,s,Q={}){if(!s||!d)return d;const{highlightClass:T="highlight",caseSensitive:_e=!1,wholeWord:D=!1}=Q,J=_e?"g":"gi";let Z;return D?Z=new RegExp(`\\b${Se(s)}\\b`,J):Z=new RegExp(Se(s),J),d.replace(Z,f=>`<span class="${T}">${f}</span>`)}function Se(d){return d.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}return Be(()=>{document.addEventListener("click",Ce)}),zt(()=>{document.removeEventListener("click",Ce)}),ie({handleOpenEditModal:P}),(d,s)=>{const Q=Ke,T=rt,_e=it,D=ut,J=Ze,Z=ot("viewer");return i(),v("div",{class:"subsection-box content-container",ref_key:"containerRef",ref:r},[a("div",Ha,[s[4]||(s[4]=O(" 分段预览 ",-1)),a("span",null,"共"+se(c.total)+"个分段",1)]),(i(!0),v(fe,null,xe(c.paragraphLists,(f,le)=>(i(),v("div",{class:st(["list-item",{"fragment-father-son-item":c.detailsInfo.chunk_type==4,"dashed-line":De(f,le),mt8:c.detailsInfo.chunk_type==4&&!De(f,le)}]),key:f.id,onClick:ye(N=>F(f,le,N),["stop"]),style:Fe({"--status-color":te(f)})},[a("div",Ba,[a("div",Ua,[s[8]||(s[8]=O(" 分段 ",-1)),c.detailsInfo.chunk_type==4?(i(),v(fe,{key:0},[O(se(f.father_chunk_paragraph_number)+"-",1)],64)):A("",!0),O(" "+se(f.number)+" ",1),a("div",Ja,se(f.title),1),a("span",null,"共"+se(f.word_total)+"个字符",1),a("span",Ga,[O(" 嵌入状态："+se(f.status_text),1),f.status==3?(i(),G(Y(Tn),{key:0})):A("",!0),f.status==2&&f.errmsg?(i(),G(Q,{key:1,title:f.errmsg},{default:l(()=>[a("strong",ja,[s[5]||(s[5]=O("原因",-1)),t(Y(Ee),{class:"err-icon cfb363f"})])]),_:1},8,["title"])):A("",!0),f.split_status==4&&f.split_err_msg?(i(),G(Q,{key:2,title:f.split_err_msg},{default:l(()=>[a("div",Qa,[t(Y(Mn),{style:{"margin-left":"0"},class:"cfb363f"}),s[6]||(s[6]=O(" 分段失败 ",-1))])]),_:1},8,["title"])):A("",!0)]),re.detailsInfo.graph_switch?(i(),v("span",Va,[O(" 知识图谱状态："+se(f.graph_status_text)+" ",1),f.graph_status==3&&f.graph_err_msg?(i(),G(Q,{key:0,title:f.graph_err_msg},{default:l(()=>[a("strong",Wa,[s[7]||(s[7]=O("原因",-1)),t(Y(Ee),{class:"err-icon cfb363f"})])]),_:1},8,["title"])):A("",!0)])):A("",!0)]),a("div",Za,[t(D,null,{overlay:l(()=>[t(_e,null,{default:l(()=>[(i(!0),v(fe,null,xe(k.value,N=>(i(),G(T,{key:N.id},{default:l(()=>[a("div",{class:"start-item",onClick:ye($e=>w(f,N),["stop"])},[t(Y(Ve),{style:Fe({color:Y(We)[N.type]})},null,8,["style"]),a("div",null,se(N.name||"-"),1)],8,Xa)]),_:2},1024))),128)),t(T,null,{default:l(()=>[a("div",{class:"start-item",onClick:ye(R,["stop"])},[t(Y(At)),s[9]||(s[9]=a("div",null,"精选设置",-1))])]),_:1})]),_:2},1024)]),default:l(()=>[a("div",Ka,[f.category_id>0?(i(),G(Y(Ve),{key:0,onClick:ye(N=>w(f,{}),["stop"]),style:Fe({color:te(f),"font-size":"16px"})},null,8,["onClick","style"])):(i(),G(Y(Ht),{key:1,onClick:N=>w(f,k.value[0]),style:{"font-size":"16px",color:"#595959"}},null,8,["onClick"]))])]),_:2},1024),t(Q,null,{title:l(()=>[...s[10]||(s[10]=[O("重新分段",-1)])]),default:l(()=>[a("div",{class:"hover-btn-box",onClick:ye(N=>E(f),["stop"])},[t(J,{name:"segmentation-icon",style:{"font-size":"16px"}})],8,Ya)]),_:2},1024),re.detailsInfo.graph_switch?(i(),G(Q,{key:0},{title:l(()=>[...s[11]||(s[11]=[O("知识图谱",-1)])]),default:l(()=>[a("div",{class:"hover-btn-box",onClick:N=>p(f)},[t(J,{name:"graph-icon",style:{"font-size":"16px",color:"#595959"}})],8,eo)]),_:2},1024)):A("",!0),t(Q,null,{title:l(()=>[...s[12]||(s[12]=[O("重新转换",-1)])]),default:l(()=>[a("div",to,[t(Y(Bt),{onClick:ye(N=>_(f,le),["stop"])},null,8,["onClick"])])]),_:2},1024),t(D,{placement:"bottomRight"},{overlay:l(()=>[t(_e,null,{default:l(()=>[t(T,null,{default:l(()=>[a("div",{onClick:ye(N=>P(f),["stop"])},"编辑",8,ao)]),_:2},1024),t(T,null,{default:l(()=>[a("div",{onClick:ye(N=>z(f.id),["stop"])},"删除",8,oo)]),_:2},1024)]),_:2},1024)]),default:l(()=>[a("div",no,[t(Y(Ut),{style:{"font-size":"16px",color:"#595959"}})])]),_:2},1024)])]),f.question?(i(),v("div",so,[s[13]||(s[13]=O("Q： ",-1)),a("span",{innerHTML:Ie(f.question,c.search)},null,8,lo)])):A("",!0),f.answer?(i(),v("div",io,[s[14]||(s[14]=O("A：",-1)),a("span",{innerHTML:Ie(f.answer,c.search)},null,8,ro)])):A("",!0),a("div",{class:"content-box",onMouseup:ye(N=>ve(N,le),["stop"]),innerHTML:Ie(f.content,c.search)},null,40,uo),f.images.length>0?lt((i(),v("div",co,[(i(!0),v(fe,null,xe(f.images,(N,$e)=>(i(),v("img",{key:$e,src:N,alt:""},null,8,_o))),128))])),[[Z]]):A("",!0)],14,Aa))),128)),t(jt,{onOk:ee,ref_key:"classificationMarkModalRef",ref:b},null,512),t(Na,{ref_key:"graphModelRef",ref:y},null,512),C.value?(i(),v("div",{key:0,class:"bubble-card",style:Fe(oe.value)},[a("button",{class:"bubble-item",onClick:s[0]||(s[0]=ye(f=>B("separate"),["stop"]))},[t(J,{name:"segmentation",style:{"font-size":"16px",color:"#262626","margin-right":"4px"}}),s[15]||(s[15]=O(" 单独成段 ",-1))]),a("button",{class:"bubble-item",onClick:s[1]||(s[1]=ye(f=>B("merge-prev"),["stop"]))},[t(J,{name:"segmentation-up",style:{"font-size":"16px",color:"#262626","margin-right":"4px"}}),s[16]||(s[16]=O(" 合并到上一分段 ",-1))]),a("button",{class:"bubble-item",onClick:s[2]||(s[2]=ye(f=>B("merge-next"),["stop"]))},[t(J,{name:"segmentation-down",style:{"font-size":"16px",color:"#262626","margin-right":"4px"}}),s[17]||(s[17]=O(" 合并到下一分段 ",-1))]),a("button",{class:"bubble-item",onClick:s[3]||(s[3]=ye(f=>B("delete"),["stop"]))},[t(J,{name:"delete",style:{"font-size":"16px",color:"#262626","margin-right":"4px"}}),s[18]||(s[18]=O(" 删除 ",-1))])],4)):A("",!0)],512)}}},Ot=Le(po,[["__scopeId","data-v-8d10a024"]]),fo={class:"mode-box"},mo=["innerHTML"],vo={class:"tag-item"},go={__name:"segmentation-mode",props:{detailsInfo:{type:Object}},setup(re){const ie=re,L=u(""),V=ke(()=>{const{is_table_file:m,is_qa_doc:c,is_diy_split:_,question_lable:P,answer_lable:z,separators:F,chunk_size:E,chunk_overlap:k,question_column:ee,answer_column:b,qa_index_type:R,doc_type:te}=ie.detailsInfo;if(m!=1&&c!=1&&_!=1)return te==3?(L.value=`分段模式：手动分段
文档类型：普通文档`,"自定义：普通文档"):(L.value=`分段模式：智能分段
文档类型：普通文档`,"智能分段：普通文档");if(m!=1&&c==1)return te==3?(L.value=`分段模式：手动分段
文档类型：QA文档`,"自定义：QA文档"):(L.value=`分段模式：智能分段
文档类型：QA文档
问题开始标识符："${P}"
答案开始标识符："${z}"`,"智能分段：QA文档");if(m!=1&&c!=1&&_==1)return L.value=`分段模式：自定义分段
文档标识符：${F}
分段最大长度：${E}字符
文段重叠长度：${k}字符`,"自定义分段";if(m==1&&c!=1)return L.value=`分段模式：智能分段
文档类型：普通表格`,"智能分段：普通表格";if(m==1&&c==1){let w=R==1?"问题与答案一起生成索引":"仅对问题生成索引";return L.value=`分段模式：智能分段
文档类型：QA文档
问题所在列："${ee}"
答案所在列："${b}"
索引方式：${w}`,"智能分段：QA文档"}});return(m,c)=>{const _=Ke;return i(),v("div",fo,[t(_,null,{title:l(()=>[a("div",{class:"tooltip-text-box",innerHTML:L.value},null,8,mo)]),default:l(()=>[a("div",vo,se(V.value),1)]),_:1})])}}},ho=Le(go,[["__scopeId","data-v-e8649c10"]]),ko={__name:"update-frequency",emits:["ok"],setup(re,{expose:ie,emit:L}){const V=L,m=u(!1),c=u(!1),_=qe({doc_auto_renew_frequency:1,id:""}),P=F=>{let{doc_auto_renew_frequency:E,id:k}=F;_.doc_auto_renew_frequency=+E,_.id=k,m.value=!0},z=()=>{c.value=!0,gn({..._}).then(F=>{V("ok",_.doc_auto_renew_frequency),m.value=!1,he.success("设置成功")}).finally(()=>{c.value=!1})};return ie({open:P}),(F,E)=>{const k=Gt,ee=Jt,b=zn,R=Pn,te=be;return i(),v("div",null,[t(te,{open:m.value,"onUpdate:open":E[1]||(E[1]=w=>m.value=w),"confirm-loading":c.value,maskClosable:!1,title:"设置更新频率",onOk:z},{default:l(()=>[t(R,{style:{margin:"32px 0"},layout:"vertical",model:_},{default:l(()=>[t(b,{name:"doc_auto_renew_frequency",label:"更新频率",required:""},{default:l(()=>[t(ee,{value:_.doc_auto_renew_frequency,"onUpdate:value":E[0]||(E[0]=w=>_.doc_auto_renew_frequency=w),style:{width:"100%"}},{default:l(()=>[t(k,{value:1},{default:l(()=>[...E[2]||(E[2]=[O("不自动更新",-1)])]),_:1}),t(k,{value:2},{default:l(()=>[...E[3]||(E[3]=[O("每天",-1)])]),_:1}),t(k,{value:3},{default:l(()=>[...E[4]||(E[4]=[O("每3天",-1)])]),_:1}),t(k,{value:4},{default:l(()=>[...E[5]||(E[5]=[O("每7天",-1)])]),_:1}),t(k,{value:5},{default:l(()=>[...E[6]||(E[6]=[O("每30天",-1)])]),_:1})]),_:1},8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open","confirm-loading"])])}}},yo={class:"loading"},bo={__name:"pdf-preview",props:{source:{type:[String],required:!0},pageSize:{type:Number,default:10}},emits:["onScrollEnd","select","rendered","scroll","getTotalPage"],setup(re,{expose:ie,emit:L}){const V=re,m=L,c=u(null),_=u([]),P=u(0),z=u(!1),F=ke(()=>z.value?null:{"border-bottom":"2px solid #d9d9d9"}),E=u({fade:!1,scrollbarTrackClickable:!0,interactive:!0,minSize:40});Be(async()=>{const y=await qt.getDocument(V.source).promise;P.value=y.numPages,m("getTotalPage",P.value),k()});const k=(y=null)=>{const p=_.value.length;if(p>=P.value||z.value)return;z.value=!0;const r=[];for(let C=1;C<=V.pageSize&&p+C<=P.value;C++)r.push(p+C);_.value.push(...r),Qe(()=>{typeof y=="function"&&y()})},ee=y=>{k(),m("onScrollEnd",y)},b=y=>{Qe(()=>{y===_.value[_.value.length-1]&&(z.value=!1,m("rendered",y,P.value))})},R=y=>{m("select",y)},te=()=>c.value,w=y=>{m("scroll",y)};return ie({loadMore:k,getScrollInstance:te}),(y,p)=>{const r=Je;return i(),G(Ae,{scrollbar:E.value,ref_key:"scrollRef",ref:c,onScroll:w,onOnScrollEnd:ee},{default:l(()=>[(i(!0),v(fe,null,xe(_.value,C=>(i(),G(Y(qt),{onClick:W=>R(C),key:C,source:re.source,page:C,onRendered:()=>b(C),style:Fe(F.value)},null,8,["onClick","source","page","onRendered","style"]))),128)),a("div",yo,[z.value?(i(),G(r,{key:0})):A("",!0)])]),_:1},8,["scrollbar"])}}},So=Le(bo,[["__scopeId","data-v-8520f2eb"]]),wo={key:0,class:"loading-wrap"},xo={class:"document-segmentation"},Co={class:"page-container"},$o={class:"page-left"},Lo={class:"page-right"},qo={class:"document-fragment-preview"},Oo={class:"preview-header"},Eo={class:"fragment-number"},Io={key:1,class:"loading-box"},Ro="你是一位文章分段助手，根据文章内容的语义进行合理分段，确保每个分段表述一个完整的语义，每个分段字数控制在500字左右，最大不超过1000字。请严格按照文章内容进行分段，不要对文章内容进行加工，分段完成后输出分段后的内容。",To={__name:"document-segmentation-model",props:{pdfState:{type:Object,default:()=>{}},currentData:{type:Object,default:()=>{}},paragraphType:{type:String,default:""}},emits:["ok","finish","loading"],setup(re,{expose:ie,emit:L}){const V=hn(),{setInitDocumentFragmentList:m}=V,c=Ue(),_=L,{id:P}=c.query,z=u(!0),F=u(1);let E=!1;const k=re,ee=u(1);let b={id:P,separators_no:"",chunk_size:512,not_merged_text:!1,chunk_overlap:50,is_qa_doc:0,question_lable:"",answer_lable:"",enable_extract_image:!0,ai_chunk_size:5e3,ai_chunk_model:"",ai_chunk_model_config_id:"",ai_chunk_prumpt:Ro,ai_chunk_task_id:"",father_chunk_paragraph_type:2,father_chunk_separators_no:[],father_chunk_chunk_size:1024,son_chunk_separators_no:[],son_chunk_chunk_size:512};const R=u(null),te=n=>{typeof n.separators_no=="object"&&(n.separators_no=JSON.stringify(n.separators_no)),typeof n.father_chunk_separators_no=="object"&&(n.father_chunk_separators_no=JSON.stringify(n.father_chunk_separators_no)),typeof n.son_chunk_separators_no=="object"&&(n.son_chunk_separators_no=JSON.stringify(n.son_chunk_separators_no)),b={...b,...n},E?be.confirm({title:"提醒",icon:t(Ee),content:"文档片段已被编辑重新获取文档片段会丢失当前修改过的文档片段内容，确定要重新获取吗？",okText:"确定",okType:"danger",cancelText:"取消",onOk(){E=!1,ge("create")},onCancel(){}}):(E=!1,ge("create"))};let w=600,y=0;const p=u({}),r=u(0),C=()=>{z.value||(z.value=!0),Mt({id:P}).then(async n=>{const{status:$}=n.data;if(r.value=n.data.library_type,p.value=n.data,b={...b,separators_no:n.data.separators_no||"[12,11]",chunk_size:+n.data.chunk_size||512,not_merged_text:n.data.not_merged_text=="true",ai_chunk_size:+n.data.ai_chunk_size||5e3,chunk_overlap:+n.data.chunk_overlap||50,is_qa_doc:r.value==2?1:0,question_lable:n.data.question_lable,answer_lable:n.data.answer_lable,question_column:n.data.question_column,answer_column:n.data.answer_column,enable_extract_image:n.data.enable_extract_image=="true",qa_index_type:+n.data.qa_index_type,chunk_type:+n.data.chunk_type,semantic_chunk_size:+n.data.semantic_chunk_size||512,semantic_chunk_overlap:+n.data.semantic_chunk_overlap||50,semantic_chunk_threshold:+n.data.semantic_chunk_threshold||90,semantic_chunk_use_model:n.data.semantic_chunk_use_model||"",ai_chunk_prumpt:n.data.ai_chunk_prumpt||"",ai_chunk_model:n.data.ai_chunk_model||"",semantic_chunk_model_config_id:n.data.semantic_chunk_model_config_id>0?n.data.semantic_chunk_model_config_id:"",ai_chunk_model_config_id:n.data.ai_chunk_model_config_id>0?n.data.ai_chunk_model_config_id:"",ai_chunk_task_id:n.data.ai_chunk_task_id||"",father_chunk_paragraph_type:+n.data.father_chunk_paragraph_type||2,father_chunk_separators_no:n.data.father_chunk_separators_no||"[12,11]",father_chunk_chunk_size:+n.data.father_chunk_chunk_size||1024,son_chunk_separators_no:n.data.son_chunk_separators_no||"[8,10]",son_chunk_chunk_size:+n.data.son_chunk_chunk_size||512},n.data.chunk_type==0&&(b={...b,separators_no:n.data.normal_chunk_default_separators_no,chunk_size:n.data.normal_chunk_default_chunk_size,not_merged_text:n.data.normal_chunk_default_not_merged_text=="true",chunk_overlap:n.data.normal_chunk_default_chunk_overlap,chunk_type:+n.data.default_chunk_type,semantic_chunk_size:+n.data.semantic_chunk_default_chunk_size,semantic_chunk_overlap:+n.data.semantic_chunk_default_chunk_overlap,semantic_chunk_threshold:+n.data.semantic_chunk_default_threshold,semantic_chunk_use_model:n.data.default_use_model||"",semantic_chunk_model_config_id:n.data.default_model_config_id>0?n.data.default_model_config_id:""}),$==0){if(y++,y>w){be.error({title:"提醒",content:"文档解析速度慢请稍后再试"});return}setTimeout(()=>{C()},1e3)}else($==4||$==2)&&(z.value=!1,F.value=parseInt(n.data.is_table_file),n.data.library_id,r.value==2?(b.question_lable||b.question_column)&&ge():ge());n.data.is_table_file==1&&me()})};Be(async()=>{await C()});const W=u([]),me=()=>{bn({id:P}).then(n=>{let $=[];for(let ae in n.data)$.push({lable:n.data[ae],value:ae});W.value=$})},h=u([]),ue=u(!1),oe=u(!1),ve=u(""),B=u(null);let I=null;const U=u([]),ne=u(0),x=ke(()=>ne.value<=0),ge=n=>{var ce;_("loading",!0);let $={...b,semantic_chunk_model_config_id:b.semantic_chunk_model_config_id?+b.semantic_chunk_model_config_id:0,ai_chunk_model_config_id:b.ai_chunk_model_config_id?+b.ai_chunk_model_config_id:0,...k.pdfState};b.chunk_type==3&&(b.ai_chunk_task_id&&!n&&($.ai_chunk_task_id=b.ai_chunk_task_id),$.ai_chunk_task_id&&n&&n==="create"&&delete $.ai_chunk_task_id);let ae=yn;return k.paragraphType&&k.paragraphType==="paragraphsSegmented"&&n=="create"&&(ae=wn,delete $.id),k.paragraphType&&k.paragraphType==="paragraphsSegmented"&&!n?(U.value=k.currentData.list||[],ne.value=k.currentData.list.length,b.chunk_type==3&&(ve.value=((ce=k.currentData.split_params)==null?void 0:ce.ai_chunk_task_id)||"",oe.value=!0,R.value.reLoading=!0,B.value=null,!b.ai_chunk_task_id&&F.value!=1||n&&n==="create"?(U.value=[],ne.value=0,Ie()):(oe.value=!1,R.value.reLoading=!1)),b.chunk_type!=3&&(R.value.reLoading=!1,R.value.saveLoading=!1),_("loading",!1),!1):ae($).then(pe=>{var Re;h.value=pe.data.list||[],m(h.value),U.value=pe.data.list||[],ne.value=pe.data.list.length||0,b.chunk_type==3&&(ve.value=((Re=pe.data.split_params)==null?void 0:Re.ai_chunk_task_id)||"",oe.value=!0,R.value.reLoading=!0,R.value.saveLoading=!0,B.value=null,!b.ai_chunk_task_id&&F.value!=1||n&&n==="create"?(U.value=[],ne.value=0,Ie()):(oe.value=!1,R.value.reLoading=!1,R.value.saveLoading=!1))}).finally(()=>{b.chunk_type!=3&&(R.value.reLoading=!1,R.value.saveLoading=!1),_("loading",!1)})},Te=n=>{ee.value=n},Ce=async()=>{var n;try{const $=await Se();return $.data.err_msg?(B.value=$.data.err_msg,!0):((n=$.data.list)==null?void 0:n.length)>0?(h.value=$.data.list||[],m(h.value),U.value=$.data.list||[],ne.value=$.data.list.length||0,!0):!1}catch{return B.value="请求异常，停止轮询",!0}};function De(n){return n.split("message:")[1]}const Ie=()=>{const n=async()=>{if(!await Ce())I=setTimeout(n,3e3);else if(oe.value=!1,R.value.reLoading=!1,R.value.saveLoading=!1,I!==null&&(clearTimeout(I),I=null),ue.value&&N(),B.value){let ae=De(B.value);be.error({title:"分段失败提示",content:ae?`模型调用失败，失败原因：${ae}`:"模型调用失败"})}};n()},Se=()=>Sn({id:b.id,task_id:ve.value}),d=u(null);let s=null;const Q=({title:n,content:$,question:ae,answer:ce,images:pe},Re)=>{s=Re,d.value.open({title:n,content:$,question:ae,answer:ce,images:pe})},T=({title:n,content:$,question:ae,answer:ce,images:pe})=>{(U.value[s].title!=n||U.value[s].content!=$||U.value[s].question!=ae||U.value[s].answer!=ce)&&(E=!0),U.value[s].title=n,U.value[s].content=$,U.value[s].question=ae,U.value[s].answer=ce,U.value[s].images=pe,U.value[s].word_total=ce.length+ae.length+$.length},_e=n=>{be.confirm({title:"提醒",icon:t(Ee),content:"确定要删除这个片段吗?",okText:"确定",okType:"danger",cancelText:"取消",onOk(){E=!0,U.value.splice(n,1)},onCancel(){}})},D=u(""),J=n=>{D.value=n},Z=u(!1),f=()=>{let n=R.value.formState;n=JSON.parse(JSON.stringify(n)),typeof n.separators_no=="object"&&(n.separators_no=JSON.stringify(n.separators_no)),typeof n.father_chunk_separators_no=="object"&&(n.father_chunk_separators_no=JSON.stringify(n.father_chunk_separators_no)),typeof n.son_chunk_separators_no=="object"&&(n.son_chunk_separators_no=JSON.stringify(n.son_chunk_separators_no)),b={...b,...n}},le=n=>{let $=0;return n.forEach(ae=>{$+=parseInt(ae.word_total)}),$},N=async()=>{if((ne.value<=0||b.chunk_type!=ee.value)&&(f(),await ge()),f(),D.value)return he.error(D.value);if(b.chunk_type==3&&!U.value.length)return ue.value=!0,!1;ve.value&&(b.ai_chunk_task_id=ve.value);let n={...b,semantic_chunk_model_config_id:b.semantic_chunk_model_config_id?+b.semantic_chunk_model_config_id:0,ai_chunk_model_config_id:b.ai_chunk_model_config_id?+b.ai_chunk_model_config_id:0,is_table_file:F.value,...k.pdfState};delete n.id;let $={file_id:P,word_total:le(U.value),split_params:JSON.stringify(n),list:JSON.stringify(U.value),...k.pdfState};n.is_qa_doc==1&&($.qa_index_type=n.qa_index_type),Z.value=!0,k.paragraphType&&k.paragraphType==="paragraphsSegmented"&&($.data_id=$.data_ids,delete $.data_ids),kn($).then(()=>{_("ok"),_("finish")}).finally(()=>{Z.value=!1}).catch(ae=>{ae.data&&ae.data.index&&ze(ae.data.index),_("finish")})},$e=u(null),ze=n=>{n=n-1;let $=$e.value.querySelectorAll(".fragment-item");$.length>=n&&$[n].scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})};return zt(()=>{I&&(clearTimeout(I),I=null)}),ie({handleSaveLibFileSplit:N}),(n,$)=>{const ae=Je;return i(),v(fe,null,[z.value?(i(),v("div",wo,[t(ae)])):A("",!0),a("div",xo,[a("div",Co,[a("div",$o,[t(ia,{excellQaLists:W.value,libFileInfo:p.value,library_type:r.value,mode:F.value,hideSave:!0,status:"paragraphsSegmented",ref_key:"segmentationSettingRef",ref:R,onChange:te,onChangeChunkType:Te,onSave:N,onValidate:J},null,8,["excellQaLists","libFileInfo","library_type","mode"])]),a("div",Lo,[a("div",qo,[a("div",Oo,[$[0]||($[0]=a("span",{class:"label-text"},"分段预览",-1)),a("span",Eo,"共"+se(ne.value)+"个分段",1)]),x.value&&!oe.value?(i(),G(ra,{key:0})):A("",!0),oe.value?(i(),v("div",Io,[t(ae),$[1]||($[1]=O("数据处理中...",-1))])):A("",!0),a("div",{class:"preview-box",ref_key:"previewBoxRef",ref:$e},[(i(!0),v(fe,null,xe(U.value,(ce,pe)=>(i(),v("div",{class:"fragment-item",key:pe},[t(ua,{status:"paragraphsSegmented",chunk_type:Y(b).chunk_type,father_chunk_paragraph_number:ce.father_chunk_paragraph_number,currentData:re.currentData,number:ce.number,title:ce.title,content:ce.content,total:ce.word_total,question:ce.question,answer:ce.answer,images:ce.images,onDelete:Re=>_e(pe),onEdit:Re=>Q(ce,pe)},null,8,["chunk_type","father_chunk_paragraph_number","currentData","number","title","content","total","question","answer","images","onDelete","onEdit"])]))),128))],512)])])]),t(ca,{ref_key:"editFragmentAlertRef",ref:d,onOk:T},null,512)])],64)}}},Qt=Le(To,[["__scopeId","data-v-f8c24c86"]]),Mo={class:"select-box"},Po=["onClick"],zo={class:"title"},Fo={class:"desc"},Do={key:0,class:"card-switch"},No={class:"main-content-box"},Ho={__name:"re-segmentation-page",props:{detailsInfo:{type:Object,default:()=>{}}},emits:["ok","enable"],setup(re,{expose:ie,emit:L}){const V=Pt(),m=ke(()=>{var B;return((B=V.companyInfo)==null?void 0:B.ali_ocr_switch)=="1"}),c=Ue().query,_=Ft(),P=re,z=u(!1),F=u(!1),E=u(""),k=L;let ee={};const b=u([{title:"图文OCR解析",desc:"通过OCR文字识别提取pdf文件内容，可以兼容扫描件，但是解析速度较慢。",icon:"pdf-ocr",pdf_parse_type:2},{title:"纯文本解析",desc:"只提取Pdf中的文字内容，如果文档为扫描件可能提取不到内容。",icon:"pdf-text",pdf_parse_type:1},{title:"图文解析",desc:"提取PDF文档中的图片和文字",icon:"pdf-img",pdf_parse_type:3}]),R=qe({pdf_parse_type:2,pdf_page_num:0}),te=()=>{b.value=b.value.filter(B=>B.pdf_parse_type!=4),k("enable")},w=u(!1),y=B=>{w.value=B},p=B=>{ee={...B},R.pdf_parse_type=2,R.pdf_page_num=B.pdf_page_num,B.type==1&&(E.value=`当页(${B.pdf_page_num})重新分段`),B.type==2&&(E.value="将文档重新分段"),B.type==3&&(E.value="重新学习文档",b.value.push({title:"阿里云OCR解析",desc:"通过阿里云文档智能接口解析提取图片和文字",icon:"ali-ocr",pdf_parse_type:4})),z.value=!0},r=()=>{window.open("#/user/aliocr")},C=B=>{if(B.pdf_parse_type==4&&!m.value)return!1;R.pdf_parse_type=B.pdf_parse_type},W=u(!1),me=()=>{if(ee.type==3){if(R.pdf_parse_type==1){_.push("/library/document-segmentation?document_id="+c.id+"&source=preview");return}W.value=!0,xn({id:c.id,pdf_parse_type:R.pdf_parse_type}).then(B=>{he.success("重新学习成功"),(R.pdf_parse_type==2||R.pdf_parse_type==3||R.pdf_parse_type==4)&&_.push({path:"/library/details/knowledge-document",query:{id:P.detailsInfo.library_id}}),R.pdf_parse_type==1&&_.push("/library/document-segmentation?document_id="+c.id+"&source=preview"),z.value=!1}).finally(()=>{W.value=!1});return}z.value=!1,F.value=!0},h=u(null),ue=()=>{W.value=!0,h.value.handleSaveLibFileSplit()},oe=()=>{he.success("保存成功"),F.value=!1,k("ok",ee.type)},ve=()=>{W.value=!1};return ie({show:p}),(B,I)=>{const U=Ze,ne=be;return i(),v("div",null,[t(ne,{open:z.value,"onUpdate:open":I[0]||(I[0]=x=>z.value=x),title:E.value,onOk:me,onCancel:te,width:720,confirmLoading:W.value},{default:l(()=>[a("div",Mo,[(i(!0),v(fe,null,xe(b.value,x=>(i(),v("div",{class:st(["select-list-item",{active:x.pdf_parse_type==R.pdf_parse_type},{disabled:x.pdf_parse_type==4&&!m.value}]),onClick:ge=>C(x),key:x.pdf_parse_type},[a("div",zo,[t(U,{name:x.icon,style:{"font-size":"16px"}},null,8,["name"]),O(" "+se(x.title),1)]),a("div",Fo,se(x.desc),1),x.pdf_parse_type==4&&!m.value?(i(),v("div",Do,[I[2]||(I[2]=O(" 未开启阿里云OCR ",-1)),a("div",{class:"card-switch-btn",onClick:ye(r,["stop"])},"去开启")])):A("",!0)],10,Po))),128))])]),_:1},8,["open","title","confirmLoading"]),t(ne,{open:F.value,"onUpdate:open":I[1]||(I[1]=x=>F.value=x),onCancel:te,title:E.value,maskClosable:!1,"ok-text":w.value?"文档解析中,请稍候...":"确定",confirmLoading:W.value||w.value,onOk:ue,width:1e3},{default:l(()=>[a("div",No,[F.value?(i(),G(Qt,{key:0,onOk:oe,onFinish:ve,onLoading:y,pdfState:R,ref_key:"documentSegmentationModalRef",ref:h},null,8,["pdfState"])):A("",!0)])]),_:1},8,["open","title","ok-text","confirmLoading"])])}}},Ao=Le(Ho,[["__scopeId","data-v-ed67085d"]]),Bo={class:"subsection-box"},Uo={class:"qa-list-box"},Jo={class:"list-item"},Go=["innerHTML"],jo={key:0,class:"list-item"},Qo=["innerHTML"],Vo={class:"list-item"},Wo=["innerHTML"],Zo={class:"fragment-img"},Ko=["src"],Xo={key:0,class:"status-tag"},Yo={key:1,class:"status-tag complete"},es={class:"status-tag status-error"},ts={key:3,class:"status-tag running"},ns={class:"right-opration"},as={class:"hover-btn-box"},os=["onClick"],ss=["onClick"],ls={class:"hover-btn-box"},is=["onClick"],rs=["onClick"],us={__name:"qa-subsection-box",props:{paragraphLists:{type:Array,default:()=>[]},search:{type:String,default:""},total:{type:[Number,String],default:0}},emits:["handleDelParagraph","handleScrollTargetPage","openEditSubscription","handleConvert","getStatrList"],setup(re,{expose:ie,emit:L}){const m=Ue().query,c=L,_=re,P=(p,r)=>{let{id:C,title:W,content:me,question:h,answer:ue,images:oe,category_id:ve}=p,B=p.similar_questions||[];be.confirm({title:"重新转换确认",icon:null,content:`确定要重新转换【分段${r+1}】吗?`,onOk(){return new Promise((I,U)=>{Rt({id:C,title:W,content:me,question:h,answer:ue,images:oe,category_id:ve,similar_questions:JSON.stringify(B)}).then(ne=>{c("handleConvert",p),I()}).catch(()=>{I()})})},onCancel(){}})},z=p=>{c("openEditSubscription",p)},F=p=>{be.confirm({title:"提示",icon:t(Ee),content:"确认是否删除该分段?",onOk(){return new Promise((r,C)=>{Tt({id:p}).then(W=>{he.success("删除成功"),c("handleDelParagraph",p),r()}).catch(()=>{r()})})},onCancel(){}})},E=u([]),k=()=>{let p={};m.id&&(p.file_id=m.id),Et(p).then(r=>{E.value=r.data||[],c("getStatrList",r.data||[])})};k();const ee=u(null),b=()=>{ee.value.show()},R=p=>{var C;let r=(C=E.value.filter(W=>W.id==p.category_id)[0])==null?void 0:C.type;return r?We[r]:"#F4EA2A"},te=(p,r={})=>{It({id:p.id,category_id:r.id||0}).then(C=>{he.success("设置成功"),p.category_id=r.id,k()})};function w(p,r,C={}){if(!r||!p)return p;const{highlightClass:W="highlight",caseSensitive:me=!1,wholeWord:h=!1}=C,ue=me?"g":"gi";let oe;return h?oe=new RegExp(`\\b${y(r)}\\b`,ue):oe=new RegExp(y(r),ue),p.replace(oe,ve=>`<span class="${W}">${ve}</span>`)}function y(p){return p.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}return ie({handleOpenEditModal:z}),(p,r)=>{const C=Fn,W=Ke,me=Je,h=rt,ue=it,oe=ut,ve=An,B=ot("viewer");return i(),v("div",Bo,[t(ve,{"data-source":re.paragraphLists,pagination:!1},{default:l(()=>[t(C,{key:"id","data-index":"id",width:1148},{title:l(()=>[O("问答（共"+se(_.total)+"个）",1)]),default:l(({record:I})=>[a("div",Uo,[a("div",Jo,[r[0]||(r[0]=a("div",{class:"list-label"},"问题",-1)),a("div",{class:"list-content",innerHTML:w(I.question,_.search)},null,8,Go)]),I.similar_questions&&I.similar_questions.length?(i(),v("div",jo,[r[1]||(r[1]=a("div",{class:"list-label"},"相似问法",-1)),a("div",{class:"list-content",innerHTML:w(I.similar_questions.join("/"),_.search)},null,8,Qo)])):A("",!0),a("div",Vo,[r[2]||(r[2]=a("div",{class:"list-label"},"答案",-1)),a("div",{class:"list-content",innerHTML:w(I.answer,_.search)},null,8,Wo)]),lt((i(),v("div",Zo,[(i(!0),v(fe,null,xe(I.images,(U,ne)=>(i(),v("img",{key:ne,src:U,alt:""},null,8,Ko))),128))])),[[B]])])]),_:1}),t(C,{title:"嵌入状态",key:"status_text","data-index":"status_text",width:128},{default:l(({record:I})=>[I.status==0?(i(),v("span",Xo,[t(Y(Dn)),r[3]||(r[3]=O(" 未转换",-1))])):A("",!0),I.status==1?(i(),v("span",Yo,[t(Y(Nn)),r[4]||(r[4]=O(" 已转换",-1))])):A("",!0),I.status==2?(i(),G(W,{key:2,placement:"top"},{title:l(()=>[a("span",null,se(I.errmsg),1)]),default:l(()=>[a("span",null,[a("span",es,[t(Y(Hn)),r[5]||(r[5]=O(" 转换异常",-1))])])]),_:2},1024)):A("",!0),I.status==3?(i(),v("span",ts,[t(me,{size:"small"}),r[6]||(r[6]=O(" 转换中",-1))])):A("",!0)]),_:1}),t(C,{title:"操作",key:"action","data-index":"action",width:120},{default:l(({record:I,index:U})=>[a("div",ns,[t(oe,null,{overlay:l(()=>[t(ue,null,{default:l(()=>[(i(!0),v(fe,null,xe(E.value,ne=>(i(),G(h,{key:ne.id},{default:l(()=>[a("div",{class:"start-item",onClick:x=>te(I,ne)},[t(Y(Ve),{style:Fe({color:Y(We)[ne.type]})},null,8,["style"]),a("div",null,se(ne.name||"-"),1)],8,os)]),_:2},1024))),128)),t(h,null,{default:l(()=>[a("div",{class:"start-item",onClick:b},[t(Y(At)),r[7]||(r[7]=a("div",null,"标记设置",-1))])]),_:1})]),_:2},1024)]),default:l(()=>[a("div",as,[I.category_id>0?(i(),G(Y(Ve),{key:0,onClick:ne=>te(I,{}),style:Fe({color:R(I),"font-size":"16px"})},null,8,["onClick","style"])):(i(),G(Y(Ht),{key:1,onClick:ne=>te(I,E.value[0]),style:{"font-size":"16px"}},null,8,["onClick"]))])]),_:2},1024),t(W,null,{title:l(()=>[...r[8]||(r[8]=[O("重新转换",-1)])]),default:l(()=>[a("div",{class:"hover-btn-box",onClick:ne=>P(I,U)},[t(Y(Bt))],8,ss)]),_:2},1024),t(oe,{placement:"bottomRight"},{overlay:l(()=>[t(ue,null,{default:l(()=>[t(h,null,{default:l(()=>[a("div",{onClick:ye(ne=>z(I),["stop"])},"编辑",8,is)]),_:2},1024),t(h,null,{default:l(()=>[a("div",{onClick:ye(ne=>F(I.id),["stop"])},"删除",8,rs)]),_:2},1024)]),_:2},1024)]),default:l(()=>[a("div",ls,[t(Y(Ut))])]),_:2},1024)])]),_:1})]),_:1},8,["data-source"]),t(jt,{onOk:k,ref_key:"classificationMarkModalRef",ref:ee},null,512)])}}},cs=Le(us,[["__scopeId","data-v-a265f5b9"]]),ds={class:"main-content-box"},_s={__name:"segmentation-setting-modal",emits:["ok","enable"],setup(re,{expose:ie,emit:L}){const V=u(!1),m=u("重新分段"),c=L;let _={};const P=qe({data_ids:0,file_id:0}),z={0:"未转换",1:"已转换",2:"转换异常",3:"转换中",4:"分段失败",10:"分段中"},F=qe({status:"",errmsg:"",status_text:""}),E=()=>{c("enable")},k=u(!1),ee=r=>{k.value=r},b=r=>{V.value=!0,P.data_ids=r.id,P.file_id=r.file_id,F.list=[{father_chunk_paragraph_number:+r.father_chunk_paragraph_number,content:r.content,number:+r.number,title:r.title,word_total:+r.word_total,question:r.question,answer:r.answer,images:r.images}],F.status=r.status,F.errmsg=r.errmsg,F.status_text=z[r.status]},R=u(!1),te=u(null),w=()=>{R.value=!0,te.value.handleSaveLibFileSplit()},y=()=>{he.success("保存成功"),V.value=!1,c("ok",_.type)},p=()=>{R.value=!1};return ie({show:b}),(r,C)=>{const W=be;return i(),v("div",null,[t(W,{open:V.value,"onUpdate:open":C[0]||(C[0]=me=>V.value=me),onCancel:E,title:m.value,maskClosable:!1,"ok-text":k.value?"文档解析中,请稍候...":"确定",confirmLoading:R.value||k.value,onOk:w,width:1084},{default:l(()=>[a("div",ds,[V.value?(i(),G(Qt,{key:0,onOk:y,onFinish:p,onLoading:ee,paragraphType:"paragraphsSegmented",pdfState:P,currentData:F,ref_key:"documentSegmentationModalRef",ref:te},null,8,["pdfState","currentData"])):A("",!0)])]),_:1},8,["open","title","ok-text","confirmLoading"])])}}},ps=Le(_s,[["__scopeId","data-v-498533cb"]]),fs={class:"library-preview-page"},ms={class:"breadcrumb-block"},vs={class:"library-line1"},gs={class:"selct-star-box"},hs={class:"document-title-block",style:{height:"22px"}},ks={class:"title"},ys={class:"search-content-block"},bs={class:"preview-box"},Ss={key:0,class:"page-loading-box"},ws={class:"content-block"},xs={class:"content-block"},Cs={key:1,class:"pdf-view-box"},$s={key:0,class:"pdf-mode-switch"},Ls={key:0},qs={key:1,class:"segmentation-btn"},Os={class:"view-content-box",style:{"padding-top":"60px"}},Es=["onClick"],Is={key:0,class:"content-box"},Rs={key:1,class:"content-box"},Ts=["innerHTML"],Ms={class:"fragment-img"},Ps=["src"],zs={class:"right-contnt-box"},Fs={key:0,class:"right-tabs-box"},Ds={class:"content-block"},Ns="你是一位文章分段助手，根据文章内容的语义进行合理分段，确保每个分段表述一个完整的语义，每个分段字数控制在500字左右，最大不超过1000字。请严格按照文章内容进行分段，不要对文章内容进行加工，分段完成后输出分段后的内容。",Hs={__name:"library-preview",setup(re){const ie=Pt(),L=ke(()=>{var e;return((e=ie.companyInfo)==null?void 0:e.neo4j_status)=="true"}),V=u(!1),m=u(null),c=u(0),_=u(0),P={0:"待生成",4:"生成中",2:"生成成功",3:"生成失败"},z=u([]),F=e=>{z.value=e},E=u({fade:!1,scrollbarTrackClickable:!0,interactive:!0,minSize:40}),k=Ue(),ee=Ft(),b=Cn(),R=ke(()=>p.value.is_table_file=="1"),te=ke(()=>p.value.doc_type),w=ke(()=>{let e=p.value.status;return!(e=="1"||e=="2")||x.value.length==0}),y=ke(()=>p.value.is_qa_doc=="1"),p=u({}),r=qe({status:-1,graph_status:-1,category_id:-1,search:""}),C=u(1),W=ke(()=>"/manage/getLibRawFile?id="+k.query.id+"&token="+b.getToken),me=()=>{ee.back()},h=u(null),ue=u(null);let oe=-1;const ve=(e,o=1)=>{let g,q;o==1?(g=".subsection-box .list-item",q=ue.value):(g=".view-content-box .list-item",q=h.value);const H=document.querySelectorAll(g)[e];H.classList.add("flash-border"),oe>=0&&document.querySelectorAll(g)[oe].classList.remove("flash-border"),setTimeout(()=>{oe=-1,H.classList.remove("flash-border")},2500),oe=e,q.scrollToElement({el:H,time:1e3})},B=u(!0),I=u(0),U=u({page:1,size:1e3}),ne=u({}),x=u([]),ge=u(0),Te={0:"未转换",1:"已转换",2:"转换异常",3:"转换中..."},Ce=qe({split_status_exception:0,total:0,vector_status_converted:0,vector_status_converting:0,vector_status_exception:0,vector_status_initial:0}),De=qe([{value:-1,label:"全部",num:ke(()=>Ce.total)},{value:4,label:"分段失败",num:ke(()=>Ce.split_status_exception)},{value:0,label:"未转换",num:ke(()=>Ce.vector_status_initial)},{value:3,label:"转换中",num:ke(()=>Ce.vector_status_converting)},{value:2,label:"转换异常",num:ke(()=>Ce.vector_status_exception)},{value:1,label:"已转换",num:ke(()=>Ce.vector_status_converted)}]),Ie=u(1);let Se={id:k.query.id,separators_no:"",chunk_size:512,not_merged_text:!1,chunk_overlap:50,is_qa_doc:0,question_lable:"",similar_label:"",answer_lable:"",enable_extract_image:!0,ai_chunk_size:5e3,ai_chunk_model:"",ai_chunk_model_config_id:"",ai_chunk_prumpt:Ns,ai_chunk_task_id:"",father_chunk_paragraph_type:2,father_chunk_separators_no:[],father_chunk_chunk_size:1024,son_chunk_separators_no:[],son_chunk_chunk_size:512};const d=u(!1);let s=!0;(async()=>{Mt({id:k.query.id}).then(e=>{I.value=e.data.library_type,p.value={...e.data,graph_switch:e.data.graph_switch=="1"&&L.value};let o=e.data.status;o==1||o==2?f():B.value=!1,Se={...Se,separators_no:e.data.separators_no||"[12,11]",chunk_size:+e.data.chunk_size||512,not_merged_text:e.data.not_merged_text=="true",ai_chunk_size:+e.data.ai_chunk_size||5e3,chunk_overlap:+e.data.chunk_overlap||50,is_qa_doc:I.value==2?1:0,question_lable:e.data.question_lable,similar_label:e.data.similar_label,answer_lable:e.data.answer_lable,question_column:e.data.question_column,similar_column:e.data.similar_column,answer_column:e.data.answer_column,enable_extract_image:e.data.enable_extract_image=="true",qa_index_type:+e.data.qa_index_type,chunk_type:+e.data.chunk_type,semantic_chunk_size:+e.data.semantic_chunk_size||512,semantic_chunk_overlap:+e.data.semantic_chunk_overlap||50,semantic_chunk_threshold:+e.data.semantic_chunk_threshold||90,semantic_chunk_use_model:e.data.semantic_chunk_use_model||"",ai_chunk_prumpt:e.data.ai_chunk_prumpt||"",ai_chunk_model:e.data.ai_chunk_model||"",semantic_chunk_model_config_id:e.data.semantic_chunk_model_config_id>0?e.data.semantic_chunk_model_config_id:"",ai_chunk_model_config_id:e.data.ai_chunk_model_config_id>0?e.data.ai_chunk_model_config_id:"",ai_chunk_task_id:e.data.ai_chunk_task_id||"",father_chunk_paragraph_type:+e.data.father_chunk_paragraph_type||2,father_chunk_separators_no:e.data.father_chunk_separators_no||"[12,11]",father_chunk_chunk_size:+e.data.father_chunk_chunk_size||1024,son_chunk_separators_no:e.data.son_chunk_separators_no||"[8,10]",son_chunk_chunk_size:+e.data.son_chunk_chunk_size||512},e.data.chunk_type==0&&(Se={...Se,separators_no:e.data.normal_chunk_default_separators_no,chunk_size:+e.data.normal_chunk_default_chunk_size,not_merged_text:e.data.normal_chunk_default_not_merged_text=="true",chunk_overlap:+e.data.normal_chunk_default_chunk_overlap,chunk_type:+e.data.default_chunk_type,semantic_chunk_size:+e.data.semantic_chunk_default_chunk_size,semantic_chunk_overlap:+e.data.semantic_chunk_default_chunk_overlap,semantic_chunk_threshold:+e.data.semantic_chunk_default_threshold,semantic_chunk_use_model:e.data.default_use_model||"",semantic_chunk_model_config_id:e.data.default_model_config_id>0?e.data.default_model_config_id:""}),(o==4||o==2)&&(Ie.value=parseInt(e.data.is_table_file))})})();const T=()=>{$n({file_id:k.query.id,search:r.search}).then(e=>{Object.assign(Ce,e.data)})},_e=()=>{window.location.reload()},D=()=>{U.value.page=1,ge.value=0,x.value=[],f(),T()},J=e=>{r.category_id=e,D()},Z=(e=null)=>{U.value.page++,f(e)},f=(e=null)=>{s=!0,$t({file_id:k.query.id,...U.value,...r}).then(o=>{var S,M;B.value=!1,s=!1;let g=o.data,q=g.list||[],H=((S=g.info)==null?void 0:S.is_qa_doc)=="1"&&((M=g.info)==null?void 0:M.is_table_file)=="1";q.forEach(we=>{we.status_text=Te[we.status],we.graph_status_text=P[we.graph_status],we.isExcelQa=H,we.similar_questions&&(we.similar_questions=JSON.parse(we.similar_questions))}),ne.value=g.info,U.value.page==1&&(x.value=[]),x.value=[...x.value,...q],ge.value=g.total,typeof e=="function"&&e()})},le=()=>{s||x.value.length>=ge.value||(Z(),m.value&&m.value.loadMore())},N=()=>{n()};let $e=null;function ze(){clearInterval($e),x.value.filter(o=>o.status==3).length?$e=setInterval(()=>{n()},5e3):clearInterval($e)}const n=()=>{$t({file_id:k.query.id,page:1,size:x.value.length,...r}).then(e=>{var H,S;let o=e.data,g=o.list||[],q=((H=o.info)==null?void 0:H.is_qa_doc)=="1"&&((S=o.info)==null?void 0:S.is_table_file)=="1";g.forEach(M=>{M.status_text=Te[M.status],M.graph_status_text=P[M.graph_status],M.isExcelQa=q,M.similar_questions&&(M.similar_questions=JSON.parse(M.similar_questions))}),x.value=g,ze()})},$=e=>{if(!e.id){U.value.page=1,f();return}let o=x.value,g=o.findIndex(q=>q.id==e.id);if(g>-1){let q=o[g];q.title=e.title,q.content=e.content,q.question=e.question,q.answer=e.answer,q.images=e.images,q.category_id=e.category_id,q.word_total=e.question.length+e.answer.length+e.content.length,q.similar_questions=e.similar_questions.length?JSON.parse(e.similar_questions):[],o.splice(g,1,q),x.value=o}},ae=e=>{let o=x.value,g=o.findIndex(q=>q.id==e);g>-1&&(o.splice(g,1),x.value=o,ge.value=ge.value--)},ce=u(null),pe=e=>{ce.value.showModal(JSON.parse(JSON.stringify(e)))},Re=u(null),Vt=()=>{Ln({id:k.query.id}).then(()=>he.success("操作完成"))},Wt=()=>{qn({id:k.query.id}).then(()=>he.success("操作完成"))},ct=u(null),Zt=()=>{ct.value.show(p.value)},dt=()=>{ee.push("/library/document-segmentation?document_id="+k.query.id+"&source=preview")},Kt=()=>{Re.value.open({id:k.query.id,doc_auto_renew_frequency:p.value.doc_auto_renew_frequency})},Xt=e=>{p.value.doc_auto_renew_frequency=e},Yt=e=>{p.value.file_name=e},en=e=>{const o=()=>{for(let g in x.value)if(x.value[g].page_num==e){ve(g);return}};if(e>x.value[x.value.length-1].page_num){he.warning("分段数据正在加载，请稍后...");const g=()=>{e<=x.value[x.value.length-1].page_num?(he.success("加载完成"),Qe(()=>{o()})):Z(g)};Z(g)}else o()},tn=(e,o)=>{_.value=o,c.value=e,x.value[x.value.length-1].page_num<e&&Z()},_t=e=>{var o;if(((o=p.value)==null?void 0:o.file_ext)=="pdf"&&C.value==1){const g=e.page_num-1,q=()=>document.querySelectorAll(".pdf-render-box > .scroll-content .vue-pdf-embed")[g],H=()=>{const M=q();M.classList.add("flash-border"),setTimeout(()=>M.classList.remove("flash-border"),2500),m.value.getScrollInstance().scrollToElement({el:M,time:1e3})};if(q())H();else{he.warning("PDF正在加载，请稍后...");const M=()=>{q()?(he.success("加载完成"),H()):m.value&&m.value.loadMore()};m.value&&m.value.loadMore(M)}}else ve(e.index,2)},Xe=u(1);let Ye=null;const Ge=u(0),nn=e=>{Ge.value=e},an=({y:e})=>{if(!Ye){const g=document.querySelectorAll(".pdf-render-box > .scroll-content .vue-pdf-embed")[0];Ye=g&&g.clientHeight}let o=Math.floor(Math.abs(e)/Ye)+1;Xe.value=Math.max(o,1)},et=u(null),tt=u(null),on=e=>{let{key:o}=e;m.value&&m.value.getScrollInstance().disable(),o==1&&et.value.show({type:o,pdf_page_num:Xe.value}),o==2&&dt(),o==3&&et.value.show({type:o,pdf_page_num:0})},pt=e=>{tt.value&&tt.value.show(e)},ft=()=>{m.value&&m.value.getScrollInstance().enable()},sn=()=>{ft(),D()},mt=()=>{V.value=!V.value},nt=(e,o)=>{let g=JSON.parse(JSON.stringify(e));return g.content=o,g.word_total=o.length,g},Me=u(!1),Pe=u(1),vt=({index:e,beforeContent:o,selectedContent:g,afterContent:q,isFullSelection:H})=>{const S=[...x.value];Me.value=H,Pe.value=1,H?(S.splice(e+1,0,nt(S[e],g)),S.splice(e,1)):(S[e].content=o||"",S[e].word_total=o.length||0,q.trim()&&S.splice(e+1,0,nt(S[e],q)),S.splice(e+1,0,nt(S[e],g)),S[e+1].images=[],S.splice(e,1)),x.value=S,Ne(S,e)},gt=({index:e,beforeContent:o,selectedContent:g,afterContent:q,isFullSelection:H})=>{const S=[...x.value];Me.value=H,Pe.value=2;let M=S[e+1].word_total;H?(S[e+1].content=+g,S[e+1].word_total=parseInt(M)+g.length,S.splice(e,1),x.value=S,Ne(S,e)):(S[e].content=o||"",S[e].word_total=o.length||0,S[e+1].content+=g,S[e+1].word_total=parseInt(M)+g.length,q.trim()&&(S[e].content+=q||"",S[e].word_total+=q.length||0),x.value=S,Ne(S,e+1))},ht=({index:e,beforeContent:o,selectedContent:g,afterContent:q,isFullSelection:H})=>{const S=[...x.value];Me.value=H,Pe.value=3;let M=S[e-1].word_total;H?(S[e-1].content+=g,S[e-1].word_total=parseInt(M)+g.length,S.splice(e,1),x.value=S,Ne(S,e)):(S[e].content=o||"",S[e].word_total=o.length||0,S[e-1].content+=g,S[e-1].word_total=parseInt(M)+g.length,q.trim()&&(S[e].content+=q||"",S[e].word_total+=q.length||0),x.value=S,Ne(S,e-1))},kt=({index:e,beforeContent:o,afterContent:g,isFullSelection:q})=>{const H=[...x.value];Me.value=q,Pe.value=4,q?H.splice(e,1):(H[e].content=o||"",H[e].word_total=o.length||0,g.trim()&&(H[e].content+=g||"",H[e].word_total+=g.length||0)),x.value=H,Ne(H,e)};function ln(e,o,g={},q){let H=q+1;if(!Array.isArray(e)||!Array.isArray(o))return JSON.stringify([]);const S=e.map((M,we)=>{const j={};for(const K of o){const Oe=g[K]||K,de=M[Oe];if(Object.prototype.hasOwnProperty.call(M,Oe))if(K==="number")j[K]=we+1;else if(K==="father_chunk_paragraph_number")j[K]=+de;else if(K==="page_num"||K==="word_total")j[K]=+de;else if(K==="content"){if(!de)return null;j[K]=de}else K==="images"?Pe.value==1?Me.value?(H==j.number,j[K]=de):H+1==j.number?j[K]=[]:j[K]=de:Pe.value==2?(Me.value,H==j.number,j[K]=de):Pe.value==3?Me.value?(H-1==j.number,j[K]=de):(H==j.number,j[K]=de):Pe.value==4&&(Me.value,j[K]=de):j[K]=de}return j}).filter(M=>M!==null&&M.content!==void 0&&M.content!=="");return JSON.stringify(S)}const rn={similar_question_list:"similar_questions"},Ne=async(e,o)=>{let g={...Se,semantic_chunk_model_config_id:Se.semantic_chunk_model_config_id?+Se.semantic_chunk_model_config_id:0,ai_chunk_model_config_id:Se.ai_chunk_model_config_id?+Se.ai_chunk_model_config_id:0,is_table_file:Ie.value};delete g.id;let q={id:k.query.id,word_total:ge.value,split_params:JSON.stringify(g),list:ln(e,["number","father_chunk_paragraph_number","page_num","title","content","question","similar_question_list","answer","word_total","images"],rn,o)};g.is_qa_doc==1&&(q.qa_index_type=g.qa_index_type),d.value=!0,On(q).then(H=>{he.success("操作成功");const S=H.data;for(let M=0;M<S.length;M++){const we=S[M],j=x.value[M];if(M<x.value.length)j.id=we.toString(),j.status="0",j.status_text=Te[j.status];else break}}).finally(()=>{d.value=!1})};return Be(()=>{T(),k.query.graph_status&&(r.graph_status=k.query.graph_status,D())}),(e,o)=>{var St,wt,xt;const g=En("router-link"),q=Qn,H=Bn,S=Ze,M=Nt,we=Vn,j=Gt,K=Jt,Oe=rt,de=it,yt=ut,un=Jn,cn=Je,je=Ke,bt=Wn,dn=Gn,_n=Zn,pn=jn,fn=ot("viewer");return i(),v("div",fs,[a("div",ms,[t(H,null,{default:l(()=>[t(q,null,{default:l(()=>[t(g,{to:"/library/list"},{default:l(()=>[...o[8]||(o[8]=[O(" 知识库管理 ",-1)])]),_:1})]),_:1}),t(q,null,{default:l(()=>[t(g,{to:{path:"/library/details/knowledge-document",query:{id:p.value.library_id}}},{default:l(()=>[a("div",vs,se(p.value.library_name)+"知识库",1)]),_:1},8,["to"])]),_:1}),t(q,null,{default:l(()=>[...o[9]||(o[9]=[O("知识库详情",-1)])]),_:1})]),_:1}),a("div",gs,[t(Kn,{startLists:z.value,onChange:J},null,8,["startLists"])])]),a("div",hs,[t(Y(Un),{onClick:me}),a("span",ks,se(p.value.file_name),1),t(ho,{detailsInfo:p.value},null,8,["detailsInfo"])]),a("div",ys,[a("div",bs,[V.value?(i(),G(M,{key:1,onClick:o[1]||(o[1]=X=>mt())},{default:l(()=>[t(S,{class:"preview-box-icon",name:"expand"}),o[11]||(o[11]=O(" 展开预览",-1))]),_:1})):(i(),G(M,{key:0,onClick:o[0]||(o[0]=X=>mt())},{default:l(()=>[t(S,{class:"preview-box-icon",name:"put-away"}),o[10]||(o[10]=O(" 收起预览",-1))]),_:1}))]),t(un,null,{default:l(()=>[t(we,{value:r.search,"onUpdate:value":o[2]||(o[2]=X=>r.search=X),placeholder:"搜索内容",style:{width:"200px"},allowClear:"",onChange:D},null,8,["value"]),y.value?(i(),G(K,{key:0,value:r.status,"onUpdate:value":o[3]||(o[3]=X=>r.status=X),placeholder:"请选择",style:{width:"160px"},onChange:D},{default:l(()=>[t(j,{value:-1},{default:l(()=>[...o[12]||(o[12]=[O("全部嵌入状态",-1)])]),_:1}),(i(),v(fe,null,xe(Te,(X,He)=>t(j,{key:X,value:He},{default:l(()=>[O(se(X),1)]),_:2},1032,["value"])),64))]),_:1},8,["value"])):A("",!0),p.value.graph_switch?(i(),G(K,{key:1,value:r.graph_status,"onUpdate:value":o[4]||(o[4]=X=>r.graph_status=X),placeholder:"请选择",onChange:D,style:{width:"160px"}},{default:l(()=>[t(j,{value:-1},{default:l(()=>[...o[13]||(o[13]=[O("全部知识图谱状态",-1)])]),_:1}),(i(),v(fe,null,xe(P,(X,He)=>t(j,{key:X,value:He},{default:l(()=>[O(se(X),1)]),_:2},1032,["value"])),64))]),_:1},8,["value"])):A("",!0),t(yt,null,{overlay:l(()=>[t(de,null,{default:l(()=>[t(Oe,{onClick:Vt},{default:l(()=>[...o[14]||(o[14]=[O("重新嵌入向量",-1)])]),_:1}),p.value.graph_switch?(i(),G(Oe,{key:0,onClick:Wt},{default:l(()=>[...o[15]||(o[15]=[O("重新抽取知识图谱",-1)])]),_:1})):A("",!0),t(Oe,{onClick:Zt},{default:l(()=>[...o[16]||(o[16]=[O("重命名",-1)])]),_:1}),te.value==2?(i(),G(Oe,{key:1,onClick:Kt},{default:l(()=>[...o[17]||(o[17]=[O("设置更新频率",-1)])]),_:1})):A("",!0)]),_:1})]),default:l(()=>[t(M,null,{default:l(()=>[o[18]||(o[18]=O("其他操作 ",-1)),t(Y(Lt))]),_:1})]),_:1}),te.value!=3?(i(),G(M,{key:2,onClick:dt},{default:l(()=>[...o[19]||(o[19]=[O("重新分段",-1)])]),_:1})):A("",!0),t(M,{onClick:o[5]||(o[5]=X=>pe({})),type:"primary"},{icon:l(()=>[t(Y(Dt))]),default:l(()=>[o[20]||(o[20]=a("span",null,"添加分段",-1))]),_:1})]),_:1})]),B.value?(i(),v("div",Ss,[t(cn)])):(i(),v(fe,{key:1},[y.value?(i(),v(fe,{key:0},[w.value?(i(),G(at,{key:0,onOpenEditSubscription:pe})):(i(),G(Ae,{key:1,scrollbar:{minSize:0},onOnScrollEnd:le},{default:l(()=>[a("div",ws,[t(cs,{ref:"subsectionBoxRef",total:ge.value,paragraphLists:x.value,search:r.search,detailsInfo:p.value,onOpenEditSubscription:pe,onHandleDelParagraph:ae,onHandleConvert:N,onGetStatrList:F},null,8,["total","paragraphLists","search","detailsInfo"])])]),_:1}))],64)):(i(),v(fe,{key:1},[R.value||te.value==3?(i(),v(fe,{key:0},[w.value?(i(),G(at,{key:0,onOpenEditSubscription:pe})):(i(),G(Ae,{key:1,scrollbar:{minSize:0},onOnScrollEnd:le,disableMouse:!0},{default:l(()=>[a("div",xs,[t(Ot,{ref:"subsectionBoxRef",total:ge.value,detailsInfo:p.value,paragraphLists:x.value,search:r.search,onOpenEditSubscription:pe,onHandleDelParagraph:ae,onHandleConvert:N,onHandleScrollTargetPage:_t,onGetStatrList:F,onHandleSplit:vt,onHandleSplitNext:gt,onHandleSplitUp:ht,onHandleSplitDelete:kt,onHandleSegmentation:pt},null,8,["total","detailsInfo","paragraphLists","search"])])]),_:1}))],64)):(i(),v("div",Cs,[a("div",{class:st(["view-content-wrap",{collapsed:V.value}])},[((St=p.value)==null?void 0:St.file_ext)=="pdf"?(i(),v("div",$s,[t(dn,{value:C.value,"onUpdate:value":o[6]||(o[6]=X=>C.value=X)},{default:l(()=>[t(bt,{value:1},{default:l(()=>[t(je,{placement:"right",title:"原文预览模式下，会展示pdf原始文件内容，手动编辑分段的不会展示。您可以通过原文预览模式，校验分段准确性，然后手动编辑分段。"},{default:l(()=>[o[21]||(o[21]=O(" 原文预览 ",-1)),C.value==1&&Ge.value>0?(i(),v("span",Ls,"("+se(Xe.value)+" / "+se(Ge.value)+")",1)):A("",!0)]),_:1})]),_:1}),t(bt,{value:2},{default:l(()=>[...o[22]||(o[22]=[O("纯文本预览",-1)])]),_:1})]),_:1},8,["value"])])):A("",!0),((wt=p.value)==null?void 0:wt.file_ext)=="pdf"?(i(),v("div",qs,[t(yt,null,{overlay:l(()=>[t(de,{onClick:on},{default:l(()=>[C.value==1&&Ge.value>0?(i(),G(Oe,{key:1},{default:l(()=>[t(je,{placement:"right",title:"将当前页重新解析并分段"},{default:l(()=>[...o[23]||(o[23]=[a("div",null,"将当页重新分段",-1)])]),_:1})]),_:1})):A("",!0),(i(),G(Oe,{key:2},{default:l(()=>[t(je,{placement:"right",title:"将整个文档重新分段，注意，重新分段并不会重新提取文档的内容，只是将内容重新分段。"},{default:l(()=>[...o[24]||(o[24]=[a("div",null,"将文档重新分段",-1)])]),_:1})]),_:1})),(i(),G(Oe,{key:3},{default:l(()=>[t(je,{placement:"right",title:"将整个文档重新学习，包含重新解析并提取文档内容，重新分段。"},{default:l(()=>[...o[25]||(o[25]=[a("div",null,"重新学习文档",-1)])]),_:1})]),_:1}))]),_:1})]),default:l(()=>[t(M,null,{default:l(()=>[o[26]||(o[26]=O(" 重新分段 ",-1)),t(Y(Lt))]),_:1})]),_:1})])):A("",!0),((xt=p.value)==null?void 0:xt.file_ext)=="pdf"&&C.value==1?(i(),G(So,{key:2,ref_key:"pdfRef",ref:m,class:"scroll-box pdf-render-box",source:W.value,onSelect:en,onScroll:an,onRendered:tn,onGetTotalPage:nn},null,8,["source"])):(i(),G(Ae,{key:3,scrollbar:E.value,ref_key:"leftScrollRef",ref:h,class:"scroll-box",onOnScrollEnd:le},{default:l(()=>[a("div",Os,[(i(!0),v(fe,null,xe(x.value,(X,He)=>(i(),v("div",{class:"list-item",onClick:Ct=>ve(He),key:He},[X.question?(i(),v("div",Is,se(X.question),1)):A("",!0),X.answer?(i(),v("div",Rs,se(X.answer),1)):A("",!0),a("div",{class:"content-box",innerHTML:X.content},null,8,Ts),lt((i(),v("div",Ms,[(i(!0),v(fe,null,xe(X.images,(Ct,mn)=>(i(),v("img",{key:mn,src:Ct,alt:""},null,8,Ps))),128))])),[[fn]])],8,Es))),128))])]),_:1},8,["scrollbar"]))],2),a("div",zs,[y.value?A("",!0):(i(),v("div",Fs,[t(pn,{activeKey:r.status,"onUpdate:activeKey":o[7]||(o[7]=X=>r.status=X),style:{"background-color":"#f2f4f7",padding:"0px 16px","border-radius":"6px"},onChange:D},{default:l(()=>[(i(!0),v(fe,null,xe(De,X=>(i(),G(_n,{key:X.value,tab:`${X.label} (${X.num})`},null,8,["tab"]))),128))]),_:1},8,["activeKey"])])),w.value?(i(),G(at,{key:1,onOpenEditSubscription:pe})):(i(),G(Ae,{key:2,scrollbar:E.value,disableMouse:!0,ref_key:"rightScrollRef",ref:ue,onOnScrollEnd:le},{default:l(()=>[a("div",Ds,[t(Ot,{ref:"subsectionBoxRef",total:ge.value,detailsInfo:p.value,paragraphLists:x.value,search:r.search,onOpenEditSubscription:pe,onHandleDelParagraph:ae,onHandleConvert:N,onHandleScrollTargetPage:_t,onGetStatrList:F,onHandleSplit:vt,onHandleSplitNext:gt,onHandleSplitUp:ht,onHandleSplitDelete:kt,onHandleSegmentation:pt},null,8,["total","detailsInfo","paragraphLists","search"])])]),_:1},8,["scrollbar"]))])]))],64))],64)),t(sa,{detailsInfo:p.value,onHandleEdit:$,ref_key:"editSubscriptionRef",ref:ce},null,8,["detailsInfo"]),t(ko,{onOk:Xt,ref_key:"updateFrequencyRef",ref:Re},null,512),t(la,{onOk:Yt,ref_key:"renameModalRef",ref:ct},null,512),t(Ao,{onOk:sn,onEnable:ft,detailsInfo:p.value,ref_key:"reSegmentationPageRef",ref:et},null,8,["detailsInfo"]),t(ps,{ref_key:"segmentationSettingModalRef",ref:tt,onOk:_e},null,512)])}}},cl=Le(Hs,[["__scopeId","data-v-bd345b13"]]);export{cl as default};
