# `message-item.vue` 组件拆分重构方案

## 1. 目的与概述

当前 `message-item.vue` 组件功能繁杂、代码量巨大，导致其难以维护、扩展和复用。本方案旨在通过将该组件拆分为多个功能单一、高内聚的子组件，来优化整体代码结构，提升项目的可读性与可维护性。

## 2. 总体拆分策略

拆分将遵循“容器与展示”分离的原则。`message-item.vue` 将作为顶层容器，负责状态管理和子组件编排。其他子组件则专注于特定的UI展示和用户交互。

核心拆分思路如下：
-   **按UI区域拆分**: 将头像、回复列表、操作按钮等明显区隔的UI块拆分为独立组件。
-   **按消息类型 (`msg_type`) 拆分**: 将不同类型的消息内容（文本、欢迎语、图片）分发给不同的组件处理。
-   **按功能拆分**: 将思考过程、推荐问题等独立功能模块化。

## 3. 建议拆分的组件清单

### 3.1. 基础UI组件

#### 3.1.1. `MessageAvatar.vue`
-   **职责**: 显示用户或机器人的头像。
-   **Props**: `src: String` (头像URL)。

#### 3.1.2. `MessageOperations.vue`
-   **职责**: 聚合“复制”、“点赞”、“点踩”等操作，并管理反馈弹窗。
-   **Props**: `message: Object`, `isLastMessage: Boolean`, `isCustomerMessage: Boolean`, `prevMsg: Object`。
-   **内部逻辑**: 直接与 `useChatStore` 交互，处理反馈逻辑。

### 3.2. 消息内容组件 (按 `msg_type` 拆分)

#### 3.2.1. `MessageContentDispatcher.vue` (原 `MessageContent.vue`)
-   **职责**: 作为消息内容的分发器，根据 `msg.msg_type` 动态渲染下面三种类型的消息组件。
-   **Props**: `message: Object`。
-   **模板结构**:
    ```html
    <template>
      <TextMessage v-if="message.msg_type === 1" :message="message" />
      <WelcomeMessage v-else-if="message.msg_type === 2" :message="message" />
      <ImageMessage v-else-if="message.msg_type === 3" :message="message" />
    </template>
    ```

#### 3.2.2. `TextMessage.vue`
-   **职责**: 渲染文本消息 (`msg_type: 1`)，包括用户输入的文本和机器人返回的Markdown内容。
-   **Props**: `message: Object`。

#### 3.2.3. `WelcomeMessage.vue`
-   **职责**: 渲染欢迎语消息 (`msg_type: 2`) 及其附带的推荐问题列表。
-   **Props**: `message: Object`。
-   **Emits**: `sendTextMessage(text: string)`。

#### 3.2.4. `ImageMessage.vue`
-   **职责**: 渲染图片消息 (`msg_type: 3`)。
-   **Props**: `message: Object`。

### 3.3. 功能模块组件

#### 3.3.1. `ReplyMessageList.vue`
-   **职责**: 渲染消息中包含的多种类型的回复内容（如文本、图片、链接、卡片等）。
-   **Props**: `replyList: Array`。
-   **Emits**: `clickSmartMenuKeyword(keyword: string)`。

#### 3.3.2. `ThinkingProcess.vue`
-   **职责**: 展示“深度思考中”和“检索知识库”的状态标签和展开内容。
-   **Props**: `message: Object`。
-   **Emits**: `toggleQuoteFile()`, `toggleReasonProcess()`, `linkClick(item: any)`。

#### 3.3.3. `SuggestedQuestions.vue`
-   **职责**: 展示在普通消息下方由 `menu_json.question` 定义的推荐问题。
-   **Props**: `questions: Array`。
-   **Emits**: `sendTextMessage(text: string)`。

## 4. 重构后的 `message-item.vue`

经过拆分后，`message-item.vue` 的模板将变得非常简洁清晰，主要负责编排和组合上述所有子组件。

```html
<template>
  <div class="ignore-message-item" :class="messageItemClasses">
    <!-- 1. 头像 -->
    <MessageAvatar :src="props.msg.avatar" />

    <div class="message-item-body">
      <!-- 2. 回复列表 -->
      <ReplyMessageList v-if="parsedReplyList.length" :replyList="parsedReplyList" />

      <!-- 3. 思考与检索过程 -->
      <ThinkingProcess :message="props.msg" />

      <!-- 4. 核心消息内容 (分发器) -->
      <MessageContentDispatcher :message="props.msg" @sendTextMessage="sendTextMessage" />

      <!-- 5. 独立推荐问题 (非欢迎语) -->
      <SuggestedQuestions v-if="shouldShowSuggestedQuestions" :questions="props.msg.menu_json.question" @sendTextMessage="sendTextMessage" />
      
      <!-- 6. 消息操作 (复制、点赞等) -->
      <MessageOperations :message="props.msg" :isLastMessage="..." :isCustomerMessage="..." />

      <!-- 7. 猜你想问 -->
      <GuessYouWant v-if="shouldShowGuessYouWant" :msg="props.msg" />
    </div>
  </div>
</template>
```

## 5. 总结

通过本次重构，`message-item.vue` 的复杂性被有效分解到各个独立的子组件中。这不仅使得代码更易于理解和维护，也为未来功能的扩展和组件的复用打下了坚实的基础。